{"config":{"lang":["ja"],"separator":"[\\s\\-\uff0c\u3002]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"\u4ecb\u7ecd","text":"<p>Kubernetes \u662f Google \u57fa\u4e8e Borg \u5f00\u6e90\u7684\u5bb9\u5668\u7f16\u6392\u8c03\u5ea6\u5f15\u64ce\uff0c\u4f5c\u4e3a CNCF\uff08Cloud Native Computing Foundation\uff09\u6700\u91cd\u8981\u7684\u7ec4\u4ef6\u4e4b\u4e00\uff0c\u5b83\u7684\u76ee\u6807\u4e0d\u4ec5\u4ec5\u662f\u4e00\u4e2a\u7f16\u6392\u7cfb\u7edf\uff0c\u800c\u662f\u63d0\u4f9b\u4e00\u4e2a\u89c4\u8303\uff0c\u53ef\u4ee5\u8ba9\u4f60\u6765\u63cf\u8ff0\u96c6\u7fa4\u7684\u67b6\u6784\uff0c\u5b9a\u4e49\u670d\u52a1\u7684\u6700\u7ec8\u72b6\u6001\uff0cKubernetes \u53ef\u4ee5\u5e2e\u4f60\u5c06\u7cfb\u7edf\u81ea\u52a8\u5730\u8fbe\u5230\u548c\u7ef4\u6301\u5728\u8fd9\u4e2a\u72b6\u6001\u3002Kubernetes \u4f5c\u4e3a\u4e91\u539f\u751f\u5e94\u7528\u7684\u57fa\u77f3\uff0c\u76f8\u5f53\u4e8e\u4e00\u4e2a\u4e91\u64cd\u4f5c\u7cfb\u7edf\uff0c\u5176\u91cd\u8981\u6027\u4e0d\u8a00\u800c\u55bb\u3002</p> <ul> <li>Docker \u7684\u4e00\u4e9b\u5e38\u7528\u65b9\u6cd5\uff0c\u5f53\u7136\u6211\u4eec\u7684\u91cd\u70b9\u4f1a\u5728 Kubernetes \u4e0a\u9762</li> <li>\u4f1a\u7528 kubeadm \u6765\u642d\u5efa\u4e00\u5957 Kubernetes \u7684\u96c6\u7fa4</li> <li>\u7406\u89e3 Kubernetes \u96c6\u7fa4\u7684\u8fd0\u884c\u539f\u7406</li> <li>\u5e38\u7528\u7684\u4e00\u4e9b\u63a7\u5236\u5668\u4f7f\u7528\u65b9\u6cd5</li> <li>\u8fd8\u6709 Kubernetes \u7684\u4e00\u4e9b\u8c03\u5ea6\u7b56\u7565</li> <li>Kubernetes \u7684\u8fd0\u7ef4\uff0c\u4f7f\u7528 Prometheus \u6765\u8fdb\u884c\u96c6\u7fa4\u76d1\u63a7\u62a5\u8b66\uff0cEFK \u8fdb\u884c\u65e5\u5fd7\u6536\u96c6</li> <li>\u5305\u7ba1\u7406\u5de5\u5177 Helm \u7684\u4f7f\u7528</li> <li>\u57fa\u4e8e Kubernetes \u7684 CI/CD</li> <li>Istio \u5728 Kubernetes \u4e2d\u7684\u4f7f\u7528</li> </ul>"},{"location":"docker/basic/","title":"\u57fa\u672c\u64cd\u4f5c","text":""},{"location":"docker/basic/#_1","title":"\u57fa\u672c\u64cd\u4f5c","text":"<p>\u955c\u50cf\u548c\u5bb9\u5668\u7684\u5e38\u7528\u64cd\u4f5c</p> <p>Docker \u7684\u57fa\u672c\u539f\u7406\u6211\u4eec\u5df2\u7ecf\u4e86\u89e3\u4e86\uff0c\u4e5f\u5df2\u7ecf\u5b89\u88c5\u4e0a\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u4e00\u8d77\u6765\u5b66\u4e60\u4e0b Docker \u7684\u5e38\u7528\u64cd\u4f5c\uff0c\u5b9e\u9645\u4e0a\u4e3b\u8981\u5c31\u662f Docker CLI \u7684\u4e00\u4e9b\u5e38\u7528\u547d\u4ee4\u4f7f\u7528\u3002</p> <p></p>"},{"location":"docker/basic/#_2","title":"\u955c\u50cf\u64cd\u4f5c","text":"<p>\u4e4b\u524d\u6211\u4eec\u63d0\u5230\u8fc7 Docker \u5b98\u65b9\u63d0\u4f9b\u4e86\u4e00\u4e2a\u516c\u5171\u7684\u955c\u50cf\u4ed3\u5e93\uff1aDocker Hub\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u4ece\u8fd9\u4e0a\u9762\u83b7\u53d6\u955c\u50cf\uff0c\u83b7\u53d6\u955c\u50cf\u7684\u547d\u4ee4\uff1a<code>docker pull</code>\uff0c\u683c\u5f0f\u4e3a\uff1a</p> <pre><code>$ docker pull [\u9009\u9879] [Docker Registry \u5730\u5740[:\u7aef\u53e3]/]\u4ed3\u5e93\u540d[:\u6807\u7b7e]\n</code></pre> <ul> <li>Docker \u955c\u50cf\u4ed3\u5e93\u5730\u5740\uff1a\u5730\u5740\u7684\u683c\u5f0f\u4e00\u822c\u662f <code>&lt;\u57df\u540d/IP&gt;[:\u7aef\u53e3\u53f7]</code>\uff0c\u9ed8\u8ba4\u5730\u5740\u662f Docker Hub \u5b98\u65b9\u5730\u5740\u3002</li> <li>\u4ed3\u5e93\u540d\uff1a\u8fd9\u91cc\u7684\u4ed3\u5e93\u540d\u662f\u4e24\u6bb5\u5f0f\u540d\u79f0\uff0c\u5373 <code>&lt;\u7528\u6237\u540d&gt;/&lt;\u8f6f\u4ef6\u540d&gt;</code>\u3002\u5bf9\u4e8e Docker Hub\uff0c\u5982\u679c\u4e0d\u7ed9\u51fa\u7528\u6237\u540d\uff0c\u5219\u9ed8\u8ba4\u4e3a library\uff0c\u4e5f\u5c31\u662f\u5b98\u65b9\u955c\u50cf\u3002\u6bd4\u5982\uff1a</li> </ul> <pre><code>$ docker pull ubuntu:04\n04: Pulling from library/ubuntu\n7ddbc47eeb70: Pull complete\nc1bbdc448b72: Pull complete\n8c3b70e39044: Pull complete\n45d437916d57: Pull complete\nDigest: sha256:6e9f67fa63b0323e9a1e587fd71c561ba48a034504fb804fd26fd8800039835d\nStatus: Downloaded newer image for ubuntu:04\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u4e2d\u6ca1\u6709\u7ed9\u51fa Docker \u955c\u50cf\u4ed3\u5e93\u5730\u5740\uff0c\u56e0\u6b64\u5c06\u4f1a\u4ece Docker Hub \u83b7\u53d6\u955c\u50cf\u3002\u800c\u955c\u50cf\u540d\u79f0\u662f ubuntu:18.04\uff0c\u56e0\u6b64\u5c06\u4f1a\u83b7\u53d6\u5b98\u65b9\u955c\u50cf <code>library/ubuntu</code> \u4ed3\u5e93\u4e2d\u6807\u7b7e\u4e3a 18.04 \u7684\u955c\u50cf\u3002\u4ece\u4e0b\u8f7d\u8fc7\u7a0b\u4e2d\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u4e4b\u524d\u63d0\u53ca\u7684\u5206\u5c42\u5b58\u50a8\u7684\u6982\u5ff5\uff0c\u955c\u50cf\u662f\u7531\u591a\u5c42\u5b58\u50a8\u6240\u6784\u6210\u3002\u4e0b\u8f7d\u4e5f\u662f\u4e00\u5c42\u5c42\u7684\u53bb\u4e0b\u8f7d\uff0c\u5e76\u975e\u5355\u4e00\u6587\u4ef6\u3002\u4e0b\u8f7d\u8fc7\u7a0b\u4e2d\u7ed9\u51fa\u4e86\u6bcf\u4e00\u5c42\u7684 ID \u7684\u524d 12 \u4f4d\u3002\u5e76\u4e14\u4e0b\u8f7d\u7ed3\u675f\u540e\uff0c\u7ed9\u51fa\u8be5\u955c\u50cf\u5b8c\u6574\u7684sha256 \u7684\u6458\u8981\uff0c\u4ee5\u786e\u4fdd\u4e0b\u8f7d\u4e00\u81f4\u6027\u3002</p> <p>\u7136\u540e\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u67e5\u770b\u7cfb\u7edf\u4e2d\u5df2\u6709\u7684\u955c\u50cf\uff1a</p> <pre><code>$ docker images\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\nubuntu              04               775349758637        19 hours ago        2MB\nbusybox             latest              020584afccce        42 hours ago        22MB\nhello-world         latest              fce289e99eb9        10 months ago       84kB\n</code></pre> <p>\u5217\u8868\u5305\u542b\u4e86\u4ed3\u5e93\u540d\u3001\u6807\u7b7e\u3001\u955c\u50cf ID\u3001\u521b\u5efa\u65f6\u95f4\u4ee5\u53ca\u6240\u5360\u7528\u7684\u7a7a\u95f4\u3002\u955c\u50cf ID \u5219\u662f\u955c\u50cf\u7684\u552f\u4e00\u6807\u8bc6\uff0c\u4e00\u4e2a\u955c\u50cf\u53ef\u4ee5\u5bf9\u5e94\u591a\u4e2a\u6807\u7b7e\u3002</p> <p>\u5982\u679c\u67d0\u4e2a\u955c\u50cf\u4e0d\u9700\u8981\u4e86\uff0c\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u9762\u547d\u4ee4\u5220\u9664\u955c\u50cf\uff1a</p> <pre><code># \u6839\u636e\u955c\u50cf\u540d\u6216\u8005\u955c\u50cfID\u5220\u9664\u90fd\u53ef\u4ee5\n$ docker rmi -f hello-world\nUntagged: hello-world:latest\nUntagged: hello-world@sha256:c3b4ada4687bbaa170745b3e4dd8ac3f194ca95b2d0518b417fb47e5879d9b5f\nDeleted: sha256:fce289e99eb9bca977dae136fbe2a82b6b7d4c372474c9235adc1741675f587e\n</code></pre> <p>\u8fd8\u53ef\u4ee5\u7ed9\u955c\u50cf\u91cd\u65b0\u6253\u4e0a\u4e00\u4e2a tag\uff1a</p> <pre><code>$ docker tag nginx nginx:test\n</code></pre> <p>\u53e6\u5916\u6211\u4eec\u8fd8\u53ef\u4ee5\u5c06\u955c\u50cf\u5bfc\u51fa\u6210\u4e00\u4e2a\u72ec\u7acb\u7684\u6587\u4ef6\uff1a</p> <pre><code>$ docker save nginx &gt;/tmp/nginx.tar.gz\n$ ls -la /tmp/nginx.tar.gz\n-rw-r--r--. 1 root root 130066944 Nov  2 02:58 /tmp/nginx.tar.gz\n</code></pre> <p>\u5bf9\u4e8e\u65e0\u6cd5\u8bbf\u95ee\u5916\u7f51\u7684\u8bf7\u60c5\u51b5\u4e0b\u4f1a\u7ecf\u5e38\u4f7f\u7528\u8fd9\u79cd\u65b9\u6cd5\u5bfc\u51fa\u955c\u50cf\uff0c\u7136\u540e\u4f7f\u7528 load \u547d\u4ee4\u5bfc\u5165\u955c\u50cf\uff1a</p> <pre><code>$ docker load &lt;/tmp/nginx.tar.gz\n</code></pre>"},{"location":"docker/basic/#_3","title":"\u8fd0\u884c\u5bb9\u5668","text":"<p>\u6709\u4e86\u955c\u50cf\u540e\uff0c\u6211\u4eec\u5c31\u80fd\u591f\u4ee5\u8fd9\u4e2a\u955c\u50cf\u4e3a\u57fa\u7840\u8fd0\u884c\u4e00\u4e2a\u5bb9\u5668\u3002\u4ee5\u4e0a\u9762\u7684 ubuntu:18.04 \u4e3a\u4f8b\uff0c\u5982\u679c\u6211\u4eec\u6253\u7b97\u542f\u52a8\u91cc\u9762\u7684 bash \u5e76\u4e14\u8fdb\u884c\u4ea4\u4e92\u5f0f\u64cd\u4f5c\u7684\u8bdd\uff0c\u53ef\u4ee5\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\uff1a</p> <pre><code>$ docker run -it --rm \\\\\n    ubuntu:04 \\\\\n    /bin/bash\n\nroot@ec125fc290ca:/# cat /etc/os-release\nNAME=\"Ubuntu\"\nVERSION=\"3 LTS (Bionic Beaver)\"\nID=ubuntu\nID_LIKE=debian\nPRETTY_NAME=\"Ubuntu 3 LTS\"\nVERSION_ID=\"04\"\nHOME_URL=\"https://www.ubuntu.com/\"\nSUPPORT_URL=\"https://help.ubuntu.com/\"\nBUG_REPORT_URL=\"https://bugs.launchpad.net/ubuntu/\"\nPRIVACY_POLICY_URL=\"https://www.ubuntu.com/legal/terms-and-policies/privacy-policy\"\nVERSION_CODENAME=bionic\nUBUNTU_CODENAME=bionic\n</code></pre> <p><code>docker run</code>\u5c31\u662f\u8fd0\u884c\u5bb9\u5668\u7684\u547d\u4ee4\uff0c\u6211\u4eec\u8fd9\u91cc\u7b80\u8981\u7684\u8bf4\u660e\u4e00\u4e0b\u4e0a\u9762\u7528\u5230\u7684\u53c2\u6570:</p> <ul> <li>-it\uff1a\u8fd9\u662f\u4e24\u4e2a\u53c2\u6570\uff0c\u4e00\u4e2a\u662f <code>-i</code> \u4ea4\u4e92\u5f0f\u64cd\u4f5c\uff0c\u4e00\u4e2a\u662f <code>-t</code> \u7ec8\u7aef\u3002\u6211\u4eec\u8fd9\u91cc\u6253\u7b97\u8fdb\u5165 bash \u6267\u884c\u4e00\u4e9b\u547d\u4ee4\u5e76\u67e5\u770b\u8fd4\u56de\u7ed3\u679c\uff0c\u56e0\u6b64\u6211\u4eec\u9700\u8981\u4ea4\u4e92\u5f0f\u7ec8\u7aef\u3002</li> <li>--rm\uff1a\u8fd9\u4e2a\u53c2\u6570\u662f\u8bf4\u5bb9\u5668\u9000\u51fa\u540e\u968f\u4e4b\u5c06\u5176\u5220\u9664\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u9000\u51fa\u7684\u5bb9\u5668\u5e76\u4e0d\u4f1a\u7acb\u5373\u5220\u9664\uff0c\u9664\u975e\u624b\u52a8 docker rm\u3002\u6211\u4eec\u8fd9\u91cc\u53ea\u662f\u6267\u884c\u4e2a\u547d\u4ee4\uff0c\u770b\u770b\u7ed3\u679c\uff0c\u4e0d\u9700\u8981\u4fdd\u7559\u7ed3\u679c\uff0c\u56e0\u6b64\u4f7f\u7528<code>--rm</code>\u53ef\u4ee5\u907f\u514d\u6d6a\u8d39\u7a7a\u95f4\u3002</li> <li>ubuntu:18.04\uff1a\u8fd9\u662f\u6307\u7528 ubuntu:18.04 \u955c\u50cf\u4e3a\u57fa\u7840\u6765\u542f\u52a8\u5bb9\u5668\u3002</li> <li>bash\uff1a\u653e\u5728\u955c\u50cf\u540d\u540e\u7684\u662f\u547d\u4ee4\uff0c\u8fd9\u91cc\u6211\u4eec\u5e0c\u671b\u6709\u4e2a\u4ea4\u4e92\u5f0f Shell\uff0c\u56e0\u6b64\u7528\u7684\u662f bash\u3002</li> </ul> <p>\u8fdb\u5165\u5bb9\u5668\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 Shell \u4e0b\u64cd\u4f5c\uff0c\u6267\u884c\u4efb\u4f55\u6240\u9700\u7684\u547d\u4ee4\u3002\u8fd9\u91cc\uff0c\u6211\u4eec\u6267\u884c\u4e86<code>cat /etc/os-release</code>\uff0c\u8fd9\u662f Linux \u5e38\u7528\u7684\u67e5\u770b\u5f53\u524d\u7cfb\u7edf\u7248\u672c\u7684\u547d\u4ee4\uff0c\u4ece\u8fd4\u56de\u7684\u7ed3\u679c\u53ef\u4ee5\u770b\u5230\u5bb9\u5668\u5185\u662f Ubuntu 16.04.4 LTS \u7cfb\u7edf\u3002\u6700\u540e\u6211\u4eec\u901a\u8fc7 exit \u9000\u51fa\u4e86\u8fd9\u4e2a\u5bb9\u5668\u3002</p> <p>\u5f53\u5229\u7528<code>docker run</code>\u6765\u521b\u5efa\u5bb9\u5668\u65f6\uff0cDocker \u5728\u540e\u53f0\u8fd0\u884c\u7684\u6d41\u7a0b\u5982\u4e0b\u6240\u793a\uff1a</p> <ul> <li>\u68c0\u67e5\u672c\u5730\u662f\u5426\u5b58\u5728\u6307\u5b9a\u7684\u955c\u50cf\uff0c\u4e0d\u5b58\u5728\u5c31\u4ece\u516c\u6709\u4ed3\u5e93\u4e0b\u8f7d</li> <li>\u5229\u7528\u955c\u50cf\u521b\u5efa\u5e76\u542f\u52a8\u4e00\u4e2a\u5bb9\u5668</li> <li>\u5206\u914d\u4e00\u4e2a\u6587\u4ef6\u7cfb\u7edf\uff0c\u5e76\u5728\u53ea\u8bfb\u7684\u955c\u50cf\u5c42\u5916\u9762\u6302\u8f7d\u4e00\u5c42\u53ef\u8bfb\u5199\u5c42</li> <li>\u4ece\u5bbf\u4e3b\u4e3b\u673a\u914d\u7f6e\u7684\u7f51\u6865\u63a5\u53e3\u4e2d\u6865\u63a5\u4e00\u4e2a\u865a\u62df\u63a5\u53e3\u5230\u5bb9\u5668\u4e2d\u53bb</li> <li>\u4ece\u5730\u5740\u6c60\u914d\u7f6e\u4e00\u4e2a ip \u5730\u5740\u7ed9\u5bb9\u5668</li> <li>\u6267\u884c\u7528\u6237\u6307\u5b9a\u7684\u5e94\u7528\u7a0b\u5e8f</li> <li>\u6267\u884c\u5b8c\u6bd5\u540e\u5bb9\u5668\u88ab\u7ec8\u6b62</li> </ul> <p>\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\u5bb9\u5668\u7ba1\u7406\u7684\u6838\u5fc3\u662f\u5bb9\u5668\u6267\u884c\u7684\u5e94\u7528\u7a0b\u5e8f\u8fd9\u4e2a\u8fdb\u7a0b\uff0c\u6240\u4ee5\u5982\u679c\u8fd9\u4e2a\u8fdb\u7a0b\u4e0d\u662f\u5e38\u9a7b\u524d\u53f0\u7684\u8bdd\u5219\u6267\u884c\u540e\u5bb9\u5668\u5c31\u4f1a\u9000\u51fa\u4e86\uff0c\u6bd4\u5982\u4e0a\u9762\u6211\u4eec\u662f\u6267\u884c\u7684 <code>/bin/bash</code> \u8fd9\u4e2a\u7a0b\u5e8f\uff0c\u8fd9\u4e2a\u7a0b\u5e8f\u4f1a\u5e38\u9a7b\u524d\u53f0\uff0c\u6240\u4ee5\u5bb9\u5668\u4f1a\u4e00\u76f4\u5b58\u5728\uff0c\u800c\u4e14\u8fd9\u4e2a\u8fd9\u4e2a\u7a0b\u5e8f\u5728\u5bb9\u5668\u4e2d\u7684\u8fdb\u7a0bID=1\uff1a</p> <pre><code>root@6bc39e8cd11c:/# ps\n  PID TTY          TIME CMD\n    1 pts/0    00:00:00 bash\n   11 pts/0    00:00:00 ps\n</code></pre> <p>\u4f46\u662f\u5982\u679c\u6211\u4eec\u8fd0\u884c\u4e00\u4e2a\u666e\u901a\u7684\u547d\u4ee4\u5462\uff1a</p> <pre><code>$ docker run -it ubuntu:04 ls\nbin   dev  home  lib64  mnt  proc  run   srv  tmp  var\nboot  etc  lib   media  opt  root  sbin  sys  usr\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8fd0\u884c\u540e\u5c31\u5bb9\u5668\u5c31\u76f4\u63a5\u9000\u51fa\u4e86\uff0c\u8fd9\u70b9\u975e\u5e38\u91cd\u8981\uff0c\u6240\u4ee5\u5982\u679c\u8981\u5728\u5bb9\u5668\u4e2d\u6267\u884c nginx \u7a0b\u5e8f\u7684\u8bdd\u8981\u8bb0\u4f4f\u4e0d\u8981\u7528 daemon \u6a21\u5f0f\u4e86\uff0c\u56e0\u4e3a\u6267\u884c\u540e\u5c31\u9000\u51fa\u5230\u540e\u53f0\u53bb\u4e86\uff0cDocker \u5c31\u6ca1\u529e\u6cd5\u7ba1\u7406\u4e86\uff0c\u5c31\u4f1a\u9000\u51fa\u5bb9\u5668\u4e86\u3002</p>"},{"location":"docker/basic/#_4","title":"\u5217\u51fa\u5bb9\u5668","text":"<p>\u5982\u679c\u8981\u67e5\u770b\u5f53\u524d\u7cfb\u7edf\u4e2d\u5df2\u7ecf\u8fd0\u884c\u7684\u5bb9\u5668\uff0c\u53ef\u4ee5\u7528\u5982\u4e0b\u547d\u4ee4\uff1a</p> <p><code>$ docker ps</code></p> <p>\u5982\u679c\u628a\u5df2\u7ecf\u9000\u51fa\u7684\u5bb9\u5668\u4e5f\u5217\u51fa\u6765\u53ef\u4ee5\u52a0\u4e0a <code>-a</code> \u53c2\u6570\uff1a</p> <pre><code>$ docker ps -a\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                         PORTS               NAMES\n2275424275b6        ubuntu:04        \"ls\"                3 minutes ago       Exited (0) 3 minutes ago                           ecstatic_gates\n6e4a54862340        fce289e99eb9        \"/hello\"            About an hour ago   Exited (0) About an hour ago                       jovial_khayyam\n</code></pre>"},{"location":"docker/basic/#_5","title":"\u5220\u9664\u5bb9\u5668","text":"<p>\u5982\u679c\u8981\u5220\u9664\u6216\u5f3a\u5236\u5220\u9664\u4e00\u4e2a\u5bb9\u5668\uff08\u5305\u62ec\u5df2\u9000\u51fa\u7684\uff09\u5219\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\uff1a</p> <pre><code># \u6839\u636e\u5bb9\u5668ID\u5f3a\u5236\u5220\u9664\u5bb9\u5668\n$ docker rm -f 2275424275b6\n</code></pre>"},{"location":"docker/basic/#_6","title":"\u540e\u53f0\u8fd0\u884c","text":"<p>\u66f4\u591a\u7684\u65f6\u5019\uff0c\u6211\u4eec\u9700\u8981\u8ba9 Docker \u5728\u540e\u53f0\u8fd0\u884c\u800c\u4e0d\u662f\u76f4\u63a5\u628a\u6267\u884c\u547d\u4ee4\u7684\u7ed3\u679c\u8f93\u51fa\u5728\u5f53\u524d\u5bbf\u4e3b\u673a\u4e0b\u3002\u6b64\u65f6\uff0c\u53ef\u4ee5\u901a\u8fc7\u6dfb\u52a0<code>-d</code>\u53c2\u6570\u6765\u5b9e\u73b0\u3002\u5982\u679c\u4e0d\u4f7f\u7528<code>-d</code>\u53c2\u6570\u8fd0\u884c\u5bb9\u5668\uff1a</p> <pre><code>$ docker run ubuntu:04 /bin/sh -c \"while true; do echo hello world; sleep 1; done\"\nhello world\nhello world\nhello world\nhello world\n</code></pre> <p>\u5bb9\u5668\u4f1a\u628a\u8f93\u51fa\u7684\u7ed3\u679c (STDOUT) \u6253\u5370\u5230\u5bbf\u4e3b\u673a\u4e0a\u9762\u3002\u5982\u679c\u4f7f\u7528\u4e86<code>-d</code>\u53c2\u6570\u8fd0\u884c\u5bb9\u5668\uff1a</p> <pre><code>$ docker run -d ubuntu:04 /bin/sh -c \"while true; do echo hello world; sleep 1; done\"\n501f4d9538a0b01f0ac422089258ad71fa88c016f2662c1120c1499b5fbc930f\n</code></pre> <p>\u6b64\u65f6\u5bb9\u5668\u4f1a\u5728\u540e\u53f0\u8fd0\u884c\u5e76\u4e0d\u4f1a\u628a\u8f93\u51fa\u7684\u7ed3\u679c (STDOUT) \u6253\u5370\u5230\u5bbf\u4e3b\u673a\u4e0a\u9762(\u8f93\u51fa\u7ed3\u679c\u53ef\u4ee5\u7528 docker logs \u67e5\u770b)\uff1a</p> <pre><code># docker logs -f [container ID or NAMES]\n$ docker logs -f 501f4d9538a0b01f0ac422089258ad71fa88c016f2662c1120c1499b5fbc930f\nhello world\nhello world\nhello world\n</code></pre> <p>\u6ce8\uff1a\u5bb9\u5668\u662f\u5426\u4f1a\u957f\u4e45\u8fd0\u884c\uff0c\u662f\u548c docker run \u6307\u5b9a\u7684\u547d\u4ee4\u6709\u5173\uff0c\u548c -d \u53c2\u6570\u65e0\u5173\u3002</p> <p>\u4f7f\u7528 <code>-d</code> \u53c2\u6570\u542f\u52a8\u540e\u4f1a\u8fd4\u56de\u4e00\u4e2a\u552f\u4e00\u7684\u5bb9\u5668 id\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u901a\u8fc7<code>docker ps</code>\u547d\u4ee4\u6765\u67e5\u770b\u5bb9\u5668\u4fe1\u606f\u3002</p>"},{"location":"docker/basic/#_7","title":"\u7ec8\u6b62\u5bb9\u5668","text":"<p>\u53e6\u5916\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528</p> <pre><code>docker stop [container ID or NAMES]\n</code></pre> <p>\u6765\u7ec8\u6b62\u4e00\u4e2a\u8fd0\u884c\u4e2d\u7684\u5bb9\u5668\u3002\u6b64\u5916\uff0c\u5f53 Docker \u5bb9\u5668\u4e2d\u6307\u5b9a\u7684\u5e94\u7528\u7ec8\u7ed3\u65f6\uff0c\u5bb9\u5668\u4e5f\u81ea\u52a8\u7ec8\u6b62\u3002\u4f8b\u5982\u524d\u9762\u53ea\u542f\u52a8\u4e86\u4e00\u4e2a\u7ec8\u7aef\u7684\u5bb9\u5668\uff0c\u7528\u6237\u901a\u8fc7 exit \u547d\u4ee4\u6216 Ctrl+d \u6765\u9000\u51fa\u7ec8\u7aef\u65f6\uff0c\u6240\u521b\u5efa\u7684\u5bb9\u5668\u7acb\u523b\u7ec8\u6b62\u3002\u7ec8\u6b62\u72b6\u6001\u7684\u5bb9\u5668\u53ef\u4ee5\u7528<code>docker ps -a</code> \u547d\u4ee4\u770b\u5230\uff1a</p> <pre><code>$ docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS               NAMES\n501f4d9538a0        ubuntu:04        \"/bin/sh -c 'while t\u2026\"   About a minute ago   Up About a minute                       nervous_ganguly\n$ docker stop 501f4d9538a0\n501f4d9538a0\n$ docker ps\nCONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES\n</code></pre> <p>\u540c\u6837\u53ef\u4ee5\u7528</p> <pre><code>docker start [container ID or NAMES]\n</code></pre> <p>\u547d\u4ee4\u6765\u542f\u52a8\u4e00\u4e2a\u7ec8\u6b62\u7684\u5bb9\u5668\uff1a</p> <pre><code>$ docker start 501f4d9538a0\n501f4d9538a0\n$ docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES\n501f4d9538a0        ubuntu:04        \"/bin/sh -c 'while t\u2026\"   5 minutes ago       Up 2 seconds                            nervous_ganguly\n</code></pre>"},{"location":"docker/basic/#_8","title":"\u7f51\u7edc","text":""},{"location":"docker/basic/#_9","title":"\u7aef\u53e3\u66b4\u9732","text":"<p>Docker \u5bb9\u5668\u66f4\u591a\u60c5\u51b5\u4e0b\u662f\u7528\u6765\u8fd0\u884c Web \u5e94\u7528\u7684\uff0c\u6240\u4ee5\u8981\u5982\u4f55\u8bbf\u95ee\u5230\u5bb9\u5668\u4e2d\u7684 Web \u670d\u52a1\u5462\uff1f\u6bd4\u5982\u6211\u4eec\u73b0\u5728\u8fd0\u884c\u4e00\u4e2a nginx \u5bb9\u5668\u670d\u52a1\uff1a</p> <pre><code>$ docker run --name webserver -d nginx\nUnable to find image 'nginx:latest' locally\nlatest: Pulling from library/nginx\n8d691f585fa8: Pull complete\n5b07f4e08ad0: Pull complete\nabc291867bca: Pull complete\nDigest: sha256:922c815aa4df050d4df476e92daed4231f466acc8ee90e0e774951b0fd7195a4\nStatus: Downloaded newer image for nginx:latest\ne8b034c01f4024162cefc45006738fce85b3fa1b717a6ff24520c0fcfabaf5b6\n</code></pre> <p>nginx \u955c\u50cf\u6ca1\u6709\u6307\u5b9a tag \u6807\u7b7e\uff0c\u5219\u9ed8\u8ba4\u5c31\u662f\u62c9\u53d6<code>nginx:latest</code>\u955c\u50cf\uff1b\u5176\u4e2d<code>--name</code>\u53c2\u6570\u6307\u5b9a\u5bb9\u5668\u7684\u540d\u79f0\uff0c\u4e0d\u6307\u5b9a\u5219\u662f\u968f\u673a\u7684\u5bb9\u5668\u540d\uff0c\u8fd0\u884c\u6210\u529f\u540e\u53ef\u4ee5\u901a\u8fc7<code>docker ps</code>\u547d\u4ee4\u67e5\u770b\u5bb9\u5668\u4fe1\u606f\uff1a</p> <pre><code>$ docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS               NAMES\ne8b034c01f40        nginx               \"nginx -g 'daemon of\u2026\"   About a minute ago   Up About a minute   80/tcp              webserver\n</code></pre> <p>\u4f46\u662f\u6211\u4eec\u8981\u600e\u4e48\u53bb\u8bbf\u95ee\u8fd9\u4e2a nginx \u670d\u52a1\u5462\uff1f\u5b9e\u9645\u4e0a\u5728\u6211\u4eec\u542f\u52a8\u5bb9\u5668\u7684\u65f6\u5019\uff0cDocker \u5c31\u4f1a\u4e3a\u6211\u4eec\u7684\u5bb9\u5668\u5206\u914d\u4e00\u4e2a IP \u5730\u5740\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u6765\u83b7\u53d6\u5bb9\u5668\u7684 IP \u5730\u5740\uff1a</p> <pre><code>$ docker inspect webserver |grep IPAddress\n            \"SecondaryIPAddresses\": null,\n            \"IPAddress\": \"14\",\n                    \"IPAddress\": \"14\",\n</code></pre> <p>\u5176\u4e2d\u7684 <code>172.17.0.4</code>\u5c31\u662f\u5bb9\u5668 webserver \u7684\u5730\u5740\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8be5\u5730\u5740\u8bbf\u95ee\u5230 nginx \u670d\u52a1\uff1a</p> <pre><code>$ curl http://14\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n    body {\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    }\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>\u4f46\u662f\u8fd9\u6837\u4e0d\u591f\u65b9\u4fbf\uff0c\u56e0\u4e3a\u542f\u52a8\u5bb9\u5668\u7684\u4ee3\u4ef7\u5f88\u5c0f\uff0c\u6240\u4ee5\u5bb9\u5668\u7684 IP \u8fd9\u4e9b\u7ecf\u5e38\u53d8\u52a8\uff0c\u662f\u5426\u80fd\u591f\u901a\u8fc7\u5bbf\u4e3b\u673a\u7684\u65b9\u5f0f\u53bb\u8bbf\u95ee\u5462\uff1f\u5b9e\u9645\u4e0a\u662f\u53ef\u4ee5\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u91cd\u65b0\u542f\u52a8\u4e00\u4e2a\u65b0\u7684\u5bb9\u5668\uff1a</p> <pre><code>$ docker rm -f webserver\n$ docker run --name webserver -d -p 80:80 nginx\n</code></pre> <p>\u6211\u4eec\u5728\u542f\u52a8\u5bb9\u5668\u7684\u65f6\u5019\u6dfb\u52a0\u4e86\u4e00\u4e2a\u65b0\u7684\u53c2\u6570<code>-p 8080:80</code>\uff0c\u8fd9\u4e2a\u53c2\u6570\u7684\u610f\u601d\u662f\u5c06\u5bbf\u4e3b\u673a\u7684 8080 \u7aef\u53e3\u548c\u5bb9\u5668\u7684 80 \u7aef\u53e3\u8fdb\u884c\u7ed1\u5b9a\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u5bbf\u4e3b\u673a\u7684 8080 \u7aef\u53e3\u6765\u8bbf\u95ee\u5bb9\u5668\u670d\u52a1\u4e86\u3002</p> <pre><code>$ docker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS                NAMES\n89e105d56215        nginx               \"nginx -g 'daemon of\u2026\"   About a minute ago   Up About a minute   0:8080-&gt;80/tcp   webserver\n$ curl http://localhost:8080\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n    body {\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    }\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre>"},{"location":"docker/basic/#bridge","title":"Bridge \u6a21\u5f0f","text":"<p>\u5f53 Docker \u8fdb\u7a0b\u542f\u52a8\u65f6\uff0c\u4f1a\u5728\u4e3b\u673a\u4e0a\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a<code>docker0</code>\u7684\u865a\u62df\u7f51\u6865\uff0c\u6b64\u4e3b\u673a\u4e0a\u542f\u52a8\u7684 Docker \u5bb9\u5668\u4f1a\u8fde\u63a5\u5230\u8fd9\u4e2a\u865a\u62df\u7f51\u6865\u4e0a\u3002\u865a\u62df\u7f51\u6865\u7684\u5de5\u4f5c\u65b9\u5f0f\u548c\u7269\u7406\u4ea4\u6362\u673a\u7c7b\u4f3c\uff0c\u8fd9\u6837\u4e3b\u673a\u4e0a\u7684\u6240\u6709\u5bb9\u5668\u5c31\u901a\u8fc7\u4ea4\u6362\u673a\u8fde\u5728\u4e86\u4e00\u4e2a\u4e8c\u5c42\u7f51\u7edc\u4e2d\u3002\u4ece docker0 \u5b50\u7f51\u4e2d\u5206\u914d\u4e00\u4e2a IP \u7ed9\u5bb9\u5668\u4f7f\u7528\uff0c\u5e76\u8bbe\u7f6e docker0 \u7684 IP \u5730\u5740\u4e3a\u5bb9\u5668\u7684\u9ed8\u8ba4\u7f51\u5173\u3002\u5728\u4e3b\u673a\u4e0a\u521b\u5efa\u4e00\u5bf9\u865a\u62df\u7f51\u5361<code>veth pair</code>\u8bbe\u5907\uff0cDocker \u5c06 veth pair \u8bbe\u5907\u7684\u4e00\u7aef\u653e\u5728\u65b0\u521b\u5efa\u7684\u5bb9\u5668\u4e2d\uff0c\u5e76\u547d\u540d\u4e3a eth0\uff08\u5bb9\u5668\u7684\u7f51\u5361\uff09\uff0c\u53e6\u4e00\u7aef\u653e\u5728\u4e3b\u673a\u4e2d\uff0c\u4ee5<code>vethxxx</code>\u8fd9\u6837\u7c7b\u4f3c\u7684\u540d\u5b57\u547d\u540d\uff0c\u5e76\u5c06\u8fd9\u4e2a\u7f51\u7edc\u8bbe\u5907\u52a0\u5165\u5230 docker0 \u7f51\u6865\u4e2d\u3002\u53ef\u4ee5\u901a\u8fc7<code>brctl show</code>\u547d\u4ee4\u67e5\u770b\uff1a</p> <pre><code>$ brctl show\nbridge name bridge id       STP enabled interfaces\ndocker0     80024286df8f39   no      veth1040b0a\n                            veth5a2ba56\n                            veth7aa7e71\n</code></pre> <p>bridge \u6a21\u5f0f\u662f docker \u7684\u9ed8\u8ba4\u7f51\u7edc\u6a21\u5f0f\uff0c\u4f7f\u7528<code>docker run -p</code>\u65f6\uff0c\u5b9e\u9645\u4e0a\u662f\u901a\u8fc7 iptables \u505a\u4e86<code>DNAT</code>\u89c4\u5219\uff0c\u5b9e\u73b0\u7aef\u53e3\u8f6c\u53d1\u529f\u80fd\u3002\u53ef\u4ee5\u4f7f\u7528iptables -t nat -vnL\u67e5\u770b\u3002bridge\u6a21\u5f0f\u5982\u4e0b\u56fe\u6240\u793a\uff1a\u200b\u200b</p> <p></p> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u8fd0\u884c\u4e00\u4e2a busybox \u5bb9\u5668\uff1a</p> <pre><code>$ docker run -tid --net=bridge --name docker_bri busybox top\n$ brctl show\nbrctl show\nbridge name bridge id       STP enabled interfaces\ndocker0     80024286df8f39   no      veth1040b0a\n                            veth27bc18a\n                            veth5a2ba56\n                            veth7aa7e71\n</code></pre> <p>\u7136\u540e\u8fdb\u5165\u5230\u5bb9\u5668\u5185\u90e8\u53bb\u67e5\u770b\u7f51\u7edc\u60c5\u51b5\uff0c\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u4f7f\u7528\u5230\u4e00\u4e2a\u65b0\u7684\u547d\u4ee4<code>docker exec</code>\uff0c\u7528\u6765\u8fdb\u5165\u5bb9\u5668\u5185\u90e8\uff0c\u8981\u8bb0\u4f4f\u6211\u4eec\u8981\u8fdb\u884c\u7ec8\u7aef\u4ea4\u4e92\uff0c\u6240\u4ee5\u8981\u5e26\u4e0a<code>-it</code>\u4e24\u4e2a\u53c2\u6570\uff1a</p> <pre><code>$ docker exec -it docker_bri /bin/sh\n/ # ifconfig -a\neth0      Link encap:Ethernet  HWaddr 02:42:AC:11:00:05\n          inet addr:15  Bcast:12255  Mask:220\n          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1\n          RX packets:8 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:0\n          RX bytes:648 (60 B)  TX bytes:0 (0 B)\n\nlo        Link encap:Local Loopback\n          inet addr:11  Mask:20\n          UP LOOPBACK RUNNING  MTU:65536  Metric:1\n          RX packets:0 errors:0 dropped:0 overruns:0 frame:0\n          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0\n          collisions:0 txqueuelen:0\n          RX bytes:0 (0 B)  TX bytes:0 (0 B)\n\n/ # route -n\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n0         11      0         UG    0      0        0 eth0\n10      0         220     U     0      0        0 eth0\n</code></pre> <p>\u53ef\u4ee5\u901a\u8fc7<code>ip link show</code>\u547d\u4ee4\u67e5\u770b\u5230\u5bf9\u5e94\u7684 veth pair \u5bf9\u540d\u79f0\u3002</p> <p>\u901a\u8fc7\u4e0a\u9762\u7684\u547d\u4ee4\u53ef\u4ee5\u9a8c\u8bc1\u6211\u4eec\u524d\u9762\u63d0\u5230\u7684 bridge \u6a21\u5f0f\u539f\u7406\u3002</p>"},{"location":"docker/basic/#_10","title":"\u81ea\u5b9a\u4e49\u7f51\u7edc","text":"<p>\u53e6\u5916\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u81ea\u5b9a\u4e49\u7684 Docker \u7f51\u7edc\u6765\u8fde\u63a5\u591a\u4e2a\u5bb9\u5668\uff0c\u800c\u4e0d\u662f\u4f7f\u7528<code>--link</code>\u547d\u4ee4\uff0c\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u6709\u4e00\u4e2a\u65b0\u7684\u5bb9\u5668\u60f3\u8981\u548c\u4e0a\u9762\u7684 docker_bri \u5bb9\u5668\u5efa\u7acb\u4e92\u8fde\u5173\u7cfb\uff0c\u4e4b\u524d\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>--link</code> \u547d\u4ee4\uff1a</p> <pre><code>$ docker run -tid --link docker_bri --name docker_bri1 busybox top\n2cba17dd1326c2c82d8fa415588a0169e7291d1a44d2accaff25d50216830777\n$ docker exec -it docker_bri1 /bin/sh\n/ # ping docker_bri\nPING docker_bri (15): 56 data bytes\n64 bytes from 15: seq=0 ttl=64 time=194 ms\n64 bytes from 15: seq=1 ttl=64 time=156 ms\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5728\u65b0\u521b\u5efa\u7684\u5bb9\u5668\u4e0a\u53ef\u4ee5\u8bbf\u95ee\u5230\u6211\u4eec\u8fde\u63a5\u7684\u5bb9\u5668\uff0c\u4f46\u662f\u53cd\u8fc7\u6765\u5374\u4e0d\u884c\u4e86\uff0c\u56e0\u4e3a<code>--link</code>\u662f\u5355\u65b9\u9762\u7684\uff1a</p> <pre><code>$ docker exec -it docker_bri /bin/sh\n/ # ping docker_bri1\nping: bad address 'docker_bri1'\n/ #\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u81ea\u5b9a\u4e49\u7f51\u7edc\u7684\u65b9\u5f0f\u6765\u5b9e\u73b0\u4e92\u8054\u4e92\u901a\uff0c\u9996\u5148\u521b\u5efa\u4e00\u4e2a\u81ea\u5b9a\u4e49\u7684\u7f51\u7edc\uff1a</p> <pre><code>$ docker network create -d bridge my-net\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u4f7f\u7528\u81ea\u5b9a\u4e49\u7684\u7f51\u7edc\u8fd0\u884c\u4e00\u4e2a\u5bb9\u5668\uff1a</p> <pre><code>$ docker run -it --rm --name busybox1 --network my-net busybox sh\n</code></pre> <p>\u6253\u5f00\u7ec8\u7aef\u518d\u8fd0\u884c\u4e00\u4e2a\u5bb9\u5668\uff1a</p> <pre><code>$ docker run -it --rm --name busybox2 --network my-net busybox sh\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u901a\u8fc7 ping \u6765\u8bc1\u660e busybox1 \u5bb9\u5668\u548c busybox2 \u5bb9\u5668\u5efa\u7acb\u4e86\u4e92\u8054\u5173\u7cfb\u3002 \u5728 busybox1 \u5bb9\u5668\u8f93\u5165\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>/ # ping busybox2\nPING busybox2 (13): 56 data bytes\n64 bytes from 13: seq=0 ttl=64 time=072 ms\n64 bytes from 13: seq=1 ttl=64 time=118 ms\n</code></pre> <p>\u7528 ping \u6765\u6d4b\u8bd5\u8fde\u63a5 busybox2 \u5bb9\u5668\uff0c\u5b83\u4f1a\u89e3\u6790\u6210 172.19.0.3\u3002 \u540c\u7406\u5728 busybox2 \u5bb9\u5668\u6267\u884c ping busybox1\uff0c\u4e5f\u4f1a\u6210\u529f\u8fde\u63a5\u5230\uff1a</p> <pre><code>/ # ping busybox1\nPING busybox1 (12): 56 data bytes\n64 bytes from 12: seq=0 ttl=64 time=064 ms\n64 bytes from 12: seq=1 ttl=64 time=143 ms\n</code></pre> <p>\u8fd9\u6837\uff0cbusybox1 \u5bb9\u5668\u548c busybox2 \u5bb9\u5668\u5efa\u7acb\u4e86\u4e92\u8054\u5173\u7cfb\uff0c\u5982\u679c\u4f60\u6709\u591a\u4e2a\u5bb9\u5668\u4e4b\u95f4\u9700\u8981\u4e92\u76f8\u8fde\u63a5\uff0c\u63a8\u8350\u4f7f\u7528\u540e\u9762\u7684 Docker Compose\u3002</p>"},{"location":"docker/basic/#host","title":"Host \u6a21\u5f0f","text":"<p>\u5982\u679c\u542f\u52a8\u5bb9\u5668\u7684\u65f6\u5019\u4f7f\u7528 host \u6a21\u5f0f\uff0c\u90a3\u4e48\u8fd9\u4e2a\u5bb9\u5668\u5c06\u4e0d\u4f1a\u83b7\u5f97\u4e00\u4e2a\u72ec\u7acb\u7684<code>Network Namespace</code>\uff0c\u800c\u662f\u548c\u5bbf\u4e3b\u673a\u5171\u7528\u4e00\u4e2a Network Namespace\u3002\u5bb9\u5668\u5c06\u4e0d\u4f1a\u865a\u62df\u51fa\u81ea\u5df1\u7684\u7f51\u5361\uff0c\u914d\u7f6e\u81ea\u5df1\u7684 IP \u7b49\uff0c\u800c\u662f\u4f7f\u7528\u5bbf\u4e3b\u673a\u7684 IP \u548c\u7aef\u53e3\u3002\u4f46\u662f\uff0c\u5bb9\u5668\u7684\u5176\u4ed6\u65b9\u9762\uff0c\u5982\u6587\u4ef6\u7cfb\u7edf\u3001\u8fdb\u7a0b\u5217\u8868\u7b49\u8fd8\u662f\u548c\u5bbf\u4e3b\u673a\u9694\u79bb\u7684\u3002 Host\u6a21\u5f0f\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p>\u200b\u200b</p> <p>\u4f7f\u7528 host \u6a21\u5f0f\u4e5f\u5f88\u7b80\u5355\uff0c\u53ea\u9700\u8981\u5728\u8fd0\u884c\u5bb9\u5668\u7684\u65f6\u5019\u6307\u5b9a <code>--net=host</code> \u5373\u53ef\u3002</p>"},{"location":"docker/basic/#container","title":"Container \u6a21\u5f0f","text":"<p>\u8fd9\u4e2a\u6a21\u5f0f\u6307\u5b9a\u65b0\u521b\u5efa\u7684\u5bb9\u5668\u548c\u5df2\u7ecf\u5b58\u5728\u7684\u4e00\u4e2a\u5bb9\u5668\u5171\u4eab\u4e00\u4e2a Network Namespace\uff0c\u800c\u4e0d\u662f\u548c\u5bbf\u4e3b\u673a\u5171\u4eab\u3002\u65b0\u521b\u5efa\u7684\u5bb9\u5668\u4e0d\u4f1a\u521b\u5efa\u81ea\u5df1\u7684\u7f51\u5361\uff0c\u914d\u7f6e\u81ea\u5df1\u7684 IP\uff0c\u800c\u662f\u548c\u4e00\u4e2a\u6307\u5b9a\u7684\u5bb9\u5668\u5171\u4eab IP\u3001\u7aef\u53e3\u8303\u56f4\u7b49\u3002\u540c\u6837\uff0c\u4e24\u4e2a\u5bb9\u5668\u9664\u4e86\u7f51\u7edc\u65b9\u9762\uff0c\u5176\u4ed6\u7684\u5982\u6587\u4ef6\u7cfb\u7edf\u3001\u8fdb\u7a0b\u5217\u8868\u7b49\u8fd8\u662f\u9694\u79bb\u7684\u3002\u4e24\u4e2a\u5bb9\u5668\u7684\u8fdb\u7a0b\u53ef\u4ee5\u901a\u8fc7 lo \u7f51\u5361\u8bbe\u5907\u901a\u4fe1\u3002 Container \u6a21\u5f0f\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u5728\u8fd0\u884c\u5bb9\u5668\u7684\u65f6\u5019\u6307\u5b9a </p> <pre><code>--net=container:\u76ee\u6807\u5bb9\u5668\u540d\n</code></pre> <p>\u5373\u53ef\u3002\u5b9e\u9645\u4e0a\u6211\u4eec\u540e\u9762\u8981\u5b66\u4e60\u7684 Kubernetes \u91cc\u9762\u7684 Pod \u4e2d\u5bb9\u5668\u4e4b\u95f4\u5c31\u662f\u901a\u8fc7 Container \u6a21\u5f0f\u94fe\u63a5\u5230 pause \u5bb9\u5668\u4e0a\u9762\u7684\uff0c\u6240\u4ee5\u5bb9\u5668\u76f4\u63a5\u53ef\u4ee5\u901a\u8fc7 localhost \u6765\u8fdb\u884c\u8bbf\u95ee\u3002</p>"},{"location":"docker/basic/#none","title":"None \u6a21\u5f0f","text":"<p>\u4f7f\u7528 non e\u6a21\u5f0f\uff0cDocker \u5bb9\u5668\u62e5\u6709\u81ea\u5df1\u7684 Network Namespace\uff0c\u4f46\u662f\u5e76\u4e0d\u4e3aDocker \u5bb9\u5668\u8fdb\u884c\u4efb\u4f55\u7f51\u7edc\u914d\u7f6e\u3002\u4e5f\u5c31\u662f\u8bf4\u8fd9\u4e2a Docker \u5bb9\u5668\u6ca1\u6709\u7f51\u5361\u3001IP\u3001\u8def\u7531\u7b49\u4fe1\u606f\u3002\u9700\u8981\u6211\u4eec\u81ea\u5df1\u4e3a Docker \u5bb9\u5668\u6dfb\u52a0\u7f51\u5361\u3001\u914d\u7f6e IP \u7b49\u3002 None\u6a21\u5f0f\u793a\u610f\u56fe\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u9009\u62e9\u8fd9\u79cd\u6a21\u5f0f\uff0c\u4e00\u822c\u662f\u7528\u6237\u5bf9\u7f51\u7edc\u6709\u81ea\u5df1\u7279\u6b8a\u7684\u9700\u6c42\uff0c\u4e0d\u5e0c\u671b docker \u9884\u8bbe\u7f6e\u592a\u591a\u7684\u4e1c\u897f\u3002</p>"},{"location":"docker/basic/#_11","title":"\u6570\u636e\u5171\u4eab\u4e0e\u6301\u4e45\u5316","text":"<p>\u63a5\u4e0b\u6765\u4ecb\u7ecd\u5982\u4f55\u5728 Docker \u5185\u90e8\u4ee5\u53ca\u5bb9\u5668\u4e4b\u95f4\u7ba1\u7406\u6570\u636e\uff0c\u5728\u5bb9\u5668\u4e2d\u7ba1\u7406\u6570\u636e\u4e3b\u8981\u6709\u4e24\u79cd\u65b9\u5f0f\uff1a</p> <ul> <li>\u6570\u636e\u5377\uff08Data Volumes\uff09</li> <li>\u6302\u8f7d\u4e3b\u673a\u76ee\u5f55 (Bind mounts)</li> </ul>"},{"location":"docker/basic/#_12","title":"\u6570\u636e\u5377","text":"<p><code>\u6570\u636e\u5377</code>\u662f\u4e00\u4e2a\u53ef\u4f9b\u4e00\u4e2a\u6216\u591a\u4e2a\u5bb9\u5668\u4f7f\u7528\u7684\u7279\u6b8a\u76ee\u5f55\uff0c\u5b83\u7ed5\u8fc7 UFS\uff0c\u53ef\u4ee5\u63d0\u4f9b\u5f88\u591a\u6709\u7528\u7684\u7279\u6027\uff1a</p> <ul> <li>\u6570\u636e\u5377\u53ef\u4ee5\u5728\u5bb9\u5668\u4e4b\u95f4\u5171\u4eab\u548c\u91cd\u7528</li> <li>\u5bf9\u6570\u636e\u5377\u7684\u4fee\u6539\u4f1a\u7acb\u9a6c\u751f\u6548</li> <li>\u5bf9\u6570\u636e\u5377\u7684\u66f4\u65b0\uff0c\u4e0d\u4f1a\u5f71\u54cd\u955c\u50cf</li> <li>\u6570\u636e\u5377\u9ed8\u8ba4\u4f1a\u4e00\u76f4\u5b58\u5728\uff0c\u5373\u4f7f\u5bb9\u5668\u88ab\u5220\u9664</li> </ul> <p>\u6570\u636e\u5377</p> <p>\u6ce8\u610f\uff1a\u6570\u636e\u5377 \u7684\u4f7f\u7528\uff0c\u7c7b\u4f3c\u4e8e Linux \u4e0b\u5bf9\u76ee\u5f55\u6216\u6587\u4ef6\u8fdb\u884c mount\uff0c\u955c\u50cf\u4e2d\u7684\u88ab\u6307\u5b9a\u4e3a\u6302\u8f7d\u70b9\u7684\u76ee\u5f55\u4e2d\u7684\u6587\u4ef6\u4f1a\u9690\u85cf\u6389\uff0c\u663e\u793a\u7684\u662f\u6302\u8f7d\u7684 \u6570\u636e\u5377\u3002</p> <p>\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u521b\u5efa\u4e00\u4e2a\u6570\u636e\u5377\uff1a</p> <pre><code>$ docker volume create my-vol\n</code></pre> <p>\u67e5\u770b\u6570\u636e\u5377\uff1a</p> <pre><code>$ docker volume ls\nlocal               my-vol\n</code></pre> <p>\u540c\u6837\u53ef\u4ee5\u901a\u8fc7 inspect \u547d\u4ee4\u67e5\u770b\u6570\u636e\u5377\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>$ docker volume inspect my-vol\n[\n    {\n        \"CreatedAt\": \"2019-11-02T03:08:02+08:00\",\n        \"Driver\": \"local\",\n        \"Labels\": {},\n        \"Mountpoint\": \"/data/docker/volumes/my-vol/_data\",\n        \"Name\": \"my-vol\",\n        \"Options\": {},\n        \"Scope\": \"local\"\n    }\n]\n</code></pre> <p>\u542f\u52a8\u4e00\u4e2a\u6302\u8f7d\u6570\u636e\u5377\u7684\u5bb9\u5668\uff1a\u5728\u7528<code>docker run</code>\u547d\u4ee4\u7684\u65f6\u5019\uff0c\u4f7f\u7528<code>--mount</code>\u6216\u8005<code>-v</code>\u6807\u8bb0\u6765\u5c06<code>\u6570\u636e\u5377</code>\u6302\u8f7d\u5230\u5bb9\u5668\u91cc\u3002\u4e0b\u9762\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a web \u7684\u5bb9\u5668\uff0c\u5e76\u52a0\u8f7d\u4e00\u4e2a\u6570\u636e\u5377\u5230\u5bb9\u5668\u7684 /usr/share/nginx/html \u76ee\u5f55\uff1a</p> <pre><code># -v my-vol:/xxxx\n# --mount source=my-vol,target=/xxxx\n$ docker run -d -p 8080:80 --name web -v my-vol:/usr/share/nginx/html nginx\n</code></pre> <p>\u8fd0\u884c\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u67e5\u770b\u6570\u636e\u5377\u76ee\u5f55\u4e0b\u9762\u5df2\u7ecf\u6709\u6587\u4ef6\u4e86\uff1a</p> <pre><code>$ ls /data/docker/volumes/my-vol/_data/\n50x.html  index.html\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7<code>localhost:8080</code>\u8bbf\u95ee\u5bb9\u5668\u670d\u52a1\uff1a</p> <pre><code>$ curl http://localhost:8080\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n    body {\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    }\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u628a\u6570\u636e\u4e0b\u9762\u7684 index.html \u6587\u4ef6\u5185\u5bb9\u53d8\u66f4\u4e0b\uff1a</p> <pre><code>$ echo \"Hello Docker\" &gt; /data/docker/volumes/my-vol/_data/index.html\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u91cd\u65b0\u8bbf\u95ee\u5c31\u53ef\u4ee5\u770b\u5230\u5185\u5bb9\u5df2\u7ecf\u53d8\u5316\u4e86\uff1a</p> <pre><code>$ curl http://localhost:8080\nHello Docker\n</code></pre> <p>\u6570\u636e\u5377\u662f\u88ab\u8bbe\u8ba1\u7528\u6765\u6301\u4e45\u5316\u6570\u636e\u7684\uff0c\u5b83\u7684\u751f\u547d\u5468\u671f\u72ec\u7acb\u4e8e\u5bb9\u5668\uff0cDocker \u4e0d\u4f1a\u5728\u5bb9\u5668\u88ab\u5220\u9664\u540e\u81ea\u52a8\u5220\u9664 \u6570\u636e\u5377\uff0c\u5e76\u4e14\u4e5f\u4e0d\u5b58\u5728\u5783\u573e\u56de\u6536\u8fd9\u6837\u7684\u673a\u5236\u6765\u5904\u7406\u6ca1\u6709\u4efb\u4f55\u5bb9\u5668\u5f15\u7528\u7684\u6570\u636e\u5377\u3002\u5982\u679c\u9700\u8981\u5728\u5220\u9664\u5bb9\u5668\u7684\u540c\u65f6\u79fb\u9664\u6570\u636e\u5377\u3002\u53ef\u4ee5\u5728\u5220\u9664\u5bb9\u5668\u7684\u65f6\u5019\u4f7f\u7528<code>docker rm -v</code>\u8fd9\u4e2a\u547d\u4ee4\u3002 \u65e0\u4e3b\u7684\u6570\u636e\u5377\u53ef\u80fd\u4f1a\u5360\u636e\u5f88\u591a\u7a7a\u95f4\uff0c\u8981\u6e05\u7406\u8bf7\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ docker volume prune\n</code></pre>"},{"location":"docker/basic/#_13","title":"\u6302\u8f7d\u4e3b\u673a\u76ee\u5f55","text":"<p>Docker \u540c\u6837\u652f\u6301\u628a\u5bbf\u4e3b\u673a\u4e0a\u7684\u76ee\u5f55\u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\uff0c\u540c\u6837\u53ef\u4ee5\u4f7f\u7528 <code>-v</code> \u6216\u8005 <code>--mount</code> \u53c2\u6570\u6765\u8fdb\u884c\u6302\u8f7d\uff0c\u5982\u4e0b\u6240\u793a\uff0c\u628a\u5bbf\u4e3b\u673a\u7684 <code>/tmp</code> \u76ee\u5f55\u6302\u8f7d\u5230\u4e00\u4e2a\u5bb9\u5668\u4e2d\uff1a</p> <pre><code>$ ls /tmp/\nnginx.tar.gz  yum_save_tx.2019-11-23-ux9w_yumtx\n$ ls /tmp/nginx.tar.gz\n/tmp/nginx.tar.gz\n$ docker run -it -v /tmp:/usr/tmp busybox /bin/sh\n/ # ls /usr/tmp/\nnginx.tar.gz                               yum_save_tx.2019-11-23-ux9w_yumtx\n</code></pre> <p>\u901a\u8fc7<code>-v</code>\u53c2\u6570\uff0c\u5192\u53f7\u524d\u4e3a<code>\u5bbf\u4e3b\u673a</code>\u76ee\u5f55\uff0c\u5fc5\u987b\u4e3a<code>\u7edd\u5bf9\u8def\u5f84</code>\uff0c\u5192\u53f7\u540e\u4e3a\u5bb9\u5668\u5185\u6302\u8f7d\u7684\u8def\u5f84\u3002\u8fd9\u6837\u5bb9\u5668\u5185\u5c31\u53ef\u4ee5\u5171\u4eab\u5bbf\u4e3b\u673a\u91cc\u7684\u6587\u4ef6\u4e86\u3002</p> <p>\u6302\u8f7d\u6743\u9650</p> <p>\u9ed8\u8ba4\u6302\u8f7d\u7684\u8def\u5f84\u6743\u9650\u4e3a\u8bfb\u5199\u3002\u5982\u679c\u6307\u5b9a\u4e3a\u53ea\u8bfb\u53ef\u4ee5\u7528\uff1a<code>ro</code>\uff0c\u5982\uff1a<code>-v /tmp:/usr/tmp:ro</code>\u3002</p> <p>\u2013 \u5bb9\u5668\u76ee\u5f55\u4e0d\u53ef\u4ee5\u4e3a\u76f8\u5bf9\u8def\u5f84</p> <p>\u2013 \u5bbf\u4e3b\u673a\u76ee\u5f55\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u4f1a\u81ea\u52a8\u751f\u6210</p> <p>\u2013 \u6302\u8f7d\u5bbf\u4e3b\u673a\u5df2\u5b58\u5728\u76ee\u5f55\u540e\uff0c\u5728\u5bb9\u5668\u5185\u5bf9\u5176\u8fdb\u884c\u64cd\u4f5c\uff0c\u62a5Permission denied\u3002\u53ef\u901a\u8fc7\u4e24\u79cd\u65b9\u5f0f\u89e3\u51b3\uff1a</p> <pre><code>* 1&gt; \u5173\u95edselinux\u3002\n\n    \u4e34\u65f6\u5173\u95ed\uff1a`# setenforce 0`\n    \u6c38\u4e45\u5173\u95ed\uff1a\u4fee\u6539`/etc/sysconfig/selinux`\u6587\u4ef6\uff0c\u5c06 SELINUX \u7684\u503c\u8bbe\u7f6e\u4e3adisabled\u3002\n\n* 2&gt; \u4ee5\u7279\u6743\u65b9\u5f0f\u542f\u52a8\u5bb9\u5668\n\n    \u6307\u5b9a`--privileged`\u53c2\u6570\uff0c\u5982\uff1a\n    `# docker run -it --privileged=true -v /test:/soft centos /bin/bash`\n</code></pre> <p><code>bind mount</code> \u548c volume \u5176\u5b9e\u90fd\u662f\u5229\u7528\u5bbf\u4e3b\u673a\u7684\u6587\u4ef6\u7cfb\u7edf\uff0c\u4e0d\u540c\u4e4b\u5904\u5728\u4e8e volume \u662f docker \u81ea\u8eab\u7ba1\u7406\u7684\u76ee\u5f55\u4e2d\u7684\u5b50\u76ee\u5f55\uff0c\u6240\u4ee5\u4e0d\u5b58\u5728\u6743\u9650\u5f15\u53d1\u7684\u6302\u8f7d\u7684\u95ee\u9898\uff0c\u5e76\u4e14\u76ee\u5f55\u8def\u5f84\u662f docker \u81ea\u8eab\u7ba1\u7406\u7684\uff0c\u6240\u4ee5\u4e5f\u4e0d\u9700\u8981\u5728\u4e0d\u540c\u7684\u670d\u52a1\u5668\u4e0a\u6307\u5b9a\u4e0d\u540c\u7684\u8def\u5f84\uff0c\u4f60\u4e0d\u9700\u8981\u5173\u5fc3\u8def\u5f84\u3002\u5b83\u4eec\u4e4b\u95f4\u7684\u4e3b\u8981\u533a\u522b\u6709\u5982\u4e0b\u51e0\u70b9\uff1a</p> <ul> <li>volume \u4f1a\u5f15\u8d77 docker \u76ee\u5f55\u81a8\u80c0\uff0c\u56e0\u4e3a\u65e2\u8981\u5b58\u955c\u50cf\uff0c\u53c8\u8981\u5b58 volume\uff0c\u6700\u597d\u4e0d\u8981\u653e\u5728\u7cfb\u7edf\u76d8\uff0c\u5c06 docker \u7684\u5b89\u88c5\u76ee\u5f55\u914d\u7f6e\u5230\u5176\u4ed6\u66f4\u5927\u7684\u6302\u8f7d\u76d8</li> <li>\u4e24\u8005\u6709\u4e00\u4e2a\u4e0d\u540c\u7684\u884c\u4e3a\uff1a\u5f53\u5bb9\u5668\u5916\u7684\u5bf9\u5e94\u76ee\u5f55\u662f\u7a7a\u7684\uff0cvolume \u4f1a\u5148\u5c06\u5bb9\u5668\u5185\u7684\u5185\u5bb9\u62f7\u8d1d\u5230\u5bb9\u5668\u5916\u76ee\u5f55\uff0c\u800c mount \u4f1a\u5c06\u5916\u90e8\u7684\u76ee\u5f55\u8986\u76d6\u5bb9\u5668\u5185\u90e8\u76ee\u5f55</li> <li>volume \u8fd8\u6709\u4e00\u4e2a\u4e0d\u5982 <code>bind mount</code> \u7684\u5730\u65b9\uff0c\u4e0d\u80fd\u76f4\u63a5\u6302\u8f7d\u6587\u4ef6\uff0c\u4f8b\u5982\u6302\u8f7d nginx \u5bb9\u5668\u7684\u914d\u7f6e\u6587\u4ef6\uff1anginx.conf</li> </ul>"},{"location":"docker/dockerfile_practice/","title":"Dockerfile\u5b9e\u8df5","text":""},{"location":"docker/dockerfile_practice/#dockerfile","title":"Dockerfile \u5b9e\u8df5","text":"<p>\u4f7f\u7528 Dockerfile \u7684\u4e00\u4e9b\u6700\u4f73\u5b9e\u8df5</p> <p>\u5728\u524d\u6587\u4e2d\u6211\u4eec\u4e86\u89e3\u5230\u4e86\u7528\u4e8e\u6784\u5efa Dockerfile \u7684\u57fa\u672c\u65b9\u6cd5\uff0c\u4f46\u662f\u7531\u4e8e\u5728\u7f16\u5199 Dockerfile \u7684\u65f6\u5019\u5e76\u6ca1\u6709\u4e00\u4e9b\u5f3a\u5236\u8981\u6c42\uff0c\u5bfc\u81f4\u5f88\u591a\u6784\u5efa\u7684\u955c\u50cf\u4e0d\u7b26\u5408\u4e00\u4e9b\u6700\u4f73\u5b9e\u8df5\uff0c\u5178\u578b\u7684\u5c31\u662f\u955c\u50cf\u6784\u5efa\u7684\u5c42\u6570\u975e\u5e38\u591a\uff0c\u5bf9\u4e00\u4e9b\u57fa\u672c\u6307\u4ee4\u7684\u533a\u522b\u4e0d\u662f\u5f88\u6e05\u695a\u3002\u672c\u8282\u4e3b\u8981\u4ecb\u7ecd Dockerfile \u5728\u5b9e\u9645\u4f7f\u7528\u4e2d\u7684\u4e00\u4e9b\u6700\u4f73\u7684\u5b9e\u8df5\u65b9\u5f0f\u3002</p> <p>\u7b2c\u4e00\u4e2a\u662f\u524d\u9762\u91cd\u70b9\u63d0\u5230\u7684\u6784\u5efa\u4e0a\u4e0b\u6587\uff0c\u8fd9\u4e2a\u4e00\u5b9a\u9700\u8981\u7406\u89e3\uff0c\u7136\u540e\u662f\u5bf9\u4e8e\u4e00\u4e9b\u4e0d\u9700\u8981\u63d0\u4ea4\u6784\u5efa\u7684\u6587\u4ef6\u7528<code>.dockerignore</code>\u6765\u8fdb\u884c\u5ffd\u7565\u3002</p>"},{"location":"docker/dockerfile_practice/#_1","title":"\u6784\u5efa\u7f13\u5b58","text":"<p>\u5728\u955c\u50cf\u7684\u6784\u5efa\u8fc7\u7a0b\u4e2d\uff0cDocker \u6839\u636e Dockerfile \u6307\u5b9a\u7684\u987a\u5e8f\u6267\u884c\u6bcf\u4e2a\u6307\u4ee4\u3002\u5728\u6267\u884c\u6bcf\u6761\u6307\u4ee4\u4e4b\u524d\uff0cDocker \u90fd\u4f1a\u5728\u7f13\u5b58\u4e2d\u67e5\u627e\u662f\u5426\u5df2\u7ecf\u5b58\u5728\u53ef\u91cd\u7528\u7684\u955c\u50cf\uff0c\u5982\u679c\u6709\u5c31\u4f7f\u7528\u73b0\u5b58\u7684\u955c\u50cf\uff0c\u4e0d\u518d\u91cd\u590d\u521b\u5efa\u3002\u5f53\u7136\u5982\u679c\u4f60\u4e0d\u60f3\u5728\u6784\u5efa\u8fc7\u7a0b\u4e2d\u4f7f\u7528\u7f13\u5b58\uff0c\u4f60\u53ef\u4ee5\u5728 <code>docker build</code> \u547d\u4ee4\u4e2d\u4f7f\u7528 <code>--no-cache=true</code> \u9009\u9879\u3002Docker \u4e2d\u6784\u5efa\u7f13\u5b58\u9075\u5faa\u7684\u57fa\u672c\u89c4\u5219\u5982\u4e0b\uff1a</p> <ul> <li>\u4ece\u4e00\u4e2a\u57fa\u7840\u955c\u50cf\u5f00\u59cb\uff08FROM \u6307\u4ee4\u6307\u5b9a\uff09\uff0c\u4e0b\u4e00\u6761\u6307\u4ee4\u5c06\u548c\u8be5\u57fa\u7840\u955c\u50cf\u7684\u6240\u6709\u5b50\u955c\u50cf\u8fdb\u884c\u5339\u914d\uff0c\u68c0\u67e5\u8fd9\u4e9b\u5b50\u955c\u50cf\u88ab\u521b\u5efa\u65f6\u4f7f\u7528\u7684\u6307\u4ee4\u662f\u5426\u548c\u88ab\u68c0\u67e5\u7684\u6307\u4ee4\u5b8c\u5168\u4e00\u6837\u3002\u5982\u679c\u4e0d\u662f\uff0c\u5219\u7f13\u5b58\u5931\u6548\u3002</li> <li>\u5bf9\u4e8e ADD \u548c COPY \u6307\u4ee4\uff0c\u955c\u50cf\u4e2d\u5bf9\u5e94\u6587\u4ef6\u7684\u5185\u5bb9\u4e5f\u4f1a\u88ab\u68c0\u67e5\uff0c\u6bcf\u4e2a\u6587\u4ef6\u90fd\u4f1a\u8ba1\u7b97\u51fa\u4e00\u4e2a\u6821\u9a8c\u503c\u3002\u5728\u7f13\u5b58\u7684\u67e5\u627e\u8fc7\u7a0b\u4e2d\uff0c\u4f1a\u5c06\u8fd9\u4e9b\u6821\u9a8c\u548c\u5df2\u5b58\u5728\u955c\u50cf\u4e2d\u7684\u6587\u4ef6\u6821\u9a8c\u503c\u8fdb\u884c\u5bf9\u6bd4\u3002\u5982\u679c\u6587\u4ef6\u6709\u4efb\u4f55\u6539\u53d8\uff0c\u5219\u7f13\u5b58\u5931\u6548\u3002</li> <li> <p>\u9664\u4e86 ADD \u548c COPY \u6307\u4ee4\uff0c\u7f13\u5b58\u5339\u914d\u8fc7\u7a0b\u4e0d\u4f1a\u67e5\u770b\u4e34\u65f6\u5bb9\u5668\u4e2d\u7684\u6587\u4ef6\u6765\u51b3\u5b9a\u7f13\u5b58\u662f\u5426\u5339\u914d\u3002\u4f8b\u5982\uff0c\u5f53\u6267\u884c\u5b8c </p> <pre><code>RUN apt-get -y update\n</code></pre> <p>\u6307\u4ee4\u540e\uff0c\u5bb9\u5668\u4e2d\u4e00\u4e9b\u6587\u4ef6\u88ab\u66f4\u65b0\uff0c\u4f46 Docker \u4e0d\u4f1a\u68c0\u67e5\u8fd9\u4e9b\u6587\u4ef6\u3002\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u53ea\u6709<code>\u6307\u4ee4\u5b57\u7b26\u4e32\u672c\u8eab</code>\u88ab\u7528\u6765\u5339\u914d\u7f13\u5b58\u3002 *   \u4e00\u65e6\u7f13\u5b58\u5931\u6548\uff0c\u6240\u6709\u540e\u7eed\u7684 Dockerfile \u6307\u4ee4\u90fd\u5c06\u4ea7\u751f\u65b0\u7684\u955c\u50cf\uff0c\u7f13\u5b58\u4e0d\u4f1a\u88ab\u4f7f\u7528\u3002</p> </li> </ul>"},{"location":"docker/dockerfile_practice/#_2","title":"\u4f7f\u7528\u591a\u9636\u6bb5\u6784\u5efa","text":"<p>\u591a\u9636\u6bb5\u6784\u5efa\u53ef\u4ee5\u8ba9\u6211\u4eec\u5927\u5e45\u5ea6\u51cf\u5c0f\u6700\u7ec8\u7684\u955c\u50cf\u5927\u5c0f\uff0c\u800c\u4e0d\u9700\u8981\u53bb\u60f3\u529e\u6cd5\u51cf\u5c11\u4e2d\u95f4\u5c42\u548c\u6587\u4ef6\u7684\u6570\u91cf\u3002\u56e0\u4e3a\u955c\u50cf\u662f\u5728\u751f\u6210\u8fc7\u7a0b\u7684\u6700\u540e\u9636\u6bb5\u751f\u6210\u7684\uff0c\u6240\u4ee5\u53ef\u4ee5\u5229\u7528\u751f\u6210\u7f13\u5b58\u6765\u6700\u5c0f\u5316\u955c\u50cf\u5c42\u3002</p> <p>\u4f8b\u5982\uff0c\u5982\u679c\u4f60\u7684\u6784\u5efa\u5305\u542b\u591a\u4e2a\u5c42\uff0c\u5219\u53ef\u4ee5\u5c06\u5b83\u4eec\u4ece\u53d8\u5316\u9891\u7387\u8f83\u4f4e\uff08\u4ee5\u786e\u4fdd\u751f\u6210\u7f13\u5b58\u53ef\u91cd\u7528\uff09\u5230\u53d8\u5316\u9891\u7387\u8f83\u9ad8\u7684\u987a\u5e8f\u6392\u5e8f\uff1a</p> <ul> <li>\u5b89\u88c5\u6784\u5efa\u5e94\u7528\u7a0b\u5e8f\u6240\u9700\u7684\u4f9d\u8d56\u5de5\u5177</li> <li>\u5b89\u88c5\u6216\u66f4\u65b0\u4f9d\u8d56\u9879</li> <li>\u6784\u5efa\u4f60\u7684\u5e94\u7528</li> </ul> <p>\u6bd4\u5982\u6211\u4eec\u6784\u5efa\u4e00\u4e2a Go \u5e94\u7528\u7a0b\u5e8f\u7684 Dockerfile \u53ef\u80fd\u7c7b\u4f3c\u4e8e\u8fd9\u6837\uff1a</p> <pre><code>FROM golang:11-alpine AS build\n\n# \u5b89\u88c5\u9879\u76ee\u9700\u8981\u7684\u5de5\u5177\n# \u8fd0\u884c `docker build --no-cache .` \u6765\u66f4\u65b0\u4f9d\u8d56\nRUN apk add --no-cache git\nRUN go get github.com/golang/dep/cmd/dep\n\n# \u901a\u8fc7 Gopkg.toml \u548c Gopkg.lock \u83b7\u53d6\u9879\u76ee\u7684\u4f9d\u8d56\n# \u4ec5\u5728\u66f4\u65b0 Gopkg \u6587\u4ef6\u65f6\u624d\u91cd\u65b0\u6784\u5efa\u8fd9\u4e9b\u5c42\nCOPY Gopkg.lock Gopkg.toml /go/src/project/\nWORKDIR /go/src/project/\n# \u5b89\u88c5\u4f9d\u8d56\u5e93\nRUN dep ensure -vendor-only\n\n# \u62f7\u8d1d\u6574\u4e2a\u9879\u76ee\u8fdb\u884c\u6784\u5efa\n# \u5f53\u9879\u76ee\u4e0b\u9762\u6709\u6587\u4ef6\u53d8\u5316\u7684\u65f6\u5019\u8be5\u5c42\u624d\u4f1a\u91cd\u65b0\u6784\u5efa\nCOPY . /go/src/project/\nRUN go build -o /bin/project\n\n# \u5c06\u6253\u5305\u540e\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u62f7\u8d1d\u5230 scratch \u955c\u50cf\u4e0b\u9762\uff0c\u5c06\u955c\u50cf\u5927\u5c0f\u964d\u5230\u6700\u4f4e\nFROM scratch\nCOPY --from=build /bin/project /bin/project\nENTRYPOINT [\"/bin/project\"]\nCMD [\"--help\"]\n</code></pre>"},{"location":"docker/dockerfile_practice/#_3","title":"\u907f\u514d\u5b89\u88c5\u4e0d\u5fc5\u8981\u7684\u5305","text":"<p>\u4e3a\u4e86\u964d\u4f4e\u590d\u6742\u6027\u3001\u51cf\u5c11\u4f9d\u8d56\u3001\u51cf\u5c0f\u6587\u4ef6\u5927\u5c0f\u548c\u6784\u5efa\u65f6\u95f4\uff0c\u5e94\u8be5\u907f\u514d\u5b89\u88c5\u989d\u5916\u7684\u6216\u8005\u4e0d\u5fc5\u8981\u7684\u8f6f\u4ef6\u5305\u3002\u4f8b\u5982\uff0c\u4e0d\u8981\u5728\u6570\u636e\u5e93\u955c\u50cf\u4e2d\u5305\u542b\u4e00\u4e2a\u6587\u672c\u7f16\u8f91\u5668\u3002</p>"},{"location":"docker/dockerfile_practice/#_4","title":"\u5e94\u7528\u89e3\u8026","text":"<p>\u6bcf\u4e2a\u5bb9\u5668\u5e94\u7528\u53ea\u5173\u5fc3\u4e00\u4e2a\u65b9\u9762\u7684\u4e8b\u60c5\u3002\u5c06\u591a\u4e2a\u5e94\u7528\u89e3\u8026\u5230\u4e0d\u540c\u5bb9\u5668\u4e2d\uff0c\u53ef\u4ee5\u66f4\u8f7b\u677e\u5730\u4fdd\u8bc1\u5bb9\u5668\u7684\u6a2a\u5411\u6269\u5c55\u548c\u590d\u7528\u3002\u4f8b\u5982\u4e00\u4e2a web \u5e94\u7528\u7a0b\u5e8f\u53ef\u80fd\u5305\u542b\u4e09\u4e2a\u72ec\u7acb\u7684\u5bb9\u5668\uff1aweb\u5e94\u7528\u3001\u6570\u636e\u5e93\u3001\u7f13\u5b58\uff0c\u6bcf\u4e2a\u5bb9\u5668\u90fd\u662f\u72ec\u7acb\u7684\u955c\u50cf\uff0c\u5206\u5f00\u8fd0\u884c\u3002\u4f46\u8fd9\u5e76\u4e0d\u662f\u8bf4\u4e00\u4e2a\u5bb9\u5668\u5c31\u53ea\u80fd\u8dd1\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u56e0\u4e3a\u6709\u7684\u7a0b\u5e8f\u53ef\u80fd\u4f1a\u81ea\u884c\u4ea7\u751f\u5176\u4ed6\u8fdb\u7a0b\uff0c\u6bd4\u5982 Celery \u5c31\u53ef\u4ee5\u6709\u5f88\u591a\u4e2a\u5de5\u4f5c\u8fdb\u7a0b\u3002\u867d\u7136<code>\u6bcf\u4e2a\u5bb9\u5668\u8dd1\u4e00\u4e2a\u8fdb\u7a0b</code>\u662f\u4e00\u6761\u5f88\u597d\u7684\u6cd5\u5219\uff0c\u4f46\u8fd9\u5e76\u4e0d\u662f\u4e00\u6761\u786c\u6027\u7684\u89c4\u5b9a\u3002\u6211\u4eec\u4e3b\u8981\u662f\u5e0c\u671b\u4e00\u4e2a\u5bb9\u5668\u53ea\u5173\u6ce8\u4e00\u4ef6\u4e8b\u60c5\uff0c\u5c3d\u91cf\u4fdd\u6301\u5e72\u51c0\u548c\u6a21\u5757\u5316\u3002</p> <p>\u5982\u679c\u5bb9\u5668\u4e92\u76f8\u4f9d\u8d56\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 Docker \u5bb9\u5668\u7f51\u7edc \u6765\u628a\u8fd9\u4e9b\u5bb9\u5668\u8fde\u63a5\u8d77\u6765\uff0c\u6211\u4eec\u524d\u9762\u5df2\u7ecf\u8ddf\u5927\u5bb6\u8bb2\u89e3\u8fc7 Docker \u7684\u5bb9\u5668\u7f51\u7edc\u6a21\u5f0f\u3002</p>"},{"location":"docker/dockerfile_practice/#_5","title":"\u6700\u5c0f\u5316\u955c\u50cf\u5c42\u6570","text":"<p>\u5728\u5f88\u65e9\u4e4b\u524d\u7684\u7248\u672c\u4e2d\u5c3d\u91cf\u51cf\u5c11\u955c\u50cf\u5c42\u6570\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u4e0d\u8fc7\u73b0\u5728\u7684\u7248\u672c\u5df2\u7ecf\u6709\u4e86\u4e00\u5b9a\u7684\u6539\u5584\u4e86\uff1a</p> <ul> <li>\u53ea\u6709 RUN\u3001COPY \u548c ADD \u6307\u4ee4\u4f1a\u521b\u5efa\u5c42\uff0c\u5176\u4ed6\u6307\u4ee4\u4f1a\u521b\u5efa\u4e34\u65f6\u7684\u4e2d\u95f4\u955c\u50cf\uff0c\u4f46\u662f\u4e0d\u4f1a\u76f4\u63a5\u589e\u52a0\u6784\u5efa\u7684\u955c\u50cf\u5927\u5c0f\u4e86\u3002</li> <li>\u591a\u9636\u6bb5\u6784\u5efa\u7684\u652f\u6301\uff0c\u5141\u8bb8\u6211\u4eec\u628a\u9700\u8981\u7684\u6570\u636e\u76f4\u63a5\u590d\u5236\u5230\u6700\u7ec8\u7684\u955c\u50cf\u4e2d\uff0c\u8fd9\u5c31\u5141\u8bb8\u6211\u4eec\u5728\u4e2d\u95f4\u9636\u6bb5\u5305\u542b\u4e00\u4e9b\u5de5\u5177\u6216\u8005\u8c03\u8bd5\u4fe1\u606f\u4e86\uff0c\u800c\u4e14\u4e0d\u4f1a\u589e\u52a0\u6700\u7ec8\u7684\u955c\u50cf\u5927\u5c0f\u3002</li> </ul>"},{"location":"docker/dockerfile_practice/#_6","title":"\u5bf9\u591a\u884c\u53c2\u6570\u6392\u5e8f","text":"<p>\u53ea\u8981\u6709\u53ef\u80fd\uff0c\u5c31\u5c06\u591a\u884c\u53c2\u6570\u6309\u5b57\u6bcd\u987a\u5e8f\u6392\u5e8f\u3002\u8fd9\u53ef\u4ee5\u5e2e\u52a9\u4f60\u907f\u514d\u91cd\u590d\u5305\u542b\u540c\u4e00\u4e2a\u5305\uff0c\u66f4\u65b0\u5305\u5217\u8868\u65f6\u4e5f\u66f4\u5bb9\u6613\uff0c\u4e5f\u66f4\u5bb9\u6613\u9605\u8bfb\u548c\u5ba1\u67e5\u3002\u5efa\u8bae\u5728\u53cd\u659c\u6760\u7b26\u53f7 <code>\\</code> \u4e4b\u524d\u6dfb\u52a0\u4e00\u4e2a\u7a7a\u683c\uff0c\u53ef\u4ee5\u589e\u52a0\u53ef\u8bfb\u6027\u3002\u6bd4\u5982\u4e0b\u9762\u7684\u4f8b\u5b50\uff1a</p> <pre><code>RUN apt-get update &amp;&amp; apt-get install -y \\\\\n  bzr \\\\\n  cvs \\\\\n  git \\\\\n  mercurial \\\\\n  subversion\n</code></pre>"},{"location":"docker/dockerfile_practice/#dockerfile_1","title":"Dockerfile \u6307\u4ee4","text":"<p>\u5173\u4e8e\u8fd9\u4e9b\u6307\u4ee4\u7684\u4f7f\u7528\u5efa\u8bae\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u521b\u5efa\u9ad8\u6548\u4e14\u53ef\u7ef4\u62a4\u7684 Dockerfile\u3002</p>"},{"location":"docker/dockerfile_practice/#from","title":"FROM \u6307\u4ee4","text":"<p>\u524d\u9762\u5df2\u7ecf\u4ecb\u7ecd\u8fc7\uff0c\u5c3d\u53ef\u80fd\u4f7f\u7528\u5f53\u524d\u7684\u5b98\u65b9\u955c\u50cf\u4f5c\u4e3a\u57fa\u7840\u955c\u50cf\u3002\u6211\u4eec\u5efa\u8bae\u4f7f\u7528<code>Alpine</code>\u6620\u50cf\uff0c\u56e0\u4e3a\u5b83\u53d7\u5230\u4e25\u683c\u63a7\u5236\u4e14\u8f83\u5c0f\uff08\u5f53\u524d\u5c0f\u4e8e5 MB\uff09\uff0c\u540c\u65f6\u4ecd\u662f\u5b8c\u6574\u7684 Linux \u53d1\u884c\u7248\u3002</p>"},{"location":"docker/dockerfile_practice/#label","title":"LABEL \u6807\u7b7e","text":"<p>\u4f60\u53ef\u4ee5\u7ed9\u955c\u50cf\u6dfb\u52a0\u6807\u7b7e\u6765\u5e2e\u52a9\u7ec4\u7ec7\u955c\u50cf\u3001\u8bb0\u5f55\u8bb8\u53ef\u4fe1\u606f\u3001\u8f85\u52a9\u81ea\u52a8\u5316\u6784\u5efa\u7b49\u3002\u6bcf\u4e2a\u6807\u7b7e\u4e00\u884c\uff0c\u7531 LABEL \u5f00\u5934\u52a0\u4e0a\u4e00\u4e2a\u6216\u591a\u4e2a\u6807\u7b7e\u5bf9\u3002</p> <p>\u4e0b\u9762\u7684\u793a\u4f8b\u5c55\u793a\u4e86\u5404\u79cd\u4e0d\u540c\u7684\u53ef\u80fd\u683c\u5f0f\u3002<code>#</code>\u5f00\u5934\u7684\u884c\u662f\u6ce8\u91ca\u5185\u5bb9\u3002</p> <p>\u6ce8\u610f</p> <p>\u5982\u679c\u4f60\u7684\u5b57\u7b26\u4e32\u5305\u542b\u7a7a\u683c\uff0c\u90a3\u4e48\u5b83\u5fc5\u987b\u88ab\u5f15\u7528\u6216\u8005\u7a7a\u683c\u5fc5\u987b\u88ab\u8f6c\u4e49\u3002\u5982\u679c\u60a8\u7684\u5b57\u7b26\u4e32\u5305\u542b\u5185\u90e8\u5f15\u53f7\u5b57\u7b26\uff08\"\uff09\uff0c\u5219\u4e5f\u53ef\u4ee5\u5c06\u5176\u8f6c\u4e49\u3002</p> <pre><code># Set one or more individual labels\nLABEL com.example.version=\"1-beta\"\nLABEL vendor=\"ACME Incorporated\"\nLABEL com.example.release-date=\"2015-02-12\"\nLABEL com.example.version.is-production=\"\"\n</code></pre> <p>\u4e00\u4e2a\u955c\u50cf\u53ef\u4ee5\u5305\u542b\u591a\u4e2a\u6807\u7b7e\uff0c\u5f53\u7136\u4ee5\u4e0a\u5185\u5bb9\u4e5f\u53ef\u4ee5\u5199\u6210\u4e0b\u9762\u8fd9\u6837\uff0c\u4f46\u662f\u4e0d\u662f\u5fc5\u987b\u7684\uff1a</p> <pre><code># Set multiple labels at once, using line-continuation characters to break long lines\nLABEL vendor=ACME\\\\ Incorporated \\\\\n      com.example.is-production=\"\" \\\\\n      com.example.version=\"1-beta\" \\\\\n      com.example.release-date=\"2015-02-12\"\n</code></pre>"},{"location":"docker/dockerfile_practice/#run","title":"RUN \u6307\u4ee4","text":"<p>\u4e3a\u4e86\u4fdd\u6301 Dockerfile \u6587\u4ef6\u7684\u53ef\u8bfb\u6027\uff0c\u4ee5\u53ca\u53ef\u7ef4\u62a4\u6027\uff0c\u5efa\u8bae\u5c06\u957f\u7684\u6216\u590d\u6742\u7684 RUN \u6307\u4ee4\u7528\u53cd\u659c\u6760<code>\\</code>\u5206\u5272\u6210\u591a\u884c\u3002</p> <p>RUN \u6307\u4ee4\u6700\u5e38\u89c1\u7684\u7528\u6cd5\u662f\u5b89\u88c5\u5305\u7528\u7684 apt-get\u3002\u56e0\u4e3a<code>RUN apt-get</code>\u6307\u4ee4\u4f1a\u5b89\u88c5\u5305\uff0c\u6240\u4ee5\u6709\u51e0\u4e2a\u95ee\u9898\u9700\u8981\u6ce8\u610f\u3002</p> <ul> <li>\u4e0d\u8981\u4f7f\u7528 RUN apt-get upgrade \u6216 dist-upgrade\uff0c\u5982\u679c\u57fa\u7840\u955c\u50cf\u4e2d\u7684\u67d0\u4e2a\u5305\u8fc7\u65f6\u4e86\uff0c\u4f60\u5e94\u8be5\u8054\u7cfb\u5b83\u7684\u7ef4\u62a4\u8005\u3002\u5982\u679c\u4f60\u786e\u5b9a\u67d0\u4e2a\u7279\u5b9a\u7684\u5305\uff0c\u6bd4\u5982 foo\uff0c\u9700\u8981\u5347\u7ea7\uff0c\u4f7f\u7528 apt-get install -y foo \u5c31\u884c\uff0c\u8be5\u6307\u4ee4\u4f1a\u81ea\u52a8\u5347\u7ea7 foo \u5305\u3002</li> <li> <p>\u6c38\u8fdc\u5c06 RUN apt-get update \u548c apt-get install \u7ec4\u5408\u6210\u4e00\u6761 RUN \u58f0\u660e\uff0c\u4f8b\u5982\uff1a</p> <pre><code>RUN apt-get update &amp;&amp; apt-get install -y \\\\\n      package-bar \\\\\n      package-baz \\\\\n      package-foo\n</code></pre> </li> </ul> <p>\u5c06 apt-get update \u653e\u5728\u4e00\u6761\u5355\u72ec\u7684 RUN \u58f0\u660e\u4e2d\u4f1a\u5bfc\u81f4\u7f13\u5b58\u95ee\u9898\u4ee5\u53ca\u540e\u7eed\u7684 apt-get install \u5931\u8d25\u3002\u6bd4\u5982\uff0c\u5047\u8bbe\u4f60\u6709\u4e00\u4e2a Dockerfile \u6587\u4ef6\uff1a</p> <pre><code>FROM ubuntu:04\nRUN apt-get update\nRUN apt-get install -y curl\n</code></pre> <p>\u6784\u5efa\u955c\u50cf\u540e\uff0c\u6240\u6709\u7684\u5c42\u90fd\u5728 Docker \u7684\u7f13\u5b58\u4e2d\u3002\u5047\u8bbe\u4f60\u540e\u6765\u53c8\u4fee\u6539\u4e86\u5176\u4e2d\u7684 apt-get install \u6dfb\u52a0\u4e86\u4e00\u4e2a\u5305\uff1a</p> <pre><code>FROM ubuntu:04\nRUN apt-get update\nRUN apt-get install -y curl nginx\n</code></pre> <p>Docker \u53d1\u73b0\u4fee\u6539\u540e\u7684 RUN apt-get update \u6307\u4ee4\u548c\u4e4b\u524d\u7684\u5b8c\u5168\u4e00\u6837\u3002\u6240\u4ee5\uff0capt-get update \u4e0d\u4f1a\u6267\u884c\uff0c\u800c\u662f\u4f7f\u7528\u4e4b\u524d\u7684\u7f13\u5b58\u955c\u50cf\u3002\u56e0\u4e3a apt-get update \u6ca1\u6709\u8fd0\u884c\uff0c\u540e\u9762\u7684 apt-get install \u53ef\u80fd\u5b89\u88c5\u7684\u662f\u8fc7\u65f6\u7684 curl \u548c nginx \u7248\u672c\u3002</p> <p>\u4f7f\u7528</p> <pre><code>RUN apt-get update &amp;&amp; apt-get install -y\n</code></pre> <p>\u53ef\u4ee5\u786e\u4fdd\u4f60\u7684 Dockerfiles \u6bcf\u6b21\u5b89\u88c5\u7684\u90fd\u662f\u5305\u7684\u6700\u65b0\u7684\u7248\u672c\uff0c\u800c\u4e14\u8fd9\u4e2a\u8fc7\u7a0b\u4e0d\u9700\u8981\u8fdb\u4e00\u6b65\u7684\u7f16\u7801\u6216\u989d\u5916\u5e72\u9884\u3002\u8fd9\u9879\u6280\u672f\u53eb\u4f5c<code>cache busting(\u7f13\u5b58\u7834\u574f)</code>\u3002</p> <p>\u4e0b\u9762\u662f\u4e00\u4e2a RUN \u6307\u4ee4\u7684\u793a\u4f8b\u6a21\u677f\uff0c\u5c55\u793a\u4e86\u6240\u6709\u5173\u4e8e apt-get \u7684\u5efa\u8bae\uff1a</p> <pre><code>RUN apt-get update &amp;&amp; apt-get install -y \\\\\n    aufs-tools \\\\\n    automake \\\\\n    build-essential \\\\\n    curl \\\\\n    dpkg-sig \\\\\n    libcap-dev \\\\\n    libsqlite3-dev \\\\\n    mercurial \\\\\n    reprepro \\\\\n    ruby1 \\\\\n    ruby1-dev \\\\\n    s3cmd=* \\\\\n # \u5176\u4ed6\u64cd\u4f5c\n &amp;&amp; rm -rf /var/lib/apt/lists/*\n</code></pre> <p>\u5176\u4e2d s3cmd \u6307\u4ee4\u6307\u5b9a\u4e86\u4e00\u4e2a\u7248\u672c\u53f7 1.1.*\u3002\u5982\u679c\u4e4b\u524d\u7684\u955c\u50cf\u4f7f\u7528\u7684\u662f\u66f4\u65e7\u7684\u7248\u672c\uff0c\u6307\u5b9a\u65b0\u7684\u7248\u672c\u4f1a\u5bfc\u81f4 apt-get udpate \u7f13\u5b58\u5931\u6548\u5e76\u786e\u4fdd\u5b89\u88c5\u7684\u662f\u65b0\u7248\u672c\u3002 \u53e6\u5916\uff0c\u6e05\u7406\u6389 apt \u7f13\u5b58 var/lib/apt/lists \u53ef\u4ee5\u51cf\u5c0f\u955c\u50cf\u5927\u5c0f\u3002\u56e0\u4e3a RUN \u6307\u4ee4\u7684\u5f00\u5934\u4e3a apt-get udpate\uff0c\u5305\u7f13\u5b58\u603b\u662f\u4f1a\u5728 apt-get install \u4e4b\u524d\u5237\u65b0\u3002</p>"},{"location":"docker/dockerfile_practice/#expose","title":"EXPOSE \u6307\u4ee4","text":"<p><code>EXPOSE</code> \u6307\u4ee4\u7528\u4e8e\u6307\u5b9a\u5bb9\u5668\u5c06\u8981\u76d1\u542c\u7684\u7aef\u53e3\u3002\u56e0\u6b64\uff0c\u4f60\u5e94\u8be5\u4e3a\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u4f7f\u7528\u5e38\u89c1\u7684\u7aef\u53e3\u3002</p> <p>\u4f8b\u5982\uff0c\u63d0\u4f9b Apache web \u670d\u52a1\u7684\u955c\u50cf\u5e94\u8be5\u4f7f\u7528 EXPOSE 80\uff0c\u800c\u63d0\u4f9b MongoDB \u670d\u52a1\u7684\u955c\u50cf\u4f7f\u7528 EXPOSE 27017\u3002</p> <p>\u5bf9\u4e8e\u5916\u90e8\u8bbf\u95ee\uff0c\u7528\u6237\u53ef\u4ee5\u5728\u6267\u884c docker run \u65f6\u4f7f\u7528\u4e00\u4e2a <code>-p</code> \u53c2\u6570\u6765\u6307\u793a\u5982\u4f55\u5c06\u6307\u5b9a\u7684\u7aef\u53e3\u6620\u5c04\u5230\u6240\u9009\u62e9\u7684\u7aef\u53e3\u3002</p>"},{"location":"docker/dockerfile_practice/#env","title":"ENV \u6307\u4ee4","text":"<p>\u4e3a\u4e86\u65b9\u4fbf\u65b0\u7a0b\u5e8f\u8fd0\u884c\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 <code>ENV</code> \u6307\u4ee4\u6765\u4e3a\u5bb9\u5668\u4e2d\u5b89\u88c5\u7684\u7a0b\u5e8f\u66f4\u65b0 PATH \u73af\u5883\u53d8\u91cf\u3002\u4f8b\u5982\u4f7f\u7528</p> <pre><code>ENV PATH /usr/local/nginx/bin:$PATH\n</code></pre> <p>\u6765\u786e\u4fdd<code>CMD [\"nginx\"]</code>\u80fd\u6b63\u786e\u8fd0\u884c\u3002</p> <p>ENV \u6307\u4ee4\u4e5f\u53ef\u7528\u4e8e\u4e3a\u4f60\u60f3\u8981\u5bb9\u5668\u5316\u7684\u670d\u52a1\u63d0\u4f9b\u5fc5\u8981\u7684\u73af\u5883\u53d8\u91cf\uff0c\u6bd4\u5982 Postgres \u9700\u8981\u7684 PGDATA\u3002 \u6700\u540e\uff0cENV \u4e5f\u80fd\u7528\u4e8e\u8bbe\u7f6e\u5e38\u89c1\u7684\u7248\u672c\u53f7\uff0c\u6bd4\u5982\u4e0b\u9762\u7684\u793a\u4f8b\uff1a</p> <pre><code>ENV PG_MAJOR 3\nENV PG_VERSION 4\nRUN curl -SL http://example.com/postgres-$PG_VERSION.tar.xz | tar -xJC /usr/src/postgress &amp;&amp; \u2026\nENV PATH /usr/local/postgres-$PG_MAJOR/bin:$PATH\n</code></pre> <p>\u7c7b\u4f3c\u4e8e\u7a0b\u5e8f\u4e2d\u7684\u5e38\u91cf\uff0c\u8fd9\u79cd\u65b9\u6cd5\u53ef\u4ee5\u8ba9\u4f60\u53ea\u9700\u6539\u53d8 ENV \u6307\u4ee4\u6765\u81ea\u52a8\u7684\u6539\u53d8\u5bb9\u5668\u4e2d\u7684\u8f6f\u4ef6\u7248\u672c\u3002</p>"},{"location":"docker/dockerfile_practice/#volume","title":"VOLUME \u6307\u4ee4","text":"<p><code>VOLUME</code> \u6307\u4ee4\u7528\u4e8e\u66b4\u9732\u4efb\u4f55\u6570\u636e\u5e93\u5b58\u50a8\u6587\u4ef6\uff0c\u914d\u7f6e\u6587\u4ef6\uff0c\u6216\u5bb9\u5668\u521b\u5efa\u7684\u6587\u4ef6\u548c\u76ee\u5f55\u3002\u5f3a\u70c8\u5efa\u8bae\u4f7f\u7528 <code>VOLUME</code> \u6765\u7ba1\u7406\u955c\u50cf\u4e2d\u7684\u53ef\u53d8\u90e8\u5206\u548c\u7528\u6237\u53ef\u4ee5\u6539\u53d8\u7684\u90e8\u5206\u3002</p>"},{"location":"docker/dockerfile_practice/#user","title":"USER \u6307\u4ee4","text":"<p>\u5982\u679c\u67d0\u4e2a\u670d\u52a1\u4e0d\u9700\u8981\u7279\u6743\u6267\u884c\uff0c\u5efa\u8bae\u4f7f\u7528 USER \u6307\u4ee4\u5207\u6362\u5230\u975e root \u7528\u6237\u3002\u5148\u5728 Dockerfile \u4e2d\u4f7f\u7528\u7c7b\u4f3c </p> <pre><code>RUN groupadd -r postgres &amp;&amp; useradd -r -g postgres postgres\n</code></pre> <p>\u7684\u6307\u4ee4\u521b\u5efa\u7528\u6237\u548c\u7528\u6237\u7ec4\u3002</p> <p>\u6ce8\u610f</p> <p>\u5728\u955c\u50cf\u4e2d\uff0c\u7528\u6237\u548c\u7528\u6237\u7ec4\u6bcf\u6b21\u88ab\u5206\u914d\u7684 UID/GID \u90fd\u662f\u4e0d\u786e\u5b9a\u7684\uff0c\u4e0b\u6b21\u91cd\u65b0\u6784\u5efa\u955c\u50cf\u65f6\u88ab\u5206\u914d\u5230\u7684 UID/GID \u53ef\u80fd\u4f1a\u4e0d\u4e00\u6837\u3002\u5982\u679c\u8981\u4f9d\u8d56\u786e\u5b9a\u7684 UID/GID\uff0c\u4f60\u5e94\u8be5\u663e\u793a\u7684\u6307\u5b9a\u4e00\u4e2a UID/GID\u3002</p> <p>\u4f60\u5e94\u8be5\u907f\u514d\u4f7f\u7528 sudo\uff0c\u56e0\u4e3a\u5b83\u4e0d\u53ef\u9884\u671f\u7684 TTY \u548c\u4fe1\u53f7\u8f6c\u53d1\u884c\u4e3a\u53ef\u80fd\u9020\u6210\u7684\u95ee\u9898\u6bd4\u5b83\u80fd\u89e3\u51b3\u7684\u95ee\u9898\u8fd8\u591a\u3002\u5982\u679c\u4f60\u771f\u7684\u9700\u8981\u548c sudo \u7c7b\u4f3c\u7684\u529f\u80fd\uff08\u4f8b\u5982\uff0c\u4ee5 root \u6743\u9650\u521d\u59cb\u5316\u67d0\u4e2a\u5b88\u62a4\u8fdb\u7a0b\uff0c\u4ee5\u975e root \u6743\u9650\u6267\u884c\u5b83\uff09\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 <code>gosu</code>\u3002\u6211\u4eec\u53ef\u4ee5\u53bb\u67e5\u770b\u5b98\u65b9\u7684\u4e00\u4e9b\u955c\u50cf\uff0c\u5f88\u591a\u90fd\u662f\u4f7f\u7528\u7684 <code>gosu</code>\u3002</p> <p>\u4e3a\u4e86\u51cf\u5c11\u5c42\u6570\u548c\u590d\u6742\u5ea6\uff0c\u907f\u514d\u9891\u7e41\u5730\u4f7f\u7528 USER \u6765\u56de\u5207\u6362\u7528\u6237\u3002</p>"},{"location":"docker/dockerfile_practice/#workdir","title":"WORKDIR \u6307\u4ee4","text":"<p>\u4e3a\u4e86\u6e05\u6670\u6027\u548c\u53ef\u9760\u6027\uff0c\u4f60\u5e94\u8be5\u603b\u662f\u5728 <code>WORKDIR</code> \u4e2d\u4f7f\u7528\u7edd\u5bf9\u8def\u5f84\u3002\u53e6\u5916\uff0c\u4f60\u5e94\u8be5\u4f7f\u7528 WORKDIR \u6765\u66ff\u4ee3\u7c7b\u4f3c\u4e8e </p> <pre><code>RUN cd ... &amp;&amp; do-something\n</code></pre> <p>\u7684\u6307\u4ee4\uff0c\u540e\u8005\u96be\u4ee5\u9605\u8bfb\u3001\u6392\u9519\u548c\u7ef4\u62a4\u3002</p>"},{"location":"docker/dockerfile_practice/#copy_add","title":"COPY \u548c ADD \u6307\u4ee4","text":"<p>\u867d\u7136 <code>ADD</code> \u548c <code>COPY</code> \u529f\u80fd\u7c7b\u4f3c\uff0c\u4f46\u4e00\u822c\u4f18\u5148\u4f7f\u7528 <code>COPY</code>\u3002\u56e0\u4e3a\u5b83\u6bd4 <code>ADD</code> \u66f4\u900f\u660e\u3002COPY \u53ea\u652f\u6301\u7b80\u5355\u5c06\u672c\u5730\u6587\u4ef6\u62f7\u8d1d\u5230\u5bb9\u5668\u4e2d\uff0c\u800c ADD \u6709\u4e00\u4e9b\u5e76\u4e0d\u660e\u663e\u7684\u529f\u80fd\uff08\u6bd4\u5982\u672c\u5730 tar \u63d0\u53d6\u548c\u8fdc\u7a0b URL \u652f\u6301\uff09\u3002\u56e0\u6b64\uff0cADD \u7684\u6700\u4f73\u7528\u4f8b\u662f\u5c06\u672c\u5730 tar \u6587\u4ef6\u81ea\u52a8\u63d0\u53d6\u5230\u955c\u50cf\u4e2d\uff0c\u4f8b\u5982<code>ADD rootfs.tar.xz</code>\u3002</p> <p>\u5982\u679c\u4f60\u7684 Dockerfile \u6709\u591a\u4e2a\u6b65\u9aa4\u9700\u8981\u4f7f\u7528\u4e0a\u4e0b\u6587\u4e2d\u4e0d\u540c\u7684\u6587\u4ef6\u3002\u5355\u72ec COPY \u6bcf\u4e2a\u6587\u4ef6\uff0c\u800c\u4e0d\u662f\u4e00\u6b21\u6027\u7684 COPY \u6240\u6709\u6587\u4ef6\uff0c\u8fd9\u5c06\u4fdd\u8bc1\u6bcf\u4e2a\u6b65\u9aa4\u7684\u6784\u5efa\u7f13\u5b58\u53ea\u5728\u7279\u5b9a\u7684\u6587\u4ef6\u53d8\u5316\u65f6\u5931\u6548\u3002\u4f8b\u5982\uff1a</p> <pre><code>COPY requirements.txt /tmp/\nRUN pip install --requirement /tmp/requirements.txt\nCOPY . /tmp/\n</code></pre> <p>\u5982\u679c\u5c06COPY . /tmp/\u653e\u7f6e\u5728 RUN \u6307\u4ee4\u4e4b\u524d\uff0c\u53ea\u8981 . \u76ee\u5f55\u4e2d\u4efb\u4f55\u4e00\u4e2a\u6587\u4ef6\u53d8\u5316\uff0c\u90fd\u4f1a\u5bfc\u81f4\u540e\u7eed\u6307\u4ee4\u7684\u7f13\u5b58\u5931\u6548\u3002</p> <p>\u4e3a\u4e86\u8ba9\u955c\u50cf\u5c3d\u91cf\u5c0f\uff0c\u6700\u597d\u4e0d\u8981\u4f7f\u7528 ADD \u6307\u4ee4\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u5305\uff0c\u800c\u662f\u4f7f\u7528 curl \u548c wget\u3002\u8fd9\u6837\u4f60\u53ef\u4ee5\u5728\u6587\u4ef6\u63d0\u53d6\u5b8c\u4e4b\u540e\u5220\u6389\u4e0d\u518d\u9700\u8981\u7684\u6587\u4ef6\u6765\u907f\u514d\u5728\u955c\u50cf\u4e2d\u989d\u5916\u6dfb\u52a0\u4e00\u5c42\u3002\u6bd4\u5982\u5c3d\u91cf\u907f\u514d\u4e0b\u9762\u7684\u7528\u6cd5\uff1a</p> <pre><code>ADD http://example.com/big.tar.xz /usr/src/things/\nRUN tar -xJf /usr/src/things/big.tar.xz -C /usr/src/things\nRUN make -C /usr/src/things all\n</code></pre> <p>\u800c\u662f\u5e94\u8be5\u4f7f\u7528\u4e0b\u9762\u8fd9\u79cd\u65b9\u6cd5\uff1a</p> <pre><code>RUN mkdir -p /usr/src/things \\\\\n    &amp;&amp; curl -SL http://example.com/big.tar.xz \\\\\n    | tar -xJC /usr/src/things \\\\\n    &amp;&amp; make -C /usr/src/things all\n</code></pre> <p>\u4e0a\u9762\u4f7f\u7528\u7684\u7ba1\u9053\u64cd\u4f5c\uff0c\u6240\u4ee5\u6ca1\u6709\u4e2d\u95f4\u6587\u4ef6\u9700\u8981\u5220\u9664\u3002\u5bf9\u4e8e\u5176\u4ed6\u4e0d\u9700\u8981 ADD \u7684\u81ea\u52a8\u63d0\u53d6\u529f\u80fd\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u4f60\u5e94\u8be5\u4f7f\u7528 COPY\u3002</p>"},{"location":"docker/dockerfile_practice/#cmd_entrypoint","title":"CMD \u4e0e ENTRYPOINT \u6307\u4ee4","text":"<p>\u5c3d\u7ba1 ENTRYPOINT \u548c CMD \u90fd\u662f\u5728\u5bb9\u5668\u91cc\u6267\u884c\u4e00\u6761\u547d\u4ee4, \u4f46\u662f\u4ed6\u4eec\u6709\u4e00\u4e9b\u5fae\u5999\u7684\u533a\u522b\uff0c\u5728\u7edd\u5927\u591a\u6570\u60c5\u51b5\u4e0b, \u4f60\u53ea\u8981\u5728\u8fd92\u8005\u4e4b\u95f4\u9009\u62e9\u4e00\u4e2a\u8c03\u7528\u5c31\u53ef\u4ee5\uff0c\u4f46\u662f\u6211\u4eec\u8fd8\u662f\u975e\u5e38\u6709\u5fc5\u8981\u6765\u8ba4\u771f\u4e86\u89e3\u4e0b\u4e8c\u8005\u7684\u533a\u522b\u3002</p>"},{"location":"docker/dockerfile_practice/#cmd","title":"CMD \u6307\u4ee4","text":"<p><code>CMD</code> \u6307\u4ee4\u662f\u5bb9\u5668\u542f\u52a8\u4ee5\u540e\uff0c<code>\u9ed8\u8ba4</code>\u7684\u6267\u884c\u547d\u4ee4\uff0c\u9700\u8981\u91cd\u70b9\u7406\u89e3\u4e0b\u8fd9\u4e2a\u9ed8\u8ba4\u7684\u542b\u4e49\uff0c\u610f\u601d\u5c31\u662f\u5982\u679c\u6211\u4eec\u6267\u884c <code>docker run</code> \u6ca1\u6709\u6307\u5b9a\u4efb\u4f55\u7684\u6267\u884c\u547d\u4ee4\u6216\u8005 Dockerfile \u91cc\u9762\u4e5f\u6ca1\u6709\u6307\u5b9a ENTRYPOINT\uff0c\u90a3\u4e48\u5c31\u4f1a\u4f7f\u7528 CMD \u6307\u5b9a\u7684\u6267\u884c\u547d\u4ee4\u6267\u884c\u4e86\u3002\u8fd9\u4e5f\u8bf4\u660e\u4e86 ENTRYPOINT \u624d\u662f\u5bb9\u5668\u542f\u52a8\u4ee5\u540e\u771f\u6b63\u8981\u6267\u884c\u7684\u547d\u4ee4\u3002</p> <p>\u6240\u4ee5\u6211\u4eec\u7ecf\u5e38\u9047\u5230 <code>CMD \u4f1a\u88ab\u8986\u76d6</code> \u7684\u60c5\u51b5\uff0c\u4e3a\u4ec0\u4e48\u4f1a\u88ab\u8986\u76d6\u5462\uff1f\u4e3b\u8981\u8fd8\u662f\u56e0\u4e3a CMD \u7684\u5b9a\u4f4d\u5c31\u662f\u9ed8\u8ba4\uff0c\u5982\u679c\u4e0d\u989d\u5916\u6307\u5b9a\uff0c\u90a3\u4e48\u624d\u4f1a\u6267\u884c CMD \u547d\u4ee4\uff0c\u4f46\u662f\u5982\u679c\u6211\u4eec\u6307\u5b9a\u4e86\u7684\u8bdd\u90a3\u5c31\u4e0d\u4f1a\u6267\u884c CMD \u547d\u4ee4\u4e86\uff0c\u4e5f\u5c31\u662f\u8bf4 CMD \u4f1a\u88ab\u8986\u76d6\u3002</p> <p>CMD \u603b\u5171\u6709\u4e09\u79cd\u7528\u6cd5\uff1a</p> <pre><code>CMD [\"executable\", \"param1\", \"param2\"]  # exec \u5f62\u5f0f\nCMD [\"param1\", \"param2\"] # \u4f5c\u4e3a ENTRYPOINT \u7684\u9ed8\u8ba4\u53c2\u6570\nCMD command param1 param2  # shell \u5f62\u5f0f\n</code></pre> <p>\u5176\u4e2d shell \u5f62\u5f0f\uff0c\u5c31\u662f\u6ca1\u6709\u4e2d\u62ec\u53f7\u7684\u5f62\u5f0f\uff0c\u547d\u4ee4 command \u9ed8\u8ba4\u662f\u5728<code>/bin/sh -c</code>\u4e0b\u6267\u884c\u7684\uff0c\u6bd4\u5982\uff1a</p> <pre><code>FROM busybox\n\nCMD echo \"hello cmd shell form!\"\n</code></pre> <p>\u6211\u4eec\u5c06\u4e0a\u9762\u7684 Dockerfile \u6253\u5305\u6210 cmdshell \u955c\u50cf\uff0c\u7136\u540e\u76f4\u63a5\u542f\u52a8\u4e00\u4e2a\u5bb9\u5668\uff1a</p> <pre><code>$ docker build -t cmdshell .\nSending build context to Docker daemon  048kB\nStep 1/2 : FROM busybox\n ---&gt; 020584afccce\nStep 2/2 : CMD echo \"hello cmd shell form!\"\n ---&gt; Running in 651afaddb83d\nRemoving intermediate container 651afaddb83d\n ---&gt; d26e4d6d9cdf\nSuccessfully built d26e4d6d9cdf\nSuccessfully tagged cmdshell:latest\n$ docker run cmdshell\nhello cmd shell form!\n</code></pre> <p>\u5bf9\u4e8e\u5e26\u6709\u4e2d\u62ec\u53f7\u7684 exec \u5f62\u5f0f\uff0c\u547d\u4ee4\u6ca1\u6709\u5728\u4efb\u4f55 shell \u7ec8\u7aef\u73af\u5883\u4e0b\uff0c\u5982\u679c\u6211\u4eec\u8981\u6267\u884c shell\uff0c\u5fc5\u987b\u628a shell \u52a0\u5165\u5230\u4e2d\u62ec\u53f7\u7684\u53c2\u6570\u4e2d\u3002\u5c06\u4e0a\u9762\u7684\u4f8b\u5b50\u4fee\u6539\u4e3a\uff1a</p> <pre><code>FROM busybox\n\nCMD [\"/bin/sh\", \"-c\", \"echo 'hello cmd exec form!'\"]\n</code></pre> <p>\u540c\u6837\u5c06\u4e0a\u9762\u7684 Dockerfile \u6253\u5305\u6210 cmdexec \u955c\u50cf\uff0c\u7136\u540e\u76f4\u63a5\u542f\u52a8\u4e00\u4e2a\u5bb9\u5668\uff1a</p> <pre><code>$ docker build -t cmdexec .\nSending build context to Docker daemon  048kB\nStep 1/2 : FROM busybox\n ---&gt; 020584afccce\nStep 2/2 : CMD [\"/bin/sh\", \"-c\", \"echo 'hello cmd exec form!'\"]\n ---&gt; Running in 8c72d5e2ce35\nRemoving intermediate container 8c72d5e2ce35\n ---&gt; c393bd1ab3c1\nSuccessfully built c393bd1ab3c1\nSuccessfully tagged cmdexec:latest\n$ docker run cmdexec\nhello cmd exec form!\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\uff0c\u91c7\u7528 exec \u5f62\u5f0f\uff0c\u7b2c\u4e00\u4e2a\u53c2\u6570\u5fc5\u987b\u662f\u547d\u4ee4\u7684<code>\u5168\u8def\u5f84</code>\u624d\u884c\u3002\u4e00\u4e2a Dockerfile \u5982\u679c\u6709\u591a\u4e2a CMD\uff0c\u53ea\u6709\u6700\u540e\u4e00\u4e2a\u751f\u6548\uff0c\u5b98\u7f51\u63a8\u8350\u91c7\u7528\u8fd9\u79cd\u65b9\u5f0f\u3002</p> <p>\u5f53\u7136\uff0c\u4ee5\u4e0a\u90fd\u662f\u4f53\u73b0\u4e86 CMD \u7684 <code>\u9ed8\u8ba4</code> \u884c\u4e3a\u3002\u5982\u679c\u6211\u4eec\u5728 run \u65f6\u6307\u5b9a\u4e86\u547d\u4ee4\u6216\u8005\u6709 ENTRYPOINT CMD \u5c31\u4f1a\u88ab\u8986\u76d6\u3002\u6bd4\u5982\u540c\u6837\u7528\u4e0a\u9762\u4e24\u4e2a\u955c\u50cf\uff0c\u5728\u8fd0\u884c\u7684\u65f6\u5019\u6307\u5b9a\u4e00\u4e2a\u547d\u4ee4\uff1a</p> <pre><code>$ docker run cmdexec echo 'hello docker'\nhello docker\n$ docker run cmdshell echo 'hello docker'\nhello docker\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u6700\u7ec8\u5bb9\u5668\u91cc\u9762\u6267\u884c\u7684\u662f run \u547d\u4ee4\u540e\u9762\u7684\u547d\u4ee4\uff0c\u800c\u4e0d\u662f CMD \u91cc\u9762\u5b9a\u4e49\u7684\u3002</p>"},{"location":"docker/dockerfile_practice/#entrypoint","title":"ENTRYPOINT \u6307\u4ee4","text":"<p>\u6839\u636e\u5b98\u65b9\u5b9a\u4e49\u6765\u8bf4 <code>ENTRYPOINT</code> \u624d\u662f\u7528\u4e8e\u5b9a\u4e49\u5bb9\u5668\u542f\u52a8\u4ee5\u540e\u7684\u6267\u884c\u7a0b\u5e8f\u7684\uff0c\u5141\u8bb8\u5c06\u955c\u50cf\u5f53\u6210\u547d\u4ee4\u672c\u8eab\u6765\u8fd0\u884c\uff08\u7528 CMD \u63d0\u4f9b\u9ed8\u8ba4\u9009\u9879\uff09\uff0c\u4ece\u540d\u5b57\u4e5f\u53ef\u4ee5\u7406\u89e3\uff0c\u662f\u5bb9\u5668\u7684<code>\u5165\u53e3</code>\u3002ENTRYPOINT \u4e00\u5171\u6709\u4e24\u79cd\u7528\u6cd5\uff1a</p> <pre><code>ENTRYPOINT [\"executable\", \"param1\", \"param2\"] (exec \u5f62\u5f0f)\nENTRYPOINT command param1 param2 (shell \u5f62\u5f0f)\n</code></pre> <p>\u5bf9\u5e94\u547d\u4ee4\u884c exec \u6a21\u5f0f\uff0c\u4e5f\u5c31\u662f\u5e26\u4e2d\u62ec\u53f7\u7684\u3002\u548c CMD \u7684\u4e2d\u62ec\u53f7\u5f62\u5f0f\u662f\u4e00\u81f4\u7684\uff0c\u4f46\u662f\u8fd9\u91cc\u8c8c\u4f3c\u662f\u5728shell\u7684\u73af\u5883\u4e0b\u6267\u884c\u7684\uff0c\u4e0ecmd\u6709\u533a\u522b\u3002\u5982\u679c run \u547d\u4ee4\u540e\u9762\u6709\u6267\u884c\u547d\u4ee4\uff0c\u90a3\u4e48\u540e\u9762\u7684\u5168\u90e8\u90fd\u4f1a\u4f5c\u4e3a ENTRYPOINT \u7684\u53c2\u6570\u3002\u5982\u679c run \u540e\u9762\u6ca1\u6709\u989d\u5916\u7684\u547d\u4ee4\uff0c\u4f46\u662f\u5b9a\u4e49\u4e86 CMD\uff0c\u90a3\u4e48 CMD \u7684\u5168\u90e8\u5185\u5bb9\u5c31\u4f1a\u4f5c\u4e3a ENTRYPOINT \u7684\u53c2\u6570\uff0c\u8fd9\u540c\u65f6\u662f\u4e0a\u9762\u6211\u4eec\u63d0\u5230\u7684 CMD \u7684\u7b2c\u4e8c\u79cd\u7528\u6cd5\u3002\u6240\u4ee5\u8bf4 ENTRYPOINT \u4e0d\u4f1a\u88ab\u8986\u76d6\u3002\u5f53\u7136\u5982\u679c\u8981\u5728 run \u91cc\u9762\u8986\u76d6\uff0c\u4e5f\u662f\u6709\u529e\u6cd5\u7684\uff0c\u4f7f\u7528<code>--entrypoint</code>\u53c2\u6570\u5373\u53ef\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u5b9a\u4e49\u5982\u4e0b\u7684 Dockerfile\uff1a</p> <pre><code>FROM busybox\n\nCMD [\"I am in cmd exec form\"]\nENTRYPOINT [\"echo\"]\n</code></pre> <p>\u5c06\u4e0a\u9762\u7684 Dockerfile \u6253\u5305\u6210\u955c\u50cf entrypointest\uff0c\u7136\u540e\u76f4\u63a5\u8fd0\u884c\uff0c\u4e0d\u5e26\u4efb\u4f55\u53c2\u6570\uff1a</p> <pre><code>$ docker build -t entrypointest .\nSending build context to Docker daemon  048kB\nStep 1/3 : FROM busybox\n ---&gt; 020584afccce\nStep 2/3 : CMD [\"I am in cmd exec form\"]\n ---&gt; Running in 2d7b13b0dfe7\nRemoving intermediate container 2d7b13b0dfe7\n ---&gt; 903d739ead9a\nStep 3/3 : ENTRYPOINT [\"echo\"]\n ---&gt; Running in c61682ea476e\nRemoving intermediate container c61682ea476e\n ---&gt; 00b09a578d48\nSuccessfully built 00b09a578d48\nSuccessfully tagged entrypointest:latest\n$ docker run entrypointest\nI am in cmd exec form\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6253\u5370\u7684\u7ed3\u679c\u662f CMD \u91cc\u9762\u6307\u5b9a\u7684\u5185\u5bb9\uff0c\u4e5f\u5c31\u662f\u9ed8\u8ba4\u60c5\u51b5\u5c06 CMD \u90e8\u5206\u4f5c\u4e3a ENTRYPOINT \u7684\u53c2\u6570\u4e86\u3002\u4f46\u662f\u5982\u679c\u6211\u4eec\u5728\u8fd0\u884c\u5bb9\u5668\u7684\u65f6\u5019\u5982\u679c\u6307\u5b9a\u4e86\u8fd0\u884c\u53c2\u6570\u5462\uff1a</p> <pre><code>$ docker run entrypointest I am in run section\nI am in run section\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8fd0\u884c\u65f6\u6307\u5b9a\u7684\u53c2\u6570\u4f1a\u8986\u76d6\u6389 CMD \u63d0\u4f9b\u7684\u9ed8\u8ba4\u53c2\u6570\uff0c\u4f46\u662f\u9ed8\u8ba4\u90fd\u662f\u6267\u884c\u7684 ENTRYPOINT \u91cc\u9762\u7684\u547d\u4ee4\u3002</p> <p>\u5bf9\u4e8e shell \u6a21\u5f0f\u7684\uff0c\u4efb\u4f55 run \u548c CMD \u7684\u53c2\u6570\u90fd\u65e0\u6cd5\u88ab\u4f20\u5165\u5230 ENTRYPOINT \u91cc\u3002\u5b98\u7f51\u63a8\u8350\u7528\u4e0a\u9762\u4e00\u79cd\u7528\u6cd5\u3002\u6bd4\u5982\u6211\u4eec\u6211\u4eec\u8fd9\u91cc\u5b9a\u4e49\u4e00\u4e2a Dockerfile \u5982\u4e0b\uff1a</p> <pre><code>FROM busybox\n\nCMD [\"I am in cmd exec form and entrypoint shell form\"]\nENTRYPOINT echo\n</code></pre> <p>\u5c06\u4e0a\u9762 Dockerfile \u6253\u5305\u6210\u955c\u50cf entrypointshell\uff0c\u7136\u540e\u76f4\u63a5\u8fd0\u884c\uff1a</p> <pre><code>$ docker build -t entrypointshell .\nSending build context to Docker daemon  048kB\nStep 1/3 : FROM busybox\n ---&gt; 020584afccce\nStep 2/3 : CMD [\"I am in cmd exec form and entrypoint shell form\"]\n ---&gt; Running in 2aee7326f4cd\nRemoving intermediate container 2aee7326f4cd\n ---&gt; e89cadeeecd3\nStep 3/3 : ENTRYPOINT echo\n ---&gt; Running in f359c8bb5025\nRemoving intermediate container f359c8bb5025\n ---&gt; f9d4e1d1b0a0\nSuccessfully built f9d4e1d1b0a0\nSuccessfully tagged entrypointshell:latest\n$ docker run entrypointshell\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0 CMD \u7684\u53c2\u6570\u5e76\u6ca1\u6709\u88ab\u6253\u5370\u51fa\u6765\uff0c\u5982\u679c\u5728\u8fd0\u884c\u7684\u65f6\u5019\u6dfb\u52a0\u4e0a\u53c2\u6570\u5462\uff1a</p> <pre><code>$ docker run entrypointshell I am in run section\n$\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\u4e5f\u6ca1\u6709\u5c06 run \u547d\u4ee4\u540e\u9762\u7684\u53c2\u6570\u6253\u5370\u51fa\u6765\u3002\u6240\u4ee5\u4e00\u822c\u60c5\u51b5\u4e0b\u5bf9\u4e8e ENTRYPOINT \u6765\u8bf4\u4f7f\u7528\u4e2d\u62ec\u53f7\u7684 exec \u5f62\u5f0f\u66f4\u597d\u3002</p> <p>\u603b\u7ed3</p> <p>\u4e00\u822c\u4f1a\u7528 ENTRYPOINT \u7684\u4e2d\u62ec\u53f7\u5f62\u5f0f\u4f5c\u4e3a Docker \u5bb9\u5668\u542f\u52a8\u4ee5\u540e\u7684\u9ed8\u8ba4\u6267\u884c\u547d\u4ee4\uff0c\u91cc\u9762\u653e\u7684\u662f\u4e0d\u53d8\u7684\u90e8\u5206\uff0c\u53ef\u53d8\u90e8\u5206\u6bd4\u5982\u547d\u4ee4\u53c2\u6570\u53ef\u4ee5\u4f7f\u7528 CMD \u7684\u5f62\u5f0f\u63d0\u4f9b\u9ed8\u8ba4\u7248\u672c\uff0c\u4e5f\u5c31\u662f run \u91cc\u9762\u6ca1\u6709\u4efb\u4f55\u53c2\u6570\u65f6\u4f7f\u7528\u7684\u9ed8\u8ba4\u53c2\u6570\u3002\u5982\u679c\u6211\u4eec\u60f3\u7528\u9ed8\u8ba4\u53c2\u6570\uff0c\u5c31\u76f4\u63a5 run\uff0c\u5426\u5219\u60f3\u7528\u5176\u4ed6\u53c2\u6570\uff0c\u5c31 run \u91cc\u9762\u52a0\u4e0a\u53c2\u6570\u3002</p>"},{"location":"docker/dockerfile_practice/#_7","title":"\u5b98\u65b9\u4ed3\u5e93\u793a\u4f8b","text":"<p>\u8fd9\u4e9b\u5b98\u65b9\u4ed3\u5e93\u7684 Dockerfile \u90fd\u662f\u53c2\u8003\u5178\u8303\uff1ahttps://github.com/docker-library/docs\u3002</p>"},{"location":"docker/dockerfile_practice/#wordpress","title":"Wordpress \u793a\u4f8b","text":"<p>\u8fd9\u91cc\u6211\u4eec\u4ee5\u521b\u5efa\u4e00\u4e2a Wordpress \u955c\u50cf\u4e3a\u4f8b\uff0c\u6211\u4eec\u77e5\u9053\u9ed8\u8ba4\u60c5\u51b5\u4e0b Wordpress \u662f\u4f7f\u7528 MySQL \u6570\u636e\u5e93\u7684\uff0c\u5982\u679c\u4f7f\u7528 MySQL \u6570\u636e\u5e93\u7684\u4e0d\u5229\u4e8e\u6211\u4eec\u8fd9\u91cc\u7684\u6f14\u793a\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u7528 Sqlite \u6765\u4f5c\u4e3a Wordpress \u7684\u5b58\u50a8\u6570\u636e\u5e93\uff0c\u8981\u7f16\u5199\u4e00\u4e2a\u4f7f\u7528 Sqlite \u6570\u636e\u5e93\u7684 Wordpress \u955c\u50cf\uff0c\u9996\u5148\u6211\u4eec\u9700\u8981\u660e\u767d\u5982\u679c\u4e0d\u4f7f\u7528\u955c\u50cf\u5e94\u8be5\u600e\u4e48\u6765\u90e8\u7f72\u8fd9\u6837\u7684\u4e00\u4e2a\u7a0b\u5e8f\uff0c\u5426\u5219\u662f\u4e0d\u53ef\u80fd\u7f16\u5199\u51fa Dockerfile \u7684\u3002</p>"},{"location":"docker/dockerfile_practice/#wordpress_1","title":"\u83b7\u53d6 Wordpress","text":"<p>\u9996\u5148\uff0c\u6211\u4eec\u9700\u8981\u83b7\u53d6\u5230 Wordpress \u7684\u7a0b\u5e8f\u5b89\u88c5\u5305\uff0c\u5730\u5740\uff1ahttps://wordpress.org/download/\uff0c\u4e0b\u8f7d\u6700\u65b0\u7684 Wordpress \u5b89\u88c5\u5305\u3002</p>"},{"location":"docker/dockerfile_practice/#sqlite","title":"\u83b7\u53d6 SQLite \u63d2\u4ef6","text":"<p>\u7531\u4e8e Wordpress \u9ed8\u8ba4\u4f7f\u7528\u7684\u662f MySQL \u6570\u636e\u5e93\uff0c\u5982\u679c\u8981\u4f7f\u7528 SQLite \u6570\u636e\u5e93\u7684\u8bdd\u9700\u8981\u4f7f\u7528 SQLite \u63d2\u4ef6\uff0c\u5730\u5740\uff1ahttps://wordpress.org/plugins/sqlite-integration/</p>"},{"location":"docker/dockerfile_practice/#_8","title":"\u5b89\u88c5\u6fc0\u6d3b\u63d2\u4ef6","text":"<p>\u5c06 SQLite \u63d2\u4ef6\u89e3\u538b\u653e\u7f6e\u5230 Wordpress \u6e90\u7801\u76ee\u5f55 <code>wp-content/plugins</code> \u76ee\u5f55\u4e0b\u9762\uff0c\u7136\u540e\u62f7\u8d1d sqlite-integration \u76ee\u5f55\u4e0b\u9762\u7684 <code>db.php</code> \u6587\u4ef6\u5230 Wordpress \u7684 <code>wordpress/wp-content</code> \u76ee\u5f55\u4e0b\u9762\u3002</p> <p>\u7136\u540e\u91cd\u65b0\u5c06 </p> <pre><code>wordpress/wp-config-sample.php\n</code></pre> <p>\u91cd\u547d\u540d\u4e3a </p> <pre><code>wordpress/wp-config.php\n</code></pre> <p>\uff0c\u53ef\u4ee5\u901a\u8fc7\u8be5\u6587\u4ef6\u91cc\u9762\u7684\u4e00\u4e9b\u53c2\u6570\u6765\u914d\u7f6e\u6570\u636e\u5e93\u7684\u540d\u79f0\u548c\u4f4d\u7f6e\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u6570\u636e\u5e93\u540d\u4e3a<code>.ht.sqlite</code>\uff0c\u5b58\u50a8\u5728 <code>wp-content/database/</code> \u76ee\u5f55\u4e2d\u3002</p> <p>\u7136\u540e\u5b89\u88c5\u4e0a Wordpress \u8fd0\u884c\u7684\u4e00\u4e9b\u73af\u5883\u6bd4\u8f83 PHP\u3001Nginx \u5c31\u53ef\u4ee5\u8fd0\u884c\u4e86\uff0c\u6700\u7ec8\u7684 Dockerfile \u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>FROM nginx:latest\n\nLABEL version=\"0\"\nLABEL author=\"\u9633\u660e &lt;icnych@gmail.com&gt;\"\n\n# \u8bbe\u7f6e\u6210\u975e\u4ea4\u4e92\u5f0f\u7684\nENV DEBIAN_FRONTEND noninteractive\nENV DOCUMENT_ROOT /usr/share/nginx/html\n\n# \u5b89\u88c5 nginx php-fpm php-pdo unzip curl\nRUN apt-get update &amp;&amp; apt-get -y install \\\\\n    apt-utils \\\\\n    curl \\\\\n    php-fpm \\\\\n    php-sqlite3 \\\\\n    unzip\n\nCOPY wordpress-tar.gz .\n\nRUN rm -rf ${DOCUMENT_ROOT}/* &amp;&amp; \\\\\n    tar -xzvf wordpress-tar.gz --strip-components=1 --directory ${DOCUMENT_ROOT} &amp;&amp; \\\\\n    rm -rf wordpress-tar.gz\n# RUN rm -rf ${DOCUMENT_ROOT}/* &amp;&amp; \\\\\n#     curl -o wordpress.tar.gz https://wordpress.org/latest.tar.gz &amp;&amp; \\\\\n#     tar -xzvf /wordpress.tar.gz --strip-components=1 --directory ${DOCUMENT_ROOT}\n\nCOPY sqlite-integration.zip .\nRUN unzip sqlite-integration.zip -d ${DOCUMENT_ROOT}/wp-content/plugins/ &amp;&amp; \\\\\n    rm -rf sqlite-integration.zip\n# RUN curl -o sqlite-plugin.zip https://downloads.wordpress.org/plugin/sqlite-integration.zip &amp;&amp; \\\\\n    # unzip sqlite-plugin.zip -d ${DOCUMENT_ROOT}/wp-content/plugins/ &amp;&amp; \\\\\n    # rm sqlite-plugin.zip &amp;&amp; \\\\\n\nRUN cp ${DOCUMENT_ROOT}/wp-content/plugins/sqlite-integration/db.php ${DOCUMENT_ROOT}/wp-content &amp;&amp; \\\\\n    cp ${DOCUMENT_ROOT}/wp-config-sample.php ${DOCUMENT_ROOT}/wp-config.php\n\n# nginx \u914d\u7f6e\nRUN sed -i -e\"s/keepalive_timeout\\\\s*65/keepalive_timeout 2/\" /etc/nginx/nginx.conf \\\\\n    &amp;&amp; sed -i -e\"s/keepalive_timeout 2/keepalive_timeout 2;\\\\n\\\\tclient_max_body_size 10m/\" /etc/nginx/nginx.conf \\\\\n    &amp;&amp; sed -i -e \"s|include /etc/nginx/conf.d/\\\\*.conf|include /etc/nginx/sites-enabled/\\\\*|g\" /etc/nginx/nginx.conf \\\\\n    &amp;&amp; echo \"daemon off;\" &gt;&gt; /etc/nginx/nginx.conf\n\n# php-fpm \u914d\u7f6e\n# RUN php --ini  # \u627e\u5230fpm\u914d\u7f6e\nRUN sed -i -e \"s/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/g\" /etc/php/3/fpm/php.ini \\\\\n    &amp;&amp; sed -i -e \"s/upload_max_filesize\\\\s*=\\\\s*2M/upload_max_filesize = 10M/g\" /etc/php/3/fpm/php.ini \\\\\n    &amp;&amp; sed -i -e \"s/post_max_size\\\\s*=\\\\s*8M/post_max_size = 10M/g\" /etc/php/3/fpm/php.ini \\\\\n    &amp;&amp; sed -i -e \"s/;catch_workers_output\\\\s*=\\\\s*yes/catch_workers_output = yes/g\" /etc/php/3/fpm/pool.d/www.conf \\\\\n    &amp;&amp; sed -i -e \"s/;listen.mode = 0660/listen.mode = 0666/g\" /etc/php/3/fpm/pool.d/www.conf\n\nCOPY nginx.conf /etc/nginx/sites-available/default\nRUN chown -R www-data.www-data ${DOCUMENT_ROOT} \\\\\n    &amp;&amp; mkdir -p /etc/nginx/sites-enabled \\\\\n    &amp;&amp; ln -s /etc/nginx/sites-available/default /etc/nginx/sites-enabled/default \\\\\n    &amp;&amp; apt-get purge -y --auto-remove curl unzip\n\nEXPOSE 80\nEXPOSE 443\n\nCMD service php3-fpm start &amp;&amp; nginx\n</code></pre> <p>\u7531\u4e8e\u4e00\u4e9b\u7f51\u7edc\u539f\u56e0\uff0c\u6211\u4eec\u8fd9\u91cc\u5c06\u5b89\u88c5\u5305\u90fd\u653e\u7f6e\u5230\u4e86 Dockerfile \u76ee\u5f55\u4e0b\u9762\uff0c\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u6765\u6784\u5efa\u955c\u50cf\uff1a</p> <pre><code>$ docker build -t cnych/wordpress:sqlite .\n</code></pre> <p>\u7136\u540e\u7528\u8be5\u955c\u50cf\u6765\u8fd0\u884c\u4e00\u4e2a Wordpress \u5bb9\u5668\uff1a</p> <pre><code>$ docker run -d --name wordpress -p 8888:80 cnych/wordpress:sqlite\n</code></pre> <p>\u8fd0\u884c\u6210\u529f\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 8888 \u7aef\u53e3\u6765\u8bbf\u95ee Wordpress \u5e94\u7528\u4e86\uff0c\u800c\u4e14\u6211\u4eec\u6ca1\u6709 MySQL \u76f8\u5173\u7684\u914d\u7f6e\uff0c\u901a\u8fc7\u4e00\u4e9b\u914d\u7f6e\u5c31\u53ef\u4ee5\u8bbf\u95ee\u5230\u5e94\u7528\u4e86\u3002</p> <p></p>"},{"location":"docker/dockerfile_usage/","title":"Dockerfile","text":""},{"location":"docker/dockerfile_usage/#dockerfile","title":"Dockerfile","text":"<p>\u4f7f\u7528 Dockerfile \u5b9a\u5236\u955c\u50cf</p> <p></p> <p>\u955c\u50cf\u7684\u5b9a\u5236\u5b9e\u9645\u4e0a\u5c31\u662f\u5b9a\u5236\u955c\u50cf\u7684\u6bcf\u4e00\u5c42\u6240\u6dfb\u52a0\u7684\u914d\u7f6e\u3001\u6587\u4ef6\u7b49\u4fe1\u606f\uff0c\u5b9e\u9645\u4e0a\u5f53\u6211\u4eec\u5728\u4e00\u4e2a\u5bb9\u5668\u4e2d\u6dfb\u52a0\u6216\u8005\u4fee\u6539\u4e86\u4e00\u4e9b\u6587\u4ef6\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7<code>docker commit</code>\u547d\u4ee4\u6765\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u955c\u50cf\uff0c\u4f46\u662f\u8fd9\u4e2a\u65b9\u6cd5\u4e0d\u591f\u76f4\u89c2\uff0c\u6ca1\u529e\u6cd5\u8ffd\u6eaf\u6211\u4eec\u955c\u50cf\u91cc\u9762\u5230\u5e95\u6709\u54ea\u4e9b\u5185\u5bb9\uff0c\u6240\u4ee5\u5b9e\u9645\u5b9a\u5236\u955c\u50cf\u7684\u8fc7\u7a0b\u6211\u4eec\u5f88\u5c11\u91c7\u7528\u8fd9\u79cd\u65b9\u5f0f\u3002\u800c\u662f\u4f7f\u7528\u4e00\u4e2a\u540d\u4e3a <code>Dockerfile</code> \u7684\u6587\u672c\u6587\u4ef6\u6765\u8fdb\u884c\u955c\u50cf\u5b9a\u5236\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u955c\u50cf\u7684\u6bcf\u4e00\u5c42\u4fee\u6539\u3001\u5b89\u88c5\u3001\u6784\u5efa\u3001\u64cd\u4f5c\u7684\u547d\u4ee4\u90fd\u5199\u5165\u5230\u8fd9\u4e2a\u6587\u4ef6\u4e2d\uff0c\u4e00\u884c\u5c31\u5bf9\u5e94\u955c\u50cf\u7684\u4e00\u5c42\uff0c\u8fd9\u79cd\u65b9\u6cd5\u663e\u7136\u8981\u66f4\u9ad8\u7ea7\uff0c\u56e0\u4e3a\u6211\u4eec\u6709\u4e00\u4e2a\u6587\u4ef6\u6765\u76f4\u89c2\u53cd\u6620\u6211\u4eec\u7684\u955c\u50cf\u5185\u5bb9\uff0c\u8fd8\u53ef\u4ee5\u4f5c\u4e3a\u7248\u672c\u8bb0\u5f55\u8fdb\u884c\u8ddf\u8e2a\u3002</p>"},{"location":"docker/dockerfile_usage/#_1","title":"\u5b9a\u5236\u955c\u50cf","text":"<p>\u4ee5\u6211\u4eec\u4e4b\u524d\u7684 nginx \u955c\u50cf\u4e3a\u4f8b\uff0c\u6211\u4eec\u73b0\u5728\u6765\u5b9a\u5236\u4e00\u4e2a nginx \u955c\u50cf\uff0c\u8981\u6c42\u9ed8\u8ba4\u7684\u5e94\u7528\u9875\u9762\u8bbf\u95ee\u7684\u5185\u5bb9\u662f <code>Hello Docker</code>\u3002</p> <p>\u9996\u5148\u6211\u4eec\u65b0\u5efa\u4e00\u4e2a\u76ee\u5f55 testnginx\uff0c\u7136\u540e\u5728\u8be5\u76ee\u5f55\u4e0b\u9762\u65b0\u5efa\u4e00\u4e2a\u540d\u4e3a<code>Dockerfile</code>\u7684\u7a7a\u767d\u6587\u672c\u6587\u4ef6\uff1a</p> <pre><code>$ mkdir -p testnginx &amp;&amp; cd testnginx &amp;&amp; touch Dockerfile\n</code></pre> <p>\u7136\u540e\u5411<code>Dockerfile</code>\u6587\u4ef6\u4e2d\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>FROM nginx\nRUN echo 'Hello Docker!' &gt; /user/share/nginx/html/index.html\n</code></pre> <p>\u8fd9\u4e2a\u6587\u4ef6\u5f88\u7b80\u5355\uff0c\u4e00\u5171\u5c31\u4e24\u884c\uff0c\u5176\u4e2d\u5305\u542b\u4e24\u6761\u6307\u4ee4\uff0c<code>FROM</code> \u548c <code>RUN</code>\u3002</p>"},{"location":"docker/dockerfile_usage/#from","title":"FROM \u6307\u4ee4","text":"<p>\u5b9a\u5236\u955c\u50cf\uff0c\u90a3\u4e48\u80af\u5b9a\u662f\u4e00\u4e2a\u955c\u50cf\u4e3a\u57fa\u7840\uff0c\u5728\u5176\u57fa\u7840\u4e0a\u8fdb\u884c\u5b9a\u5236\uff0c\u800c <code>FROM</code> \u8fd9\u4e2a\u6307\u4ee4\u5c31\u662f\u6765\u6307\u5b9a\u57fa\u7840\u955c\u50cf\u7684\uff0c\u6240\u4ee5\u5728\u4e00\u4e2a <code>Dockerfile</code> \u6587\u4ef6\u4e2d <code>FROM</code> \u6307\u4ee4\u662f\u5fc5\u5907\u7684\uff0c\u5e76\u4e14\u5fc5\u987b\u662f\u7b2c\u4e00\u6761\u6307\u4ee4\u3002</p> <p>\u5728 Docker Hub \u4e0a\u6709\u975e\u5e38\u591a\u7684\u9ad8\u8d28\u91cf\u7684\u5b98\u65b9\u955c\u50cf\uff0c\u6709\u4e00\u4e9b\u53ef\u4ee5\u76f4\u63a5\u62ff\u6765\u4f7f\u7528\u7684\u670d\u52a1\u7c7b\u7684\u955c\u50cf\uff0c\u5982 nginx\u3001redis\u3001mongo\u3001mysql\u3001httpd\u3001php\u3001tomcat \u7b49\uff1b\u4e5f\u6709\u4e00\u4e9b\u65b9\u4fbf\u5f00\u53d1\u3001\u6784\u5efa\u3001\u8fd0\u884c\u5404\u79cd\u8bed\u8a00\u5e94\u7528\u7684\u955c\u50cf\uff0c\u5982 node\u3001openjdk\u3001python\u3001ruby\u3001golang \u7b49\u3002\u53ef\u4ee5\u5728\u5176\u4e2d\u5bfb\u627e\u4e00\u4e2a\u6700\u7b26\u5408\u6211\u4eec\u6700\u7ec8\u76ee\u6807\u7684\u955c\u50cf\u4e3a\u57fa\u7840\u955c\u50cf\u8fdb\u884c\u5b9a\u5236\u3002</p> <p>\u5982\u679c\u6ca1\u6709\u627e\u5230\u5408\u9002\u7684\u57fa\u7840\u955c\u50cf\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e9b\u66f4\u4e3a\u57fa\u7840\u7684\u64cd\u4f5c\u7cfb\u7edf\u955c\u50cf\uff0c\u6bd4\u5982 ubuntu\u3001debian\u3001centos\u3001alpine \u7b49\uff0c\u8fd9\u4e9b\u57fa\u7840\u955c\u50cf\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u66f4\u5927\u7684\u6269\u5c55\u7a7a\u95f4\uff0c\u5c31\u7c7b\u4f3c\u4e8e\u5e73\u65f6\u6211\u4eec\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e0a\u9762\u90e8\u7f72\u81ea\u5df1\u7684\u670d\u52a1\u4e00\u6837\u7684\u64cd\u4f5c\u3002</p> <p>\u9664\u4e86\u9009\u62e9\u73b0\u6709\u955c\u50cf\u4e3a\u57fa\u7840\u955c\u50cf\u5916\uff0cDocker \u8fd8\u5b58\u5728\u4e00\u4e2a\u7279\u6b8a\u7684\u955c\u50cf\uff0c\u540d\u4e3a <code>scratch</code>\uff0c\u8fd9\u4e2a\u955c\u50cf\u662f\u4e00\u4e2a\u865a\u62df\u7684\u955c\u50cf\uff0c\u5e76\u4e0d\u5b9e\u9645\u5b58\u5728\uff0c\u8868\u793a\u4e00\u4e2a\u7a7a\u767d\u7684\u955c\u50cf\uff1a</p> <p><code>FROM scratch ...</code></p> <p>\u5982\u679c\u4f60\u4ee5 <code>scratch</code> \u4e3a\u57fa\u7840\u955c\u50cf\u7684\u8bdd\uff0c\u610f\u5473\u7740\u4f60\u4e0d\u4ee5\u4efb\u4f55\u955c\u50cf\u4e3a\u57fa\u7840\uff0c\u63a5\u4e0b\u6765\u6240\u5199\u7684\u6307\u4ee4\u5c06\u4f5c\u4e3a\u955c\u50cf\u7b2c\u4e00\u5c42\u5f00\u59cb\u5b58\u5728\u3002\u6709\u7684\u540c\u5b66\u53ef\u80fd\u611f\u89c9\u5f88\u5947\u602a\uff0c\u6ca1\u6709\u4efb\u4f55\u57fa\u7840\u955c\u50cf\uff0c\u6211\u600e\u4e48\u53bb\u6267\u884c\u6211\u7684\u7a0b\u5e8f\u5462\uff0c\u5176\u5b9e\u5bf9\u4e8e Linux \u4e0b\u9759\u6001\u7f16\u8bd1\u7684\u7a0b\u5e8f\u6765\u8bf4\uff0c\u5e76\u4e0d\u9700\u8981\u6709\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u8fd0\u884c\u65f6\u652f\u6301\uff0c\u6240\u9700\u7684\u4e00\u5207\u5e93\u90fd\u5df2\u7ecf\u5728\u53ef\u6267\u884c\u6587\u4ef6\u91cc\u4e86\uff0c\u56e0\u6b64\u76f4\u63a5<code>FROM scratch</code>\u4f1a\u8ba9\u955c\u50cf\u4f53\u79ef\u66f4\u52a0\u5c0f\u5de7\u3002\u4f7f\u7528 Go \u8bed\u8a00 \u5f00\u53d1\u7684\u5e94\u7528\u5f88\u591a\u4f1a\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u6765\u5236\u4f5c\u955c\u50cf\uff0c\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u6709\u5f88\u591a\u89c2\u70b9\u8ba4\u4e3a Go \u662f\u7279\u522b\u9002\u5408\u5bb9\u5668\u5fae\u670d\u52a1\u67b6\u6784\u7684\u8bed\u8a00\u7684\u539f\u56e0\u4e4b\u4e00\u3002</p>"},{"location":"docker/dockerfile_usage/#run","title":"RUN \u6307\u4ee4","text":"<p><code>RUN</code> \u6307\u4ee4\u662f\u7528\u6765\u6267\u884c\u547d\u4ee4\u884c\u547d\u4ee4\u7684\u3002\u7531\u4e8e\u547d\u4ee4\u884c\u7684\u5f3a\u5927\u80fd\u529b\uff0c\u6240\u4ee5 <code>RUN</code> \u6307\u4ee4\u662f\u5b9a\u5236\u955c\u50cf\u65f6\u662f\u6700\u5e38\u7528\u7684\u6307\u4ee4\u4e4b\u4e00\u3002\u5176\u683c\u5f0f\u6709\u4e24\u79cd\uff1a</p> <ul> <li> <p>shell \u683c\u5f0f\uff1a<code>RUN &lt;\u547d\u4ee4&gt;</code>\uff0c\u5c31\u50cf\u76f4\u63a5\u5728\u547d\u4ee4\u884c\u4e2d\u8f93\u5165\u7684\u547d\u4ee4\u4e00\u6837\u3002\u521a\u624d\u5199\u7684 Dockerfile \u4e2d\u7684 RUN \u6307\u4ee4\u5c31\u662f\u8fd9\u79cd\u683c\u5f0f\uff1a</p> <pre><code>RUN echo 'Hello, Docker!' &gt; /usr/share/nginx/html/index.html\n</code></pre> </li> <li> <p>exec \u683c\u5f0f\uff1a</p> <pre><code>RUN [\"\u53ef\u6267\u884c\u6587\u4ef6\", \"\u53c2\u65701\", \"\u53c2\u65702\"]\n</code></pre> <p>\uff0c\u8fd9\u66f4\u50cf\u662f\u51fd\u6570\u8c03\u7528\u4e2d\u7684\u683c\u5f0f\u3002\u65e2\u7136 RUN \u5c31\u50cf Shell \u811a\u672c\u4e00\u6837\u53ef\u4ee5\u6267\u884c\u547d\u4ee4\uff0c\u90a3\u4e48\u6211\u4eec\u662f\u5426\u5c31\u53ef\u4ee5\u50cf Shell \u811a\u672c\u4e00\u6837\u628a\u6bcf\u4e2a\u547d\u4ee4\u5bf9\u5e94\u4e00\u4e2a RUN \u5462\uff1f\u6bd4\u5982\u8fd9\u6837\uff1a</p> <pre><code>FROM debian:jessie\nRUN apt-get update\nRUN apt-get install -y gcc libc6-dev make wget\nRUN wget -O redis.tar.gz \"http://download.redis.io/releases/redis-tar.gz\"\nRUN mkdir -p /usr/src/redis\nRUN tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1\nRUN make -C /usr/src/redis\nRUN make -C /usr/src/redis install\n# \u5176\u4ed6\u6307\u4ee4...\n</code></pre> </li> </ul> <p>\u4e4b\u524d\u8bf4\u8fc7\uff0cDockerfile \u4e2d\u6bcf\u4e00\u4e2a\u6307\u4ee4\u90fd\u4f1a\u5efa\u7acb\u4e00\u5c42\uff0cRUN \u4e5f\u4e0d\u4f8b\u5916\u3002\u6bcf\u4e00\u4e2a RUN \u5c31\u4f1a\u65b0\u5efa\u7acb\u4e00\u5c42\uff0c\u5728\u5176\u4e0a\u6267\u884c\u8fd9\u4e9b\u547d\u4ee4\uff0c\u6267\u884c\u7ed3\u675f\u540e\uff0ccommit \u8fd9\u4e00\u5c42\u7684\u4fee\u6539\uff0c\u6784\u6210\u65b0\u7684\u955c\u50cf\u3002</p> <p>\u800c\u4e0a\u9762\u7684\u8fd9\u79cd\u5199\u6cd5\uff0c\u521b\u5efa\u4e86 7 \u5c42\u955c\u50cf\u3002\u8fd9\u662f\u5b8c\u5168\u6ca1\u6709\u5fc5\u8981\u7684\uff0c\u800c\u4e14\u5f88\u591a\u8fd0\u884c\u65f6\u4e0d\u9700\u8981\u7684\u4e1c\u897f\uff0c\u90fd\u88ab\u88c5\u8fdb\u4e86\u955c\u50cf\u91cc\uff0c\u6bd4\u5982\u7f16\u8bd1\u73af\u5883\u3001\u66f4\u65b0\u7684\u8f6f\u4ef6\u5305\u7b49\u7b49\u3002\u7ed3\u679c\u5c31\u662f\u4ea7\u751f\u975e\u5e38\u81c3\u80bf\u3001\u975e\u5e38\u591a\u5c42\u7684\u955c\u50cf\uff0c\u4e0d\u4ec5\u4ec5\u589e\u52a0\u4e86\u6784\u5efa\u90e8\u7f72\u7684\u65f6\u95f4\uff0c\u4e5f\u5f88\u5bb9\u6613\u51fa\u9519\u3002 \u8fd9\u662f\u5f88\u591a\u521d\u5b66 Docker \u7684\u4eba\u5e38\u72af\u7684\u4e00\u4e2a\u9519\u8bef\u3002</p> <p>UnionFS \u5c42\u9650\u5236</p> <p>UnionFS \u5b9e\u9645\u4e0a\u662f\u6709\u6700\u5927\u5c42\u6570\u9650\u5236\u7684\uff0c\u6bd4\u5982 AUFS\uff0c\u66fe\u7ecf\u662f\u6700\u5927\u4e0d\u5f97\u8d85\u8fc7 42 \u5c42\uff0c\u73b0\u5728\u662f\u4e0d\u5f97\u8d85\u8fc7 127 \u5c42\u3002</p> <p>\u4e0a\u9762\u7684 Dockerfile \u6b63\u786e\u7684\u5199\u6cd5\u5e94\u8be5\u662f\u8fd9\u6837\uff1a</p> <pre><code>FROM debian:jessie\nRUN buildDeps='gcc libc6-dev make wget' \\\\\n    &amp;&amp; apt-get update \\\\\n    &amp;&amp; apt-get install -y $buildDeps \\\\\n    &amp;&amp; wget -O redis.tar.gz \"http://download.redis.io/releases/redis-tar.gz\" \\\\\n    &amp;&amp; mkdir -p /usr/src/redis \\\\\n    &amp;&amp; tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1 \\\\\n    &amp;&amp; make -C /usr/src/redis \\\\\n    &amp;&amp; make -C /usr/src/redis install \\\\\n    &amp;&amp; rm -rf /var/lib/apt/lists/* \\\\\n    &amp;&amp; rm redis.tar.gz \\\\\n    &amp;&amp; rm -r /usr/src/redis \\\\\n    &amp;&amp; apt-get purge -y --auto-remove $buildDeps\n# \u5176\u4ed6\u6307\u4ee4...\n</code></pre> <p>\u9996\u5148\uff0c\u4e4b\u524d\u6240\u6709\u7684\u547d\u4ee4\u53ea\u6709\u4e00\u4e2a\u76ee\u7684\uff0c\u5c31\u662f\u7f16\u8bd1\u3001\u5b89\u88c5 redis \u53ef\u6267\u884c\u6587\u4ef6\u3002\u56e0\u6b64\u6ca1\u6709\u5fc5\u8981\u5efa\u7acb\u5f88\u591a\u5c42\uff0c\u8fd9\u53ea\u662f\u4e00\u5c42\u7684\u4e8b\u60c5\u3002\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u6ca1\u6709\u4f7f\u7528\u5f88\u591a\u4e2a RUN \u6307\u4ee4\u6765\u5bf9\u5e94\u4e0d\u540c\u7684\u547d\u4ee4\uff0c\u800c\u662f\u4ec5\u4ec5\u4f7f\u7528\u4e00\u4e2a RUN \u6307\u4ee4\uff0c\u5e76\u4f7f\u7528<code>&amp;&amp;</code>\u5c06\u5404\u4e2a\u6240\u9700\u547d\u4ee4\u4e32\u8054\u8d77\u6765\u3002\u5c06\u4e4b\u524d\u7684 7 \u5c42\uff0c\u7b80\u5316\u4e3a\u4e86 1 \u5c42\u3002\u5728\u64b0\u5199 Dockerfile \u7684\u65f6\u5019\uff0c\u8981\u7ecf\u5e38\u63d0\u9192\u81ea\u5df1\uff0c\u8fd9\u5e76\u4e0d\u662f\u5728\u5199 Shell \u811a\u672c\uff0c\u800c\u662f\u5728\u5b9a\u4e49\u6bcf\u4e00\u5c42\u8be5\u5982\u4f55\u6784\u5efa\u3002</p> <p>\u5e76\u4e14\uff0c\u8fd9\u91cc\u4e3a\u4e86\u683c\u5f0f\u5316\u8fd8\u8fdb\u884c\u4e86\u6362\u884c\u3002Dockerfile \u652f\u6301 Shell \u7c7b\u7684\u884c\u5c3e\u6dfb\u52a0<code>\\</code>\u7684\u547d\u4ee4\u6362\u884c\u65b9\u5f0f\uff0c\u4ee5\u53ca\u884c\u9996<code>#</code>\u8fdb\u884c\u6ce8\u91ca\u7684\u683c\u5f0f\u3002\u826f\u597d\u7684\u683c\u5f0f\uff0c\u6bd4\u5982<code>\u6362\u884c\u3001\u7f29\u8fdb\u3001\u6ce8\u91ca</code>\u7b49\uff0c\u4f1a\u8ba9\u7ef4\u62a4\u3001\u6392\u969c\u66f4\u4e3a\u5bb9\u6613\uff0c\u8fd9\u662f\u4e00\u4e2a\u6bd4\u8f83\u597d\u7684\u4e60\u60ef\u3002</p> <p>\u6b64\u5916\uff0c\u8fd8\u53ef\u4ee5\u770b\u5230\u8fd9\u4e00\u7ec4\u547d\u4ee4\u7684\u6700\u540e\u6dfb\u52a0\u4e86\u6e05\u7406\u5de5\u4f5c\u7684\u547d\u4ee4\uff0c\u5220\u9664\u4e86\u4e3a\u4e86\u7f16\u8bd1\u6784\u5efa\u4e0b\u8f7d\u7684\u8f6f\u4ef6\uff0c\u6e05\u7406\u4e86\u6240\u6709\u4e0b\u8f7d\u3001\u5c55\u5f00\u7684\u6587\u4ef6\uff0c\u5e76\u4e14\u8fd8\u6e05\u7406\u4e86 apt \u7f13\u5b58\u6587\u4ef6\u3002\u8fd9\u662f\u5f88\u91cd\u8981\u7684\u4e00\u6b65\uff0c\u6211\u4eec\u4e4b\u524d\u8bf4\u8fc7\uff0c\u955c\u50cf\u662f\u591a\u5c42\u5b58\u50a8\uff0c\u6bcf\u4e00\u5c42\u7684\u4e1c\u897f\u5e76\u4e0d\u4f1a\u5728\u4e0b\u4e00\u5c42\u88ab\u5220\u9664\uff0c\u4f1a\u4e00\u76f4\u8ddf\u968f\u7740\u955c\u50cf\u3002\u56e0\u6b64\u955c\u50cf\u6784\u5efa\u65f6\uff0c\u4e00\u5b9a\u8981\u786e\u4fdd\u6bcf\u4e00\u5c42\u53ea\u6dfb\u52a0\u771f\u6b63\u9700\u8981\u6dfb\u52a0\u7684\u4e1c\u897f\uff0c\u4efb\u4f55\u65e0\u5173\u7684\u4e1c\u897f\u90fd\u5e94\u8be5\u6e05\u7406\u6389\u3002 \u5f88\u591a\u4eba\u521d\u5b66 Docker \u5236\u4f5c\u51fa\u4e86\u5f88\u81c3\u80bf\u7684\u955c\u50cf\u7684\u539f\u56e0\u4e4b\u4e00\uff0c\u5c31\u662f\u5fd8\u8bb0\u4e86\u6bcf\u4e00\u5c42\u6784\u5efa\u7684\u6700\u540e\u4e00\u5b9a\u8981\u6e05\u7406\u6389\u65e0\u5173\u6587\u4ef6\u3002</p>"},{"location":"docker/dockerfile_usage/#workdir","title":"WORKDIR \u6307\u4ee4","text":"<p><code>WORKDIR</code> \u6307\u4ee4\u8bbe\u7f6e Dockerfile \u4e2d\u7684\u4efb\u4f55 RUN\uff0cCMD\uff0cENTRPOINT\uff0cCOPY \u548c ADD \u6307\u4ee4\u7684\u5de5\u4f5c\u76ee\u5f55\u3002\u5982\u679c WORKDIR \u6307\u5b9a\u7684\u76ee\u5f55\u4e0d\u5b58\u5728\uff0c\u5373\u4f7f\u968f\u540e\u7684\u6307\u4ee4\u6ca1\u6709\u7528\u5230\u8fd9\u4e2a\u76ee\u5f55\uff0c\u90fd\u4f1a\u521b\u5efa\u8be5\u76ee\u5f55\u3002</p> <p>\u683c\u5f0f\uff1a </p> <pre><code>WORKDIR /path/to/workdir\n</code></pre> <p>\u4e3a\u4e86\u6e05\u6670\u6027\u548c\u53ef\u9760\u6027\uff0c\u4f60\u5e94\u8be5\u603b\u662f\u5728 WORKDIR \u4e2d\u4f7f\u7528\u7edd\u5bf9\u8def\u5f84\uff0c\u800c\u4e14\u5355\u4e2a Dockerfile \u53ef\u4ee5\u4f7f\u7528\u591a\u6b21WORKDIR\u3002\u53e6\u5916\uff0c\u6211\u4eec\u5e94\u8be5\u4f7f\u7528 WORKDIR \u6765\u66ff\u4ee3\u7c7b\u4f3c\u4e8e </p> <pre><code>RUN cd ... &amp;&amp; do-something\n</code></pre> <p>\u7684\u6307\u4ee4\uff0c\u540e\u8005\u96be\u4ee5\u9605\u8bfb\u3001\u6392\u9519\u548c\u7ef4\u62a4\u3002</p>"},{"location":"docker/dockerfile_usage/#add_copy","title":"ADD &amp; COPY \u6307\u4ee4","text":"<p>Dockerfile \u4e2d\u7684 <code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code> \u6307\u4ee4\u90fd\u53ef\u4ee5\u5c06\u4e3b\u673a\u4e0a\u7684\u8d44\u6e90\u590d\u5236\u6216\u52a0\u5165\u5230\u5bb9\u5668\u955c\u50cf\u4e2d\uff0c\u90fd\u662f\u5728\u6784\u5efa\u955c\u50cf\u7684\u8fc7\u7a0b\u4e2d\u5b8c\u6210\u7684\u3002</p> <p><code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code> \u6307\u4ee4\u7684\u552f\u4e00\u533a\u522b\u5728\u4e8e<code>\u662f\u5426\u652f\u6301\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90</code>\u3002<code>COPY</code> \u6307\u4ee4\u53ea\u80fd\u4ece\u6267\u884c<code>docker build</code>\u6240\u5728\u7684\u4e3b\u673a\u4e0a\u8bfb\u53d6\u8d44\u6e90\u5e76\u590d\u5236\u5230\u955c\u50cf\u4e2d\u3002\u800c <code>ADD</code> \u6307\u4ee4\u8fd8\u652f\u6301\u901a\u8fc7 URL \u4ece\u8fdc\u7a0b\u670d\u52a1\u5668\u8bfb\u53d6\u8d44\u6e90\u5e76\u590d\u5236\u5230\u955c\u50cf\u4e2d\u3002</p> <p>\u4e00\u822c\u6765\u8bf4\u6ee1\u8db3\u540c\u7b49\u529f\u80fd\u7684\u60c5\u51b5\u4e0b\uff0c\u63a8\u8350\u4f7f\u7528COPY\u6307\u4ee4\u3002<code>ADD</code> \u6307\u4ee4\u66f4\u64c5\u957f\u8bfb\u53d6\u672c\u5730 tar \u6587\u4ef6\u5e76\u89e3\u538b\u7f29\u3002</p>"},{"location":"docker/dockerfile_usage/#copy","title":"COPY \u6307\u4ee4","text":"<p><code>COPY</code> \u6307\u4ee4\u80fd\u591f\u5c06\u6784\u5efa\u547d\u4ee4\u6240\u5728\u7684\u4e3b\u673a\u672c\u5730\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u590d\u5236\u5230\u955c\u50cf\u6587\u4ef6\u7cfb\u7edf\u3002COPY \u6307\u4ee4\u540c\u6837\u4e5f\u652f\u6301 exec \u548c shell \u4e24\u79cd\u683c\u5f0f\uff1a</p> <ul> <li> <p>exec \u683c\u5f0f\u7528\u6cd5\uff1a</p> <pre><code>COPY [\"&lt;src&gt;\",... \"&lt;dest&gt;\"]\n</code></pre> <p>\uff0c\u7279\u522b\u9002\u5408\u8def\u5f84\u4e2d\u5e26\u6709\u7a7a\u683c\u7684\u60c5\u51b5\u3002</p> </li> <li> <p>shell \u683c\u5f0f\u7528\u6cd5\uff1a<code>COPY &lt;src&gt;... &lt;dest&gt;</code></p> </li> </ul>"},{"location":"docker/dockerfile_usage/#add","title":"ADD \u6307\u4ee4","text":"<p><code>ADD</code> \u6307\u4ee4\u4e0d\u4ec5\u80fd\u591f\u5c06\u6784\u5efa\u547d\u4ee4\u6240\u5728\u7684\u4e3b\u673a\u672c\u5730\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u800c\u4e14\u80fd\u591f\u5c06\u8fdc\u7a0b URL \u6240\u5bf9\u5e94\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u4f5c\u4e3a\u8d44\u6e90\u590d\u5236\u5230\u955c\u50cf\u6587\u4ef6\u7cfb\u7edf\u3002\u6240\u4ee5\uff0c\u53ef\u4ee5\u8ba4\u4e3a <code>ADD</code> \u662f\u589e\u5f3a\u7248\u7684 <code>COPY</code>\uff0c\u652f\u6301\u5c06\u8fdc\u7a0b URL \u7684\u8d44\u6e90\u52a0\u5165\u5230\u955c\u50cf\u7684\u6587\u4ef6\u7cfb\u7edf\u3002\u540c\u6837\u4e5f\u652f\u6301 exec \u548c shell \u4e24\u79cd\u683c\u5f0f\u7528\u6cd5\uff1a \u00a0 * exec \u683c\u5f0f\u7528\u6cd5\uff1a</p> <pre><code>ADD [\"&lt;src&gt;\",... \"&lt;dest&gt;\"]\n</code></pre> <p>\uff0c\u7279\u522b\u9002\u5408\u8def\u5f84\u4e2d\u5e26\u6709\u7a7a\u683c\u7684\u60c5\u51b5</p> <ul> <li>shell \u683c\u5f0f\u7528\u6cd5\uff1a<code>ADD &lt;src&gt;... &lt;dest&gt;</code></li> </ul> <p>\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90\uff0c\u6bd4\u5982\uff1a</p> <pre><code>ADD http://foo.com/bar.go /tmp/main.go\n</code></pre> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u5bf9\u4e8e\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90\u7684\u60c5\u51b5\uff0c\u7531\u4e8e ADD \u6307\u4ee4\u4e0d\u652f\u6301\u8ba4\u8bc1\uff0c\u5982\u679c\u4ece\u8fdc\u7a0b\u83b7\u53d6\u8d44\u6e90\u9700\u8981\u8ba4\u8bc1\uff0c\u5219\u53ea\u80fd\u4f7f\u7528<code>RUN wget</code> \u6216 <code>RUN curl</code> \u66ff\u4ee3\u4e86\u3002</p> <p>\u6709\u80fd\u529b\u81ea\u52a8\u89e3\u538b\u6587\u4ef6\uff0c\u6bd4\u5982\uff1a</p> <pre><code>ADD /foo.tar.gz /tmp/\n</code></pre> <p>\u4e0a\u8ff0\u6307\u4ee4\u4f1a\u4f7f foo.tar.gz \u538b\u7f29\u6587\u4ef6\u89e3\u538b\u5230\u5bb9\u5668\u7684 /tmp \u76ee\u5f55\u3002</p> <p>\u4e0d\u8fc7\u4e00\u822c\u6765\u8bf4\u867d\u7136 ADD \u6307\u4ee4\u652f\u6301\u4ece\u8fdc\u7a0b\u83b7\u53d6\u8d44\u6e90\uff0c\u4f46\u662f\u5e76\u4e0d\u63a8\u8350\u4f7f\u7528\uff0c\u800c\u662f\u5efa\u8bae\u4f7f\u7528 RUN \u6307\u4ee4\u53bb\u6267\u884c wget \u6216 curl \u547d\u4ee4\u3002</p> <p>\u6bd4\u5982\u524d\u9762\u6211\u4eec\u5b9a\u5236\u7684 nginx \u955c\u50cf\uff0c\u53ef\u4ee5\u6539\u6210\u4e0b\u9762\u7684\u5f62\u5f0f\uff1a</p> <pre><code>$ echo 'Hello Docker!' &gt; index.html\n</code></pre> <p>\u7136\u540e\u4fee\u6539 Dockerfile\uff1a</p> <pre><code>FROM nginx\n# COPY\u6216\u8005ADD\u6307\u4ee4\u90fd\u53ef\u4ee5\nCOPY index.html /user/share/nginx/html/index.html\n</code></pre>"},{"location":"docker/dockerfile_usage/#_2","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p><code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code>\u6307\u4ee4\u7684\u7528\u6cd5\u975e\u5e38\u76f8\u4f3c\uff0c\u5177\u4f53\u6ce8\u610f\u4e8b\u9879\u5982\u4e0b\uff1a</p> <ul> <li>\u6e90\u8def\u5f84\u53ef\u4ee5\u6709\u591a\u4e2a</li> <li>\u6e90\u8def\u5f84\u662f\u76f8\u5bf9\u4e8e\u6267\u884c build \u7684\u76f8\u5bf9\u8def\u5f84</li> <li>\u6e90\u8def\u5f84\u5982\u679c\u662f\u672c\u5730\u8def\u5f84\uff0c\u5fc5\u987b\u662f\u6784\u5efa\u4e0a\u4e0b\u6587\u4e2d\u7684\u8def\u5f84</li> <li>\u6e90\u8def\u5f84\u5982\u679c\u662f\u4e00\u4e2a\u76ee\u5f55\uff0c\u5219\u8be5\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u5185\u5bb9\u90fd\u5c06\u88ab\u52a0\u5165\u5230\u5bb9\u5668\uff0c\u4f46\u662f\u8be5\u76ee\u5f55\u672c\u8eab\u4e0d\u4f1a</li> <li>\u76ee\u6807\u8def\u5f84\u5fc5\u987b\u662f\u7edd\u5bf9\u8def\u5f84\uff0c\u6216\u76f8\u5bf9\u4e8e WORKDIR \u7684\u76f8\u5bf9\u8def\u5f84</li> <li>\u76ee\u6807\u8def\u5f84\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u4f1a\u521b\u5efa\u76f8\u5e94\u7684\u5b8c\u6574\u8def\u5f84</li> <li>\u76ee\u6807\u8def\u5f84\u5982\u679c\u4e0d\u662f\u4e00\u4e2a\u6587\u4ef6\uff0c\u5219\u5fc5\u987b\u4f7f\u7528/\u7ed3\u675f</li> <li>\u8def\u5f84\u4e2d\u53ef\u4ee5\u4f7f\u7528\u901a\u914d\u7b26</li> </ul>"},{"location":"docker/dockerfile_usage/#_3","title":"\u6784\u5efa\u955c\u50cf","text":"<p>\u73b0\u5728\u8ba9\u6211\u4eec\u518d\u56de\u5230\u4e4b\u524d\u5b9a\u5236\u7684 nginx \u955c\u50cf\u7684 Dockerfile \u6765\u3002\u73b0\u5728\u6211\u4eec\u660e\u767d\u4e86\u8fd9\u4e2a Dockerfile \u7684\u5185\u5bb9\uff0c\u90a3\u4e48\u8ba9\u6211\u4eec\u6765\u6784\u5efa\u8fd9\u4e2a\u955c\u50cf\u5427\u3002\u5728 Dockerfile \u6587\u4ef6\u6240\u5728\u76ee\u5f55\u6267\u884c\uff1a</p> <pre><code>$ docker build -t nginx:v1 .\nSending build context to Docker daemon 048 kB\nStep 1 : FROM nginx\n ---&gt; e43d811ce2f4\nStep 2 : RUN echo 'Hello, Docker!' &gt; /usr/share/nginx/html/index.html\n ---&gt; Running in 9cdc27646c7b\n ---&gt; 44aa4490ce2c\nRemoving intermediate container 9cdc27646c7b\nSuccessfully built 44aa4490ce2c\n</code></pre> <p>\u4ece\u547d\u4ee4\u7684\u8f93\u51fa\u7ed3\u679c\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u6e05\u6670\u7684\u770b\u5230\u955c\u50cf\u7684\u6784\u5efa\u8fc7\u7a0b\u3002\u5728 Step 2 \u4e2d\uff0c\u5982\u540c\u6211\u4eec\u4e4b\u524d\u6240\u8bf4\u7684\u90a3\u6837\uff0cRUN \u6307\u4ee4\u542f\u52a8\u4e86\u4e00\u4e2a\u5bb9\u5668 9cdc27646c7b\uff0c\u6267\u884c\u4e86\u6240\u8981\u6c42\u7684\u547d\u4ee4\uff0c\u5e76\u6700\u540e\u63d0\u4ea4\u4e86\u8fd9\u4e00\u5c42 44aa4490ce2c\uff0c\u968f\u540e\u5220\u9664\u4e86\u6240\u7528\u5230\u7684\u8fd9\u4e2a\u5bb9\u5668 9cdc27646c7b\u3002\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u4e86 <code>docker build</code> \u547d\u4ee4\u8fdb\u884c\u955c\u50cf\u6784\u5efa\u3002\u5176\u683c\u5f0f\u4e3a\uff1a</p> <pre><code>$ docker build [\u9009\u9879] &lt;\u4e0a\u4e0b\u6587\u8def\u5f84/URL/-&gt;\n</code></pre> <p>\u5728\u8fd9\u91cc\u6211\u4eec\u901a\u8fc7 <code>-t</code> \u53c2\u6570\u6307\u5b9a\u4e86\u6700\u7ec8\u955c\u50cf\u7684\u540d\u79f0 <code>nginx:v1</code>\uff0c\u6784\u5efa\u6210\u529f\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a\u955c\u50cf\u6765\u8fd0\u884c\u5bb9\u5668\u4e86\u3002</p>"},{"location":"docker/dockerfile_usage/#_4","title":"\u6784\u5efa\u4e0a\u4e0b\u6587","text":"<p>\u5982\u679c\u6211\u4eec\u4ed4\u7ec6\u89c2\u5bdf\u7684\u8bdd\u4f1a\u770b\u5230 <code>docker build</code> \u547d\u4ee4\u6700\u540e\u6709\u4e00\u4e2a <code>.</code>\u3002<code>.</code> \u8868\u793a\u5f53\u524d\u76ee\u5f55\uff0c\u800c Dockerfile \u5c31\u5728\u5f53\u524d\u76ee\u5f55\uff0c\u56e0\u6b64\u4e0d\u5c11\u521d\u5b66\u8005\u4ee5\u4e3a\u8fd9\u4e2a\u8def\u5f84\u662f\u5728\u6307\u5b9a Dockerfile \u6240\u5728\u8def\u5f84\uff0c\u8fd9\u4e48\u7406\u89e3\u5176\u5b9e\u662f\u4e0d\u51c6\u786e\u7684\u3002\u5982\u679c\u5bf9\u5e94\u4e0a\u9762\u7684\u547d\u4ee4\u683c\u5f0f\uff0c\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0\uff0c\u8fd9\u662f\u5728\u6307\u5b9a\u4e0a\u4e0b\u6587\u8def\u5f84\u3002\u90a3\u4e48\u4ec0\u4e48\u662f\u4e0a\u4e0b\u6587\u5462\uff1f</p> <p>\u9996\u5148\u6211\u4eec\u8981\u7406\u89e3 <code>docker build</code> \u7684\u5de5\u4f5c\u539f\u7406\u3002Docker \u5728\u8fd0\u884c\u65f6\u5206\u4e3a Docker Daemon \u548c\u5ba2\u6237\u7aef\u5de5\u5177\u3002Docker \u7684\u5f15\u64ce\u63d0\u4f9b\u4e86\u4e00\u7ec4 REST API\uff0c\u88ab\u79f0\u4e3a Docker Remote API\uff0c\u800c\u5982 docker \u547d\u4ee4\u8fd9\u6837\u7684\u5ba2\u6237\u7aef\u5de5\u5177\uff0c\u5219\u662f\u901a\u8fc7\u8fd9\u7ec4 API \u4e0e Docker \u5f15\u64ce\u4ea4\u4e92\uff0c\u4ece\u800c\u5b8c\u6210\u5404\u79cd\u529f\u80fd\u3002\u56e0\u6b64\uff0c\u867d\u7136\u8868\u9762\u4e0a\u6211\u4eec\u597d\u50cf\u662f\u5728\u672c\u673a\u6267\u884c\u5404\u79cd docker \u529f\u80fd\uff0c\u4f46\u5b9e\u9645\u4e0a\uff0c\u4e00\u5207\u90fd\u662f\u4f7f\u7528\u7684\u8fdc\u7a0b\u8c03\u7528\u5f62\u5f0f\u5728\u670d\u52a1\u7aef\uff08Docker \u5f15\u64ce\uff09\u5b8c\u6210\u3002\u4e5f\u56e0\u4e3a\u8fd9\u79cd C/S \u8bbe\u8ba1\uff0c\u8ba9\u6211\u4eec\u64cd\u4f5c\u8fdc\u7a0b\u670d\u52a1\u5668\u7684 Docker \u5f15\u64ce\u53d8\u5f97\u8f7b\u800c\u6613\u4e3e\u3002</p> <p>\u5f53\u6211\u4eec\u8fdb\u884c\u955c\u50cf\u6784\u5efa\u7684\u65f6\u5019\uff0c\u5e76\u975e\u6240\u6709\u5b9a\u5236\u90fd\u4f1a\u901a\u8fc7 RUN \u6307\u4ee4\u5b8c\u6210\uff0c\u7ecf\u5e38\u4f1a\u9700\u8981\u5c06\u4e00\u4e9b\u672c\u5730\u6587\u4ef6\u590d\u5236\u8fdb\u955c\u50cf\uff0c\u6bd4\u5982\u901a\u8fc7 <code>COPY</code> \u6307\u4ee4\u3001<code>ADD</code> \u6307\u4ee4\u7b49\u3002\u800c <code>docker build</code> \u547d\u4ee4\u6784\u5efa\u955c\u50cf\uff0c\u5176\u5b9e\u5e76\u975e\u5728\u672c\u5730\u6784\u5efa\uff0c\u800c\u662f\u5728\u670d\u52a1\u7aef\uff0c\u4e5f\u5c31\u662f Docker \u5f15\u64ce\u4e2d\u6784\u5efa\u7684\u3002\u90a3\u4e48\u5728\u8fd9\u79cd<code>\u5ba2\u6237\u7aef/\u670d\u52a1\u7aef</code>\u7684\u67b6\u6784\u4e2d\uff0c\u5982\u4f55\u624d\u80fd\u8ba9\u670d\u52a1\u7aef\u83b7\u5f97\u672c\u5730\u6587\u4ef6\u5462\uff1f</p> <p>\u8fd9\u5c31\u5f15\u5165\u4e86<code>\u4e0a\u4e0b\u6587</code>\u7684\u6982\u5ff5\u3002\u5f53\u6784\u5efa\u7684\u65f6\u5019\uff0c\u7528\u6237\u4f1a\u6307\u5b9a\u6784\u5efa\u955c\u50cf\u4e0a\u4e0b\u6587\u7684\u8def\u5f84\uff0cdocker build \u547d\u4ee4\u5f97\u77e5\u8fd9\u4e2a\u8def\u5f84\u540e\uff0c\u4f1a\u5c06\u8def\u5f84\u4e0b\u7684\u6240\u6709\u5185\u5bb9\u6253\u5305\uff0c\u7136\u540e\u4e0a\u4f20\u7ed9 Docker \u5f15\u64ce\u3002\u8fd9\u6837 Docker \u5f15\u64ce\u6536\u5230\u8fd9\u4e2a\u4e0a\u4e0b\u6587\u5305\u540e\uff0c\u5c55\u5f00\u5c31\u4f1a\u83b7\u5f97\u6784\u5efa\u955c\u50cf\u6240\u9700\u7684\u4e00\u5207\u6587\u4ef6\u3002\u5982\u679c\u5728 Dockerfile \u4e2d\u8fd9\u4e48\u5199\uff1a</p> <pre><code>COPY ./package.json /app/\n</code></pre> <p>\u8fd9\u5e76\u4e0d\u662f\u8981\u590d\u5236\u6267\u884c docker build \u547d\u4ee4\u6240\u5728\u7684\u76ee\u5f55\u4e0b\u7684 package.json\uff0c\u4e5f\u4e0d\u662f\u590d\u5236 Dockerfile \u6240\u5728\u76ee\u5f55\u4e0b\u7684 package.json\uff0c\u800c\u662f\u590d\u5236 <code>\u4e0a\u4e0b\u6587\uff08context\uff09</code> \u76ee\u5f55\u4e0b\u7684 package.json\u3002</p> <p>\u56e0\u6b64\uff0c<code>COPY</code> \u8fd9\u7c7b\u6307\u4ee4\u4e2d\u7684\u6e90\u6587\u4ef6\u7684\u8def\u5f84\u90fd\u662f<code>\u76f8\u5bf9\u8def\u5f84</code>\u3002\u8fd9\u4e5f\u662f\u521d\u5b66\u8005\u7ecf\u5e38\u4f1a\u95ee\u7684\u4e3a\u4ec0\u4e48 </p> <pre><code>COPY ../package.json /app\n</code></pre> <p>\u6216\u8005 <code>COPY /opt/xxxx /app</code> \u65e0\u6cd5\u5de5\u4f5c\u7684\u539f\u56e0\uff0c\u56e0\u4e3a\u8fd9\u4e9b\u8def\u5f84\u5df2\u7ecf\u8d85\u51fa\u4e86\u4e0a\u4e0b\u6587\u7684\u8303\u56f4\uff0cDocker \u5f15\u64ce\u65e0\u6cd5\u83b7\u5f97\u8fd9\u4e9b\u4f4d\u7f6e\u7684\u6587\u4ef6\u3002\u5982\u679c\u771f\u7684\u9700\u8981\u90a3\u4e9b\u6587\u4ef6\uff0c\u5e94\u8be5\u5c06\u5b83\u4eec\u590d\u5236\u5230\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\u53bb\u3002</p> <p>\u73b0\u5728\u5c31\u53ef\u4ee5\u7406\u89e3\u521a\u624d\u7684\u547d\u4ee4</p> <pre><code>docker build -t nginx:v1 .\n</code></pre> <p>\u4e2d\u7684\u8fd9\u4e2a<code>.</code>\uff0c\u5b9e\u9645\u4e0a\u662f\u5728\u6307\u5b9a\u4e0a\u4e0b\u6587\u7684\u76ee\u5f55\uff0cdocker build \u547d\u4ee4\u4f1a\u5c06\u8be5\u76ee\u5f55\u4e0b\u7684\u5185\u5bb9\u6253\u5305\u4ea4\u7ed9 Docker \u5f15\u64ce\u4ee5\u5e2e\u52a9\u6784\u5efa\u955c\u50cf\u3002</p> <p>\u5982\u679c\u89c2\u5bdf docker build \u8f93\u51fa\uff0c\u6211\u4eec\u5176\u5b9e\u5df2\u7ecf\u770b\u5230\u4e86\u8fd9\u4e2a\u53d1\u9001\u4e0a\u4e0b\u6587\u7684\u8fc7\u7a0b\uff1a</p> <pre><code>$ docker build -t nginx:v1 .\nSending build context to Docker daemon 048 kB\n...\n</code></pre> <p>\u7406\u89e3\u6784\u5efa\u4e0a\u4e0b\u6587\u5bf9\u4e8e\u955c\u50cf\u6784\u5efa\u662f\u5f88\u91cd\u8981\u7684\uff0c\u53ef\u4ee5\u907f\u514d\u72af\u4e00\u4e9b\u4e0d\u5e94\u8be5\u7684\u9519\u8bef\u3002\u6bd4\u5982\u6709\u4e9b\u521d\u5b66\u8005\u5728\u53d1\u73b0 COPY /opt/xxxx /app \u4e0d\u5de5\u4f5c\u540e\uff0c\u4e8e\u662f\u5e72\u8106\u5c06 Dockerfile \u653e\u5230\u4e86\u786c\u76d8\u6839\u76ee\u5f55\u53bb\u6784\u5efa\uff0c\u7ed3\u679c\u53d1\u73b0 docker build \u6267\u884c\u65f6\u53d1\u9001\u4e00\u4e2a\u51e0\u5341 GB \u7684\u4e1c\u897f\uff0c\u6781\u4e3a\u7f13\u6162\u800c\u4e14\u5f88\u5bb9\u6613\u6784\u5efa\u5931\u8d25\u3002\u90a3\u662f\u56e0\u4e3a\u8fd9\u79cd\u505a\u6cd5\u662f\u5728\u8ba9 docker build \u6253\u5305\u6574\u4e2a\u786c\u76d8\uff0c\u8fd9\u663e\u7136\u662f\u4f7f\u7528\u9519\u8bef\u3002</p> <p>\u4e00\u822c\u6765\u8bf4\uff0c\u5e94\u8be5\u4f1a\u5c06 Dockerfile \u7f6e\u4e8e\u4e00\u4e2a\u7a7a\u76ee\u5f55\u4e0b\uff0c\u6216\u8005\u9879\u76ee\u6839\u76ee\u5f55\u4e0b\u3002\u5982\u679c\u8be5\u76ee\u5f55\u4e0b\u6ca1\u6709\u6240\u9700\u6587\u4ef6\uff0c\u90a3\u4e48\u5e94\u8be5\u628a\u6240\u9700\u6587\u4ef6\u590d\u5236\u4e00\u4efd\u8fc7\u6765\u3002\u5982\u679c\u76ee\u5f55\u4e0b\u6709\u4e9b\u4e1c\u897f\u786e\u5b9e\u4e0d\u5e0c\u671b\u6784\u5efa\u65f6\u4f20\u7ed9 Docker \u5f15\u64ce\uff0c\u90a3\u4e48\u53ef\u4ee5\u7528 .gitignore \u4e00\u6837\u7684\u8bed\u6cd5\u5199\u4e00\u4e2a <code>.dockerignore</code>\uff0c\u8be5\u6587\u4ef6\u662f\u7528\u4e8e\u5254\u9664\u4e0d\u9700\u8981\u4f5c\u4e3a\u4e0a\u4e0b\u6587\u4f20\u9012\u7ed9 Docker \u5f15\u64ce\u7684\u3002</p> <p>\u90a3\u4e48\u4e3a\u4ec0\u4e48\u4f1a\u6709\u4eba\u8bef\u4ee5\u4e3a <code>.</code> \u662f\u6307\u5b9a Dockerfile \u6240\u5728\u76ee\u5f55\u5462\uff1f\u8fd9\u662f\u56e0\u4e3a\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u4e0d\u989d\u5916\u6307\u5b9a Dockerfile \u7684\u8bdd\uff0c\u4f1a\u5c06\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e0b\u7684\u540d\u4e3a Dockerfile \u7684\u6587\u4ef6\u4f5c\u4e3a Dockerfile\u3002\u8fd9\u53ea\u662f\u9ed8\u8ba4\u884c\u4e3a\uff0c\u5b9e\u9645\u4e0a Dockerfile \u7684\u6587\u4ef6\u540d\u5e76\u4e0d\u8981\u6c42\u5fc5\u987b\u4e3a Dockerfile\uff0c\u800c\u4e14\u5e76\u4e0d\u8981\u6c42\u5fc5\u987b\u4f4d\u4e8e\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\uff0c\u6bd4\u5982\u53ef\u4ee5\u7528<code>-f ../Dockerfile.Dev</code>\u53c2\u6570\u6307\u5b9a\u67d0\u4e2a\u6587\u4ef6\u4f5c\u4e3a Dockerfile\u3002</p> <p>\u5f53\u7136\uff0c\u4e00\u822c\u5927\u5bb6\u4e60\u60ef\u6027\u7684\u4f1a\u4f7f\u7528\u9ed8\u8ba4\u7684\u6587\u4ef6\u540d Dockerfile\uff0c\u4ee5\u53ca\u4f1a\u5c06\u5176\u7f6e\u4e8e\u955c\u50cf\u6784\u5efa\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\u3002</p>"},{"location":"docker/dockerfile_usage/#_5","title":"\u63a8\u9001\u955c\u50cf","text":"<p>\u4e0a\u9762\u6211\u4eec\u8bb2\u5230\u4e86 Dockerfile \u7684\u57fa\u672c\u5199\u6cd5\u4ee5\u53ca\u6784\u5efa\u955c\u50cf\u7684\u65f6\u5019\u4e00\u4e9b\u6ce8\u610f\u4e8b\u9879\uff0c\u90a3\u4e48\u955c\u50cf\u6784\u5efa\u5b8c\u6210\u540e\uff0c\u5982\u4f55\u628a\u6211\u4eec\u7684\u955c\u50cf\u7ed9\u5230\u522b\u4eba\u4f7f\u7528\u5462\uff1f\u7b2c\u4e00\u79cd\u65b9\u6cd5\u5c31\u662f\u5229\u7528 Docker \u5b98\u65b9\u63d0\u4f9b\u7684\u516c\u5171\u7684 Docker Hub \u4ed3\u5e93\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u955c\u50cf\u63a8\u9001\u4e0a\u53bb\uff0c\u7136\u540e\u522b\u4eba\u5c31\u53ef\u4ee5\u76f4\u63a5\u62c9\u53d6\u955c\u50cf\u3002</p>"},{"location":"docker/dockerfile_usage/#_6","title":"\u6ce8\u518c","text":"<p>\u9996\u5148\u9700\u8981 https://cloud.docker.com \u514d\u8d39\u6ce8\u518c\u4e00\u4e2a Docker \u8d26\u53f7\u3002</p>"},{"location":"docker/dockerfile_usage/#_7","title":"\u767b\u5f55","text":"<p>\u7136\u540e\u901a\u8fc7\u6267\u884c<code>docker login</code>\u547d\u4ee4\u4ea4\u4e92\u5f0f\u7684\u8f93\u5165\u7528\u6237\u540d\u53ca\u5bc6\u7801\u6765\u5b8c\u6210\u5728\u547d\u4ee4\u884c\u754c\u9762\u767b\u5f55 Docker Hub\u3002</p> <pre><code>$ docker login\nLogin with your Docker ID to push and pull images from Docker Hub. If you don't have a Docker ID, head over to https://hub.docker.com to create one.\nUsername: cnych\nPassword:\nWARNING! Your password will be stored unencrypted in /root/.docker/config.json.\nConfigure a credential helper to remove this warning. See\nhttps://docs.docker.com/engine/reference/commandline/login/#credentials-store\n\nLogin Succeeded\n</code></pre>"},{"location":"docker/dockerfile_usage/#_8","title":"\u6ce8\u9500","text":"<p>\u4f60\u53ef\u4ee5\u901a\u8fc7<code>docker logout</code>\u9000\u51fa\u767b\u5f55\u3002</p>"},{"location":"docker/dockerfile_usage/#_9","title":"\u63a8\u9001\u955c\u50cf","text":"<p>\u7528\u6237\u5728\u767b\u5f55\u540e\u53ef\u4ee5\u901a\u8fc7<code>docker push</code>\u547d\u4ee4\u6765\u5c06\u81ea\u5df1\u7684\u955c\u50cf\u63a8\u9001\u5230 Docker Hub\u3002\u4ee5\u4e0b\u547d\u4ee4\u4e2d\u7684 username \u8bf7\u66ff\u6362\u4e3a\u4f60\u7684 Docker \u8d26\u53f7\u7528\u6237\u540d\u3002</p> <pre><code>$ docker tag ubuntu:10 username/ubuntu:10\n$ docker image ls\n\nREPOSITORY                                               TAG                    IMAGE ID            CREATED             SIZE\nubuntu                                                   10                  275d79972a86        6 days ago          6MB\nusername/ubuntu                                          10                  275d79972a86        6 days ago          6MB\n$ docker push username/ubuntu:10\n</code></pre>"},{"location":"docker/dockerfile_usage/#_10","title":"\u79c1\u6709\u4ed3\u5e93","text":"<p>\u6709\u65f6\u5019\u6211\u4eec\u53ef\u80fd\u5e0c\u671b\u6211\u4eec\u7684\u955c\u50cf\u53ea\u5728\u5c40\u57df\u7f51\u8303\u56f4\u5185\u4f7f\u7528\uff0c\u4e0d\u5e0c\u671b\u63a8\u9001\u5230 Docker Hub \u8fd9\u6837\u7684\u516c\u5171\u4ed3\u5e93\uff0c\u90a3\u4e48\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u672c\u5730\u4ed3\u5e93\u4f9b\u79c1\u4eba\u4f7f\u7528\u3002</p> <p><code>docker-registry</code> \u5c31\u662f\u662f\u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e2a\u79c1\u6709\u4ed3\u5e93\u5de5\u5177\uff0c\u53ef\u4ee5\u7528\u4e8e\u5b58\u50a8\u79c1\u6709\u7684\u955c\u50cf\u4ed3\u5e93\u3002\u540c\u6837\u7684\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u83b7\u53d6\u5b98\u65b9 registry \u955c\u50cf\u6765\u76f4\u63a5\u8fd0\u884c\uff1a</p> <pre><code>$ docker run -d -p 5000:5000 --name registry registry:2\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u4f7f\u7528\u5b98\u65b9\u7684 registry \u955c\u50cf\u6765\u542f\u52a8\u79c1\u6709\u4ed3\u5e93\u5bb9\u5668\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4ed3\u5e93\u4f1a\u88ab\u521b\u5efa\u5728\u5bb9\u5668\u7684<code>/var/lib/registry</code>\u76ee\u5f55\u4e0b\u3002\u4f60\u53ef\u4ee5\u901a\u8fc7 <code>-v</code> \u53c2\u6570\u6765\u5c06\u955c\u50cf\u6587\u4ef6\u5b58\u653e\u5728\u672c\u5730\u7684\u6307\u5b9a\u8def\u5f84\u3002\u4f8b\u5982\u4e0b\u9762\u7684\u4f8b\u5b50\u5c06\u4e0a\u4f20\u7684\u955c\u50cf\u653e\u5230\u672c\u5730\u7684 <code>/opt/data/registry</code> \u76ee\u5f55:</p> <pre><code>$ docker run -d \\\\\n    -p 5000:5000 \\\\\n    -v /opt/data/registry:/var/lib/registry \\\\\n    registry:2\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u8fd0\u884c\u4e86\u4e00\u4e2a\u6570\u636e\u6301\u4e45\u5316\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u3002</p> <p>\u521b\u5efa\u597d\u79c1\u6709\u4ed3\u5e93\u4e4b\u540e\uff0c\u7136\u540e\u53ef\u4ee5\u4f7f\u7528<code>docker tag</code>\u6765\u6807\u8bb0\u4e00\u4e2a\u955c\u50cf\uff0c\u7136\u540e\u63a8\u9001\u5b83\u5230\u4ed3\u5e93\u3002\u6bd4\u5982\u79c1\u6709\u4ed3\u5e93\u5730\u5740\u4e3a<code>127.0.0.1:5000</code>\u3002\u5148\u5728\u672c\u673a\u67e5\u770b\u5df2\u6709\u7684\u955c\u50cf\u3002</p> <pre><code>$ docker images\nREPOSITORY                        TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nubuntu                            latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u4f7f\u7528<code>docker tag</code>\u5c06 ubuntu:latest \u8fd9\u4e2a\u955c\u50cf\u6807\u8bb0\u4e3a </p> <pre><code>11:5000/ubuntu:latest\n</code></pre> <p>:</p> <pre><code>$ docker tag ubuntu:latest 11:5000/ubuntu:latest\n$ docker images\nREPOSITORY                        TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nubuntu                            latest              ba5877dc9bec        6 weeks ago         17 MB\n11:5000/ubuntu:latest      latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u7136\u540e\u5c31\u53ef\u4ee5\u4f7f\u7528<code>docker push</code>\u4e0a\u4f20\u6807\u8bb0\u7684\u955c\u50cf:</p> <pre><code>$ docker push 11:5000/ubuntu:latest\nThe push refers to repository [11:5000/ubuntu]\n373a30c24545: Pushed\na9148f5200b0: Pushed\ncdd3de0940ab: Pushedfc56279bbb33: Pushed\nb38367233d37: Pushed\n2aebd096e0e2: Pushed\nlatest: digest: sha256:fe4277621f10b5026266932ddf760f5a756d2facd505a94d2da12f4f52f71f5a size: 1568\n</code></pre> <p>\u6b64\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528 registry \u4ed3\u5e93\u63d0\u4f9b\u7684 API \u6765\u67e5\u770b\u4ed3\u5e93\u4e2d\u7684\u955c\u50cf\uff1a</p> <pre><code>$ curl 11:5000/v2/_catalog\n{\"repositories\":[\"ubuntu\"]}\n</code></pre> <p>\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230 {\"repositories\":[\"ubuntu\"]}\uff0c\u8868\u660e\u955c\u50cf\u5df2\u7ecf\u88ab\u6210\u529f\u4e0a\u4f20\u4e86\u3002</p> <p>\u5148\u5220\u9664\u5df2\u6709\u955c\u50cf\uff0c\u518d\u5c1d\u8bd5\u4ece\u79c1\u6709\u4ed3\u5e93\u4e2d\u4e0b\u8f7d\u8fd9\u4e2a\u955c\u50cf\u3002</p> <pre><code>$ docker image rm 11:5000/ubuntu:latest\n$ docker pull 11:5000/ubuntu:latest\nPulling repository 11:5000/ubuntu:latest\nba5877dc9bec: Download complete\n511136ea3c5a: Download complete\n9bad880da3d2: Download complete\n25f11f5fb0cb: Download complete\nebc34468f71d: Download complete\n2318d26665ef: Download complete\n$ docker image ls\nREPOSITORY                         TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\n11:5000/ubuntu:latest       latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u628a\u955c\u50cf\u4e0a\u4f20\u5230\u4e86\u79c1\u6709\u4ed3\u5e93\u4e2d\u7684\u5b8c\u6574\u8fc7\u7a0b\u3002</p>"},{"location":"docker/dockerfile_usage/#_11","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p>\u5982\u679c\u4f60\u4e0d\u60f3\u4f7f\u7528 <code>127.0.0.1:5000</code> \u4f5c\u4e3a\u4ed3\u5e93\u5730\u5740\uff0c\u6bd4\u5982\u60f3\u8ba9\u672c\u7f51\u6bb5\u7684\u5176\u4ed6\u4e3b\u673a\u4e5f\u80fd\u628a\u955c\u50cf\u63a8\u9001\u5230\u79c1\u6709\u4ed3\u5e93\u3002\u4f60\u5c31\u5f97\u628a\u4f8b\u5982 <code>192.168.199.100:5000</code> \u8fd9\u6837\u7684\u5185\u7f51\u5730\u5740\u4f5c\u4e3a\u79c1\u6709\u4ed3\u5e93\u5730\u5740\uff0c\u8fd9\u65f6\u4f60\u4f1a\u53d1\u73b0\u65e0\u6cd5\u6210\u529f\u63a8\u9001\u955c\u50cf\u3002</p> <p>\u8fd9\u662f\u56e0\u4e3a Docker \u9ed8\u8ba4\u4e0d\u5141\u8bb8\u975e HTTPS \u65b9\u5f0f\u63a8\u9001\u955c\u50cf\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Docker \u7684\u914d\u7f6e\u9009\u9879\u6765\u53d6\u6d88\u8fd9\u4e2a\u9650\u5236\uff0c\u6211\u4eec\u8fd9\u91cc\u662f CentOS 7 \u7cfb\u7edf\uff0c\u540c\u6837\u8fd8\u662f\u7f16\u8f91\u6587\u4ef6</p> <pre><code>/etc/docker/daemon.json\n</code></pre> <p>\uff0c\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>{\n  \"registry-mirror\": [\n    \"https://registry.docker-cn.com\"\n  ],\n  \"insecure-registries\": [\n    \"111100:5000\"\n  ]\n}\n</code></pre> <p>\u5176\u4e2d\u7684<code>insecure-registries</code>\u5c31\u662f\u6211\u4eec\u6dfb\u52a0\u7684\u5185\u5bb9\uff0c\u7136\u540e\u91cd\u542f Docker \u4e4b\u540e\u5c31\u53ef\u4ee5\u5728\u5c40\u57df\u7f51\u5185\u4f7f\u7528\u6211\u4eec\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u4e86\u3002</p> <p>\u9ed8\u8ba4\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u53ef\u4ee5\u6ee1\u8db3\u6211\u4eec\u7684\u5f88\u591a\u9700\u6c42\uff0c\u4f46\u662f\u5f80\u5f80\u5728\u4f01\u4e1a\u4e2d\u4f7f\u7528\u7684\u8bdd\u8fd8\u6709\u5f88\u5b89\u5168\u6027\u65b9\u9762\u7684\u529f\u80fd\u7684\u7f3a\u5931\uff0c\u6bd4\u5982\u6743\u9650\u7ba1\u7406\u4e4b\u7c7b\u7684\uff0c\u8fd9\u5bf9\u4e8e\u4f01\u4e1a\u6765\u8bf4\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u4e0d\u8fc7 registry \u5bf9\u4e8e\u6743\u9650\u7ba1\u7406\u8fd9\u4e00\u5757\u505a\u4e86\u4e00\u4e2a\u5bf9\u5916\u66b4\u9732\u7684\u63a5\u53e3\uff0c\u53ea\u8981\u6211\u4eec\u5b9e\u73b0\u4ed6\u66b4\u9732\u7684\u5b89\u5168\u63a5\u53e3\u5c31\u53ef\u4ee5\u6765\u5b9e\u73b0\u6743\u9650\u7ba1\u7406\u76f8\u5173\u7684\u63a5\u53e3\uff0c\u5176\u4e2d\u6ce8\u660e\u7684\u5f00\u6e90\u955c\u50cf\u7ba1\u7406\u8f6f\u4ef6 Harbor \u5c31\u662f\u8fd9\u7c7b\u5e94\u7528\u7684\u4f7c\u4f7c\u8005\uff0c\u6211\u4eec\u8fd8\u5728\u540e\u9762\u7684\u8bfe\u7a0b\u4e2d\u548c\u5927\u5bb6\u5b66\u4e60 Harbor \u7684\u4e00\u4e2a\u4f7f\u7528\u3002\ue3c9</p>"},{"location":"docker/dockerfile_usage/#dockerfile_1","title":"Dockerfile","text":"<p>\u4f7f\u7528 Dockerfile \u5b9a\u5236\u955c\u50cf</p> <p></p> <p>\u955c\u50cf\u7684\u5b9a\u5236\u5b9e\u9645\u4e0a\u5c31\u662f\u5b9a\u5236\u955c\u50cf\u7684\u6bcf\u4e00\u5c42\u6240\u6dfb\u52a0\u7684\u914d\u7f6e\u3001\u6587\u4ef6\u7b49\u4fe1\u606f\uff0c\u5b9e\u9645\u4e0a\u5f53\u6211\u4eec\u5728\u4e00\u4e2a\u5bb9\u5668\u4e2d\u6dfb\u52a0\u6216\u8005\u4fee\u6539\u4e86\u4e00\u4e9b\u6587\u4ef6\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7<code>docker commit</code>\u547d\u4ee4\u6765\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u955c\u50cf\uff0c\u4f46\u662f\u8fd9\u4e2a\u65b9\u6cd5\u4e0d\u591f\u76f4\u89c2\uff0c\u6ca1\u529e\u6cd5\u8ffd\u6eaf\u6211\u4eec\u955c\u50cf\u91cc\u9762\u5230\u5e95\u6709\u54ea\u4e9b\u5185\u5bb9\uff0c\u6240\u4ee5\u5b9e\u9645\u5b9a\u5236\u955c\u50cf\u7684\u8fc7\u7a0b\u6211\u4eec\u5f88\u5c11\u91c7\u7528\u8fd9\u79cd\u65b9\u5f0f\u3002\u800c\u662f\u4f7f\u7528\u4e00\u4e2a\u540d\u4e3a <code>Dockerfile</code> \u7684\u6587\u672c\u6587\u4ef6\u6765\u8fdb\u884c\u955c\u50cf\u5b9a\u5236\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u955c\u50cf\u7684\u6bcf\u4e00\u5c42\u4fee\u6539\u3001\u5b89\u88c5\u3001\u6784\u5efa\u3001\u64cd\u4f5c\u7684\u547d\u4ee4\u90fd\u5199\u5165\u5230\u8fd9\u4e2a\u6587\u4ef6\u4e2d\uff0c\u4e00\u884c\u5c31\u5bf9\u5e94\u955c\u50cf\u7684\u4e00\u5c42\uff0c\u8fd9\u79cd\u65b9\u6cd5\u663e\u7136\u8981\u66f4\u9ad8\u7ea7\uff0c\u56e0\u4e3a\u6211\u4eec\u6709\u4e00\u4e2a\u6587\u4ef6\u6765\u76f4\u89c2\u53cd\u6620\u6211\u4eec\u7684\u955c\u50cf\u5185\u5bb9\uff0c\u8fd8\u53ef\u4ee5\u4f5c\u4e3a\u7248\u672c\u8bb0\u5f55\u8fdb\u884c\u8ddf\u8e2a\u3002</p>"},{"location":"docker/dockerfile_usage/#_12","title":"\u5b9a\u5236\u955c\u50cf","text":"<p>\u4ee5\u6211\u4eec\u4e4b\u524d\u7684 nginx \u955c\u50cf\u4e3a\u4f8b\uff0c\u6211\u4eec\u73b0\u5728\u6765\u5b9a\u5236\u4e00\u4e2a nginx \u955c\u50cf\uff0c\u8981\u6c42\u9ed8\u8ba4\u7684\u5e94\u7528\u9875\u9762\u8bbf\u95ee\u7684\u5185\u5bb9\u662f <code>Hello Docker</code>\u3002</p> <p>\u9996\u5148\u6211\u4eec\u65b0\u5efa\u4e00\u4e2a\u76ee\u5f55 testnginx\uff0c\u7136\u540e\u5728\u8be5\u76ee\u5f55\u4e0b\u9762\u65b0\u5efa\u4e00\u4e2a\u540d\u4e3a<code>Dockerfile</code>\u7684\u7a7a\u767d\u6587\u672c\u6587\u4ef6\uff1a</p> <pre><code>$ mkdir -p testnginx &amp;&amp; cd testnginx &amp;&amp; touch Dockerfile\n</code></pre> <p>\u7136\u540e\u5411<code>Dockerfile</code>\u6587\u4ef6\u4e2d\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>FROM nginx\nRUN echo 'Hello Docker!' &gt; /user/share/nginx/html/index.html\n</code></pre> <p>\u8fd9\u4e2a\u6587\u4ef6\u5f88\u7b80\u5355\uff0c\u4e00\u5171\u5c31\u4e24\u884c\uff0c\u5176\u4e2d\u5305\u542b\u4e24\u6761\u6307\u4ee4\uff0c<code>FROM</code> \u548c <code>RUN</code>\u3002</p>"},{"location":"docker/dockerfile_usage/#from_1","title":"FROM \u6307\u4ee4","text":"<p>\u5b9a\u5236\u955c\u50cf\uff0c\u90a3\u4e48\u80af\u5b9a\u662f\u4e00\u4e2a\u955c\u50cf\u4e3a\u57fa\u7840\uff0c\u5728\u5176\u57fa\u7840\u4e0a\u8fdb\u884c\u5b9a\u5236\uff0c\u800c <code>FROM</code> \u8fd9\u4e2a\u6307\u4ee4\u5c31\u662f\u6765\u6307\u5b9a\u57fa\u7840\u955c\u50cf\u7684\uff0c\u6240\u4ee5\u5728\u4e00\u4e2a <code>Dockerfile</code> \u6587\u4ef6\u4e2d <code>FROM</code> \u6307\u4ee4\u662f\u5fc5\u5907\u7684\uff0c\u5e76\u4e14\u5fc5\u987b\u662f\u7b2c\u4e00\u6761\u6307\u4ee4\u3002</p> <p>\u5728 Docker Hub \u4e0a\u6709\u975e\u5e38\u591a\u7684\u9ad8\u8d28\u91cf\u7684\u5b98\u65b9\u955c\u50cf\uff0c\u6709\u4e00\u4e9b\u53ef\u4ee5\u76f4\u63a5\u62ff\u6765\u4f7f\u7528\u7684\u670d\u52a1\u7c7b\u7684\u955c\u50cf\uff0c\u5982 nginx\u3001redis\u3001mongo\u3001mysql\u3001httpd\u3001php\u3001tomcat \u7b49\uff1b\u4e5f\u6709\u4e00\u4e9b\u65b9\u4fbf\u5f00\u53d1\u3001\u6784\u5efa\u3001\u8fd0\u884c\u5404\u79cd\u8bed\u8a00\u5e94\u7528\u7684\u955c\u50cf\uff0c\u5982 node\u3001openjdk\u3001python\u3001ruby\u3001golang \u7b49\u3002\u53ef\u4ee5\u5728\u5176\u4e2d\u5bfb\u627e\u4e00\u4e2a\u6700\u7b26\u5408\u6211\u4eec\u6700\u7ec8\u76ee\u6807\u7684\u955c\u50cf\u4e3a\u57fa\u7840\u955c\u50cf\u8fdb\u884c\u5b9a\u5236\u3002</p> <p>\u5982\u679c\u6ca1\u6709\u627e\u5230\u5408\u9002\u7684\u57fa\u7840\u955c\u50cf\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e9b\u66f4\u4e3a\u57fa\u7840\u7684\u64cd\u4f5c\u7cfb\u7edf\u955c\u50cf\uff0c\u6bd4\u5982 ubuntu\u3001debian\u3001centos\u3001alpine \u7b49\uff0c\u8fd9\u4e9b\u57fa\u7840\u955c\u50cf\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u66f4\u5927\u7684\u6269\u5c55\u7a7a\u95f4\uff0c\u5c31\u7c7b\u4f3c\u4e8e\u5e73\u65f6\u6211\u4eec\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e0a\u9762\u90e8\u7f72\u81ea\u5df1\u7684\u670d\u52a1\u4e00\u6837\u7684\u64cd\u4f5c\u3002</p> <p>\u9664\u4e86\u9009\u62e9\u73b0\u6709\u955c\u50cf\u4e3a\u57fa\u7840\u955c\u50cf\u5916\uff0cDocker \u8fd8\u5b58\u5728\u4e00\u4e2a\u7279\u6b8a\u7684\u955c\u50cf\uff0c\u540d\u4e3a <code>scratch</code>\uff0c\u8fd9\u4e2a\u955c\u50cf\u662f\u4e00\u4e2a\u865a\u62df\u7684\u955c\u50cf\uff0c\u5e76\u4e0d\u5b9e\u9645\u5b58\u5728\uff0c\u8868\u793a\u4e00\u4e2a\u7a7a\u767d\u7684\u955c\u50cf\uff1a</p> <p><code>FROM scratch ...</code></p> <p>\u5982\u679c\u4f60\u4ee5 <code>scratch</code> \u4e3a\u57fa\u7840\u955c\u50cf\u7684\u8bdd\uff0c\u610f\u5473\u7740\u4f60\u4e0d\u4ee5\u4efb\u4f55\u955c\u50cf\u4e3a\u57fa\u7840\uff0c\u63a5\u4e0b\u6765\u6240\u5199\u7684\u6307\u4ee4\u5c06\u4f5c\u4e3a\u955c\u50cf\u7b2c\u4e00\u5c42\u5f00\u59cb\u5b58\u5728\u3002\u6709\u7684\u540c\u5b66\u53ef\u80fd\u611f\u89c9\u5f88\u5947\u602a\uff0c\u6ca1\u6709\u4efb\u4f55\u57fa\u7840\u955c\u50cf\uff0c\u6211\u600e\u4e48\u53bb\u6267\u884c\u6211\u7684\u7a0b\u5e8f\u5462\uff0c\u5176\u5b9e\u5bf9\u4e8e Linux \u4e0b\u9759\u6001\u7f16\u8bd1\u7684\u7a0b\u5e8f\u6765\u8bf4\uff0c\u5e76\u4e0d\u9700\u8981\u6709\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u8fd0\u884c\u65f6\u652f\u6301\uff0c\u6240\u9700\u7684\u4e00\u5207\u5e93\u90fd\u5df2\u7ecf\u5728\u53ef\u6267\u884c\u6587\u4ef6\u91cc\u4e86\uff0c\u56e0\u6b64\u76f4\u63a5<code>FROM scratch</code>\u4f1a\u8ba9\u955c\u50cf\u4f53\u79ef\u66f4\u52a0\u5c0f\u5de7\u3002\u4f7f\u7528 Go \u8bed\u8a00 \u5f00\u53d1\u7684\u5e94\u7528\u5f88\u591a\u4f1a\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u6765\u5236\u4f5c\u955c\u50cf\uff0c\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u6709\u5f88\u591a\u89c2\u70b9\u8ba4\u4e3a Go \u662f\u7279\u522b\u9002\u5408\u5bb9\u5668\u5fae\u670d\u52a1\u67b6\u6784\u7684\u8bed\u8a00\u7684\u539f\u56e0\u4e4b\u4e00\u3002</p>"},{"location":"docker/dockerfile_usage/#run_1","title":"RUN \u6307\u4ee4","text":"<p><code>RUN</code> \u6307\u4ee4\u662f\u7528\u6765\u6267\u884c\u547d\u4ee4\u884c\u547d\u4ee4\u7684\u3002\u7531\u4e8e\u547d\u4ee4\u884c\u7684\u5f3a\u5927\u80fd\u529b\uff0c\u6240\u4ee5 <code>RUN</code> \u6307\u4ee4\u662f\u5b9a\u5236\u955c\u50cf\u65f6\u662f\u6700\u5e38\u7528\u7684\u6307\u4ee4\u4e4b\u4e00\u3002\u5176\u683c\u5f0f\u6709\u4e24\u79cd\uff1a</p> <ul> <li> <p>shell \u683c\u5f0f\uff1a<code>RUN &lt;\u547d\u4ee4&gt;</code>\uff0c\u5c31\u50cf\u76f4\u63a5\u5728\u547d\u4ee4\u884c\u4e2d\u8f93\u5165\u7684\u547d\u4ee4\u4e00\u6837\u3002\u521a\u624d\u5199\u7684 Dockerfile \u4e2d\u7684 RUN \u6307\u4ee4\u5c31\u662f\u8fd9\u79cd\u683c\u5f0f\uff1a</p> <pre><code>RUN echo 'Hello, Docker!' &gt; /usr/share/nginx/html/index.html\n</code></pre> </li> <li> <p>exec \u683c\u5f0f\uff1a</p> <pre><code>RUN [\"\u53ef\u6267\u884c\u6587\u4ef6\", \"\u53c2\u65701\", \"\u53c2\u65702\"]\n</code></pre> <p>\uff0c\u8fd9\u66f4\u50cf\u662f\u51fd\u6570\u8c03\u7528\u4e2d\u7684\u683c\u5f0f\u3002\u65e2\u7136 RUN \u5c31\u50cf Shell \u811a\u672c\u4e00\u6837\u53ef\u4ee5\u6267\u884c\u547d\u4ee4\uff0c\u90a3\u4e48\u6211\u4eec\u662f\u5426\u5c31\u53ef\u4ee5\u50cf Shell \u811a\u672c\u4e00\u6837\u628a\u6bcf\u4e2a\u547d\u4ee4\u5bf9\u5e94\u4e00\u4e2a RUN \u5462\uff1f\u6bd4\u5982\u8fd9\u6837\uff1a</p> <pre><code>FROM debian:jessie\nRUN apt-get update\nRUN apt-get install -y gcc libc6-dev make wget\nRUN wget -O redis.tar.gz \"http://download.redis.io/releases/redis-tar.gz\"\nRUN mkdir -p /usr/src/redis\nRUN tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1\nRUN make -C /usr/src/redis\nRUN make -C /usr/src/redis install\n# \u5176\u4ed6\u6307\u4ee4...\n</code></pre> </li> </ul> <p>\u4e4b\u524d\u8bf4\u8fc7\uff0cDockerfile \u4e2d\u6bcf\u4e00\u4e2a\u6307\u4ee4\u90fd\u4f1a\u5efa\u7acb\u4e00\u5c42\uff0cRUN \u4e5f\u4e0d\u4f8b\u5916\u3002\u6bcf\u4e00\u4e2a RUN \u5c31\u4f1a\u65b0\u5efa\u7acb\u4e00\u5c42\uff0c\u5728\u5176\u4e0a\u6267\u884c\u8fd9\u4e9b\u547d\u4ee4\uff0c\u6267\u884c\u7ed3\u675f\u540e\uff0ccommit \u8fd9\u4e00\u5c42\u7684\u4fee\u6539\uff0c\u6784\u6210\u65b0\u7684\u955c\u50cf\u3002</p> <p>\u800c\u4e0a\u9762\u7684\u8fd9\u79cd\u5199\u6cd5\uff0c\u521b\u5efa\u4e86 7 \u5c42\u955c\u50cf\u3002\u8fd9\u662f\u5b8c\u5168\u6ca1\u6709\u5fc5\u8981\u7684\uff0c\u800c\u4e14\u5f88\u591a\u8fd0\u884c\u65f6\u4e0d\u9700\u8981\u7684\u4e1c\u897f\uff0c\u90fd\u88ab\u88c5\u8fdb\u4e86\u955c\u50cf\u91cc\uff0c\u6bd4\u5982\u7f16\u8bd1\u73af\u5883\u3001\u66f4\u65b0\u7684\u8f6f\u4ef6\u5305\u7b49\u7b49\u3002\u7ed3\u679c\u5c31\u662f\u4ea7\u751f\u975e\u5e38\u81c3\u80bf\u3001\u975e\u5e38\u591a\u5c42\u7684\u955c\u50cf\uff0c\u4e0d\u4ec5\u4ec5\u589e\u52a0\u4e86\u6784\u5efa\u90e8\u7f72\u7684\u65f6\u95f4\uff0c\u4e5f\u5f88\u5bb9\u6613\u51fa\u9519\u3002 \u8fd9\u662f\u5f88\u591a\u521d\u5b66 Docker \u7684\u4eba\u5e38\u72af\u7684\u4e00\u4e2a\u9519\u8bef\u3002</p> <p>UnionFS \u5c42\u9650\u5236</p> <p>UnionFS \u5b9e\u9645\u4e0a\u662f\u6709\u6700\u5927\u5c42\u6570\u9650\u5236\u7684\uff0c\u6bd4\u5982 AUFS\uff0c\u66fe\u7ecf\u662f\u6700\u5927\u4e0d\u5f97\u8d85\u8fc7 42 \u5c42\uff0c\u73b0\u5728\u662f\u4e0d\u5f97\u8d85\u8fc7 127 \u5c42\u3002</p> <p>\u4e0a\u9762\u7684 Dockerfile \u6b63\u786e\u7684\u5199\u6cd5\u5e94\u8be5\u662f\u8fd9\u6837\uff1a</p> <pre><code>FROM debian:jessie\nRUN buildDeps='gcc libc6-dev make wget' \\\\\n    &amp;&amp; apt-get update \\\\\n    &amp;&amp; apt-get install -y $buildDeps \\\\\n    &amp;&amp; wget -O redis.tar.gz \"http://download.redis.io/releases/redis-tar.gz\" \\\\\n    &amp;&amp; mkdir -p /usr/src/redis \\\\\n    &amp;&amp; tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1 \\\\\n    &amp;&amp; make -C /usr/src/redis \\\\\n    &amp;&amp; make -C /usr/src/redis install \\\\\n    &amp;&amp; rm -rf /var/lib/apt/lists/* \\\\\n    &amp;&amp; rm redis.tar.gz \\\\\n    &amp;&amp; rm -r /usr/src/redis \\\\\n    &amp;&amp; apt-get purge -y --auto-remove $buildDeps\n# \u5176\u4ed6\u6307\u4ee4...\n</code></pre> <p>\u9996\u5148\uff0c\u4e4b\u524d\u6240\u6709\u7684\u547d\u4ee4\u53ea\u6709\u4e00\u4e2a\u76ee\u7684\uff0c\u5c31\u662f\u7f16\u8bd1\u3001\u5b89\u88c5 redis \u53ef\u6267\u884c\u6587\u4ef6\u3002\u56e0\u6b64\u6ca1\u6709\u5fc5\u8981\u5efa\u7acb\u5f88\u591a\u5c42\uff0c\u8fd9\u53ea\u662f\u4e00\u5c42\u7684\u4e8b\u60c5\u3002\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u6ca1\u6709\u4f7f\u7528\u5f88\u591a\u4e2a RUN \u6307\u4ee4\u6765\u5bf9\u5e94\u4e0d\u540c\u7684\u547d\u4ee4\uff0c\u800c\u662f\u4ec5\u4ec5\u4f7f\u7528\u4e00\u4e2a RUN \u6307\u4ee4\uff0c\u5e76\u4f7f\u7528<code>&amp;&amp;</code>\u5c06\u5404\u4e2a\u6240\u9700\u547d\u4ee4\u4e32\u8054\u8d77\u6765\u3002\u5c06\u4e4b\u524d\u7684 7 \u5c42\uff0c\u7b80\u5316\u4e3a\u4e86 1 \u5c42\u3002\u5728\u64b0\u5199 Dockerfile \u7684\u65f6\u5019\uff0c\u8981\u7ecf\u5e38\u63d0\u9192\u81ea\u5df1\uff0c\u8fd9\u5e76\u4e0d\u662f\u5728\u5199 Shell \u811a\u672c\uff0c\u800c\u662f\u5728\u5b9a\u4e49\u6bcf\u4e00\u5c42\u8be5\u5982\u4f55\u6784\u5efa\u3002</p> <p>\u5e76\u4e14\uff0c\u8fd9\u91cc\u4e3a\u4e86\u683c\u5f0f\u5316\u8fd8\u8fdb\u884c\u4e86\u6362\u884c\u3002Dockerfile \u652f\u6301 Shell \u7c7b\u7684\u884c\u5c3e\u6dfb\u52a0<code>\\</code>\u7684\u547d\u4ee4\u6362\u884c\u65b9\u5f0f\uff0c\u4ee5\u53ca\u884c\u9996<code>#</code>\u8fdb\u884c\u6ce8\u91ca\u7684\u683c\u5f0f\u3002\u826f\u597d\u7684\u683c\u5f0f\uff0c\u6bd4\u5982<code>\u6362\u884c\u3001\u7f29\u8fdb\u3001\u6ce8\u91ca</code>\u7b49\uff0c\u4f1a\u8ba9\u7ef4\u62a4\u3001\u6392\u969c\u66f4\u4e3a\u5bb9\u6613\uff0c\u8fd9\u662f\u4e00\u4e2a\u6bd4\u8f83\u597d\u7684\u4e60\u60ef\u3002</p> <p>\u6b64\u5916\uff0c\u8fd8\u53ef\u4ee5\u770b\u5230\u8fd9\u4e00\u7ec4\u547d\u4ee4\u7684\u6700\u540e\u6dfb\u52a0\u4e86\u6e05\u7406\u5de5\u4f5c\u7684\u547d\u4ee4\uff0c\u5220\u9664\u4e86\u4e3a\u4e86\u7f16\u8bd1\u6784\u5efa\u4e0b\u8f7d\u7684\u8f6f\u4ef6\uff0c\u6e05\u7406\u4e86\u6240\u6709\u4e0b\u8f7d\u3001\u5c55\u5f00\u7684\u6587\u4ef6\uff0c\u5e76\u4e14\u8fd8\u6e05\u7406\u4e86 apt \u7f13\u5b58\u6587\u4ef6\u3002\u8fd9\u662f\u5f88\u91cd\u8981\u7684\u4e00\u6b65\uff0c\u6211\u4eec\u4e4b\u524d\u8bf4\u8fc7\uff0c\u955c\u50cf\u662f\u591a\u5c42\u5b58\u50a8\uff0c\u6bcf\u4e00\u5c42\u7684\u4e1c\u897f\u5e76\u4e0d\u4f1a\u5728\u4e0b\u4e00\u5c42\u88ab\u5220\u9664\uff0c\u4f1a\u4e00\u76f4\u8ddf\u968f\u7740\u955c\u50cf\u3002\u56e0\u6b64\u955c\u50cf\u6784\u5efa\u65f6\uff0c\u4e00\u5b9a\u8981\u786e\u4fdd\u6bcf\u4e00\u5c42\u53ea\u6dfb\u52a0\u771f\u6b63\u9700\u8981\u6dfb\u52a0\u7684\u4e1c\u897f\uff0c\u4efb\u4f55\u65e0\u5173\u7684\u4e1c\u897f\u90fd\u5e94\u8be5\u6e05\u7406\u6389\u3002 \u5f88\u591a\u4eba\u521d\u5b66 Docker \u5236\u4f5c\u51fa\u4e86\u5f88\u81c3\u80bf\u7684\u955c\u50cf\u7684\u539f\u56e0\u4e4b\u4e00\uff0c\u5c31\u662f\u5fd8\u8bb0\u4e86\u6bcf\u4e00\u5c42\u6784\u5efa\u7684\u6700\u540e\u4e00\u5b9a\u8981\u6e05\u7406\u6389\u65e0\u5173\u6587\u4ef6\u3002</p>"},{"location":"docker/dockerfile_usage/#workdir_1","title":"WORKDIR \u6307\u4ee4","text":"<p><code>WORKDIR</code> \u6307\u4ee4\u8bbe\u7f6e Dockerfile \u4e2d\u7684\u4efb\u4f55 RUN\uff0cCMD\uff0cENTRPOINT\uff0cCOPY \u548c ADD \u6307\u4ee4\u7684\u5de5\u4f5c\u76ee\u5f55\u3002\u5982\u679c WORKDIR \u6307\u5b9a\u7684\u76ee\u5f55\u4e0d\u5b58\u5728\uff0c\u5373\u4f7f\u968f\u540e\u7684\u6307\u4ee4\u6ca1\u6709\u7528\u5230\u8fd9\u4e2a\u76ee\u5f55\uff0c\u90fd\u4f1a\u521b\u5efa\u8be5\u76ee\u5f55\u3002</p> <p>\u683c\u5f0f\uff1a </p> <pre><code>WORKDIR /path/to/workdir\n</code></pre> <p>\u4e3a\u4e86\u6e05\u6670\u6027\u548c\u53ef\u9760\u6027\uff0c\u4f60\u5e94\u8be5\u603b\u662f\u5728 WORKDIR \u4e2d\u4f7f\u7528\u7edd\u5bf9\u8def\u5f84\uff0c\u800c\u4e14\u5355\u4e2a Dockerfile \u53ef\u4ee5\u4f7f\u7528\u591a\u6b21WORKDIR\u3002\u53e6\u5916\uff0c\u6211\u4eec\u5e94\u8be5\u4f7f\u7528 WORKDIR \u6765\u66ff\u4ee3\u7c7b\u4f3c\u4e8e </p> <pre><code>RUN cd ... &amp;&amp; do-something\n</code></pre> <p>\u7684\u6307\u4ee4\uff0c\u540e\u8005\u96be\u4ee5\u9605\u8bfb\u3001\u6392\u9519\u548c\u7ef4\u62a4\u3002</p>"},{"location":"docker/dockerfile_usage/#add_copy_1","title":"ADD &amp; COPY \u6307\u4ee4","text":"<p>Dockerfile \u4e2d\u7684 <code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code> \u6307\u4ee4\u90fd\u53ef\u4ee5\u5c06\u4e3b\u673a\u4e0a\u7684\u8d44\u6e90\u590d\u5236\u6216\u52a0\u5165\u5230\u5bb9\u5668\u955c\u50cf\u4e2d\uff0c\u90fd\u662f\u5728\u6784\u5efa\u955c\u50cf\u7684\u8fc7\u7a0b\u4e2d\u5b8c\u6210\u7684\u3002</p> <p><code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code> \u6307\u4ee4\u7684\u552f\u4e00\u533a\u522b\u5728\u4e8e<code>\u662f\u5426\u652f\u6301\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90</code>\u3002<code>COPY</code> \u6307\u4ee4\u53ea\u80fd\u4ece\u6267\u884c<code>docker build</code>\u6240\u5728\u7684\u4e3b\u673a\u4e0a\u8bfb\u53d6\u8d44\u6e90\u5e76\u590d\u5236\u5230\u955c\u50cf\u4e2d\u3002\u800c <code>ADD</code> \u6307\u4ee4\u8fd8\u652f\u6301\u901a\u8fc7 URL \u4ece\u8fdc\u7a0b\u670d\u52a1\u5668\u8bfb\u53d6\u8d44\u6e90\u5e76\u590d\u5236\u5230\u955c\u50cf\u4e2d\u3002</p> <p>\u4e00\u822c\u6765\u8bf4\u6ee1\u8db3\u540c\u7b49\u529f\u80fd\u7684\u60c5\u51b5\u4e0b\uff0c\u63a8\u8350\u4f7f\u7528COPY\u6307\u4ee4\u3002<code>ADD</code> \u6307\u4ee4\u66f4\u64c5\u957f\u8bfb\u53d6\u672c\u5730 tar \u6587\u4ef6\u5e76\u89e3\u538b\u7f29\u3002</p>"},{"location":"docker/dockerfile_usage/#copy_1","title":"COPY \u6307\u4ee4","text":"<p><code>COPY</code> \u6307\u4ee4\u80fd\u591f\u5c06\u6784\u5efa\u547d\u4ee4\u6240\u5728\u7684\u4e3b\u673a\u672c\u5730\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u590d\u5236\u5230\u955c\u50cf\u6587\u4ef6\u7cfb\u7edf\u3002COPY \u6307\u4ee4\u540c\u6837\u4e5f\u652f\u6301 exec \u548c shell \u4e24\u79cd\u683c\u5f0f\uff1a</p> <ul> <li> <p>exec \u683c\u5f0f\u7528\u6cd5\uff1a</p> <pre><code>COPY [\"&lt;src&gt;\",... \"&lt;dest&gt;\"]\n</code></pre> <p>\uff0c\u7279\u522b\u9002\u5408\u8def\u5f84\u4e2d\u5e26\u6709\u7a7a\u683c\u7684\u60c5\u51b5\u3002</p> </li> <li> <p>shell \u683c\u5f0f\u7528\u6cd5\uff1a<code>COPY &lt;src&gt;... &lt;dest&gt;</code></p> </li> </ul>"},{"location":"docker/dockerfile_usage/#add_1","title":"ADD \u6307\u4ee4","text":"<p><code>ADD</code> \u6307\u4ee4\u4e0d\u4ec5\u80fd\u591f\u5c06\u6784\u5efa\u547d\u4ee4\u6240\u5728\u7684\u4e3b\u673a\u672c\u5730\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u800c\u4e14\u80fd\u591f\u5c06\u8fdc\u7a0b URL \u6240\u5bf9\u5e94\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u4f5c\u4e3a\u8d44\u6e90\u590d\u5236\u5230\u955c\u50cf\u6587\u4ef6\u7cfb\u7edf\u3002\u6240\u4ee5\uff0c\u53ef\u4ee5\u8ba4\u4e3a <code>ADD</code> \u662f\u589e\u5f3a\u7248\u7684 <code>COPY</code>\uff0c\u652f\u6301\u5c06\u8fdc\u7a0b URL \u7684\u8d44\u6e90\u52a0\u5165\u5230\u955c\u50cf\u7684\u6587\u4ef6\u7cfb\u7edf\u3002\u540c\u6837\u4e5f\u652f\u6301 exec \u548c shell \u4e24\u79cd\u683c\u5f0f\u7528\u6cd5\uff1a \u00a0 * exec \u683c\u5f0f\u7528\u6cd5\uff1a</p> <pre><code>ADD [\"&lt;src&gt;\",... \"&lt;dest&gt;\"]\n</code></pre> <p>\uff0c\u7279\u522b\u9002\u5408\u8def\u5f84\u4e2d\u5e26\u6709\u7a7a\u683c\u7684\u60c5\u51b5</p> <ul> <li>shell \u683c\u5f0f\u7528\u6cd5\uff1a<code>ADD &lt;src&gt;... &lt;dest&gt;</code></li> </ul> <p>\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90\uff0c\u6bd4\u5982\uff1a</p> <pre><code>ADD http://foo.com/bar.go /tmp/main.go\n</code></pre> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u5bf9\u4e8e\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90\u7684\u60c5\u51b5\uff0c\u7531\u4e8e ADD \u6307\u4ee4\u4e0d\u652f\u6301\u8ba4\u8bc1\uff0c\u5982\u679c\u4ece\u8fdc\u7a0b\u83b7\u53d6\u8d44\u6e90\u9700\u8981\u8ba4\u8bc1\uff0c\u5219\u53ea\u80fd\u4f7f\u7528<code>RUN wget</code> \u6216 <code>RUN curl</code> \u66ff\u4ee3\u4e86\u3002</p> <p>\u6709\u80fd\u529b\u81ea\u52a8\u89e3\u538b\u6587\u4ef6\uff0c\u6bd4\u5982\uff1a</p> <pre><code>ADD /foo.tar.gz /tmp/\n</code></pre> <p>\u4e0a\u8ff0\u6307\u4ee4\u4f1a\u4f7f foo.tar.gz \u538b\u7f29\u6587\u4ef6\u89e3\u538b\u5230\u5bb9\u5668\u7684 /tmp \u76ee\u5f55\u3002</p> <p>\u4e0d\u8fc7\u4e00\u822c\u6765\u8bf4\u867d\u7136 ADD \u6307\u4ee4\u652f\u6301\u4ece\u8fdc\u7a0b\u83b7\u53d6\u8d44\u6e90\uff0c\u4f46\u662f\u5e76\u4e0d\u63a8\u8350\u4f7f\u7528\uff0c\u800c\u662f\u5efa\u8bae\u4f7f\u7528 RUN \u6307\u4ee4\u53bb\u6267\u884c wget \u6216 curl \u547d\u4ee4\u3002</p> <p>\u6bd4\u5982\u524d\u9762\u6211\u4eec\u5b9a\u5236\u7684 nginx \u955c\u50cf\uff0c\u53ef\u4ee5\u6539\u6210\u4e0b\u9762\u7684\u5f62\u5f0f\uff1a</p> <pre><code>$ echo 'Hello Docker!' &gt; index.html\n</code></pre> <p>\u7136\u540e\u4fee\u6539 Dockerfile\uff1a</p> <pre><code>FROM nginx\n# COPY\u6216\u8005ADD\u6307\u4ee4\u90fd\u53ef\u4ee5\nCOPY index.html /user/share/nginx/html/index.html\n</code></pre>"},{"location":"docker/dockerfile_usage/#_13","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p><code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code>\u6307\u4ee4\u7684\u7528\u6cd5\u975e\u5e38\u76f8\u4f3c\uff0c\u5177\u4f53\u6ce8\u610f\u4e8b\u9879\u5982\u4e0b\uff1a</p> <ul> <li>\u6e90\u8def\u5f84\u53ef\u4ee5\u6709\u591a\u4e2a</li> <li>\u6e90\u8def\u5f84\u662f\u76f8\u5bf9\u4e8e\u6267\u884c build \u7684\u76f8\u5bf9\u8def\u5f84</li> <li>\u6e90\u8def\u5f84\u5982\u679c\u662f\u672c\u5730\u8def\u5f84\uff0c\u5fc5\u987b\u662f\u6784\u5efa\u4e0a\u4e0b\u6587\u4e2d\u7684\u8def\u5f84</li> <li>\u6e90\u8def\u5f84\u5982\u679c\u662f\u4e00\u4e2a\u76ee\u5f55\uff0c\u5219\u8be5\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u5185\u5bb9\u90fd\u5c06\u88ab\u52a0\u5165\u5230\u5bb9\u5668\uff0c\u4f46\u662f\u8be5\u76ee\u5f55\u672c\u8eab\u4e0d\u4f1a</li> <li>\u76ee\u6807\u8def\u5f84\u5fc5\u987b\u662f\u7edd\u5bf9\u8def\u5f84\uff0c\u6216\u76f8\u5bf9\u4e8e WORKDIR \u7684\u76f8\u5bf9\u8def\u5f84</li> <li>\u76ee\u6807\u8def\u5f84\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u4f1a\u521b\u5efa\u76f8\u5e94\u7684\u5b8c\u6574\u8def\u5f84</li> <li>\u76ee\u6807\u8def\u5f84\u5982\u679c\u4e0d\u662f\u4e00\u4e2a\u6587\u4ef6\uff0c\u5219\u5fc5\u987b\u4f7f\u7528/\u7ed3\u675f</li> <li>\u8def\u5f84\u4e2d\u53ef\u4ee5\u4f7f\u7528\u901a\u914d\u7b26</li> </ul>"},{"location":"docker/dockerfile_usage/#_14","title":"\u6784\u5efa\u955c\u50cf","text":"<p>\u73b0\u5728\u8ba9\u6211\u4eec\u518d\u56de\u5230\u4e4b\u524d\u5b9a\u5236\u7684 nginx \u955c\u50cf\u7684 Dockerfile \u6765\u3002\u73b0\u5728\u6211\u4eec\u660e\u767d\u4e86\u8fd9\u4e2a Dockerfile \u7684\u5185\u5bb9\uff0c\u90a3\u4e48\u8ba9\u6211\u4eec\u6765\u6784\u5efa\u8fd9\u4e2a\u955c\u50cf\u5427\u3002\u5728 Dockerfile \u6587\u4ef6\u6240\u5728\u76ee\u5f55\u6267\u884c\uff1a</p> <pre><code>$ docker build -t nginx:v1 .\nSending build context to Docker daemon 048 kB\nStep 1 : FROM nginx\n ---&gt; e43d811ce2f4\nStep 2 : RUN echo 'Hello, Docker!' &gt; /usr/share/nginx/html/index.html\n ---&gt; Running in 9cdc27646c7b\n ---&gt; 44aa4490ce2c\nRemoving intermediate container 9cdc27646c7b\nSuccessfully built 44aa4490ce2c\n</code></pre> <p>\u4ece\u547d\u4ee4\u7684\u8f93\u51fa\u7ed3\u679c\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u6e05\u6670\u7684\u770b\u5230\u955c\u50cf\u7684\u6784\u5efa\u8fc7\u7a0b\u3002\u5728 Step 2 \u4e2d\uff0c\u5982\u540c\u6211\u4eec\u4e4b\u524d\u6240\u8bf4\u7684\u90a3\u6837\uff0cRUN \u6307\u4ee4\u542f\u52a8\u4e86\u4e00\u4e2a\u5bb9\u5668 9cdc27646c7b\uff0c\u6267\u884c\u4e86\u6240\u8981\u6c42\u7684\u547d\u4ee4\uff0c\u5e76\u6700\u540e\u63d0\u4ea4\u4e86\u8fd9\u4e00\u5c42 44aa4490ce2c\uff0c\u968f\u540e\u5220\u9664\u4e86\u6240\u7528\u5230\u7684\u8fd9\u4e2a\u5bb9\u5668 9cdc27646c7b\u3002\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u4e86 <code>docker build</code> \u547d\u4ee4\u8fdb\u884c\u955c\u50cf\u6784\u5efa\u3002\u5176\u683c\u5f0f\u4e3a\uff1a</p> <pre><code>$ docker build [\u9009\u9879] &lt;\u4e0a\u4e0b\u6587\u8def\u5f84/URL/-&gt;\n</code></pre> <p>\u5728\u8fd9\u91cc\u6211\u4eec\u901a\u8fc7 <code>-t</code> \u53c2\u6570\u6307\u5b9a\u4e86\u6700\u7ec8\u955c\u50cf\u7684\u540d\u79f0 <code>nginx:v1</code>\uff0c\u6784\u5efa\u6210\u529f\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a\u955c\u50cf\u6765\u8fd0\u884c\u5bb9\u5668\u4e86\u3002</p>"},{"location":"docker/dockerfile_usage/#_15","title":"\u6784\u5efa\u4e0a\u4e0b\u6587","text":"<p>\u5982\u679c\u6211\u4eec\u4ed4\u7ec6\u89c2\u5bdf\u7684\u8bdd\u4f1a\u770b\u5230 <code>docker build</code> \u547d\u4ee4\u6700\u540e\u6709\u4e00\u4e2a <code>.</code>\u3002<code>.</code> \u8868\u793a\u5f53\u524d\u76ee\u5f55\uff0c\u800c Dockerfile \u5c31\u5728\u5f53\u524d\u76ee\u5f55\uff0c\u56e0\u6b64\u4e0d\u5c11\u521d\u5b66\u8005\u4ee5\u4e3a\u8fd9\u4e2a\u8def\u5f84\u662f\u5728\u6307\u5b9a Dockerfile \u6240\u5728\u8def\u5f84\uff0c\u8fd9\u4e48\u7406\u89e3\u5176\u5b9e\u662f\u4e0d\u51c6\u786e\u7684\u3002\u5982\u679c\u5bf9\u5e94\u4e0a\u9762\u7684\u547d\u4ee4\u683c\u5f0f\uff0c\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0\uff0c\u8fd9\u662f\u5728\u6307\u5b9a\u4e0a\u4e0b\u6587\u8def\u5f84\u3002\u90a3\u4e48\u4ec0\u4e48\u662f\u4e0a\u4e0b\u6587\u5462\uff1f</p> <p>\u9996\u5148\u6211\u4eec\u8981\u7406\u89e3 <code>docker build</code> \u7684\u5de5\u4f5c\u539f\u7406\u3002Docker \u5728\u8fd0\u884c\u65f6\u5206\u4e3a Docker Daemon \u548c\u5ba2\u6237\u7aef\u5de5\u5177\u3002Docker \u7684\u5f15\u64ce\u63d0\u4f9b\u4e86\u4e00\u7ec4 REST API\uff0c\u88ab\u79f0\u4e3a Docker Remote API\uff0c\u800c\u5982 docker \u547d\u4ee4\u8fd9\u6837\u7684\u5ba2\u6237\u7aef\u5de5\u5177\uff0c\u5219\u662f\u901a\u8fc7\u8fd9\u7ec4 API \u4e0e Docker \u5f15\u64ce\u4ea4\u4e92\uff0c\u4ece\u800c\u5b8c\u6210\u5404\u79cd\u529f\u80fd\u3002\u56e0\u6b64\uff0c\u867d\u7136\u8868\u9762\u4e0a\u6211\u4eec\u597d\u50cf\u662f\u5728\u672c\u673a\u6267\u884c\u5404\u79cd docker \u529f\u80fd\uff0c\u4f46\u5b9e\u9645\u4e0a\uff0c\u4e00\u5207\u90fd\u662f\u4f7f\u7528\u7684\u8fdc\u7a0b\u8c03\u7528\u5f62\u5f0f\u5728\u670d\u52a1\u7aef\uff08Docker \u5f15\u64ce\uff09\u5b8c\u6210\u3002\u4e5f\u56e0\u4e3a\u8fd9\u79cd C/S \u8bbe\u8ba1\uff0c\u8ba9\u6211\u4eec\u64cd\u4f5c\u8fdc\u7a0b\u670d\u52a1\u5668\u7684 Docker \u5f15\u64ce\u53d8\u5f97\u8f7b\u800c\u6613\u4e3e\u3002</p> <p>\u5f53\u6211\u4eec\u8fdb\u884c\u955c\u50cf\u6784\u5efa\u7684\u65f6\u5019\uff0c\u5e76\u975e\u6240\u6709\u5b9a\u5236\u90fd\u4f1a\u901a\u8fc7 RUN \u6307\u4ee4\u5b8c\u6210\uff0c\u7ecf\u5e38\u4f1a\u9700\u8981\u5c06\u4e00\u4e9b\u672c\u5730\u6587\u4ef6\u590d\u5236\u8fdb\u955c\u50cf\uff0c\u6bd4\u5982\u901a\u8fc7 <code>COPY</code> \u6307\u4ee4\u3001<code>ADD</code> \u6307\u4ee4\u7b49\u3002\u800c <code>docker build</code> \u547d\u4ee4\u6784\u5efa\u955c\u50cf\uff0c\u5176\u5b9e\u5e76\u975e\u5728\u672c\u5730\u6784\u5efa\uff0c\u800c\u662f\u5728\u670d\u52a1\u7aef\uff0c\u4e5f\u5c31\u662f Docker \u5f15\u64ce\u4e2d\u6784\u5efa\u7684\u3002\u90a3\u4e48\u5728\u8fd9\u79cd<code>\u5ba2\u6237\u7aef/\u670d\u52a1\u7aef</code>\u7684\u67b6\u6784\u4e2d\uff0c\u5982\u4f55\u624d\u80fd\u8ba9\u670d\u52a1\u7aef\u83b7\u5f97\u672c\u5730\u6587\u4ef6\u5462\uff1f</p> <p>\u8fd9\u5c31\u5f15\u5165\u4e86<code>\u4e0a\u4e0b\u6587</code>\u7684\u6982\u5ff5\u3002\u5f53\u6784\u5efa\u7684\u65f6\u5019\uff0c\u7528\u6237\u4f1a\u6307\u5b9a\u6784\u5efa\u955c\u50cf\u4e0a\u4e0b\u6587\u7684\u8def\u5f84\uff0cdocker build \u547d\u4ee4\u5f97\u77e5\u8fd9\u4e2a\u8def\u5f84\u540e\uff0c\u4f1a\u5c06\u8def\u5f84\u4e0b\u7684\u6240\u6709\u5185\u5bb9\u6253\u5305\uff0c\u7136\u540e\u4e0a\u4f20\u7ed9 Docker \u5f15\u64ce\u3002\u8fd9\u6837 Docker \u5f15\u64ce\u6536\u5230\u8fd9\u4e2a\u4e0a\u4e0b\u6587\u5305\u540e\uff0c\u5c55\u5f00\u5c31\u4f1a\u83b7\u5f97\u6784\u5efa\u955c\u50cf\u6240\u9700\u7684\u4e00\u5207\u6587\u4ef6\u3002\u5982\u679c\u5728 Dockerfile \u4e2d\u8fd9\u4e48\u5199\uff1a</p> <pre><code>COPY ./package.json /app/\n</code></pre> <p>\u8fd9\u5e76\u4e0d\u662f\u8981\u590d\u5236\u6267\u884c docker build \u547d\u4ee4\u6240\u5728\u7684\u76ee\u5f55\u4e0b\u7684 package.json\uff0c\u4e5f\u4e0d\u662f\u590d\u5236 Dockerfile \u6240\u5728\u76ee\u5f55\u4e0b\u7684 package.json\uff0c\u800c\u662f\u590d\u5236 <code>\u4e0a\u4e0b\u6587\uff08context\uff09</code> \u76ee\u5f55\u4e0b\u7684 package.json\u3002</p> <p>\u56e0\u6b64\uff0c<code>COPY</code> \u8fd9\u7c7b\u6307\u4ee4\u4e2d\u7684\u6e90\u6587\u4ef6\u7684\u8def\u5f84\u90fd\u662f<code>\u76f8\u5bf9\u8def\u5f84</code>\u3002\u8fd9\u4e5f\u662f\u521d\u5b66\u8005\u7ecf\u5e38\u4f1a\u95ee\u7684\u4e3a\u4ec0\u4e48 </p> <pre><code>COPY ../package.json /app\n</code></pre> <p>\u6216\u8005 <code>COPY /opt/xxxx /app</code> \u65e0\u6cd5\u5de5\u4f5c\u7684\u539f\u56e0\uff0c\u56e0\u4e3a\u8fd9\u4e9b\u8def\u5f84\u5df2\u7ecf\u8d85\u51fa\u4e86\u4e0a\u4e0b\u6587\u7684\u8303\u56f4\uff0cDocker \u5f15\u64ce\u65e0\u6cd5\u83b7\u5f97\u8fd9\u4e9b\u4f4d\u7f6e\u7684\u6587\u4ef6\u3002\u5982\u679c\u771f\u7684\u9700\u8981\u90a3\u4e9b\u6587\u4ef6\uff0c\u5e94\u8be5\u5c06\u5b83\u4eec\u590d\u5236\u5230\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\u53bb\u3002</p> <p>\u73b0\u5728\u5c31\u53ef\u4ee5\u7406\u89e3\u521a\u624d\u7684\u547d\u4ee4</p> <pre><code>docker build -t nginx:v1 .\n</code></pre> <p>\u4e2d\u7684\u8fd9\u4e2a<code>.</code>\uff0c\u5b9e\u9645\u4e0a\u662f\u5728\u6307\u5b9a\u4e0a\u4e0b\u6587\u7684\u76ee\u5f55\uff0cdocker build \u547d\u4ee4\u4f1a\u5c06\u8be5\u76ee\u5f55\u4e0b\u7684\u5185\u5bb9\u6253\u5305\u4ea4\u7ed9 Docker \u5f15\u64ce\u4ee5\u5e2e\u52a9\u6784\u5efa\u955c\u50cf\u3002</p> <p>\u5982\u679c\u89c2\u5bdf docker build \u8f93\u51fa\uff0c\u6211\u4eec\u5176\u5b9e\u5df2\u7ecf\u770b\u5230\u4e86\u8fd9\u4e2a\u53d1\u9001\u4e0a\u4e0b\u6587\u7684\u8fc7\u7a0b\uff1a</p> <pre><code>$ docker build -t nginx:v1 .\nSending build context to Docker daemon 048 kB\n...\n</code></pre> <p>\u7406\u89e3\u6784\u5efa\u4e0a\u4e0b\u6587\u5bf9\u4e8e\u955c\u50cf\u6784\u5efa\u662f\u5f88\u91cd\u8981\u7684\uff0c\u53ef\u4ee5\u907f\u514d\u72af\u4e00\u4e9b\u4e0d\u5e94\u8be5\u7684\u9519\u8bef\u3002\u6bd4\u5982\u6709\u4e9b\u521d\u5b66\u8005\u5728\u53d1\u73b0 COPY /opt/xxxx /app \u4e0d\u5de5\u4f5c\u540e\uff0c\u4e8e\u662f\u5e72\u8106\u5c06 Dockerfile \u653e\u5230\u4e86\u786c\u76d8\u6839\u76ee\u5f55\u53bb\u6784\u5efa\uff0c\u7ed3\u679c\u53d1\u73b0 docker build \u6267\u884c\u65f6\u53d1\u9001\u4e00\u4e2a\u51e0\u5341 GB \u7684\u4e1c\u897f\uff0c\u6781\u4e3a\u7f13\u6162\u800c\u4e14\u5f88\u5bb9\u6613\u6784\u5efa\u5931\u8d25\u3002\u90a3\u662f\u56e0\u4e3a\u8fd9\u79cd\u505a\u6cd5\u662f\u5728\u8ba9 docker build \u6253\u5305\u6574\u4e2a\u786c\u76d8\uff0c\u8fd9\u663e\u7136\u662f\u4f7f\u7528\u9519\u8bef\u3002</p> <p>\u4e00\u822c\u6765\u8bf4\uff0c\u5e94\u8be5\u4f1a\u5c06 Dockerfile \u7f6e\u4e8e\u4e00\u4e2a\u7a7a\u76ee\u5f55\u4e0b\uff0c\u6216\u8005\u9879\u76ee\u6839\u76ee\u5f55\u4e0b\u3002\u5982\u679c\u8be5\u76ee\u5f55\u4e0b\u6ca1\u6709\u6240\u9700\u6587\u4ef6\uff0c\u90a3\u4e48\u5e94\u8be5\u628a\u6240\u9700\u6587\u4ef6\u590d\u5236\u4e00\u4efd\u8fc7\u6765\u3002\u5982\u679c\u76ee\u5f55\u4e0b\u6709\u4e9b\u4e1c\u897f\u786e\u5b9e\u4e0d\u5e0c\u671b\u6784\u5efa\u65f6\u4f20\u7ed9 Docker \u5f15\u64ce\uff0c\u90a3\u4e48\u53ef\u4ee5\u7528 .gitignore \u4e00\u6837\u7684\u8bed\u6cd5\u5199\u4e00\u4e2a <code>.dockerignore</code>\uff0c\u8be5\u6587\u4ef6\u662f\u7528\u4e8e\u5254\u9664\u4e0d\u9700\u8981\u4f5c\u4e3a\u4e0a\u4e0b\u6587\u4f20\u9012\u7ed9 Docker \u5f15\u64ce\u7684\u3002</p> <p>\u90a3\u4e48\u4e3a\u4ec0\u4e48\u4f1a\u6709\u4eba\u8bef\u4ee5\u4e3a <code>.</code> \u662f\u6307\u5b9a Dockerfile \u6240\u5728\u76ee\u5f55\u5462\uff1f\u8fd9\u662f\u56e0\u4e3a\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u4e0d\u989d\u5916\u6307\u5b9a Dockerfile \u7684\u8bdd\uff0c\u4f1a\u5c06\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e0b\u7684\u540d\u4e3a Dockerfile \u7684\u6587\u4ef6\u4f5c\u4e3a Dockerfile\u3002\u8fd9\u53ea\u662f\u9ed8\u8ba4\u884c\u4e3a\uff0c\u5b9e\u9645\u4e0a Dockerfile \u7684\u6587\u4ef6\u540d\u5e76\u4e0d\u8981\u6c42\u5fc5\u987b\u4e3a Dockerfile\uff0c\u800c\u4e14\u5e76\u4e0d\u8981\u6c42\u5fc5\u987b\u4f4d\u4e8e\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\uff0c\u6bd4\u5982\u53ef\u4ee5\u7528<code>-f ../Dockerfile.Dev</code>\u53c2\u6570\u6307\u5b9a\u67d0\u4e2a\u6587\u4ef6\u4f5c\u4e3a Dockerfile\u3002</p> <p>\u5f53\u7136\uff0c\u4e00\u822c\u5927\u5bb6\u4e60\u60ef\u6027\u7684\u4f1a\u4f7f\u7528\u9ed8\u8ba4\u7684\u6587\u4ef6\u540d Dockerfile\uff0c\u4ee5\u53ca\u4f1a\u5c06\u5176\u7f6e\u4e8e\u955c\u50cf\u6784\u5efa\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\u3002</p>"},{"location":"docker/dockerfile_usage/#_16","title":"\u63a8\u9001\u955c\u50cf","text":"<p>\u4e0a\u9762\u6211\u4eec\u8bb2\u5230\u4e86 Dockerfile \u7684\u57fa\u672c\u5199\u6cd5\u4ee5\u53ca\u6784\u5efa\u955c\u50cf\u7684\u65f6\u5019\u4e00\u4e9b\u6ce8\u610f\u4e8b\u9879\uff0c\u90a3\u4e48\u955c\u50cf\u6784\u5efa\u5b8c\u6210\u540e\uff0c\u5982\u4f55\u628a\u6211\u4eec\u7684\u955c\u50cf\u7ed9\u5230\u522b\u4eba\u4f7f\u7528\u5462\uff1f\u7b2c\u4e00\u79cd\u65b9\u6cd5\u5c31\u662f\u5229\u7528 Docker \u5b98\u65b9\u63d0\u4f9b\u7684\u516c\u5171\u7684 Docker Hub \u4ed3\u5e93\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u955c\u50cf\u63a8\u9001\u4e0a\u53bb\uff0c\u7136\u540e\u522b\u4eba\u5c31\u53ef\u4ee5\u76f4\u63a5\u62c9\u53d6\u955c\u50cf\u3002</p>"},{"location":"docker/dockerfile_usage/#_17","title":"\u6ce8\u518c","text":"<p>\u9996\u5148\u9700\u8981 https://cloud.docker.com \u514d\u8d39\u6ce8\u518c\u4e00\u4e2a Docker \u8d26\u53f7\u3002</p>"},{"location":"docker/dockerfile_usage/#_18","title":"\u767b\u5f55","text":"<p>\u7136\u540e\u901a\u8fc7\u6267\u884c<code>docker login</code>\u547d\u4ee4\u4ea4\u4e92\u5f0f\u7684\u8f93\u5165\u7528\u6237\u540d\u53ca\u5bc6\u7801\u6765\u5b8c\u6210\u5728\u547d\u4ee4\u884c\u754c\u9762\u767b\u5f55 Docker Hub\u3002</p> <pre><code>$ docker login\nLogin with your Docker ID to push and pull images from Docker Hub. If you don't have a Docker ID, head over to https://hub.docker.com to create one.\nUsername: cnych\nPassword:\nWARNING! Your password will be stored unencrypted in /root/.docker/config.json.\nConfigure a credential helper to remove this warning. See\nhttps://docs.docker.com/engine/reference/commandline/login/#credentials-store\n\nLogin Succeeded\n</code></pre>"},{"location":"docker/dockerfile_usage/#_19","title":"\u6ce8\u9500","text":"<p>\u4f60\u53ef\u4ee5\u901a\u8fc7<code>docker logout</code>\u9000\u51fa\u767b\u5f55\u3002</p>"},{"location":"docker/dockerfile_usage/#_20","title":"\u63a8\u9001\u955c\u50cf","text":"<p>\u7528\u6237\u5728\u767b\u5f55\u540e\u53ef\u4ee5\u901a\u8fc7<code>docker push</code>\u547d\u4ee4\u6765\u5c06\u81ea\u5df1\u7684\u955c\u50cf\u63a8\u9001\u5230 Docker Hub\u3002\u4ee5\u4e0b\u547d\u4ee4\u4e2d\u7684 username \u8bf7\u66ff\u6362\u4e3a\u4f60\u7684 Docker \u8d26\u53f7\u7528\u6237\u540d\u3002</p> <pre><code>$ docker tag ubuntu:10 username/ubuntu:10\n$ docker image ls\n\nREPOSITORY                                               TAG                    IMAGE ID            CREATED             SIZE\nubuntu                                                   10                  275d79972a86        6 days ago          6MB\nusername/ubuntu                                          10                  275d79972a86        6 days ago          6MB\n$ docker push username/ubuntu:10\n</code></pre>"},{"location":"docker/dockerfile_usage/#_21","title":"\u79c1\u6709\u4ed3\u5e93","text":"<p>\u6709\u65f6\u5019\u6211\u4eec\u53ef\u80fd\u5e0c\u671b\u6211\u4eec\u7684\u955c\u50cf\u53ea\u5728\u5c40\u57df\u7f51\u8303\u56f4\u5185\u4f7f\u7528\uff0c\u4e0d\u5e0c\u671b\u63a8\u9001\u5230 Docker Hub \u8fd9\u6837\u7684\u516c\u5171\u4ed3\u5e93\uff0c\u90a3\u4e48\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u672c\u5730\u4ed3\u5e93\u4f9b\u79c1\u4eba\u4f7f\u7528\u3002</p> <p><code>docker-registry</code> \u5c31\u662f\u662f\u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e2a\u79c1\u6709\u4ed3\u5e93\u5de5\u5177\uff0c\u53ef\u4ee5\u7528\u4e8e\u5b58\u50a8\u79c1\u6709\u7684\u955c\u50cf\u4ed3\u5e93\u3002\u540c\u6837\u7684\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u83b7\u53d6\u5b98\u65b9 registry \u955c\u50cf\u6765\u76f4\u63a5\u8fd0\u884c\uff1a</p> <pre><code>$ docker run -d -p 5000:5000 --name registry registry:2\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u4f7f\u7528\u5b98\u65b9\u7684 registry \u955c\u50cf\u6765\u542f\u52a8\u79c1\u6709\u4ed3\u5e93\u5bb9\u5668\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4ed3\u5e93\u4f1a\u88ab\u521b\u5efa\u5728\u5bb9\u5668\u7684<code>/var/lib/registry</code>\u76ee\u5f55\u4e0b\u3002\u4f60\u53ef\u4ee5\u901a\u8fc7 <code>-v</code> \u53c2\u6570\u6765\u5c06\u955c\u50cf\u6587\u4ef6\u5b58\u653e\u5728\u672c\u5730\u7684\u6307\u5b9a\u8def\u5f84\u3002\u4f8b\u5982\u4e0b\u9762\u7684\u4f8b\u5b50\u5c06\u4e0a\u4f20\u7684\u955c\u50cf\u653e\u5230\u672c\u5730\u7684 <code>/opt/data/registry</code> \u76ee\u5f55:</p> <pre><code>$ docker run -d \\\\\n    -p 5000:5000 \\\\\n    -v /opt/data/registry:/var/lib/registry \\\\\n    registry:2\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u8fd0\u884c\u4e86\u4e00\u4e2a\u6570\u636e\u6301\u4e45\u5316\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u3002</p> <p>\u521b\u5efa\u597d\u79c1\u6709\u4ed3\u5e93\u4e4b\u540e\uff0c\u7136\u540e\u53ef\u4ee5\u4f7f\u7528<code>docker tag</code>\u6765\u6807\u8bb0\u4e00\u4e2a\u955c\u50cf\uff0c\u7136\u540e\u63a8\u9001\u5b83\u5230\u4ed3\u5e93\u3002\u6bd4\u5982\u79c1\u6709\u4ed3\u5e93\u5730\u5740\u4e3a<code>127.0.0.1:5000</code>\u3002\u5148\u5728\u672c\u673a\u67e5\u770b\u5df2\u6709\u7684\u955c\u50cf\u3002</p> <pre><code>$ docker images\nREPOSITORY                        TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nubuntu                            latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u4f7f\u7528<code>docker tag</code>\u5c06 ubuntu:latest \u8fd9\u4e2a\u955c\u50cf\u6807\u8bb0\u4e3a </p> <pre><code>11:5000/ubuntu:latest\n</code></pre> <p>:</p> <pre><code>$ docker tag ubuntu:latest 11:5000/ubuntu:latest\n$ docker images\nREPOSITORY                        TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nubuntu                            latest              ba5877dc9bec        6 weeks ago         17 MB\n11:5000/ubuntu:latest      latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u7136\u540e\u5c31\u53ef\u4ee5\u4f7f\u7528<code>docker push</code>\u4e0a\u4f20\u6807\u8bb0\u7684\u955c\u50cf:</p> <pre><code>$ docker push 11:5000/ubuntu:latest\nThe push refers to repository [11:5000/ubuntu]\n373a30c24545: Pushed\na9148f5200b0: Pushed\ncdd3de0940ab: Pushedfc56279bbb33: Pushed\nb38367233d37: Pushed\n2aebd096e0e2: Pushed\nlatest: digest: sha256:fe4277621f10b5026266932ddf760f5a756d2facd505a94d2da12f4f52f71f5a size: 1568\n</code></pre> <p>\u6b64\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528 registry \u4ed3\u5e93\u63d0\u4f9b\u7684 API \u6765\u67e5\u770b\u4ed3\u5e93\u4e2d\u7684\u955c\u50cf\uff1a</p> <pre><code>$ curl 11:5000/v2/_catalog\n{\"repositories\":[\"ubuntu\"]}\n</code></pre> <p>\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230 {\"repositories\":[\"ubuntu\"]}\uff0c\u8868\u660e\u955c\u50cf\u5df2\u7ecf\u88ab\u6210\u529f\u4e0a\u4f20\u4e86\u3002</p> <p>\u5148\u5220\u9664\u5df2\u6709\u955c\u50cf\uff0c\u518d\u5c1d\u8bd5\u4ece\u79c1\u6709\u4ed3\u5e93\u4e2d\u4e0b\u8f7d\u8fd9\u4e2a\u955c\u50cf\u3002</p> <pre><code>$ docker image rm 11:5000/ubuntu:latest\n$ docker pull 11:5000/ubuntu:latest\nPulling repository 11:5000/ubuntu:latest\nba5877dc9bec: Download complete\n511136ea3c5a: Download complete\n9bad880da3d2: Download complete\n25f11f5fb0cb: Download complete\nebc34468f71d: Download complete\n2318d26665ef: Download complete\n$ docker image ls\nREPOSITORY                         TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\n11:5000/ubuntu:latest       latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u628a\u955c\u50cf\u4e0a\u4f20\u5230\u4e86\u79c1\u6709\u4ed3\u5e93\u4e2d\u7684\u5b8c\u6574\u8fc7\u7a0b\u3002</p>"},{"location":"docker/dockerfile_usage/#_22","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p>\u5982\u679c\u4f60\u4e0d\u60f3\u4f7f\u7528 <code>127.0.0.1:5000</code> \u4f5c\u4e3a\u4ed3\u5e93\u5730\u5740\uff0c\u6bd4\u5982\u60f3\u8ba9\u672c\u7f51\u6bb5\u7684\u5176\u4ed6\u4e3b\u673a\u4e5f\u80fd\u628a\u955c\u50cf\u63a8\u9001\u5230\u79c1\u6709\u4ed3\u5e93\u3002\u4f60\u5c31\u5f97\u628a\u4f8b\u5982 <code>192.168.199.100:5000</code> \u8fd9\u6837\u7684\u5185\u7f51\u5730\u5740\u4f5c\u4e3a\u79c1\u6709\u4ed3\u5e93\u5730\u5740\uff0c\u8fd9\u65f6\u4f60\u4f1a\u53d1\u73b0\u65e0\u6cd5\u6210\u529f\u63a8\u9001\u955c\u50cf\u3002</p> <p>\u8fd9\u662f\u56e0\u4e3a Docker \u9ed8\u8ba4\u4e0d\u5141\u8bb8\u975e HTTPS \u65b9\u5f0f\u63a8\u9001\u955c\u50cf\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Docker \u7684\u914d\u7f6e\u9009\u9879\u6765\u53d6\u6d88\u8fd9\u4e2a\u9650\u5236\uff0c\u6211\u4eec\u8fd9\u91cc\u662f CentOS 7 \u7cfb\u7edf\uff0c\u540c\u6837\u8fd8\u662f\u7f16\u8f91\u6587\u4ef6</p> <pre><code>/etc/docker/daemon.json\n</code></pre> <p>\uff0c\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>{\n  \"registry-mirror\": [\n    \"https://registry.docker-cn.com\"\n  ],\n  \"insecure-registries\": [\n    \"111100:5000\"\n  ]\n}\n</code></pre> <p>\u5176\u4e2d\u7684<code>insecure-registries</code>\u5c31\u662f\u6211\u4eec\u6dfb\u52a0\u7684\u5185\u5bb9\uff0c\u7136\u540e\u91cd\u542f Docker \u4e4b\u540e\u5c31\u53ef\u4ee5\u5728\u5c40\u57df\u7f51\u5185\u4f7f\u7528\u6211\u4eec\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u4e86\u3002</p> <p>\u9ed8\u8ba4\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u53ef\u4ee5\u6ee1\u8db3\u6211\u4eec\u7684\u5f88\u591a\u9700\u6c42\uff0c\u4f46\u662f\u5f80\u5f80\u5728\u4f01\u4e1a\u4e2d\u4f7f\u7528\u7684\u8bdd\u8fd8\u6709\u5f88\u5b89\u5168\u6027\u65b9\u9762\u7684\u529f\u80fd\u7684\u7f3a\u5931\uff0c\u6bd4\u5982\u6743\u9650\u7ba1\u7406\u4e4b\u7c7b\u7684\uff0c\u8fd9\u5bf9\u4e8e\u4f01\u4e1a\u6765\u8bf4\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u4e0d\u8fc7 registry \u5bf9\u4e8e\u6743\u9650\u7ba1\u7406\u8fd9\u4e00\u5757\u505a\u4e86\u4e00\u4e2a\u5bf9\u5916\u66b4\u9732\u7684\u63a5\u53e3\uff0c\u53ea\u8981\u6211\u4eec\u5b9e\u73b0\u4ed6\u66b4\u9732\u7684\u5b89\u5168\u63a5\u53e3\u5c31\u53ef\u4ee5\u6765\u5b9e\u73b0\u6743\u9650\u7ba1\u7406\u76f8\u5173\u7684\u63a5\u53e3\uff0c\u5176\u4e2d\u6ce8\u660e\u7684\u5f00\u6e90\u955c\u50cf\u7ba1\u7406\u8f6f\u4ef6 Harbor \u5c31\u662f\u8fd9\u7c7b\u5e94\u7528\u7684\u4f7c\u4f7c\u8005\uff0c\u6211\u4eec\u8fd8\u5728\u540e\u9762\u7684\u8bfe\u7a0b\u4e2d\u548c\u5927\u5bb6\u5b66\u4e60 Harbor \u7684\u4e00\u4e2a\u4f7f\u7528\u3002\ue3c9</p>"},{"location":"docker/dockerfile_usage/#dockerfile_2","title":"Dockerfile","text":"<p>\u4f7f\u7528 Dockerfile \u5b9a\u5236\u955c\u50cf</p> <p></p> <p>\u955c\u50cf\u7684\u5b9a\u5236\u5b9e\u9645\u4e0a\u5c31\u662f\u5b9a\u5236\u955c\u50cf\u7684\u6bcf\u4e00\u5c42\u6240\u6dfb\u52a0\u7684\u914d\u7f6e\u3001\u6587\u4ef6\u7b49\u4fe1\u606f\uff0c\u5b9e\u9645\u4e0a\u5f53\u6211\u4eec\u5728\u4e00\u4e2a\u5bb9\u5668\u4e2d\u6dfb\u52a0\u6216\u8005\u4fee\u6539\u4e86\u4e00\u4e9b\u6587\u4ef6\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7<code>docker commit</code>\u547d\u4ee4\u6765\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u955c\u50cf\uff0c\u4f46\u662f\u8fd9\u4e2a\u65b9\u6cd5\u4e0d\u591f\u76f4\u89c2\uff0c\u6ca1\u529e\u6cd5\u8ffd\u6eaf\u6211\u4eec\u955c\u50cf\u91cc\u9762\u5230\u5e95\u6709\u54ea\u4e9b\u5185\u5bb9\uff0c\u6240\u4ee5\u5b9e\u9645\u5b9a\u5236\u955c\u50cf\u7684\u8fc7\u7a0b\u6211\u4eec\u5f88\u5c11\u91c7\u7528\u8fd9\u79cd\u65b9\u5f0f\u3002\u800c\u662f\u4f7f\u7528\u4e00\u4e2a\u540d\u4e3a <code>Dockerfile</code> \u7684\u6587\u672c\u6587\u4ef6\u6765\u8fdb\u884c\u955c\u50cf\u5b9a\u5236\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u955c\u50cf\u7684\u6bcf\u4e00\u5c42\u4fee\u6539\u3001\u5b89\u88c5\u3001\u6784\u5efa\u3001\u64cd\u4f5c\u7684\u547d\u4ee4\u90fd\u5199\u5165\u5230\u8fd9\u4e2a\u6587\u4ef6\u4e2d\uff0c\u4e00\u884c\u5c31\u5bf9\u5e94\u955c\u50cf\u7684\u4e00\u5c42\uff0c\u8fd9\u79cd\u65b9\u6cd5\u663e\u7136\u8981\u66f4\u9ad8\u7ea7\uff0c\u56e0\u4e3a\u6211\u4eec\u6709\u4e00\u4e2a\u6587\u4ef6\u6765\u76f4\u89c2\u53cd\u6620\u6211\u4eec\u7684\u955c\u50cf\u5185\u5bb9\uff0c\u8fd8\u53ef\u4ee5\u4f5c\u4e3a\u7248\u672c\u8bb0\u5f55\u8fdb\u884c\u8ddf\u8e2a\u3002</p>"},{"location":"docker/dockerfile_usage/#_23","title":"\u5b9a\u5236\u955c\u50cf","text":"<p>\u4ee5\u6211\u4eec\u4e4b\u524d\u7684 nginx \u955c\u50cf\u4e3a\u4f8b\uff0c\u6211\u4eec\u73b0\u5728\u6765\u5b9a\u5236\u4e00\u4e2a nginx \u955c\u50cf\uff0c\u8981\u6c42\u9ed8\u8ba4\u7684\u5e94\u7528\u9875\u9762\u8bbf\u95ee\u7684\u5185\u5bb9\u662f <code>Hello Docker</code>\u3002</p> <p>\u9996\u5148\u6211\u4eec\u65b0\u5efa\u4e00\u4e2a\u76ee\u5f55 testnginx\uff0c\u7136\u540e\u5728\u8be5\u76ee\u5f55\u4e0b\u9762\u65b0\u5efa\u4e00\u4e2a\u540d\u4e3a<code>Dockerfile</code>\u7684\u7a7a\u767d\u6587\u672c\u6587\u4ef6\uff1a</p> <pre><code>$ mkdir -p testnginx &amp;&amp; cd testnginx &amp;&amp; touch Dockerfile\n</code></pre> <p>\u7136\u540e\u5411<code>Dockerfile</code>\u6587\u4ef6\u4e2d\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>FROM nginx\nRUN echo 'Hello Docker!' &gt; /user/share/nginx/html/index.html\n</code></pre> <p>\u8fd9\u4e2a\u6587\u4ef6\u5f88\u7b80\u5355\uff0c\u4e00\u5171\u5c31\u4e24\u884c\uff0c\u5176\u4e2d\u5305\u542b\u4e24\u6761\u6307\u4ee4\uff0c<code>FROM</code> \u548c <code>RUN</code>\u3002</p>"},{"location":"docker/dockerfile_usage/#from_2","title":"FROM \u6307\u4ee4","text":"<p>\u5b9a\u5236\u955c\u50cf\uff0c\u90a3\u4e48\u80af\u5b9a\u662f\u4e00\u4e2a\u955c\u50cf\u4e3a\u57fa\u7840\uff0c\u5728\u5176\u57fa\u7840\u4e0a\u8fdb\u884c\u5b9a\u5236\uff0c\u800c <code>FROM</code> \u8fd9\u4e2a\u6307\u4ee4\u5c31\u662f\u6765\u6307\u5b9a\u57fa\u7840\u955c\u50cf\u7684\uff0c\u6240\u4ee5\u5728\u4e00\u4e2a <code>Dockerfile</code> \u6587\u4ef6\u4e2d <code>FROM</code> \u6307\u4ee4\u662f\u5fc5\u5907\u7684\uff0c\u5e76\u4e14\u5fc5\u987b\u662f\u7b2c\u4e00\u6761\u6307\u4ee4\u3002</p> <p>\u5728 Docker Hub \u4e0a\u6709\u975e\u5e38\u591a\u7684\u9ad8\u8d28\u91cf\u7684\u5b98\u65b9\u955c\u50cf\uff0c\u6709\u4e00\u4e9b\u53ef\u4ee5\u76f4\u63a5\u62ff\u6765\u4f7f\u7528\u7684\u670d\u52a1\u7c7b\u7684\u955c\u50cf\uff0c\u5982 nginx\u3001redis\u3001mongo\u3001mysql\u3001httpd\u3001php\u3001tomcat \u7b49\uff1b\u4e5f\u6709\u4e00\u4e9b\u65b9\u4fbf\u5f00\u53d1\u3001\u6784\u5efa\u3001\u8fd0\u884c\u5404\u79cd\u8bed\u8a00\u5e94\u7528\u7684\u955c\u50cf\uff0c\u5982 node\u3001openjdk\u3001python\u3001ruby\u3001golang \u7b49\u3002\u53ef\u4ee5\u5728\u5176\u4e2d\u5bfb\u627e\u4e00\u4e2a\u6700\u7b26\u5408\u6211\u4eec\u6700\u7ec8\u76ee\u6807\u7684\u955c\u50cf\u4e3a\u57fa\u7840\u955c\u50cf\u8fdb\u884c\u5b9a\u5236\u3002</p> <p>\u5982\u679c\u6ca1\u6709\u627e\u5230\u5408\u9002\u7684\u57fa\u7840\u955c\u50cf\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e9b\u66f4\u4e3a\u57fa\u7840\u7684\u64cd\u4f5c\u7cfb\u7edf\u955c\u50cf\uff0c\u6bd4\u5982 ubuntu\u3001debian\u3001centos\u3001alpine \u7b49\uff0c\u8fd9\u4e9b\u57fa\u7840\u955c\u50cf\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u66f4\u5927\u7684\u6269\u5c55\u7a7a\u95f4\uff0c\u5c31\u7c7b\u4f3c\u4e8e\u5e73\u65f6\u6211\u4eec\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e0a\u9762\u90e8\u7f72\u81ea\u5df1\u7684\u670d\u52a1\u4e00\u6837\u7684\u64cd\u4f5c\u3002</p> <p>\u9664\u4e86\u9009\u62e9\u73b0\u6709\u955c\u50cf\u4e3a\u57fa\u7840\u955c\u50cf\u5916\uff0cDocker \u8fd8\u5b58\u5728\u4e00\u4e2a\u7279\u6b8a\u7684\u955c\u50cf\uff0c\u540d\u4e3a <code>scratch</code>\uff0c\u8fd9\u4e2a\u955c\u50cf\u662f\u4e00\u4e2a\u865a\u62df\u7684\u955c\u50cf\uff0c\u5e76\u4e0d\u5b9e\u9645\u5b58\u5728\uff0c\u8868\u793a\u4e00\u4e2a\u7a7a\u767d\u7684\u955c\u50cf\uff1a</p> <p><code>FROM scratch ...</code></p> <p>\u5982\u679c\u4f60\u4ee5 <code>scratch</code> \u4e3a\u57fa\u7840\u955c\u50cf\u7684\u8bdd\uff0c\u610f\u5473\u7740\u4f60\u4e0d\u4ee5\u4efb\u4f55\u955c\u50cf\u4e3a\u57fa\u7840\uff0c\u63a5\u4e0b\u6765\u6240\u5199\u7684\u6307\u4ee4\u5c06\u4f5c\u4e3a\u955c\u50cf\u7b2c\u4e00\u5c42\u5f00\u59cb\u5b58\u5728\u3002\u6709\u7684\u540c\u5b66\u53ef\u80fd\u611f\u89c9\u5f88\u5947\u602a\uff0c\u6ca1\u6709\u4efb\u4f55\u57fa\u7840\u955c\u50cf\uff0c\u6211\u600e\u4e48\u53bb\u6267\u884c\u6211\u7684\u7a0b\u5e8f\u5462\uff0c\u5176\u5b9e\u5bf9\u4e8e Linux \u4e0b\u9759\u6001\u7f16\u8bd1\u7684\u7a0b\u5e8f\u6765\u8bf4\uff0c\u5e76\u4e0d\u9700\u8981\u6709\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u8fd0\u884c\u65f6\u652f\u6301\uff0c\u6240\u9700\u7684\u4e00\u5207\u5e93\u90fd\u5df2\u7ecf\u5728\u53ef\u6267\u884c\u6587\u4ef6\u91cc\u4e86\uff0c\u56e0\u6b64\u76f4\u63a5<code>FROM scratch</code>\u4f1a\u8ba9\u955c\u50cf\u4f53\u79ef\u66f4\u52a0\u5c0f\u5de7\u3002\u4f7f\u7528 Go \u8bed\u8a00 \u5f00\u53d1\u7684\u5e94\u7528\u5f88\u591a\u4f1a\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u6765\u5236\u4f5c\u955c\u50cf\uff0c\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u6709\u5f88\u591a\u89c2\u70b9\u8ba4\u4e3a Go \u662f\u7279\u522b\u9002\u5408\u5bb9\u5668\u5fae\u670d\u52a1\u67b6\u6784\u7684\u8bed\u8a00\u7684\u539f\u56e0\u4e4b\u4e00\u3002</p>"},{"location":"docker/dockerfile_usage/#run_2","title":"RUN \u6307\u4ee4","text":"<p><code>RUN</code> \u6307\u4ee4\u662f\u7528\u6765\u6267\u884c\u547d\u4ee4\u884c\u547d\u4ee4\u7684\u3002\u7531\u4e8e\u547d\u4ee4\u884c\u7684\u5f3a\u5927\u80fd\u529b\uff0c\u6240\u4ee5 <code>RUN</code> \u6307\u4ee4\u662f\u5b9a\u5236\u955c\u50cf\u65f6\u662f\u6700\u5e38\u7528\u7684\u6307\u4ee4\u4e4b\u4e00\u3002\u5176\u683c\u5f0f\u6709\u4e24\u79cd\uff1a</p> <ul> <li> <p>shell \u683c\u5f0f\uff1a<code>RUN &lt;\u547d\u4ee4&gt;</code>\uff0c\u5c31\u50cf\u76f4\u63a5\u5728\u547d\u4ee4\u884c\u4e2d\u8f93\u5165\u7684\u547d\u4ee4\u4e00\u6837\u3002\u521a\u624d\u5199\u7684 Dockerfile \u4e2d\u7684 RUN \u6307\u4ee4\u5c31\u662f\u8fd9\u79cd\u683c\u5f0f\uff1a</p> <pre><code>RUN echo 'Hello, Docker!' &gt; /usr/share/nginx/html/index.html\n</code></pre> </li> <li> <p>exec \u683c\u5f0f\uff1a</p> <pre><code>RUN [\"\u53ef\u6267\u884c\u6587\u4ef6\", \"\u53c2\u65701\", \"\u53c2\u65702\"]\n</code></pre> <p>\uff0c\u8fd9\u66f4\u50cf\u662f\u51fd\u6570\u8c03\u7528\u4e2d\u7684\u683c\u5f0f\u3002\u65e2\u7136 RUN \u5c31\u50cf Shell \u811a\u672c\u4e00\u6837\u53ef\u4ee5\u6267\u884c\u547d\u4ee4\uff0c\u90a3\u4e48\u6211\u4eec\u662f\u5426\u5c31\u53ef\u4ee5\u50cf Shell \u811a\u672c\u4e00\u6837\u628a\u6bcf\u4e2a\u547d\u4ee4\u5bf9\u5e94\u4e00\u4e2a RUN \u5462\uff1f\u6bd4\u5982\u8fd9\u6837\uff1a</p> <pre><code>FROM debian:jessie\nRUN apt-get update\nRUN apt-get install -y gcc libc6-dev make wget\nRUN wget -O redis.tar.gz \"http://download.redis.io/releases/redis-tar.gz\"\nRUN mkdir -p /usr/src/redis\nRUN tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1\nRUN make -C /usr/src/redis\nRUN make -C /usr/src/redis install\n# \u5176\u4ed6\u6307\u4ee4...\n</code></pre> </li> </ul> <p>\u4e4b\u524d\u8bf4\u8fc7\uff0cDockerfile \u4e2d\u6bcf\u4e00\u4e2a\u6307\u4ee4\u90fd\u4f1a\u5efa\u7acb\u4e00\u5c42\uff0cRUN \u4e5f\u4e0d\u4f8b\u5916\u3002\u6bcf\u4e00\u4e2a RUN \u5c31\u4f1a\u65b0\u5efa\u7acb\u4e00\u5c42\uff0c\u5728\u5176\u4e0a\u6267\u884c\u8fd9\u4e9b\u547d\u4ee4\uff0c\u6267\u884c\u7ed3\u675f\u540e\uff0ccommit \u8fd9\u4e00\u5c42\u7684\u4fee\u6539\uff0c\u6784\u6210\u65b0\u7684\u955c\u50cf\u3002</p> <p>\u800c\u4e0a\u9762\u7684\u8fd9\u79cd\u5199\u6cd5\uff0c\u521b\u5efa\u4e86 7 \u5c42\u955c\u50cf\u3002\u8fd9\u662f\u5b8c\u5168\u6ca1\u6709\u5fc5\u8981\u7684\uff0c\u800c\u4e14\u5f88\u591a\u8fd0\u884c\u65f6\u4e0d\u9700\u8981\u7684\u4e1c\u897f\uff0c\u90fd\u88ab\u88c5\u8fdb\u4e86\u955c\u50cf\u91cc\uff0c\u6bd4\u5982\u7f16\u8bd1\u73af\u5883\u3001\u66f4\u65b0\u7684\u8f6f\u4ef6\u5305\u7b49\u7b49\u3002\u7ed3\u679c\u5c31\u662f\u4ea7\u751f\u975e\u5e38\u81c3\u80bf\u3001\u975e\u5e38\u591a\u5c42\u7684\u955c\u50cf\uff0c\u4e0d\u4ec5\u4ec5\u589e\u52a0\u4e86\u6784\u5efa\u90e8\u7f72\u7684\u65f6\u95f4\uff0c\u4e5f\u5f88\u5bb9\u6613\u51fa\u9519\u3002 \u8fd9\u662f\u5f88\u591a\u521d\u5b66 Docker \u7684\u4eba\u5e38\u72af\u7684\u4e00\u4e2a\u9519\u8bef\u3002</p> <p>UnionFS \u5c42\u9650\u5236</p> <p>UnionFS \u5b9e\u9645\u4e0a\u662f\u6709\u6700\u5927\u5c42\u6570\u9650\u5236\u7684\uff0c\u6bd4\u5982 AUFS\uff0c\u66fe\u7ecf\u662f\u6700\u5927\u4e0d\u5f97\u8d85\u8fc7 42 \u5c42\uff0c\u73b0\u5728\u662f\u4e0d\u5f97\u8d85\u8fc7 127 \u5c42\u3002</p> <p>\u4e0a\u9762\u7684 Dockerfile \u6b63\u786e\u7684\u5199\u6cd5\u5e94\u8be5\u662f\u8fd9\u6837\uff1a</p> <pre><code>FROM debian:jessie\nRUN buildDeps='gcc libc6-dev make wget' \\\\\n    &amp;&amp; apt-get update \\\\\n    &amp;&amp; apt-get install -y $buildDeps \\\\\n    &amp;&amp; wget -O redis.tar.gz \"http://download.redis.io/releases/redis-tar.gz\" \\\\\n    &amp;&amp; mkdir -p /usr/src/redis \\\\\n    &amp;&amp; tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1 \\\\\n    &amp;&amp; make -C /usr/src/redis \\\\\n    &amp;&amp; make -C /usr/src/redis install \\\\\n    &amp;&amp; rm -rf /var/lib/apt/lists/* \\\\\n    &amp;&amp; rm redis.tar.gz \\\\\n    &amp;&amp; rm -r /usr/src/redis \\\\\n    &amp;&amp; apt-get purge -y --auto-remove $buildDeps\n# \u5176\u4ed6\u6307\u4ee4...\n</code></pre> <p>\u9996\u5148\uff0c\u4e4b\u524d\u6240\u6709\u7684\u547d\u4ee4\u53ea\u6709\u4e00\u4e2a\u76ee\u7684\uff0c\u5c31\u662f\u7f16\u8bd1\u3001\u5b89\u88c5 redis \u53ef\u6267\u884c\u6587\u4ef6\u3002\u56e0\u6b64\u6ca1\u6709\u5fc5\u8981\u5efa\u7acb\u5f88\u591a\u5c42\uff0c\u8fd9\u53ea\u662f\u4e00\u5c42\u7684\u4e8b\u60c5\u3002\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u6ca1\u6709\u4f7f\u7528\u5f88\u591a\u4e2a RUN \u6307\u4ee4\u6765\u5bf9\u5e94\u4e0d\u540c\u7684\u547d\u4ee4\uff0c\u800c\u662f\u4ec5\u4ec5\u4f7f\u7528\u4e00\u4e2a RUN \u6307\u4ee4\uff0c\u5e76\u4f7f\u7528<code>&amp;&amp;</code>\u5c06\u5404\u4e2a\u6240\u9700\u547d\u4ee4\u4e32\u8054\u8d77\u6765\u3002\u5c06\u4e4b\u524d\u7684 7 \u5c42\uff0c\u7b80\u5316\u4e3a\u4e86 1 \u5c42\u3002\u5728\u64b0\u5199 Dockerfile \u7684\u65f6\u5019\uff0c\u8981\u7ecf\u5e38\u63d0\u9192\u81ea\u5df1\uff0c\u8fd9\u5e76\u4e0d\u662f\u5728\u5199 Shell \u811a\u672c\uff0c\u800c\u662f\u5728\u5b9a\u4e49\u6bcf\u4e00\u5c42\u8be5\u5982\u4f55\u6784\u5efa\u3002</p> <p>\u5e76\u4e14\uff0c\u8fd9\u91cc\u4e3a\u4e86\u683c\u5f0f\u5316\u8fd8\u8fdb\u884c\u4e86\u6362\u884c\u3002Dockerfile \u652f\u6301 Shell \u7c7b\u7684\u884c\u5c3e\u6dfb\u52a0<code>\\</code>\u7684\u547d\u4ee4\u6362\u884c\u65b9\u5f0f\uff0c\u4ee5\u53ca\u884c\u9996<code>#</code>\u8fdb\u884c\u6ce8\u91ca\u7684\u683c\u5f0f\u3002\u826f\u597d\u7684\u683c\u5f0f\uff0c\u6bd4\u5982<code>\u6362\u884c\u3001\u7f29\u8fdb\u3001\u6ce8\u91ca</code>\u7b49\uff0c\u4f1a\u8ba9\u7ef4\u62a4\u3001\u6392\u969c\u66f4\u4e3a\u5bb9\u6613\uff0c\u8fd9\u662f\u4e00\u4e2a\u6bd4\u8f83\u597d\u7684\u4e60\u60ef\u3002</p> <p>\u6b64\u5916\uff0c\u8fd8\u53ef\u4ee5\u770b\u5230\u8fd9\u4e00\u7ec4\u547d\u4ee4\u7684\u6700\u540e\u6dfb\u52a0\u4e86\u6e05\u7406\u5de5\u4f5c\u7684\u547d\u4ee4\uff0c\u5220\u9664\u4e86\u4e3a\u4e86\u7f16\u8bd1\u6784\u5efa\u4e0b\u8f7d\u7684\u8f6f\u4ef6\uff0c\u6e05\u7406\u4e86\u6240\u6709\u4e0b\u8f7d\u3001\u5c55\u5f00\u7684\u6587\u4ef6\uff0c\u5e76\u4e14\u8fd8\u6e05\u7406\u4e86 apt \u7f13\u5b58\u6587\u4ef6\u3002\u8fd9\u662f\u5f88\u91cd\u8981\u7684\u4e00\u6b65\uff0c\u6211\u4eec\u4e4b\u524d\u8bf4\u8fc7\uff0c\u955c\u50cf\u662f\u591a\u5c42\u5b58\u50a8\uff0c\u6bcf\u4e00\u5c42\u7684\u4e1c\u897f\u5e76\u4e0d\u4f1a\u5728\u4e0b\u4e00\u5c42\u88ab\u5220\u9664\uff0c\u4f1a\u4e00\u76f4\u8ddf\u968f\u7740\u955c\u50cf\u3002\u56e0\u6b64\u955c\u50cf\u6784\u5efa\u65f6\uff0c\u4e00\u5b9a\u8981\u786e\u4fdd\u6bcf\u4e00\u5c42\u53ea\u6dfb\u52a0\u771f\u6b63\u9700\u8981\u6dfb\u52a0\u7684\u4e1c\u897f\uff0c\u4efb\u4f55\u65e0\u5173\u7684\u4e1c\u897f\u90fd\u5e94\u8be5\u6e05\u7406\u6389\u3002 \u5f88\u591a\u4eba\u521d\u5b66 Docker \u5236\u4f5c\u51fa\u4e86\u5f88\u81c3\u80bf\u7684\u955c\u50cf\u7684\u539f\u56e0\u4e4b\u4e00\uff0c\u5c31\u662f\u5fd8\u8bb0\u4e86\u6bcf\u4e00\u5c42\u6784\u5efa\u7684\u6700\u540e\u4e00\u5b9a\u8981\u6e05\u7406\u6389\u65e0\u5173\u6587\u4ef6\u3002</p>"},{"location":"docker/dockerfile_usage/#workdir_2","title":"WORKDIR \u6307\u4ee4","text":"<p><code>WORKDIR</code> \u6307\u4ee4\u8bbe\u7f6e Dockerfile \u4e2d\u7684\u4efb\u4f55 RUN\uff0cCMD\uff0cENTRPOINT\uff0cCOPY \u548c ADD \u6307\u4ee4\u7684\u5de5\u4f5c\u76ee\u5f55\u3002\u5982\u679c WORKDIR \u6307\u5b9a\u7684\u76ee\u5f55\u4e0d\u5b58\u5728\uff0c\u5373\u4f7f\u968f\u540e\u7684\u6307\u4ee4\u6ca1\u6709\u7528\u5230\u8fd9\u4e2a\u76ee\u5f55\uff0c\u90fd\u4f1a\u521b\u5efa\u8be5\u76ee\u5f55\u3002</p> <p>\u683c\u5f0f\uff1a </p> <pre><code>WORKDIR /path/to/workdir\n</code></pre> <p>\u4e3a\u4e86\u6e05\u6670\u6027\u548c\u53ef\u9760\u6027\uff0c\u4f60\u5e94\u8be5\u603b\u662f\u5728 WORKDIR \u4e2d\u4f7f\u7528\u7edd\u5bf9\u8def\u5f84\uff0c\u800c\u4e14\u5355\u4e2a Dockerfile \u53ef\u4ee5\u4f7f\u7528\u591a\u6b21WORKDIR\u3002\u53e6\u5916\uff0c\u6211\u4eec\u5e94\u8be5\u4f7f\u7528 WORKDIR \u6765\u66ff\u4ee3\u7c7b\u4f3c\u4e8e </p> <pre><code>RUN cd ... &amp;&amp; do-something\n</code></pre> <p>\u7684\u6307\u4ee4\uff0c\u540e\u8005\u96be\u4ee5\u9605\u8bfb\u3001\u6392\u9519\u548c\u7ef4\u62a4\u3002</p>"},{"location":"docker/dockerfile_usage/#add_copy_2","title":"ADD &amp; COPY \u6307\u4ee4","text":"<p>Dockerfile \u4e2d\u7684 <code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code> \u6307\u4ee4\u90fd\u53ef\u4ee5\u5c06\u4e3b\u673a\u4e0a\u7684\u8d44\u6e90\u590d\u5236\u6216\u52a0\u5165\u5230\u5bb9\u5668\u955c\u50cf\u4e2d\uff0c\u90fd\u662f\u5728\u6784\u5efa\u955c\u50cf\u7684\u8fc7\u7a0b\u4e2d\u5b8c\u6210\u7684\u3002</p> <p><code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code> \u6307\u4ee4\u7684\u552f\u4e00\u533a\u522b\u5728\u4e8e<code>\u662f\u5426\u652f\u6301\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90</code>\u3002<code>COPY</code> \u6307\u4ee4\u53ea\u80fd\u4ece\u6267\u884c<code>docker build</code>\u6240\u5728\u7684\u4e3b\u673a\u4e0a\u8bfb\u53d6\u8d44\u6e90\u5e76\u590d\u5236\u5230\u955c\u50cf\u4e2d\u3002\u800c <code>ADD</code> \u6307\u4ee4\u8fd8\u652f\u6301\u901a\u8fc7 URL \u4ece\u8fdc\u7a0b\u670d\u52a1\u5668\u8bfb\u53d6\u8d44\u6e90\u5e76\u590d\u5236\u5230\u955c\u50cf\u4e2d\u3002</p> <p>\u4e00\u822c\u6765\u8bf4\u6ee1\u8db3\u540c\u7b49\u529f\u80fd\u7684\u60c5\u51b5\u4e0b\uff0c\u63a8\u8350\u4f7f\u7528COPY\u6307\u4ee4\u3002<code>ADD</code> \u6307\u4ee4\u66f4\u64c5\u957f\u8bfb\u53d6\u672c\u5730 tar \u6587\u4ef6\u5e76\u89e3\u538b\u7f29\u3002</p>"},{"location":"docker/dockerfile_usage/#copy_2","title":"COPY \u6307\u4ee4","text":"<p><code>COPY</code> \u6307\u4ee4\u80fd\u591f\u5c06\u6784\u5efa\u547d\u4ee4\u6240\u5728\u7684\u4e3b\u673a\u672c\u5730\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u590d\u5236\u5230\u955c\u50cf\u6587\u4ef6\u7cfb\u7edf\u3002COPY \u6307\u4ee4\u540c\u6837\u4e5f\u652f\u6301 exec \u548c shell \u4e24\u79cd\u683c\u5f0f\uff1a</p> <ul> <li> <p>exec \u683c\u5f0f\u7528\u6cd5\uff1a</p> <pre><code>COPY [\"&lt;src&gt;\",... \"&lt;dest&gt;\"]\n</code></pre> <p>\uff0c\u7279\u522b\u9002\u5408\u8def\u5f84\u4e2d\u5e26\u6709\u7a7a\u683c\u7684\u60c5\u51b5\u3002</p> </li> <li> <p>shell \u683c\u5f0f\u7528\u6cd5\uff1a<code>COPY &lt;src&gt;... &lt;dest&gt;</code></p> </li> </ul>"},{"location":"docker/dockerfile_usage/#add_2","title":"ADD \u6307\u4ee4","text":"<p><code>ADD</code> \u6307\u4ee4\u4e0d\u4ec5\u80fd\u591f\u5c06\u6784\u5efa\u547d\u4ee4\u6240\u5728\u7684\u4e3b\u673a\u672c\u5730\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u800c\u4e14\u80fd\u591f\u5c06\u8fdc\u7a0b URL \u6240\u5bf9\u5e94\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u4f5c\u4e3a\u8d44\u6e90\u590d\u5236\u5230\u955c\u50cf\u6587\u4ef6\u7cfb\u7edf\u3002\u6240\u4ee5\uff0c\u53ef\u4ee5\u8ba4\u4e3a <code>ADD</code> \u662f\u589e\u5f3a\u7248\u7684 <code>COPY</code>\uff0c\u652f\u6301\u5c06\u8fdc\u7a0b URL \u7684\u8d44\u6e90\u52a0\u5165\u5230\u955c\u50cf\u7684\u6587\u4ef6\u7cfb\u7edf\u3002\u540c\u6837\u4e5f\u652f\u6301 exec \u548c shell \u4e24\u79cd\u683c\u5f0f\u7528\u6cd5\uff1a \u00a0 * exec \u683c\u5f0f\u7528\u6cd5\uff1a</p> <pre><code>ADD [\"&lt;src&gt;\",... \"&lt;dest&gt;\"]\n</code></pre> <p>\uff0c\u7279\u522b\u9002\u5408\u8def\u5f84\u4e2d\u5e26\u6709\u7a7a\u683c\u7684\u60c5\u51b5</p> <ul> <li>shell \u683c\u5f0f\u7528\u6cd5\uff1a<code>ADD &lt;src&gt;... &lt;dest&gt;</code></li> </ul> <p>\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90\uff0c\u6bd4\u5982\uff1a</p> <pre><code>ADD http://foo.com/bar.go /tmp/main.go\n</code></pre> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u5bf9\u4e8e\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90\u7684\u60c5\u51b5\uff0c\u7531\u4e8e ADD \u6307\u4ee4\u4e0d\u652f\u6301\u8ba4\u8bc1\uff0c\u5982\u679c\u4ece\u8fdc\u7a0b\u83b7\u53d6\u8d44\u6e90\u9700\u8981\u8ba4\u8bc1\uff0c\u5219\u53ea\u80fd\u4f7f\u7528<code>RUN wget</code> \u6216 <code>RUN curl</code> \u66ff\u4ee3\u4e86\u3002</p> <p>\u6709\u80fd\u529b\u81ea\u52a8\u89e3\u538b\u6587\u4ef6\uff0c\u6bd4\u5982\uff1a</p> <pre><code>ADD /foo.tar.gz /tmp/\n</code></pre> <p>\u4e0a\u8ff0\u6307\u4ee4\u4f1a\u4f7f foo.tar.gz \u538b\u7f29\u6587\u4ef6\u89e3\u538b\u5230\u5bb9\u5668\u7684 /tmp \u76ee\u5f55\u3002</p> <p>\u4e0d\u8fc7\u4e00\u822c\u6765\u8bf4\u867d\u7136 ADD \u6307\u4ee4\u652f\u6301\u4ece\u8fdc\u7a0b\u83b7\u53d6\u8d44\u6e90\uff0c\u4f46\u662f\u5e76\u4e0d\u63a8\u8350\u4f7f\u7528\uff0c\u800c\u662f\u5efa\u8bae\u4f7f\u7528 RUN \u6307\u4ee4\u53bb\u6267\u884c wget \u6216 curl \u547d\u4ee4\u3002</p> <p>\u6bd4\u5982\u524d\u9762\u6211\u4eec\u5b9a\u5236\u7684 nginx \u955c\u50cf\uff0c\u53ef\u4ee5\u6539\u6210\u4e0b\u9762\u7684\u5f62\u5f0f\uff1a</p> <pre><code>$ echo 'Hello Docker!' &gt; index.html\n</code></pre> <p>\u7136\u540e\u4fee\u6539 Dockerfile\uff1a</p> <pre><code>FROM nginx\n# COPY\u6216\u8005ADD\u6307\u4ee4\u90fd\u53ef\u4ee5\nCOPY index.html /user/share/nginx/html/index.html\n</code></pre>"},{"location":"docker/dockerfile_usage/#_24","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p><code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code>\u6307\u4ee4\u7684\u7528\u6cd5\u975e\u5e38\u76f8\u4f3c\uff0c\u5177\u4f53\u6ce8\u610f\u4e8b\u9879\u5982\u4e0b\uff1a</p> <ul> <li>\u6e90\u8def\u5f84\u53ef\u4ee5\u6709\u591a\u4e2a</li> <li>\u6e90\u8def\u5f84\u662f\u76f8\u5bf9\u4e8e\u6267\u884c build \u7684\u76f8\u5bf9\u8def\u5f84</li> <li>\u6e90\u8def\u5f84\u5982\u679c\u662f\u672c\u5730\u8def\u5f84\uff0c\u5fc5\u987b\u662f\u6784\u5efa\u4e0a\u4e0b\u6587\u4e2d\u7684\u8def\u5f84</li> <li>\u6e90\u8def\u5f84\u5982\u679c\u662f\u4e00\u4e2a\u76ee\u5f55\uff0c\u5219\u8be5\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u5185\u5bb9\u90fd\u5c06\u88ab\u52a0\u5165\u5230\u5bb9\u5668\uff0c\u4f46\u662f\u8be5\u76ee\u5f55\u672c\u8eab\u4e0d\u4f1a</li> <li>\u76ee\u6807\u8def\u5f84\u5fc5\u987b\u662f\u7edd\u5bf9\u8def\u5f84\uff0c\u6216\u76f8\u5bf9\u4e8e WORKDIR \u7684\u76f8\u5bf9\u8def\u5f84</li> <li>\u76ee\u6807\u8def\u5f84\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u4f1a\u521b\u5efa\u76f8\u5e94\u7684\u5b8c\u6574\u8def\u5f84</li> <li>\u76ee\u6807\u8def\u5f84\u5982\u679c\u4e0d\u662f\u4e00\u4e2a\u6587\u4ef6\uff0c\u5219\u5fc5\u987b\u4f7f\u7528/\u7ed3\u675f</li> <li>\u8def\u5f84\u4e2d\u53ef\u4ee5\u4f7f\u7528\u901a\u914d\u7b26</li> </ul>"},{"location":"docker/dockerfile_usage/#_25","title":"\u6784\u5efa\u955c\u50cf","text":"<p>\u73b0\u5728\u8ba9\u6211\u4eec\u518d\u56de\u5230\u4e4b\u524d\u5b9a\u5236\u7684 nginx \u955c\u50cf\u7684 Dockerfile \u6765\u3002\u73b0\u5728\u6211\u4eec\u660e\u767d\u4e86\u8fd9\u4e2a Dockerfile \u7684\u5185\u5bb9\uff0c\u90a3\u4e48\u8ba9\u6211\u4eec\u6765\u6784\u5efa\u8fd9\u4e2a\u955c\u50cf\u5427\u3002\u5728 Dockerfile \u6587\u4ef6\u6240\u5728\u76ee\u5f55\u6267\u884c\uff1a</p> <pre><code>$ docker build -t nginx:v1 .\nSending build context to Docker daemon 048 kB\nStep 1 : FROM nginx\n ---&gt; e43d811ce2f4\nStep 2 : RUN echo 'Hello, Docker!' &gt; /usr/share/nginx/html/index.html\n ---&gt; Running in 9cdc27646c7b\n ---&gt; 44aa4490ce2c\nRemoving intermediate container 9cdc27646c7b\nSuccessfully built 44aa4490ce2c\n</code></pre> <p>\u4ece\u547d\u4ee4\u7684\u8f93\u51fa\u7ed3\u679c\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u6e05\u6670\u7684\u770b\u5230\u955c\u50cf\u7684\u6784\u5efa\u8fc7\u7a0b\u3002\u5728 Step 2 \u4e2d\uff0c\u5982\u540c\u6211\u4eec\u4e4b\u524d\u6240\u8bf4\u7684\u90a3\u6837\uff0cRUN \u6307\u4ee4\u542f\u52a8\u4e86\u4e00\u4e2a\u5bb9\u5668 9cdc27646c7b\uff0c\u6267\u884c\u4e86\u6240\u8981\u6c42\u7684\u547d\u4ee4\uff0c\u5e76\u6700\u540e\u63d0\u4ea4\u4e86\u8fd9\u4e00\u5c42 44aa4490ce2c\uff0c\u968f\u540e\u5220\u9664\u4e86\u6240\u7528\u5230\u7684\u8fd9\u4e2a\u5bb9\u5668 9cdc27646c7b\u3002\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u4e86 <code>docker build</code> \u547d\u4ee4\u8fdb\u884c\u955c\u50cf\u6784\u5efa\u3002\u5176\u683c\u5f0f\u4e3a\uff1a</p> <pre><code>$ docker build [\u9009\u9879] &lt;\u4e0a\u4e0b\u6587\u8def\u5f84/URL/-&gt;\n</code></pre> <p>\u5728\u8fd9\u91cc\u6211\u4eec\u901a\u8fc7 <code>-t</code> \u53c2\u6570\u6307\u5b9a\u4e86\u6700\u7ec8\u955c\u50cf\u7684\u540d\u79f0 <code>nginx:v1</code>\uff0c\u6784\u5efa\u6210\u529f\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a\u955c\u50cf\u6765\u8fd0\u884c\u5bb9\u5668\u4e86\u3002</p>"},{"location":"docker/dockerfile_usage/#_26","title":"\u6784\u5efa\u4e0a\u4e0b\u6587","text":"<p>\u5982\u679c\u6211\u4eec\u4ed4\u7ec6\u89c2\u5bdf\u7684\u8bdd\u4f1a\u770b\u5230 <code>docker build</code> \u547d\u4ee4\u6700\u540e\u6709\u4e00\u4e2a <code>.</code>\u3002<code>.</code> \u8868\u793a\u5f53\u524d\u76ee\u5f55\uff0c\u800c Dockerfile \u5c31\u5728\u5f53\u524d\u76ee\u5f55\uff0c\u56e0\u6b64\u4e0d\u5c11\u521d\u5b66\u8005\u4ee5\u4e3a\u8fd9\u4e2a\u8def\u5f84\u662f\u5728\u6307\u5b9a Dockerfile \u6240\u5728\u8def\u5f84\uff0c\u8fd9\u4e48\u7406\u89e3\u5176\u5b9e\u662f\u4e0d\u51c6\u786e\u7684\u3002\u5982\u679c\u5bf9\u5e94\u4e0a\u9762\u7684\u547d\u4ee4\u683c\u5f0f\uff0c\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0\uff0c\u8fd9\u662f\u5728\u6307\u5b9a\u4e0a\u4e0b\u6587\u8def\u5f84\u3002\u90a3\u4e48\u4ec0\u4e48\u662f\u4e0a\u4e0b\u6587\u5462\uff1f</p> <p>\u9996\u5148\u6211\u4eec\u8981\u7406\u89e3 <code>docker build</code> \u7684\u5de5\u4f5c\u539f\u7406\u3002Docker \u5728\u8fd0\u884c\u65f6\u5206\u4e3a Docker Daemon \u548c\u5ba2\u6237\u7aef\u5de5\u5177\u3002Docker \u7684\u5f15\u64ce\u63d0\u4f9b\u4e86\u4e00\u7ec4 REST API\uff0c\u88ab\u79f0\u4e3a Docker Remote API\uff0c\u800c\u5982 docker \u547d\u4ee4\u8fd9\u6837\u7684\u5ba2\u6237\u7aef\u5de5\u5177\uff0c\u5219\u662f\u901a\u8fc7\u8fd9\u7ec4 API \u4e0e Docker \u5f15\u64ce\u4ea4\u4e92\uff0c\u4ece\u800c\u5b8c\u6210\u5404\u79cd\u529f\u80fd\u3002\u56e0\u6b64\uff0c\u867d\u7136\u8868\u9762\u4e0a\u6211\u4eec\u597d\u50cf\u662f\u5728\u672c\u673a\u6267\u884c\u5404\u79cd docker \u529f\u80fd\uff0c\u4f46\u5b9e\u9645\u4e0a\uff0c\u4e00\u5207\u90fd\u662f\u4f7f\u7528\u7684\u8fdc\u7a0b\u8c03\u7528\u5f62\u5f0f\u5728\u670d\u52a1\u7aef\uff08Docker \u5f15\u64ce\uff09\u5b8c\u6210\u3002\u4e5f\u56e0\u4e3a\u8fd9\u79cd C/S \u8bbe\u8ba1\uff0c\u8ba9\u6211\u4eec\u64cd\u4f5c\u8fdc\u7a0b\u670d\u52a1\u5668\u7684 Docker \u5f15\u64ce\u53d8\u5f97\u8f7b\u800c\u6613\u4e3e\u3002</p> <p>\u5f53\u6211\u4eec\u8fdb\u884c\u955c\u50cf\u6784\u5efa\u7684\u65f6\u5019\uff0c\u5e76\u975e\u6240\u6709\u5b9a\u5236\u90fd\u4f1a\u901a\u8fc7 RUN \u6307\u4ee4\u5b8c\u6210\uff0c\u7ecf\u5e38\u4f1a\u9700\u8981\u5c06\u4e00\u4e9b\u672c\u5730\u6587\u4ef6\u590d\u5236\u8fdb\u955c\u50cf\uff0c\u6bd4\u5982\u901a\u8fc7 <code>COPY</code> \u6307\u4ee4\u3001<code>ADD</code> \u6307\u4ee4\u7b49\u3002\u800c <code>docker build</code> \u547d\u4ee4\u6784\u5efa\u955c\u50cf\uff0c\u5176\u5b9e\u5e76\u975e\u5728\u672c\u5730\u6784\u5efa\uff0c\u800c\u662f\u5728\u670d\u52a1\u7aef\uff0c\u4e5f\u5c31\u662f Docker \u5f15\u64ce\u4e2d\u6784\u5efa\u7684\u3002\u90a3\u4e48\u5728\u8fd9\u79cd<code>\u5ba2\u6237\u7aef/\u670d\u52a1\u7aef</code>\u7684\u67b6\u6784\u4e2d\uff0c\u5982\u4f55\u624d\u80fd\u8ba9\u670d\u52a1\u7aef\u83b7\u5f97\u672c\u5730\u6587\u4ef6\u5462\uff1f</p> <p>\u8fd9\u5c31\u5f15\u5165\u4e86<code>\u4e0a\u4e0b\u6587</code>\u7684\u6982\u5ff5\u3002\u5f53\u6784\u5efa\u7684\u65f6\u5019\uff0c\u7528\u6237\u4f1a\u6307\u5b9a\u6784\u5efa\u955c\u50cf\u4e0a\u4e0b\u6587\u7684\u8def\u5f84\uff0cdocker build \u547d\u4ee4\u5f97\u77e5\u8fd9\u4e2a\u8def\u5f84\u540e\uff0c\u4f1a\u5c06\u8def\u5f84\u4e0b\u7684\u6240\u6709\u5185\u5bb9\u6253\u5305\uff0c\u7136\u540e\u4e0a\u4f20\u7ed9 Docker \u5f15\u64ce\u3002\u8fd9\u6837 Docker \u5f15\u64ce\u6536\u5230\u8fd9\u4e2a\u4e0a\u4e0b\u6587\u5305\u540e\uff0c\u5c55\u5f00\u5c31\u4f1a\u83b7\u5f97\u6784\u5efa\u955c\u50cf\u6240\u9700\u7684\u4e00\u5207\u6587\u4ef6\u3002\u5982\u679c\u5728 Dockerfile \u4e2d\u8fd9\u4e48\u5199\uff1a</p> <pre><code>COPY ./package.json /app/\n</code></pre> <p>\u8fd9\u5e76\u4e0d\u662f\u8981\u590d\u5236\u6267\u884c docker build \u547d\u4ee4\u6240\u5728\u7684\u76ee\u5f55\u4e0b\u7684 package.json\uff0c\u4e5f\u4e0d\u662f\u590d\u5236 Dockerfile \u6240\u5728\u76ee\u5f55\u4e0b\u7684 package.json\uff0c\u800c\u662f\u590d\u5236 <code>\u4e0a\u4e0b\u6587\uff08context\uff09</code> \u76ee\u5f55\u4e0b\u7684 package.json\u3002</p> <p>\u56e0\u6b64\uff0c<code>COPY</code> \u8fd9\u7c7b\u6307\u4ee4\u4e2d\u7684\u6e90\u6587\u4ef6\u7684\u8def\u5f84\u90fd\u662f<code>\u76f8\u5bf9\u8def\u5f84</code>\u3002\u8fd9\u4e5f\u662f\u521d\u5b66\u8005\u7ecf\u5e38\u4f1a\u95ee\u7684\u4e3a\u4ec0\u4e48 </p> <pre><code>COPY ../package.json /app\n</code></pre> <p>\u6216\u8005 <code>COPY /opt/xxxx /app</code> \u65e0\u6cd5\u5de5\u4f5c\u7684\u539f\u56e0\uff0c\u56e0\u4e3a\u8fd9\u4e9b\u8def\u5f84\u5df2\u7ecf\u8d85\u51fa\u4e86\u4e0a\u4e0b\u6587\u7684\u8303\u56f4\uff0cDocker \u5f15\u64ce\u65e0\u6cd5\u83b7\u5f97\u8fd9\u4e9b\u4f4d\u7f6e\u7684\u6587\u4ef6\u3002\u5982\u679c\u771f\u7684\u9700\u8981\u90a3\u4e9b\u6587\u4ef6\uff0c\u5e94\u8be5\u5c06\u5b83\u4eec\u590d\u5236\u5230\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\u53bb\u3002</p> <p>\u73b0\u5728\u5c31\u53ef\u4ee5\u7406\u89e3\u521a\u624d\u7684\u547d\u4ee4</p> <pre><code>docker build -t nginx:v1 .\n</code></pre> <p>\u4e2d\u7684\u8fd9\u4e2a<code>.</code>\uff0c\u5b9e\u9645\u4e0a\u662f\u5728\u6307\u5b9a\u4e0a\u4e0b\u6587\u7684\u76ee\u5f55\uff0cdocker build \u547d\u4ee4\u4f1a\u5c06\u8be5\u76ee\u5f55\u4e0b\u7684\u5185\u5bb9\u6253\u5305\u4ea4\u7ed9 Docker \u5f15\u64ce\u4ee5\u5e2e\u52a9\u6784\u5efa\u955c\u50cf\u3002</p> <p>\u5982\u679c\u89c2\u5bdf docker build \u8f93\u51fa\uff0c\u6211\u4eec\u5176\u5b9e\u5df2\u7ecf\u770b\u5230\u4e86\u8fd9\u4e2a\u53d1\u9001\u4e0a\u4e0b\u6587\u7684\u8fc7\u7a0b\uff1a</p> <pre><code>$ docker build -t nginx:v1 .\nSending build context to Docker daemon 048 kB\n...\n</code></pre> <p>\u7406\u89e3\u6784\u5efa\u4e0a\u4e0b\u6587\u5bf9\u4e8e\u955c\u50cf\u6784\u5efa\u662f\u5f88\u91cd\u8981\u7684\uff0c\u53ef\u4ee5\u907f\u514d\u72af\u4e00\u4e9b\u4e0d\u5e94\u8be5\u7684\u9519\u8bef\u3002\u6bd4\u5982\u6709\u4e9b\u521d\u5b66\u8005\u5728\u53d1\u73b0 COPY /opt/xxxx /app \u4e0d\u5de5\u4f5c\u540e\uff0c\u4e8e\u662f\u5e72\u8106\u5c06 Dockerfile \u653e\u5230\u4e86\u786c\u76d8\u6839\u76ee\u5f55\u53bb\u6784\u5efa\uff0c\u7ed3\u679c\u53d1\u73b0 docker build \u6267\u884c\u65f6\u53d1\u9001\u4e00\u4e2a\u51e0\u5341 GB \u7684\u4e1c\u897f\uff0c\u6781\u4e3a\u7f13\u6162\u800c\u4e14\u5f88\u5bb9\u6613\u6784\u5efa\u5931\u8d25\u3002\u90a3\u662f\u56e0\u4e3a\u8fd9\u79cd\u505a\u6cd5\u662f\u5728\u8ba9 docker build \u6253\u5305\u6574\u4e2a\u786c\u76d8\uff0c\u8fd9\u663e\u7136\u662f\u4f7f\u7528\u9519\u8bef\u3002</p> <p>\u4e00\u822c\u6765\u8bf4\uff0c\u5e94\u8be5\u4f1a\u5c06 Dockerfile \u7f6e\u4e8e\u4e00\u4e2a\u7a7a\u76ee\u5f55\u4e0b\uff0c\u6216\u8005\u9879\u76ee\u6839\u76ee\u5f55\u4e0b\u3002\u5982\u679c\u8be5\u76ee\u5f55\u4e0b\u6ca1\u6709\u6240\u9700\u6587\u4ef6\uff0c\u90a3\u4e48\u5e94\u8be5\u628a\u6240\u9700\u6587\u4ef6\u590d\u5236\u4e00\u4efd\u8fc7\u6765\u3002\u5982\u679c\u76ee\u5f55\u4e0b\u6709\u4e9b\u4e1c\u897f\u786e\u5b9e\u4e0d\u5e0c\u671b\u6784\u5efa\u65f6\u4f20\u7ed9 Docker \u5f15\u64ce\uff0c\u90a3\u4e48\u53ef\u4ee5\u7528 .gitignore \u4e00\u6837\u7684\u8bed\u6cd5\u5199\u4e00\u4e2a <code>.dockerignore</code>\uff0c\u8be5\u6587\u4ef6\u662f\u7528\u4e8e\u5254\u9664\u4e0d\u9700\u8981\u4f5c\u4e3a\u4e0a\u4e0b\u6587\u4f20\u9012\u7ed9 Docker \u5f15\u64ce\u7684\u3002</p> <p>\u90a3\u4e48\u4e3a\u4ec0\u4e48\u4f1a\u6709\u4eba\u8bef\u4ee5\u4e3a <code>.</code> \u662f\u6307\u5b9a Dockerfile \u6240\u5728\u76ee\u5f55\u5462\uff1f\u8fd9\u662f\u56e0\u4e3a\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u4e0d\u989d\u5916\u6307\u5b9a Dockerfile \u7684\u8bdd\uff0c\u4f1a\u5c06\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e0b\u7684\u540d\u4e3a Dockerfile \u7684\u6587\u4ef6\u4f5c\u4e3a Dockerfile\u3002\u8fd9\u53ea\u662f\u9ed8\u8ba4\u884c\u4e3a\uff0c\u5b9e\u9645\u4e0a Dockerfile \u7684\u6587\u4ef6\u540d\u5e76\u4e0d\u8981\u6c42\u5fc5\u987b\u4e3a Dockerfile\uff0c\u800c\u4e14\u5e76\u4e0d\u8981\u6c42\u5fc5\u987b\u4f4d\u4e8e\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\uff0c\u6bd4\u5982\u53ef\u4ee5\u7528<code>-f ../Dockerfile.Dev</code>\u53c2\u6570\u6307\u5b9a\u67d0\u4e2a\u6587\u4ef6\u4f5c\u4e3a Dockerfile\u3002</p> <p>\u5f53\u7136\uff0c\u4e00\u822c\u5927\u5bb6\u4e60\u60ef\u6027\u7684\u4f1a\u4f7f\u7528\u9ed8\u8ba4\u7684\u6587\u4ef6\u540d Dockerfile\uff0c\u4ee5\u53ca\u4f1a\u5c06\u5176\u7f6e\u4e8e\u955c\u50cf\u6784\u5efa\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\u3002</p>"},{"location":"docker/dockerfile_usage/#_27","title":"\u63a8\u9001\u955c\u50cf","text":"<p>\u4e0a\u9762\u6211\u4eec\u8bb2\u5230\u4e86 Dockerfile \u7684\u57fa\u672c\u5199\u6cd5\u4ee5\u53ca\u6784\u5efa\u955c\u50cf\u7684\u65f6\u5019\u4e00\u4e9b\u6ce8\u610f\u4e8b\u9879\uff0c\u90a3\u4e48\u955c\u50cf\u6784\u5efa\u5b8c\u6210\u540e\uff0c\u5982\u4f55\u628a\u6211\u4eec\u7684\u955c\u50cf\u7ed9\u5230\u522b\u4eba\u4f7f\u7528\u5462\uff1f\u7b2c\u4e00\u79cd\u65b9\u6cd5\u5c31\u662f\u5229\u7528 Docker \u5b98\u65b9\u63d0\u4f9b\u7684\u516c\u5171\u7684 Docker Hub \u4ed3\u5e93\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u955c\u50cf\u63a8\u9001\u4e0a\u53bb\uff0c\u7136\u540e\u522b\u4eba\u5c31\u53ef\u4ee5\u76f4\u63a5\u62c9\u53d6\u955c\u50cf\u3002</p>"},{"location":"docker/dockerfile_usage/#_28","title":"\u6ce8\u518c","text":"<p>\u9996\u5148\u9700\u8981 https://cloud.docker.com \u514d\u8d39\u6ce8\u518c\u4e00\u4e2a Docker \u8d26\u53f7\u3002</p>"},{"location":"docker/dockerfile_usage/#_29","title":"\u767b\u5f55","text":"<p>\u7136\u540e\u901a\u8fc7\u6267\u884c<code>docker login</code>\u547d\u4ee4\u4ea4\u4e92\u5f0f\u7684\u8f93\u5165\u7528\u6237\u540d\u53ca\u5bc6\u7801\u6765\u5b8c\u6210\u5728\u547d\u4ee4\u884c\u754c\u9762\u767b\u5f55 Docker Hub\u3002</p> <pre><code>$ docker login\nLogin with your Docker ID to push and pull images from Docker Hub. If you don't have a Docker ID, head over to https://hub.docker.com to create one.\nUsername: cnych\nPassword:\nWARNING! Your password will be stored unencrypted in /root/.docker/config.json.\nConfigure a credential helper to remove this warning. See\nhttps://docs.docker.com/engine/reference/commandline/login/#credentials-store\n\nLogin Succeeded\n</code></pre>"},{"location":"docker/dockerfile_usage/#_30","title":"\u6ce8\u9500","text":"<p>\u4f60\u53ef\u4ee5\u901a\u8fc7<code>docker logout</code>\u9000\u51fa\u767b\u5f55\u3002</p>"},{"location":"docker/dockerfile_usage/#_31","title":"\u63a8\u9001\u955c\u50cf","text":"<p>\u7528\u6237\u5728\u767b\u5f55\u540e\u53ef\u4ee5\u901a\u8fc7<code>docker push</code>\u547d\u4ee4\u6765\u5c06\u81ea\u5df1\u7684\u955c\u50cf\u63a8\u9001\u5230 Docker Hub\u3002\u4ee5\u4e0b\u547d\u4ee4\u4e2d\u7684 username \u8bf7\u66ff\u6362\u4e3a\u4f60\u7684 Docker \u8d26\u53f7\u7528\u6237\u540d\u3002</p> <pre><code>$ docker tag ubuntu:10 username/ubuntu:10\n$ docker image ls\n\nREPOSITORY                                               TAG                    IMAGE ID            CREATED             SIZE\nubuntu                                                   10                  275d79972a86        6 days ago          6MB\nusername/ubuntu                                          10                  275d79972a86        6 days ago          6MB\n$ docker push username/ubuntu:10\n</code></pre>"},{"location":"docker/dockerfile_usage/#_32","title":"\u79c1\u6709\u4ed3\u5e93","text":"<p>\u6709\u65f6\u5019\u6211\u4eec\u53ef\u80fd\u5e0c\u671b\u6211\u4eec\u7684\u955c\u50cf\u53ea\u5728\u5c40\u57df\u7f51\u8303\u56f4\u5185\u4f7f\u7528\uff0c\u4e0d\u5e0c\u671b\u63a8\u9001\u5230 Docker Hub \u8fd9\u6837\u7684\u516c\u5171\u4ed3\u5e93\uff0c\u90a3\u4e48\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u672c\u5730\u4ed3\u5e93\u4f9b\u79c1\u4eba\u4f7f\u7528\u3002</p> <p><code>docker-registry</code> \u5c31\u662f\u662f\u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e2a\u79c1\u6709\u4ed3\u5e93\u5de5\u5177\uff0c\u53ef\u4ee5\u7528\u4e8e\u5b58\u50a8\u79c1\u6709\u7684\u955c\u50cf\u4ed3\u5e93\u3002\u540c\u6837\u7684\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u83b7\u53d6\u5b98\u65b9 registry \u955c\u50cf\u6765\u76f4\u63a5\u8fd0\u884c\uff1a</p> <pre><code>$ docker run -d -p 5000:5000 --name registry registry:2\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u4f7f\u7528\u5b98\u65b9\u7684 registry \u955c\u50cf\u6765\u542f\u52a8\u79c1\u6709\u4ed3\u5e93\u5bb9\u5668\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4ed3\u5e93\u4f1a\u88ab\u521b\u5efa\u5728\u5bb9\u5668\u7684<code>/var/lib/registry</code>\u76ee\u5f55\u4e0b\u3002\u4f60\u53ef\u4ee5\u901a\u8fc7 <code>-v</code> \u53c2\u6570\u6765\u5c06\u955c\u50cf\u6587\u4ef6\u5b58\u653e\u5728\u672c\u5730\u7684\u6307\u5b9a\u8def\u5f84\u3002\u4f8b\u5982\u4e0b\u9762\u7684\u4f8b\u5b50\u5c06\u4e0a\u4f20\u7684\u955c\u50cf\u653e\u5230\u672c\u5730\u7684 <code>/opt/data/registry</code> \u76ee\u5f55:</p> <pre><code>$ docker run -d \\\\\n    -p 5000:5000 \\\\\n    -v /opt/data/registry:/var/lib/registry \\\\\n    registry:2\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u8fd0\u884c\u4e86\u4e00\u4e2a\u6570\u636e\u6301\u4e45\u5316\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u3002</p> <p>\u521b\u5efa\u597d\u79c1\u6709\u4ed3\u5e93\u4e4b\u540e\uff0c\u7136\u540e\u53ef\u4ee5\u4f7f\u7528<code>docker tag</code>\u6765\u6807\u8bb0\u4e00\u4e2a\u955c\u50cf\uff0c\u7136\u540e\u63a8\u9001\u5b83\u5230\u4ed3\u5e93\u3002\u6bd4\u5982\u79c1\u6709\u4ed3\u5e93\u5730\u5740\u4e3a<code>127.0.0.1:5000</code>\u3002\u5148\u5728\u672c\u673a\u67e5\u770b\u5df2\u6709\u7684\u955c\u50cf\u3002</p> <pre><code>$ docker images\nREPOSITORY                        TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nubuntu                            latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u4f7f\u7528<code>docker tag</code>\u5c06 ubuntu:latest \u8fd9\u4e2a\u955c\u50cf\u6807\u8bb0\u4e3a </p> <pre><code>11:5000/ubuntu:latest\n</code></pre> <p>:</p> <pre><code>$ docker tag ubuntu:latest 11:5000/ubuntu:latest\n$ docker images\nREPOSITORY                        TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nubuntu                            latest              ba5877dc9bec        6 weeks ago         17 MB\n11:5000/ubuntu:latest      latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u7136\u540e\u5c31\u53ef\u4ee5\u4f7f\u7528<code>docker push</code>\u4e0a\u4f20\u6807\u8bb0\u7684\u955c\u50cf:</p> <pre><code>$ docker push 11:5000/ubuntu:latest\nThe push refers to repository [11:5000/ubuntu]\n373a30c24545: Pushed\na9148f5200b0: Pushed\ncdd3de0940ab: Pushedfc56279bbb33: Pushed\nb38367233d37: Pushed\n2aebd096e0e2: Pushed\nlatest: digest: sha256:fe4277621f10b5026266932ddf760f5a756d2facd505a94d2da12f4f52f71f5a size: 1568\n</code></pre> <p>\u6b64\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528 registry \u4ed3\u5e93\u63d0\u4f9b\u7684 API \u6765\u67e5\u770b\u4ed3\u5e93\u4e2d\u7684\u955c\u50cf\uff1a</p> <pre><code>$ curl 11:5000/v2/_catalog\n{\"repositories\":[\"ubuntu\"]}\n</code></pre> <p>\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230 {\"repositories\":[\"ubuntu\"]}\uff0c\u8868\u660e\u955c\u50cf\u5df2\u7ecf\u88ab\u6210\u529f\u4e0a\u4f20\u4e86\u3002</p> <p>\u5148\u5220\u9664\u5df2\u6709\u955c\u50cf\uff0c\u518d\u5c1d\u8bd5\u4ece\u79c1\u6709\u4ed3\u5e93\u4e2d\u4e0b\u8f7d\u8fd9\u4e2a\u955c\u50cf\u3002</p> <pre><code>$ docker image rm 11:5000/ubuntu:latest\n$ docker pull 11:5000/ubuntu:latest\nPulling repository 11:5000/ubuntu:latest\nba5877dc9bec: Download complete\n511136ea3c5a: Download complete\n9bad880da3d2: Download complete\n25f11f5fb0cb: Download complete\nebc34468f71d: Download complete\n2318d26665ef: Download complete\n$ docker image ls\nREPOSITORY                         TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\n11:5000/ubuntu:latest       latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u628a\u955c\u50cf\u4e0a\u4f20\u5230\u4e86\u79c1\u6709\u4ed3\u5e93\u4e2d\u7684\u5b8c\u6574\u8fc7\u7a0b\u3002</p>"},{"location":"docker/dockerfile_usage/#_33","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p>\u5982\u679c\u4f60\u4e0d\u60f3\u4f7f\u7528 <code>127.0.0.1:5000</code> \u4f5c\u4e3a\u4ed3\u5e93\u5730\u5740\uff0c\u6bd4\u5982\u60f3\u8ba9\u672c\u7f51\u6bb5\u7684\u5176\u4ed6\u4e3b\u673a\u4e5f\u80fd\u628a\u955c\u50cf\u63a8\u9001\u5230\u79c1\u6709\u4ed3\u5e93\u3002\u4f60\u5c31\u5f97\u628a\u4f8b\u5982 <code>192.168.199.100:5000</code> \u8fd9\u6837\u7684\u5185\u7f51\u5730\u5740\u4f5c\u4e3a\u79c1\u6709\u4ed3\u5e93\u5730\u5740\uff0c\u8fd9\u65f6\u4f60\u4f1a\u53d1\u73b0\u65e0\u6cd5\u6210\u529f\u63a8\u9001\u955c\u50cf\u3002</p> <p>\u8fd9\u662f\u56e0\u4e3a Docker \u9ed8\u8ba4\u4e0d\u5141\u8bb8\u975e HTTPS \u65b9\u5f0f\u63a8\u9001\u955c\u50cf\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Docker \u7684\u914d\u7f6e\u9009\u9879\u6765\u53d6\u6d88\u8fd9\u4e2a\u9650\u5236\uff0c\u6211\u4eec\u8fd9\u91cc\u662f CentOS 7 \u7cfb\u7edf\uff0c\u540c\u6837\u8fd8\u662f\u7f16\u8f91\u6587\u4ef6</p> <pre><code>/etc/docker/daemon.json\n</code></pre> <p>\uff0c\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>{\n  \"registry-mirror\": [\n    \"https://registry.docker-cn.com\"\n  ],\n  \"insecure-registries\": [\n    \"111100:5000\"\n  ]\n}\n</code></pre> <p>\u5176\u4e2d\u7684<code>insecure-registries</code>\u5c31\u662f\u6211\u4eec\u6dfb\u52a0\u7684\u5185\u5bb9\uff0c\u7136\u540e\u91cd\u542f Docker \u4e4b\u540e\u5c31\u53ef\u4ee5\u5728\u5c40\u57df\u7f51\u5185\u4f7f\u7528\u6211\u4eec\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u4e86\u3002</p> <p>\u9ed8\u8ba4\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u53ef\u4ee5\u6ee1\u8db3\u6211\u4eec\u7684\u5f88\u591a\u9700\u6c42\uff0c\u4f46\u662f\u5f80\u5f80\u5728\u4f01\u4e1a\u4e2d\u4f7f\u7528\u7684\u8bdd\u8fd8\u6709\u5f88\u5b89\u5168\u6027\u65b9\u9762\u7684\u529f\u80fd\u7684\u7f3a\u5931\uff0c\u6bd4\u5982\u6743\u9650\u7ba1\u7406\u4e4b\u7c7b\u7684\uff0c\u8fd9\u5bf9\u4e8e\u4f01\u4e1a\u6765\u8bf4\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u4e0d\u8fc7 registry \u5bf9\u4e8e\u6743\u9650\u7ba1\u7406\u8fd9\u4e00\u5757\u505a\u4e86\u4e00\u4e2a\u5bf9\u5916\u66b4\u9732\u7684\u63a5\u53e3\uff0c\u53ea\u8981\u6211\u4eec\u5b9e\u73b0\u4ed6\u66b4\u9732\u7684\u5b89\u5168\u63a5\u53e3\u5c31\u53ef\u4ee5\u6765\u5b9e\u73b0\u6743\u9650\u7ba1\u7406\u76f8\u5173\u7684\u63a5\u53e3\uff0c\u5176\u4e2d\u6ce8\u660e\u7684\u5f00\u6e90\u955c\u50cf\u7ba1\u7406\u8f6f\u4ef6 Harbor \u5c31\u662f\u8fd9\u7c7b\u5e94\u7528\u7684\u4f7c\u4f7c\u8005\uff0c\u6211\u4eec\u8fd8\u5728\u540e\u9762\u7684\u8bfe\u7a0b\u4e2d\u548c\u5927\u5bb6\u5b66\u4e60 Harbor \u7684\u4e00\u4e2a\u4f7f\u7528\u3002\ue3c9</p>"},{"location":"docker/dockerfile_usage/#dockerfile_3","title":"Dockerfile","text":"<p>\u4f7f\u7528 Dockerfile \u5b9a\u5236\u955c\u50cf</p> <p></p> <p>\u955c\u50cf\u7684\u5b9a\u5236\u5b9e\u9645\u4e0a\u5c31\u662f\u5b9a\u5236\u955c\u50cf\u7684\u6bcf\u4e00\u5c42\u6240\u6dfb\u52a0\u7684\u914d\u7f6e\u3001\u6587\u4ef6\u7b49\u4fe1\u606f\uff0c\u5b9e\u9645\u4e0a\u5f53\u6211\u4eec\u5728\u4e00\u4e2a\u5bb9\u5668\u4e2d\u6dfb\u52a0\u6216\u8005\u4fee\u6539\u4e86\u4e00\u4e9b\u6587\u4ef6\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7<code>docker commit</code>\u547d\u4ee4\u6765\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u955c\u50cf\uff0c\u4f46\u662f\u8fd9\u4e2a\u65b9\u6cd5\u4e0d\u591f\u76f4\u89c2\uff0c\u6ca1\u529e\u6cd5\u8ffd\u6eaf\u6211\u4eec\u955c\u50cf\u91cc\u9762\u5230\u5e95\u6709\u54ea\u4e9b\u5185\u5bb9\uff0c\u6240\u4ee5\u5b9e\u9645\u5b9a\u5236\u955c\u50cf\u7684\u8fc7\u7a0b\u6211\u4eec\u5f88\u5c11\u91c7\u7528\u8fd9\u79cd\u65b9\u5f0f\u3002\u800c\u662f\u4f7f\u7528\u4e00\u4e2a\u540d\u4e3a <code>Dockerfile</code> \u7684\u6587\u672c\u6587\u4ef6\u6765\u8fdb\u884c\u955c\u50cf\u5b9a\u5236\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u955c\u50cf\u7684\u6bcf\u4e00\u5c42\u4fee\u6539\u3001\u5b89\u88c5\u3001\u6784\u5efa\u3001\u64cd\u4f5c\u7684\u547d\u4ee4\u90fd\u5199\u5165\u5230\u8fd9\u4e2a\u6587\u4ef6\u4e2d\uff0c\u4e00\u884c\u5c31\u5bf9\u5e94\u955c\u50cf\u7684\u4e00\u5c42\uff0c\u8fd9\u79cd\u65b9\u6cd5\u663e\u7136\u8981\u66f4\u9ad8\u7ea7\uff0c\u56e0\u4e3a\u6211\u4eec\u6709\u4e00\u4e2a\u6587\u4ef6\u6765\u76f4\u89c2\u53cd\u6620\u6211\u4eec\u7684\u955c\u50cf\u5185\u5bb9\uff0c\u8fd8\u53ef\u4ee5\u4f5c\u4e3a\u7248\u672c\u8bb0\u5f55\u8fdb\u884c\u8ddf\u8e2a\u3002</p>"},{"location":"docker/dockerfile_usage/#_34","title":"\u5b9a\u5236\u955c\u50cf","text":"<p>\u4ee5\u6211\u4eec\u4e4b\u524d\u7684 nginx \u955c\u50cf\u4e3a\u4f8b\uff0c\u6211\u4eec\u73b0\u5728\u6765\u5b9a\u5236\u4e00\u4e2a nginx \u955c\u50cf\uff0c\u8981\u6c42\u9ed8\u8ba4\u7684\u5e94\u7528\u9875\u9762\u8bbf\u95ee\u7684\u5185\u5bb9\u662f <code>Hello Docker</code>\u3002</p> <p>\u9996\u5148\u6211\u4eec\u65b0\u5efa\u4e00\u4e2a\u76ee\u5f55 testnginx\uff0c\u7136\u540e\u5728\u8be5\u76ee\u5f55\u4e0b\u9762\u65b0\u5efa\u4e00\u4e2a\u540d\u4e3a<code>Dockerfile</code>\u7684\u7a7a\u767d\u6587\u672c\u6587\u4ef6\uff1a</p> <pre><code>$ mkdir -p testnginx &amp;&amp; cd testnginx &amp;&amp; touch Dockerfile\n</code></pre> <p>\u7136\u540e\u5411<code>Dockerfile</code>\u6587\u4ef6\u4e2d\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>FROM nginx\nRUN echo 'Hello Docker!' &gt; /user/share/nginx/html/index.html\n</code></pre> <p>\u8fd9\u4e2a\u6587\u4ef6\u5f88\u7b80\u5355\uff0c\u4e00\u5171\u5c31\u4e24\u884c\uff0c\u5176\u4e2d\u5305\u542b\u4e24\u6761\u6307\u4ee4\uff0c<code>FROM</code> \u548c <code>RUN</code>\u3002</p>"},{"location":"docker/dockerfile_usage/#from_3","title":"FROM \u6307\u4ee4","text":"<p>\u5b9a\u5236\u955c\u50cf\uff0c\u90a3\u4e48\u80af\u5b9a\u662f\u4e00\u4e2a\u955c\u50cf\u4e3a\u57fa\u7840\uff0c\u5728\u5176\u57fa\u7840\u4e0a\u8fdb\u884c\u5b9a\u5236\uff0c\u800c <code>FROM</code> \u8fd9\u4e2a\u6307\u4ee4\u5c31\u662f\u6765\u6307\u5b9a\u57fa\u7840\u955c\u50cf\u7684\uff0c\u6240\u4ee5\u5728\u4e00\u4e2a <code>Dockerfile</code> \u6587\u4ef6\u4e2d <code>FROM</code> \u6307\u4ee4\u662f\u5fc5\u5907\u7684\uff0c\u5e76\u4e14\u5fc5\u987b\u662f\u7b2c\u4e00\u6761\u6307\u4ee4\u3002</p> <p>\u5728 Docker Hub \u4e0a\u6709\u975e\u5e38\u591a\u7684\u9ad8\u8d28\u91cf\u7684\u5b98\u65b9\u955c\u50cf\uff0c\u6709\u4e00\u4e9b\u53ef\u4ee5\u76f4\u63a5\u62ff\u6765\u4f7f\u7528\u7684\u670d\u52a1\u7c7b\u7684\u955c\u50cf\uff0c\u5982 nginx\u3001redis\u3001mongo\u3001mysql\u3001httpd\u3001php\u3001tomcat \u7b49\uff1b\u4e5f\u6709\u4e00\u4e9b\u65b9\u4fbf\u5f00\u53d1\u3001\u6784\u5efa\u3001\u8fd0\u884c\u5404\u79cd\u8bed\u8a00\u5e94\u7528\u7684\u955c\u50cf\uff0c\u5982 node\u3001openjdk\u3001python\u3001ruby\u3001golang \u7b49\u3002\u53ef\u4ee5\u5728\u5176\u4e2d\u5bfb\u627e\u4e00\u4e2a\u6700\u7b26\u5408\u6211\u4eec\u6700\u7ec8\u76ee\u6807\u7684\u955c\u50cf\u4e3a\u57fa\u7840\u955c\u50cf\u8fdb\u884c\u5b9a\u5236\u3002</p> <p>\u5982\u679c\u6ca1\u6709\u627e\u5230\u5408\u9002\u7684\u57fa\u7840\u955c\u50cf\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e9b\u66f4\u4e3a\u57fa\u7840\u7684\u64cd\u4f5c\u7cfb\u7edf\u955c\u50cf\uff0c\u6bd4\u5982 ubuntu\u3001debian\u3001centos\u3001alpine \u7b49\uff0c\u8fd9\u4e9b\u57fa\u7840\u955c\u50cf\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u66f4\u5927\u7684\u6269\u5c55\u7a7a\u95f4\uff0c\u5c31\u7c7b\u4f3c\u4e8e\u5e73\u65f6\u6211\u4eec\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e0a\u9762\u90e8\u7f72\u81ea\u5df1\u7684\u670d\u52a1\u4e00\u6837\u7684\u64cd\u4f5c\u3002</p> <p>\u9664\u4e86\u9009\u62e9\u73b0\u6709\u955c\u50cf\u4e3a\u57fa\u7840\u955c\u50cf\u5916\uff0cDocker \u8fd8\u5b58\u5728\u4e00\u4e2a\u7279\u6b8a\u7684\u955c\u50cf\uff0c\u540d\u4e3a <code>scratch</code>\uff0c\u8fd9\u4e2a\u955c\u50cf\u662f\u4e00\u4e2a\u865a\u62df\u7684\u955c\u50cf\uff0c\u5e76\u4e0d\u5b9e\u9645\u5b58\u5728\uff0c\u8868\u793a\u4e00\u4e2a\u7a7a\u767d\u7684\u955c\u50cf\uff1a</p> <p><code>FROM scratch ...</code></p> <p>\u5982\u679c\u4f60\u4ee5 <code>scratch</code> \u4e3a\u57fa\u7840\u955c\u50cf\u7684\u8bdd\uff0c\u610f\u5473\u7740\u4f60\u4e0d\u4ee5\u4efb\u4f55\u955c\u50cf\u4e3a\u57fa\u7840\uff0c\u63a5\u4e0b\u6765\u6240\u5199\u7684\u6307\u4ee4\u5c06\u4f5c\u4e3a\u955c\u50cf\u7b2c\u4e00\u5c42\u5f00\u59cb\u5b58\u5728\u3002\u6709\u7684\u540c\u5b66\u53ef\u80fd\u611f\u89c9\u5f88\u5947\u602a\uff0c\u6ca1\u6709\u4efb\u4f55\u57fa\u7840\u955c\u50cf\uff0c\u6211\u600e\u4e48\u53bb\u6267\u884c\u6211\u7684\u7a0b\u5e8f\u5462\uff0c\u5176\u5b9e\u5bf9\u4e8e Linux \u4e0b\u9759\u6001\u7f16\u8bd1\u7684\u7a0b\u5e8f\u6765\u8bf4\uff0c\u5e76\u4e0d\u9700\u8981\u6709\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u8fd0\u884c\u65f6\u652f\u6301\uff0c\u6240\u9700\u7684\u4e00\u5207\u5e93\u90fd\u5df2\u7ecf\u5728\u53ef\u6267\u884c\u6587\u4ef6\u91cc\u4e86\uff0c\u56e0\u6b64\u76f4\u63a5<code>FROM scratch</code>\u4f1a\u8ba9\u955c\u50cf\u4f53\u79ef\u66f4\u52a0\u5c0f\u5de7\u3002\u4f7f\u7528 Go \u8bed\u8a00 \u5f00\u53d1\u7684\u5e94\u7528\u5f88\u591a\u4f1a\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u6765\u5236\u4f5c\u955c\u50cf\uff0c\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u6709\u5f88\u591a\u89c2\u70b9\u8ba4\u4e3a Go \u662f\u7279\u522b\u9002\u5408\u5bb9\u5668\u5fae\u670d\u52a1\u67b6\u6784\u7684\u8bed\u8a00\u7684\u539f\u56e0\u4e4b\u4e00\u3002</p>"},{"location":"docker/dockerfile_usage/#run_3","title":"RUN \u6307\u4ee4","text":"<p><code>RUN</code> \u6307\u4ee4\u662f\u7528\u6765\u6267\u884c\u547d\u4ee4\u884c\u547d\u4ee4\u7684\u3002\u7531\u4e8e\u547d\u4ee4\u884c\u7684\u5f3a\u5927\u80fd\u529b\uff0c\u6240\u4ee5 <code>RUN</code> \u6307\u4ee4\u662f\u5b9a\u5236\u955c\u50cf\u65f6\u662f\u6700\u5e38\u7528\u7684\u6307\u4ee4\u4e4b\u4e00\u3002\u5176\u683c\u5f0f\u6709\u4e24\u79cd\uff1a</p> <ul> <li> <p>shell \u683c\u5f0f\uff1a<code>RUN &lt;\u547d\u4ee4&gt;</code>\uff0c\u5c31\u50cf\u76f4\u63a5\u5728\u547d\u4ee4\u884c\u4e2d\u8f93\u5165\u7684\u547d\u4ee4\u4e00\u6837\u3002\u521a\u624d\u5199\u7684 Dockerfile \u4e2d\u7684 RUN \u6307\u4ee4\u5c31\u662f\u8fd9\u79cd\u683c\u5f0f\uff1a</p> <pre><code>RUN echo 'Hello, Docker!' &gt; /usr/share/nginx/html/index.html\n</code></pre> </li> <li> <p>exec \u683c\u5f0f\uff1a</p> <pre><code>RUN [\"\u53ef\u6267\u884c\u6587\u4ef6\", \"\u53c2\u65701\", \"\u53c2\u65702\"]\n</code></pre> <p>\uff0c\u8fd9\u66f4\u50cf\u662f\u51fd\u6570\u8c03\u7528\u4e2d\u7684\u683c\u5f0f\u3002\u65e2\u7136 RUN \u5c31\u50cf Shell \u811a\u672c\u4e00\u6837\u53ef\u4ee5\u6267\u884c\u547d\u4ee4\uff0c\u90a3\u4e48\u6211\u4eec\u662f\u5426\u5c31\u53ef\u4ee5\u50cf Shell \u811a\u672c\u4e00\u6837\u628a\u6bcf\u4e2a\u547d\u4ee4\u5bf9\u5e94\u4e00\u4e2a RUN \u5462\uff1f\u6bd4\u5982\u8fd9\u6837\uff1a</p> <pre><code>FROM debian:jessie\nRUN apt-get update\nRUN apt-get install -y gcc libc6-dev make wget\nRUN wget -O redis.tar.gz \"http://download.redis.io/releases/redis-tar.gz\"\nRUN mkdir -p /usr/src/redis\nRUN tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1\nRUN make -C /usr/src/redis\nRUN make -C /usr/src/redis install\n# \u5176\u4ed6\u6307\u4ee4...\n</code></pre> </li> </ul> <p>\u4e4b\u524d\u8bf4\u8fc7\uff0cDockerfile \u4e2d\u6bcf\u4e00\u4e2a\u6307\u4ee4\u90fd\u4f1a\u5efa\u7acb\u4e00\u5c42\uff0cRUN \u4e5f\u4e0d\u4f8b\u5916\u3002\u6bcf\u4e00\u4e2a RUN \u5c31\u4f1a\u65b0\u5efa\u7acb\u4e00\u5c42\uff0c\u5728\u5176\u4e0a\u6267\u884c\u8fd9\u4e9b\u547d\u4ee4\uff0c\u6267\u884c\u7ed3\u675f\u540e\uff0ccommit \u8fd9\u4e00\u5c42\u7684\u4fee\u6539\uff0c\u6784\u6210\u65b0\u7684\u955c\u50cf\u3002</p> <p>\u800c\u4e0a\u9762\u7684\u8fd9\u79cd\u5199\u6cd5\uff0c\u521b\u5efa\u4e86 7 \u5c42\u955c\u50cf\u3002\u8fd9\u662f\u5b8c\u5168\u6ca1\u6709\u5fc5\u8981\u7684\uff0c\u800c\u4e14\u5f88\u591a\u8fd0\u884c\u65f6\u4e0d\u9700\u8981\u7684\u4e1c\u897f\uff0c\u90fd\u88ab\u88c5\u8fdb\u4e86\u955c\u50cf\u91cc\uff0c\u6bd4\u5982\u7f16\u8bd1\u73af\u5883\u3001\u66f4\u65b0\u7684\u8f6f\u4ef6\u5305\u7b49\u7b49\u3002\u7ed3\u679c\u5c31\u662f\u4ea7\u751f\u975e\u5e38\u81c3\u80bf\u3001\u975e\u5e38\u591a\u5c42\u7684\u955c\u50cf\uff0c\u4e0d\u4ec5\u4ec5\u589e\u52a0\u4e86\u6784\u5efa\u90e8\u7f72\u7684\u65f6\u95f4\uff0c\u4e5f\u5f88\u5bb9\u6613\u51fa\u9519\u3002 \u8fd9\u662f\u5f88\u591a\u521d\u5b66 Docker \u7684\u4eba\u5e38\u72af\u7684\u4e00\u4e2a\u9519\u8bef\u3002</p> <p>UnionFS \u5c42\u9650\u5236</p> <p>UnionFS \u5b9e\u9645\u4e0a\u662f\u6709\u6700\u5927\u5c42\u6570\u9650\u5236\u7684\uff0c\u6bd4\u5982 AUFS\uff0c\u66fe\u7ecf\u662f\u6700\u5927\u4e0d\u5f97\u8d85\u8fc7 42 \u5c42\uff0c\u73b0\u5728\u662f\u4e0d\u5f97\u8d85\u8fc7 127 \u5c42\u3002</p> <p>\u4e0a\u9762\u7684 Dockerfile \u6b63\u786e\u7684\u5199\u6cd5\u5e94\u8be5\u662f\u8fd9\u6837\uff1a</p> <pre><code>FROM debian:jessie\nRUN buildDeps='gcc libc6-dev make wget' \\\\\n    &amp;&amp; apt-get update \\\\\n    &amp;&amp; apt-get install -y $buildDeps \\\\\n    &amp;&amp; wget -O redis.tar.gz \"http://download.redis.io/releases/redis-tar.gz\" \\\\\n    &amp;&amp; mkdir -p /usr/src/redis \\\\\n    &amp;&amp; tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1 \\\\\n    &amp;&amp; make -C /usr/src/redis \\\\\n    &amp;&amp; make -C /usr/src/redis install \\\\\n    &amp;&amp; rm -rf /var/lib/apt/lists/* \\\\\n    &amp;&amp; rm redis.tar.gz \\\\\n    &amp;&amp; rm -r /usr/src/redis \\\\\n    &amp;&amp; apt-get purge -y --auto-remove $buildDeps\n# \u5176\u4ed6\u6307\u4ee4...\n</code></pre> <p>\u9996\u5148\uff0c\u4e4b\u524d\u6240\u6709\u7684\u547d\u4ee4\u53ea\u6709\u4e00\u4e2a\u76ee\u7684\uff0c\u5c31\u662f\u7f16\u8bd1\u3001\u5b89\u88c5 redis \u53ef\u6267\u884c\u6587\u4ef6\u3002\u56e0\u6b64\u6ca1\u6709\u5fc5\u8981\u5efa\u7acb\u5f88\u591a\u5c42\uff0c\u8fd9\u53ea\u662f\u4e00\u5c42\u7684\u4e8b\u60c5\u3002\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u6ca1\u6709\u4f7f\u7528\u5f88\u591a\u4e2a RUN \u6307\u4ee4\u6765\u5bf9\u5e94\u4e0d\u540c\u7684\u547d\u4ee4\uff0c\u800c\u662f\u4ec5\u4ec5\u4f7f\u7528\u4e00\u4e2a RUN \u6307\u4ee4\uff0c\u5e76\u4f7f\u7528<code>&amp;&amp;</code>\u5c06\u5404\u4e2a\u6240\u9700\u547d\u4ee4\u4e32\u8054\u8d77\u6765\u3002\u5c06\u4e4b\u524d\u7684 7 \u5c42\uff0c\u7b80\u5316\u4e3a\u4e86 1 \u5c42\u3002\u5728\u64b0\u5199 Dockerfile \u7684\u65f6\u5019\uff0c\u8981\u7ecf\u5e38\u63d0\u9192\u81ea\u5df1\uff0c\u8fd9\u5e76\u4e0d\u662f\u5728\u5199 Shell \u811a\u672c\uff0c\u800c\u662f\u5728\u5b9a\u4e49\u6bcf\u4e00\u5c42\u8be5\u5982\u4f55\u6784\u5efa\u3002</p> <p>\u5e76\u4e14\uff0c\u8fd9\u91cc\u4e3a\u4e86\u683c\u5f0f\u5316\u8fd8\u8fdb\u884c\u4e86\u6362\u884c\u3002Dockerfile \u652f\u6301 Shell \u7c7b\u7684\u884c\u5c3e\u6dfb\u52a0<code>\\</code>\u7684\u547d\u4ee4\u6362\u884c\u65b9\u5f0f\uff0c\u4ee5\u53ca\u884c\u9996<code>#</code>\u8fdb\u884c\u6ce8\u91ca\u7684\u683c\u5f0f\u3002\u826f\u597d\u7684\u683c\u5f0f\uff0c\u6bd4\u5982<code>\u6362\u884c\u3001\u7f29\u8fdb\u3001\u6ce8\u91ca</code>\u7b49\uff0c\u4f1a\u8ba9\u7ef4\u62a4\u3001\u6392\u969c\u66f4\u4e3a\u5bb9\u6613\uff0c\u8fd9\u662f\u4e00\u4e2a\u6bd4\u8f83\u597d\u7684\u4e60\u60ef\u3002</p> <p>\u6b64\u5916\uff0c\u8fd8\u53ef\u4ee5\u770b\u5230\u8fd9\u4e00\u7ec4\u547d\u4ee4\u7684\u6700\u540e\u6dfb\u52a0\u4e86\u6e05\u7406\u5de5\u4f5c\u7684\u547d\u4ee4\uff0c\u5220\u9664\u4e86\u4e3a\u4e86\u7f16\u8bd1\u6784\u5efa\u4e0b\u8f7d\u7684\u8f6f\u4ef6\uff0c\u6e05\u7406\u4e86\u6240\u6709\u4e0b\u8f7d\u3001\u5c55\u5f00\u7684\u6587\u4ef6\uff0c\u5e76\u4e14\u8fd8\u6e05\u7406\u4e86 apt \u7f13\u5b58\u6587\u4ef6\u3002\u8fd9\u662f\u5f88\u91cd\u8981\u7684\u4e00\u6b65\uff0c\u6211\u4eec\u4e4b\u524d\u8bf4\u8fc7\uff0c\u955c\u50cf\u662f\u591a\u5c42\u5b58\u50a8\uff0c\u6bcf\u4e00\u5c42\u7684\u4e1c\u897f\u5e76\u4e0d\u4f1a\u5728\u4e0b\u4e00\u5c42\u88ab\u5220\u9664\uff0c\u4f1a\u4e00\u76f4\u8ddf\u968f\u7740\u955c\u50cf\u3002\u56e0\u6b64\u955c\u50cf\u6784\u5efa\u65f6\uff0c\u4e00\u5b9a\u8981\u786e\u4fdd\u6bcf\u4e00\u5c42\u53ea\u6dfb\u52a0\u771f\u6b63\u9700\u8981\u6dfb\u52a0\u7684\u4e1c\u897f\uff0c\u4efb\u4f55\u65e0\u5173\u7684\u4e1c\u897f\u90fd\u5e94\u8be5\u6e05\u7406\u6389\u3002 \u5f88\u591a\u4eba\u521d\u5b66 Docker \u5236\u4f5c\u51fa\u4e86\u5f88\u81c3\u80bf\u7684\u955c\u50cf\u7684\u539f\u56e0\u4e4b\u4e00\uff0c\u5c31\u662f\u5fd8\u8bb0\u4e86\u6bcf\u4e00\u5c42\u6784\u5efa\u7684\u6700\u540e\u4e00\u5b9a\u8981\u6e05\u7406\u6389\u65e0\u5173\u6587\u4ef6\u3002</p>"},{"location":"docker/dockerfile_usage/#workdir_3","title":"WORKDIR \u6307\u4ee4","text":"<p><code>WORKDIR</code> \u6307\u4ee4\u8bbe\u7f6e Dockerfile \u4e2d\u7684\u4efb\u4f55 RUN\uff0cCMD\uff0cENTRPOINT\uff0cCOPY \u548c ADD \u6307\u4ee4\u7684\u5de5\u4f5c\u76ee\u5f55\u3002\u5982\u679c WORKDIR \u6307\u5b9a\u7684\u76ee\u5f55\u4e0d\u5b58\u5728\uff0c\u5373\u4f7f\u968f\u540e\u7684\u6307\u4ee4\u6ca1\u6709\u7528\u5230\u8fd9\u4e2a\u76ee\u5f55\uff0c\u90fd\u4f1a\u521b\u5efa\u8be5\u76ee\u5f55\u3002</p> <p>\u683c\u5f0f\uff1a </p> <pre><code>WORKDIR /path/to/workdir\n</code></pre> <p>\u4e3a\u4e86\u6e05\u6670\u6027\u548c\u53ef\u9760\u6027\uff0c\u4f60\u5e94\u8be5\u603b\u662f\u5728 WORKDIR \u4e2d\u4f7f\u7528\u7edd\u5bf9\u8def\u5f84\uff0c\u800c\u4e14\u5355\u4e2a Dockerfile \u53ef\u4ee5\u4f7f\u7528\u591a\u6b21WORKDIR\u3002\u53e6\u5916\uff0c\u6211\u4eec\u5e94\u8be5\u4f7f\u7528 WORKDIR \u6765\u66ff\u4ee3\u7c7b\u4f3c\u4e8e </p> <pre><code>RUN cd ... &amp;&amp; do-something\n</code></pre> <p>\u7684\u6307\u4ee4\uff0c\u540e\u8005\u96be\u4ee5\u9605\u8bfb\u3001\u6392\u9519\u548c\u7ef4\u62a4\u3002</p>"},{"location":"docker/dockerfile_usage/#add_copy_3","title":"ADD &amp; COPY \u6307\u4ee4","text":"<p>Dockerfile \u4e2d\u7684 <code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code> \u6307\u4ee4\u90fd\u53ef\u4ee5\u5c06\u4e3b\u673a\u4e0a\u7684\u8d44\u6e90\u590d\u5236\u6216\u52a0\u5165\u5230\u5bb9\u5668\u955c\u50cf\u4e2d\uff0c\u90fd\u662f\u5728\u6784\u5efa\u955c\u50cf\u7684\u8fc7\u7a0b\u4e2d\u5b8c\u6210\u7684\u3002</p> <p><code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code> \u6307\u4ee4\u7684\u552f\u4e00\u533a\u522b\u5728\u4e8e<code>\u662f\u5426\u652f\u6301\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90</code>\u3002<code>COPY</code> \u6307\u4ee4\u53ea\u80fd\u4ece\u6267\u884c<code>docker build</code>\u6240\u5728\u7684\u4e3b\u673a\u4e0a\u8bfb\u53d6\u8d44\u6e90\u5e76\u590d\u5236\u5230\u955c\u50cf\u4e2d\u3002\u800c <code>ADD</code> \u6307\u4ee4\u8fd8\u652f\u6301\u901a\u8fc7 URL \u4ece\u8fdc\u7a0b\u670d\u52a1\u5668\u8bfb\u53d6\u8d44\u6e90\u5e76\u590d\u5236\u5230\u955c\u50cf\u4e2d\u3002</p> <p>\u4e00\u822c\u6765\u8bf4\u6ee1\u8db3\u540c\u7b49\u529f\u80fd\u7684\u60c5\u51b5\u4e0b\uff0c\u63a8\u8350\u4f7f\u7528COPY\u6307\u4ee4\u3002<code>ADD</code> \u6307\u4ee4\u66f4\u64c5\u957f\u8bfb\u53d6\u672c\u5730 tar \u6587\u4ef6\u5e76\u89e3\u538b\u7f29\u3002</p>"},{"location":"docker/dockerfile_usage/#copy_3","title":"COPY \u6307\u4ee4","text":"<p><code>COPY</code> \u6307\u4ee4\u80fd\u591f\u5c06\u6784\u5efa\u547d\u4ee4\u6240\u5728\u7684\u4e3b\u673a\u672c\u5730\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u590d\u5236\u5230\u955c\u50cf\u6587\u4ef6\u7cfb\u7edf\u3002COPY \u6307\u4ee4\u540c\u6837\u4e5f\u652f\u6301 exec \u548c shell \u4e24\u79cd\u683c\u5f0f\uff1a</p> <ul> <li> <p>exec \u683c\u5f0f\u7528\u6cd5\uff1a</p> <pre><code>COPY [\"&lt;src&gt;\",... \"&lt;dest&gt;\"]\n</code></pre> <p>\uff0c\u7279\u522b\u9002\u5408\u8def\u5f84\u4e2d\u5e26\u6709\u7a7a\u683c\u7684\u60c5\u51b5\u3002</p> </li> <li> <p>shell \u683c\u5f0f\u7528\u6cd5\uff1a<code>COPY &lt;src&gt;... &lt;dest&gt;</code></p> </li> </ul>"},{"location":"docker/dockerfile_usage/#add_3","title":"ADD \u6307\u4ee4","text":"<p><code>ADD</code> \u6307\u4ee4\u4e0d\u4ec5\u80fd\u591f\u5c06\u6784\u5efa\u547d\u4ee4\u6240\u5728\u7684\u4e3b\u673a\u672c\u5730\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u800c\u4e14\u80fd\u591f\u5c06\u8fdc\u7a0b URL \u6240\u5bf9\u5e94\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u4f5c\u4e3a\u8d44\u6e90\u590d\u5236\u5230\u955c\u50cf\u6587\u4ef6\u7cfb\u7edf\u3002\u6240\u4ee5\uff0c\u53ef\u4ee5\u8ba4\u4e3a <code>ADD</code> \u662f\u589e\u5f3a\u7248\u7684 <code>COPY</code>\uff0c\u652f\u6301\u5c06\u8fdc\u7a0b URL \u7684\u8d44\u6e90\u52a0\u5165\u5230\u955c\u50cf\u7684\u6587\u4ef6\u7cfb\u7edf\u3002\u540c\u6837\u4e5f\u652f\u6301 exec \u548c shell \u4e24\u79cd\u683c\u5f0f\u7528\u6cd5\uff1a \u00a0 * exec \u683c\u5f0f\u7528\u6cd5\uff1a</p> <pre><code>ADD [\"&lt;src&gt;\",... \"&lt;dest&gt;\"]\n</code></pre> <p>\uff0c\u7279\u522b\u9002\u5408\u8def\u5f84\u4e2d\u5e26\u6709\u7a7a\u683c\u7684\u60c5\u51b5</p> <ul> <li>shell \u683c\u5f0f\u7528\u6cd5\uff1a<code>ADD &lt;src&gt;... &lt;dest&gt;</code></li> </ul> <p>\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90\uff0c\u6bd4\u5982\uff1a</p> <pre><code>ADD http://foo.com/bar.go /tmp/main.go\n</code></pre> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u5bf9\u4e8e\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90\u7684\u60c5\u51b5\uff0c\u7531\u4e8e ADD \u6307\u4ee4\u4e0d\u652f\u6301\u8ba4\u8bc1\uff0c\u5982\u679c\u4ece\u8fdc\u7a0b\u83b7\u53d6\u8d44\u6e90\u9700\u8981\u8ba4\u8bc1\uff0c\u5219\u53ea\u80fd\u4f7f\u7528<code>RUN wget</code> \u6216 <code>RUN curl</code> \u66ff\u4ee3\u4e86\u3002</p> <p>\u6709\u80fd\u529b\u81ea\u52a8\u89e3\u538b\u6587\u4ef6\uff0c\u6bd4\u5982\uff1a</p> <pre><code>ADD /foo.tar.gz /tmp/\n</code></pre> <p>\u4e0a\u8ff0\u6307\u4ee4\u4f1a\u4f7f foo.tar.gz \u538b\u7f29\u6587\u4ef6\u89e3\u538b\u5230\u5bb9\u5668\u7684 /tmp \u76ee\u5f55\u3002</p> <p>\u4e0d\u8fc7\u4e00\u822c\u6765\u8bf4\u867d\u7136 ADD \u6307\u4ee4\u652f\u6301\u4ece\u8fdc\u7a0b\u83b7\u53d6\u8d44\u6e90\uff0c\u4f46\u662f\u5e76\u4e0d\u63a8\u8350\u4f7f\u7528\uff0c\u800c\u662f\u5efa\u8bae\u4f7f\u7528 RUN \u6307\u4ee4\u53bb\u6267\u884c wget \u6216 curl \u547d\u4ee4\u3002</p> <p>\u6bd4\u5982\u524d\u9762\u6211\u4eec\u5b9a\u5236\u7684 nginx \u955c\u50cf\uff0c\u53ef\u4ee5\u6539\u6210\u4e0b\u9762\u7684\u5f62\u5f0f\uff1a</p> <pre><code>$ echo 'Hello Docker!' &gt; index.html\n</code></pre> <p>\u7136\u540e\u4fee\u6539 Dockerfile\uff1a</p> <pre><code>FROM nginx\n# COPY\u6216\u8005ADD\u6307\u4ee4\u90fd\u53ef\u4ee5\nCOPY index.html /user/share/nginx/html/index.html\n</code></pre>"},{"location":"docker/dockerfile_usage/#_35","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p><code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code>\u6307\u4ee4\u7684\u7528\u6cd5\u975e\u5e38\u76f8\u4f3c\uff0c\u5177\u4f53\u6ce8\u610f\u4e8b\u9879\u5982\u4e0b\uff1a</p> <ul> <li>\u6e90\u8def\u5f84\u53ef\u4ee5\u6709\u591a\u4e2a</li> <li>\u6e90\u8def\u5f84\u662f\u76f8\u5bf9\u4e8e\u6267\u884c build \u7684\u76f8\u5bf9\u8def\u5f84</li> <li>\u6e90\u8def\u5f84\u5982\u679c\u662f\u672c\u5730\u8def\u5f84\uff0c\u5fc5\u987b\u662f\u6784\u5efa\u4e0a\u4e0b\u6587\u4e2d\u7684\u8def\u5f84</li> <li>\u6e90\u8def\u5f84\u5982\u679c\u662f\u4e00\u4e2a\u76ee\u5f55\uff0c\u5219\u8be5\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u5185\u5bb9\u90fd\u5c06\u88ab\u52a0\u5165\u5230\u5bb9\u5668\uff0c\u4f46\u662f\u8be5\u76ee\u5f55\u672c\u8eab\u4e0d\u4f1a</li> <li>\u76ee\u6807\u8def\u5f84\u5fc5\u987b\u662f\u7edd\u5bf9\u8def\u5f84\uff0c\u6216\u76f8\u5bf9\u4e8e WORKDIR \u7684\u76f8\u5bf9\u8def\u5f84</li> <li>\u76ee\u6807\u8def\u5f84\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u4f1a\u521b\u5efa\u76f8\u5e94\u7684\u5b8c\u6574\u8def\u5f84</li> <li>\u76ee\u6807\u8def\u5f84\u5982\u679c\u4e0d\u662f\u4e00\u4e2a\u6587\u4ef6\uff0c\u5219\u5fc5\u987b\u4f7f\u7528/\u7ed3\u675f</li> <li>\u8def\u5f84\u4e2d\u53ef\u4ee5\u4f7f\u7528\u901a\u914d\u7b26</li> </ul>"},{"location":"docker/dockerfile_usage/#_36","title":"\u6784\u5efa\u955c\u50cf","text":"<p>\u73b0\u5728\u8ba9\u6211\u4eec\u518d\u56de\u5230\u4e4b\u524d\u5b9a\u5236\u7684 nginx \u955c\u50cf\u7684 Dockerfile \u6765\u3002\u73b0\u5728\u6211\u4eec\u660e\u767d\u4e86\u8fd9\u4e2a Dockerfile \u7684\u5185\u5bb9\uff0c\u90a3\u4e48\u8ba9\u6211\u4eec\u6765\u6784\u5efa\u8fd9\u4e2a\u955c\u50cf\u5427\u3002\u5728 Dockerfile \u6587\u4ef6\u6240\u5728\u76ee\u5f55\u6267\u884c\uff1a</p> <pre><code>$ docker build -t nginx:v1 .\nSending build context to Docker daemon 048 kB\nStep 1 : FROM nginx\n ---&gt; e43d811ce2f4\nStep 2 : RUN echo 'Hello, Docker!' &gt; /usr/share/nginx/html/index.html\n ---&gt; Running in 9cdc27646c7b\n ---&gt; 44aa4490ce2c\nRemoving intermediate container 9cdc27646c7b\nSuccessfully built 44aa4490ce2c\n</code></pre> <p>\u4ece\u547d\u4ee4\u7684\u8f93\u51fa\u7ed3\u679c\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u6e05\u6670\u7684\u770b\u5230\u955c\u50cf\u7684\u6784\u5efa\u8fc7\u7a0b\u3002\u5728 Step 2 \u4e2d\uff0c\u5982\u540c\u6211\u4eec\u4e4b\u524d\u6240\u8bf4\u7684\u90a3\u6837\uff0cRUN \u6307\u4ee4\u542f\u52a8\u4e86\u4e00\u4e2a\u5bb9\u5668 9cdc27646c7b\uff0c\u6267\u884c\u4e86\u6240\u8981\u6c42\u7684\u547d\u4ee4\uff0c\u5e76\u6700\u540e\u63d0\u4ea4\u4e86\u8fd9\u4e00\u5c42 44aa4490ce2c\uff0c\u968f\u540e\u5220\u9664\u4e86\u6240\u7528\u5230\u7684\u8fd9\u4e2a\u5bb9\u5668 9cdc27646c7b\u3002\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u4e86 <code>docker build</code> \u547d\u4ee4\u8fdb\u884c\u955c\u50cf\u6784\u5efa\u3002\u5176\u683c\u5f0f\u4e3a\uff1a</p> <pre><code>$ docker build [\u9009\u9879] &lt;\u4e0a\u4e0b\u6587\u8def\u5f84/URL/-&gt;\n</code></pre> <p>\u5728\u8fd9\u91cc\u6211\u4eec\u901a\u8fc7 <code>-t</code> \u53c2\u6570\u6307\u5b9a\u4e86\u6700\u7ec8\u955c\u50cf\u7684\u540d\u79f0 <code>nginx:v1</code>\uff0c\u6784\u5efa\u6210\u529f\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a\u955c\u50cf\u6765\u8fd0\u884c\u5bb9\u5668\u4e86\u3002</p>"},{"location":"docker/dockerfile_usage/#_37","title":"\u6784\u5efa\u4e0a\u4e0b\u6587","text":"<p>\u5982\u679c\u6211\u4eec\u4ed4\u7ec6\u89c2\u5bdf\u7684\u8bdd\u4f1a\u770b\u5230 <code>docker build</code> \u547d\u4ee4\u6700\u540e\u6709\u4e00\u4e2a <code>.</code>\u3002<code>.</code> \u8868\u793a\u5f53\u524d\u76ee\u5f55\uff0c\u800c Dockerfile \u5c31\u5728\u5f53\u524d\u76ee\u5f55\uff0c\u56e0\u6b64\u4e0d\u5c11\u521d\u5b66\u8005\u4ee5\u4e3a\u8fd9\u4e2a\u8def\u5f84\u662f\u5728\u6307\u5b9a Dockerfile \u6240\u5728\u8def\u5f84\uff0c\u8fd9\u4e48\u7406\u89e3\u5176\u5b9e\u662f\u4e0d\u51c6\u786e\u7684\u3002\u5982\u679c\u5bf9\u5e94\u4e0a\u9762\u7684\u547d\u4ee4\u683c\u5f0f\uff0c\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0\uff0c\u8fd9\u662f\u5728\u6307\u5b9a\u4e0a\u4e0b\u6587\u8def\u5f84\u3002\u90a3\u4e48\u4ec0\u4e48\u662f\u4e0a\u4e0b\u6587\u5462\uff1f</p> <p>\u9996\u5148\u6211\u4eec\u8981\u7406\u89e3 <code>docker build</code> \u7684\u5de5\u4f5c\u539f\u7406\u3002Docker \u5728\u8fd0\u884c\u65f6\u5206\u4e3a Docker Daemon \u548c\u5ba2\u6237\u7aef\u5de5\u5177\u3002Docker \u7684\u5f15\u64ce\u63d0\u4f9b\u4e86\u4e00\u7ec4 REST API\uff0c\u88ab\u79f0\u4e3a Docker Remote API\uff0c\u800c\u5982 docker \u547d\u4ee4\u8fd9\u6837\u7684\u5ba2\u6237\u7aef\u5de5\u5177\uff0c\u5219\u662f\u901a\u8fc7\u8fd9\u7ec4 API \u4e0e Docker \u5f15\u64ce\u4ea4\u4e92\uff0c\u4ece\u800c\u5b8c\u6210\u5404\u79cd\u529f\u80fd\u3002\u56e0\u6b64\uff0c\u867d\u7136\u8868\u9762\u4e0a\u6211\u4eec\u597d\u50cf\u662f\u5728\u672c\u673a\u6267\u884c\u5404\u79cd docker \u529f\u80fd\uff0c\u4f46\u5b9e\u9645\u4e0a\uff0c\u4e00\u5207\u90fd\u662f\u4f7f\u7528\u7684\u8fdc\u7a0b\u8c03\u7528\u5f62\u5f0f\u5728\u670d\u52a1\u7aef\uff08Docker \u5f15\u64ce\uff09\u5b8c\u6210\u3002\u4e5f\u56e0\u4e3a\u8fd9\u79cd C/S \u8bbe\u8ba1\uff0c\u8ba9\u6211\u4eec\u64cd\u4f5c\u8fdc\u7a0b\u670d\u52a1\u5668\u7684 Docker \u5f15\u64ce\u53d8\u5f97\u8f7b\u800c\u6613\u4e3e\u3002</p> <p>\u5f53\u6211\u4eec\u8fdb\u884c\u955c\u50cf\u6784\u5efa\u7684\u65f6\u5019\uff0c\u5e76\u975e\u6240\u6709\u5b9a\u5236\u90fd\u4f1a\u901a\u8fc7 RUN \u6307\u4ee4\u5b8c\u6210\uff0c\u7ecf\u5e38\u4f1a\u9700\u8981\u5c06\u4e00\u4e9b\u672c\u5730\u6587\u4ef6\u590d\u5236\u8fdb\u955c\u50cf\uff0c\u6bd4\u5982\u901a\u8fc7 <code>COPY</code> \u6307\u4ee4\u3001<code>ADD</code> \u6307\u4ee4\u7b49\u3002\u800c <code>docker build</code> \u547d\u4ee4\u6784\u5efa\u955c\u50cf\uff0c\u5176\u5b9e\u5e76\u975e\u5728\u672c\u5730\u6784\u5efa\uff0c\u800c\u662f\u5728\u670d\u52a1\u7aef\uff0c\u4e5f\u5c31\u662f Docker \u5f15\u64ce\u4e2d\u6784\u5efa\u7684\u3002\u90a3\u4e48\u5728\u8fd9\u79cd<code>\u5ba2\u6237\u7aef/\u670d\u52a1\u7aef</code>\u7684\u67b6\u6784\u4e2d\uff0c\u5982\u4f55\u624d\u80fd\u8ba9\u670d\u52a1\u7aef\u83b7\u5f97\u672c\u5730\u6587\u4ef6\u5462\uff1f</p> <p>\u8fd9\u5c31\u5f15\u5165\u4e86<code>\u4e0a\u4e0b\u6587</code>\u7684\u6982\u5ff5\u3002\u5f53\u6784\u5efa\u7684\u65f6\u5019\uff0c\u7528\u6237\u4f1a\u6307\u5b9a\u6784\u5efa\u955c\u50cf\u4e0a\u4e0b\u6587\u7684\u8def\u5f84\uff0cdocker build \u547d\u4ee4\u5f97\u77e5\u8fd9\u4e2a\u8def\u5f84\u540e\uff0c\u4f1a\u5c06\u8def\u5f84\u4e0b\u7684\u6240\u6709\u5185\u5bb9\u6253\u5305\uff0c\u7136\u540e\u4e0a\u4f20\u7ed9 Docker \u5f15\u64ce\u3002\u8fd9\u6837 Docker \u5f15\u64ce\u6536\u5230\u8fd9\u4e2a\u4e0a\u4e0b\u6587\u5305\u540e\uff0c\u5c55\u5f00\u5c31\u4f1a\u83b7\u5f97\u6784\u5efa\u955c\u50cf\u6240\u9700\u7684\u4e00\u5207\u6587\u4ef6\u3002\u5982\u679c\u5728 Dockerfile \u4e2d\u8fd9\u4e48\u5199\uff1a</p> <pre><code>COPY ./package.json /app/\n</code></pre> <p>\u8fd9\u5e76\u4e0d\u662f\u8981\u590d\u5236\u6267\u884c docker build \u547d\u4ee4\u6240\u5728\u7684\u76ee\u5f55\u4e0b\u7684 package.json\uff0c\u4e5f\u4e0d\u662f\u590d\u5236 Dockerfile \u6240\u5728\u76ee\u5f55\u4e0b\u7684 package.json\uff0c\u800c\u662f\u590d\u5236 <code>\u4e0a\u4e0b\u6587\uff08context\uff09</code> \u76ee\u5f55\u4e0b\u7684 package.json\u3002</p> <p>\u56e0\u6b64\uff0c<code>COPY</code> \u8fd9\u7c7b\u6307\u4ee4\u4e2d\u7684\u6e90\u6587\u4ef6\u7684\u8def\u5f84\u90fd\u662f<code>\u76f8\u5bf9\u8def\u5f84</code>\u3002\u8fd9\u4e5f\u662f\u521d\u5b66\u8005\u7ecf\u5e38\u4f1a\u95ee\u7684\u4e3a\u4ec0\u4e48 </p> <pre><code>COPY ../package.json /app\n</code></pre> <p>\u6216\u8005 <code>COPY /opt/xxxx /app</code> \u65e0\u6cd5\u5de5\u4f5c\u7684\u539f\u56e0\uff0c\u56e0\u4e3a\u8fd9\u4e9b\u8def\u5f84\u5df2\u7ecf\u8d85\u51fa\u4e86\u4e0a\u4e0b\u6587\u7684\u8303\u56f4\uff0cDocker \u5f15\u64ce\u65e0\u6cd5\u83b7\u5f97\u8fd9\u4e9b\u4f4d\u7f6e\u7684\u6587\u4ef6\u3002\u5982\u679c\u771f\u7684\u9700\u8981\u90a3\u4e9b\u6587\u4ef6\uff0c\u5e94\u8be5\u5c06\u5b83\u4eec\u590d\u5236\u5230\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\u53bb\u3002</p> <p>\u73b0\u5728\u5c31\u53ef\u4ee5\u7406\u89e3\u521a\u624d\u7684\u547d\u4ee4</p> <pre><code>docker build -t nginx:v1 .\n</code></pre> <p>\u4e2d\u7684\u8fd9\u4e2a<code>.</code>\uff0c\u5b9e\u9645\u4e0a\u662f\u5728\u6307\u5b9a\u4e0a\u4e0b\u6587\u7684\u76ee\u5f55\uff0cdocker build \u547d\u4ee4\u4f1a\u5c06\u8be5\u76ee\u5f55\u4e0b\u7684\u5185\u5bb9\u6253\u5305\u4ea4\u7ed9 Docker \u5f15\u64ce\u4ee5\u5e2e\u52a9\u6784\u5efa\u955c\u50cf\u3002</p> <p>\u5982\u679c\u89c2\u5bdf docker build \u8f93\u51fa\uff0c\u6211\u4eec\u5176\u5b9e\u5df2\u7ecf\u770b\u5230\u4e86\u8fd9\u4e2a\u53d1\u9001\u4e0a\u4e0b\u6587\u7684\u8fc7\u7a0b\uff1a</p> <pre><code>$ docker build -t nginx:v1 .\nSending build context to Docker daemon 048 kB\n...\n</code></pre> <p>\u7406\u89e3\u6784\u5efa\u4e0a\u4e0b\u6587\u5bf9\u4e8e\u955c\u50cf\u6784\u5efa\u662f\u5f88\u91cd\u8981\u7684\uff0c\u53ef\u4ee5\u907f\u514d\u72af\u4e00\u4e9b\u4e0d\u5e94\u8be5\u7684\u9519\u8bef\u3002\u6bd4\u5982\u6709\u4e9b\u521d\u5b66\u8005\u5728\u53d1\u73b0 COPY /opt/xxxx /app \u4e0d\u5de5\u4f5c\u540e\uff0c\u4e8e\u662f\u5e72\u8106\u5c06 Dockerfile \u653e\u5230\u4e86\u786c\u76d8\u6839\u76ee\u5f55\u53bb\u6784\u5efa\uff0c\u7ed3\u679c\u53d1\u73b0 docker build \u6267\u884c\u65f6\u53d1\u9001\u4e00\u4e2a\u51e0\u5341 GB \u7684\u4e1c\u897f\uff0c\u6781\u4e3a\u7f13\u6162\u800c\u4e14\u5f88\u5bb9\u6613\u6784\u5efa\u5931\u8d25\u3002\u90a3\u662f\u56e0\u4e3a\u8fd9\u79cd\u505a\u6cd5\u662f\u5728\u8ba9 docker build \u6253\u5305\u6574\u4e2a\u786c\u76d8\uff0c\u8fd9\u663e\u7136\u662f\u4f7f\u7528\u9519\u8bef\u3002</p> <p>\u4e00\u822c\u6765\u8bf4\uff0c\u5e94\u8be5\u4f1a\u5c06 Dockerfile \u7f6e\u4e8e\u4e00\u4e2a\u7a7a\u76ee\u5f55\u4e0b\uff0c\u6216\u8005\u9879\u76ee\u6839\u76ee\u5f55\u4e0b\u3002\u5982\u679c\u8be5\u76ee\u5f55\u4e0b\u6ca1\u6709\u6240\u9700\u6587\u4ef6\uff0c\u90a3\u4e48\u5e94\u8be5\u628a\u6240\u9700\u6587\u4ef6\u590d\u5236\u4e00\u4efd\u8fc7\u6765\u3002\u5982\u679c\u76ee\u5f55\u4e0b\u6709\u4e9b\u4e1c\u897f\u786e\u5b9e\u4e0d\u5e0c\u671b\u6784\u5efa\u65f6\u4f20\u7ed9 Docker \u5f15\u64ce\uff0c\u90a3\u4e48\u53ef\u4ee5\u7528 .gitignore \u4e00\u6837\u7684\u8bed\u6cd5\u5199\u4e00\u4e2a <code>.dockerignore</code>\uff0c\u8be5\u6587\u4ef6\u662f\u7528\u4e8e\u5254\u9664\u4e0d\u9700\u8981\u4f5c\u4e3a\u4e0a\u4e0b\u6587\u4f20\u9012\u7ed9 Docker \u5f15\u64ce\u7684\u3002</p> <p>\u90a3\u4e48\u4e3a\u4ec0\u4e48\u4f1a\u6709\u4eba\u8bef\u4ee5\u4e3a <code>.</code> \u662f\u6307\u5b9a Dockerfile \u6240\u5728\u76ee\u5f55\u5462\uff1f\u8fd9\u662f\u56e0\u4e3a\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u4e0d\u989d\u5916\u6307\u5b9a Dockerfile \u7684\u8bdd\uff0c\u4f1a\u5c06\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e0b\u7684\u540d\u4e3a Dockerfile \u7684\u6587\u4ef6\u4f5c\u4e3a Dockerfile\u3002\u8fd9\u53ea\u662f\u9ed8\u8ba4\u884c\u4e3a\uff0c\u5b9e\u9645\u4e0a Dockerfile \u7684\u6587\u4ef6\u540d\u5e76\u4e0d\u8981\u6c42\u5fc5\u987b\u4e3a Dockerfile\uff0c\u800c\u4e14\u5e76\u4e0d\u8981\u6c42\u5fc5\u987b\u4f4d\u4e8e\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\uff0c\u6bd4\u5982\u53ef\u4ee5\u7528<code>-f ../Dockerfile.Dev</code>\u53c2\u6570\u6307\u5b9a\u67d0\u4e2a\u6587\u4ef6\u4f5c\u4e3a Dockerfile\u3002</p> <p>\u5f53\u7136\uff0c\u4e00\u822c\u5927\u5bb6\u4e60\u60ef\u6027\u7684\u4f1a\u4f7f\u7528\u9ed8\u8ba4\u7684\u6587\u4ef6\u540d Dockerfile\uff0c\u4ee5\u53ca\u4f1a\u5c06\u5176\u7f6e\u4e8e\u955c\u50cf\u6784\u5efa\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\u3002</p>"},{"location":"docker/dockerfile_usage/#_38","title":"\u63a8\u9001\u955c\u50cf","text":"<p>\u4e0a\u9762\u6211\u4eec\u8bb2\u5230\u4e86 Dockerfile \u7684\u57fa\u672c\u5199\u6cd5\u4ee5\u53ca\u6784\u5efa\u955c\u50cf\u7684\u65f6\u5019\u4e00\u4e9b\u6ce8\u610f\u4e8b\u9879\uff0c\u90a3\u4e48\u955c\u50cf\u6784\u5efa\u5b8c\u6210\u540e\uff0c\u5982\u4f55\u628a\u6211\u4eec\u7684\u955c\u50cf\u7ed9\u5230\u522b\u4eba\u4f7f\u7528\u5462\uff1f\u7b2c\u4e00\u79cd\u65b9\u6cd5\u5c31\u662f\u5229\u7528 Docker \u5b98\u65b9\u63d0\u4f9b\u7684\u516c\u5171\u7684 Docker Hub \u4ed3\u5e93\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u955c\u50cf\u63a8\u9001\u4e0a\u53bb\uff0c\u7136\u540e\u522b\u4eba\u5c31\u53ef\u4ee5\u76f4\u63a5\u62c9\u53d6\u955c\u50cf\u3002</p>"},{"location":"docker/dockerfile_usage/#_39","title":"\u6ce8\u518c","text":"<p>\u9996\u5148\u9700\u8981 https://cloud.docker.com \u514d\u8d39\u6ce8\u518c\u4e00\u4e2a Docker \u8d26\u53f7\u3002</p>"},{"location":"docker/dockerfile_usage/#_40","title":"\u767b\u5f55","text":"<p>\u7136\u540e\u901a\u8fc7\u6267\u884c<code>docker login</code>\u547d\u4ee4\u4ea4\u4e92\u5f0f\u7684\u8f93\u5165\u7528\u6237\u540d\u53ca\u5bc6\u7801\u6765\u5b8c\u6210\u5728\u547d\u4ee4\u884c\u754c\u9762\u767b\u5f55 Docker Hub\u3002</p> <pre><code>$ docker login\nLogin with your Docker ID to push and pull images from Docker Hub. If you don't have a Docker ID, head over to https://hub.docker.com to create one.\nUsername: cnych\nPassword:\nWARNING! Your password will be stored unencrypted in /root/.docker/config.json.\nConfigure a credential helper to remove this warning. See\nhttps://docs.docker.com/engine/reference/commandline/login/#credentials-store\n\nLogin Succeeded\n</code></pre>"},{"location":"docker/dockerfile_usage/#_41","title":"\u6ce8\u9500","text":"<p>\u4f60\u53ef\u4ee5\u901a\u8fc7<code>docker logout</code>\u9000\u51fa\u767b\u5f55\u3002</p>"},{"location":"docker/dockerfile_usage/#_42","title":"\u63a8\u9001\u955c\u50cf","text":"<p>\u7528\u6237\u5728\u767b\u5f55\u540e\u53ef\u4ee5\u901a\u8fc7<code>docker push</code>\u547d\u4ee4\u6765\u5c06\u81ea\u5df1\u7684\u955c\u50cf\u63a8\u9001\u5230 Docker Hub\u3002\u4ee5\u4e0b\u547d\u4ee4\u4e2d\u7684 username \u8bf7\u66ff\u6362\u4e3a\u4f60\u7684 Docker \u8d26\u53f7\u7528\u6237\u540d\u3002</p> <pre><code>$ docker tag ubuntu:10 username/ubuntu:10\n$ docker image ls\n\nREPOSITORY                                               TAG                    IMAGE ID            CREATED             SIZE\nubuntu                                                   10                  275d79972a86        6 days ago          6MB\nusername/ubuntu                                          10                  275d79972a86        6 days ago          6MB\n$ docker push username/ubuntu:10\n</code></pre>"},{"location":"docker/dockerfile_usage/#_43","title":"\u79c1\u6709\u4ed3\u5e93","text":"<p>\u6709\u65f6\u5019\u6211\u4eec\u53ef\u80fd\u5e0c\u671b\u6211\u4eec\u7684\u955c\u50cf\u53ea\u5728\u5c40\u57df\u7f51\u8303\u56f4\u5185\u4f7f\u7528\uff0c\u4e0d\u5e0c\u671b\u63a8\u9001\u5230 Docker Hub \u8fd9\u6837\u7684\u516c\u5171\u4ed3\u5e93\uff0c\u90a3\u4e48\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u672c\u5730\u4ed3\u5e93\u4f9b\u79c1\u4eba\u4f7f\u7528\u3002</p> <p><code>docker-registry</code> \u5c31\u662f\u662f\u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e2a\u79c1\u6709\u4ed3\u5e93\u5de5\u5177\uff0c\u53ef\u4ee5\u7528\u4e8e\u5b58\u50a8\u79c1\u6709\u7684\u955c\u50cf\u4ed3\u5e93\u3002\u540c\u6837\u7684\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u83b7\u53d6\u5b98\u65b9 registry \u955c\u50cf\u6765\u76f4\u63a5\u8fd0\u884c\uff1a</p> <pre><code>$ docker run -d -p 5000:5000 --name registry registry:2\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u4f7f\u7528\u5b98\u65b9\u7684 registry \u955c\u50cf\u6765\u542f\u52a8\u79c1\u6709\u4ed3\u5e93\u5bb9\u5668\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4ed3\u5e93\u4f1a\u88ab\u521b\u5efa\u5728\u5bb9\u5668\u7684<code>/var/lib/registry</code>\u76ee\u5f55\u4e0b\u3002\u4f60\u53ef\u4ee5\u901a\u8fc7 <code>-v</code> \u53c2\u6570\u6765\u5c06\u955c\u50cf\u6587\u4ef6\u5b58\u653e\u5728\u672c\u5730\u7684\u6307\u5b9a\u8def\u5f84\u3002\u4f8b\u5982\u4e0b\u9762\u7684\u4f8b\u5b50\u5c06\u4e0a\u4f20\u7684\u955c\u50cf\u653e\u5230\u672c\u5730\u7684 <code>/opt/data/registry</code> \u76ee\u5f55:</p> <pre><code>$ docker run -d \\\\\n    -p 5000:5000 \\\\\n    -v /opt/data/registry:/var/lib/registry \\\\\n    registry:2\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u8fd0\u884c\u4e86\u4e00\u4e2a\u6570\u636e\u6301\u4e45\u5316\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u3002</p> <p>\u521b\u5efa\u597d\u79c1\u6709\u4ed3\u5e93\u4e4b\u540e\uff0c\u7136\u540e\u53ef\u4ee5\u4f7f\u7528<code>docker tag</code>\u6765\u6807\u8bb0\u4e00\u4e2a\u955c\u50cf\uff0c\u7136\u540e\u63a8\u9001\u5b83\u5230\u4ed3\u5e93\u3002\u6bd4\u5982\u79c1\u6709\u4ed3\u5e93\u5730\u5740\u4e3a<code>127.0.0.1:5000</code>\u3002\u5148\u5728\u672c\u673a\u67e5\u770b\u5df2\u6709\u7684\u955c\u50cf\u3002</p> <pre><code>$ docker images\nREPOSITORY                        TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nubuntu                            latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u4f7f\u7528<code>docker tag</code>\u5c06 ubuntu:latest \u8fd9\u4e2a\u955c\u50cf\u6807\u8bb0\u4e3a </p> <pre><code>11:5000/ubuntu:latest\n</code></pre> <p>:</p> <pre><code>$ docker tag ubuntu:latest 11:5000/ubuntu:latest\n$ docker images\nREPOSITORY                        TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nubuntu                            latest              ba5877dc9bec        6 weeks ago         17 MB\n11:5000/ubuntu:latest      latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u7136\u540e\u5c31\u53ef\u4ee5\u4f7f\u7528<code>docker push</code>\u4e0a\u4f20\u6807\u8bb0\u7684\u955c\u50cf:</p> <pre><code>$ docker push 11:5000/ubuntu:latest\nThe push refers to repository [11:5000/ubuntu]\n373a30c24545: Pushed\na9148f5200b0: Pushed\ncdd3de0940ab: Pushedfc56279bbb33: Pushed\nb38367233d37: Pushed\n2aebd096e0e2: Pushed\nlatest: digest: sha256:fe4277621f10b5026266932ddf760f5a756d2facd505a94d2da12f4f52f71f5a size: 1568\n</code></pre> <p>\u6b64\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528 registry \u4ed3\u5e93\u63d0\u4f9b\u7684 API \u6765\u67e5\u770b\u4ed3\u5e93\u4e2d\u7684\u955c\u50cf\uff1a</p> <pre><code>$ curl 11:5000/v2/_catalog\n{\"repositories\":[\"ubuntu\"]}\n</code></pre> <p>\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230 {\"repositories\":[\"ubuntu\"]}\uff0c\u8868\u660e\u955c\u50cf\u5df2\u7ecf\u88ab\u6210\u529f\u4e0a\u4f20\u4e86\u3002</p> <p>\u5148\u5220\u9664\u5df2\u6709\u955c\u50cf\uff0c\u518d\u5c1d\u8bd5\u4ece\u79c1\u6709\u4ed3\u5e93\u4e2d\u4e0b\u8f7d\u8fd9\u4e2a\u955c\u50cf\u3002</p> <pre><code>$ docker image rm 11:5000/ubuntu:latest\n$ docker pull 11:5000/ubuntu:latest\nPulling repository 11:5000/ubuntu:latest\nba5877dc9bec: Download complete\n511136ea3c5a: Download complete\n9bad880da3d2: Download complete\n25f11f5fb0cb: Download complete\nebc34468f71d: Download complete\n2318d26665ef: Download complete\n$ docker image ls\nREPOSITORY                         TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\n11:5000/ubuntu:latest       latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u628a\u955c\u50cf\u4e0a\u4f20\u5230\u4e86\u79c1\u6709\u4ed3\u5e93\u4e2d\u7684\u5b8c\u6574\u8fc7\u7a0b\u3002</p>"},{"location":"docker/dockerfile_usage/#_44","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p>\u5982\u679c\u4f60\u4e0d\u60f3\u4f7f\u7528 <code>127.0.0.1:5000</code> \u4f5c\u4e3a\u4ed3\u5e93\u5730\u5740\uff0c\u6bd4\u5982\u60f3\u8ba9\u672c\u7f51\u6bb5\u7684\u5176\u4ed6\u4e3b\u673a\u4e5f\u80fd\u628a\u955c\u50cf\u63a8\u9001\u5230\u79c1\u6709\u4ed3\u5e93\u3002\u4f60\u5c31\u5f97\u628a\u4f8b\u5982 <code>192.168.199.100:5000</code> \u8fd9\u6837\u7684\u5185\u7f51\u5730\u5740\u4f5c\u4e3a\u79c1\u6709\u4ed3\u5e93\u5730\u5740\uff0c\u8fd9\u65f6\u4f60\u4f1a\u53d1\u73b0\u65e0\u6cd5\u6210\u529f\u63a8\u9001\u955c\u50cf\u3002</p> <p>\u8fd9\u662f\u56e0\u4e3a Docker \u9ed8\u8ba4\u4e0d\u5141\u8bb8\u975e HTTPS \u65b9\u5f0f\u63a8\u9001\u955c\u50cf\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Docker \u7684\u914d\u7f6e\u9009\u9879\u6765\u53d6\u6d88\u8fd9\u4e2a\u9650\u5236\uff0c\u6211\u4eec\u8fd9\u91cc\u662f CentOS 7 \u7cfb\u7edf\uff0c\u540c\u6837\u8fd8\u662f\u7f16\u8f91\u6587\u4ef6</p> <pre><code>/etc/docker/daemon.json\n</code></pre> <p>\uff0c\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>{\n  \"registry-mirror\": [\n    \"https://registry.docker-cn.com\"\n  ],\n  \"insecure-registries\": [\n    \"111100:5000\"\n  ]\n}\n</code></pre> <p>\u5176\u4e2d\u7684<code>insecure-registries</code>\u5c31\u662f\u6211\u4eec\u6dfb\u52a0\u7684\u5185\u5bb9\uff0c\u7136\u540e\u91cd\u542f Docker \u4e4b\u540e\u5c31\u53ef\u4ee5\u5728\u5c40\u57df\u7f51\u5185\u4f7f\u7528\u6211\u4eec\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u4e86\u3002</p> <p>\u9ed8\u8ba4\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u53ef\u4ee5\u6ee1\u8db3\u6211\u4eec\u7684\u5f88\u591a\u9700\u6c42\uff0c\u4f46\u662f\u5f80\u5f80\u5728\u4f01\u4e1a\u4e2d\u4f7f\u7528\u7684\u8bdd\u8fd8\u6709\u5f88\u5b89\u5168\u6027\u65b9\u9762\u7684\u529f\u80fd\u7684\u7f3a\u5931\uff0c\u6bd4\u5982\u6743\u9650\u7ba1\u7406\u4e4b\u7c7b\u7684\uff0c\u8fd9\u5bf9\u4e8e\u4f01\u4e1a\u6765\u8bf4\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u4e0d\u8fc7 registry \u5bf9\u4e8e\u6743\u9650\u7ba1\u7406\u8fd9\u4e00\u5757\u505a\u4e86\u4e00\u4e2a\u5bf9\u5916\u66b4\u9732\u7684\u63a5\u53e3\uff0c\u53ea\u8981\u6211\u4eec\u5b9e\u73b0\u4ed6\u66b4\u9732\u7684\u5b89\u5168\u63a5\u53e3\u5c31\u53ef\u4ee5\u6765\u5b9e\u73b0\u6743\u9650\u7ba1\u7406\u76f8\u5173\u7684\u63a5\u53e3\uff0c\u5176\u4e2d\u6ce8\u660e\u7684\u5f00\u6e90\u955c\u50cf\u7ba1\u7406\u8f6f\u4ef6 Harbor \u5c31\u662f\u8fd9\u7c7b\u5e94\u7528\u7684\u4f7c\u4f7c\u8005\uff0c\u6211\u4eec\u8fd8\u5728\u540e\u9762\u7684\u8bfe\u7a0b\u4e2d\u548c\u5927\u5bb6\u5b66\u4e60 Harbor \u7684\u4e00\u4e2a\u4f7f\u7528\u3002\ue3c9</p>"},{"location":"docker/dockerfile_usage/#dockerfile_4","title":"Dockerfile","text":"<p>\u4f7f\u7528 Dockerfile \u5b9a\u5236\u955c\u50cf</p> <p></p> <p>\u955c\u50cf\u7684\u5b9a\u5236\u5b9e\u9645\u4e0a\u5c31\u662f\u5b9a\u5236\u955c\u50cf\u7684\u6bcf\u4e00\u5c42\u6240\u6dfb\u52a0\u7684\u914d\u7f6e\u3001\u6587\u4ef6\u7b49\u4fe1\u606f\uff0c\u5b9e\u9645\u4e0a\u5f53\u6211\u4eec\u5728\u4e00\u4e2a\u5bb9\u5668\u4e2d\u6dfb\u52a0\u6216\u8005\u4fee\u6539\u4e86\u4e00\u4e9b\u6587\u4ef6\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7<code>docker commit</code>\u547d\u4ee4\u6765\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u955c\u50cf\uff0c\u4f46\u662f\u8fd9\u4e2a\u65b9\u6cd5\u4e0d\u591f\u76f4\u89c2\uff0c\u6ca1\u529e\u6cd5\u8ffd\u6eaf\u6211\u4eec\u955c\u50cf\u91cc\u9762\u5230\u5e95\u6709\u54ea\u4e9b\u5185\u5bb9\uff0c\u6240\u4ee5\u5b9e\u9645\u5b9a\u5236\u955c\u50cf\u7684\u8fc7\u7a0b\u6211\u4eec\u5f88\u5c11\u91c7\u7528\u8fd9\u79cd\u65b9\u5f0f\u3002\u800c\u662f\u4f7f\u7528\u4e00\u4e2a\u540d\u4e3a <code>Dockerfile</code> \u7684\u6587\u672c\u6587\u4ef6\u6765\u8fdb\u884c\u955c\u50cf\u5b9a\u5236\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u955c\u50cf\u7684\u6bcf\u4e00\u5c42\u4fee\u6539\u3001\u5b89\u88c5\u3001\u6784\u5efa\u3001\u64cd\u4f5c\u7684\u547d\u4ee4\u90fd\u5199\u5165\u5230\u8fd9\u4e2a\u6587\u4ef6\u4e2d\uff0c\u4e00\u884c\u5c31\u5bf9\u5e94\u955c\u50cf\u7684\u4e00\u5c42\uff0c\u8fd9\u79cd\u65b9\u6cd5\u663e\u7136\u8981\u66f4\u9ad8\u7ea7\uff0c\u56e0\u4e3a\u6211\u4eec\u6709\u4e00\u4e2a\u6587\u4ef6\u6765\u76f4\u89c2\u53cd\u6620\u6211\u4eec\u7684\u955c\u50cf\u5185\u5bb9\uff0c\u8fd8\u53ef\u4ee5\u4f5c\u4e3a\u7248\u672c\u8bb0\u5f55\u8fdb\u884c\u8ddf\u8e2a\u3002</p>"},{"location":"docker/dockerfile_usage/#_45","title":"\u5b9a\u5236\u955c\u50cf","text":"<p>\u4ee5\u6211\u4eec\u4e4b\u524d\u7684 nginx \u955c\u50cf\u4e3a\u4f8b\uff0c\u6211\u4eec\u73b0\u5728\u6765\u5b9a\u5236\u4e00\u4e2a nginx \u955c\u50cf\uff0c\u8981\u6c42\u9ed8\u8ba4\u7684\u5e94\u7528\u9875\u9762\u8bbf\u95ee\u7684\u5185\u5bb9\u662f <code>Hello Docker</code>\u3002</p> <p>\u9996\u5148\u6211\u4eec\u65b0\u5efa\u4e00\u4e2a\u76ee\u5f55 testnginx\uff0c\u7136\u540e\u5728\u8be5\u76ee\u5f55\u4e0b\u9762\u65b0\u5efa\u4e00\u4e2a\u540d\u4e3a<code>Dockerfile</code>\u7684\u7a7a\u767d\u6587\u672c\u6587\u4ef6\uff1a</p> <pre><code>$ mkdir -p testnginx &amp;&amp; cd testnginx &amp;&amp; touch Dockerfile\n</code></pre> <p>\u7136\u540e\u5411<code>Dockerfile</code>\u6587\u4ef6\u4e2d\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>FROM nginx\nRUN echo 'Hello Docker!' &gt; /user/share/nginx/html/index.html\n</code></pre> <p>\u8fd9\u4e2a\u6587\u4ef6\u5f88\u7b80\u5355\uff0c\u4e00\u5171\u5c31\u4e24\u884c\uff0c\u5176\u4e2d\u5305\u542b\u4e24\u6761\u6307\u4ee4\uff0c<code>FROM</code> \u548c <code>RUN</code>\u3002</p>"},{"location":"docker/dockerfile_usage/#from_4","title":"FROM \u6307\u4ee4","text":"<p>\u5b9a\u5236\u955c\u50cf\uff0c\u90a3\u4e48\u80af\u5b9a\u662f\u4e00\u4e2a\u955c\u50cf\u4e3a\u57fa\u7840\uff0c\u5728\u5176\u57fa\u7840\u4e0a\u8fdb\u884c\u5b9a\u5236\uff0c\u800c <code>FROM</code> \u8fd9\u4e2a\u6307\u4ee4\u5c31\u662f\u6765\u6307\u5b9a\u57fa\u7840\u955c\u50cf\u7684\uff0c\u6240\u4ee5\u5728\u4e00\u4e2a <code>Dockerfile</code> \u6587\u4ef6\u4e2d <code>FROM</code> \u6307\u4ee4\u662f\u5fc5\u5907\u7684\uff0c\u5e76\u4e14\u5fc5\u987b\u662f\u7b2c\u4e00\u6761\u6307\u4ee4\u3002</p> <p>\u5728 Docker Hub \u4e0a\u6709\u975e\u5e38\u591a\u7684\u9ad8\u8d28\u91cf\u7684\u5b98\u65b9\u955c\u50cf\uff0c\u6709\u4e00\u4e9b\u53ef\u4ee5\u76f4\u63a5\u62ff\u6765\u4f7f\u7528\u7684\u670d\u52a1\u7c7b\u7684\u955c\u50cf\uff0c\u5982 nginx\u3001redis\u3001mongo\u3001mysql\u3001httpd\u3001php\u3001tomcat \u7b49\uff1b\u4e5f\u6709\u4e00\u4e9b\u65b9\u4fbf\u5f00\u53d1\u3001\u6784\u5efa\u3001\u8fd0\u884c\u5404\u79cd\u8bed\u8a00\u5e94\u7528\u7684\u955c\u50cf\uff0c\u5982 node\u3001openjdk\u3001python\u3001ruby\u3001golang \u7b49\u3002\u53ef\u4ee5\u5728\u5176\u4e2d\u5bfb\u627e\u4e00\u4e2a\u6700\u7b26\u5408\u6211\u4eec\u6700\u7ec8\u76ee\u6807\u7684\u955c\u50cf\u4e3a\u57fa\u7840\u955c\u50cf\u8fdb\u884c\u5b9a\u5236\u3002</p> <p>\u5982\u679c\u6ca1\u6709\u627e\u5230\u5408\u9002\u7684\u57fa\u7840\u955c\u50cf\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e9b\u66f4\u4e3a\u57fa\u7840\u7684\u64cd\u4f5c\u7cfb\u7edf\u955c\u50cf\uff0c\u6bd4\u5982 ubuntu\u3001debian\u3001centos\u3001alpine \u7b49\uff0c\u8fd9\u4e9b\u57fa\u7840\u955c\u50cf\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u66f4\u5927\u7684\u6269\u5c55\u7a7a\u95f4\uff0c\u5c31\u7c7b\u4f3c\u4e8e\u5e73\u65f6\u6211\u4eec\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e0a\u9762\u90e8\u7f72\u81ea\u5df1\u7684\u670d\u52a1\u4e00\u6837\u7684\u64cd\u4f5c\u3002</p> <p>\u9664\u4e86\u9009\u62e9\u73b0\u6709\u955c\u50cf\u4e3a\u57fa\u7840\u955c\u50cf\u5916\uff0cDocker \u8fd8\u5b58\u5728\u4e00\u4e2a\u7279\u6b8a\u7684\u955c\u50cf\uff0c\u540d\u4e3a <code>scratch</code>\uff0c\u8fd9\u4e2a\u955c\u50cf\u662f\u4e00\u4e2a\u865a\u62df\u7684\u955c\u50cf\uff0c\u5e76\u4e0d\u5b9e\u9645\u5b58\u5728\uff0c\u8868\u793a\u4e00\u4e2a\u7a7a\u767d\u7684\u955c\u50cf\uff1a</p> <p><code>FROM scratch ...</code></p> <p>\u5982\u679c\u4f60\u4ee5 <code>scratch</code> \u4e3a\u57fa\u7840\u955c\u50cf\u7684\u8bdd\uff0c\u610f\u5473\u7740\u4f60\u4e0d\u4ee5\u4efb\u4f55\u955c\u50cf\u4e3a\u57fa\u7840\uff0c\u63a5\u4e0b\u6765\u6240\u5199\u7684\u6307\u4ee4\u5c06\u4f5c\u4e3a\u955c\u50cf\u7b2c\u4e00\u5c42\u5f00\u59cb\u5b58\u5728\u3002\u6709\u7684\u540c\u5b66\u53ef\u80fd\u611f\u89c9\u5f88\u5947\u602a\uff0c\u6ca1\u6709\u4efb\u4f55\u57fa\u7840\u955c\u50cf\uff0c\u6211\u600e\u4e48\u53bb\u6267\u884c\u6211\u7684\u7a0b\u5e8f\u5462\uff0c\u5176\u5b9e\u5bf9\u4e8e Linux \u4e0b\u9759\u6001\u7f16\u8bd1\u7684\u7a0b\u5e8f\u6765\u8bf4\uff0c\u5e76\u4e0d\u9700\u8981\u6709\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u8fd0\u884c\u65f6\u652f\u6301\uff0c\u6240\u9700\u7684\u4e00\u5207\u5e93\u90fd\u5df2\u7ecf\u5728\u53ef\u6267\u884c\u6587\u4ef6\u91cc\u4e86\uff0c\u56e0\u6b64\u76f4\u63a5<code>FROM scratch</code>\u4f1a\u8ba9\u955c\u50cf\u4f53\u79ef\u66f4\u52a0\u5c0f\u5de7\u3002\u4f7f\u7528 Go \u8bed\u8a00 \u5f00\u53d1\u7684\u5e94\u7528\u5f88\u591a\u4f1a\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u6765\u5236\u4f5c\u955c\u50cf\uff0c\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u6709\u5f88\u591a\u89c2\u70b9\u8ba4\u4e3a Go \u662f\u7279\u522b\u9002\u5408\u5bb9\u5668\u5fae\u670d\u52a1\u67b6\u6784\u7684\u8bed\u8a00\u7684\u539f\u56e0\u4e4b\u4e00\u3002</p>"},{"location":"docker/dockerfile_usage/#run_4","title":"RUN \u6307\u4ee4","text":"<p><code>RUN</code> \u6307\u4ee4\u662f\u7528\u6765\u6267\u884c\u547d\u4ee4\u884c\u547d\u4ee4\u7684\u3002\u7531\u4e8e\u547d\u4ee4\u884c\u7684\u5f3a\u5927\u80fd\u529b\uff0c\u6240\u4ee5 <code>RUN</code> \u6307\u4ee4\u662f\u5b9a\u5236\u955c\u50cf\u65f6\u662f\u6700\u5e38\u7528\u7684\u6307\u4ee4\u4e4b\u4e00\u3002\u5176\u683c\u5f0f\u6709\u4e24\u79cd\uff1a</p> <ul> <li> <p>shell \u683c\u5f0f\uff1a<code>RUN &lt;\u547d\u4ee4&gt;</code>\uff0c\u5c31\u50cf\u76f4\u63a5\u5728\u547d\u4ee4\u884c\u4e2d\u8f93\u5165\u7684\u547d\u4ee4\u4e00\u6837\u3002\u521a\u624d\u5199\u7684 Dockerfile \u4e2d\u7684 RUN \u6307\u4ee4\u5c31\u662f\u8fd9\u79cd\u683c\u5f0f\uff1a</p> <pre><code>RUN echo 'Hello, Docker!' &gt; /usr/share/nginx/html/index.html\n</code></pre> </li> <li> <p>exec \u683c\u5f0f\uff1a</p> <pre><code>RUN [\"\u53ef\u6267\u884c\u6587\u4ef6\", \"\u53c2\u65701\", \"\u53c2\u65702\"]\n</code></pre> <p>\uff0c\u8fd9\u66f4\u50cf\u662f\u51fd\u6570\u8c03\u7528\u4e2d\u7684\u683c\u5f0f\u3002\u65e2\u7136 RUN \u5c31\u50cf Shell \u811a\u672c\u4e00\u6837\u53ef\u4ee5\u6267\u884c\u547d\u4ee4\uff0c\u90a3\u4e48\u6211\u4eec\u662f\u5426\u5c31\u53ef\u4ee5\u50cf Shell \u811a\u672c\u4e00\u6837\u628a\u6bcf\u4e2a\u547d\u4ee4\u5bf9\u5e94\u4e00\u4e2a RUN \u5462\uff1f\u6bd4\u5982\u8fd9\u6837\uff1a</p> <pre><code>FROM debian:jessie\nRUN apt-get update\nRUN apt-get install -y gcc libc6-dev make wget\nRUN wget -O redis.tar.gz \"http://download.redis.io/releases/redis-tar.gz\"\nRUN mkdir -p /usr/src/redis\nRUN tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1\nRUN make -C /usr/src/redis\nRUN make -C /usr/src/redis install\n# \u5176\u4ed6\u6307\u4ee4...\n</code></pre> </li> </ul> <p>\u4e4b\u524d\u8bf4\u8fc7\uff0cDockerfile \u4e2d\u6bcf\u4e00\u4e2a\u6307\u4ee4\u90fd\u4f1a\u5efa\u7acb\u4e00\u5c42\uff0cRUN \u4e5f\u4e0d\u4f8b\u5916\u3002\u6bcf\u4e00\u4e2a RUN \u5c31\u4f1a\u65b0\u5efa\u7acb\u4e00\u5c42\uff0c\u5728\u5176\u4e0a\u6267\u884c\u8fd9\u4e9b\u547d\u4ee4\uff0c\u6267\u884c\u7ed3\u675f\u540e\uff0ccommit \u8fd9\u4e00\u5c42\u7684\u4fee\u6539\uff0c\u6784\u6210\u65b0\u7684\u955c\u50cf\u3002</p> <p>\u800c\u4e0a\u9762\u7684\u8fd9\u79cd\u5199\u6cd5\uff0c\u521b\u5efa\u4e86 7 \u5c42\u955c\u50cf\u3002\u8fd9\u662f\u5b8c\u5168\u6ca1\u6709\u5fc5\u8981\u7684\uff0c\u800c\u4e14\u5f88\u591a\u8fd0\u884c\u65f6\u4e0d\u9700\u8981\u7684\u4e1c\u897f\uff0c\u90fd\u88ab\u88c5\u8fdb\u4e86\u955c\u50cf\u91cc\uff0c\u6bd4\u5982\u7f16\u8bd1\u73af\u5883\u3001\u66f4\u65b0\u7684\u8f6f\u4ef6\u5305\u7b49\u7b49\u3002\u7ed3\u679c\u5c31\u662f\u4ea7\u751f\u975e\u5e38\u81c3\u80bf\u3001\u975e\u5e38\u591a\u5c42\u7684\u955c\u50cf\uff0c\u4e0d\u4ec5\u4ec5\u589e\u52a0\u4e86\u6784\u5efa\u90e8\u7f72\u7684\u65f6\u95f4\uff0c\u4e5f\u5f88\u5bb9\u6613\u51fa\u9519\u3002 \u8fd9\u662f\u5f88\u591a\u521d\u5b66 Docker \u7684\u4eba\u5e38\u72af\u7684\u4e00\u4e2a\u9519\u8bef\u3002</p> <p>UnionFS \u5c42\u9650\u5236</p> <p>UnionFS \u5b9e\u9645\u4e0a\u662f\u6709\u6700\u5927\u5c42\u6570\u9650\u5236\u7684\uff0c\u6bd4\u5982 AUFS\uff0c\u66fe\u7ecf\u662f\u6700\u5927\u4e0d\u5f97\u8d85\u8fc7 42 \u5c42\uff0c\u73b0\u5728\u662f\u4e0d\u5f97\u8d85\u8fc7 127 \u5c42\u3002</p> <p>\u4e0a\u9762\u7684 Dockerfile \u6b63\u786e\u7684\u5199\u6cd5\u5e94\u8be5\u662f\u8fd9\u6837\uff1a</p> <pre><code>FROM debian:jessie\nRUN buildDeps='gcc libc6-dev make wget' \\\\\n    &amp;&amp; apt-get update \\\\\n    &amp;&amp; apt-get install -y $buildDeps \\\\\n    &amp;&amp; wget -O redis.tar.gz \"http://download.redis.io/releases/redis-tar.gz\" \\\\\n    &amp;&amp; mkdir -p /usr/src/redis \\\\\n    &amp;&amp; tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1 \\\\\n    &amp;&amp; make -C /usr/src/redis \\\\\n    &amp;&amp; make -C /usr/src/redis install \\\\\n    &amp;&amp; rm -rf /var/lib/apt/lists/* \\\\\n    &amp;&amp; rm redis.tar.gz \\\\\n    &amp;&amp; rm -r /usr/src/redis \\\\\n    &amp;&amp; apt-get purge -y --auto-remove $buildDeps\n# \u5176\u4ed6\u6307\u4ee4...\n</code></pre> <p>\u9996\u5148\uff0c\u4e4b\u524d\u6240\u6709\u7684\u547d\u4ee4\u53ea\u6709\u4e00\u4e2a\u76ee\u7684\uff0c\u5c31\u662f\u7f16\u8bd1\u3001\u5b89\u88c5 redis \u53ef\u6267\u884c\u6587\u4ef6\u3002\u56e0\u6b64\u6ca1\u6709\u5fc5\u8981\u5efa\u7acb\u5f88\u591a\u5c42\uff0c\u8fd9\u53ea\u662f\u4e00\u5c42\u7684\u4e8b\u60c5\u3002\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u6ca1\u6709\u4f7f\u7528\u5f88\u591a\u4e2a RUN \u6307\u4ee4\u6765\u5bf9\u5e94\u4e0d\u540c\u7684\u547d\u4ee4\uff0c\u800c\u662f\u4ec5\u4ec5\u4f7f\u7528\u4e00\u4e2a RUN \u6307\u4ee4\uff0c\u5e76\u4f7f\u7528<code>&amp;&amp;</code>\u5c06\u5404\u4e2a\u6240\u9700\u547d\u4ee4\u4e32\u8054\u8d77\u6765\u3002\u5c06\u4e4b\u524d\u7684 7 \u5c42\uff0c\u7b80\u5316\u4e3a\u4e86 1 \u5c42\u3002\u5728\u64b0\u5199 Dockerfile \u7684\u65f6\u5019\uff0c\u8981\u7ecf\u5e38\u63d0\u9192\u81ea\u5df1\uff0c\u8fd9\u5e76\u4e0d\u662f\u5728\u5199 Shell \u811a\u672c\uff0c\u800c\u662f\u5728\u5b9a\u4e49\u6bcf\u4e00\u5c42\u8be5\u5982\u4f55\u6784\u5efa\u3002</p> <p>\u5e76\u4e14\uff0c\u8fd9\u91cc\u4e3a\u4e86\u683c\u5f0f\u5316\u8fd8\u8fdb\u884c\u4e86\u6362\u884c\u3002Dockerfile \u652f\u6301 Shell \u7c7b\u7684\u884c\u5c3e\u6dfb\u52a0<code>\\</code>\u7684\u547d\u4ee4\u6362\u884c\u65b9\u5f0f\uff0c\u4ee5\u53ca\u884c\u9996<code>#</code>\u8fdb\u884c\u6ce8\u91ca\u7684\u683c\u5f0f\u3002\u826f\u597d\u7684\u683c\u5f0f\uff0c\u6bd4\u5982<code>\u6362\u884c\u3001\u7f29\u8fdb\u3001\u6ce8\u91ca</code>\u7b49\uff0c\u4f1a\u8ba9\u7ef4\u62a4\u3001\u6392\u969c\u66f4\u4e3a\u5bb9\u6613\uff0c\u8fd9\u662f\u4e00\u4e2a\u6bd4\u8f83\u597d\u7684\u4e60\u60ef\u3002</p> <p>\u6b64\u5916\uff0c\u8fd8\u53ef\u4ee5\u770b\u5230\u8fd9\u4e00\u7ec4\u547d\u4ee4\u7684\u6700\u540e\u6dfb\u52a0\u4e86\u6e05\u7406\u5de5\u4f5c\u7684\u547d\u4ee4\uff0c\u5220\u9664\u4e86\u4e3a\u4e86\u7f16\u8bd1\u6784\u5efa\u4e0b\u8f7d\u7684\u8f6f\u4ef6\uff0c\u6e05\u7406\u4e86\u6240\u6709\u4e0b\u8f7d\u3001\u5c55\u5f00\u7684\u6587\u4ef6\uff0c\u5e76\u4e14\u8fd8\u6e05\u7406\u4e86 apt \u7f13\u5b58\u6587\u4ef6\u3002\u8fd9\u662f\u5f88\u91cd\u8981\u7684\u4e00\u6b65\uff0c\u6211\u4eec\u4e4b\u524d\u8bf4\u8fc7\uff0c\u955c\u50cf\u662f\u591a\u5c42\u5b58\u50a8\uff0c\u6bcf\u4e00\u5c42\u7684\u4e1c\u897f\u5e76\u4e0d\u4f1a\u5728\u4e0b\u4e00\u5c42\u88ab\u5220\u9664\uff0c\u4f1a\u4e00\u76f4\u8ddf\u968f\u7740\u955c\u50cf\u3002\u56e0\u6b64\u955c\u50cf\u6784\u5efa\u65f6\uff0c\u4e00\u5b9a\u8981\u786e\u4fdd\u6bcf\u4e00\u5c42\u53ea\u6dfb\u52a0\u771f\u6b63\u9700\u8981\u6dfb\u52a0\u7684\u4e1c\u897f\uff0c\u4efb\u4f55\u65e0\u5173\u7684\u4e1c\u897f\u90fd\u5e94\u8be5\u6e05\u7406\u6389\u3002 \u5f88\u591a\u4eba\u521d\u5b66 Docker \u5236\u4f5c\u51fa\u4e86\u5f88\u81c3\u80bf\u7684\u955c\u50cf\u7684\u539f\u56e0\u4e4b\u4e00\uff0c\u5c31\u662f\u5fd8\u8bb0\u4e86\u6bcf\u4e00\u5c42\u6784\u5efa\u7684\u6700\u540e\u4e00\u5b9a\u8981\u6e05\u7406\u6389\u65e0\u5173\u6587\u4ef6\u3002</p>"},{"location":"docker/dockerfile_usage/#workdir_4","title":"WORKDIR \u6307\u4ee4","text":"<p><code>WORKDIR</code> \u6307\u4ee4\u8bbe\u7f6e Dockerfile \u4e2d\u7684\u4efb\u4f55 RUN\uff0cCMD\uff0cENTRPOINT\uff0cCOPY \u548c ADD \u6307\u4ee4\u7684\u5de5\u4f5c\u76ee\u5f55\u3002\u5982\u679c WORKDIR \u6307\u5b9a\u7684\u76ee\u5f55\u4e0d\u5b58\u5728\uff0c\u5373\u4f7f\u968f\u540e\u7684\u6307\u4ee4\u6ca1\u6709\u7528\u5230\u8fd9\u4e2a\u76ee\u5f55\uff0c\u90fd\u4f1a\u521b\u5efa\u8be5\u76ee\u5f55\u3002</p> <p>\u683c\u5f0f\uff1a </p> <pre><code>WORKDIR /path/to/workdir\n</code></pre> <p>\u4e3a\u4e86\u6e05\u6670\u6027\u548c\u53ef\u9760\u6027\uff0c\u4f60\u5e94\u8be5\u603b\u662f\u5728 WORKDIR \u4e2d\u4f7f\u7528\u7edd\u5bf9\u8def\u5f84\uff0c\u800c\u4e14\u5355\u4e2a Dockerfile \u53ef\u4ee5\u4f7f\u7528\u591a\u6b21WORKDIR\u3002\u53e6\u5916\uff0c\u6211\u4eec\u5e94\u8be5\u4f7f\u7528 WORKDIR \u6765\u66ff\u4ee3\u7c7b\u4f3c\u4e8e </p> <pre><code>RUN cd ... &amp;&amp; do-something\n</code></pre> <p>\u7684\u6307\u4ee4\uff0c\u540e\u8005\u96be\u4ee5\u9605\u8bfb\u3001\u6392\u9519\u548c\u7ef4\u62a4\u3002</p>"},{"location":"docker/dockerfile_usage/#add_copy_4","title":"ADD &amp; COPY \u6307\u4ee4","text":"<p>Dockerfile \u4e2d\u7684 <code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code> \u6307\u4ee4\u90fd\u53ef\u4ee5\u5c06\u4e3b\u673a\u4e0a\u7684\u8d44\u6e90\u590d\u5236\u6216\u52a0\u5165\u5230\u5bb9\u5668\u955c\u50cf\u4e2d\uff0c\u90fd\u662f\u5728\u6784\u5efa\u955c\u50cf\u7684\u8fc7\u7a0b\u4e2d\u5b8c\u6210\u7684\u3002</p> <p><code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code> \u6307\u4ee4\u7684\u552f\u4e00\u533a\u522b\u5728\u4e8e<code>\u662f\u5426\u652f\u6301\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90</code>\u3002<code>COPY</code> \u6307\u4ee4\u53ea\u80fd\u4ece\u6267\u884c<code>docker build</code>\u6240\u5728\u7684\u4e3b\u673a\u4e0a\u8bfb\u53d6\u8d44\u6e90\u5e76\u590d\u5236\u5230\u955c\u50cf\u4e2d\u3002\u800c <code>ADD</code> \u6307\u4ee4\u8fd8\u652f\u6301\u901a\u8fc7 URL \u4ece\u8fdc\u7a0b\u670d\u52a1\u5668\u8bfb\u53d6\u8d44\u6e90\u5e76\u590d\u5236\u5230\u955c\u50cf\u4e2d\u3002</p> <p>\u4e00\u822c\u6765\u8bf4\u6ee1\u8db3\u540c\u7b49\u529f\u80fd\u7684\u60c5\u51b5\u4e0b\uff0c\u63a8\u8350\u4f7f\u7528COPY\u6307\u4ee4\u3002<code>ADD</code> \u6307\u4ee4\u66f4\u64c5\u957f\u8bfb\u53d6\u672c\u5730 tar \u6587\u4ef6\u5e76\u89e3\u538b\u7f29\u3002</p>"},{"location":"docker/dockerfile_usage/#copy_4","title":"COPY \u6307\u4ee4","text":"<p><code>COPY</code> \u6307\u4ee4\u80fd\u591f\u5c06\u6784\u5efa\u547d\u4ee4\u6240\u5728\u7684\u4e3b\u673a\u672c\u5730\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u590d\u5236\u5230\u955c\u50cf\u6587\u4ef6\u7cfb\u7edf\u3002COPY \u6307\u4ee4\u540c\u6837\u4e5f\u652f\u6301 exec \u548c shell \u4e24\u79cd\u683c\u5f0f\uff1a</p> <ul> <li> <p>exec \u683c\u5f0f\u7528\u6cd5\uff1a</p> <pre><code>COPY [\"&lt;src&gt;\",... \"&lt;dest&gt;\"]\n</code></pre> <p>\uff0c\u7279\u522b\u9002\u5408\u8def\u5f84\u4e2d\u5e26\u6709\u7a7a\u683c\u7684\u60c5\u51b5\u3002</p> </li> <li> <p>shell \u683c\u5f0f\u7528\u6cd5\uff1a<code>COPY &lt;src&gt;... &lt;dest&gt;</code></p> </li> </ul>"},{"location":"docker/dockerfile_usage/#add_4","title":"ADD \u6307\u4ee4","text":"<p><code>ADD</code> \u6307\u4ee4\u4e0d\u4ec5\u80fd\u591f\u5c06\u6784\u5efa\u547d\u4ee4\u6240\u5728\u7684\u4e3b\u673a\u672c\u5730\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u800c\u4e14\u80fd\u591f\u5c06\u8fdc\u7a0b URL \u6240\u5bf9\u5e94\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u4f5c\u4e3a\u8d44\u6e90\u590d\u5236\u5230\u955c\u50cf\u6587\u4ef6\u7cfb\u7edf\u3002\u6240\u4ee5\uff0c\u53ef\u4ee5\u8ba4\u4e3a <code>ADD</code> \u662f\u589e\u5f3a\u7248\u7684 <code>COPY</code>\uff0c\u652f\u6301\u5c06\u8fdc\u7a0b URL \u7684\u8d44\u6e90\u52a0\u5165\u5230\u955c\u50cf\u7684\u6587\u4ef6\u7cfb\u7edf\u3002\u540c\u6837\u4e5f\u652f\u6301 exec \u548c shell \u4e24\u79cd\u683c\u5f0f\u7528\u6cd5\uff1a \u00a0 * exec \u683c\u5f0f\u7528\u6cd5\uff1a</p> <pre><code>ADD [\"&lt;src&gt;\",... \"&lt;dest&gt;\"]\n</code></pre> <p>\uff0c\u7279\u522b\u9002\u5408\u8def\u5f84\u4e2d\u5e26\u6709\u7a7a\u683c\u7684\u60c5\u51b5</p> <ul> <li>shell \u683c\u5f0f\u7528\u6cd5\uff1a<code>ADD &lt;src&gt;... &lt;dest&gt;</code></li> </ul> <p>\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90\uff0c\u6bd4\u5982\uff1a</p> <pre><code>ADD http://foo.com/bar.go /tmp/main.go\n</code></pre> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u5bf9\u4e8e\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90\u7684\u60c5\u51b5\uff0c\u7531\u4e8e ADD \u6307\u4ee4\u4e0d\u652f\u6301\u8ba4\u8bc1\uff0c\u5982\u679c\u4ece\u8fdc\u7a0b\u83b7\u53d6\u8d44\u6e90\u9700\u8981\u8ba4\u8bc1\uff0c\u5219\u53ea\u80fd\u4f7f\u7528<code>RUN wget</code> \u6216 <code>RUN curl</code> \u66ff\u4ee3\u4e86\u3002</p> <p>\u6709\u80fd\u529b\u81ea\u52a8\u89e3\u538b\u6587\u4ef6\uff0c\u6bd4\u5982\uff1a</p> <pre><code>ADD /foo.tar.gz /tmp/\n</code></pre> <p>\u4e0a\u8ff0\u6307\u4ee4\u4f1a\u4f7f foo.tar.gz \u538b\u7f29\u6587\u4ef6\u89e3\u538b\u5230\u5bb9\u5668\u7684 /tmp \u76ee\u5f55\u3002</p> <p>\u4e0d\u8fc7\u4e00\u822c\u6765\u8bf4\u867d\u7136 ADD \u6307\u4ee4\u652f\u6301\u4ece\u8fdc\u7a0b\u83b7\u53d6\u8d44\u6e90\uff0c\u4f46\u662f\u5e76\u4e0d\u63a8\u8350\u4f7f\u7528\uff0c\u800c\u662f\u5efa\u8bae\u4f7f\u7528 RUN \u6307\u4ee4\u53bb\u6267\u884c wget \u6216 curl \u547d\u4ee4\u3002</p> <p>\u6bd4\u5982\u524d\u9762\u6211\u4eec\u5b9a\u5236\u7684 nginx \u955c\u50cf\uff0c\u53ef\u4ee5\u6539\u6210\u4e0b\u9762\u7684\u5f62\u5f0f\uff1a</p> <pre><code>$ echo 'Hello Docker!' &gt; index.html\n</code></pre> <p>\u7136\u540e\u4fee\u6539 Dockerfile\uff1a</p> <pre><code>FROM nginx\n# COPY\u6216\u8005ADD\u6307\u4ee4\u90fd\u53ef\u4ee5\nCOPY index.html /user/share/nginx/html/index.html\n</code></pre>"},{"location":"docker/dockerfile_usage/#_46","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p><code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code>\u6307\u4ee4\u7684\u7528\u6cd5\u975e\u5e38\u76f8\u4f3c\uff0c\u5177\u4f53\u6ce8\u610f\u4e8b\u9879\u5982\u4e0b\uff1a</p> <ul> <li>\u6e90\u8def\u5f84\u53ef\u4ee5\u6709\u591a\u4e2a</li> <li>\u6e90\u8def\u5f84\u662f\u76f8\u5bf9\u4e8e\u6267\u884c build \u7684\u76f8\u5bf9\u8def\u5f84</li> <li>\u6e90\u8def\u5f84\u5982\u679c\u662f\u672c\u5730\u8def\u5f84\uff0c\u5fc5\u987b\u662f\u6784\u5efa\u4e0a\u4e0b\u6587\u4e2d\u7684\u8def\u5f84</li> <li>\u6e90\u8def\u5f84\u5982\u679c\u662f\u4e00\u4e2a\u76ee\u5f55\uff0c\u5219\u8be5\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u5185\u5bb9\u90fd\u5c06\u88ab\u52a0\u5165\u5230\u5bb9\u5668\uff0c\u4f46\u662f\u8be5\u76ee\u5f55\u672c\u8eab\u4e0d\u4f1a</li> <li>\u76ee\u6807\u8def\u5f84\u5fc5\u987b\u662f\u7edd\u5bf9\u8def\u5f84\uff0c\u6216\u76f8\u5bf9\u4e8e WORKDIR \u7684\u76f8\u5bf9\u8def\u5f84</li> <li>\u76ee\u6807\u8def\u5f84\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u4f1a\u521b\u5efa\u76f8\u5e94\u7684\u5b8c\u6574\u8def\u5f84</li> <li>\u76ee\u6807\u8def\u5f84\u5982\u679c\u4e0d\u662f\u4e00\u4e2a\u6587\u4ef6\uff0c\u5219\u5fc5\u987b\u4f7f\u7528/\u7ed3\u675f</li> <li>\u8def\u5f84\u4e2d\u53ef\u4ee5\u4f7f\u7528\u901a\u914d\u7b26</li> </ul>"},{"location":"docker/dockerfile_usage/#_47","title":"\u6784\u5efa\u955c\u50cf","text":"<p>\u73b0\u5728\u8ba9\u6211\u4eec\u518d\u56de\u5230\u4e4b\u524d\u5b9a\u5236\u7684 nginx \u955c\u50cf\u7684 Dockerfile \u6765\u3002\u73b0\u5728\u6211\u4eec\u660e\u767d\u4e86\u8fd9\u4e2a Dockerfile \u7684\u5185\u5bb9\uff0c\u90a3\u4e48\u8ba9\u6211\u4eec\u6765\u6784\u5efa\u8fd9\u4e2a\u955c\u50cf\u5427\u3002\u5728 Dockerfile \u6587\u4ef6\u6240\u5728\u76ee\u5f55\u6267\u884c\uff1a</p> <pre><code>$ docker build -t nginx:v1 .\nSending build context to Docker daemon 048 kB\nStep 1 : FROM nginx\n ---&gt; e43d811ce2f4\nStep 2 : RUN echo 'Hello, Docker!' &gt; /usr/share/nginx/html/index.html\n ---&gt; Running in 9cdc27646c7b\n ---&gt; 44aa4490ce2c\nRemoving intermediate container 9cdc27646c7b\nSuccessfully built 44aa4490ce2c\n</code></pre> <p>\u4ece\u547d\u4ee4\u7684\u8f93\u51fa\u7ed3\u679c\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u6e05\u6670\u7684\u770b\u5230\u955c\u50cf\u7684\u6784\u5efa\u8fc7\u7a0b\u3002\u5728 Step 2 \u4e2d\uff0c\u5982\u540c\u6211\u4eec\u4e4b\u524d\u6240\u8bf4\u7684\u90a3\u6837\uff0cRUN \u6307\u4ee4\u542f\u52a8\u4e86\u4e00\u4e2a\u5bb9\u5668 9cdc27646c7b\uff0c\u6267\u884c\u4e86\u6240\u8981\u6c42\u7684\u547d\u4ee4\uff0c\u5e76\u6700\u540e\u63d0\u4ea4\u4e86\u8fd9\u4e00\u5c42 44aa4490ce2c\uff0c\u968f\u540e\u5220\u9664\u4e86\u6240\u7528\u5230\u7684\u8fd9\u4e2a\u5bb9\u5668 9cdc27646c7b\u3002\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u4e86 <code>docker build</code> \u547d\u4ee4\u8fdb\u884c\u955c\u50cf\u6784\u5efa\u3002\u5176\u683c\u5f0f\u4e3a\uff1a</p> <pre><code>$ docker build [\u9009\u9879] &lt;\u4e0a\u4e0b\u6587\u8def\u5f84/URL/-&gt;\n</code></pre> <p>\u5728\u8fd9\u91cc\u6211\u4eec\u901a\u8fc7 <code>-t</code> \u53c2\u6570\u6307\u5b9a\u4e86\u6700\u7ec8\u955c\u50cf\u7684\u540d\u79f0 <code>nginx:v1</code>\uff0c\u6784\u5efa\u6210\u529f\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a\u955c\u50cf\u6765\u8fd0\u884c\u5bb9\u5668\u4e86\u3002</p>"},{"location":"docker/dockerfile_usage/#_48","title":"\u6784\u5efa\u4e0a\u4e0b\u6587","text":"<p>\u5982\u679c\u6211\u4eec\u4ed4\u7ec6\u89c2\u5bdf\u7684\u8bdd\u4f1a\u770b\u5230 <code>docker build</code> \u547d\u4ee4\u6700\u540e\u6709\u4e00\u4e2a <code>.</code>\u3002<code>.</code> \u8868\u793a\u5f53\u524d\u76ee\u5f55\uff0c\u800c Dockerfile \u5c31\u5728\u5f53\u524d\u76ee\u5f55\uff0c\u56e0\u6b64\u4e0d\u5c11\u521d\u5b66\u8005\u4ee5\u4e3a\u8fd9\u4e2a\u8def\u5f84\u662f\u5728\u6307\u5b9a Dockerfile \u6240\u5728\u8def\u5f84\uff0c\u8fd9\u4e48\u7406\u89e3\u5176\u5b9e\u662f\u4e0d\u51c6\u786e\u7684\u3002\u5982\u679c\u5bf9\u5e94\u4e0a\u9762\u7684\u547d\u4ee4\u683c\u5f0f\uff0c\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0\uff0c\u8fd9\u662f\u5728\u6307\u5b9a\u4e0a\u4e0b\u6587\u8def\u5f84\u3002\u90a3\u4e48\u4ec0\u4e48\u662f\u4e0a\u4e0b\u6587\u5462\uff1f</p> <p>\u9996\u5148\u6211\u4eec\u8981\u7406\u89e3 <code>docker build</code> \u7684\u5de5\u4f5c\u539f\u7406\u3002Docker \u5728\u8fd0\u884c\u65f6\u5206\u4e3a Docker Daemon \u548c\u5ba2\u6237\u7aef\u5de5\u5177\u3002Docker \u7684\u5f15\u64ce\u63d0\u4f9b\u4e86\u4e00\u7ec4 REST API\uff0c\u88ab\u79f0\u4e3a Docker Remote API\uff0c\u800c\u5982 docker \u547d\u4ee4\u8fd9\u6837\u7684\u5ba2\u6237\u7aef\u5de5\u5177\uff0c\u5219\u662f\u901a\u8fc7\u8fd9\u7ec4 API \u4e0e Docker \u5f15\u64ce\u4ea4\u4e92\uff0c\u4ece\u800c\u5b8c\u6210\u5404\u79cd\u529f\u80fd\u3002\u56e0\u6b64\uff0c\u867d\u7136\u8868\u9762\u4e0a\u6211\u4eec\u597d\u50cf\u662f\u5728\u672c\u673a\u6267\u884c\u5404\u79cd docker \u529f\u80fd\uff0c\u4f46\u5b9e\u9645\u4e0a\uff0c\u4e00\u5207\u90fd\u662f\u4f7f\u7528\u7684\u8fdc\u7a0b\u8c03\u7528\u5f62\u5f0f\u5728\u670d\u52a1\u7aef\uff08Docker \u5f15\u64ce\uff09\u5b8c\u6210\u3002\u4e5f\u56e0\u4e3a\u8fd9\u79cd C/S \u8bbe\u8ba1\uff0c\u8ba9\u6211\u4eec\u64cd\u4f5c\u8fdc\u7a0b\u670d\u52a1\u5668\u7684 Docker \u5f15\u64ce\u53d8\u5f97\u8f7b\u800c\u6613\u4e3e\u3002</p> <p>\u5f53\u6211\u4eec\u8fdb\u884c\u955c\u50cf\u6784\u5efa\u7684\u65f6\u5019\uff0c\u5e76\u975e\u6240\u6709\u5b9a\u5236\u90fd\u4f1a\u901a\u8fc7 RUN \u6307\u4ee4\u5b8c\u6210\uff0c\u7ecf\u5e38\u4f1a\u9700\u8981\u5c06\u4e00\u4e9b\u672c\u5730\u6587\u4ef6\u590d\u5236\u8fdb\u955c\u50cf\uff0c\u6bd4\u5982\u901a\u8fc7 <code>COPY</code> \u6307\u4ee4\u3001<code>ADD</code> \u6307\u4ee4\u7b49\u3002\u800c <code>docker build</code> \u547d\u4ee4\u6784\u5efa\u955c\u50cf\uff0c\u5176\u5b9e\u5e76\u975e\u5728\u672c\u5730\u6784\u5efa\uff0c\u800c\u662f\u5728\u670d\u52a1\u7aef\uff0c\u4e5f\u5c31\u662f Docker \u5f15\u64ce\u4e2d\u6784\u5efa\u7684\u3002\u90a3\u4e48\u5728\u8fd9\u79cd<code>\u5ba2\u6237\u7aef/\u670d\u52a1\u7aef</code>\u7684\u67b6\u6784\u4e2d\uff0c\u5982\u4f55\u624d\u80fd\u8ba9\u670d\u52a1\u7aef\u83b7\u5f97\u672c\u5730\u6587\u4ef6\u5462\uff1f</p> <p>\u8fd9\u5c31\u5f15\u5165\u4e86<code>\u4e0a\u4e0b\u6587</code>\u7684\u6982\u5ff5\u3002\u5f53\u6784\u5efa\u7684\u65f6\u5019\uff0c\u7528\u6237\u4f1a\u6307\u5b9a\u6784\u5efa\u955c\u50cf\u4e0a\u4e0b\u6587\u7684\u8def\u5f84\uff0cdocker build \u547d\u4ee4\u5f97\u77e5\u8fd9\u4e2a\u8def\u5f84\u540e\uff0c\u4f1a\u5c06\u8def\u5f84\u4e0b\u7684\u6240\u6709\u5185\u5bb9\u6253\u5305\uff0c\u7136\u540e\u4e0a\u4f20\u7ed9 Docker \u5f15\u64ce\u3002\u8fd9\u6837 Docker \u5f15\u64ce\u6536\u5230\u8fd9\u4e2a\u4e0a\u4e0b\u6587\u5305\u540e\uff0c\u5c55\u5f00\u5c31\u4f1a\u83b7\u5f97\u6784\u5efa\u955c\u50cf\u6240\u9700\u7684\u4e00\u5207\u6587\u4ef6\u3002\u5982\u679c\u5728 Dockerfile \u4e2d\u8fd9\u4e48\u5199\uff1a</p> <pre><code>COPY ./package.json /app/\n</code></pre> <p>\u8fd9\u5e76\u4e0d\u662f\u8981\u590d\u5236\u6267\u884c docker build \u547d\u4ee4\u6240\u5728\u7684\u76ee\u5f55\u4e0b\u7684 package.json\uff0c\u4e5f\u4e0d\u662f\u590d\u5236 Dockerfile \u6240\u5728\u76ee\u5f55\u4e0b\u7684 package.json\uff0c\u800c\u662f\u590d\u5236 <code>\u4e0a\u4e0b\u6587\uff08context\uff09</code> \u76ee\u5f55\u4e0b\u7684 package.json\u3002</p> <p>\u56e0\u6b64\uff0c<code>COPY</code> \u8fd9\u7c7b\u6307\u4ee4\u4e2d\u7684\u6e90\u6587\u4ef6\u7684\u8def\u5f84\u90fd\u662f<code>\u76f8\u5bf9\u8def\u5f84</code>\u3002\u8fd9\u4e5f\u662f\u521d\u5b66\u8005\u7ecf\u5e38\u4f1a\u95ee\u7684\u4e3a\u4ec0\u4e48 </p> <pre><code>COPY ../package.json /app\n</code></pre> <p>\u6216\u8005 <code>COPY /opt/xxxx /app</code> \u65e0\u6cd5\u5de5\u4f5c\u7684\u539f\u56e0\uff0c\u56e0\u4e3a\u8fd9\u4e9b\u8def\u5f84\u5df2\u7ecf\u8d85\u51fa\u4e86\u4e0a\u4e0b\u6587\u7684\u8303\u56f4\uff0cDocker \u5f15\u64ce\u65e0\u6cd5\u83b7\u5f97\u8fd9\u4e9b\u4f4d\u7f6e\u7684\u6587\u4ef6\u3002\u5982\u679c\u771f\u7684\u9700\u8981\u90a3\u4e9b\u6587\u4ef6\uff0c\u5e94\u8be5\u5c06\u5b83\u4eec\u590d\u5236\u5230\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\u53bb\u3002</p> <p>\u73b0\u5728\u5c31\u53ef\u4ee5\u7406\u89e3\u521a\u624d\u7684\u547d\u4ee4</p> <pre><code>docker build -t nginx:v1 .\n</code></pre> <p>\u4e2d\u7684\u8fd9\u4e2a<code>.</code>\uff0c\u5b9e\u9645\u4e0a\u662f\u5728\u6307\u5b9a\u4e0a\u4e0b\u6587\u7684\u76ee\u5f55\uff0cdocker build \u547d\u4ee4\u4f1a\u5c06\u8be5\u76ee\u5f55\u4e0b\u7684\u5185\u5bb9\u6253\u5305\u4ea4\u7ed9 Docker \u5f15\u64ce\u4ee5\u5e2e\u52a9\u6784\u5efa\u955c\u50cf\u3002</p> <p>\u5982\u679c\u89c2\u5bdf docker build \u8f93\u51fa\uff0c\u6211\u4eec\u5176\u5b9e\u5df2\u7ecf\u770b\u5230\u4e86\u8fd9\u4e2a\u53d1\u9001\u4e0a\u4e0b\u6587\u7684\u8fc7\u7a0b\uff1a</p> <pre><code>$ docker build -t nginx:v1 .\nSending build context to Docker daemon 048 kB\n...\n</code></pre> <p>\u7406\u89e3\u6784\u5efa\u4e0a\u4e0b\u6587\u5bf9\u4e8e\u955c\u50cf\u6784\u5efa\u662f\u5f88\u91cd\u8981\u7684\uff0c\u53ef\u4ee5\u907f\u514d\u72af\u4e00\u4e9b\u4e0d\u5e94\u8be5\u7684\u9519\u8bef\u3002\u6bd4\u5982\u6709\u4e9b\u521d\u5b66\u8005\u5728\u53d1\u73b0 COPY /opt/xxxx /app \u4e0d\u5de5\u4f5c\u540e\uff0c\u4e8e\u662f\u5e72\u8106\u5c06 Dockerfile \u653e\u5230\u4e86\u786c\u76d8\u6839\u76ee\u5f55\u53bb\u6784\u5efa\uff0c\u7ed3\u679c\u53d1\u73b0 docker build \u6267\u884c\u65f6\u53d1\u9001\u4e00\u4e2a\u51e0\u5341 GB \u7684\u4e1c\u897f\uff0c\u6781\u4e3a\u7f13\u6162\u800c\u4e14\u5f88\u5bb9\u6613\u6784\u5efa\u5931\u8d25\u3002\u90a3\u662f\u56e0\u4e3a\u8fd9\u79cd\u505a\u6cd5\u662f\u5728\u8ba9 docker build \u6253\u5305\u6574\u4e2a\u786c\u76d8\uff0c\u8fd9\u663e\u7136\u662f\u4f7f\u7528\u9519\u8bef\u3002</p> <p>\u4e00\u822c\u6765\u8bf4\uff0c\u5e94\u8be5\u4f1a\u5c06 Dockerfile \u7f6e\u4e8e\u4e00\u4e2a\u7a7a\u76ee\u5f55\u4e0b\uff0c\u6216\u8005\u9879\u76ee\u6839\u76ee\u5f55\u4e0b\u3002\u5982\u679c\u8be5\u76ee\u5f55\u4e0b\u6ca1\u6709\u6240\u9700\u6587\u4ef6\uff0c\u90a3\u4e48\u5e94\u8be5\u628a\u6240\u9700\u6587\u4ef6\u590d\u5236\u4e00\u4efd\u8fc7\u6765\u3002\u5982\u679c\u76ee\u5f55\u4e0b\u6709\u4e9b\u4e1c\u897f\u786e\u5b9e\u4e0d\u5e0c\u671b\u6784\u5efa\u65f6\u4f20\u7ed9 Docker \u5f15\u64ce\uff0c\u90a3\u4e48\u53ef\u4ee5\u7528 .gitignore \u4e00\u6837\u7684\u8bed\u6cd5\u5199\u4e00\u4e2a <code>.dockerignore</code>\uff0c\u8be5\u6587\u4ef6\u662f\u7528\u4e8e\u5254\u9664\u4e0d\u9700\u8981\u4f5c\u4e3a\u4e0a\u4e0b\u6587\u4f20\u9012\u7ed9 Docker \u5f15\u64ce\u7684\u3002</p> <p>\u90a3\u4e48\u4e3a\u4ec0\u4e48\u4f1a\u6709\u4eba\u8bef\u4ee5\u4e3a <code>.</code> \u662f\u6307\u5b9a Dockerfile \u6240\u5728\u76ee\u5f55\u5462\uff1f\u8fd9\u662f\u56e0\u4e3a\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u4e0d\u989d\u5916\u6307\u5b9a Dockerfile \u7684\u8bdd\uff0c\u4f1a\u5c06\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e0b\u7684\u540d\u4e3a Dockerfile \u7684\u6587\u4ef6\u4f5c\u4e3a Dockerfile\u3002\u8fd9\u53ea\u662f\u9ed8\u8ba4\u884c\u4e3a\uff0c\u5b9e\u9645\u4e0a Dockerfile \u7684\u6587\u4ef6\u540d\u5e76\u4e0d\u8981\u6c42\u5fc5\u987b\u4e3a Dockerfile\uff0c\u800c\u4e14\u5e76\u4e0d\u8981\u6c42\u5fc5\u987b\u4f4d\u4e8e\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\uff0c\u6bd4\u5982\u53ef\u4ee5\u7528<code>-f ../Dockerfile.Dev</code>\u53c2\u6570\u6307\u5b9a\u67d0\u4e2a\u6587\u4ef6\u4f5c\u4e3a Dockerfile\u3002</p> <p>\u5f53\u7136\uff0c\u4e00\u822c\u5927\u5bb6\u4e60\u60ef\u6027\u7684\u4f1a\u4f7f\u7528\u9ed8\u8ba4\u7684\u6587\u4ef6\u540d Dockerfile\uff0c\u4ee5\u53ca\u4f1a\u5c06\u5176\u7f6e\u4e8e\u955c\u50cf\u6784\u5efa\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\u3002</p>"},{"location":"docker/dockerfile_usage/#_49","title":"\u63a8\u9001\u955c\u50cf","text":"<p>\u4e0a\u9762\u6211\u4eec\u8bb2\u5230\u4e86 Dockerfile \u7684\u57fa\u672c\u5199\u6cd5\u4ee5\u53ca\u6784\u5efa\u955c\u50cf\u7684\u65f6\u5019\u4e00\u4e9b\u6ce8\u610f\u4e8b\u9879\uff0c\u90a3\u4e48\u955c\u50cf\u6784\u5efa\u5b8c\u6210\u540e\uff0c\u5982\u4f55\u628a\u6211\u4eec\u7684\u955c\u50cf\u7ed9\u5230\u522b\u4eba\u4f7f\u7528\u5462\uff1f\u7b2c\u4e00\u79cd\u65b9\u6cd5\u5c31\u662f\u5229\u7528 Docker \u5b98\u65b9\u63d0\u4f9b\u7684\u516c\u5171\u7684 Docker Hub \u4ed3\u5e93\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u955c\u50cf\u63a8\u9001\u4e0a\u53bb\uff0c\u7136\u540e\u522b\u4eba\u5c31\u53ef\u4ee5\u76f4\u63a5\u62c9\u53d6\u955c\u50cf\u3002</p>"},{"location":"docker/dockerfile_usage/#_50","title":"\u6ce8\u518c","text":"<p>\u9996\u5148\u9700\u8981 https://cloud.docker.com \u514d\u8d39\u6ce8\u518c\u4e00\u4e2a Docker \u8d26\u53f7\u3002</p>"},{"location":"docker/dockerfile_usage/#_51","title":"\u767b\u5f55","text":"<p>\u7136\u540e\u901a\u8fc7\u6267\u884c<code>docker login</code>\u547d\u4ee4\u4ea4\u4e92\u5f0f\u7684\u8f93\u5165\u7528\u6237\u540d\u53ca\u5bc6\u7801\u6765\u5b8c\u6210\u5728\u547d\u4ee4\u884c\u754c\u9762\u767b\u5f55 Docker Hub\u3002</p> <pre><code>$ docker login\nLogin with your Docker ID to push and pull images from Docker Hub. If you don't have a Docker ID, head over to https://hub.docker.com to create one.\nUsername: cnych\nPassword:\nWARNING! Your password will be stored unencrypted in /root/.docker/config.json.\nConfigure a credential helper to remove this warning. See\nhttps://docs.docker.com/engine/reference/commandline/login/#credentials-store\n\nLogin Succeeded\n</code></pre>"},{"location":"docker/dockerfile_usage/#_52","title":"\u6ce8\u9500","text":"<p>\u4f60\u53ef\u4ee5\u901a\u8fc7<code>docker logout</code>\u9000\u51fa\u767b\u5f55\u3002</p>"},{"location":"docker/dockerfile_usage/#_53","title":"\u63a8\u9001\u955c\u50cf","text":"<p>\u7528\u6237\u5728\u767b\u5f55\u540e\u53ef\u4ee5\u901a\u8fc7<code>docker push</code>\u547d\u4ee4\u6765\u5c06\u81ea\u5df1\u7684\u955c\u50cf\u63a8\u9001\u5230 Docker Hub\u3002\u4ee5\u4e0b\u547d\u4ee4\u4e2d\u7684 username \u8bf7\u66ff\u6362\u4e3a\u4f60\u7684 Docker \u8d26\u53f7\u7528\u6237\u540d\u3002</p> <pre><code>$ docker tag ubuntu:10 username/ubuntu:10\n$ docker image ls\n\nREPOSITORY                                               TAG                    IMAGE ID            CREATED             SIZE\nubuntu                                                   10                  275d79972a86        6 days ago          6MB\nusername/ubuntu                                          10                  275d79972a86        6 days ago          6MB\n$ docker push username/ubuntu:10\n</code></pre>"},{"location":"docker/dockerfile_usage/#_54","title":"\u79c1\u6709\u4ed3\u5e93","text":"<p>\u6709\u65f6\u5019\u6211\u4eec\u53ef\u80fd\u5e0c\u671b\u6211\u4eec\u7684\u955c\u50cf\u53ea\u5728\u5c40\u57df\u7f51\u8303\u56f4\u5185\u4f7f\u7528\uff0c\u4e0d\u5e0c\u671b\u63a8\u9001\u5230 Docker Hub \u8fd9\u6837\u7684\u516c\u5171\u4ed3\u5e93\uff0c\u90a3\u4e48\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u672c\u5730\u4ed3\u5e93\u4f9b\u79c1\u4eba\u4f7f\u7528\u3002</p> <p><code>docker-registry</code> \u5c31\u662f\u662f\u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e2a\u79c1\u6709\u4ed3\u5e93\u5de5\u5177\uff0c\u53ef\u4ee5\u7528\u4e8e\u5b58\u50a8\u79c1\u6709\u7684\u955c\u50cf\u4ed3\u5e93\u3002\u540c\u6837\u7684\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u83b7\u53d6\u5b98\u65b9 registry \u955c\u50cf\u6765\u76f4\u63a5\u8fd0\u884c\uff1a</p> <pre><code>$ docker run -d -p 5000:5000 --name registry registry:2\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u4f7f\u7528\u5b98\u65b9\u7684 registry \u955c\u50cf\u6765\u542f\u52a8\u79c1\u6709\u4ed3\u5e93\u5bb9\u5668\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4ed3\u5e93\u4f1a\u88ab\u521b\u5efa\u5728\u5bb9\u5668\u7684<code>/var/lib/registry</code>\u76ee\u5f55\u4e0b\u3002\u4f60\u53ef\u4ee5\u901a\u8fc7 <code>-v</code> \u53c2\u6570\u6765\u5c06\u955c\u50cf\u6587\u4ef6\u5b58\u653e\u5728\u672c\u5730\u7684\u6307\u5b9a\u8def\u5f84\u3002\u4f8b\u5982\u4e0b\u9762\u7684\u4f8b\u5b50\u5c06\u4e0a\u4f20\u7684\u955c\u50cf\u653e\u5230\u672c\u5730\u7684 <code>/opt/data/registry</code> \u76ee\u5f55:</p> <pre><code>$ docker run -d \\\\\n    -p 5000:5000 \\\\\n    -v /opt/data/registry:/var/lib/registry \\\\\n    registry:2\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u8fd0\u884c\u4e86\u4e00\u4e2a\u6570\u636e\u6301\u4e45\u5316\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u3002</p> <p>\u521b\u5efa\u597d\u79c1\u6709\u4ed3\u5e93\u4e4b\u540e\uff0c\u7136\u540e\u53ef\u4ee5\u4f7f\u7528<code>docker tag</code>\u6765\u6807\u8bb0\u4e00\u4e2a\u955c\u50cf\uff0c\u7136\u540e\u63a8\u9001\u5b83\u5230\u4ed3\u5e93\u3002\u6bd4\u5982\u79c1\u6709\u4ed3\u5e93\u5730\u5740\u4e3a<code>127.0.0.1:5000</code>\u3002\u5148\u5728\u672c\u673a\u67e5\u770b\u5df2\u6709\u7684\u955c\u50cf\u3002</p> <pre><code>$ docker images\nREPOSITORY                        TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nubuntu                            latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u4f7f\u7528<code>docker tag</code>\u5c06 ubuntu:latest \u8fd9\u4e2a\u955c\u50cf\u6807\u8bb0\u4e3a </p> <pre><code>11:5000/ubuntu:latest\n</code></pre> <p>:</p> <pre><code>$ docker tag ubuntu:latest 11:5000/ubuntu:latest\n$ docker images\nREPOSITORY                        TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nubuntu                            latest              ba5877dc9bec        6 weeks ago         17 MB\n11:5000/ubuntu:latest      latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u7136\u540e\u5c31\u53ef\u4ee5\u4f7f\u7528<code>docker push</code>\u4e0a\u4f20\u6807\u8bb0\u7684\u955c\u50cf:</p> <pre><code>$ docker push 11:5000/ubuntu:latest\nThe push refers to repository [11:5000/ubuntu]\n373a30c24545: Pushed\na9148f5200b0: Pushed\ncdd3de0940ab: Pushedfc56279bbb33: Pushed\nb38367233d37: Pushed\n2aebd096e0e2: Pushed\nlatest: digest: sha256:fe4277621f10b5026266932ddf760f5a756d2facd505a94d2da12f4f52f71f5a size: 1568\n</code></pre> <p>\u6b64\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528 registry \u4ed3\u5e93\u63d0\u4f9b\u7684 API \u6765\u67e5\u770b\u4ed3\u5e93\u4e2d\u7684\u955c\u50cf\uff1a</p> <pre><code>$ curl 11:5000/v2/_catalog\n{\"repositories\":[\"ubuntu\"]}\n</code></pre> <p>\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230 {\"repositories\":[\"ubuntu\"]}\uff0c\u8868\u660e\u955c\u50cf\u5df2\u7ecf\u88ab\u6210\u529f\u4e0a\u4f20\u4e86\u3002</p> <p>\u5148\u5220\u9664\u5df2\u6709\u955c\u50cf\uff0c\u518d\u5c1d\u8bd5\u4ece\u79c1\u6709\u4ed3\u5e93\u4e2d\u4e0b\u8f7d\u8fd9\u4e2a\u955c\u50cf\u3002</p> <pre><code>$ docker image rm 11:5000/ubuntu:latest\n$ docker pull 11:5000/ubuntu:latest\nPulling repository 11:5000/ubuntu:latest\nba5877dc9bec: Download complete\n511136ea3c5a: Download complete\n9bad880da3d2: Download complete\n25f11f5fb0cb: Download complete\nebc34468f71d: Download complete\n2318d26665ef: Download complete\n$ docker image ls\nREPOSITORY                         TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\n11:5000/ubuntu:latest       latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u628a\u955c\u50cf\u4e0a\u4f20\u5230\u4e86\u79c1\u6709\u4ed3\u5e93\u4e2d\u7684\u5b8c\u6574\u8fc7\u7a0b\u3002</p>"},{"location":"docker/dockerfile_usage/#_55","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p>\u5982\u679c\u4f60\u4e0d\u60f3\u4f7f\u7528 <code>127.0.0.1:5000</code> \u4f5c\u4e3a\u4ed3\u5e93\u5730\u5740\uff0c\u6bd4\u5982\u60f3\u8ba9\u672c\u7f51\u6bb5\u7684\u5176\u4ed6\u4e3b\u673a\u4e5f\u80fd\u628a\u955c\u50cf\u63a8\u9001\u5230\u79c1\u6709\u4ed3\u5e93\u3002\u4f60\u5c31\u5f97\u628a\u4f8b\u5982 <code>192.168.199.100:5000</code> \u8fd9\u6837\u7684\u5185\u7f51\u5730\u5740\u4f5c\u4e3a\u79c1\u6709\u4ed3\u5e93\u5730\u5740\uff0c\u8fd9\u65f6\u4f60\u4f1a\u53d1\u73b0\u65e0\u6cd5\u6210\u529f\u63a8\u9001\u955c\u50cf\u3002</p> <p>\u8fd9\u662f\u56e0\u4e3a Docker \u9ed8\u8ba4\u4e0d\u5141\u8bb8\u975e HTTPS \u65b9\u5f0f\u63a8\u9001\u955c\u50cf\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Docker \u7684\u914d\u7f6e\u9009\u9879\u6765\u53d6\u6d88\u8fd9\u4e2a\u9650\u5236\uff0c\u6211\u4eec\u8fd9\u91cc\u662f CentOS 7 \u7cfb\u7edf\uff0c\u540c\u6837\u8fd8\u662f\u7f16\u8f91\u6587\u4ef6</p> <pre><code>/etc/docker/daemon.json\n</code></pre> <p>\uff0c\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>{\n  \"registry-mirror\": [\n    \"https://registry.docker-cn.com\"\n  ],\n  \"insecure-registries\": [\n    \"111100:5000\"\n  ]\n}\n</code></pre> <p>\u5176\u4e2d\u7684<code>insecure-registries</code>\u5c31\u662f\u6211\u4eec\u6dfb\u52a0\u7684\u5185\u5bb9\uff0c\u7136\u540e\u91cd\u542f Docker \u4e4b\u540e\u5c31\u53ef\u4ee5\u5728\u5c40\u57df\u7f51\u5185\u4f7f\u7528\u6211\u4eec\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u4e86\u3002</p> <p>\u9ed8\u8ba4\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u53ef\u4ee5\u6ee1\u8db3\u6211\u4eec\u7684\u5f88\u591a\u9700\u6c42\uff0c\u4f46\u662f\u5f80\u5f80\u5728\u4f01\u4e1a\u4e2d\u4f7f\u7528\u7684\u8bdd\u8fd8\u6709\u5f88\u5b89\u5168\u6027\u65b9\u9762\u7684\u529f\u80fd\u7684\u7f3a\u5931\uff0c\u6bd4\u5982\u6743\u9650\u7ba1\u7406\u4e4b\u7c7b\u7684\uff0c\u8fd9\u5bf9\u4e8e\u4f01\u4e1a\u6765\u8bf4\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u4e0d\u8fc7 registry \u5bf9\u4e8e\u6743\u9650\u7ba1\u7406\u8fd9\u4e00\u5757\u505a\u4e86\u4e00\u4e2a\u5bf9\u5916\u66b4\u9732\u7684\u63a5\u53e3\uff0c\u53ea\u8981\u6211\u4eec\u5b9e\u73b0\u4ed6\u66b4\u9732\u7684\u5b89\u5168\u63a5\u53e3\u5c31\u53ef\u4ee5\u6765\u5b9e\u73b0\u6743\u9650\u7ba1\u7406\u76f8\u5173\u7684\u63a5\u53e3\uff0c\u5176\u4e2d\u6ce8\u660e\u7684\u5f00\u6e90\u955c\u50cf\u7ba1\u7406\u8f6f\u4ef6 Harbor \u5c31\u662f\u8fd9\u7c7b\u5e94\u7528\u7684\u4f7c\u4f7c\u8005\uff0c\u6211\u4eec\u8fd8\u5728\u540e\u9762\u7684\u8bfe\u7a0b\u4e2d\u548c\u5927\u5bb6\u5b66\u4e60 Harbor \u7684\u4e00\u4e2a\u4f7f\u7528\u3002\ue3c9</p>"},{"location":"docker/dockerfile_usage/#dockerfile_5","title":"Dockerfile","text":"<p>\u4f7f\u7528 Dockerfile \u5b9a\u5236\u955c\u50cf</p> <p></p> <p>\u955c\u50cf\u7684\u5b9a\u5236\u5b9e\u9645\u4e0a\u5c31\u662f\u5b9a\u5236\u955c\u50cf\u7684\u6bcf\u4e00\u5c42\u6240\u6dfb\u52a0\u7684\u914d\u7f6e\u3001\u6587\u4ef6\u7b49\u4fe1\u606f\uff0c\u5b9e\u9645\u4e0a\u5f53\u6211\u4eec\u5728\u4e00\u4e2a\u5bb9\u5668\u4e2d\u6dfb\u52a0\u6216\u8005\u4fee\u6539\u4e86\u4e00\u4e9b\u6587\u4ef6\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7<code>docker commit</code>\u547d\u4ee4\u6765\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u955c\u50cf\uff0c\u4f46\u662f\u8fd9\u4e2a\u65b9\u6cd5\u4e0d\u591f\u76f4\u89c2\uff0c\u6ca1\u529e\u6cd5\u8ffd\u6eaf\u6211\u4eec\u955c\u50cf\u91cc\u9762\u5230\u5e95\u6709\u54ea\u4e9b\u5185\u5bb9\uff0c\u6240\u4ee5\u5b9e\u9645\u5b9a\u5236\u955c\u50cf\u7684\u8fc7\u7a0b\u6211\u4eec\u5f88\u5c11\u91c7\u7528\u8fd9\u79cd\u65b9\u5f0f\u3002\u800c\u662f\u4f7f\u7528\u4e00\u4e2a\u540d\u4e3a <code>Dockerfile</code> \u7684\u6587\u672c\u6587\u4ef6\u6765\u8fdb\u884c\u955c\u50cf\u5b9a\u5236\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u955c\u50cf\u7684\u6bcf\u4e00\u5c42\u4fee\u6539\u3001\u5b89\u88c5\u3001\u6784\u5efa\u3001\u64cd\u4f5c\u7684\u547d\u4ee4\u90fd\u5199\u5165\u5230\u8fd9\u4e2a\u6587\u4ef6\u4e2d\uff0c\u4e00\u884c\u5c31\u5bf9\u5e94\u955c\u50cf\u7684\u4e00\u5c42\uff0c\u8fd9\u79cd\u65b9\u6cd5\u663e\u7136\u8981\u66f4\u9ad8\u7ea7\uff0c\u56e0\u4e3a\u6211\u4eec\u6709\u4e00\u4e2a\u6587\u4ef6\u6765\u76f4\u89c2\u53cd\u6620\u6211\u4eec\u7684\u955c\u50cf\u5185\u5bb9\uff0c\u8fd8\u53ef\u4ee5\u4f5c\u4e3a\u7248\u672c\u8bb0\u5f55\u8fdb\u884c\u8ddf\u8e2a\u3002</p>"},{"location":"docker/dockerfile_usage/#_56","title":"\u5b9a\u5236\u955c\u50cf","text":"<p>\u4ee5\u6211\u4eec\u4e4b\u524d\u7684 nginx \u955c\u50cf\u4e3a\u4f8b\uff0c\u6211\u4eec\u73b0\u5728\u6765\u5b9a\u5236\u4e00\u4e2a nginx \u955c\u50cf\uff0c\u8981\u6c42\u9ed8\u8ba4\u7684\u5e94\u7528\u9875\u9762\u8bbf\u95ee\u7684\u5185\u5bb9\u662f <code>Hello Docker</code>\u3002</p> <p>\u9996\u5148\u6211\u4eec\u65b0\u5efa\u4e00\u4e2a\u76ee\u5f55 testnginx\uff0c\u7136\u540e\u5728\u8be5\u76ee\u5f55\u4e0b\u9762\u65b0\u5efa\u4e00\u4e2a\u540d\u4e3a<code>Dockerfile</code>\u7684\u7a7a\u767d\u6587\u672c\u6587\u4ef6\uff1a</p> <pre><code>$ mkdir -p testnginx &amp;&amp; cd testnginx &amp;&amp; touch Dockerfile\n</code></pre> <p>\u7136\u540e\u5411<code>Dockerfile</code>\u6587\u4ef6\u4e2d\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>FROM nginx\nRUN echo 'Hello Docker!' &gt; /user/share/nginx/html/index.html\n</code></pre> <p>\u8fd9\u4e2a\u6587\u4ef6\u5f88\u7b80\u5355\uff0c\u4e00\u5171\u5c31\u4e24\u884c\uff0c\u5176\u4e2d\u5305\u542b\u4e24\u6761\u6307\u4ee4\uff0c<code>FROM</code> \u548c <code>RUN</code>\u3002</p>"},{"location":"docker/dockerfile_usage/#from_5","title":"FROM \u6307\u4ee4","text":"<p>\u5b9a\u5236\u955c\u50cf\uff0c\u90a3\u4e48\u80af\u5b9a\u662f\u4e00\u4e2a\u955c\u50cf\u4e3a\u57fa\u7840\uff0c\u5728\u5176\u57fa\u7840\u4e0a\u8fdb\u884c\u5b9a\u5236\uff0c\u800c <code>FROM</code> \u8fd9\u4e2a\u6307\u4ee4\u5c31\u662f\u6765\u6307\u5b9a\u57fa\u7840\u955c\u50cf\u7684\uff0c\u6240\u4ee5\u5728\u4e00\u4e2a <code>Dockerfile</code> \u6587\u4ef6\u4e2d <code>FROM</code> \u6307\u4ee4\u662f\u5fc5\u5907\u7684\uff0c\u5e76\u4e14\u5fc5\u987b\u662f\u7b2c\u4e00\u6761\u6307\u4ee4\u3002</p> <p>\u5728 Docker Hub \u4e0a\u6709\u975e\u5e38\u591a\u7684\u9ad8\u8d28\u91cf\u7684\u5b98\u65b9\u955c\u50cf\uff0c\u6709\u4e00\u4e9b\u53ef\u4ee5\u76f4\u63a5\u62ff\u6765\u4f7f\u7528\u7684\u670d\u52a1\u7c7b\u7684\u955c\u50cf\uff0c\u5982 nginx\u3001redis\u3001mongo\u3001mysql\u3001httpd\u3001php\u3001tomcat \u7b49\uff1b\u4e5f\u6709\u4e00\u4e9b\u65b9\u4fbf\u5f00\u53d1\u3001\u6784\u5efa\u3001\u8fd0\u884c\u5404\u79cd\u8bed\u8a00\u5e94\u7528\u7684\u955c\u50cf\uff0c\u5982 node\u3001openjdk\u3001python\u3001ruby\u3001golang \u7b49\u3002\u53ef\u4ee5\u5728\u5176\u4e2d\u5bfb\u627e\u4e00\u4e2a\u6700\u7b26\u5408\u6211\u4eec\u6700\u7ec8\u76ee\u6807\u7684\u955c\u50cf\u4e3a\u57fa\u7840\u955c\u50cf\u8fdb\u884c\u5b9a\u5236\u3002</p> <p>\u5982\u679c\u6ca1\u6709\u627e\u5230\u5408\u9002\u7684\u57fa\u7840\u955c\u50cf\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e9b\u66f4\u4e3a\u57fa\u7840\u7684\u64cd\u4f5c\u7cfb\u7edf\u955c\u50cf\uff0c\u6bd4\u5982 ubuntu\u3001debian\u3001centos\u3001alpine \u7b49\uff0c\u8fd9\u4e9b\u57fa\u7840\u955c\u50cf\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u66f4\u5927\u7684\u6269\u5c55\u7a7a\u95f4\uff0c\u5c31\u7c7b\u4f3c\u4e8e\u5e73\u65f6\u6211\u4eec\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e0a\u9762\u90e8\u7f72\u81ea\u5df1\u7684\u670d\u52a1\u4e00\u6837\u7684\u64cd\u4f5c\u3002</p> <p>\u9664\u4e86\u9009\u62e9\u73b0\u6709\u955c\u50cf\u4e3a\u57fa\u7840\u955c\u50cf\u5916\uff0cDocker \u8fd8\u5b58\u5728\u4e00\u4e2a\u7279\u6b8a\u7684\u955c\u50cf\uff0c\u540d\u4e3a <code>scratch</code>\uff0c\u8fd9\u4e2a\u955c\u50cf\u662f\u4e00\u4e2a\u865a\u62df\u7684\u955c\u50cf\uff0c\u5e76\u4e0d\u5b9e\u9645\u5b58\u5728\uff0c\u8868\u793a\u4e00\u4e2a\u7a7a\u767d\u7684\u955c\u50cf\uff1a</p> <p><code>FROM scratch ...</code></p> <p>\u5982\u679c\u4f60\u4ee5 <code>scratch</code> \u4e3a\u57fa\u7840\u955c\u50cf\u7684\u8bdd\uff0c\u610f\u5473\u7740\u4f60\u4e0d\u4ee5\u4efb\u4f55\u955c\u50cf\u4e3a\u57fa\u7840\uff0c\u63a5\u4e0b\u6765\u6240\u5199\u7684\u6307\u4ee4\u5c06\u4f5c\u4e3a\u955c\u50cf\u7b2c\u4e00\u5c42\u5f00\u59cb\u5b58\u5728\u3002\u6709\u7684\u540c\u5b66\u53ef\u80fd\u611f\u89c9\u5f88\u5947\u602a\uff0c\u6ca1\u6709\u4efb\u4f55\u57fa\u7840\u955c\u50cf\uff0c\u6211\u600e\u4e48\u53bb\u6267\u884c\u6211\u7684\u7a0b\u5e8f\u5462\uff0c\u5176\u5b9e\u5bf9\u4e8e Linux \u4e0b\u9759\u6001\u7f16\u8bd1\u7684\u7a0b\u5e8f\u6765\u8bf4\uff0c\u5e76\u4e0d\u9700\u8981\u6709\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u8fd0\u884c\u65f6\u652f\u6301\uff0c\u6240\u9700\u7684\u4e00\u5207\u5e93\u90fd\u5df2\u7ecf\u5728\u53ef\u6267\u884c\u6587\u4ef6\u91cc\u4e86\uff0c\u56e0\u6b64\u76f4\u63a5<code>FROM scratch</code>\u4f1a\u8ba9\u955c\u50cf\u4f53\u79ef\u66f4\u52a0\u5c0f\u5de7\u3002\u4f7f\u7528 Go \u8bed\u8a00 \u5f00\u53d1\u7684\u5e94\u7528\u5f88\u591a\u4f1a\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u6765\u5236\u4f5c\u955c\u50cf\uff0c\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u6709\u5f88\u591a\u89c2\u70b9\u8ba4\u4e3a Go \u662f\u7279\u522b\u9002\u5408\u5bb9\u5668\u5fae\u670d\u52a1\u67b6\u6784\u7684\u8bed\u8a00\u7684\u539f\u56e0\u4e4b\u4e00\u3002</p>"},{"location":"docker/dockerfile_usage/#run_5","title":"RUN \u6307\u4ee4","text":"<p><code>RUN</code> \u6307\u4ee4\u662f\u7528\u6765\u6267\u884c\u547d\u4ee4\u884c\u547d\u4ee4\u7684\u3002\u7531\u4e8e\u547d\u4ee4\u884c\u7684\u5f3a\u5927\u80fd\u529b\uff0c\u6240\u4ee5 <code>RUN</code> \u6307\u4ee4\u662f\u5b9a\u5236\u955c\u50cf\u65f6\u662f\u6700\u5e38\u7528\u7684\u6307\u4ee4\u4e4b\u4e00\u3002\u5176\u683c\u5f0f\u6709\u4e24\u79cd\uff1a</p> <ul> <li> <p>shell \u683c\u5f0f\uff1a<code>RUN &lt;\u547d\u4ee4&gt;</code>\uff0c\u5c31\u50cf\u76f4\u63a5\u5728\u547d\u4ee4\u884c\u4e2d\u8f93\u5165\u7684\u547d\u4ee4\u4e00\u6837\u3002\u521a\u624d\u5199\u7684 Dockerfile \u4e2d\u7684 RUN \u6307\u4ee4\u5c31\u662f\u8fd9\u79cd\u683c\u5f0f\uff1a</p> <pre><code>RUN echo 'Hello, Docker!' &gt; /usr/share/nginx/html/index.html\n</code></pre> </li> <li> <p>exec \u683c\u5f0f\uff1a</p> <pre><code>RUN [\"\u53ef\u6267\u884c\u6587\u4ef6\", \"\u53c2\u65701\", \"\u53c2\u65702\"]\n</code></pre> <p>\uff0c\u8fd9\u66f4\u50cf\u662f\u51fd\u6570\u8c03\u7528\u4e2d\u7684\u683c\u5f0f\u3002\u65e2\u7136 RUN \u5c31\u50cf Shell \u811a\u672c\u4e00\u6837\u53ef\u4ee5\u6267\u884c\u547d\u4ee4\uff0c\u90a3\u4e48\u6211\u4eec\u662f\u5426\u5c31\u53ef\u4ee5\u50cf Shell \u811a\u672c\u4e00\u6837\u628a\u6bcf\u4e2a\u547d\u4ee4\u5bf9\u5e94\u4e00\u4e2a RUN \u5462\uff1f\u6bd4\u5982\u8fd9\u6837\uff1a</p> <pre><code>FROM debian:jessie\nRUN apt-get update\nRUN apt-get install -y gcc libc6-dev make wget\nRUN wget -O redis.tar.gz \"http://download.redis.io/releases/redis-tar.gz\"\nRUN mkdir -p /usr/src/redis\nRUN tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1\nRUN make -C /usr/src/redis\nRUN make -C /usr/src/redis install\n# \u5176\u4ed6\u6307\u4ee4...\n</code></pre> </li> </ul> <p>\u4e4b\u524d\u8bf4\u8fc7\uff0cDockerfile \u4e2d\u6bcf\u4e00\u4e2a\u6307\u4ee4\u90fd\u4f1a\u5efa\u7acb\u4e00\u5c42\uff0cRUN \u4e5f\u4e0d\u4f8b\u5916\u3002\u6bcf\u4e00\u4e2a RUN \u5c31\u4f1a\u65b0\u5efa\u7acb\u4e00\u5c42\uff0c\u5728\u5176\u4e0a\u6267\u884c\u8fd9\u4e9b\u547d\u4ee4\uff0c\u6267\u884c\u7ed3\u675f\u540e\uff0ccommit \u8fd9\u4e00\u5c42\u7684\u4fee\u6539\uff0c\u6784\u6210\u65b0\u7684\u955c\u50cf\u3002</p> <p>\u800c\u4e0a\u9762\u7684\u8fd9\u79cd\u5199\u6cd5\uff0c\u521b\u5efa\u4e86 7 \u5c42\u955c\u50cf\u3002\u8fd9\u662f\u5b8c\u5168\u6ca1\u6709\u5fc5\u8981\u7684\uff0c\u800c\u4e14\u5f88\u591a\u8fd0\u884c\u65f6\u4e0d\u9700\u8981\u7684\u4e1c\u897f\uff0c\u90fd\u88ab\u88c5\u8fdb\u4e86\u955c\u50cf\u91cc\uff0c\u6bd4\u5982\u7f16\u8bd1\u73af\u5883\u3001\u66f4\u65b0\u7684\u8f6f\u4ef6\u5305\u7b49\u7b49\u3002\u7ed3\u679c\u5c31\u662f\u4ea7\u751f\u975e\u5e38\u81c3\u80bf\u3001\u975e\u5e38\u591a\u5c42\u7684\u955c\u50cf\uff0c\u4e0d\u4ec5\u4ec5\u589e\u52a0\u4e86\u6784\u5efa\u90e8\u7f72\u7684\u65f6\u95f4\uff0c\u4e5f\u5f88\u5bb9\u6613\u51fa\u9519\u3002 \u8fd9\u662f\u5f88\u591a\u521d\u5b66 Docker \u7684\u4eba\u5e38\u72af\u7684\u4e00\u4e2a\u9519\u8bef\u3002</p> <p>UnionFS \u5c42\u9650\u5236</p> <p>UnionFS \u5b9e\u9645\u4e0a\u662f\u6709\u6700\u5927\u5c42\u6570\u9650\u5236\u7684\uff0c\u6bd4\u5982 AUFS\uff0c\u66fe\u7ecf\u662f\u6700\u5927\u4e0d\u5f97\u8d85\u8fc7 42 \u5c42\uff0c\u73b0\u5728\u662f\u4e0d\u5f97\u8d85\u8fc7 127 \u5c42\u3002</p> <p>\u4e0a\u9762\u7684 Dockerfile \u6b63\u786e\u7684\u5199\u6cd5\u5e94\u8be5\u662f\u8fd9\u6837\uff1a</p> <pre><code>FROM debian:jessie\nRUN buildDeps='gcc libc6-dev make wget' \\\\\n    &amp;&amp; apt-get update \\\\\n    &amp;&amp; apt-get install -y $buildDeps \\\\\n    &amp;&amp; wget -O redis.tar.gz \"http://download.redis.io/releases/redis-tar.gz\" \\\\\n    &amp;&amp; mkdir -p /usr/src/redis \\\\\n    &amp;&amp; tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1 \\\\\n    &amp;&amp; make -C /usr/src/redis \\\\\n    &amp;&amp; make -C /usr/src/redis install \\\\\n    &amp;&amp; rm -rf /var/lib/apt/lists/* \\\\\n    &amp;&amp; rm redis.tar.gz \\\\\n    &amp;&amp; rm -r /usr/src/redis \\\\\n    &amp;&amp; apt-get purge -y --auto-remove $buildDeps\n# \u5176\u4ed6\u6307\u4ee4...\n</code></pre> <p>\u9996\u5148\uff0c\u4e4b\u524d\u6240\u6709\u7684\u547d\u4ee4\u53ea\u6709\u4e00\u4e2a\u76ee\u7684\uff0c\u5c31\u662f\u7f16\u8bd1\u3001\u5b89\u88c5 redis \u53ef\u6267\u884c\u6587\u4ef6\u3002\u56e0\u6b64\u6ca1\u6709\u5fc5\u8981\u5efa\u7acb\u5f88\u591a\u5c42\uff0c\u8fd9\u53ea\u662f\u4e00\u5c42\u7684\u4e8b\u60c5\u3002\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u6ca1\u6709\u4f7f\u7528\u5f88\u591a\u4e2a RUN \u6307\u4ee4\u6765\u5bf9\u5e94\u4e0d\u540c\u7684\u547d\u4ee4\uff0c\u800c\u662f\u4ec5\u4ec5\u4f7f\u7528\u4e00\u4e2a RUN \u6307\u4ee4\uff0c\u5e76\u4f7f\u7528<code>&amp;&amp;</code>\u5c06\u5404\u4e2a\u6240\u9700\u547d\u4ee4\u4e32\u8054\u8d77\u6765\u3002\u5c06\u4e4b\u524d\u7684 7 \u5c42\uff0c\u7b80\u5316\u4e3a\u4e86 1 \u5c42\u3002\u5728\u64b0\u5199 Dockerfile \u7684\u65f6\u5019\uff0c\u8981\u7ecf\u5e38\u63d0\u9192\u81ea\u5df1\uff0c\u8fd9\u5e76\u4e0d\u662f\u5728\u5199 Shell \u811a\u672c\uff0c\u800c\u662f\u5728\u5b9a\u4e49\u6bcf\u4e00\u5c42\u8be5\u5982\u4f55\u6784\u5efa\u3002</p> <p>\u5e76\u4e14\uff0c\u8fd9\u91cc\u4e3a\u4e86\u683c\u5f0f\u5316\u8fd8\u8fdb\u884c\u4e86\u6362\u884c\u3002Dockerfile \u652f\u6301 Shell \u7c7b\u7684\u884c\u5c3e\u6dfb\u52a0<code>\\</code>\u7684\u547d\u4ee4\u6362\u884c\u65b9\u5f0f\uff0c\u4ee5\u53ca\u884c\u9996<code>#</code>\u8fdb\u884c\u6ce8\u91ca\u7684\u683c\u5f0f\u3002\u826f\u597d\u7684\u683c\u5f0f\uff0c\u6bd4\u5982<code>\u6362\u884c\u3001\u7f29\u8fdb\u3001\u6ce8\u91ca</code>\u7b49\uff0c\u4f1a\u8ba9\u7ef4\u62a4\u3001\u6392\u969c\u66f4\u4e3a\u5bb9\u6613\uff0c\u8fd9\u662f\u4e00\u4e2a\u6bd4\u8f83\u597d\u7684\u4e60\u60ef\u3002</p> <p>\u6b64\u5916\uff0c\u8fd8\u53ef\u4ee5\u770b\u5230\u8fd9\u4e00\u7ec4\u547d\u4ee4\u7684\u6700\u540e\u6dfb\u52a0\u4e86\u6e05\u7406\u5de5\u4f5c\u7684\u547d\u4ee4\uff0c\u5220\u9664\u4e86\u4e3a\u4e86\u7f16\u8bd1\u6784\u5efa\u4e0b\u8f7d\u7684\u8f6f\u4ef6\uff0c\u6e05\u7406\u4e86\u6240\u6709\u4e0b\u8f7d\u3001\u5c55\u5f00\u7684\u6587\u4ef6\uff0c\u5e76\u4e14\u8fd8\u6e05\u7406\u4e86 apt \u7f13\u5b58\u6587\u4ef6\u3002\u8fd9\u662f\u5f88\u91cd\u8981\u7684\u4e00\u6b65\uff0c\u6211\u4eec\u4e4b\u524d\u8bf4\u8fc7\uff0c\u955c\u50cf\u662f\u591a\u5c42\u5b58\u50a8\uff0c\u6bcf\u4e00\u5c42\u7684\u4e1c\u897f\u5e76\u4e0d\u4f1a\u5728\u4e0b\u4e00\u5c42\u88ab\u5220\u9664\uff0c\u4f1a\u4e00\u76f4\u8ddf\u968f\u7740\u955c\u50cf\u3002\u56e0\u6b64\u955c\u50cf\u6784\u5efa\u65f6\uff0c\u4e00\u5b9a\u8981\u786e\u4fdd\u6bcf\u4e00\u5c42\u53ea\u6dfb\u52a0\u771f\u6b63\u9700\u8981\u6dfb\u52a0\u7684\u4e1c\u897f\uff0c\u4efb\u4f55\u65e0\u5173\u7684\u4e1c\u897f\u90fd\u5e94\u8be5\u6e05\u7406\u6389\u3002 \u5f88\u591a\u4eba\u521d\u5b66 Docker \u5236\u4f5c\u51fa\u4e86\u5f88\u81c3\u80bf\u7684\u955c\u50cf\u7684\u539f\u56e0\u4e4b\u4e00\uff0c\u5c31\u662f\u5fd8\u8bb0\u4e86\u6bcf\u4e00\u5c42\u6784\u5efa\u7684\u6700\u540e\u4e00\u5b9a\u8981\u6e05\u7406\u6389\u65e0\u5173\u6587\u4ef6\u3002</p>"},{"location":"docker/dockerfile_usage/#workdir_5","title":"WORKDIR \u6307\u4ee4","text":"<p><code>WORKDIR</code> \u6307\u4ee4\u8bbe\u7f6e Dockerfile \u4e2d\u7684\u4efb\u4f55 RUN\uff0cCMD\uff0cENTRPOINT\uff0cCOPY \u548c ADD \u6307\u4ee4\u7684\u5de5\u4f5c\u76ee\u5f55\u3002\u5982\u679c WORKDIR \u6307\u5b9a\u7684\u76ee\u5f55\u4e0d\u5b58\u5728\uff0c\u5373\u4f7f\u968f\u540e\u7684\u6307\u4ee4\u6ca1\u6709\u7528\u5230\u8fd9\u4e2a\u76ee\u5f55\uff0c\u90fd\u4f1a\u521b\u5efa\u8be5\u76ee\u5f55\u3002</p> <p>\u683c\u5f0f\uff1a </p> <pre><code>WORKDIR /path/to/workdir\n</code></pre> <p>\u4e3a\u4e86\u6e05\u6670\u6027\u548c\u53ef\u9760\u6027\uff0c\u4f60\u5e94\u8be5\u603b\u662f\u5728 WORKDIR \u4e2d\u4f7f\u7528\u7edd\u5bf9\u8def\u5f84\uff0c\u800c\u4e14\u5355\u4e2a Dockerfile \u53ef\u4ee5\u4f7f\u7528\u591a\u6b21WORKDIR\u3002\u53e6\u5916\uff0c\u6211\u4eec\u5e94\u8be5\u4f7f\u7528 WORKDIR \u6765\u66ff\u4ee3\u7c7b\u4f3c\u4e8e </p> <pre><code>RUN cd ... &amp;&amp; do-something\n</code></pre> <p>\u7684\u6307\u4ee4\uff0c\u540e\u8005\u96be\u4ee5\u9605\u8bfb\u3001\u6392\u9519\u548c\u7ef4\u62a4\u3002</p>"},{"location":"docker/dockerfile_usage/#add_copy_5","title":"ADD &amp; COPY \u6307\u4ee4","text":"<p>Dockerfile \u4e2d\u7684 <code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code> \u6307\u4ee4\u90fd\u53ef\u4ee5\u5c06\u4e3b\u673a\u4e0a\u7684\u8d44\u6e90\u590d\u5236\u6216\u52a0\u5165\u5230\u5bb9\u5668\u955c\u50cf\u4e2d\uff0c\u90fd\u662f\u5728\u6784\u5efa\u955c\u50cf\u7684\u8fc7\u7a0b\u4e2d\u5b8c\u6210\u7684\u3002</p> <p><code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code> \u6307\u4ee4\u7684\u552f\u4e00\u533a\u522b\u5728\u4e8e<code>\u662f\u5426\u652f\u6301\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90</code>\u3002<code>COPY</code> \u6307\u4ee4\u53ea\u80fd\u4ece\u6267\u884c<code>docker build</code>\u6240\u5728\u7684\u4e3b\u673a\u4e0a\u8bfb\u53d6\u8d44\u6e90\u5e76\u590d\u5236\u5230\u955c\u50cf\u4e2d\u3002\u800c <code>ADD</code> \u6307\u4ee4\u8fd8\u652f\u6301\u901a\u8fc7 URL \u4ece\u8fdc\u7a0b\u670d\u52a1\u5668\u8bfb\u53d6\u8d44\u6e90\u5e76\u590d\u5236\u5230\u955c\u50cf\u4e2d\u3002</p> <p>\u4e00\u822c\u6765\u8bf4\u6ee1\u8db3\u540c\u7b49\u529f\u80fd\u7684\u60c5\u51b5\u4e0b\uff0c\u63a8\u8350\u4f7f\u7528COPY\u6307\u4ee4\u3002<code>ADD</code> \u6307\u4ee4\u66f4\u64c5\u957f\u8bfb\u53d6\u672c\u5730 tar \u6587\u4ef6\u5e76\u89e3\u538b\u7f29\u3002</p>"},{"location":"docker/dockerfile_usage/#copy_5","title":"COPY \u6307\u4ee4","text":"<p><code>COPY</code> \u6307\u4ee4\u80fd\u591f\u5c06\u6784\u5efa\u547d\u4ee4\u6240\u5728\u7684\u4e3b\u673a\u672c\u5730\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u590d\u5236\u5230\u955c\u50cf\u6587\u4ef6\u7cfb\u7edf\u3002COPY \u6307\u4ee4\u540c\u6837\u4e5f\u652f\u6301 exec \u548c shell \u4e24\u79cd\u683c\u5f0f\uff1a</p> <ul> <li> <p>exec \u683c\u5f0f\u7528\u6cd5\uff1a</p> <pre><code>COPY [\"&lt;src&gt;\",... \"&lt;dest&gt;\"]\n</code></pre> <p>\uff0c\u7279\u522b\u9002\u5408\u8def\u5f84\u4e2d\u5e26\u6709\u7a7a\u683c\u7684\u60c5\u51b5\u3002</p> </li> <li> <p>shell \u683c\u5f0f\u7528\u6cd5\uff1a<code>COPY &lt;src&gt;... &lt;dest&gt;</code></p> </li> </ul>"},{"location":"docker/dockerfile_usage/#add_5","title":"ADD \u6307\u4ee4","text":"<p><code>ADD</code> \u6307\u4ee4\u4e0d\u4ec5\u80fd\u591f\u5c06\u6784\u5efa\u547d\u4ee4\u6240\u5728\u7684\u4e3b\u673a\u672c\u5730\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u800c\u4e14\u80fd\u591f\u5c06\u8fdc\u7a0b URL \u6240\u5bf9\u5e94\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u4f5c\u4e3a\u8d44\u6e90\u590d\u5236\u5230\u955c\u50cf\u6587\u4ef6\u7cfb\u7edf\u3002\u6240\u4ee5\uff0c\u53ef\u4ee5\u8ba4\u4e3a <code>ADD</code> \u662f\u589e\u5f3a\u7248\u7684 <code>COPY</code>\uff0c\u652f\u6301\u5c06\u8fdc\u7a0b URL \u7684\u8d44\u6e90\u52a0\u5165\u5230\u955c\u50cf\u7684\u6587\u4ef6\u7cfb\u7edf\u3002\u540c\u6837\u4e5f\u652f\u6301 exec \u548c shell \u4e24\u79cd\u683c\u5f0f\u7528\u6cd5\uff1a \u00a0 * exec \u683c\u5f0f\u7528\u6cd5\uff1a</p> <pre><code>ADD [\"&lt;src&gt;\",... \"&lt;dest&gt;\"]\n</code></pre> <p>\uff0c\u7279\u522b\u9002\u5408\u8def\u5f84\u4e2d\u5e26\u6709\u7a7a\u683c\u7684\u60c5\u51b5</p> <ul> <li>shell \u683c\u5f0f\u7528\u6cd5\uff1a<code>ADD &lt;src&gt;... &lt;dest&gt;</code></li> </ul> <p>\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90\uff0c\u6bd4\u5982\uff1a</p> <pre><code>ADD http://foo.com/bar.go /tmp/main.go\n</code></pre> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u5bf9\u4e8e\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90\u7684\u60c5\u51b5\uff0c\u7531\u4e8e ADD \u6307\u4ee4\u4e0d\u652f\u6301\u8ba4\u8bc1\uff0c\u5982\u679c\u4ece\u8fdc\u7a0b\u83b7\u53d6\u8d44\u6e90\u9700\u8981\u8ba4\u8bc1\uff0c\u5219\u53ea\u80fd\u4f7f\u7528<code>RUN wget</code> \u6216 <code>RUN curl</code> \u66ff\u4ee3\u4e86\u3002</p> <p>\u6709\u80fd\u529b\u81ea\u52a8\u89e3\u538b\u6587\u4ef6\uff0c\u6bd4\u5982\uff1a</p> <pre><code>ADD /foo.tar.gz /tmp/\n</code></pre> <p>\u4e0a\u8ff0\u6307\u4ee4\u4f1a\u4f7f foo.tar.gz \u538b\u7f29\u6587\u4ef6\u89e3\u538b\u5230\u5bb9\u5668\u7684 /tmp \u76ee\u5f55\u3002</p> <p>\u4e0d\u8fc7\u4e00\u822c\u6765\u8bf4\u867d\u7136 ADD \u6307\u4ee4\u652f\u6301\u4ece\u8fdc\u7a0b\u83b7\u53d6\u8d44\u6e90\uff0c\u4f46\u662f\u5e76\u4e0d\u63a8\u8350\u4f7f\u7528\uff0c\u800c\u662f\u5efa\u8bae\u4f7f\u7528 RUN \u6307\u4ee4\u53bb\u6267\u884c wget \u6216 curl \u547d\u4ee4\u3002</p> <p>\u6bd4\u5982\u524d\u9762\u6211\u4eec\u5b9a\u5236\u7684 nginx \u955c\u50cf\uff0c\u53ef\u4ee5\u6539\u6210\u4e0b\u9762\u7684\u5f62\u5f0f\uff1a</p> <pre><code>$ echo 'Hello Docker!' &gt; index.html\n</code></pre> <p>\u7136\u540e\u4fee\u6539 Dockerfile\uff1a</p> <pre><code>FROM nginx\n# COPY\u6216\u8005ADD\u6307\u4ee4\u90fd\u53ef\u4ee5\nCOPY index.html /user/share/nginx/html/index.html\n</code></pre>"},{"location":"docker/dockerfile_usage/#_57","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p><code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code>\u6307\u4ee4\u7684\u7528\u6cd5\u975e\u5e38\u76f8\u4f3c\uff0c\u5177\u4f53\u6ce8\u610f\u4e8b\u9879\u5982\u4e0b\uff1a</p> <ul> <li>\u6e90\u8def\u5f84\u53ef\u4ee5\u6709\u591a\u4e2a</li> <li>\u6e90\u8def\u5f84\u662f\u76f8\u5bf9\u4e8e\u6267\u884c build \u7684\u76f8\u5bf9\u8def\u5f84</li> <li>\u6e90\u8def\u5f84\u5982\u679c\u662f\u672c\u5730\u8def\u5f84\uff0c\u5fc5\u987b\u662f\u6784\u5efa\u4e0a\u4e0b\u6587\u4e2d\u7684\u8def\u5f84</li> <li>\u6e90\u8def\u5f84\u5982\u679c\u662f\u4e00\u4e2a\u76ee\u5f55\uff0c\u5219\u8be5\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u5185\u5bb9\u90fd\u5c06\u88ab\u52a0\u5165\u5230\u5bb9\u5668\uff0c\u4f46\u662f\u8be5\u76ee\u5f55\u672c\u8eab\u4e0d\u4f1a</li> <li>\u76ee\u6807\u8def\u5f84\u5fc5\u987b\u662f\u7edd\u5bf9\u8def\u5f84\uff0c\u6216\u76f8\u5bf9\u4e8e WORKDIR \u7684\u76f8\u5bf9\u8def\u5f84</li> <li>\u76ee\u6807\u8def\u5f84\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u4f1a\u521b\u5efa\u76f8\u5e94\u7684\u5b8c\u6574\u8def\u5f84</li> <li>\u76ee\u6807\u8def\u5f84\u5982\u679c\u4e0d\u662f\u4e00\u4e2a\u6587\u4ef6\uff0c\u5219\u5fc5\u987b\u4f7f\u7528/\u7ed3\u675f</li> <li>\u8def\u5f84\u4e2d\u53ef\u4ee5\u4f7f\u7528\u901a\u914d\u7b26</li> </ul>"},{"location":"docker/dockerfile_usage/#_58","title":"\u6784\u5efa\u955c\u50cf","text":"<p>\u73b0\u5728\u8ba9\u6211\u4eec\u518d\u56de\u5230\u4e4b\u524d\u5b9a\u5236\u7684 nginx \u955c\u50cf\u7684 Dockerfile \u6765\u3002\u73b0\u5728\u6211\u4eec\u660e\u767d\u4e86\u8fd9\u4e2a Dockerfile \u7684\u5185\u5bb9\uff0c\u90a3\u4e48\u8ba9\u6211\u4eec\u6765\u6784\u5efa\u8fd9\u4e2a\u955c\u50cf\u5427\u3002\u5728 Dockerfile \u6587\u4ef6\u6240\u5728\u76ee\u5f55\u6267\u884c\uff1a</p> <pre><code>$ docker build -t nginx:v1 .\nSending build context to Docker daemon 048 kB\nStep 1 : FROM nginx\n ---&gt; e43d811ce2f4\nStep 2 : RUN echo 'Hello, Docker!' &gt; /usr/share/nginx/html/index.html\n ---&gt; Running in 9cdc27646c7b\n ---&gt; 44aa4490ce2c\nRemoving intermediate container 9cdc27646c7b\nSuccessfully built 44aa4490ce2c\n</code></pre> <p>\u4ece\u547d\u4ee4\u7684\u8f93\u51fa\u7ed3\u679c\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u6e05\u6670\u7684\u770b\u5230\u955c\u50cf\u7684\u6784\u5efa\u8fc7\u7a0b\u3002\u5728 Step 2 \u4e2d\uff0c\u5982\u540c\u6211\u4eec\u4e4b\u524d\u6240\u8bf4\u7684\u90a3\u6837\uff0cRUN \u6307\u4ee4\u542f\u52a8\u4e86\u4e00\u4e2a\u5bb9\u5668 9cdc27646c7b\uff0c\u6267\u884c\u4e86\u6240\u8981\u6c42\u7684\u547d\u4ee4\uff0c\u5e76\u6700\u540e\u63d0\u4ea4\u4e86\u8fd9\u4e00\u5c42 44aa4490ce2c\uff0c\u968f\u540e\u5220\u9664\u4e86\u6240\u7528\u5230\u7684\u8fd9\u4e2a\u5bb9\u5668 9cdc27646c7b\u3002\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u4e86 <code>docker build</code> \u547d\u4ee4\u8fdb\u884c\u955c\u50cf\u6784\u5efa\u3002\u5176\u683c\u5f0f\u4e3a\uff1a</p> <pre><code>$ docker build [\u9009\u9879] &lt;\u4e0a\u4e0b\u6587\u8def\u5f84/URL/-&gt;\n</code></pre> <p>\u5728\u8fd9\u91cc\u6211\u4eec\u901a\u8fc7 <code>-t</code> \u53c2\u6570\u6307\u5b9a\u4e86\u6700\u7ec8\u955c\u50cf\u7684\u540d\u79f0 <code>nginx:v1</code>\uff0c\u6784\u5efa\u6210\u529f\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a\u955c\u50cf\u6765\u8fd0\u884c\u5bb9\u5668\u4e86\u3002</p>"},{"location":"docker/dockerfile_usage/#_59","title":"\u6784\u5efa\u4e0a\u4e0b\u6587","text":"<p>\u5982\u679c\u6211\u4eec\u4ed4\u7ec6\u89c2\u5bdf\u7684\u8bdd\u4f1a\u770b\u5230 <code>docker build</code> \u547d\u4ee4\u6700\u540e\u6709\u4e00\u4e2a <code>.</code>\u3002<code>.</code> \u8868\u793a\u5f53\u524d\u76ee\u5f55\uff0c\u800c Dockerfile \u5c31\u5728\u5f53\u524d\u76ee\u5f55\uff0c\u56e0\u6b64\u4e0d\u5c11\u521d\u5b66\u8005\u4ee5\u4e3a\u8fd9\u4e2a\u8def\u5f84\u662f\u5728\u6307\u5b9a Dockerfile \u6240\u5728\u8def\u5f84\uff0c\u8fd9\u4e48\u7406\u89e3\u5176\u5b9e\u662f\u4e0d\u51c6\u786e\u7684\u3002\u5982\u679c\u5bf9\u5e94\u4e0a\u9762\u7684\u547d\u4ee4\u683c\u5f0f\uff0c\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0\uff0c\u8fd9\u662f\u5728\u6307\u5b9a\u4e0a\u4e0b\u6587\u8def\u5f84\u3002\u90a3\u4e48\u4ec0\u4e48\u662f\u4e0a\u4e0b\u6587\u5462\uff1f</p> <p>\u9996\u5148\u6211\u4eec\u8981\u7406\u89e3 <code>docker build</code> \u7684\u5de5\u4f5c\u539f\u7406\u3002Docker \u5728\u8fd0\u884c\u65f6\u5206\u4e3a Docker Daemon \u548c\u5ba2\u6237\u7aef\u5de5\u5177\u3002Docker \u7684\u5f15\u64ce\u63d0\u4f9b\u4e86\u4e00\u7ec4 REST API\uff0c\u88ab\u79f0\u4e3a Docker Remote API\uff0c\u800c\u5982 docker \u547d\u4ee4\u8fd9\u6837\u7684\u5ba2\u6237\u7aef\u5de5\u5177\uff0c\u5219\u662f\u901a\u8fc7\u8fd9\u7ec4 API \u4e0e Docker \u5f15\u64ce\u4ea4\u4e92\uff0c\u4ece\u800c\u5b8c\u6210\u5404\u79cd\u529f\u80fd\u3002\u56e0\u6b64\uff0c\u867d\u7136\u8868\u9762\u4e0a\u6211\u4eec\u597d\u50cf\u662f\u5728\u672c\u673a\u6267\u884c\u5404\u79cd docker \u529f\u80fd\uff0c\u4f46\u5b9e\u9645\u4e0a\uff0c\u4e00\u5207\u90fd\u662f\u4f7f\u7528\u7684\u8fdc\u7a0b\u8c03\u7528\u5f62\u5f0f\u5728\u670d\u52a1\u7aef\uff08Docker \u5f15\u64ce\uff09\u5b8c\u6210\u3002\u4e5f\u56e0\u4e3a\u8fd9\u79cd C/S \u8bbe\u8ba1\uff0c\u8ba9\u6211\u4eec\u64cd\u4f5c\u8fdc\u7a0b\u670d\u52a1\u5668\u7684 Docker \u5f15\u64ce\u53d8\u5f97\u8f7b\u800c\u6613\u4e3e\u3002</p> <p>\u5f53\u6211\u4eec\u8fdb\u884c\u955c\u50cf\u6784\u5efa\u7684\u65f6\u5019\uff0c\u5e76\u975e\u6240\u6709\u5b9a\u5236\u90fd\u4f1a\u901a\u8fc7 RUN \u6307\u4ee4\u5b8c\u6210\uff0c\u7ecf\u5e38\u4f1a\u9700\u8981\u5c06\u4e00\u4e9b\u672c\u5730\u6587\u4ef6\u590d\u5236\u8fdb\u955c\u50cf\uff0c\u6bd4\u5982\u901a\u8fc7 <code>COPY</code> \u6307\u4ee4\u3001<code>ADD</code> \u6307\u4ee4\u7b49\u3002\u800c <code>docker build</code> \u547d\u4ee4\u6784\u5efa\u955c\u50cf\uff0c\u5176\u5b9e\u5e76\u975e\u5728\u672c\u5730\u6784\u5efa\uff0c\u800c\u662f\u5728\u670d\u52a1\u7aef\uff0c\u4e5f\u5c31\u662f Docker \u5f15\u64ce\u4e2d\u6784\u5efa\u7684\u3002\u90a3\u4e48\u5728\u8fd9\u79cd<code>\u5ba2\u6237\u7aef/\u670d\u52a1\u7aef</code>\u7684\u67b6\u6784\u4e2d\uff0c\u5982\u4f55\u624d\u80fd\u8ba9\u670d\u52a1\u7aef\u83b7\u5f97\u672c\u5730\u6587\u4ef6\u5462\uff1f</p> <p>\u8fd9\u5c31\u5f15\u5165\u4e86<code>\u4e0a\u4e0b\u6587</code>\u7684\u6982\u5ff5\u3002\u5f53\u6784\u5efa\u7684\u65f6\u5019\uff0c\u7528\u6237\u4f1a\u6307\u5b9a\u6784\u5efa\u955c\u50cf\u4e0a\u4e0b\u6587\u7684\u8def\u5f84\uff0cdocker build \u547d\u4ee4\u5f97\u77e5\u8fd9\u4e2a\u8def\u5f84\u540e\uff0c\u4f1a\u5c06\u8def\u5f84\u4e0b\u7684\u6240\u6709\u5185\u5bb9\u6253\u5305\uff0c\u7136\u540e\u4e0a\u4f20\u7ed9 Docker \u5f15\u64ce\u3002\u8fd9\u6837 Docker \u5f15\u64ce\u6536\u5230\u8fd9\u4e2a\u4e0a\u4e0b\u6587\u5305\u540e\uff0c\u5c55\u5f00\u5c31\u4f1a\u83b7\u5f97\u6784\u5efa\u955c\u50cf\u6240\u9700\u7684\u4e00\u5207\u6587\u4ef6\u3002\u5982\u679c\u5728 Dockerfile \u4e2d\u8fd9\u4e48\u5199\uff1a</p> <pre><code>COPY ./package.json /app/\n</code></pre> <p>\u8fd9\u5e76\u4e0d\u662f\u8981\u590d\u5236\u6267\u884c docker build \u547d\u4ee4\u6240\u5728\u7684\u76ee\u5f55\u4e0b\u7684 package.json\uff0c\u4e5f\u4e0d\u662f\u590d\u5236 Dockerfile \u6240\u5728\u76ee\u5f55\u4e0b\u7684 package.json\uff0c\u800c\u662f\u590d\u5236 <code>\u4e0a\u4e0b\u6587\uff08context\uff09</code> \u76ee\u5f55\u4e0b\u7684 package.json\u3002</p> <p>\u56e0\u6b64\uff0c<code>COPY</code> \u8fd9\u7c7b\u6307\u4ee4\u4e2d\u7684\u6e90\u6587\u4ef6\u7684\u8def\u5f84\u90fd\u662f<code>\u76f8\u5bf9\u8def\u5f84</code>\u3002\u8fd9\u4e5f\u662f\u521d\u5b66\u8005\u7ecf\u5e38\u4f1a\u95ee\u7684\u4e3a\u4ec0\u4e48 </p> <pre><code>COPY ../package.json /app\n</code></pre> <p>\u6216\u8005 <code>COPY /opt/xxxx /app</code> \u65e0\u6cd5\u5de5\u4f5c\u7684\u539f\u56e0\uff0c\u56e0\u4e3a\u8fd9\u4e9b\u8def\u5f84\u5df2\u7ecf\u8d85\u51fa\u4e86\u4e0a\u4e0b\u6587\u7684\u8303\u56f4\uff0cDocker \u5f15\u64ce\u65e0\u6cd5\u83b7\u5f97\u8fd9\u4e9b\u4f4d\u7f6e\u7684\u6587\u4ef6\u3002\u5982\u679c\u771f\u7684\u9700\u8981\u90a3\u4e9b\u6587\u4ef6\uff0c\u5e94\u8be5\u5c06\u5b83\u4eec\u590d\u5236\u5230\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\u53bb\u3002</p> <p>\u73b0\u5728\u5c31\u53ef\u4ee5\u7406\u89e3\u521a\u624d\u7684\u547d\u4ee4</p> <pre><code>docker build -t nginx:v1 .\n</code></pre> <p>\u4e2d\u7684\u8fd9\u4e2a<code>.</code>\uff0c\u5b9e\u9645\u4e0a\u662f\u5728\u6307\u5b9a\u4e0a\u4e0b\u6587\u7684\u76ee\u5f55\uff0cdocker build \u547d\u4ee4\u4f1a\u5c06\u8be5\u76ee\u5f55\u4e0b\u7684\u5185\u5bb9\u6253\u5305\u4ea4\u7ed9 Docker \u5f15\u64ce\u4ee5\u5e2e\u52a9\u6784\u5efa\u955c\u50cf\u3002</p> <p>\u5982\u679c\u89c2\u5bdf docker build \u8f93\u51fa\uff0c\u6211\u4eec\u5176\u5b9e\u5df2\u7ecf\u770b\u5230\u4e86\u8fd9\u4e2a\u53d1\u9001\u4e0a\u4e0b\u6587\u7684\u8fc7\u7a0b\uff1a</p> <pre><code>$ docker build -t nginx:v1 .\nSending build context to Docker daemon 048 kB\n...\n</code></pre> <p>\u7406\u89e3\u6784\u5efa\u4e0a\u4e0b\u6587\u5bf9\u4e8e\u955c\u50cf\u6784\u5efa\u662f\u5f88\u91cd\u8981\u7684\uff0c\u53ef\u4ee5\u907f\u514d\u72af\u4e00\u4e9b\u4e0d\u5e94\u8be5\u7684\u9519\u8bef\u3002\u6bd4\u5982\u6709\u4e9b\u521d\u5b66\u8005\u5728\u53d1\u73b0 COPY /opt/xxxx /app \u4e0d\u5de5\u4f5c\u540e\uff0c\u4e8e\u662f\u5e72\u8106\u5c06 Dockerfile \u653e\u5230\u4e86\u786c\u76d8\u6839\u76ee\u5f55\u53bb\u6784\u5efa\uff0c\u7ed3\u679c\u53d1\u73b0 docker build \u6267\u884c\u65f6\u53d1\u9001\u4e00\u4e2a\u51e0\u5341 GB \u7684\u4e1c\u897f\uff0c\u6781\u4e3a\u7f13\u6162\u800c\u4e14\u5f88\u5bb9\u6613\u6784\u5efa\u5931\u8d25\u3002\u90a3\u662f\u56e0\u4e3a\u8fd9\u79cd\u505a\u6cd5\u662f\u5728\u8ba9 docker build \u6253\u5305\u6574\u4e2a\u786c\u76d8\uff0c\u8fd9\u663e\u7136\u662f\u4f7f\u7528\u9519\u8bef\u3002</p> <p>\u4e00\u822c\u6765\u8bf4\uff0c\u5e94\u8be5\u4f1a\u5c06 Dockerfile \u7f6e\u4e8e\u4e00\u4e2a\u7a7a\u76ee\u5f55\u4e0b\uff0c\u6216\u8005\u9879\u76ee\u6839\u76ee\u5f55\u4e0b\u3002\u5982\u679c\u8be5\u76ee\u5f55\u4e0b\u6ca1\u6709\u6240\u9700\u6587\u4ef6\uff0c\u90a3\u4e48\u5e94\u8be5\u628a\u6240\u9700\u6587\u4ef6\u590d\u5236\u4e00\u4efd\u8fc7\u6765\u3002\u5982\u679c\u76ee\u5f55\u4e0b\u6709\u4e9b\u4e1c\u897f\u786e\u5b9e\u4e0d\u5e0c\u671b\u6784\u5efa\u65f6\u4f20\u7ed9 Docker \u5f15\u64ce\uff0c\u90a3\u4e48\u53ef\u4ee5\u7528 .gitignore \u4e00\u6837\u7684\u8bed\u6cd5\u5199\u4e00\u4e2a <code>.dockerignore</code>\uff0c\u8be5\u6587\u4ef6\u662f\u7528\u4e8e\u5254\u9664\u4e0d\u9700\u8981\u4f5c\u4e3a\u4e0a\u4e0b\u6587\u4f20\u9012\u7ed9 Docker \u5f15\u64ce\u7684\u3002</p> <p>\u90a3\u4e48\u4e3a\u4ec0\u4e48\u4f1a\u6709\u4eba\u8bef\u4ee5\u4e3a <code>.</code> \u662f\u6307\u5b9a Dockerfile \u6240\u5728\u76ee\u5f55\u5462\uff1f\u8fd9\u662f\u56e0\u4e3a\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u4e0d\u989d\u5916\u6307\u5b9a Dockerfile \u7684\u8bdd\uff0c\u4f1a\u5c06\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e0b\u7684\u540d\u4e3a Dockerfile \u7684\u6587\u4ef6\u4f5c\u4e3a Dockerfile\u3002\u8fd9\u53ea\u662f\u9ed8\u8ba4\u884c\u4e3a\uff0c\u5b9e\u9645\u4e0a Dockerfile \u7684\u6587\u4ef6\u540d\u5e76\u4e0d\u8981\u6c42\u5fc5\u987b\u4e3a Dockerfile\uff0c\u800c\u4e14\u5e76\u4e0d\u8981\u6c42\u5fc5\u987b\u4f4d\u4e8e\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\uff0c\u6bd4\u5982\u53ef\u4ee5\u7528<code>-f ../Dockerfile.Dev</code>\u53c2\u6570\u6307\u5b9a\u67d0\u4e2a\u6587\u4ef6\u4f5c\u4e3a Dockerfile\u3002</p> <p>\u5f53\u7136\uff0c\u4e00\u822c\u5927\u5bb6\u4e60\u60ef\u6027\u7684\u4f1a\u4f7f\u7528\u9ed8\u8ba4\u7684\u6587\u4ef6\u540d Dockerfile\uff0c\u4ee5\u53ca\u4f1a\u5c06\u5176\u7f6e\u4e8e\u955c\u50cf\u6784\u5efa\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\u3002</p>"},{"location":"docker/dockerfile_usage/#_60","title":"\u63a8\u9001\u955c\u50cf","text":"<p>\u4e0a\u9762\u6211\u4eec\u8bb2\u5230\u4e86 Dockerfile \u7684\u57fa\u672c\u5199\u6cd5\u4ee5\u53ca\u6784\u5efa\u955c\u50cf\u7684\u65f6\u5019\u4e00\u4e9b\u6ce8\u610f\u4e8b\u9879\uff0c\u90a3\u4e48\u955c\u50cf\u6784\u5efa\u5b8c\u6210\u540e\uff0c\u5982\u4f55\u628a\u6211\u4eec\u7684\u955c\u50cf\u7ed9\u5230\u522b\u4eba\u4f7f\u7528\u5462\uff1f\u7b2c\u4e00\u79cd\u65b9\u6cd5\u5c31\u662f\u5229\u7528 Docker \u5b98\u65b9\u63d0\u4f9b\u7684\u516c\u5171\u7684 Docker Hub \u4ed3\u5e93\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u955c\u50cf\u63a8\u9001\u4e0a\u53bb\uff0c\u7136\u540e\u522b\u4eba\u5c31\u53ef\u4ee5\u76f4\u63a5\u62c9\u53d6\u955c\u50cf\u3002</p>"},{"location":"docker/dockerfile_usage/#_61","title":"\u6ce8\u518c","text":"<p>\u9996\u5148\u9700\u8981 https://cloud.docker.com \u514d\u8d39\u6ce8\u518c\u4e00\u4e2a Docker \u8d26\u53f7\u3002</p>"},{"location":"docker/dockerfile_usage/#_62","title":"\u767b\u5f55","text":"<p>\u7136\u540e\u901a\u8fc7\u6267\u884c<code>docker login</code>\u547d\u4ee4\u4ea4\u4e92\u5f0f\u7684\u8f93\u5165\u7528\u6237\u540d\u53ca\u5bc6\u7801\u6765\u5b8c\u6210\u5728\u547d\u4ee4\u884c\u754c\u9762\u767b\u5f55 Docker Hub\u3002</p> <pre><code>$ docker login\nLogin with your Docker ID to push and pull images from Docker Hub. If you don't have a Docker ID, head over to https://hub.docker.com to create one.\nUsername: cnych\nPassword:\nWARNING! Your password will be stored unencrypted in /root/.docker/config.json.\nConfigure a credential helper to remove this warning. See\nhttps://docs.docker.com/engine/reference/commandline/login/#credentials-store\n\nLogin Succeeded\n</code></pre>"},{"location":"docker/dockerfile_usage/#_63","title":"\u6ce8\u9500","text":"<p>\u4f60\u53ef\u4ee5\u901a\u8fc7<code>docker logout</code>\u9000\u51fa\u767b\u5f55\u3002</p>"},{"location":"docker/dockerfile_usage/#_64","title":"\u63a8\u9001\u955c\u50cf","text":"<p>\u7528\u6237\u5728\u767b\u5f55\u540e\u53ef\u4ee5\u901a\u8fc7<code>docker push</code>\u547d\u4ee4\u6765\u5c06\u81ea\u5df1\u7684\u955c\u50cf\u63a8\u9001\u5230 Docker Hub\u3002\u4ee5\u4e0b\u547d\u4ee4\u4e2d\u7684 username \u8bf7\u66ff\u6362\u4e3a\u4f60\u7684 Docker \u8d26\u53f7\u7528\u6237\u540d\u3002</p> <pre><code>$ docker tag ubuntu:10 username/ubuntu:10\n$ docker image ls\n\nREPOSITORY                                               TAG                    IMAGE ID            CREATED             SIZE\nubuntu                                                   10                  275d79972a86        6 days ago          6MB\nusername/ubuntu                                          10                  275d79972a86        6 days ago          6MB\n$ docker push username/ubuntu:10\n</code></pre>"},{"location":"docker/dockerfile_usage/#_65","title":"\u79c1\u6709\u4ed3\u5e93","text":"<p>\u6709\u65f6\u5019\u6211\u4eec\u53ef\u80fd\u5e0c\u671b\u6211\u4eec\u7684\u955c\u50cf\u53ea\u5728\u5c40\u57df\u7f51\u8303\u56f4\u5185\u4f7f\u7528\uff0c\u4e0d\u5e0c\u671b\u63a8\u9001\u5230 Docker Hub \u8fd9\u6837\u7684\u516c\u5171\u4ed3\u5e93\uff0c\u90a3\u4e48\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u672c\u5730\u4ed3\u5e93\u4f9b\u79c1\u4eba\u4f7f\u7528\u3002</p> <p><code>docker-registry</code> \u5c31\u662f\u662f\u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e2a\u79c1\u6709\u4ed3\u5e93\u5de5\u5177\uff0c\u53ef\u4ee5\u7528\u4e8e\u5b58\u50a8\u79c1\u6709\u7684\u955c\u50cf\u4ed3\u5e93\u3002\u540c\u6837\u7684\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u83b7\u53d6\u5b98\u65b9 registry \u955c\u50cf\u6765\u76f4\u63a5\u8fd0\u884c\uff1a</p> <pre><code>$ docker run -d -p 5000:5000 --name registry registry:2\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u4f7f\u7528\u5b98\u65b9\u7684 registry \u955c\u50cf\u6765\u542f\u52a8\u79c1\u6709\u4ed3\u5e93\u5bb9\u5668\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4ed3\u5e93\u4f1a\u88ab\u521b\u5efa\u5728\u5bb9\u5668\u7684<code>/var/lib/registry</code>\u76ee\u5f55\u4e0b\u3002\u4f60\u53ef\u4ee5\u901a\u8fc7 <code>-v</code> \u53c2\u6570\u6765\u5c06\u955c\u50cf\u6587\u4ef6\u5b58\u653e\u5728\u672c\u5730\u7684\u6307\u5b9a\u8def\u5f84\u3002\u4f8b\u5982\u4e0b\u9762\u7684\u4f8b\u5b50\u5c06\u4e0a\u4f20\u7684\u955c\u50cf\u653e\u5230\u672c\u5730\u7684 <code>/opt/data/registry</code> \u76ee\u5f55:</p> <pre><code>$ docker run -d \\\\\n    -p 5000:5000 \\\\\n    -v /opt/data/registry:/var/lib/registry \\\\\n    registry:2\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u8fd0\u884c\u4e86\u4e00\u4e2a\u6570\u636e\u6301\u4e45\u5316\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u3002</p> <p>\u521b\u5efa\u597d\u79c1\u6709\u4ed3\u5e93\u4e4b\u540e\uff0c\u7136\u540e\u53ef\u4ee5\u4f7f\u7528<code>docker tag</code>\u6765\u6807\u8bb0\u4e00\u4e2a\u955c\u50cf\uff0c\u7136\u540e\u63a8\u9001\u5b83\u5230\u4ed3\u5e93\u3002\u6bd4\u5982\u79c1\u6709\u4ed3\u5e93\u5730\u5740\u4e3a<code>127.0.0.1:5000</code>\u3002\u5148\u5728\u672c\u673a\u67e5\u770b\u5df2\u6709\u7684\u955c\u50cf\u3002</p> <pre><code>$ docker images\nREPOSITORY                        TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nubuntu                            latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u4f7f\u7528<code>docker tag</code>\u5c06 ubuntu:latest \u8fd9\u4e2a\u955c\u50cf\u6807\u8bb0\u4e3a </p> <pre><code>11:5000/ubuntu:latest\n</code></pre> <p>:</p> <pre><code>$ docker tag ubuntu:latest 11:5000/ubuntu:latest\n$ docker images\nREPOSITORY                        TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nubuntu                            latest              ba5877dc9bec        6 weeks ago         17 MB\n11:5000/ubuntu:latest      latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u7136\u540e\u5c31\u53ef\u4ee5\u4f7f\u7528<code>docker push</code>\u4e0a\u4f20\u6807\u8bb0\u7684\u955c\u50cf:</p> <pre><code>$ docker push 11:5000/ubuntu:latest\nThe push refers to repository [11:5000/ubuntu]\n373a30c24545: Pushed\na9148f5200b0: Pushed\ncdd3de0940ab: Pushedfc56279bbb33: Pushed\nb38367233d37: Pushed\n2aebd096e0e2: Pushed\nlatest: digest: sha256:fe4277621f10b5026266932ddf760f5a756d2facd505a94d2da12f4f52f71f5a size: 1568\n</code></pre> <p>\u6b64\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528 registry \u4ed3\u5e93\u63d0\u4f9b\u7684 API \u6765\u67e5\u770b\u4ed3\u5e93\u4e2d\u7684\u955c\u50cf\uff1a</p> <pre><code>$ curl 11:5000/v2/_catalog\n{\"repositories\":[\"ubuntu\"]}\n</code></pre> <p>\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230 {\"repositories\":[\"ubuntu\"]}\uff0c\u8868\u660e\u955c\u50cf\u5df2\u7ecf\u88ab\u6210\u529f\u4e0a\u4f20\u4e86\u3002</p> <p>\u5148\u5220\u9664\u5df2\u6709\u955c\u50cf\uff0c\u518d\u5c1d\u8bd5\u4ece\u79c1\u6709\u4ed3\u5e93\u4e2d\u4e0b\u8f7d\u8fd9\u4e2a\u955c\u50cf\u3002</p> <pre><code>$ docker image rm 11:5000/ubuntu:latest\n$ docker pull 11:5000/ubuntu:latest\nPulling repository 11:5000/ubuntu:latest\nba5877dc9bec: Download complete\n511136ea3c5a: Download complete\n9bad880da3d2: Download complete\n25f11f5fb0cb: Download complete\nebc34468f71d: Download complete\n2318d26665ef: Download complete\n$ docker image ls\nREPOSITORY                         TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\n11:5000/ubuntu:latest       latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u628a\u955c\u50cf\u4e0a\u4f20\u5230\u4e86\u79c1\u6709\u4ed3\u5e93\u4e2d\u7684\u5b8c\u6574\u8fc7\u7a0b\u3002</p>"},{"location":"docker/dockerfile_usage/#_66","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p>\u5982\u679c\u4f60\u4e0d\u60f3\u4f7f\u7528 <code>127.0.0.1:5000</code> \u4f5c\u4e3a\u4ed3\u5e93\u5730\u5740\uff0c\u6bd4\u5982\u60f3\u8ba9\u672c\u7f51\u6bb5\u7684\u5176\u4ed6\u4e3b\u673a\u4e5f\u80fd\u628a\u955c\u50cf\u63a8\u9001\u5230\u79c1\u6709\u4ed3\u5e93\u3002\u4f60\u5c31\u5f97\u628a\u4f8b\u5982 <code>192.168.199.100:5000</code> \u8fd9\u6837\u7684\u5185\u7f51\u5730\u5740\u4f5c\u4e3a\u79c1\u6709\u4ed3\u5e93\u5730\u5740\uff0c\u8fd9\u65f6\u4f60\u4f1a\u53d1\u73b0\u65e0\u6cd5\u6210\u529f\u63a8\u9001\u955c\u50cf\u3002</p> <p>\u8fd9\u662f\u56e0\u4e3a Docker \u9ed8\u8ba4\u4e0d\u5141\u8bb8\u975e HTTPS \u65b9\u5f0f\u63a8\u9001\u955c\u50cf\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Docker \u7684\u914d\u7f6e\u9009\u9879\u6765\u53d6\u6d88\u8fd9\u4e2a\u9650\u5236\uff0c\u6211\u4eec\u8fd9\u91cc\u662f CentOS 7 \u7cfb\u7edf\uff0c\u540c\u6837\u8fd8\u662f\u7f16\u8f91\u6587\u4ef6</p> <pre><code>/etc/docker/daemon.json\n</code></pre> <p>\uff0c\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>{\n  \"registry-mirror\": [\n    \"https://registry.docker-cn.com\"\n  ],\n  \"insecure-registries\": [\n    \"111100:5000\"\n  ]\n}\n</code></pre> <p>\u5176\u4e2d\u7684<code>insecure-registries</code>\u5c31\u662f\u6211\u4eec\u6dfb\u52a0\u7684\u5185\u5bb9\uff0c\u7136\u540e\u91cd\u542f Docker \u4e4b\u540e\u5c31\u53ef\u4ee5\u5728\u5c40\u57df\u7f51\u5185\u4f7f\u7528\u6211\u4eec\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u4e86\u3002</p> <p>\u9ed8\u8ba4\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u53ef\u4ee5\u6ee1\u8db3\u6211\u4eec\u7684\u5f88\u591a\u9700\u6c42\uff0c\u4f46\u662f\u5f80\u5f80\u5728\u4f01\u4e1a\u4e2d\u4f7f\u7528\u7684\u8bdd\u8fd8\u6709\u5f88\u5b89\u5168\u6027\u65b9\u9762\u7684\u529f\u80fd\u7684\u7f3a\u5931\uff0c\u6bd4\u5982\u6743\u9650\u7ba1\u7406\u4e4b\u7c7b\u7684\uff0c\u8fd9\u5bf9\u4e8e\u4f01\u4e1a\u6765\u8bf4\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u4e0d\u8fc7 registry \u5bf9\u4e8e\u6743\u9650\u7ba1\u7406\u8fd9\u4e00\u5757\u505a\u4e86\u4e00\u4e2a\u5bf9\u5916\u66b4\u9732\u7684\u63a5\u53e3\uff0c\u53ea\u8981\u6211\u4eec\u5b9e\u73b0\u4ed6\u66b4\u9732\u7684\u5b89\u5168\u63a5\u53e3\u5c31\u53ef\u4ee5\u6765\u5b9e\u73b0\u6743\u9650\u7ba1\u7406\u76f8\u5173\u7684\u63a5\u53e3\uff0c\u5176\u4e2d\u6ce8\u660e\u7684\u5f00\u6e90\u955c\u50cf\u7ba1\u7406\u8f6f\u4ef6 Harbor \u5c31\u662f\u8fd9\u7c7b\u5e94\u7528\u7684\u4f7c\u4f7c\u8005\uff0c\u6211\u4eec\u8fd8\u5728\u540e\u9762\u7684\u8bfe\u7a0b\u4e2d\u548c\u5927\u5bb6\u5b66\u4e60 Harbor \u7684\u4e00\u4e2a\u4f7f\u7528\u3002\ue3c9</p>"},{"location":"docker/dockerfile_usage/#dockerfile_6","title":"Dockerfile","text":"<p>\u4f7f\u7528 Dockerfile \u5b9a\u5236\u955c\u50cf</p> <p></p> <p>\u955c\u50cf\u7684\u5b9a\u5236\u5b9e\u9645\u4e0a\u5c31\u662f\u5b9a\u5236\u955c\u50cf\u7684\u6bcf\u4e00\u5c42\u6240\u6dfb\u52a0\u7684\u914d\u7f6e\u3001\u6587\u4ef6\u7b49\u4fe1\u606f\uff0c\u5b9e\u9645\u4e0a\u5f53\u6211\u4eec\u5728\u4e00\u4e2a\u5bb9\u5668\u4e2d\u6dfb\u52a0\u6216\u8005\u4fee\u6539\u4e86\u4e00\u4e9b\u6587\u4ef6\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7<code>docker commit</code>\u547d\u4ee4\u6765\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u955c\u50cf\uff0c\u4f46\u662f\u8fd9\u4e2a\u65b9\u6cd5\u4e0d\u591f\u76f4\u89c2\uff0c\u6ca1\u529e\u6cd5\u8ffd\u6eaf\u6211\u4eec\u955c\u50cf\u91cc\u9762\u5230\u5e95\u6709\u54ea\u4e9b\u5185\u5bb9\uff0c\u6240\u4ee5\u5b9e\u9645\u5b9a\u5236\u955c\u50cf\u7684\u8fc7\u7a0b\u6211\u4eec\u5f88\u5c11\u91c7\u7528\u8fd9\u79cd\u65b9\u5f0f\u3002\u800c\u662f\u4f7f\u7528\u4e00\u4e2a\u540d\u4e3a <code>Dockerfile</code> \u7684\u6587\u672c\u6587\u4ef6\u6765\u8fdb\u884c\u955c\u50cf\u5b9a\u5236\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u955c\u50cf\u7684\u6bcf\u4e00\u5c42\u4fee\u6539\u3001\u5b89\u88c5\u3001\u6784\u5efa\u3001\u64cd\u4f5c\u7684\u547d\u4ee4\u90fd\u5199\u5165\u5230\u8fd9\u4e2a\u6587\u4ef6\u4e2d\uff0c\u4e00\u884c\u5c31\u5bf9\u5e94\u955c\u50cf\u7684\u4e00\u5c42\uff0c\u8fd9\u79cd\u65b9\u6cd5\u663e\u7136\u8981\u66f4\u9ad8\u7ea7\uff0c\u56e0\u4e3a\u6211\u4eec\u6709\u4e00\u4e2a\u6587\u4ef6\u6765\u76f4\u89c2\u53cd\u6620\u6211\u4eec\u7684\u955c\u50cf\u5185\u5bb9\uff0c\u8fd8\u53ef\u4ee5\u4f5c\u4e3a\u7248\u672c\u8bb0\u5f55\u8fdb\u884c\u8ddf\u8e2a\u3002</p>"},{"location":"docker/dockerfile_usage/#_67","title":"\u5b9a\u5236\u955c\u50cf","text":"<p>\u4ee5\u6211\u4eec\u4e4b\u524d\u7684 nginx \u955c\u50cf\u4e3a\u4f8b\uff0c\u6211\u4eec\u73b0\u5728\u6765\u5b9a\u5236\u4e00\u4e2a nginx \u955c\u50cf\uff0c\u8981\u6c42\u9ed8\u8ba4\u7684\u5e94\u7528\u9875\u9762\u8bbf\u95ee\u7684\u5185\u5bb9\u662f <code>Hello Docker</code>\u3002</p> <p>\u9996\u5148\u6211\u4eec\u65b0\u5efa\u4e00\u4e2a\u76ee\u5f55 testnginx\uff0c\u7136\u540e\u5728\u8be5\u76ee\u5f55\u4e0b\u9762\u65b0\u5efa\u4e00\u4e2a\u540d\u4e3a<code>Dockerfile</code>\u7684\u7a7a\u767d\u6587\u672c\u6587\u4ef6\uff1a</p> <pre><code>$ mkdir -p testnginx &amp;&amp; cd testnginx &amp;&amp; touch Dockerfile\n</code></pre> <p>\u7136\u540e\u5411<code>Dockerfile</code>\u6587\u4ef6\u4e2d\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>FROM nginx\nRUN echo 'Hello Docker!' &gt; /user/share/nginx/html/index.html\n</code></pre> <p>\u8fd9\u4e2a\u6587\u4ef6\u5f88\u7b80\u5355\uff0c\u4e00\u5171\u5c31\u4e24\u884c\uff0c\u5176\u4e2d\u5305\u542b\u4e24\u6761\u6307\u4ee4\uff0c<code>FROM</code> \u548c <code>RUN</code>\u3002</p>"},{"location":"docker/dockerfile_usage/#from_6","title":"FROM \u6307\u4ee4","text":"<p>\u5b9a\u5236\u955c\u50cf\uff0c\u90a3\u4e48\u80af\u5b9a\u662f\u4e00\u4e2a\u955c\u50cf\u4e3a\u57fa\u7840\uff0c\u5728\u5176\u57fa\u7840\u4e0a\u8fdb\u884c\u5b9a\u5236\uff0c\u800c <code>FROM</code> \u8fd9\u4e2a\u6307\u4ee4\u5c31\u662f\u6765\u6307\u5b9a\u57fa\u7840\u955c\u50cf\u7684\uff0c\u6240\u4ee5\u5728\u4e00\u4e2a <code>Dockerfile</code> \u6587\u4ef6\u4e2d <code>FROM</code> \u6307\u4ee4\u662f\u5fc5\u5907\u7684\uff0c\u5e76\u4e14\u5fc5\u987b\u662f\u7b2c\u4e00\u6761\u6307\u4ee4\u3002</p> <p>\u5728 Docker Hub \u4e0a\u6709\u975e\u5e38\u591a\u7684\u9ad8\u8d28\u91cf\u7684\u5b98\u65b9\u955c\u50cf\uff0c\u6709\u4e00\u4e9b\u53ef\u4ee5\u76f4\u63a5\u62ff\u6765\u4f7f\u7528\u7684\u670d\u52a1\u7c7b\u7684\u955c\u50cf\uff0c\u5982 nginx\u3001redis\u3001mongo\u3001mysql\u3001httpd\u3001php\u3001tomcat \u7b49\uff1b\u4e5f\u6709\u4e00\u4e9b\u65b9\u4fbf\u5f00\u53d1\u3001\u6784\u5efa\u3001\u8fd0\u884c\u5404\u79cd\u8bed\u8a00\u5e94\u7528\u7684\u955c\u50cf\uff0c\u5982 node\u3001openjdk\u3001python\u3001ruby\u3001golang \u7b49\u3002\u53ef\u4ee5\u5728\u5176\u4e2d\u5bfb\u627e\u4e00\u4e2a\u6700\u7b26\u5408\u6211\u4eec\u6700\u7ec8\u76ee\u6807\u7684\u955c\u50cf\u4e3a\u57fa\u7840\u955c\u50cf\u8fdb\u884c\u5b9a\u5236\u3002</p> <p>\u5982\u679c\u6ca1\u6709\u627e\u5230\u5408\u9002\u7684\u57fa\u7840\u955c\u50cf\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e9b\u66f4\u4e3a\u57fa\u7840\u7684\u64cd\u4f5c\u7cfb\u7edf\u955c\u50cf\uff0c\u6bd4\u5982 ubuntu\u3001debian\u3001centos\u3001alpine \u7b49\uff0c\u8fd9\u4e9b\u57fa\u7840\u955c\u50cf\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u66f4\u5927\u7684\u6269\u5c55\u7a7a\u95f4\uff0c\u5c31\u7c7b\u4f3c\u4e8e\u5e73\u65f6\u6211\u4eec\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e0a\u9762\u90e8\u7f72\u81ea\u5df1\u7684\u670d\u52a1\u4e00\u6837\u7684\u64cd\u4f5c\u3002</p> <p>\u9664\u4e86\u9009\u62e9\u73b0\u6709\u955c\u50cf\u4e3a\u57fa\u7840\u955c\u50cf\u5916\uff0cDocker \u8fd8\u5b58\u5728\u4e00\u4e2a\u7279\u6b8a\u7684\u955c\u50cf\uff0c\u540d\u4e3a <code>scratch</code>\uff0c\u8fd9\u4e2a\u955c\u50cf\u662f\u4e00\u4e2a\u865a\u62df\u7684\u955c\u50cf\uff0c\u5e76\u4e0d\u5b9e\u9645\u5b58\u5728\uff0c\u8868\u793a\u4e00\u4e2a\u7a7a\u767d\u7684\u955c\u50cf\uff1a</p> <p><code>FROM scratch ...</code></p> <p>\u5982\u679c\u4f60\u4ee5 <code>scratch</code> \u4e3a\u57fa\u7840\u955c\u50cf\u7684\u8bdd\uff0c\u610f\u5473\u7740\u4f60\u4e0d\u4ee5\u4efb\u4f55\u955c\u50cf\u4e3a\u57fa\u7840\uff0c\u63a5\u4e0b\u6765\u6240\u5199\u7684\u6307\u4ee4\u5c06\u4f5c\u4e3a\u955c\u50cf\u7b2c\u4e00\u5c42\u5f00\u59cb\u5b58\u5728\u3002\u6709\u7684\u540c\u5b66\u53ef\u80fd\u611f\u89c9\u5f88\u5947\u602a\uff0c\u6ca1\u6709\u4efb\u4f55\u57fa\u7840\u955c\u50cf\uff0c\u6211\u600e\u4e48\u53bb\u6267\u884c\u6211\u7684\u7a0b\u5e8f\u5462\uff0c\u5176\u5b9e\u5bf9\u4e8e Linux \u4e0b\u9759\u6001\u7f16\u8bd1\u7684\u7a0b\u5e8f\u6765\u8bf4\uff0c\u5e76\u4e0d\u9700\u8981\u6709\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u8fd0\u884c\u65f6\u652f\u6301\uff0c\u6240\u9700\u7684\u4e00\u5207\u5e93\u90fd\u5df2\u7ecf\u5728\u53ef\u6267\u884c\u6587\u4ef6\u91cc\u4e86\uff0c\u56e0\u6b64\u76f4\u63a5<code>FROM scratch</code>\u4f1a\u8ba9\u955c\u50cf\u4f53\u79ef\u66f4\u52a0\u5c0f\u5de7\u3002\u4f7f\u7528 Go \u8bed\u8a00 \u5f00\u53d1\u7684\u5e94\u7528\u5f88\u591a\u4f1a\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u6765\u5236\u4f5c\u955c\u50cf\uff0c\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u6709\u5f88\u591a\u89c2\u70b9\u8ba4\u4e3a Go \u662f\u7279\u522b\u9002\u5408\u5bb9\u5668\u5fae\u670d\u52a1\u67b6\u6784\u7684\u8bed\u8a00\u7684\u539f\u56e0\u4e4b\u4e00\u3002</p>"},{"location":"docker/dockerfile_usage/#run_6","title":"RUN \u6307\u4ee4","text":"<p><code>RUN</code> \u6307\u4ee4\u662f\u7528\u6765\u6267\u884c\u547d\u4ee4\u884c\u547d\u4ee4\u7684\u3002\u7531\u4e8e\u547d\u4ee4\u884c\u7684\u5f3a\u5927\u80fd\u529b\uff0c\u6240\u4ee5 <code>RUN</code> \u6307\u4ee4\u662f\u5b9a\u5236\u955c\u50cf\u65f6\u662f\u6700\u5e38\u7528\u7684\u6307\u4ee4\u4e4b\u4e00\u3002\u5176\u683c\u5f0f\u6709\u4e24\u79cd\uff1a</p> <ul> <li> <p>shell \u683c\u5f0f\uff1a<code>RUN &lt;\u547d\u4ee4&gt;</code>\uff0c\u5c31\u50cf\u76f4\u63a5\u5728\u547d\u4ee4\u884c\u4e2d\u8f93\u5165\u7684\u547d\u4ee4\u4e00\u6837\u3002\u521a\u624d\u5199\u7684 Dockerfile \u4e2d\u7684 RUN \u6307\u4ee4\u5c31\u662f\u8fd9\u79cd\u683c\u5f0f\uff1a</p> <pre><code>RUN echo 'Hello, Docker!' &gt; /usr/share/nginx/html/index.html\n</code></pre> </li> <li> <p>exec \u683c\u5f0f\uff1a</p> <pre><code>RUN [\"\u53ef\u6267\u884c\u6587\u4ef6\", \"\u53c2\u65701\", \"\u53c2\u65702\"]\n</code></pre> <p>\uff0c\u8fd9\u66f4\u50cf\u662f\u51fd\u6570\u8c03\u7528\u4e2d\u7684\u683c\u5f0f\u3002\u65e2\u7136 RUN \u5c31\u50cf Shell \u811a\u672c\u4e00\u6837\u53ef\u4ee5\u6267\u884c\u547d\u4ee4\uff0c\u90a3\u4e48\u6211\u4eec\u662f\u5426\u5c31\u53ef\u4ee5\u50cf Shell \u811a\u672c\u4e00\u6837\u628a\u6bcf\u4e2a\u547d\u4ee4\u5bf9\u5e94\u4e00\u4e2a RUN \u5462\uff1f\u6bd4\u5982\u8fd9\u6837\uff1a</p> <pre><code>FROM debian:jessie\nRUN apt-get update\nRUN apt-get install -y gcc libc6-dev make wget\nRUN wget -O redis.tar.gz \"http://download.redis.io/releases/redis-tar.gz\"\nRUN mkdir -p /usr/src/redis\nRUN tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1\nRUN make -C /usr/src/redis\nRUN make -C /usr/src/redis install\n# \u5176\u4ed6\u6307\u4ee4...\n</code></pre> </li> </ul> <p>\u4e4b\u524d\u8bf4\u8fc7\uff0cDockerfile \u4e2d\u6bcf\u4e00\u4e2a\u6307\u4ee4\u90fd\u4f1a\u5efa\u7acb\u4e00\u5c42\uff0cRUN \u4e5f\u4e0d\u4f8b\u5916\u3002\u6bcf\u4e00\u4e2a RUN \u5c31\u4f1a\u65b0\u5efa\u7acb\u4e00\u5c42\uff0c\u5728\u5176\u4e0a\u6267\u884c\u8fd9\u4e9b\u547d\u4ee4\uff0c\u6267\u884c\u7ed3\u675f\u540e\uff0ccommit \u8fd9\u4e00\u5c42\u7684\u4fee\u6539\uff0c\u6784\u6210\u65b0\u7684\u955c\u50cf\u3002</p> <p>\u800c\u4e0a\u9762\u7684\u8fd9\u79cd\u5199\u6cd5\uff0c\u521b\u5efa\u4e86 7 \u5c42\u955c\u50cf\u3002\u8fd9\u662f\u5b8c\u5168\u6ca1\u6709\u5fc5\u8981\u7684\uff0c\u800c\u4e14\u5f88\u591a\u8fd0\u884c\u65f6\u4e0d\u9700\u8981\u7684\u4e1c\u897f\uff0c\u90fd\u88ab\u88c5\u8fdb\u4e86\u955c\u50cf\u91cc\uff0c\u6bd4\u5982\u7f16\u8bd1\u73af\u5883\u3001\u66f4\u65b0\u7684\u8f6f\u4ef6\u5305\u7b49\u7b49\u3002\u7ed3\u679c\u5c31\u662f\u4ea7\u751f\u975e\u5e38\u81c3\u80bf\u3001\u975e\u5e38\u591a\u5c42\u7684\u955c\u50cf\uff0c\u4e0d\u4ec5\u4ec5\u589e\u52a0\u4e86\u6784\u5efa\u90e8\u7f72\u7684\u65f6\u95f4\uff0c\u4e5f\u5f88\u5bb9\u6613\u51fa\u9519\u3002 \u8fd9\u662f\u5f88\u591a\u521d\u5b66 Docker \u7684\u4eba\u5e38\u72af\u7684\u4e00\u4e2a\u9519\u8bef\u3002</p> <p>UnionFS \u5c42\u9650\u5236</p> <p>UnionFS \u5b9e\u9645\u4e0a\u662f\u6709\u6700\u5927\u5c42\u6570\u9650\u5236\u7684\uff0c\u6bd4\u5982 AUFS\uff0c\u66fe\u7ecf\u662f\u6700\u5927\u4e0d\u5f97\u8d85\u8fc7 42 \u5c42\uff0c\u73b0\u5728\u662f\u4e0d\u5f97\u8d85\u8fc7 127 \u5c42\u3002</p> <p>\u4e0a\u9762\u7684 Dockerfile \u6b63\u786e\u7684\u5199\u6cd5\u5e94\u8be5\u662f\u8fd9\u6837\uff1a</p> <pre><code>FROM debian:jessie\nRUN buildDeps='gcc libc6-dev make wget' \\\\\n    &amp;&amp; apt-get update \\\\\n    &amp;&amp; apt-get install -y $buildDeps \\\\\n    &amp;&amp; wget -O redis.tar.gz \"http://download.redis.io/releases/redis-tar.gz\" \\\\\n    &amp;&amp; mkdir -p /usr/src/redis \\\\\n    &amp;&amp; tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1 \\\\\n    &amp;&amp; make -C /usr/src/redis \\\\\n    &amp;&amp; make -C /usr/src/redis install \\\\\n    &amp;&amp; rm -rf /var/lib/apt/lists/* \\\\\n    &amp;&amp; rm redis.tar.gz \\\\\n    &amp;&amp; rm -r /usr/src/redis \\\\\n    &amp;&amp; apt-get purge -y --auto-remove $buildDeps\n# \u5176\u4ed6\u6307\u4ee4...\n</code></pre> <p>\u9996\u5148\uff0c\u4e4b\u524d\u6240\u6709\u7684\u547d\u4ee4\u53ea\u6709\u4e00\u4e2a\u76ee\u7684\uff0c\u5c31\u662f\u7f16\u8bd1\u3001\u5b89\u88c5 redis \u53ef\u6267\u884c\u6587\u4ef6\u3002\u56e0\u6b64\u6ca1\u6709\u5fc5\u8981\u5efa\u7acb\u5f88\u591a\u5c42\uff0c\u8fd9\u53ea\u662f\u4e00\u5c42\u7684\u4e8b\u60c5\u3002\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u6ca1\u6709\u4f7f\u7528\u5f88\u591a\u4e2a RUN \u6307\u4ee4\u6765\u5bf9\u5e94\u4e0d\u540c\u7684\u547d\u4ee4\uff0c\u800c\u662f\u4ec5\u4ec5\u4f7f\u7528\u4e00\u4e2a RUN \u6307\u4ee4\uff0c\u5e76\u4f7f\u7528<code>&amp;&amp;</code>\u5c06\u5404\u4e2a\u6240\u9700\u547d\u4ee4\u4e32\u8054\u8d77\u6765\u3002\u5c06\u4e4b\u524d\u7684 7 \u5c42\uff0c\u7b80\u5316\u4e3a\u4e86 1 \u5c42\u3002\u5728\u64b0\u5199 Dockerfile \u7684\u65f6\u5019\uff0c\u8981\u7ecf\u5e38\u63d0\u9192\u81ea\u5df1\uff0c\u8fd9\u5e76\u4e0d\u662f\u5728\u5199 Shell \u811a\u672c\uff0c\u800c\u662f\u5728\u5b9a\u4e49\u6bcf\u4e00\u5c42\u8be5\u5982\u4f55\u6784\u5efa\u3002</p> <p>\u5e76\u4e14\uff0c\u8fd9\u91cc\u4e3a\u4e86\u683c\u5f0f\u5316\u8fd8\u8fdb\u884c\u4e86\u6362\u884c\u3002Dockerfile \u652f\u6301 Shell \u7c7b\u7684\u884c\u5c3e\u6dfb\u52a0<code>\\</code>\u7684\u547d\u4ee4\u6362\u884c\u65b9\u5f0f\uff0c\u4ee5\u53ca\u884c\u9996<code>#</code>\u8fdb\u884c\u6ce8\u91ca\u7684\u683c\u5f0f\u3002\u826f\u597d\u7684\u683c\u5f0f\uff0c\u6bd4\u5982<code>\u6362\u884c\u3001\u7f29\u8fdb\u3001\u6ce8\u91ca</code>\u7b49\uff0c\u4f1a\u8ba9\u7ef4\u62a4\u3001\u6392\u969c\u66f4\u4e3a\u5bb9\u6613\uff0c\u8fd9\u662f\u4e00\u4e2a\u6bd4\u8f83\u597d\u7684\u4e60\u60ef\u3002</p> <p>\u6b64\u5916\uff0c\u8fd8\u53ef\u4ee5\u770b\u5230\u8fd9\u4e00\u7ec4\u547d\u4ee4\u7684\u6700\u540e\u6dfb\u52a0\u4e86\u6e05\u7406\u5de5\u4f5c\u7684\u547d\u4ee4\uff0c\u5220\u9664\u4e86\u4e3a\u4e86\u7f16\u8bd1\u6784\u5efa\u4e0b\u8f7d\u7684\u8f6f\u4ef6\uff0c\u6e05\u7406\u4e86\u6240\u6709\u4e0b\u8f7d\u3001\u5c55\u5f00\u7684\u6587\u4ef6\uff0c\u5e76\u4e14\u8fd8\u6e05\u7406\u4e86 apt \u7f13\u5b58\u6587\u4ef6\u3002\u8fd9\u662f\u5f88\u91cd\u8981\u7684\u4e00\u6b65\uff0c\u6211\u4eec\u4e4b\u524d\u8bf4\u8fc7\uff0c\u955c\u50cf\u662f\u591a\u5c42\u5b58\u50a8\uff0c\u6bcf\u4e00\u5c42\u7684\u4e1c\u897f\u5e76\u4e0d\u4f1a\u5728\u4e0b\u4e00\u5c42\u88ab\u5220\u9664\uff0c\u4f1a\u4e00\u76f4\u8ddf\u968f\u7740\u955c\u50cf\u3002\u56e0\u6b64\u955c\u50cf\u6784\u5efa\u65f6\uff0c\u4e00\u5b9a\u8981\u786e\u4fdd\u6bcf\u4e00\u5c42\u53ea\u6dfb\u52a0\u771f\u6b63\u9700\u8981\u6dfb\u52a0\u7684\u4e1c\u897f\uff0c\u4efb\u4f55\u65e0\u5173\u7684\u4e1c\u897f\u90fd\u5e94\u8be5\u6e05\u7406\u6389\u3002 \u5f88\u591a\u4eba\u521d\u5b66 Docker \u5236\u4f5c\u51fa\u4e86\u5f88\u81c3\u80bf\u7684\u955c\u50cf\u7684\u539f\u56e0\u4e4b\u4e00\uff0c\u5c31\u662f\u5fd8\u8bb0\u4e86\u6bcf\u4e00\u5c42\u6784\u5efa\u7684\u6700\u540e\u4e00\u5b9a\u8981\u6e05\u7406\u6389\u65e0\u5173\u6587\u4ef6\u3002</p>"},{"location":"docker/dockerfile_usage/#workdir_6","title":"WORKDIR \u6307\u4ee4","text":"<p><code>WORKDIR</code> \u6307\u4ee4\u8bbe\u7f6e Dockerfile \u4e2d\u7684\u4efb\u4f55 RUN\uff0cCMD\uff0cENTRPOINT\uff0cCOPY \u548c ADD \u6307\u4ee4\u7684\u5de5\u4f5c\u76ee\u5f55\u3002\u5982\u679c WORKDIR \u6307\u5b9a\u7684\u76ee\u5f55\u4e0d\u5b58\u5728\uff0c\u5373\u4f7f\u968f\u540e\u7684\u6307\u4ee4\u6ca1\u6709\u7528\u5230\u8fd9\u4e2a\u76ee\u5f55\uff0c\u90fd\u4f1a\u521b\u5efa\u8be5\u76ee\u5f55\u3002</p> <p>\u683c\u5f0f\uff1a </p> <pre><code>WORKDIR /path/to/workdir\n</code></pre> <p>\u4e3a\u4e86\u6e05\u6670\u6027\u548c\u53ef\u9760\u6027\uff0c\u4f60\u5e94\u8be5\u603b\u662f\u5728 WORKDIR \u4e2d\u4f7f\u7528\u7edd\u5bf9\u8def\u5f84\uff0c\u800c\u4e14\u5355\u4e2a Dockerfile \u53ef\u4ee5\u4f7f\u7528\u591a\u6b21WORKDIR\u3002\u53e6\u5916\uff0c\u6211\u4eec\u5e94\u8be5\u4f7f\u7528 WORKDIR \u6765\u66ff\u4ee3\u7c7b\u4f3c\u4e8e </p> <pre><code>RUN cd ... &amp;&amp; do-something\n</code></pre> <p>\u7684\u6307\u4ee4\uff0c\u540e\u8005\u96be\u4ee5\u9605\u8bfb\u3001\u6392\u9519\u548c\u7ef4\u62a4\u3002</p>"},{"location":"docker/dockerfile_usage/#add_copy_6","title":"ADD &amp; COPY \u6307\u4ee4","text":"<p>Dockerfile \u4e2d\u7684 <code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code> \u6307\u4ee4\u90fd\u53ef\u4ee5\u5c06\u4e3b\u673a\u4e0a\u7684\u8d44\u6e90\u590d\u5236\u6216\u52a0\u5165\u5230\u5bb9\u5668\u955c\u50cf\u4e2d\uff0c\u90fd\u662f\u5728\u6784\u5efa\u955c\u50cf\u7684\u8fc7\u7a0b\u4e2d\u5b8c\u6210\u7684\u3002</p> <p><code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code> \u6307\u4ee4\u7684\u552f\u4e00\u533a\u522b\u5728\u4e8e<code>\u662f\u5426\u652f\u6301\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90</code>\u3002<code>COPY</code> \u6307\u4ee4\u53ea\u80fd\u4ece\u6267\u884c<code>docker build</code>\u6240\u5728\u7684\u4e3b\u673a\u4e0a\u8bfb\u53d6\u8d44\u6e90\u5e76\u590d\u5236\u5230\u955c\u50cf\u4e2d\u3002\u800c <code>ADD</code> \u6307\u4ee4\u8fd8\u652f\u6301\u901a\u8fc7 URL \u4ece\u8fdc\u7a0b\u670d\u52a1\u5668\u8bfb\u53d6\u8d44\u6e90\u5e76\u590d\u5236\u5230\u955c\u50cf\u4e2d\u3002</p> <p>\u4e00\u822c\u6765\u8bf4\u6ee1\u8db3\u540c\u7b49\u529f\u80fd\u7684\u60c5\u51b5\u4e0b\uff0c\u63a8\u8350\u4f7f\u7528COPY\u6307\u4ee4\u3002<code>ADD</code> \u6307\u4ee4\u66f4\u64c5\u957f\u8bfb\u53d6\u672c\u5730 tar \u6587\u4ef6\u5e76\u89e3\u538b\u7f29\u3002</p>"},{"location":"docker/dockerfile_usage/#copy_6","title":"COPY \u6307\u4ee4","text":"<p><code>COPY</code> \u6307\u4ee4\u80fd\u591f\u5c06\u6784\u5efa\u547d\u4ee4\u6240\u5728\u7684\u4e3b\u673a\u672c\u5730\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u590d\u5236\u5230\u955c\u50cf\u6587\u4ef6\u7cfb\u7edf\u3002COPY \u6307\u4ee4\u540c\u6837\u4e5f\u652f\u6301 exec \u548c shell \u4e24\u79cd\u683c\u5f0f\uff1a</p> <ul> <li> <p>exec \u683c\u5f0f\u7528\u6cd5\uff1a</p> <pre><code>COPY [\"&lt;src&gt;\",... \"&lt;dest&gt;\"]\n</code></pre> <p>\uff0c\u7279\u522b\u9002\u5408\u8def\u5f84\u4e2d\u5e26\u6709\u7a7a\u683c\u7684\u60c5\u51b5\u3002</p> </li> <li> <p>shell \u683c\u5f0f\u7528\u6cd5\uff1a<code>COPY &lt;src&gt;... &lt;dest&gt;</code></p> </li> </ul>"},{"location":"docker/dockerfile_usage/#add_6","title":"ADD \u6307\u4ee4","text":"<p><code>ADD</code> \u6307\u4ee4\u4e0d\u4ec5\u80fd\u591f\u5c06\u6784\u5efa\u547d\u4ee4\u6240\u5728\u7684\u4e3b\u673a\u672c\u5730\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u800c\u4e14\u80fd\u591f\u5c06\u8fdc\u7a0b URL \u6240\u5bf9\u5e94\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u4f5c\u4e3a\u8d44\u6e90\u590d\u5236\u5230\u955c\u50cf\u6587\u4ef6\u7cfb\u7edf\u3002\u6240\u4ee5\uff0c\u53ef\u4ee5\u8ba4\u4e3a <code>ADD</code> \u662f\u589e\u5f3a\u7248\u7684 <code>COPY</code>\uff0c\u652f\u6301\u5c06\u8fdc\u7a0b URL \u7684\u8d44\u6e90\u52a0\u5165\u5230\u955c\u50cf\u7684\u6587\u4ef6\u7cfb\u7edf\u3002\u540c\u6837\u4e5f\u652f\u6301 exec \u548c shell \u4e24\u79cd\u683c\u5f0f\u7528\u6cd5\uff1a \u00a0 * exec \u683c\u5f0f\u7528\u6cd5\uff1a</p> <pre><code>ADD [\"&lt;src&gt;\",... \"&lt;dest&gt;\"]\n</code></pre> <p>\uff0c\u7279\u522b\u9002\u5408\u8def\u5f84\u4e2d\u5e26\u6709\u7a7a\u683c\u7684\u60c5\u51b5</p> <ul> <li>shell \u683c\u5f0f\u7528\u6cd5\uff1a<code>ADD &lt;src&gt;... &lt;dest&gt;</code></li> </ul> <p>\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90\uff0c\u6bd4\u5982\uff1a</p> <pre><code>ADD http://foo.com/bar.go /tmp/main.go\n</code></pre> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u5bf9\u4e8e\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90\u7684\u60c5\u51b5\uff0c\u7531\u4e8e ADD \u6307\u4ee4\u4e0d\u652f\u6301\u8ba4\u8bc1\uff0c\u5982\u679c\u4ece\u8fdc\u7a0b\u83b7\u53d6\u8d44\u6e90\u9700\u8981\u8ba4\u8bc1\uff0c\u5219\u53ea\u80fd\u4f7f\u7528<code>RUN wget</code> \u6216 <code>RUN curl</code> \u66ff\u4ee3\u4e86\u3002</p> <p>\u6709\u80fd\u529b\u81ea\u52a8\u89e3\u538b\u6587\u4ef6\uff0c\u6bd4\u5982\uff1a</p> <pre><code>ADD /foo.tar.gz /tmp/\n</code></pre> <p>\u4e0a\u8ff0\u6307\u4ee4\u4f1a\u4f7f foo.tar.gz \u538b\u7f29\u6587\u4ef6\u89e3\u538b\u5230\u5bb9\u5668\u7684 /tmp \u76ee\u5f55\u3002</p> <p>\u4e0d\u8fc7\u4e00\u822c\u6765\u8bf4\u867d\u7136 ADD \u6307\u4ee4\u652f\u6301\u4ece\u8fdc\u7a0b\u83b7\u53d6\u8d44\u6e90\uff0c\u4f46\u662f\u5e76\u4e0d\u63a8\u8350\u4f7f\u7528\uff0c\u800c\u662f\u5efa\u8bae\u4f7f\u7528 RUN \u6307\u4ee4\u53bb\u6267\u884c wget \u6216 curl \u547d\u4ee4\u3002</p> <p>\u6bd4\u5982\u524d\u9762\u6211\u4eec\u5b9a\u5236\u7684 nginx \u955c\u50cf\uff0c\u53ef\u4ee5\u6539\u6210\u4e0b\u9762\u7684\u5f62\u5f0f\uff1a</p> <pre><code>$ echo 'Hello Docker!' &gt; index.html\n</code></pre> <p>\u7136\u540e\u4fee\u6539 Dockerfile\uff1a</p> <pre><code>FROM nginx\n# COPY\u6216\u8005ADD\u6307\u4ee4\u90fd\u53ef\u4ee5\nCOPY index.html /user/share/nginx/html/index.html\n</code></pre>"},{"location":"docker/dockerfile_usage/#_68","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p><code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code>\u6307\u4ee4\u7684\u7528\u6cd5\u975e\u5e38\u76f8\u4f3c\uff0c\u5177\u4f53\u6ce8\u610f\u4e8b\u9879\u5982\u4e0b\uff1a</p> <ul> <li>\u6e90\u8def\u5f84\u53ef\u4ee5\u6709\u591a\u4e2a</li> <li>\u6e90\u8def\u5f84\u662f\u76f8\u5bf9\u4e8e\u6267\u884c build \u7684\u76f8\u5bf9\u8def\u5f84</li> <li>\u6e90\u8def\u5f84\u5982\u679c\u662f\u672c\u5730\u8def\u5f84\uff0c\u5fc5\u987b\u662f\u6784\u5efa\u4e0a\u4e0b\u6587\u4e2d\u7684\u8def\u5f84</li> <li>\u6e90\u8def\u5f84\u5982\u679c\u662f\u4e00\u4e2a\u76ee\u5f55\uff0c\u5219\u8be5\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u5185\u5bb9\u90fd\u5c06\u88ab\u52a0\u5165\u5230\u5bb9\u5668\uff0c\u4f46\u662f\u8be5\u76ee\u5f55\u672c\u8eab\u4e0d\u4f1a</li> <li>\u76ee\u6807\u8def\u5f84\u5fc5\u987b\u662f\u7edd\u5bf9\u8def\u5f84\uff0c\u6216\u76f8\u5bf9\u4e8e WORKDIR \u7684\u76f8\u5bf9\u8def\u5f84</li> <li>\u76ee\u6807\u8def\u5f84\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u4f1a\u521b\u5efa\u76f8\u5e94\u7684\u5b8c\u6574\u8def\u5f84</li> <li>\u76ee\u6807\u8def\u5f84\u5982\u679c\u4e0d\u662f\u4e00\u4e2a\u6587\u4ef6\uff0c\u5219\u5fc5\u987b\u4f7f\u7528/\u7ed3\u675f</li> <li>\u8def\u5f84\u4e2d\u53ef\u4ee5\u4f7f\u7528\u901a\u914d\u7b26</li> </ul>"},{"location":"docker/dockerfile_usage/#_69","title":"\u6784\u5efa\u955c\u50cf","text":"<p>\u73b0\u5728\u8ba9\u6211\u4eec\u518d\u56de\u5230\u4e4b\u524d\u5b9a\u5236\u7684 nginx \u955c\u50cf\u7684 Dockerfile \u6765\u3002\u73b0\u5728\u6211\u4eec\u660e\u767d\u4e86\u8fd9\u4e2a Dockerfile \u7684\u5185\u5bb9\uff0c\u90a3\u4e48\u8ba9\u6211\u4eec\u6765\u6784\u5efa\u8fd9\u4e2a\u955c\u50cf\u5427\u3002\u5728 Dockerfile \u6587\u4ef6\u6240\u5728\u76ee\u5f55\u6267\u884c\uff1a</p> <pre><code>$ docker build -t nginx:v1 .\nSending build context to Docker daemon 048 kB\nStep 1 : FROM nginx\n ---&gt; e43d811ce2f4\nStep 2 : RUN echo 'Hello, Docker!' &gt; /usr/share/nginx/html/index.html\n ---&gt; Running in 9cdc27646c7b\n ---&gt; 44aa4490ce2c\nRemoving intermediate container 9cdc27646c7b\nSuccessfully built 44aa4490ce2c\n</code></pre> <p>\u4ece\u547d\u4ee4\u7684\u8f93\u51fa\u7ed3\u679c\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u6e05\u6670\u7684\u770b\u5230\u955c\u50cf\u7684\u6784\u5efa\u8fc7\u7a0b\u3002\u5728 Step 2 \u4e2d\uff0c\u5982\u540c\u6211\u4eec\u4e4b\u524d\u6240\u8bf4\u7684\u90a3\u6837\uff0cRUN \u6307\u4ee4\u542f\u52a8\u4e86\u4e00\u4e2a\u5bb9\u5668 9cdc27646c7b\uff0c\u6267\u884c\u4e86\u6240\u8981\u6c42\u7684\u547d\u4ee4\uff0c\u5e76\u6700\u540e\u63d0\u4ea4\u4e86\u8fd9\u4e00\u5c42 44aa4490ce2c\uff0c\u968f\u540e\u5220\u9664\u4e86\u6240\u7528\u5230\u7684\u8fd9\u4e2a\u5bb9\u5668 9cdc27646c7b\u3002\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u4e86 <code>docker build</code> \u547d\u4ee4\u8fdb\u884c\u955c\u50cf\u6784\u5efa\u3002\u5176\u683c\u5f0f\u4e3a\uff1a</p> <pre><code>$ docker build [\u9009\u9879] &lt;\u4e0a\u4e0b\u6587\u8def\u5f84/URL/-&gt;\n</code></pre> <p>\u5728\u8fd9\u91cc\u6211\u4eec\u901a\u8fc7 <code>-t</code> \u53c2\u6570\u6307\u5b9a\u4e86\u6700\u7ec8\u955c\u50cf\u7684\u540d\u79f0 <code>nginx:v1</code>\uff0c\u6784\u5efa\u6210\u529f\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a\u955c\u50cf\u6765\u8fd0\u884c\u5bb9\u5668\u4e86\u3002</p>"},{"location":"docker/dockerfile_usage/#_70","title":"\u6784\u5efa\u4e0a\u4e0b\u6587","text":"<p>\u5982\u679c\u6211\u4eec\u4ed4\u7ec6\u89c2\u5bdf\u7684\u8bdd\u4f1a\u770b\u5230 <code>docker build</code> \u547d\u4ee4\u6700\u540e\u6709\u4e00\u4e2a <code>.</code>\u3002<code>.</code> \u8868\u793a\u5f53\u524d\u76ee\u5f55\uff0c\u800c Dockerfile \u5c31\u5728\u5f53\u524d\u76ee\u5f55\uff0c\u56e0\u6b64\u4e0d\u5c11\u521d\u5b66\u8005\u4ee5\u4e3a\u8fd9\u4e2a\u8def\u5f84\u662f\u5728\u6307\u5b9a Dockerfile \u6240\u5728\u8def\u5f84\uff0c\u8fd9\u4e48\u7406\u89e3\u5176\u5b9e\u662f\u4e0d\u51c6\u786e\u7684\u3002\u5982\u679c\u5bf9\u5e94\u4e0a\u9762\u7684\u547d\u4ee4\u683c\u5f0f\uff0c\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0\uff0c\u8fd9\u662f\u5728\u6307\u5b9a\u4e0a\u4e0b\u6587\u8def\u5f84\u3002\u90a3\u4e48\u4ec0\u4e48\u662f\u4e0a\u4e0b\u6587\u5462\uff1f</p> <p>\u9996\u5148\u6211\u4eec\u8981\u7406\u89e3 <code>docker build</code> \u7684\u5de5\u4f5c\u539f\u7406\u3002Docker \u5728\u8fd0\u884c\u65f6\u5206\u4e3a Docker Daemon \u548c\u5ba2\u6237\u7aef\u5de5\u5177\u3002Docker \u7684\u5f15\u64ce\u63d0\u4f9b\u4e86\u4e00\u7ec4 REST API\uff0c\u88ab\u79f0\u4e3a Docker Remote API\uff0c\u800c\u5982 docker \u547d\u4ee4\u8fd9\u6837\u7684\u5ba2\u6237\u7aef\u5de5\u5177\uff0c\u5219\u662f\u901a\u8fc7\u8fd9\u7ec4 API \u4e0e Docker \u5f15\u64ce\u4ea4\u4e92\uff0c\u4ece\u800c\u5b8c\u6210\u5404\u79cd\u529f\u80fd\u3002\u56e0\u6b64\uff0c\u867d\u7136\u8868\u9762\u4e0a\u6211\u4eec\u597d\u50cf\u662f\u5728\u672c\u673a\u6267\u884c\u5404\u79cd docker \u529f\u80fd\uff0c\u4f46\u5b9e\u9645\u4e0a\uff0c\u4e00\u5207\u90fd\u662f\u4f7f\u7528\u7684\u8fdc\u7a0b\u8c03\u7528\u5f62\u5f0f\u5728\u670d\u52a1\u7aef\uff08Docker \u5f15\u64ce\uff09\u5b8c\u6210\u3002\u4e5f\u56e0\u4e3a\u8fd9\u79cd C/S \u8bbe\u8ba1\uff0c\u8ba9\u6211\u4eec\u64cd\u4f5c\u8fdc\u7a0b\u670d\u52a1\u5668\u7684 Docker \u5f15\u64ce\u53d8\u5f97\u8f7b\u800c\u6613\u4e3e\u3002</p> <p>\u5f53\u6211\u4eec\u8fdb\u884c\u955c\u50cf\u6784\u5efa\u7684\u65f6\u5019\uff0c\u5e76\u975e\u6240\u6709\u5b9a\u5236\u90fd\u4f1a\u901a\u8fc7 RUN \u6307\u4ee4\u5b8c\u6210\uff0c\u7ecf\u5e38\u4f1a\u9700\u8981\u5c06\u4e00\u4e9b\u672c\u5730\u6587\u4ef6\u590d\u5236\u8fdb\u955c\u50cf\uff0c\u6bd4\u5982\u901a\u8fc7 <code>COPY</code> \u6307\u4ee4\u3001<code>ADD</code> \u6307\u4ee4\u7b49\u3002\u800c <code>docker build</code> \u547d\u4ee4\u6784\u5efa\u955c\u50cf\uff0c\u5176\u5b9e\u5e76\u975e\u5728\u672c\u5730\u6784\u5efa\uff0c\u800c\u662f\u5728\u670d\u52a1\u7aef\uff0c\u4e5f\u5c31\u662f Docker \u5f15\u64ce\u4e2d\u6784\u5efa\u7684\u3002\u90a3\u4e48\u5728\u8fd9\u79cd<code>\u5ba2\u6237\u7aef/\u670d\u52a1\u7aef</code>\u7684\u67b6\u6784\u4e2d\uff0c\u5982\u4f55\u624d\u80fd\u8ba9\u670d\u52a1\u7aef\u83b7\u5f97\u672c\u5730\u6587\u4ef6\u5462\uff1f</p> <p>\u8fd9\u5c31\u5f15\u5165\u4e86<code>\u4e0a\u4e0b\u6587</code>\u7684\u6982\u5ff5\u3002\u5f53\u6784\u5efa\u7684\u65f6\u5019\uff0c\u7528\u6237\u4f1a\u6307\u5b9a\u6784\u5efa\u955c\u50cf\u4e0a\u4e0b\u6587\u7684\u8def\u5f84\uff0cdocker build \u547d\u4ee4\u5f97\u77e5\u8fd9\u4e2a\u8def\u5f84\u540e\uff0c\u4f1a\u5c06\u8def\u5f84\u4e0b\u7684\u6240\u6709\u5185\u5bb9\u6253\u5305\uff0c\u7136\u540e\u4e0a\u4f20\u7ed9 Docker \u5f15\u64ce\u3002\u8fd9\u6837 Docker \u5f15\u64ce\u6536\u5230\u8fd9\u4e2a\u4e0a\u4e0b\u6587\u5305\u540e\uff0c\u5c55\u5f00\u5c31\u4f1a\u83b7\u5f97\u6784\u5efa\u955c\u50cf\u6240\u9700\u7684\u4e00\u5207\u6587\u4ef6\u3002\u5982\u679c\u5728 Dockerfile \u4e2d\u8fd9\u4e48\u5199\uff1a</p> <pre><code>COPY ./package.json /app/\n</code></pre> <p>\u8fd9\u5e76\u4e0d\u662f\u8981\u590d\u5236\u6267\u884c docker build \u547d\u4ee4\u6240\u5728\u7684\u76ee\u5f55\u4e0b\u7684 package.json\uff0c\u4e5f\u4e0d\u662f\u590d\u5236 Dockerfile \u6240\u5728\u76ee\u5f55\u4e0b\u7684 package.json\uff0c\u800c\u662f\u590d\u5236 <code>\u4e0a\u4e0b\u6587\uff08context\uff09</code> \u76ee\u5f55\u4e0b\u7684 package.json\u3002</p> <p>\u56e0\u6b64\uff0c<code>COPY</code> \u8fd9\u7c7b\u6307\u4ee4\u4e2d\u7684\u6e90\u6587\u4ef6\u7684\u8def\u5f84\u90fd\u662f<code>\u76f8\u5bf9\u8def\u5f84</code>\u3002\u8fd9\u4e5f\u662f\u521d\u5b66\u8005\u7ecf\u5e38\u4f1a\u95ee\u7684\u4e3a\u4ec0\u4e48 </p> <pre><code>COPY ../package.json /app\n</code></pre> <p>\u6216\u8005 <code>COPY /opt/xxxx /app</code> \u65e0\u6cd5\u5de5\u4f5c\u7684\u539f\u56e0\uff0c\u56e0\u4e3a\u8fd9\u4e9b\u8def\u5f84\u5df2\u7ecf\u8d85\u51fa\u4e86\u4e0a\u4e0b\u6587\u7684\u8303\u56f4\uff0cDocker \u5f15\u64ce\u65e0\u6cd5\u83b7\u5f97\u8fd9\u4e9b\u4f4d\u7f6e\u7684\u6587\u4ef6\u3002\u5982\u679c\u771f\u7684\u9700\u8981\u90a3\u4e9b\u6587\u4ef6\uff0c\u5e94\u8be5\u5c06\u5b83\u4eec\u590d\u5236\u5230\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\u53bb\u3002</p> <p>\u73b0\u5728\u5c31\u53ef\u4ee5\u7406\u89e3\u521a\u624d\u7684\u547d\u4ee4</p> <pre><code>docker build -t nginx:v1 .\n</code></pre> <p>\u4e2d\u7684\u8fd9\u4e2a<code>.</code>\uff0c\u5b9e\u9645\u4e0a\u662f\u5728\u6307\u5b9a\u4e0a\u4e0b\u6587\u7684\u76ee\u5f55\uff0cdocker build \u547d\u4ee4\u4f1a\u5c06\u8be5\u76ee\u5f55\u4e0b\u7684\u5185\u5bb9\u6253\u5305\u4ea4\u7ed9 Docker \u5f15\u64ce\u4ee5\u5e2e\u52a9\u6784\u5efa\u955c\u50cf\u3002</p> <p>\u5982\u679c\u89c2\u5bdf docker build \u8f93\u51fa\uff0c\u6211\u4eec\u5176\u5b9e\u5df2\u7ecf\u770b\u5230\u4e86\u8fd9\u4e2a\u53d1\u9001\u4e0a\u4e0b\u6587\u7684\u8fc7\u7a0b\uff1a</p> <pre><code>$ docker build -t nginx:v1 .\nSending build context to Docker daemon 048 kB\n...\n</code></pre> <p>\u7406\u89e3\u6784\u5efa\u4e0a\u4e0b\u6587\u5bf9\u4e8e\u955c\u50cf\u6784\u5efa\u662f\u5f88\u91cd\u8981\u7684\uff0c\u53ef\u4ee5\u907f\u514d\u72af\u4e00\u4e9b\u4e0d\u5e94\u8be5\u7684\u9519\u8bef\u3002\u6bd4\u5982\u6709\u4e9b\u521d\u5b66\u8005\u5728\u53d1\u73b0 COPY /opt/xxxx /app \u4e0d\u5de5\u4f5c\u540e\uff0c\u4e8e\u662f\u5e72\u8106\u5c06 Dockerfile \u653e\u5230\u4e86\u786c\u76d8\u6839\u76ee\u5f55\u53bb\u6784\u5efa\uff0c\u7ed3\u679c\u53d1\u73b0 docker build \u6267\u884c\u65f6\u53d1\u9001\u4e00\u4e2a\u51e0\u5341 GB \u7684\u4e1c\u897f\uff0c\u6781\u4e3a\u7f13\u6162\u800c\u4e14\u5f88\u5bb9\u6613\u6784\u5efa\u5931\u8d25\u3002\u90a3\u662f\u56e0\u4e3a\u8fd9\u79cd\u505a\u6cd5\u662f\u5728\u8ba9 docker build \u6253\u5305\u6574\u4e2a\u786c\u76d8\uff0c\u8fd9\u663e\u7136\u662f\u4f7f\u7528\u9519\u8bef\u3002</p> <p>\u4e00\u822c\u6765\u8bf4\uff0c\u5e94\u8be5\u4f1a\u5c06 Dockerfile \u7f6e\u4e8e\u4e00\u4e2a\u7a7a\u76ee\u5f55\u4e0b\uff0c\u6216\u8005\u9879\u76ee\u6839\u76ee\u5f55\u4e0b\u3002\u5982\u679c\u8be5\u76ee\u5f55\u4e0b\u6ca1\u6709\u6240\u9700\u6587\u4ef6\uff0c\u90a3\u4e48\u5e94\u8be5\u628a\u6240\u9700\u6587\u4ef6\u590d\u5236\u4e00\u4efd\u8fc7\u6765\u3002\u5982\u679c\u76ee\u5f55\u4e0b\u6709\u4e9b\u4e1c\u897f\u786e\u5b9e\u4e0d\u5e0c\u671b\u6784\u5efa\u65f6\u4f20\u7ed9 Docker \u5f15\u64ce\uff0c\u90a3\u4e48\u53ef\u4ee5\u7528 .gitignore \u4e00\u6837\u7684\u8bed\u6cd5\u5199\u4e00\u4e2a <code>.dockerignore</code>\uff0c\u8be5\u6587\u4ef6\u662f\u7528\u4e8e\u5254\u9664\u4e0d\u9700\u8981\u4f5c\u4e3a\u4e0a\u4e0b\u6587\u4f20\u9012\u7ed9 Docker \u5f15\u64ce\u7684\u3002</p> <p>\u90a3\u4e48\u4e3a\u4ec0\u4e48\u4f1a\u6709\u4eba\u8bef\u4ee5\u4e3a <code>.</code> \u662f\u6307\u5b9a Dockerfile \u6240\u5728\u76ee\u5f55\u5462\uff1f\u8fd9\u662f\u56e0\u4e3a\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u4e0d\u989d\u5916\u6307\u5b9a Dockerfile \u7684\u8bdd\uff0c\u4f1a\u5c06\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e0b\u7684\u540d\u4e3a Dockerfile \u7684\u6587\u4ef6\u4f5c\u4e3a Dockerfile\u3002\u8fd9\u53ea\u662f\u9ed8\u8ba4\u884c\u4e3a\uff0c\u5b9e\u9645\u4e0a Dockerfile \u7684\u6587\u4ef6\u540d\u5e76\u4e0d\u8981\u6c42\u5fc5\u987b\u4e3a Dockerfile\uff0c\u800c\u4e14\u5e76\u4e0d\u8981\u6c42\u5fc5\u987b\u4f4d\u4e8e\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\uff0c\u6bd4\u5982\u53ef\u4ee5\u7528<code>-f ../Dockerfile.Dev</code>\u53c2\u6570\u6307\u5b9a\u67d0\u4e2a\u6587\u4ef6\u4f5c\u4e3a Dockerfile\u3002</p> <p>\u5f53\u7136\uff0c\u4e00\u822c\u5927\u5bb6\u4e60\u60ef\u6027\u7684\u4f1a\u4f7f\u7528\u9ed8\u8ba4\u7684\u6587\u4ef6\u540d Dockerfile\uff0c\u4ee5\u53ca\u4f1a\u5c06\u5176\u7f6e\u4e8e\u955c\u50cf\u6784\u5efa\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\u3002</p>"},{"location":"docker/dockerfile_usage/#_71","title":"\u63a8\u9001\u955c\u50cf","text":"<p>\u4e0a\u9762\u6211\u4eec\u8bb2\u5230\u4e86 Dockerfile \u7684\u57fa\u672c\u5199\u6cd5\u4ee5\u53ca\u6784\u5efa\u955c\u50cf\u7684\u65f6\u5019\u4e00\u4e9b\u6ce8\u610f\u4e8b\u9879\uff0c\u90a3\u4e48\u955c\u50cf\u6784\u5efa\u5b8c\u6210\u540e\uff0c\u5982\u4f55\u628a\u6211\u4eec\u7684\u955c\u50cf\u7ed9\u5230\u522b\u4eba\u4f7f\u7528\u5462\uff1f\u7b2c\u4e00\u79cd\u65b9\u6cd5\u5c31\u662f\u5229\u7528 Docker \u5b98\u65b9\u63d0\u4f9b\u7684\u516c\u5171\u7684 Docker Hub \u4ed3\u5e93\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u955c\u50cf\u63a8\u9001\u4e0a\u53bb\uff0c\u7136\u540e\u522b\u4eba\u5c31\u53ef\u4ee5\u76f4\u63a5\u62c9\u53d6\u955c\u50cf\u3002</p>"},{"location":"docker/dockerfile_usage/#_72","title":"\u6ce8\u518c","text":"<p>\u9996\u5148\u9700\u8981 https://cloud.docker.com \u514d\u8d39\u6ce8\u518c\u4e00\u4e2a Docker \u8d26\u53f7\u3002</p>"},{"location":"docker/dockerfile_usage/#_73","title":"\u767b\u5f55","text":"<p>\u7136\u540e\u901a\u8fc7\u6267\u884c<code>docker login</code>\u547d\u4ee4\u4ea4\u4e92\u5f0f\u7684\u8f93\u5165\u7528\u6237\u540d\u53ca\u5bc6\u7801\u6765\u5b8c\u6210\u5728\u547d\u4ee4\u884c\u754c\u9762\u767b\u5f55 Docker Hub\u3002</p> <pre><code>$ docker login\nLogin with your Docker ID to push and pull images from Docker Hub. If you don't have a Docker ID, head over to https://hub.docker.com to create one.\nUsername: cnych\nPassword:\nWARNING! Your password will be stored unencrypted in /root/.docker/config.json.\nConfigure a credential helper to remove this warning. See\nhttps://docs.docker.com/engine/reference/commandline/login/#credentials-store\n\nLogin Succeeded\n</code></pre>"},{"location":"docker/dockerfile_usage/#_74","title":"\u6ce8\u9500","text":"<p>\u4f60\u53ef\u4ee5\u901a\u8fc7<code>docker logout</code>\u9000\u51fa\u767b\u5f55\u3002</p>"},{"location":"docker/dockerfile_usage/#_75","title":"\u63a8\u9001\u955c\u50cf","text":"<p>\u7528\u6237\u5728\u767b\u5f55\u540e\u53ef\u4ee5\u901a\u8fc7<code>docker push</code>\u547d\u4ee4\u6765\u5c06\u81ea\u5df1\u7684\u955c\u50cf\u63a8\u9001\u5230 Docker Hub\u3002\u4ee5\u4e0b\u547d\u4ee4\u4e2d\u7684 username \u8bf7\u66ff\u6362\u4e3a\u4f60\u7684 Docker \u8d26\u53f7\u7528\u6237\u540d\u3002</p> <pre><code>$ docker tag ubuntu:10 username/ubuntu:10\n$ docker image ls\n\nREPOSITORY                                               TAG                    IMAGE ID            CREATED             SIZE\nubuntu                                                   10                  275d79972a86        6 days ago          6MB\nusername/ubuntu                                          10                  275d79972a86        6 days ago          6MB\n$ docker push username/ubuntu:10\n</code></pre>"},{"location":"docker/dockerfile_usage/#_76","title":"\u79c1\u6709\u4ed3\u5e93","text":"<p>\u6709\u65f6\u5019\u6211\u4eec\u53ef\u80fd\u5e0c\u671b\u6211\u4eec\u7684\u955c\u50cf\u53ea\u5728\u5c40\u57df\u7f51\u8303\u56f4\u5185\u4f7f\u7528\uff0c\u4e0d\u5e0c\u671b\u63a8\u9001\u5230 Docker Hub \u8fd9\u6837\u7684\u516c\u5171\u4ed3\u5e93\uff0c\u90a3\u4e48\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u672c\u5730\u4ed3\u5e93\u4f9b\u79c1\u4eba\u4f7f\u7528\u3002</p> <p><code>docker-registry</code> \u5c31\u662f\u662f\u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e2a\u79c1\u6709\u4ed3\u5e93\u5de5\u5177\uff0c\u53ef\u4ee5\u7528\u4e8e\u5b58\u50a8\u79c1\u6709\u7684\u955c\u50cf\u4ed3\u5e93\u3002\u540c\u6837\u7684\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u83b7\u53d6\u5b98\u65b9 registry \u955c\u50cf\u6765\u76f4\u63a5\u8fd0\u884c\uff1a</p> <pre><code>$ docker run -d -p 5000:5000 --name registry registry:2\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u4f7f\u7528\u5b98\u65b9\u7684 registry \u955c\u50cf\u6765\u542f\u52a8\u79c1\u6709\u4ed3\u5e93\u5bb9\u5668\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4ed3\u5e93\u4f1a\u88ab\u521b\u5efa\u5728\u5bb9\u5668\u7684<code>/var/lib/registry</code>\u76ee\u5f55\u4e0b\u3002\u4f60\u53ef\u4ee5\u901a\u8fc7 <code>-v</code> \u53c2\u6570\u6765\u5c06\u955c\u50cf\u6587\u4ef6\u5b58\u653e\u5728\u672c\u5730\u7684\u6307\u5b9a\u8def\u5f84\u3002\u4f8b\u5982\u4e0b\u9762\u7684\u4f8b\u5b50\u5c06\u4e0a\u4f20\u7684\u955c\u50cf\u653e\u5230\u672c\u5730\u7684 <code>/opt/data/registry</code> \u76ee\u5f55:</p> <pre><code>$ docker run -d \\\\\n    -p 5000:5000 \\\\\n    -v /opt/data/registry:/var/lib/registry \\\\\n    registry:2\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u8fd0\u884c\u4e86\u4e00\u4e2a\u6570\u636e\u6301\u4e45\u5316\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u3002</p> <p>\u521b\u5efa\u597d\u79c1\u6709\u4ed3\u5e93\u4e4b\u540e\uff0c\u7136\u540e\u53ef\u4ee5\u4f7f\u7528<code>docker tag</code>\u6765\u6807\u8bb0\u4e00\u4e2a\u955c\u50cf\uff0c\u7136\u540e\u63a8\u9001\u5b83\u5230\u4ed3\u5e93\u3002\u6bd4\u5982\u79c1\u6709\u4ed3\u5e93\u5730\u5740\u4e3a<code>127.0.0.1:5000</code>\u3002\u5148\u5728\u672c\u673a\u67e5\u770b\u5df2\u6709\u7684\u955c\u50cf\u3002</p> <pre><code>$ docker images\nREPOSITORY                        TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nubuntu                            latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u4f7f\u7528<code>docker tag</code>\u5c06 ubuntu:latest \u8fd9\u4e2a\u955c\u50cf\u6807\u8bb0\u4e3a </p> <pre><code>11:5000/ubuntu:latest\n</code></pre> <p>:</p> <pre><code>$ docker tag ubuntu:latest 11:5000/ubuntu:latest\n$ docker images\nREPOSITORY                        TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nubuntu                            latest              ba5877dc9bec        6 weeks ago         17 MB\n11:5000/ubuntu:latest      latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u7136\u540e\u5c31\u53ef\u4ee5\u4f7f\u7528<code>docker push</code>\u4e0a\u4f20\u6807\u8bb0\u7684\u955c\u50cf:</p> <pre><code>$ docker push 11:5000/ubuntu:latest\nThe push refers to repository [11:5000/ubuntu]\n373a30c24545: Pushed\na9148f5200b0: Pushed\ncdd3de0940ab: Pushedfc56279bbb33: Pushed\nb38367233d37: Pushed\n2aebd096e0e2: Pushed\nlatest: digest: sha256:fe4277621f10b5026266932ddf760f5a756d2facd505a94d2da12f4f52f71f5a size: 1568\n</code></pre> <p>\u6b64\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528 registry \u4ed3\u5e93\u63d0\u4f9b\u7684 API \u6765\u67e5\u770b\u4ed3\u5e93\u4e2d\u7684\u955c\u50cf\uff1a</p> <pre><code>$ curl 11:5000/v2/_catalog\n{\"repositories\":[\"ubuntu\"]}\n</code></pre> <p>\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230 {\"repositories\":[\"ubuntu\"]}\uff0c\u8868\u660e\u955c\u50cf\u5df2\u7ecf\u88ab\u6210\u529f\u4e0a\u4f20\u4e86\u3002</p> <p>\u5148\u5220\u9664\u5df2\u6709\u955c\u50cf\uff0c\u518d\u5c1d\u8bd5\u4ece\u79c1\u6709\u4ed3\u5e93\u4e2d\u4e0b\u8f7d\u8fd9\u4e2a\u955c\u50cf\u3002</p> <pre><code>$ docker image rm 11:5000/ubuntu:latest\n$ docker pull 11:5000/ubuntu:latest\nPulling repository 11:5000/ubuntu:latest\nba5877dc9bec: Download complete\n511136ea3c5a: Download complete\n9bad880da3d2: Download complete\n25f11f5fb0cb: Download complete\nebc34468f71d: Download complete\n2318d26665ef: Download complete\n$ docker image ls\nREPOSITORY                         TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\n11:5000/ubuntu:latest       latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u628a\u955c\u50cf\u4e0a\u4f20\u5230\u4e86\u79c1\u6709\u4ed3\u5e93\u4e2d\u7684\u5b8c\u6574\u8fc7\u7a0b\u3002</p>"},{"location":"docker/dockerfile_usage/#_77","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p>\u5982\u679c\u4f60\u4e0d\u60f3\u4f7f\u7528 <code>127.0.0.1:5000</code> \u4f5c\u4e3a\u4ed3\u5e93\u5730\u5740\uff0c\u6bd4\u5982\u60f3\u8ba9\u672c\u7f51\u6bb5\u7684\u5176\u4ed6\u4e3b\u673a\u4e5f\u80fd\u628a\u955c\u50cf\u63a8\u9001\u5230\u79c1\u6709\u4ed3\u5e93\u3002\u4f60\u5c31\u5f97\u628a\u4f8b\u5982 <code>192.168.199.100:5000</code> \u8fd9\u6837\u7684\u5185\u7f51\u5730\u5740\u4f5c\u4e3a\u79c1\u6709\u4ed3\u5e93\u5730\u5740\uff0c\u8fd9\u65f6\u4f60\u4f1a\u53d1\u73b0\u65e0\u6cd5\u6210\u529f\u63a8\u9001\u955c\u50cf\u3002</p> <p>\u8fd9\u662f\u56e0\u4e3a Docker \u9ed8\u8ba4\u4e0d\u5141\u8bb8\u975e HTTPS \u65b9\u5f0f\u63a8\u9001\u955c\u50cf\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Docker \u7684\u914d\u7f6e\u9009\u9879\u6765\u53d6\u6d88\u8fd9\u4e2a\u9650\u5236\uff0c\u6211\u4eec\u8fd9\u91cc\u662f CentOS 7 \u7cfb\u7edf\uff0c\u540c\u6837\u8fd8\u662f\u7f16\u8f91\u6587\u4ef6</p> <pre><code>/etc/docker/daemon.json\n</code></pre> <p>\uff0c\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>{\n  \"registry-mirror\": [\n    \"https://registry.docker-cn.com\"\n  ],\n  \"insecure-registries\": [\n    \"111100:5000\"\n  ]\n}\n</code></pre> <p>\u5176\u4e2d\u7684<code>insecure-registries</code>\u5c31\u662f\u6211\u4eec\u6dfb\u52a0\u7684\u5185\u5bb9\uff0c\u7136\u540e\u91cd\u542f Docker \u4e4b\u540e\u5c31\u53ef\u4ee5\u5728\u5c40\u57df\u7f51\u5185\u4f7f\u7528\u6211\u4eec\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u4e86\u3002</p> <p>\u9ed8\u8ba4\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u53ef\u4ee5\u6ee1\u8db3\u6211\u4eec\u7684\u5f88\u591a\u9700\u6c42\uff0c\u4f46\u662f\u5f80\u5f80\u5728\u4f01\u4e1a\u4e2d\u4f7f\u7528\u7684\u8bdd\u8fd8\u6709\u5f88\u5b89\u5168\u6027\u65b9\u9762\u7684\u529f\u80fd\u7684\u7f3a\u5931\uff0c\u6bd4\u5982\u6743\u9650\u7ba1\u7406\u4e4b\u7c7b\u7684\uff0c\u8fd9\u5bf9\u4e8e\u4f01\u4e1a\u6765\u8bf4\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u4e0d\u8fc7 registry \u5bf9\u4e8e\u6743\u9650\u7ba1\u7406\u8fd9\u4e00\u5757\u505a\u4e86\u4e00\u4e2a\u5bf9\u5916\u66b4\u9732\u7684\u63a5\u53e3\uff0c\u53ea\u8981\u6211\u4eec\u5b9e\u73b0\u4ed6\u66b4\u9732\u7684\u5b89\u5168\u63a5\u53e3\u5c31\u53ef\u4ee5\u6765\u5b9e\u73b0\u6743\u9650\u7ba1\u7406\u76f8\u5173\u7684\u63a5\u53e3\uff0c\u5176\u4e2d\u6ce8\u660e\u7684\u5f00\u6e90\u955c\u50cf\u7ba1\u7406\u8f6f\u4ef6 Harbor \u5c31\u662f\u8fd9\u7c7b\u5e94\u7528\u7684\u4f7c\u4f7c\u8005\uff0c\u6211\u4eec\u8fd8\u5728\u540e\u9762\u7684\u8bfe\u7a0b\u4e2d\u548c\u5927\u5bb6\u5b66\u4e60 Harbor \u7684\u4e00\u4e2a\u4f7f\u7528\u3002\u4f7f\u7528 Dockerfile \u5b9a\u5236\u955c\u50cf</p> <p></p> <p>\u955c\u50cf\u7684\u5b9a\u5236\u5b9e\u9645\u4e0a\u5c31\u662f\u5b9a\u5236\u955c\u50cf\u7684\u6bcf\u4e00\u5c42\u6240\u6dfb\u52a0\u7684\u914d\u7f6e\u3001\u6587\u4ef6\u7b49\u4fe1\u606f\uff0c\u5b9e\u9645\u4e0a\u5f53\u6211\u4eec\u5728\u4e00\u4e2a\u5bb9\u5668\u4e2d\u6dfb\u52a0\u6216\u8005\u4fee\u6539\u4e86\u4e00\u4e9b\u6587\u4ef6\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7<code>docker commit</code>\u547d\u4ee4\u6765\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u955c\u50cf\uff0c\u4f46\u662f\u8fd9\u4e2a\u65b9\u6cd5\u4e0d\u591f\u76f4\u89c2\uff0c\u6ca1\u529e\u6cd5\u8ffd\u6eaf\u6211\u4eec\u955c\u50cf\u91cc\u9762\u5230\u5e95\u6709\u54ea\u4e9b\u5185\u5bb9\uff0c\u6240\u4ee5\u5b9e\u9645\u5b9a\u5236\u955c\u50cf\u7684\u8fc7\u7a0b\u6211\u4eec\u5f88\u5c11\u91c7\u7528\u8fd9\u79cd\u65b9\u5f0f\u3002\u800c\u662f\u4f7f\u7528\u4e00\u4e2a\u540d\u4e3a <code>Dockerfile</code> \u7684\u6587\u672c\u6587\u4ef6\u6765\u8fdb\u884c\u955c\u50cf\u5b9a\u5236\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u955c\u50cf\u7684\u6bcf\u4e00\u5c42\u4fee\u6539\u3001\u5b89\u88c5\u3001\u6784\u5efa\u3001\u64cd\u4f5c\u7684\u547d\u4ee4\u90fd\u5199\u5165\u5230\u8fd9\u4e2a\u6587\u4ef6\u4e2d\uff0c\u4e00\u884c\u5c31\u5bf9\u5e94\u955c\u50cf\u7684\u4e00\u5c42\uff0c\u8fd9\u79cd\u65b9\u6cd5\u663e\u7136\u8981\u66f4\u9ad8\u7ea7\uff0c\u56e0\u4e3a\u6211\u4eec\u6709\u4e00\u4e2a\u6587\u4ef6\u6765\u76f4\u89c2\u53cd\u6620\u6211\u4eec\u7684\u955c\u50cf\u5185\u5bb9\uff0c\u8fd8\u53ef\u4ee5\u4f5c\u4e3a\u7248\u672c\u8bb0\u5f55\u8fdb\u884c\u8ddf\u8e2a\u3002</p>"},{"location":"docker/dockerfile_usage/#_78","title":"\u5b9a\u5236\u955c\u50cf","text":"<p>\u4ee5\u6211\u4eec\u4e4b\u524d\u7684 nginx \u955c\u50cf\u4e3a\u4f8b\uff0c\u6211\u4eec\u73b0\u5728\u6765\u5b9a\u5236\u4e00\u4e2a nginx \u955c\u50cf\uff0c\u8981\u6c42\u9ed8\u8ba4\u7684\u5e94\u7528\u9875\u9762\u8bbf\u95ee\u7684\u5185\u5bb9\u662f <code>Hello Docker</code>\u3002</p> <p>\u9996\u5148\u6211\u4eec\u65b0\u5efa\u4e00\u4e2a\u76ee\u5f55 testnginx\uff0c\u7136\u540e\u5728\u8be5\u76ee\u5f55\u4e0b\u9762\u65b0\u5efa\u4e00\u4e2a\u540d\u4e3a<code>Dockerfile</code>\u7684\u7a7a\u767d\u6587\u672c\u6587\u4ef6\uff1a</p> <pre><code>$ mkdir -p testnginx &amp;&amp; cd testnginx &amp;&amp; touch Dockerfile\n</code></pre> <p>\u7136\u540e\u5411<code>Dockerfile</code>\u6587\u4ef6\u4e2d\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>FROM nginx\nRUN echo 'Hello Docker!' &gt; /user/share/nginx/html/index.html\n</code></pre> <p>\u8fd9\u4e2a\u6587\u4ef6\u5f88\u7b80\u5355\uff0c\u4e00\u5171\u5c31\u4e24\u884c\uff0c\u5176\u4e2d\u5305\u542b\u4e24\u6761\u6307\u4ee4\uff0c<code>FROM</code> \u548c <code>RUN</code>\u3002</p>"},{"location":"docker/dockerfile_usage/#from_7","title":"FROM \u6307\u4ee4","text":"<p>\u5b9a\u5236\u955c\u50cf\uff0c\u90a3\u4e48\u80af\u5b9a\u662f\u4e00\u4e2a\u955c\u50cf\u4e3a\u57fa\u7840\uff0c\u5728\u5176\u57fa\u7840\u4e0a\u8fdb\u884c\u5b9a\u5236\uff0c\u800c <code>FROM</code> \u8fd9\u4e2a\u6307\u4ee4\u5c31\u662f\u6765\u6307\u5b9a\u57fa\u7840\u955c\u50cf\u7684\uff0c\u6240\u4ee5\u5728\u4e00\u4e2a <code>Dockerfile</code> \u6587\u4ef6\u4e2d <code>FROM</code> \u6307\u4ee4\u662f\u5fc5\u5907\u7684\uff0c\u5e76\u4e14\u5fc5\u987b\u662f\u7b2c\u4e00\u6761\u6307\u4ee4\u3002</p> <p>\u5728 Docker Hub \u4e0a\u6709\u975e\u5e38\u591a\u7684\u9ad8\u8d28\u91cf\u7684\u5b98\u65b9\u955c\u50cf\uff0c\u6709\u4e00\u4e9b\u53ef\u4ee5\u76f4\u63a5\u62ff\u6765\u4f7f\u7528\u7684\u670d\u52a1\u7c7b\u7684\u955c\u50cf\uff0c\u5982 nginx\u3001redis\u3001mongo\u3001mysql\u3001httpd\u3001php\u3001tomcat \u7b49\uff1b\u4e5f\u6709\u4e00\u4e9b\u65b9\u4fbf\u5f00\u53d1\u3001\u6784\u5efa\u3001\u8fd0\u884c\u5404\u79cd\u8bed\u8a00\u5e94\u7528\u7684\u955c\u50cf\uff0c\u5982 node\u3001openjdk\u3001python\u3001ruby\u3001golang \u7b49\u3002\u53ef\u4ee5\u5728\u5176\u4e2d\u5bfb\u627e\u4e00\u4e2a\u6700\u7b26\u5408\u6211\u4eec\u6700\u7ec8\u76ee\u6807\u7684\u955c\u50cf\u4e3a\u57fa\u7840\u955c\u50cf\u8fdb\u884c\u5b9a\u5236\u3002</p> <p>\u5982\u679c\u6ca1\u6709\u627e\u5230\u5408\u9002\u7684\u57fa\u7840\u955c\u50cf\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e9b\u66f4\u4e3a\u57fa\u7840\u7684\u64cd\u4f5c\u7cfb\u7edf\u955c\u50cf\uff0c\u6bd4\u5982 ubuntu\u3001debian\u3001centos\u3001alpine \u7b49\uff0c\u8fd9\u4e9b\u57fa\u7840\u955c\u50cf\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u66f4\u5927\u7684\u6269\u5c55\u7a7a\u95f4\uff0c\u5c31\u7c7b\u4f3c\u4e8e\u5e73\u65f6\u6211\u4eec\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e0a\u9762\u90e8\u7f72\u81ea\u5df1\u7684\u670d\u52a1\u4e00\u6837\u7684\u64cd\u4f5c\u3002</p> <p>\u9664\u4e86\u9009\u62e9\u73b0\u6709\u955c\u50cf\u4e3a\u57fa\u7840\u955c\u50cf\u5916\uff0cDocker \u8fd8\u5b58\u5728\u4e00\u4e2a\u7279\u6b8a\u7684\u955c\u50cf\uff0c\u540d\u4e3a <code>scratch</code>\uff0c\u8fd9\u4e2a\u955c\u50cf\u662f\u4e00\u4e2a\u865a\u62df\u7684\u955c\u50cf\uff0c\u5e76\u4e0d\u5b9e\u9645\u5b58\u5728\uff0c\u8868\u793a\u4e00\u4e2a\u7a7a\u767d\u7684\u955c\u50cf\uff1a</p> <p><code>FROM scratch ...</code></p> <p>\u5982\u679c\u4f60\u4ee5 <code>scratch</code> \u4e3a\u57fa\u7840\u955c\u50cf\u7684\u8bdd\uff0c\u610f\u5473\u7740\u4f60\u4e0d\u4ee5\u4efb\u4f55\u955c\u50cf\u4e3a\u57fa\u7840\uff0c\u63a5\u4e0b\u6765\u6240\u5199\u7684\u6307\u4ee4\u5c06\u4f5c\u4e3a\u955c\u50cf\u7b2c\u4e00\u5c42\u5f00\u59cb\u5b58\u5728\u3002\u6709\u7684\u540c\u5b66\u53ef\u80fd\u611f\u89c9\u5f88\u5947\u602a\uff0c\u6ca1\u6709\u4efb\u4f55\u57fa\u7840\u955c\u50cf\uff0c\u6211\u600e\u4e48\u53bb\u6267\u884c\u6211\u7684\u7a0b\u5e8f\u5462\uff0c\u5176\u5b9e\u5bf9\u4e8e Linux \u4e0b\u9759\u6001\u7f16\u8bd1\u7684\u7a0b\u5e8f\u6765\u8bf4\uff0c\u5e76\u4e0d\u9700\u8981\u6709\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u8fd0\u884c\u65f6\u652f\u6301\uff0c\u6240\u9700\u7684\u4e00\u5207\u5e93\u90fd\u5df2\u7ecf\u5728\u53ef\u6267\u884c\u6587\u4ef6\u91cc\u4e86\uff0c\u56e0\u6b64\u76f4\u63a5<code>FROM scratch</code>\u4f1a\u8ba9\u955c\u50cf\u4f53\u79ef\u66f4\u52a0\u5c0f\u5de7\u3002\u4f7f\u7528 Go \u8bed\u8a00 \u5f00\u53d1\u7684\u5e94\u7528\u5f88\u591a\u4f1a\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u6765\u5236\u4f5c\u955c\u50cf\uff0c\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u6709\u5f88\u591a\u89c2\u70b9\u8ba4\u4e3a Go \u662f\u7279\u522b\u9002\u5408\u5bb9\u5668\u5fae\u670d\u52a1\u67b6\u6784\u7684\u8bed\u8a00\u7684\u539f\u56e0\u4e4b\u4e00\u3002</p>"},{"location":"docker/dockerfile_usage/#run_7","title":"RUN \u6307\u4ee4","text":"<p><code>RUN</code> \u6307\u4ee4\u662f\u7528\u6765\u6267\u884c\u547d\u4ee4\u884c\u547d\u4ee4\u7684\u3002\u7531\u4e8e\u547d\u4ee4\u884c\u7684\u5f3a\u5927\u80fd\u529b\uff0c\u6240\u4ee5 <code>RUN</code> \u6307\u4ee4\u662f\u5b9a\u5236\u955c\u50cf\u65f6\u662f\u6700\u5e38\u7528\u7684\u6307\u4ee4\u4e4b\u4e00\u3002\u5176\u683c\u5f0f\u6709\u4e24\u79cd\uff1a</p> <ul> <li> <p>shell \u683c\u5f0f\uff1a<code>RUN &lt;\u547d\u4ee4&gt;</code>\uff0c\u5c31\u50cf\u76f4\u63a5\u5728\u547d\u4ee4\u884c\u4e2d\u8f93\u5165\u7684\u547d\u4ee4\u4e00\u6837\u3002\u521a\u624d\u5199\u7684 Dockerfile \u4e2d\u7684 RUN \u6307\u4ee4\u5c31\u662f\u8fd9\u79cd\u683c\u5f0f\uff1a</p> <pre><code>RUN echo 'Hello, Docker!' &gt; /usr/share/nginx/html/index.html\n</code></pre> </li> <li> <p>exec \u683c\u5f0f\uff1a</p> <pre><code>RUN [\"\u53ef\u6267\u884c\u6587\u4ef6\", \"\u53c2\u65701\", \"\u53c2\u65702\"]\n</code></pre> <p>\uff0c\u8fd9\u66f4\u50cf\u662f\u51fd\u6570\u8c03\u7528\u4e2d\u7684\u683c\u5f0f\u3002\u65e2\u7136 RUN \u5c31\u50cf Shell \u811a\u672c\u4e00\u6837\u53ef\u4ee5\u6267\u884c\u547d\u4ee4\uff0c\u90a3\u4e48\u6211\u4eec\u662f\u5426\u5c31\u53ef\u4ee5\u50cf Shell \u811a\u672c\u4e00\u6837\u628a\u6bcf\u4e2a\u547d\u4ee4\u5bf9\u5e94\u4e00\u4e2a RUN \u5462\uff1f\u6bd4\u5982\u8fd9\u6837\uff1a</p> <pre><code>FROM debian:jessie\nRUN apt-get update\nRUN apt-get install -y gcc libc6-dev make wget\nRUN wget -O redis.tar.gz \"http://download.redis.io/releases/redis-tar.gz\"\nRUN mkdir -p /usr/src/redis\nRUN tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1\nRUN make -C /usr/src/redis\nRUN make -C /usr/src/redis install\n# \u5176\u4ed6\u6307\u4ee4...\n</code></pre> </li> </ul> <p>\u4e4b\u524d\u8bf4\u8fc7\uff0cDockerfile \u4e2d\u6bcf\u4e00\u4e2a\u6307\u4ee4\u90fd\u4f1a\u5efa\u7acb\u4e00\u5c42\uff0cRUN \u4e5f\u4e0d\u4f8b\u5916\u3002\u6bcf\u4e00\u4e2a RUN \u5c31\u4f1a\u65b0\u5efa\u7acb\u4e00\u5c42\uff0c\u5728\u5176\u4e0a\u6267\u884c\u8fd9\u4e9b\u547d\u4ee4\uff0c\u6267\u884c\u7ed3\u675f\u540e\uff0ccommit \u8fd9\u4e00\u5c42\u7684\u4fee\u6539\uff0c\u6784\u6210\u65b0\u7684\u955c\u50cf\u3002</p> <p>\u800c\u4e0a\u9762\u7684\u8fd9\u79cd\u5199\u6cd5\uff0c\u521b\u5efa\u4e86 7 \u5c42\u955c\u50cf\u3002\u8fd9\u662f\u5b8c\u5168\u6ca1\u6709\u5fc5\u8981\u7684\uff0c\u800c\u4e14\u5f88\u591a\u8fd0\u884c\u65f6\u4e0d\u9700\u8981\u7684\u4e1c\u897f\uff0c\u90fd\u88ab\u88c5\u8fdb\u4e86\u955c\u50cf\u91cc\uff0c\u6bd4\u5982\u7f16\u8bd1\u73af\u5883\u3001\u66f4\u65b0\u7684\u8f6f\u4ef6\u5305\u7b49\u7b49\u3002\u7ed3\u679c\u5c31\u662f\u4ea7\u751f\u975e\u5e38\u81c3\u80bf\u3001\u975e\u5e38\u591a\u5c42\u7684\u955c\u50cf\uff0c\u4e0d\u4ec5\u4ec5\u589e\u52a0\u4e86\u6784\u5efa\u90e8\u7f72\u7684\u65f6\u95f4\uff0c\u4e5f\u5f88\u5bb9\u6613\u51fa\u9519\u3002 \u8fd9\u662f\u5f88\u591a\u521d\u5b66 Docker \u7684\u4eba\u5e38\u72af\u7684\u4e00\u4e2a\u9519\u8bef\u3002</p> <p>UnionFS \u5c42\u9650\u5236</p> <p>UnionFS \u5b9e\u9645\u4e0a\u662f\u6709\u6700\u5927\u5c42\u6570\u9650\u5236\u7684\uff0c\u6bd4\u5982 AUFS\uff0c\u66fe\u7ecf\u662f\u6700\u5927\u4e0d\u5f97\u8d85\u8fc7 42 \u5c42\uff0c\u73b0\u5728\u662f\u4e0d\u5f97\u8d85\u8fc7 127 \u5c42\u3002</p> <p>\u4e0a\u9762\u7684 Dockerfile \u6b63\u786e\u7684\u5199\u6cd5\u5e94\u8be5\u662f\u8fd9\u6837\uff1a</p> <pre><code>FROM debian:jessie\nRUN buildDeps='gcc libc6-dev make wget' \\\\\n    &amp;&amp; apt-get update \\\\\n    &amp;&amp; apt-get install -y $buildDeps \\\\\n    &amp;&amp; wget -O redis.tar.gz \"http://download.redis.io/releases/redis-tar.gz\" \\\\\n    &amp;&amp; mkdir -p /usr/src/redis \\\\\n    &amp;&amp; tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1 \\\\\n    &amp;&amp; make -C /usr/src/redis \\\\\n    &amp;&amp; make -C /usr/src/redis install \\\\\n    &amp;&amp; rm -rf /var/lib/apt/lists/* \\\\\n    &amp;&amp; rm redis.tar.gz \\\\\n    &amp;&amp; rm -r /usr/src/redis \\\\\n    &amp;&amp; apt-get purge -y --auto-remove $buildDeps\n# \u5176\u4ed6\u6307\u4ee4...\n</code></pre> <p>\u9996\u5148\uff0c\u4e4b\u524d\u6240\u6709\u7684\u547d\u4ee4\u53ea\u6709\u4e00\u4e2a\u76ee\u7684\uff0c\u5c31\u662f\u7f16\u8bd1\u3001\u5b89\u88c5 redis \u53ef\u6267\u884c\u6587\u4ef6\u3002\u56e0\u6b64\u6ca1\u6709\u5fc5\u8981\u5efa\u7acb\u5f88\u591a\u5c42\uff0c\u8fd9\u53ea\u662f\u4e00\u5c42\u7684\u4e8b\u60c5\u3002\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u6ca1\u6709\u4f7f\u7528\u5f88\u591a\u4e2a RUN \u6307\u4ee4\u6765\u5bf9\u5e94\u4e0d\u540c\u7684\u547d\u4ee4\uff0c\u800c\u662f\u4ec5\u4ec5\u4f7f\u7528\u4e00\u4e2a RUN \u6307\u4ee4\uff0c\u5e76\u4f7f\u7528<code>&amp;&amp;</code>\u5c06\u5404\u4e2a\u6240\u9700\u547d\u4ee4\u4e32\u8054\u8d77\u6765\u3002\u5c06\u4e4b\u524d\u7684 7 \u5c42\uff0c\u7b80\u5316\u4e3a\u4e86 1 \u5c42\u3002\u5728\u64b0\u5199 Dockerfile \u7684\u65f6\u5019\uff0c\u8981\u7ecf\u5e38\u63d0\u9192\u81ea\u5df1\uff0c\u8fd9\u5e76\u4e0d\u662f\u5728\u5199 Shell \u811a\u672c\uff0c\u800c\u662f\u5728\u5b9a\u4e49\u6bcf\u4e00\u5c42\u8be5\u5982\u4f55\u6784\u5efa\u3002</p> <p>\u5e76\u4e14\uff0c\u8fd9\u91cc\u4e3a\u4e86\u683c\u5f0f\u5316\u8fd8\u8fdb\u884c\u4e86\u6362\u884c\u3002Dockerfile \u652f\u6301 Shell \u7c7b\u7684\u884c\u5c3e\u6dfb\u52a0<code>\\</code>\u7684\u547d\u4ee4\u6362\u884c\u65b9\u5f0f\uff0c\u4ee5\u53ca\u884c\u9996<code>#</code>\u8fdb\u884c\u6ce8\u91ca\u7684\u683c\u5f0f\u3002\u826f\u597d\u7684\u683c\u5f0f\uff0c\u6bd4\u5982<code>\u6362\u884c\u3001\u7f29\u8fdb\u3001\u6ce8\u91ca</code>\u7b49\uff0c\u4f1a\u8ba9\u7ef4\u62a4\u3001\u6392\u969c\u66f4\u4e3a\u5bb9\u6613\uff0c\u8fd9\u662f\u4e00\u4e2a\u6bd4\u8f83\u597d\u7684\u4e60\u60ef\u3002</p> <p>\u6b64\u5916\uff0c\u8fd8\u53ef\u4ee5\u770b\u5230\u8fd9\u4e00\u7ec4\u547d\u4ee4\u7684\u6700\u540e\u6dfb\u52a0\u4e86\u6e05\u7406\u5de5\u4f5c\u7684\u547d\u4ee4\uff0c\u5220\u9664\u4e86\u4e3a\u4e86\u7f16\u8bd1\u6784\u5efa\u4e0b\u8f7d\u7684\u8f6f\u4ef6\uff0c\u6e05\u7406\u4e86\u6240\u6709\u4e0b\u8f7d\u3001\u5c55\u5f00\u7684\u6587\u4ef6\uff0c\u5e76\u4e14\u8fd8\u6e05\u7406\u4e86 apt \u7f13\u5b58\u6587\u4ef6\u3002\u8fd9\u662f\u5f88\u91cd\u8981\u7684\u4e00\u6b65\uff0c\u6211\u4eec\u4e4b\u524d\u8bf4\u8fc7\uff0c\u955c\u50cf\u662f\u591a\u5c42\u5b58\u50a8\uff0c\u6bcf\u4e00\u5c42\u7684\u4e1c\u897f\u5e76\u4e0d\u4f1a\u5728\u4e0b\u4e00\u5c42\u88ab\u5220\u9664\uff0c\u4f1a\u4e00\u76f4\u8ddf\u968f\u7740\u955c\u50cf\u3002\u56e0\u6b64\u955c\u50cf\u6784\u5efa\u65f6\uff0c\u4e00\u5b9a\u8981\u786e\u4fdd\u6bcf\u4e00\u5c42\u53ea\u6dfb\u52a0\u771f\u6b63\u9700\u8981\u6dfb\u52a0\u7684\u4e1c\u897f\uff0c\u4efb\u4f55\u65e0\u5173\u7684\u4e1c\u897f\u90fd\u5e94\u8be5\u6e05\u7406\u6389\u3002 \u5f88\u591a\u4eba\u521d\u5b66 Docker \u5236\u4f5c\u51fa\u4e86\u5f88\u81c3\u80bf\u7684\u955c\u50cf\u7684\u539f\u56e0\u4e4b\u4e00\uff0c\u5c31\u662f\u5fd8\u8bb0\u4e86\u6bcf\u4e00\u5c42\u6784\u5efa\u7684\u6700\u540e\u4e00\u5b9a\u8981\u6e05\u7406\u6389\u65e0\u5173\u6587\u4ef6\u3002</p>"},{"location":"docker/dockerfile_usage/#workdir_7","title":"WORKDIR \u6307\u4ee4","text":"<p><code>WORKDIR</code> \u6307\u4ee4\u8bbe\u7f6e Dockerfile \u4e2d\u7684\u4efb\u4f55 RUN\uff0cCMD\uff0cENTRPOINT\uff0cCOPY \u548c ADD \u6307\u4ee4\u7684\u5de5\u4f5c\u76ee\u5f55\u3002\u5982\u679c WORKDIR \u6307\u5b9a\u7684\u76ee\u5f55\u4e0d\u5b58\u5728\uff0c\u5373\u4f7f\u968f\u540e\u7684\u6307\u4ee4\u6ca1\u6709\u7528\u5230\u8fd9\u4e2a\u76ee\u5f55\uff0c\u90fd\u4f1a\u521b\u5efa\u8be5\u76ee\u5f55\u3002</p> <p>\u683c\u5f0f\uff1a </p> <pre><code>WORKDIR /path/to/workdir\n</code></pre> <p>\u4e3a\u4e86\u6e05\u6670\u6027\u548c\u53ef\u9760\u6027\uff0c\u4f60\u5e94\u8be5\u603b\u662f\u5728 WORKDIR \u4e2d\u4f7f\u7528\u7edd\u5bf9\u8def\u5f84\uff0c\u800c\u4e14\u5355\u4e2a Dockerfile \u53ef\u4ee5\u4f7f\u7528\u591a\u6b21WORKDIR\u3002\u53e6\u5916\uff0c\u6211\u4eec\u5e94\u8be5\u4f7f\u7528 WORKDIR \u6765\u66ff\u4ee3\u7c7b\u4f3c\u4e8e </p> <pre><code>RUN cd ... &amp;&amp; do-something\n</code></pre> <p>\u7684\u6307\u4ee4\uff0c\u540e\u8005\u96be\u4ee5\u9605\u8bfb\u3001\u6392\u9519\u548c\u7ef4\u62a4\u3002</p>"},{"location":"docker/dockerfile_usage/#add_copy_7","title":"ADD &amp; COPY \u6307\u4ee4","text":"<p>Dockerfile \u4e2d\u7684 <code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code> \u6307\u4ee4\u90fd\u53ef\u4ee5\u5c06\u4e3b\u673a\u4e0a\u7684\u8d44\u6e90\u590d\u5236\u6216\u52a0\u5165\u5230\u5bb9\u5668\u955c\u50cf\u4e2d\uff0c\u90fd\u662f\u5728\u6784\u5efa\u955c\u50cf\u7684\u8fc7\u7a0b\u4e2d\u5b8c\u6210\u7684\u3002</p> <p><code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code> \u6307\u4ee4\u7684\u552f\u4e00\u533a\u522b\u5728\u4e8e<code>\u662f\u5426\u652f\u6301\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90</code>\u3002<code>COPY</code> \u6307\u4ee4\u53ea\u80fd\u4ece\u6267\u884c<code>docker build</code>\u6240\u5728\u7684\u4e3b\u673a\u4e0a\u8bfb\u53d6\u8d44\u6e90\u5e76\u590d\u5236\u5230\u955c\u50cf\u4e2d\u3002\u800c <code>ADD</code> \u6307\u4ee4\u8fd8\u652f\u6301\u901a\u8fc7 URL \u4ece\u8fdc\u7a0b\u670d\u52a1\u5668\u8bfb\u53d6\u8d44\u6e90\u5e76\u590d\u5236\u5230\u955c\u50cf\u4e2d\u3002</p> <p>\u4e00\u822c\u6765\u8bf4\u6ee1\u8db3\u540c\u7b49\u529f\u80fd\u7684\u60c5\u51b5\u4e0b\uff0c\u63a8\u8350\u4f7f\u7528COPY\u6307\u4ee4\u3002<code>ADD</code> \u6307\u4ee4\u66f4\u64c5\u957f\u8bfb\u53d6\u672c\u5730 tar \u6587\u4ef6\u5e76\u89e3\u538b\u7f29\u3002</p>"},{"location":"docker/dockerfile_usage/#copy_7","title":"COPY \u6307\u4ee4","text":"<p><code>COPY</code> \u6307\u4ee4\u80fd\u591f\u5c06\u6784\u5efa\u547d\u4ee4\u6240\u5728\u7684\u4e3b\u673a\u672c\u5730\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u590d\u5236\u5230\u955c\u50cf\u6587\u4ef6\u7cfb\u7edf\u3002COPY \u6307\u4ee4\u540c\u6837\u4e5f\u652f\u6301 exec \u548c shell \u4e24\u79cd\u683c\u5f0f\uff1a</p> <ul> <li> <p>exec \u683c\u5f0f\u7528\u6cd5\uff1a</p> <pre><code>COPY [\"&lt;src&gt;\",... \"&lt;dest&gt;\"]\n</code></pre> <p>\uff0c\u7279\u522b\u9002\u5408\u8def\u5f84\u4e2d\u5e26\u6709\u7a7a\u683c\u7684\u60c5\u51b5\u3002</p> </li> <li> <p>shell \u683c\u5f0f\u7528\u6cd5\uff1a<code>COPY &lt;src&gt;... &lt;dest&gt;</code></p> </li> </ul>"},{"location":"docker/dockerfile_usage/#add_7","title":"ADD \u6307\u4ee4","text":"<p><code>ADD</code> \u6307\u4ee4\u4e0d\u4ec5\u80fd\u591f\u5c06\u6784\u5efa\u547d\u4ee4\u6240\u5728\u7684\u4e3b\u673a\u672c\u5730\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u800c\u4e14\u80fd\u591f\u5c06\u8fdc\u7a0b URL \u6240\u5bf9\u5e94\u7684\u6587\u4ef6\u6216\u76ee\u5f55\uff0c\u4f5c\u4e3a\u8d44\u6e90\u590d\u5236\u5230\u955c\u50cf\u6587\u4ef6\u7cfb\u7edf\u3002\u6240\u4ee5\uff0c\u53ef\u4ee5\u8ba4\u4e3a <code>ADD</code> \u662f\u589e\u5f3a\u7248\u7684 <code>COPY</code>\uff0c\u652f\u6301\u5c06\u8fdc\u7a0b URL \u7684\u8d44\u6e90\u52a0\u5165\u5230\u955c\u50cf\u7684\u6587\u4ef6\u7cfb\u7edf\u3002\u540c\u6837\u4e5f\u652f\u6301 exec \u548c shell \u4e24\u79cd\u683c\u5f0f\u7528\u6cd5\uff1a \u00a0 * exec \u683c\u5f0f\u7528\u6cd5\uff1a</p> <pre><code>ADD [\"&lt;src&gt;\",... \"&lt;dest&gt;\"]\n</code></pre> <p>\uff0c\u7279\u522b\u9002\u5408\u8def\u5f84\u4e2d\u5e26\u6709\u7a7a\u683c\u7684\u60c5\u51b5</p> <ul> <li>shell \u683c\u5f0f\u7528\u6cd5\uff1a<code>ADD &lt;src&gt;... &lt;dest&gt;</code></li> </ul> <p>\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90\uff0c\u6bd4\u5982\uff1a</p> <pre><code>ADD http://foo.com/bar.go /tmp/main.go\n</code></pre> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u5bf9\u4e8e\u4ece\u8fdc\u7a0b URL \u83b7\u53d6\u8d44\u6e90\u7684\u60c5\u51b5\uff0c\u7531\u4e8e ADD \u6307\u4ee4\u4e0d\u652f\u6301\u8ba4\u8bc1\uff0c\u5982\u679c\u4ece\u8fdc\u7a0b\u83b7\u53d6\u8d44\u6e90\u9700\u8981\u8ba4\u8bc1\uff0c\u5219\u53ea\u80fd\u4f7f\u7528<code>RUN wget</code> \u6216 <code>RUN curl</code> \u66ff\u4ee3\u4e86\u3002</p> <p>\u6709\u80fd\u529b\u81ea\u52a8\u89e3\u538b\u6587\u4ef6\uff0c\u6bd4\u5982\uff1a</p> <pre><code>ADD /foo.tar.gz /tmp/\n</code></pre> <p>\u4e0a\u8ff0\u6307\u4ee4\u4f1a\u4f7f foo.tar.gz \u538b\u7f29\u6587\u4ef6\u89e3\u538b\u5230\u5bb9\u5668\u7684 /tmp \u76ee\u5f55\u3002</p> <p>\u4e0d\u8fc7\u4e00\u822c\u6765\u8bf4\u867d\u7136 ADD \u6307\u4ee4\u652f\u6301\u4ece\u8fdc\u7a0b\u83b7\u53d6\u8d44\u6e90\uff0c\u4f46\u662f\u5e76\u4e0d\u63a8\u8350\u4f7f\u7528\uff0c\u800c\u662f\u5efa\u8bae\u4f7f\u7528 RUN \u6307\u4ee4\u53bb\u6267\u884c wget \u6216 curl \u547d\u4ee4\u3002</p> <p>\u6bd4\u5982\u524d\u9762\u6211\u4eec\u5b9a\u5236\u7684 nginx \u955c\u50cf\uff0c\u53ef\u4ee5\u6539\u6210\u4e0b\u9762\u7684\u5f62\u5f0f\uff1a</p> <pre><code>$ echo 'Hello Docker!' &gt; index.html\n</code></pre> <p>\u7136\u540e\u4fee\u6539 Dockerfile\uff1a</p> <pre><code>FROM nginx\n# COPY\u6216\u8005ADD\u6307\u4ee4\u90fd\u53ef\u4ee5\nCOPY index.html /user/share/nginx/html/index.html\n</code></pre>"},{"location":"docker/dockerfile_usage/#_79","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p><code>COPY</code> \u6307\u4ee4\u548c <code>ADD</code>\u6307\u4ee4\u7684\u7528\u6cd5\u975e\u5e38\u76f8\u4f3c\uff0c\u5177\u4f53\u6ce8\u610f\u4e8b\u9879\u5982\u4e0b\uff1a</p> <ul> <li>\u6e90\u8def\u5f84\u53ef\u4ee5\u6709\u591a\u4e2a</li> <li>\u6e90\u8def\u5f84\u662f\u76f8\u5bf9\u4e8e\u6267\u884c build \u7684\u76f8\u5bf9\u8def\u5f84</li> <li>\u6e90\u8def\u5f84\u5982\u679c\u662f\u672c\u5730\u8def\u5f84\uff0c\u5fc5\u987b\u662f\u6784\u5efa\u4e0a\u4e0b\u6587\u4e2d\u7684\u8def\u5f84</li> <li>\u6e90\u8def\u5f84\u5982\u679c\u662f\u4e00\u4e2a\u76ee\u5f55\uff0c\u5219\u8be5\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u5185\u5bb9\u90fd\u5c06\u88ab\u52a0\u5165\u5230\u5bb9\u5668\uff0c\u4f46\u662f\u8be5\u76ee\u5f55\u672c\u8eab\u4e0d\u4f1a</li> <li>\u76ee\u6807\u8def\u5f84\u5fc5\u987b\u662f\u7edd\u5bf9\u8def\u5f84\uff0c\u6216\u76f8\u5bf9\u4e8e WORKDIR \u7684\u76f8\u5bf9\u8def\u5f84</li> <li>\u76ee\u6807\u8def\u5f84\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5219\u4f1a\u521b\u5efa\u76f8\u5e94\u7684\u5b8c\u6574\u8def\u5f84</li> <li>\u76ee\u6807\u8def\u5f84\u5982\u679c\u4e0d\u662f\u4e00\u4e2a\u6587\u4ef6\uff0c\u5219\u5fc5\u987b\u4f7f\u7528/\u7ed3\u675f</li> <li>\u8def\u5f84\u4e2d\u53ef\u4ee5\u4f7f\u7528\u901a\u914d\u7b26</li> </ul>"},{"location":"docker/dockerfile_usage/#_80","title":"\u6784\u5efa\u955c\u50cf","text":"<p>\u73b0\u5728\u8ba9\u6211\u4eec\u518d\u56de\u5230\u4e4b\u524d\u5b9a\u5236\u7684 nginx \u955c\u50cf\u7684 Dockerfile \u6765\u3002\u73b0\u5728\u6211\u4eec\u660e\u767d\u4e86\u8fd9\u4e2a Dockerfile \u7684\u5185\u5bb9\uff0c\u90a3\u4e48\u8ba9\u6211\u4eec\u6765\u6784\u5efa\u8fd9\u4e2a\u955c\u50cf\u5427\u3002\u5728 Dockerfile \u6587\u4ef6\u6240\u5728\u76ee\u5f55\u6267\u884c\uff1a</p> <pre><code>$ docker build -t nginx:v1 .\nSending build context to Docker daemon 048 kB\nStep 1 : FROM nginx\n ---&gt; e43d811ce2f4\nStep 2 : RUN echo 'Hello, Docker!' &gt; /usr/share/nginx/html/index.html\n ---&gt; Running in 9cdc27646c7b\n ---&gt; 44aa4490ce2c\nRemoving intermediate container 9cdc27646c7b\nSuccessfully built 44aa4490ce2c\n</code></pre> <p>\u4ece\u547d\u4ee4\u7684\u8f93\u51fa\u7ed3\u679c\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u6e05\u6670\u7684\u770b\u5230\u955c\u50cf\u7684\u6784\u5efa\u8fc7\u7a0b\u3002\u5728 Step 2 \u4e2d\uff0c\u5982\u540c\u6211\u4eec\u4e4b\u524d\u6240\u8bf4\u7684\u90a3\u6837\uff0cRUN \u6307\u4ee4\u542f\u52a8\u4e86\u4e00\u4e2a\u5bb9\u5668 9cdc27646c7b\uff0c\u6267\u884c\u4e86\u6240\u8981\u6c42\u7684\u547d\u4ee4\uff0c\u5e76\u6700\u540e\u63d0\u4ea4\u4e86\u8fd9\u4e00\u5c42 44aa4490ce2c\uff0c\u968f\u540e\u5220\u9664\u4e86\u6240\u7528\u5230\u7684\u8fd9\u4e2a\u5bb9\u5668 9cdc27646c7b\u3002\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u4e86 <code>docker build</code> \u547d\u4ee4\u8fdb\u884c\u955c\u50cf\u6784\u5efa\u3002\u5176\u683c\u5f0f\u4e3a\uff1a</p> <pre><code>$ docker build [\u9009\u9879] &lt;\u4e0a\u4e0b\u6587\u8def\u5f84/URL/-&gt;\n</code></pre> <p>\u5728\u8fd9\u91cc\u6211\u4eec\u901a\u8fc7 <code>-t</code> \u53c2\u6570\u6307\u5b9a\u4e86\u6700\u7ec8\u955c\u50cf\u7684\u540d\u79f0 <code>nginx:v1</code>\uff0c\u6784\u5efa\u6210\u529f\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a\u955c\u50cf\u6765\u8fd0\u884c\u5bb9\u5668\u4e86\u3002</p>"},{"location":"docker/dockerfile_usage/#_81","title":"\u6784\u5efa\u4e0a\u4e0b\u6587","text":"<p>\u5982\u679c\u6211\u4eec\u4ed4\u7ec6\u89c2\u5bdf\u7684\u8bdd\u4f1a\u770b\u5230 <code>docker build</code> \u547d\u4ee4\u6700\u540e\u6709\u4e00\u4e2a <code>.</code>\u3002<code>.</code> \u8868\u793a\u5f53\u524d\u76ee\u5f55\uff0c\u800c Dockerfile \u5c31\u5728\u5f53\u524d\u76ee\u5f55\uff0c\u56e0\u6b64\u4e0d\u5c11\u521d\u5b66\u8005\u4ee5\u4e3a\u8fd9\u4e2a\u8def\u5f84\u662f\u5728\u6307\u5b9a Dockerfile \u6240\u5728\u8def\u5f84\uff0c\u8fd9\u4e48\u7406\u89e3\u5176\u5b9e\u662f\u4e0d\u51c6\u786e\u7684\u3002\u5982\u679c\u5bf9\u5e94\u4e0a\u9762\u7684\u547d\u4ee4\u683c\u5f0f\uff0c\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0\uff0c\u8fd9\u662f\u5728\u6307\u5b9a\u4e0a\u4e0b\u6587\u8def\u5f84\u3002\u90a3\u4e48\u4ec0\u4e48\u662f\u4e0a\u4e0b\u6587\u5462\uff1f</p> <p>\u9996\u5148\u6211\u4eec\u8981\u7406\u89e3 <code>docker build</code> \u7684\u5de5\u4f5c\u539f\u7406\u3002Docker \u5728\u8fd0\u884c\u65f6\u5206\u4e3a Docker Daemon \u548c\u5ba2\u6237\u7aef\u5de5\u5177\u3002Docker \u7684\u5f15\u64ce\u63d0\u4f9b\u4e86\u4e00\u7ec4 REST API\uff0c\u88ab\u79f0\u4e3a Docker Remote API\uff0c\u800c\u5982 docker \u547d\u4ee4\u8fd9\u6837\u7684\u5ba2\u6237\u7aef\u5de5\u5177\uff0c\u5219\u662f\u901a\u8fc7\u8fd9\u7ec4 API \u4e0e Docker \u5f15\u64ce\u4ea4\u4e92\uff0c\u4ece\u800c\u5b8c\u6210\u5404\u79cd\u529f\u80fd\u3002\u56e0\u6b64\uff0c\u867d\u7136\u8868\u9762\u4e0a\u6211\u4eec\u597d\u50cf\u662f\u5728\u672c\u673a\u6267\u884c\u5404\u79cd docker \u529f\u80fd\uff0c\u4f46\u5b9e\u9645\u4e0a\uff0c\u4e00\u5207\u90fd\u662f\u4f7f\u7528\u7684\u8fdc\u7a0b\u8c03\u7528\u5f62\u5f0f\u5728\u670d\u52a1\u7aef\uff08Docker \u5f15\u64ce\uff09\u5b8c\u6210\u3002\u4e5f\u56e0\u4e3a\u8fd9\u79cd C/S \u8bbe\u8ba1\uff0c\u8ba9\u6211\u4eec\u64cd\u4f5c\u8fdc\u7a0b\u670d\u52a1\u5668\u7684 Docker \u5f15\u64ce\u53d8\u5f97\u8f7b\u800c\u6613\u4e3e\u3002</p> <p>\u5f53\u6211\u4eec\u8fdb\u884c\u955c\u50cf\u6784\u5efa\u7684\u65f6\u5019\uff0c\u5e76\u975e\u6240\u6709\u5b9a\u5236\u90fd\u4f1a\u901a\u8fc7 RUN \u6307\u4ee4\u5b8c\u6210\uff0c\u7ecf\u5e38\u4f1a\u9700\u8981\u5c06\u4e00\u4e9b\u672c\u5730\u6587\u4ef6\u590d\u5236\u8fdb\u955c\u50cf\uff0c\u6bd4\u5982\u901a\u8fc7 <code>COPY</code> \u6307\u4ee4\u3001<code>ADD</code> \u6307\u4ee4\u7b49\u3002\u800c <code>docker build</code> \u547d\u4ee4\u6784\u5efa\u955c\u50cf\uff0c\u5176\u5b9e\u5e76\u975e\u5728\u672c\u5730\u6784\u5efa\uff0c\u800c\u662f\u5728\u670d\u52a1\u7aef\uff0c\u4e5f\u5c31\u662f Docker \u5f15\u64ce\u4e2d\u6784\u5efa\u7684\u3002\u90a3\u4e48\u5728\u8fd9\u79cd<code>\u5ba2\u6237\u7aef/\u670d\u52a1\u7aef</code>\u7684\u67b6\u6784\u4e2d\uff0c\u5982\u4f55\u624d\u80fd\u8ba9\u670d\u52a1\u7aef\u83b7\u5f97\u672c\u5730\u6587\u4ef6\u5462\uff1f</p> <p>\u8fd9\u5c31\u5f15\u5165\u4e86<code>\u4e0a\u4e0b\u6587</code>\u7684\u6982\u5ff5\u3002\u5f53\u6784\u5efa\u7684\u65f6\u5019\uff0c\u7528\u6237\u4f1a\u6307\u5b9a\u6784\u5efa\u955c\u50cf\u4e0a\u4e0b\u6587\u7684\u8def\u5f84\uff0cdocker build \u547d\u4ee4\u5f97\u77e5\u8fd9\u4e2a\u8def\u5f84\u540e\uff0c\u4f1a\u5c06\u8def\u5f84\u4e0b\u7684\u6240\u6709\u5185\u5bb9\u6253\u5305\uff0c\u7136\u540e\u4e0a\u4f20\u7ed9 Docker \u5f15\u64ce\u3002\u8fd9\u6837 Docker \u5f15\u64ce\u6536\u5230\u8fd9\u4e2a\u4e0a\u4e0b\u6587\u5305\u540e\uff0c\u5c55\u5f00\u5c31\u4f1a\u83b7\u5f97\u6784\u5efa\u955c\u50cf\u6240\u9700\u7684\u4e00\u5207\u6587\u4ef6\u3002\u5982\u679c\u5728 Dockerfile \u4e2d\u8fd9\u4e48\u5199\uff1a</p> <pre><code>COPY ./package.json /app/\n</code></pre> <p>\u8fd9\u5e76\u4e0d\u662f\u8981\u590d\u5236\u6267\u884c docker build \u547d\u4ee4\u6240\u5728\u7684\u76ee\u5f55\u4e0b\u7684 package.json\uff0c\u4e5f\u4e0d\u662f\u590d\u5236 Dockerfile \u6240\u5728\u76ee\u5f55\u4e0b\u7684 package.json\uff0c\u800c\u662f\u590d\u5236 <code>\u4e0a\u4e0b\u6587\uff08context\uff09</code> \u76ee\u5f55\u4e0b\u7684 package.json\u3002</p> <p>\u56e0\u6b64\uff0c<code>COPY</code> \u8fd9\u7c7b\u6307\u4ee4\u4e2d\u7684\u6e90\u6587\u4ef6\u7684\u8def\u5f84\u90fd\u662f<code>\u76f8\u5bf9\u8def\u5f84</code>\u3002\u8fd9\u4e5f\u662f\u521d\u5b66\u8005\u7ecf\u5e38\u4f1a\u95ee\u7684\u4e3a\u4ec0\u4e48 </p> <pre><code>COPY ../package.json /app\n</code></pre> <p>\u6216\u8005 <code>COPY /opt/xxxx /app</code> \u65e0\u6cd5\u5de5\u4f5c\u7684\u539f\u56e0\uff0c\u56e0\u4e3a\u8fd9\u4e9b\u8def\u5f84\u5df2\u7ecf\u8d85\u51fa\u4e86\u4e0a\u4e0b\u6587\u7684\u8303\u56f4\uff0cDocker \u5f15\u64ce\u65e0\u6cd5\u83b7\u5f97\u8fd9\u4e9b\u4f4d\u7f6e\u7684\u6587\u4ef6\u3002\u5982\u679c\u771f\u7684\u9700\u8981\u90a3\u4e9b\u6587\u4ef6\uff0c\u5e94\u8be5\u5c06\u5b83\u4eec\u590d\u5236\u5230\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\u53bb\u3002</p> <p>\u73b0\u5728\u5c31\u53ef\u4ee5\u7406\u89e3\u521a\u624d\u7684\u547d\u4ee4</p> <pre><code>docker build -t nginx:v1 .\n</code></pre> <p>\u4e2d\u7684\u8fd9\u4e2a<code>.</code>\uff0c\u5b9e\u9645\u4e0a\u662f\u5728\u6307\u5b9a\u4e0a\u4e0b\u6587\u7684\u76ee\u5f55\uff0cdocker build \u547d\u4ee4\u4f1a\u5c06\u8be5\u76ee\u5f55\u4e0b\u7684\u5185\u5bb9\u6253\u5305\u4ea4\u7ed9 Docker \u5f15\u64ce\u4ee5\u5e2e\u52a9\u6784\u5efa\u955c\u50cf\u3002</p> <p>\u5982\u679c\u89c2\u5bdf docker build \u8f93\u51fa\uff0c\u6211\u4eec\u5176\u5b9e\u5df2\u7ecf\u770b\u5230\u4e86\u8fd9\u4e2a\u53d1\u9001\u4e0a\u4e0b\u6587\u7684\u8fc7\u7a0b\uff1a</p> <pre><code>$ docker build -t nginx:v1 .\nSending build context to Docker daemon 048 kB\n...\n</code></pre> <p>\u7406\u89e3\u6784\u5efa\u4e0a\u4e0b\u6587\u5bf9\u4e8e\u955c\u50cf\u6784\u5efa\u662f\u5f88\u91cd\u8981\u7684\uff0c\u53ef\u4ee5\u907f\u514d\u72af\u4e00\u4e9b\u4e0d\u5e94\u8be5\u7684\u9519\u8bef\u3002\u6bd4\u5982\u6709\u4e9b\u521d\u5b66\u8005\u5728\u53d1\u73b0 COPY /opt/xxxx /app \u4e0d\u5de5\u4f5c\u540e\uff0c\u4e8e\u662f\u5e72\u8106\u5c06 Dockerfile \u653e\u5230\u4e86\u786c\u76d8\u6839\u76ee\u5f55\u53bb\u6784\u5efa\uff0c\u7ed3\u679c\u53d1\u73b0 docker build \u6267\u884c\u65f6\u53d1\u9001\u4e00\u4e2a\u51e0\u5341 GB \u7684\u4e1c\u897f\uff0c\u6781\u4e3a\u7f13\u6162\u800c\u4e14\u5f88\u5bb9\u6613\u6784\u5efa\u5931\u8d25\u3002\u90a3\u662f\u56e0\u4e3a\u8fd9\u79cd\u505a\u6cd5\u662f\u5728\u8ba9 docker build \u6253\u5305\u6574\u4e2a\u786c\u76d8\uff0c\u8fd9\u663e\u7136\u662f\u4f7f\u7528\u9519\u8bef\u3002</p> <p>\u4e00\u822c\u6765\u8bf4\uff0c\u5e94\u8be5\u4f1a\u5c06 Dockerfile \u7f6e\u4e8e\u4e00\u4e2a\u7a7a\u76ee\u5f55\u4e0b\uff0c\u6216\u8005\u9879\u76ee\u6839\u76ee\u5f55\u4e0b\u3002\u5982\u679c\u8be5\u76ee\u5f55\u4e0b\u6ca1\u6709\u6240\u9700\u6587\u4ef6\uff0c\u90a3\u4e48\u5e94\u8be5\u628a\u6240\u9700\u6587\u4ef6\u590d\u5236\u4e00\u4efd\u8fc7\u6765\u3002\u5982\u679c\u76ee\u5f55\u4e0b\u6709\u4e9b\u4e1c\u897f\u786e\u5b9e\u4e0d\u5e0c\u671b\u6784\u5efa\u65f6\u4f20\u7ed9 Docker \u5f15\u64ce\uff0c\u90a3\u4e48\u53ef\u4ee5\u7528 .gitignore \u4e00\u6837\u7684\u8bed\u6cd5\u5199\u4e00\u4e2a <code>.dockerignore</code>\uff0c\u8be5\u6587\u4ef6\u662f\u7528\u4e8e\u5254\u9664\u4e0d\u9700\u8981\u4f5c\u4e3a\u4e0a\u4e0b\u6587\u4f20\u9012\u7ed9 Docker \u5f15\u64ce\u7684\u3002</p> <p>\u90a3\u4e48\u4e3a\u4ec0\u4e48\u4f1a\u6709\u4eba\u8bef\u4ee5\u4e3a <code>.</code> \u662f\u6307\u5b9a Dockerfile \u6240\u5728\u76ee\u5f55\u5462\uff1f\u8fd9\u662f\u56e0\u4e3a\u5728\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u4e0d\u989d\u5916\u6307\u5b9a Dockerfile \u7684\u8bdd\uff0c\u4f1a\u5c06\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e0b\u7684\u540d\u4e3a Dockerfile \u7684\u6587\u4ef6\u4f5c\u4e3a Dockerfile\u3002\u8fd9\u53ea\u662f\u9ed8\u8ba4\u884c\u4e3a\uff0c\u5b9e\u9645\u4e0a Dockerfile \u7684\u6587\u4ef6\u540d\u5e76\u4e0d\u8981\u6c42\u5fc5\u987b\u4e3a Dockerfile\uff0c\u800c\u4e14\u5e76\u4e0d\u8981\u6c42\u5fc5\u987b\u4f4d\u4e8e\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\uff0c\u6bd4\u5982\u53ef\u4ee5\u7528<code>-f ../Dockerfile.Dev</code>\u53c2\u6570\u6307\u5b9a\u67d0\u4e2a\u6587\u4ef6\u4f5c\u4e3a Dockerfile\u3002</p> <p>\u5f53\u7136\uff0c\u4e00\u822c\u5927\u5bb6\u4e60\u60ef\u6027\u7684\u4f1a\u4f7f\u7528\u9ed8\u8ba4\u7684\u6587\u4ef6\u540d Dockerfile\uff0c\u4ee5\u53ca\u4f1a\u5c06\u5176\u7f6e\u4e8e\u955c\u50cf\u6784\u5efa\u4e0a\u4e0b\u6587\u76ee\u5f55\u4e2d\u3002</p>"},{"location":"docker/dockerfile_usage/#_82","title":"\u63a8\u9001\u955c\u50cf","text":"<p>\u4e0a\u9762\u6211\u4eec\u8bb2\u5230\u4e86 Dockerfile \u7684\u57fa\u672c\u5199\u6cd5\u4ee5\u53ca\u6784\u5efa\u955c\u50cf\u7684\u65f6\u5019\u4e00\u4e9b\u6ce8\u610f\u4e8b\u9879\uff0c\u90a3\u4e48\u955c\u50cf\u6784\u5efa\u5b8c\u6210\u540e\uff0c\u5982\u4f55\u628a\u6211\u4eec\u7684\u955c\u50cf\u7ed9\u5230\u522b\u4eba\u4f7f\u7528\u5462\uff1f\u7b2c\u4e00\u79cd\u65b9\u6cd5\u5c31\u662f\u5229\u7528 Docker \u5b98\u65b9\u63d0\u4f9b\u7684\u516c\u5171\u7684 Docker Hub \u4ed3\u5e93\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u955c\u50cf\u63a8\u9001\u4e0a\u53bb\uff0c\u7136\u540e\u522b\u4eba\u5c31\u53ef\u4ee5\u76f4\u63a5\u62c9\u53d6\u955c\u50cf\u3002</p>"},{"location":"docker/dockerfile_usage/#_83","title":"\u6ce8\u518c","text":"<p>\u9996\u5148\u9700\u8981 https://cloud.docker.com \u514d\u8d39\u6ce8\u518c\u4e00\u4e2a Docker \u8d26\u53f7\u3002</p>"},{"location":"docker/dockerfile_usage/#_84","title":"\u767b\u5f55","text":"<p>\u7136\u540e\u901a\u8fc7\u6267\u884c<code>docker login</code>\u547d\u4ee4\u4ea4\u4e92\u5f0f\u7684\u8f93\u5165\u7528\u6237\u540d\u53ca\u5bc6\u7801\u6765\u5b8c\u6210\u5728\u547d\u4ee4\u884c\u754c\u9762\u767b\u5f55 Docker Hub\u3002</p> <pre><code>$ docker login\nLogin with your Docker ID to push and pull images from Docker Hub. If you don't have a Docker ID, head over to https://hub.docker.com to create one.\nUsername: cnych\nPassword:\nWARNING! Your password will be stored unencrypted in /root/.docker/config.json.\nConfigure a credential helper to remove this warning. See\nhttps://docs.docker.com/engine/reference/commandline/login/#credentials-store\n\nLogin Succeeded\n</code></pre>"},{"location":"docker/dockerfile_usage/#_85","title":"\u6ce8\u9500","text":"<p>\u4f60\u53ef\u4ee5\u901a\u8fc7<code>docker logout</code>\u9000\u51fa\u767b\u5f55\u3002</p>"},{"location":"docker/dockerfile_usage/#_86","title":"\u63a8\u9001\u955c\u50cf","text":"<p>\u7528\u6237\u5728\u767b\u5f55\u540e\u53ef\u4ee5\u901a\u8fc7<code>docker push</code>\u547d\u4ee4\u6765\u5c06\u81ea\u5df1\u7684\u955c\u50cf\u63a8\u9001\u5230 Docker Hub\u3002\u4ee5\u4e0b\u547d\u4ee4\u4e2d\u7684 username \u8bf7\u66ff\u6362\u4e3a\u4f60\u7684 Docker \u8d26\u53f7\u7528\u6237\u540d\u3002</p> <pre><code>$ docker tag ubuntu:10 username/ubuntu:10\n$ docker image ls\n\nREPOSITORY                                               TAG                    IMAGE ID            CREATED             SIZE\nubuntu                                                   10                  275d79972a86        6 days ago          6MB\nusername/ubuntu                                          10                  275d79972a86        6 days ago          6MB\n$ docker push username/ubuntu:10\n</code></pre>"},{"location":"docker/dockerfile_usage/#_87","title":"\u79c1\u6709\u4ed3\u5e93","text":"<p>\u6709\u65f6\u5019\u6211\u4eec\u53ef\u80fd\u5e0c\u671b\u6211\u4eec\u7684\u955c\u50cf\u53ea\u5728\u5c40\u57df\u7f51\u8303\u56f4\u5185\u4f7f\u7528\uff0c\u4e0d\u5e0c\u671b\u63a8\u9001\u5230 Docker Hub \u8fd9\u6837\u7684\u516c\u5171\u4ed3\u5e93\uff0c\u90a3\u4e48\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u672c\u5730\u4ed3\u5e93\u4f9b\u79c1\u4eba\u4f7f\u7528\u3002</p> <p><code>docker-registry</code> \u5c31\u662f\u662f\u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e2a\u79c1\u6709\u4ed3\u5e93\u5de5\u5177\uff0c\u53ef\u4ee5\u7528\u4e8e\u5b58\u50a8\u79c1\u6709\u7684\u955c\u50cf\u4ed3\u5e93\u3002\u540c\u6837\u7684\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u83b7\u53d6\u5b98\u65b9 registry \u955c\u50cf\u6765\u76f4\u63a5\u8fd0\u884c\uff1a</p> <pre><code>$ docker run -d -p 5000:5000 --name registry registry:2\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u4f1a\u4f7f\u7528\u5b98\u65b9\u7684 registry \u955c\u50cf\u6765\u542f\u52a8\u79c1\u6709\u4ed3\u5e93\u5bb9\u5668\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4ed3\u5e93\u4f1a\u88ab\u521b\u5efa\u5728\u5bb9\u5668\u7684<code>/var/lib/registry</code>\u76ee\u5f55\u4e0b\u3002\u4f60\u53ef\u4ee5\u901a\u8fc7 <code>-v</code> \u53c2\u6570\u6765\u5c06\u955c\u50cf\u6587\u4ef6\u5b58\u653e\u5728\u672c\u5730\u7684\u6307\u5b9a\u8def\u5f84\u3002\u4f8b\u5982\u4e0b\u9762\u7684\u4f8b\u5b50\u5c06\u4e0a\u4f20\u7684\u955c\u50cf\u653e\u5230\u672c\u5730\u7684 <code>/opt/data/registry</code> \u76ee\u5f55:</p> <pre><code>$ docker run -d \\\\\n    -p 5000:5000 \\\\\n    -v /opt/data/registry:/var/lib/registry \\\\\n    registry:2\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u8fd0\u884c\u4e86\u4e00\u4e2a\u6570\u636e\u6301\u4e45\u5316\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u3002</p> <p>\u521b\u5efa\u597d\u79c1\u6709\u4ed3\u5e93\u4e4b\u540e\uff0c\u7136\u540e\u53ef\u4ee5\u4f7f\u7528<code>docker tag</code>\u6765\u6807\u8bb0\u4e00\u4e2a\u955c\u50cf\uff0c\u7136\u540e\u63a8\u9001\u5b83\u5230\u4ed3\u5e93\u3002\u6bd4\u5982\u79c1\u6709\u4ed3\u5e93\u5730\u5740\u4e3a<code>127.0.0.1:5000</code>\u3002\u5148\u5728\u672c\u673a\u67e5\u770b\u5df2\u6709\u7684\u955c\u50cf\u3002</p> <pre><code>$ docker images\nREPOSITORY                        TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nubuntu                            latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u4f7f\u7528<code>docker tag</code>\u5c06 ubuntu:latest \u8fd9\u4e2a\u955c\u50cf\u6807\u8bb0\u4e3a </p> <pre><code>11:5000/ubuntu:latest\n</code></pre> <p>:</p> <pre><code>$ docker tag ubuntu:latest 11:5000/ubuntu:latest\n$ docker images\nREPOSITORY                        TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\nubuntu                            latest              ba5877dc9bec        6 weeks ago         17 MB\n11:5000/ubuntu:latest      latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u7136\u540e\u5c31\u53ef\u4ee5\u4f7f\u7528<code>docker push</code>\u4e0a\u4f20\u6807\u8bb0\u7684\u955c\u50cf:</p> <pre><code>$ docker push 11:5000/ubuntu:latest\nThe push refers to repository [11:5000/ubuntu]\n373a30c24545: Pushed\na9148f5200b0: Pushed\ncdd3de0940ab: Pushedfc56279bbb33: Pushed\nb38367233d37: Pushed\n2aebd096e0e2: Pushed\nlatest: digest: sha256:fe4277621f10b5026266932ddf760f5a756d2facd505a94d2da12f4f52f71f5a size: 1568\n</code></pre> <p>\u6b64\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528 registry \u4ed3\u5e93\u63d0\u4f9b\u7684 API \u6765\u67e5\u770b\u4ed3\u5e93\u4e2d\u7684\u955c\u50cf\uff1a</p> <pre><code>$ curl 11:5000/v2/_catalog\n{\"repositories\":[\"ubuntu\"]}\n</code></pre> <p>\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230 {\"repositories\":[\"ubuntu\"]}\uff0c\u8868\u660e\u955c\u50cf\u5df2\u7ecf\u88ab\u6210\u529f\u4e0a\u4f20\u4e86\u3002</p> <p>\u5148\u5220\u9664\u5df2\u6709\u955c\u50cf\uff0c\u518d\u5c1d\u8bd5\u4ece\u79c1\u6709\u4ed3\u5e93\u4e2d\u4e0b\u8f7d\u8fd9\u4e2a\u955c\u50cf\u3002</p> <pre><code>$ docker image rm 11:5000/ubuntu:latest\n$ docker pull 11:5000/ubuntu:latest\nPulling repository 11:5000/ubuntu:latest\nba5877dc9bec: Download complete\n511136ea3c5a: Download complete\n9bad880da3d2: Download complete\n25f11f5fb0cb: Download complete\nebc34468f71d: Download complete\n2318d26665ef: Download complete\n$ docker image ls\nREPOSITORY                         TAG                 IMAGE ID            CREATED             VIRTUAL SIZE\n11:5000/ubuntu:latest       latest              ba5877dc9bec        6 weeks ago         17 MB\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u628a\u955c\u50cf\u4e0a\u4f20\u5230\u4e86\u79c1\u6709\u4ed3\u5e93\u4e2d\u7684\u5b8c\u6574\u8fc7\u7a0b\u3002</p>"},{"location":"docker/dockerfile_usage/#_88","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p>\u5982\u679c\u4f60\u4e0d\u60f3\u4f7f\u7528 <code>127.0.0.1:5000</code> \u4f5c\u4e3a\u4ed3\u5e93\u5730\u5740\uff0c\u6bd4\u5982\u60f3\u8ba9\u672c\u7f51\u6bb5\u7684\u5176\u4ed6\u4e3b\u673a\u4e5f\u80fd\u628a\u955c\u50cf\u63a8\u9001\u5230\u79c1\u6709\u4ed3\u5e93\u3002\u4f60\u5c31\u5f97\u628a\u4f8b\u5982 <code>192.168.199.100:5000</code> \u8fd9\u6837\u7684\u5185\u7f51\u5730\u5740\u4f5c\u4e3a\u79c1\u6709\u4ed3\u5e93\u5730\u5740\uff0c\u8fd9\u65f6\u4f60\u4f1a\u53d1\u73b0\u65e0\u6cd5\u6210\u529f\u63a8\u9001\u955c\u50cf\u3002</p> <p>\u8fd9\u662f\u56e0\u4e3a Docker \u9ed8\u8ba4\u4e0d\u5141\u8bb8\u975e HTTPS \u65b9\u5f0f\u63a8\u9001\u955c\u50cf\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Docker \u7684\u914d\u7f6e\u9009\u9879\u6765\u53d6\u6d88\u8fd9\u4e2a\u9650\u5236\uff0c\u6211\u4eec\u8fd9\u91cc\u662f CentOS 7 \u7cfb\u7edf\uff0c\u540c\u6837\u8fd8\u662f\u7f16\u8f91\u6587\u4ef6</p> <pre><code>/etc/docker/daemon.json\n</code></pre> <p>\uff0c\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>{\n  \"registry-mirror\": [\n    \"https://registry.docker-cn.com\"\n  ],\n  \"insecure-registries\": [\n    \"111100:5000\"\n  ]\n}\n</code></pre> <p>\u5176\u4e2d\u7684<code>insecure-registries</code>\u5c31\u662f\u6211\u4eec\u6dfb\u52a0\u7684\u5185\u5bb9\uff0c\u7136\u540e\u91cd\u542f Docker \u4e4b\u540e\u5c31\u53ef\u4ee5\u5728\u5c40\u57df\u7f51\u5185\u4f7f\u7528\u6211\u4eec\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u4e86\u3002</p> <p>\u9ed8\u8ba4\u7684\u79c1\u6709\u955c\u50cf\u4ed3\u5e93\u53ef\u4ee5\u6ee1\u8db3\u6211\u4eec\u7684\u5f88\u591a\u9700\u6c42\uff0c\u4f46\u662f\u5f80\u5f80\u5728\u4f01\u4e1a\u4e2d\u4f7f\u7528\u7684\u8bdd\u8fd8\u6709\u5f88\u5b89\u5168\u6027\u65b9\u9762\u7684\u529f\u80fd\u7684\u7f3a\u5931\uff0c\u6bd4\u5982\u6743\u9650\u7ba1\u7406\u4e4b\u7c7b\u7684\uff0c\u8fd9\u5bf9\u4e8e\u4f01\u4e1a\u6765\u8bf4\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u4e0d\u8fc7 registry \u5bf9\u4e8e\u6743\u9650\u7ba1\u7406\u8fd9\u4e00\u5757\u505a\u4e86\u4e00\u4e2a\u5bf9\u5916\u66b4\u9732\u7684\u63a5\u53e3\uff0c\u53ea\u8981\u6211\u4eec\u5b9e\u73b0\u4ed6\u66b4\u9732\u7684\u5b89\u5168\u63a5\u53e3\u5c31\u53ef\u4ee5\u6765\u5b9e\u73b0\u6743\u9650\u7ba1\u7406\u76f8\u5173\u7684\u63a5\u53e3\uff0c\u5176\u4e2d\u6ce8\u660e\u7684\u5f00\u6e90\u955c\u50cf\u7ba1\u7406\u8f6f\u4ef6 Harbor \u5c31\u662f\u8fd9\u7c7b\u5e94\u7528\u7684\u4f7c\u4f7c\u8005\uff0c\u6211\u4eec\u8fd8\u5728\u540e\u9762\u7684\u8bfe\u7a0b\u4e2d\u548c\u5927\u5bb6\u5b66\u4e60 Harbor \u7684\u4e00\u4e2a\u4f7f\u7528\u3002</p>"},{"location":"docker/install/","title":"\u5b89\u88c5","text":""},{"location":"docker/install/#_1","title":"\u5b89\u88c5","text":"<p>\u8981\u5b89\u88c5 Docker CE\uff08\u793e\u533a\uff09\u7248\u672c\uff0c\u63a8\u8350\u4f7f\u7528 CentOS 7\uff0c\u4f7f\u7528 <code>overlay2</code> \u5b58\u50a8\u9a71\u52a8\u7a0b\u5e8f\u3002</p>"},{"location":"docker/install/#_2","title":"\u5378\u8f7d\u65e7\u7248\u672c","text":"<p>\u65e7\u7248\u672c\u7684 Docker \u53eb <code>docker</code> \u6216\u8005 <code>docker-engine</code>\uff0c\u73b0\u5728\u7684\u7248\u672c\u88ab\u79f0\u4e3a<code>docker-ce</code>\uff0c\u5982\u679c\u4e4b\u524d\u5b89\u88c5\u8fc7\uff0c\u5219\u5148\u5378\u8f7d\u6389\u4e4b\u524d\u7684\u7248\u672c\uff1a</p> <pre><code>$ sudo yum remove docker \\\\\n                  docker-client \\\\\n                  docker-client-latest \\\\\n                  docker-common \\\\\n                  docker-latest \\\\\n                  docker-latest-logrotate \\\\\n                  docker-logrotate \\\\\n                  docker-engine\n</code></pre>"},{"location":"docker/install/#docker-ce","title":"\u5b89\u88c5 Docker-CE","text":"<p>\u8981\u5b89\u88c5 Docker \u6709\u591a\u79cd\u65b9\u6cd5\uff0c\u5927\u591a\u6570\u7528\u6237\u4f1a\u8bbe\u7f6e Docker \u7684\u5b58\u50a8\u4ed3\u5e93\u6765\u8fdb\u884c\u5b89\u88c5\uff0c\u8fd9\u79cd\u65b9\u5f0f\u53ef\u4ee5\u7b80\u5316\u6211\u4eec\u7684\u5b89\u88c5\u548c\u5347\u7ea7\uff0c\u5f53\u7136\u4e5f\u63a8\u8350\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u3002</p> <p>\u4f46\u662f\u5982\u679c\u4f60\u7684\u670d\u52a1\u5668\u65e0\u6cd5\u8bbf\u95ee\u4e92\u8054\u7f51\u5219\u53ef\u4ee5\u4f7f\u7528\u624b\u52a8\u4e0b\u8f7d RPM \u5b89\u88c5\u5305\u8fdb\u884c\u5b89\u88c5\uff0c\u5982\u679c\u4f60\u8981\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u5b89\u88c5\uff0c\u53ef\u4ee5\u5728\u9875\u9762 https://download.docker.com/linux/centos/7/x86_64/stable/Packages/ \u4e0b\u8f7d\u81ea\u5df1\u60f3\u8981\u5b89\u88c5\u7684 <code>.rpm</code> \u6587\u4ef6\u7136\u540e\u76f4\u63a5\u5b89\u88c5\u5373\u53ef\u3002</p> <p>\u6211\u4eec\u8fd9\u91cc\u901a\u8fc7\u5728\u7ebf\u65b9\u5f0f\u8fdb\u884c\u5b89\u88c5\uff0c\u9996\u5148\u5b89\u88c5\u4ed3\u5e93\uff0c\u5148\u5b89\u88c5\u4e00\u4e9b\u4f9d\u8d56\u5305\uff0c\u5176\u4e2d<code>yum-utils</code>\u63d0\u4f9b\u4e86<code>yum-config-manager</code>\u7684\u4e00\u4e9b\u5b9e\u7528\u7684\u529f\u80fd\uff1a</p> <pre><code>$ sudo yum install -y yum-utils\n</code></pre> <p>\u7136\u540e\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6dfb\u52a0 <code>stable</code> \u7248\u672c\u7684 docker \u4ed3\u5e93\uff1a</p> <pre><code>$ sudo yum-config-manager \\\\\n    --add-repo \\\\\n    https://download.docker.com/linux/centos/docker-ce.repo\n</code></pre> <p>\u6dfb\u52a0\u5b8c\u6210\u540e\u5c31\u53ef\u4ee5\u5b89\u88c5\u4e86\uff0c\u5982\u679c\u8981\u5b89\u88c5\u6700\u65b0\u7248\u672c\uff0c\u76f4\u63a5\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u5373\u53ef\uff1a</p> <pre><code>$ yum install docker-ce docker-ce-cli containerd.io\n</code></pre> <p>\u5982\u679c\u8981\u5b89\u88c5\u6307\u5b9a\u7684\u7248\u672c\uff0c\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u6765\u83b7\u53d6\u53ef\u5b89\u88c5\u7684\u7248\u672c\uff1a</p> <pre><code>$ yum list docker-ce --showduplicates | sort -r\n * updates: mirrors.tuna.tsinghua.edu.cn\nLoading mirror speeds from cached hostfile\nLoaded plugins: fastestmirror, langpacks\n * extras: mirrors.huaweicloud.com\ndocker-ce.x86_64            3:4-el7                     docker-ce-stable\n......\ndocker-ce.x86_64            3:9-el7                     docker-ce-stable\ndocker-ce.x86_64            3:8-el7                     docker-ce-stable\ndocker-ce.x86_64            3:7-el7                     docker-ce-stable\ndocker-ce.x86_64            3:6-el7                     docker-ce-stable\n......\ndocker-ce.x86_64            ce-el7                    docker-ce-stable\n</code></pre> <p>\u8be5\u8f6f\u4ef6\u5305\u540d\u79f0\u662f\u8f6f\u4ef6\u5305\u540d\u79f0\uff08docker-ce\uff09\u52a0\u4e0a\u7248\u672c\u5b57\u7b26\u4e32\uff08\u7b2c\u4e8c\u5217\uff09\uff0c\u4ece\u7b2c\u4e00\u4e2a\u5192\u53f7\uff08:\uff09\u5f00\u59cb\uff0c\u76f4\u81f3\u7b2c\u4e00\u4e2a\u8fde\u5b57\u7b26\uff0c\u5e76\u7528\u8fde\u5b57\u7b26\uff08-\uff09\u5206\u9694 \uff09\u3002 \u6bd4\u5982\u8fd9\u91cc\u6211\u4eec\u6765\u5b89\u88c5 docker-ce-18.09.9 \u7248\u672c\uff1a</p> <pre><code>$ sudo yum install docker-ce-9 docker-ce-cli-9 containerd.io -y\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\uff0c\u4f46\u662f\u8fd8\u6ca1\u6709\u542f\u52a8\uff0c\u7531\u4e8e\u6211\u8fd9\u91cc\u7684\u78c1\u76d8\u7a7a\u95f4\u4e0d\u5927\uff0c\u6240\u4ee5\u9700\u8981\u66f4\u6539\u4e0b Docker \u7684\u6839\u76ee\u5f55\uff0c\u5c06\u9ed8\u8ba4\u7684 <code>/var/lib/docker</code> \u66f4\u6539\u4e3a <code>/data/docker</code> \u76ee\u5f55\uff0c\u6dfb\u52a0\u5982\u4e0b\u914d\u7f6e\u6587\u4ef6\uff1a</p> <pre><code>$ mkdir -p /etc/docker\n$ vi /etc/docker/daemon.json\n{\n  \"registry-mirrors\" : [\n    \"https://ot2k4dmirror.aliyuncs.com/\"\n  ],\n  \"graph\": \"/data/docker\"\n}\n</code></pre> <p>\u955c\u50cf\u52a0\u901f\u5668</p> <p>\u4f7f\u7528\u52a0\u901f\u5668\u53ef\u4ee5\u63d0\u5347\u83b7\u53d6 Docker \u5b98\u65b9\u955c\u50cf\u7684\u901f\u5ea6\uff0c\u5efa\u8bae\u6ce8\u518c\u963f\u91cc\u4e91\u5e10\u53f7\uff0c\u4f7f\u7528\u963f\u91cc\u4e91\u63d0\u4f9b\u7684\u955c\u50cf\u52a0\u901f\u670d\u52a1\uff0c\u5730\u5740\uff1ahttps://cr.console.aliyun.com/cn-beijing/instances/mirrors\u3002</p> <p>\u7136\u540e\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u542f\u52a8 docker\uff1a</p> <pre><code># \u8bbe\u7f6e\u4e3a\u5f00\u673a\u542f\u52a8\n$ systemctl enable docker  \n$ systemctl daemon-reload\n# \u542f\u52a8 docker\n$ systemctl start docker\n</code></pre> <p>\u542f\u52a8\u6210\u529f\u540e\uff0c\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u67e5\u770b Docker \u76f8\u5173\u4fe1\u606f\uff1a</p> <pre><code>$ docker info\ndocker info\nContainers: 0\n Running: 0\n Paused: 0\n Stopped: 0\nImages: 0\nServer Version: 9\nStorage Driver: overlay2\n Backing Filesystem: extfs\n Supports d_type: true\n Native Overlay Diff: false\nLogging Driver: json-file\nCgroup Driver: cgroupfs\nPlugins:\n Volume: local\n Network: bridge host macvlan null overlay\n Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog\nSwarm: inactive\nRuntimes: runc\nDefault Runtime: runc\nInit Binary: docker-init\ncontainerd version: b34a5c8af56e510852c35414db4c1f4fa6172339\nrunc version: 3e425f80a8c931f88e6d94a8c831b9d5aa481657\ninit version: fec3683\nSecurity Options:\n seccomp\n  Profile: default\nKernel Version: 0-3elx86_64\nOperating System: CentOS Linux 7 (Core)\nOSType: linux\nArchitecture: x86_64\nCPUs: 4\nTotal Memory: 64GiB\nName: pnhmltdr\nID: VIBG:JCTE:KBVO:ETXD:OZH4:SXCH:MA7Y:YFFB:KQEX:OLAM:I25P:F2TM\nDocker Root Dir: /data/docker\nDebug Mode (client): false\nDebug Mode (server): false\nRegistry: https://index.docker.io/v1/\nLabels:\nExperimental: false\nInsecure Registries:\n 10/8\nRegistry Mirrors:\n https://ot2k4dmirror.aliyuncs.com/\nLive Restore Enabled: false\nProduct License: Community Engine\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5b89\u88c5\u7684\u7248\u672c\u662f 18.09.9\uff0c\u9ed8\u8ba4\u7684\u5b58\u50a8\u9a71\u52a8\u7a0b\u5e8f\u662f <code>overlay2</code>\uff0c\u800c\u4e14 <code>Root Dir</code> \u4e5f\u5df2\u7ecf\u662f\u6211\u4eec\u66f4\u6539\u540e\u7684\u76ee\u5f55\u4e86\u3002</p>"},{"location":"docker/install/#_3","title":"\u6d4b\u8bd5","text":"<p>Docker \u542f\u52a8\u6210\u529f\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u8fd0\u884c\u4e00\u4e2a\u6d4b\u8bd5\u5bb9\u5668\uff1a</p> <pre><code>$ docker run hello-world\nUnable to find image 'hello-world:latest' locally\nlatest: Pulling from library/hello-world\n1b930d010525: Pull complete\nDigest: sha256:c3b4ada4687bbaa170745b3e4dd8ac3f194ca95b2d0518b417fb47e5879d9b5f\nStatus: Downloaded newer image for hello-world:latest\n\nHello from Docker!\nThis message shows that your installation appears to be working correctly.\n\nTo generate this message, Docker took the following steps:\n  The Docker client contacted the Docker daemon.\n  The Docker daemon pulled the \"hello-world\" image from the Docker Hub.\n    (amd64)\n  The Docker daemon created a new container from that image which runs the\n    executable that produces the output you are currently reading.\n  The Docker daemon streamed that output to the Docker client, which sent it\n    to your terminal.\n\nTo try something more ambitious, you can run an Ubuntu container with:\n $ docker run -it ubuntu bash\n\nShare images, automate workflows, and more with a free Docker ID:\n https://hub.docker.com/\n\nFor more examples and ideas, visit:\n https://docs.docker.com/get-started/\n</code></pre> <p>\u770b\u5230\u5982\u4e0a\u7684\u4e00\u4e9b\u4fe1\u606f\u6253\u5370\u51fa\u6765\u8bc1\u660e\u6211\u4eec\u7684 Docker \u5c31\u5df2\u7ecf\u5b89\u88c5\u6210\u529f\u4e86\u3002</p>"},{"location":"docker/overview/","title":"\u7b80\u4ecb","text":""},{"location":"docker/overview/#_1","title":"\u7b80\u4ecb","text":"<p>\u4f60\u9700\u8981\u4e86\u89e3\u7684 Docker</p> <p>\u5728\u4e86\u89e3\u5b66\u4e60 Docker \u4e4b\u524d\u6211\u4eec\u5c31\u975e\u5e38\u6709\u5fc5\u8981\u4ecb\u7ecd\u4e0b Docker \u7684\u524d\u751f LXC\uff08Linux Container\uff09\u3002</p> <p></p>"},{"location":"docker/overview/#lxc","title":"LXC \u4ecb\u7ecd","text":"<p>LXC \u53ef\u4ee5\u63d0\u4f9b\u8f7b\u91cf\u7ea7\u7684\u865a\u62df\u5316\uff0c\u7528\u6765\u9694\u79bb\u8fdb\u7a0b\u548c\u8d44\u6e90\uff0c\u548c\u6211\u4eec\u4f20\u7edf\u89c2\u5ff5\u4e2d\u7684\u5168\u865a\u62df\u5316\u5b8c\u5168\u4e0d\u4e00\u6837\uff0c\u975e\u5e38\u8f7b\u91cf\u7ea7\u3002LXC \u53ef\u4ee5\u5c06\u5355\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u7ba1\u7406\u7684\u8d44\u6e90\u5212\u5206\u5230\u72ec\u7acb\u7684\u7ec4\u4e2d\uff0c\u548c\u4f20\u7edf\u7684\u865a\u62df\u5316\u6280\u672f\u76f8\u6bd4\uff0cLXC \u6709\u5982\u4e0b\u4e00\u4e9b\u4f18\u52bf\uff1a</p> <ul> <li>\u548c\u5bbf\u4e3b\u673a\u4f7f\u7528\u540c\u4e00\u4e2a\u5185\u6838\uff0c\u6240\u4ee5\u6027\u80fd\u635f\u8017\u5c0f</li> <li>\u4e0d\u9700\u8981\u6307\u4ee4\u7ea7\u6a21\u62df</li> <li>\u4e0d\u9700\u8981\u5373\u65f6\u7f16\u8bd1</li> <li>\u5bb9\u5668\u53ef\u4ee5\u5728 CPU \u6838\u5fc3\u7684\u672c\u5730\u8fd0\u884c\u6307\u4ee4\uff0c\u4e0d\u9700\u8981\u4efb\u4f55\u4e13\u95e8\u7684\u89e3\u91ca\u673a\u5236</li> <li>\u907f\u514d\u4e86\u865a\u62df\u5316\u548c\u7cfb\u7edf\u8c03\u7528\u4e2d\u7684\u590d\u6742\u6027</li> <li>\u8f7b\u91cf\u7ea7\u9694\u79bb\uff0c\u9694\u79bb\u7684\u540c\u65f6\u8fd8\u53ef\u4ee5\u548c\u5bbf\u4e3b\u673a\u5171\u4eab\u8d44\u6e90</li> </ul> <p>LXC \u6709\u70b9\u50cf chroot\uff0c\u63d0\u4f9b\u4e86\u4e00\u4e2a\u62e5\u6709\u81ea\u5df1\u8fdb\u7a0b\u548c\u7f51\u7edc\u7a7a\u95f4\u7684\u865a\u62df\u73af\u5883\uff0c\u4f46\u662f\u548c\u865a\u62df\u673a\u53c8\u4e0d\u4e00\u6837\uff0c\u56e0\u4e3a LXC \u662f\u4e00\u79cd\u64cd\u4f5c\u7cfb\u7edf\u5c42\u9762\u4e0a\u7684\u8d44\u6e90\u7684\u865a\u62df\u5316\u3002</p> <p>chroot \u7b80\u4ecb</p> <p>chroot\uff08change root\uff09\uff0c\u5728 Linux \u7cfb\u7edf\u4e2d\uff0c\u7cfb\u7edf\u9ed8\u8ba4\u7684\u76ee\u5f55\u5c31\u90fd\u662f\u4ee5 <code>/</code> \u4e5f\u5c31\u662f\u6839\u76ee\u5f55\u5f00\u5934\u7684\uff0cchroot \u7684\u4f7f\u7528\u80fd\u591f\u6539\u53d8\u5f53\u524d\u7684\u7cfb\u7edf\u6839\u76ee\u5f55\u7ed3\u6784\uff0c\u901a\u8fc7\u6539\u53d8\u5f53\u524d\u7cfb\u7edf\u7684\u6839\u76ee\u5f55\uff0c\u6211\u4eec\u80fd\u591f\u9650\u5236\u7528\u6237\u7684\u6743\u5229\uff0c\u5728\u65b0\u7684\u6839\u76ee\u5f55\u4e0b\u5e76\u4e0d\u80fd\u591f\u8bbf\u95ee\u65e7\u7cfb\u7edf\u6839\u76ee\u5f55\u7684\u7ed3\u6784\u4e2a\u6587\u4ef6\uff0c\u4e5f\u5c31\u5efa\u7acb\u4e86\u4e00\u4e2a\u4e0e\u539f\u7cfb\u7edf\u5b8c\u5168\u9694\u79bb\u7684\u76ee\u5f55\u7ed3\u6784\u3002</p> <p>\u66f4\u591a\u5173\u4e8e chroot \u7684\u4ecb\u7ecd\uff0c\u53ef\u4ee5\u67e5\u770b \u7406\u89e3 chroot \u4e00\u6587\u3002</p>"},{"location":"docker/overview/#docker","title":"\u4ec0\u4e48\u662f Docker","text":"<p>Docker \u5e76\u4e0d\u662f LXC \u66ff\u4ee3\u54c1\uff0cDocker \u5e95\u5c42\u5c31\u662f\u4f7f\u7528\u7684 LXC \u6765\u5b9e\u73b0\uff0cLXC \u5c06 Linux \u8fdb\u7a0b\u6c99\u76d2\u5316\uff0c\u4f7f\u5f97\u8fdb\u7a0b\u4e4b\u95f4\u76f8\u4e92\u9694\u79bb\uff0c\u8fd8\u53ef\u4ee5\u5171\u4eab\u5bbf\u4e3b\u673a\u7684\u8d44\u6e90\u3002\u5728 LXC \u7684\u57fa\u7840\u4e0a\uff0cDocker \u63d0\u4f9b\u4e86\u4e00\u7cfb\u5217\u66f4\u52a0\u5f3a\u5927\u65b9\u4fbf\u7684\u529f\u80fd\uff0c\u4f7f\u5f97 Docker \u6210\u4e3a\u4e86\u73b0\u5728\u6700\u706b\u7684\u865a\u62df\u5316\u6280\u672f\u3002</p> <p>\u7531\u4e8e\u4e4b\u524d\u6211\u4eec\u7684\u540e\u53f0\u5728\u5f00\u53d1\u548c\u8fd0\u7ef4\u9636\u6bb5\u7684\u73af\u5883\u662f\u4e0d\u4e00\u81f4\u7684\uff0c\u8fd9\u5c31\u5bfc\u81f4\u4e86 Docker \u7684\u51fa\u73b0\uff0c\u56e0\u4e3a\u6211\u4eec\u901a\u8fc7 Docker \u53ef\u4ee5\u5c06\u7a0b\u5e8f\u8fd0\u884c\u7684\u73af\u5883\u4e5f\u4e00\u8d77\u6253\u5305\u5230\u7248\u672c\u63a7\u5236\u53bb\u4e86\uff0c\u8fd9\u6837\u5c31\u6392\u9664\u4e86\u56e0\u4e3a\u73af\u5883\u4e0d\u540c\u9020\u6210\u7684\u5404\u79cd\u9ebb\u70e6\u4e8b\u60c5\u4e86\uff0c\u4e5f\u4e0d\u4f1a\u51fa\u73b0\u5728\u672c\u5730\u53ef\u4ee5\u5728\u7ebf\u4e0a\u5374\u4e0d\u884c\u8fd9\u6837\u7684\u7a98\u5883\u4e86\u3002</p> <p>Docker \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u5e94\u7528\u5bb9\u5668\u5f15\u64ce\uff0c\u57fa\u4e8e go \u8bed\u8a00\u5f00\u53d1\uff0c\u53ef\u4ee5\u8ba9\u5f00\u53d1\u8005\u6253\u5305\u4ed6\u4eec\u7684\u5e94\u7528\u4ee5\u53ca\u4f9d\u8d56\u5305\u5230\u4e00\u4e2a\u8f7b\u91cf\u7ea7\u3001\u53ef\u79fb\u690d\u7684\u5bb9\u5668\u4e2d\uff0c\u7136\u540e\u53d1\u5e03\u5230\u4efb\u4f55\u6d41\u884c\u7684 Linux \u670d\u52a1\u5668\u3002\u5bb9\u5668\u662f\u4e00\u4e2a\u6c99\u7bb1\u673a\u5236\uff0c\u76f8\u4e92\u4e4b\u95f4\u4e0d\u4f1a\u6709\u5f71\u54cd\uff08\u7c7b\u4f3c\u4e8e\u6211\u4eec\u624b\u673a\u4e0a\u8fd0\u884c\u7684 app\uff09\uff0c\u5e76\u4e14\u5bb9\u5668\u5f00\u9500\u662f\u5f88\u4f4e\u7684\u3002</p> <p>\u7528\u5b98\u65b9\u7684\u8bdd\u6765\u8bf4\uff0cDocker \u53d7\u6b22\u8fce\uff0c\u662f\u56e0\u4e3a\u4ee5\u4e0b\u51e0\u4e2a\u7279\u70b9\uff1a</p> <ul> <li>\u7075\u6d3b\u6027\uff1a\u5373\u4f7f\u662f\u6700\u590d\u6742\u7684\u5e94\u7528\u4e5f\u53ef\u4ee5\u96c6\u88c5\u7bb1\u5316</li> <li>\u8f7b\u91cf\u7ea7\uff1a\u5bb9\u5668\u5229\u7528\u5e76\u5171\u4eab\u4e3b\u673a\u5185\u6838</li> <li>\u53ef\u4e92\u6362\uff1a\u60a8\u53ef\u4ee5\u5373\u65f6\u90e8\u7f72\u66f4\u65b0\u548c\u5347\u7ea7</li> <li>\u4fbf\u643a\u5f0f\uff1a\u60a8\u53ef\u4ee5\u5728\u672c\u5730\u6784\u5efa\uff0c\u90e8\u7f72\u5230\u4e91\uff0c\u5e76\u5728\u4efb\u4f55\u5730\u65b9\u8fd0\u884c</li> <li>\u53ef\u6269\u5c55\uff1a\u60a8\u53ef\u4ee5\u589e\u52a0\u5e76\u81ea\u52a8\u5206\u53d1\u5bb9\u5668\u526f\u672c</li> <li>\u53ef\u5806\u53e0\uff1a\u60a8\u53ef\u4ee5\u5782\u76f4\u548c\u5373\u65f6\u5806\u53e0\u670d\u52a1</li> </ul>"},{"location":"docker/overview/#docker_1","title":"Docker \u51e0\u4e2a\u91cd\u8981\u6982\u5ff5","text":"<p>\u5728\u4e86\u89e3\u4e86 Docker \u662f\u4ec0\u4e48\u4e4b\u540e\uff0c\u6211\u4eec\u9700\u8981\u5148\u4e86\u89e3\u4e0b Docker \u4e2d\u6700\u91cd\u8981\u76843\u4e2a\u6982\u5ff5\uff1a\u955c\u50cf\u3001\u5bb9\u5668\u548c\u4ed3\u5e93\u3002</p> <p><code>\u955c\u50cf</code> \u662f\u4e00\u4e2a\u53ea\u8bfb\u6a21\u677f\uff0c\u5e26\u6709\u521b\u5efa Docker \u5bb9\u5668\u7684\u8bf4\u660e\uff0c\u4e00\u822c\u6765\u8bf4\u7684\uff0c\u955c\u50cf\u4f1a\u57fa\u4e8e\u53e6\u5916\u7684\u4e00\u4e9b\u57fa\u7840\u955c\u50cf\u5e76\u52a0\u4e0a\u4e00\u4e9b\u989d\u5916\u7684\u81ea\u5b9a\u4e49\u529f\u80fd\u6765\u7ec4\u6210\u3002\u6bd4\u5982\uff0c\u4f60\u53ef\u4ee5\u6784\u5efa\u4e00\u4e2a\u57fa\u4e8e Centos \u7684\u955c\u50cf\uff0c\u7136\u540e\u5728\u8fd9\u4e2a\u57fa\u7840\u955c\u50cf\u4e0a\u9762\u5b89\u88c5\u4e00\u4e2a Nginx \u670d\u52a1\u5668\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u6784\u6210\u4e00\u4e2a\u5c5e\u4e8e\u6211\u4eec\u81ea\u5df1\u7684\u955c\u50cf\u4e86\u3002</p> <p><code>\u5bb9\u5668</code> \u662f\u4e00\u4e2a\u955c\u50cf\u7684\u53ef\u8fd0\u884c\u7684\u5b9e\u4f8b\uff0c\u53ef\u4ee5\u4f7f\u7528 Docker REST API \u6216\u8005 CLI \u547d\u4ee4\u884c\u5de5\u5177\u6765\u64cd\u4f5c\u5bb9\u5668\uff0c\u5bb9\u5668\u7684\u672c\u8d28\u662f\u8fdb\u7a0b\uff0c\u4f46\u4e0e\u76f4\u63a5\u5728\u5bbf\u4e3b\u6267\u884c\u7684\u8fdb\u7a0b\u4e0d\u540c\uff0c\u5bb9\u5668\u8fdb\u7a0b\u8fd0\u884c\u4e8e\u5c5e\u4e8e\u81ea\u5df1\u7684\u72ec\u7acb\u7684\u547d\u540d\u7a7a\u95f4\u3002\u56e0\u6b64\u5bb9\u5668\u53ef\u4ee5\u62e5\u6709\u81ea\u5df1\u7684 root \u6587\u4ef6\u7cfb\u7edf\u3001\u81ea\u5df1\u7684\u7f51\u7edc\u914d\u7f6e\u3001\u81ea\u5df1\u7684\u8fdb\u7a0b\u7a7a\u95f4\uff0c\u751a\u81f3\u81ea\u5df1\u7684\u7528\u6237 ID \u7a7a\u95f4\u3002\u5bb9\u5668\u5185\u7684\u8fdb\u7a0b\u662f\u8fd0\u884c\u5728\u4e00\u4e2a\u9694\u79bb\u7684\u73af\u5883\u91cc\uff0c\u4f7f\u7528\u8d77\u6765\uff0c\u5c31\u597d\u50cf\u662f\u5728\u4e00\u4e2a\u72ec\u7acb\u4e8e\u5bbf\u4e3b\u7684\u7cfb\u7edf\u4e0b\u64cd\u4f5c\u4e00\u6837\u3002\u8fd9\u79cd\u7279\u6027\u4f7f\u5f97\u5bb9\u5668\u5c01\u88c5\u7684\u5e94\u7528\u6bd4\u76f4\u63a5\u5728\u5bbf\u4e3b\u8fd0\u884c\u66f4\u52a0\u5b89\u5168\u3002</p> <p><code>registry</code> \u662f\u7528\u6765\u5b58\u50a8 Docker \u955c\u50cf\u7684\u4ed3\u5e93\uff0cDocker Hub \u662f Docker \u5b98\u65b9\u63d0\u4f9b\u7684\u4e00\u4e2a\u516c\u5171\u4ed3\u5e93\uff0c\u800c\u4e14 Docker \u9ed8\u8ba4\u4e5f\u662f\u4ece Docker Hub \u4e0a\u67e5\u627e\u955c\u50cf\u7684\uff0c\u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u8fd0\u884c\u4e00\u4e2a\u79c1\u6709\u4ed3\u5e93\uff0c\u5f53\u6211\u4eec\u4f7f\u7528 <code>docker pull</code> \u6216\u8005 <code>docker run</code> \u547d\u4ee4\u65f6\uff0c\u5c31\u4f1a\u4ece\u6211\u4eec\u914d\u7f6e\u7684 Docker \u955c\u50cf\u4ed3\u5e93\u4e2d\u53bb\u62c9\u53d6\u955c\u50cf\uff0c\u4f7f\u7528 <code>docker push</code> \u547d\u4ee4\u65f6\uff0c\u4f1a\u5c06\u6211\u4eec\u6784\u5efa\u7684\u955c\u50cf\u63a8\u9001\u5230\u5bf9\u5e94\u7684\u955c\u50cf\u4ed3\u5e93\u4e2d\uff0cregistry \u53ef\u4ee5\u7406\u89e3\u4e3a\u7528\u4e8e\u955c\u50cf\u7684 github \u8fd9\u6837\u7684\u6258\u7ba1\u670d\u52a1\u3002</p>"},{"location":"docker/overview/#_2","title":"\u5bb9\u5668\u548c\u865a\u62df\u673a","text":"<p>\u4e0a\u9762\u6211\u4eec\u8bf4\u5230\u4e86\u5bb9\u5668\u662f\u5728 Linux \u4e0a\u672c\u673a\u8fd0\u884c\uff0c\u5e76\u4e0e\u5176\u4ed6\u5bb9\u5668\u5171\u4eab\u4e3b\u673a\u7684\u5185\u6838\uff0c\u5b83\u8fd0\u884c\u4e00\u4e2a\u72ec\u7acb\u7684\u8fdb\u7a0b\uff0c\u4e0d\u5360\u7528\u5176\u4ed6\u4efb\u4f55\u53ef\u6267\u884c\u6587\u4ef6\u7684\u5185\u5b58\uff0c\u975e\u5e38\u8f7b\u91cf\u3002</p> <p>\u800c\u865a\u62df\u673a\u8fd0\u884c\u7684\u662f\u4e00\u4e2a\u5b8c\u6574\u7684\u64cd\u4f5c\u7cfb\u7edf\uff0c\u901a\u8fc7\u865a\u62df\u673a\u7ba1\u7406\u7a0b\u5e8f\u5bf9\u4e3b\u673a\u8d44\u6e90\u8fdb\u884c\u865a\u62df\u8bbf\u95ee\uff0c\u76f8\u6bd4\u4e4b\u4e0b\u9700\u8981\u7684\u8d44\u6e90\u9700\u8981\u66f4\u591a\uff0c\u4f46\u662f\u975e\u5e38\u5b89\u5168\uff0c\u56e0\u4e3a\u662f\u72ec\u7acb\u7684\u64cd\u4f5c\u7cfb\u7edf\uff0c\u72ec\u7acb\u7684\u5185\u6838\u3002</p> <p></p>"},{"location":"docker/overview/#docker_2","title":"\u652f\u6301 Docker \u7684\u5e95\u5c42\u6280\u672f","text":"<p><code>Docker \u672c\u8d28\u5c31\u662f\u5bbf\u4e3b\u673a\u7684\u4e00\u4e2a\u7279\u6b8a\u8fdb\u7a0b</code>\uff0cDocker \u662f\u901a\u8fc7 <code>namespace</code> \u5b9e\u73b0\u8d44\u6e90\u9694\u79bb\uff0c\u901a\u8fc7<code>cgroup</code> \u5b9e\u73b0\u8d44\u6e90\u9650\u5236\uff0c\u901a\u8fc7\u5199\u65f6\u590d\u5236\u6280\u672f\uff08copy-on-write\uff09\u5b9e\u73b0\u4e86\u9ad8\u6548\u7684\u6587\u4ef6\u64cd\u4f5c\uff08\u7c7b\u4f3c\u865a\u62df\u673a\u7684\u78c1\u76d8\u6bd4\u5982\u5206\u914d 500g \u5e76\u4e0d\u662f\u5b9e\u9645\u5360\u7528\u7269\u7406\u78c1\u76d8 500g\uff09</p>"},{"location":"docker/overview/#namespaces","title":"Namespaces","text":"<p>\u547d\u540d\u7a7a\u95f4 (namespaces) \u662f Linux \u4e3a\u6211\u4eec\u63d0\u4f9b\u7684\u7528\u4e8e\u5206\u79bb\u8fdb\u7a0b\u6811\u3001\u7f51\u7edc\u63a5\u53e3\u3001\u6302\u8f7d\u70b9\u4ee5\u53ca\u8fdb\u7a0b\u95f4\u901a\u4fe1\u7b49\u8d44\u6e90\u7684\u65b9\u6cd5\u3002\u5728\u65e5\u5e38\u4f7f\u7528\u4e2a\u4eba PC \u65f6\uff0c\u6211\u4eec\u5e76\u6ca1\u6709\u8fd0\u884c\u591a\u4e2a\u5b8c\u5168\u5206\u79bb\u7684\u670d\u52a1\u5668\u7684\u9700\u6c42\uff0c\u4f46\u662f\u5982\u679c\u6211\u4eec\u5728\u670d\u52a1\u5668\u4e0a\u542f\u52a8\u4e86\u591a\u4e2a\u670d\u52a1\uff0c\u8fd9\u4e9b\u670d\u52a1\u5176\u5b9e\u4f1a\u76f8\u4e92\u5f71\u54cd\u7684\uff0c\u6bcf\u4e00\u4e2a\u670d\u52a1\u90fd\u80fd\u770b\u5230\u5176\u4ed6\u670d\u52a1\u7684\u8fdb\u7a0b\uff0c\u4e5f\u53ef\u4ee5\u8bbf\u95ee\u5bbf\u4e3b\u673a\u5668\u4e0a\u7684\u4efb\u610f\u6587\u4ef6\uff0c\u4e00\u65e6\u670d\u52a1\u5668\u4e0a\u7684\u67d0\u4e00\u4e2a\u670d\u52a1\u88ab\u5165\u4fb5\uff0c\u90a3\u4e48\u5165\u4fb5\u8005\u5c31\u80fd\u591f\u8bbf\u95ee\u5f53\u524d\u673a\u5668\u4e0a\u7684\u6240\u6709\u670d\u52a1\u548c\u6587\u4ef6\uff0c\u8fd9\u662f\u6211\u4eec\u4e0d\u613f\u610f\u770b\u5230\u7684\uff0c\u6211\u4eec\u66f4\u5e0c\u671b\u8fd0\u884c\u5728\u540c\u4e00\u53f0\u673a\u5668\u4e0a\u7684\u4e0d\u540c\u670d\u52a1\u80fd\u505a\u5230\u5b8c\u5168\u9694\u79bb\uff0c\u5c31\u50cf\u8fd0\u884c\u5728\u591a\u53f0\u4e0d\u540c\u7684\u673a\u5668\u4e0a\u4e00\u6837\u3002\u800c Docker \u5176\u5b9e\u5c31\u901a\u8fc7 Linux \u7684 Namespaces \u6280\u672f\u6765\u5b9e\u73b0\u7684\u5bf9\u4e0d\u540c\u7684\u5bb9\u5668\u8fdb\u884c\u9694\u79bb\u3002</p> <p>\u5f53\u6211\u4eec\u8fd0\u884c\uff08docker run \u6216\u8005 docker start\uff09\u4e00\u4e2a Docker \u5bb9\u5668\u65f6\uff0cDocker \u4f1a\u4e3a\u8be5\u5bb9\u5668\u8bbe\u7f6e\u4e00\u7cfb\u5217\u7684 namespaces\uff0c\u8fd9\u4e9b namespaces \u63d0\u4f9b\u4e86\u4e00\u5c42\u9694\u79bb\uff0c\u5bb9\u5668\u7684\u5404\u4e2a\u65b9\u9762\u90fd\u5728\u5355\u72ec\u7684 namespace \u4e2d\u8fd0\u884c\uff0c\u5e76\u4e14\u5bf9\u5176\u7684\u8bbf\u95ee\u4ec5\u9650\u4e8e\u8be5 namespace\u3002</p> <p>Docker \u5728 Linux \u4e0a\u4f7f\u7528\u4ee5\u4e0b\u51e0\u4e2a\u547d\u540d\u7a7a\u95f4\uff08\u4e0a\u9762\u8bf4\u7684\u5404\u4e2a\u65b9\u9762\uff09\uff1a</p> <ul> <li>pid namespace\uff1a\u7528\u4e8e\u8fdb\u7a0b\u9694\u79bb\uff08PID\uff1a\u8fdb\u7a0bID\uff09</li> <li>net namespace\uff1a\u7ba1\u7406\u7f51\u7edc\u63a5\u53e3\uff08NET\uff1a\u7f51\u7edc\uff09</li> <li>ipc namespace\uff1a\u7ba1\u7406\u5bf9 IPC \u8d44\u6e90\u7684\u8bbf\u95ee\uff08IPC\uff1a\u8fdb\u7a0b\u95f4\u901a\u4fe1\uff08\u4fe1\u53f7\u91cf\u3001\u6d88\u606f\u961f\u5217\u548c\u5171\u4eab\u5185\u5b58\uff09\uff09</li> <li>mnt namespace\uff1a\u7ba1\u7406\u6587\u4ef6\u7cfb\u7edf\u6302\u8f7d\u70b9\uff08MNT\uff1a\u6302\u8f7d\uff09</li> <li>uts namespace\uff1a\u9694\u79bb\u4e3b\u673a\u540d\u548c\u57df\u540d</li> <li>user namespace\uff1a\u9694\u79bb\u7528\u6237\u548c\u7528\u6237\u7ec4\uff083.8\u4ee5\u540e\u7684\u5185\u6838\u624d\u652f\u6301\uff09</li> </ul>"},{"location":"docker/overview/#cgroups","title":"CGroups","text":"<p>\u6211\u4eec\u901a\u8fc7 Linux \u7684 namespaces \u6280\u672f\u4e3a\u65b0\u521b\u5efa\u7684\u8fdb\u7a0b\u9694\u79bb\u4e86\u6587\u4ef6\u7cfb\u7edf\u3001\u7f51\u7edc\u3001\u8fdb\u7a0b\u7b49\u8d44\u6e90\uff0c\u4f46\u662f namespaces \u5e76\u4e0d\u80fd\u591f\u4e3a\u6211\u4eec\u63d0\u4f9b\u7269\u7406\u8d44\u6e90\u4e0a\u7684\u9694\u79bb\uff0c\u6bd4\u5982 CPU\u3001\u5185\u5b58\u3001IO \u6216\u8005\u7f51\u7edc\u5e26\u5bbd\u7b49\uff0c\u6240\u4ee5\u5982\u679c\u6211\u4eec\u8fd0\u884c\u591a\u4e2a\u5bb9\u5668\u7684\u8bdd\uff0c\u5219\u5bb9\u5668\u4e4b\u95f4\u5c31\u4f1a\u62a2\u5360\u8d44\u6e90\u4e92\u76f8\u5f71\u54cd\u4e86\uff0c\u6240\u4ee5\u5bf9\u5bb9\u5668\u8d44\u6e90\u7684\u4f7f\u7528\u8fdb\u884c\u9650\u5236\u5c31\u975e\u5e38\u91cd\u8981\u4e86\uff0c\u800c Control Groups\uff08CGroups\uff09\u6280\u672f\u5c31\u80fd\u591f\u9694\u79bb\u5bbf\u4e3b\u673a\u4e0a\u7684\u7269\u7406\u8d44\u6e90\u3002CGroups \u7531 7 \u4e2a\u4e3b\u8981\u7684\u5b50\u7cfb\u7edf\u7ec4\u6210\uff1a\u5206\u522b\u662f cpuset\u3001cpu\u3001cpuacct\u3001blkio\u3001devices\u3001freezer\u3001memory\uff0c\u4e0d\u540c\u7c7b\u578b\u8d44\u6e90\u7684\u5206\u914d\u548c\u7ba1\u7406\u662f\u7531\u5404\u4e2a CGroup \u5b50\u7cfb\u7edf\u8d1f\u8d23\u5b8c\u6210\u7684\u3002</p> <p>CGroup \u7b80\u4ecb</p> <p>\u5728 CGroup \u4e2d\uff0c\u6240\u6709\u7684\u4efb\u52a1\u5c31\u662f\u4e00\u4e2a\u7cfb\u7edf\u7684\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u800c CGroup \u5c31\u662f\u4e00\u7ec4\u6309\u7167\u67d0\u79cd\u6807\u51c6\u5212\u5206\u7684\u8fdb\u7a0b\uff0c\u5728 CGroup \u8fd9\u79cd\u673a\u5236\u4e2d\uff0c\u6240\u6709\u7684\u8d44\u6e90\u63a7\u5236\u90fd\u662f\u4ee5 CGroup \u4f5c\u4e3a\u5355\u4f4d\u5b9e\u73b0\u7684\uff0c\u6bcf\u4e00\u4e2a\u8fdb\u7a0b\u90fd\u53ef\u4ee5\u968f\u65f6\u52a0\u5165\u4e00\u4e2a CGroup \u4e5f\u53ef\u4ee5\u968f\u65f6\u9000\u51fa\u4e00\u4e2a CGroup\u3002</p> <p>\u2013 CGroup \u4ecb\u7ecd\u3001\u5e94\u7528\u5b9e\u4f8b\u53ca\u539f\u7406\u63cf\u8ff0</p> <p>\u2013 Docker \u80cc\u540e\u7684\u5185\u6838 Cgroups \u673a\u5236</p> <p>CGroup \u5177\u6709\u4ee5\u4e0b\u51e0\u4e2a\u7279\u70b9\uff1a</p> <ul> <li>CGroup \u7684 API \u4ee5\u4e00\u4e2a\u4f2a\u6587\u4ef6\u7cfb\u7edf\uff08/sys/fs/cgroup/\uff09\u7684\u5b9e\u73b0\u65b9\u5f0f\uff0c\u7528\u6237\u7684\u7a0b\u5e8f\u53ef\u4ee5\u901a\u8fc7\u6587\u4ef6\u7cfb\u7edf\u5b9e\u73b0 CGroup \u7684\u7ec4\u4ef6\u7ba1\u7406</li> <li>CGroup \u7684\u7ec4\u4ef6\u7ba1\u7406\u64cd\u4f5c\u5355\u5143\u53ef\u4ee5\u7ec6\u7c92\u5ea6\u5230\u7ebf\u7a0b\u7ea7\u522b\uff0c\u7528\u6237\u53ef\u4ee5\u521b\u5efa\u548c\u9500\u6bc1 CGroup\uff0c\u4ece\u800c\u5b9e\u73b0\u8d44\u6e90\u8f7d\u5206\u914d\u548c\u518d\u5229\u7528</li> <li>\u6240\u6709\u8d44\u6e90\u7ba1\u7406\u7684\u529f\u80fd\u90fd\u4ee5\u5b50\u7cfb\u7edf\uff08cpu\u3001cpuset \u8fd9\u4e9b\uff09\u7684\u65b9\u5f0f\u5b9e\u73b0\uff0c\u63a5\u53e3\u7edf\u4e00\u5b50\u4efb\u52a1\u521b\u5efa\u4e4b\u521d\u4e0e\u5176\u7236\u4efb\u52a1\u5904\u4e8e\u540c\u4e00\u4e2a CGroup \u7684\u63a7\u5236\u7ec4</li> </ul> <p>\u53e6\u5916 CGroup \u5177\u6709\u56db\u5927\u529f\u80fd\uff1a</p> <ul> <li>\u8d44\u6e90\u9650\u5236\uff1a\u53ef\u4ee5\u5bf9\u4efb\u52a1\u4f7f\u7528\u7684\u8d44\u6e90\u603b\u989d\u8fdb\u884c\u9650\u5236</li> <li>\u4f18\u5148\u7ea7\u5206\u914d\uff1a\u901a\u8fc7\u5206\u914d\u7684 cpu \u65f6\u95f4\u7247\u6570\u91cf\u4ee5\u53ca\u78c1\u76d8 IO \u5e26\u5bbd\u5927\u5c0f\u7b49\uff0c\u5b9e\u9645\u4e0a\u76f8\u5f53\u4e8e\u63a7\u5236\u4e86\u4efb\u52a1\u8fd0\u884c\u4f18\u5148\u7ea7</li> <li>\u8d44\u6e90\u7edf\u8ba1\uff1a\u53ef\u4ee5\u7edf\u8ba1\u7cfb\u7edf\u7684\u8d44\u6e90\u4f7f\u7528\u91cf\uff0c\u5982 cpu \u65f6\u957f\uff0c\u5185\u5b58\u7528\u91cf\u7b49</li> <li>\u4efb\u52a1\u63a7\u5236\uff1acgroup \u53ef\u4ee5\u5bf9\u4efb\u52a1\u6267\u884c\u6302\u8d77\u3001\u6062\u590d\u7b49\u64cd\u4f5c</li> </ul>"},{"location":"docker/overview/#unionfs","title":"UnionFS","text":"<p>Linux \u7684\u547d\u540d\u7a7a\u95f4\u548c\u63a7\u5236\u7ec4\u5206\u522b\u89e3\u51b3\u4e86\u4e0d\u540c\u8d44\u6e90\u9694\u79bb\u7684\u95ee\u9898\uff0c\u524d\u8005\u89e3\u51b3\u4e86\u8fdb\u7a0b\u3001\u7f51\u7edc\u4ee5\u53ca\u6587\u4ef6\u7cfb\u7edf\u7684\u9694\u79bb\uff0c\u540e\u8005\u5b9e\u73b0\u4e86 CPU\u3001\u5185\u5b58\u7b49\u8d44\u6e90\u7684\u9694\u79bb\uff0c\u4f46\u662f\u5728 Docker \u4e2d\u8fd8\u6709\u53e6\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u95ee\u9898\u9700\u8981\u89e3\u51b3 - \u4e5f\u5c31\u662f\u955c\u50cf\u3002</p> <p>\u955c\u50cf\u5230\u5e95\u662f\u4ec0\u4e48\uff0c\u5b83\u53c8\u662f\u5982\u4f55\u7ec4\u6210\u548c\u7ec4\u7ec7\u7684\u5462\uff1f\u800c\u8fd9\u5176\u4e2d\u6700\u91cd\u8981\u7684\u6982\u5ff5\u5c31\u662f\u955c\u50cf\u5c42(Layers)\uff08\u5982\u4e0b\u56fe\uff09\u7684\u6982\u5ff5\uff0c\u800c\u955c\u50cf\u5c42\u4f9d\u8d56\u4e8e\u4e00\u7cfb\u5217\u7684\u5e95\u5c42\u6280\u672f\uff0c\u6bd4\u5982\u6587\u4ef6\u7cfb\u7edf(filesystems)\u3001\u5199\u65f6\u590d\u5236(copy-on-write)\u3001\u8054\u5408\u6302\u8f7d(union mounts)\u7b49\u3002</p> <p></p> <p>Docker \u955c\u50cf\u662f\u7531\u4e00\u7cfb\u5217\u7684\u5c42\u7ec4\u6210\u7684\uff0c\u6bcf\u5c42\u4ee3\u8868 Dockerfile \u4e2d\u7684\u4e00\u6761\u6307\u4ee4\uff0c\u6bd4\u5982\u4e0b\u9762\u7684 Dockerfile \u6587\u4ef6\uff1a</p> <pre><code>FROM ubuntu:04\nCOPY . /app\nRUN make /app\nCMD python /app/app.py\n</code></pre> <p>Dockerfile \u4ecb\u7ecd</p> <p><code>Dockerfile</code> \u662f\u4e00\u4e2a\u6587\u672c\u6587\u4ef6\uff0c\u5176\u5185\u5305\u542b\u4e86\u4e00\u6761\u6761\u7684\u6307\u4ee4\uff0c\u6bcf\u4e00\u6761\u6307\u4ee4\u6784\u5efa\u4e00\u5c42\uff0c\u56e0\u6b64\u6bcf\u4e00\u6761\u6307\u4ee4\u7684\u5185\u5bb9\uff0c\u5c31\u662f\u63cf\u8ff0\u8be5\u5c42\u5e94\u5f53\u5982\u4f55\u6784\u5efa\u3002Dockerfile \u662f\u6211\u4eec\u7528\u6765\u6784\u5efa Docker \u955c\u50cf\u7684\u4e00\u4e2a\u8bf4\u660e\u6587\u6863\uff0c\u4e5f\u662f\u6211\u4eec\u5b66\u4e60\u7684\u91cd\u70b9\uff0c\u5fc5\u987b\u8981\u8981\u638c\u63e1\u5982\u4f55\u7f16\u5199 Dockerfile\u3002</p> <p>\u8fd9\u91cc\u7684 Dockerfile \u5305\u542b4\u6761\u547d\u4ee4\uff0c\u5176\u4e2d\u6bcf\u4e00\u884c\u5c31\u521b\u5efa\u4e86\u4e00\u5c42\uff0c<code>FROM</code> \u8bed\u53e5\u4ece <code>ubuntu:18.04</code> \u8fd9\u4e2a\u57fa\u7840\u955c\u50cf\u521b\u5efa\u4e00\u4e2a\u5c42\u5f00\u59cb\uff0c<code>COPY</code> \u547d\u4ee4\u4ece Docker \u5ba2\u6237\u7aef\u7684\u5f53\u524d\u76ee\u5f55\u6dfb\u52a0\u4e00\u4e9b\u65b0\u7684\u6587\u4ef6\uff0c<code>RUN</code> \u6307\u4ee4\u4f7f\u7528 make \u547d\u4ee4\u6784\u5efa\u5e94\u7528\uff0c\u6700\u540e\u4e00\u5c42\u6307\u5b9a\u5728\u5bb9\u5668\u4e2d\u8fd0\u884c\u4ec0\u4e48\u547d\u4ee4\u3002</p> <p>\u955c\u50cf\u5c31\u662f\u7531\u8fd9\u4e9b\u5c42\u4e00\u5c42\u4e00\u5c42\u5806\u53e0\u8d77\u6765\u7684\uff0c\u955c\u50cf\u4e2d\u7684\u8fd9\u4e9b\u5c42\u90fd\u662f\u53ea\u8bfb\u7684\uff0c\u5f53\u6211\u4eec\u8fd0\u884c\u5bb9\u5668\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u4ee5\u5728\u8fd9\u4e9b\u57fa\u7840\u5c42\u4e4b\u4e0a\u6dfb\u52a0\u65b0\u7684\u53ef\u5199\u5c42\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u901a\u5e38\u8bf4\u7684<code>\u5bb9\u5668\u5c42</code>\uff0c\u5bf9\u4e8e\u8fd0\u884c\u4e2d\u7684\u5bb9\u5668\u6240\u505a\u7684\u6240\u6709\u66f4\u6539\uff08\u6bd4\u5982\u5199\u5165\u65b0\u6587\u4ef6\u3001\u4fee\u6539\u73b0\u6709\u6587\u4ef6\u3001\u5220\u9664\u6587\u4ef6\uff09\u90fd\u5c06\u5199\u5165\u8fd9\u4e2a\u5bb9\u5668\u5c42\uff0c\u4e0b\u9762\u663e\u793a\u4e86\u57fa\u4e8e Ubuntu 15.04 \u955c\u50cf\u8fd0\u884c\u7684\u5bb9\u5668\u5c42\u7684\u7ed3\u6784\uff1a</p> <p></p> <p>\u5bb9\u5668\u548c\u955c\u50cf\u4e4b\u95f4\u7684\u4e3b\u8981\u533a\u522b\u5c31\u662f\u5bb9\u5668\u5728\u955c\u50cf\u9876\u90e8\u7531\u4e00\u4e2a\u53ef\u5199\u5c42\uff0c\u5728\u5bb9\u5668\u4e2d\u7684\u6240\u6709\u64cd\u4f5c\u90fd\u4f1a\u5b58\u50a8\u5728\u8fd9\u4e2a\u5bb9\u5668\u5c42\u4e2d\uff0c\u5220\u9664\u5bb9\u5668\u540e\uff0c\u5bb9\u5668\u5c42\u4e5f\u4f1a\u88ab\u5220\u9664\uff0c\u4f46\u662f\u955c\u50cf\u4e0d\u4f1a\u53d8\u5316\u3002\u6b63\u56e0\u4e3a\u6bcf\u4e2a\u5bb9\u5668\u90fd\u6709\u81ea\u5df1\u7684\u53ef\u5199\u5bb9\u5668\u5c42\uff0c\u6240\u6709\u66f4\u6539\u90fd\u5b58\u50a8\u5728\u81ea\u5df1\u7684\u5bb9\u5668\u5c42\u4e2d\uff0c\u6240\u4ee5\u591a\u4e2a\u5bb9\u5668\u4e4b\u95f4\u53ef\u4ee5\u5171\u4eab\u540c\u4e00\u57fa\u7840\u955c\u50cf\u7684\u8bbf\u95ee\uff0c\u4f46\u4ecd\u7136\u5177\u6709\u81ea\u5df1\u7684\u6570\u636e\u72b6\u6001\u3002\u5982\u4e0b\u56fe\u6f14\u793a\u4e86\u591a\u4e2a\u5bb9\u5668\u5171\u4eab\u540c\u4e00\u955c\u50cf\u7684\u8bf7\u60c5\u51b5\uff1a</p> <p></p> <p>Docker \u4f7f\u7528\u5b58\u50a8\u9a71\u52a8\u7a0b\u5e8f\u6765\u7ba1\u7406\u955c\u50cf\u5c42\u548c\u53ef\u5199\u5bb9\u5668\u5c42\u7684\u5185\u5bb9\uff0c\u6bcf\u4e2a\u5b58\u50a8\u9a71\u52a8\u7a0b\u5e8f\u7684\u5904\u7406\u65b9\u5f0f\u4e0d\u540c\uff0c\u4f46\u662f\u6240\u6709\u7684\u9a71\u52a8\u90fd\u4f7f\u7528\u53ef\u5806\u53e0\u7684\u955c\u50cf\u5c42\u548c\u5199\u65f6\u590d\u5236\uff08Cow\uff09\u7b56\u7565\uff0c\u8fd9\u4e9b\u9a71\u52a8\u7a0b\u5e8f\u7ba1\u7406\u7684\u8fd9\u4e9b\u5c42\u5176\u5b9e\u5c31\u662f UnionFS\uff08\u8054\u5408\u6587\u4ef6\u7cfb\u7edf\uff09\uff0c\u73b0\u5728 Docker \u4e3b\u8981\u652f\u6301\u7684\u5b58\u50a8\u9a71\u52a8\u6709 aufs\u3001devicemapper\u3001overlay\u3001overlay2\u3001zfs \u548c vfs \u7b49\u7b49\uff0c\u5728\u65b0\u7684 Docker \u7248\u672c\u4e2d\uff0coverlay2 \u53d6\u4ee3\u4e86 aufs \u6210\u4e3a\u4e86\u63a8\u8350\u7684\u5b58\u50a8\u9a71\u52a8\u3002</p> <p>Copy-on-write</p> <p>\u5199\u65f6\u590d\u5236\u662f\u4e00\u79cd\u5171\u4eab\u548c\u590d\u5236\u6587\u4ef6\u7684\u7b56\u7565\uff0c\u53ef\u4ee5\u6700\u5927\u7a0b\u5ea6\u5730\u63d0\u9ad8\u6548\u7387\uff0c\u5982\u679c\u6587\u4ef6\u6216\u76ee\u5f55\u4f4d\u4e8e\u955c\u50cf\u7684\u8f83\u4f4e\u5c42\u4e2d\uff0c\u800c\u53e6\u4e00\u5c42\uff08\u5305\u62ec\u53ef\u5199\u5c42\uff09\u9700\u8981\u5bf9\u5176\u8fdb\u884c\u8bfb\u53d6\u8bbf\u95ee\uff0c\u5219\u5b83\u76f4\u63a5\u4f7f\u7528\u73b0\u6709\u6587\u4ef6\u5373\u53ef\u3002\u53e6\u4e00\u5c42\u7b2c\u4e00\u6b21\u9700\u8981\u4fee\u6539\u6587\u4ef6\u65f6\uff08\u5728\u6784\u5efa\u955c\u50cf\u6216\u8fd0\u884c\u5bb9\u5668\u65f6\uff09\uff0c\u5c06\u6587\u4ef6\u590d\u5236\u5230\u8be5\u5c42\u5e76\u8fdb\u884c\u4fee\u6539\u3002\u8fd9\u6837\u53ef\u4ee5\u5c06 I/O \u548c\u6bcf\u4e2a\u540e\u7eed\u5c42\u7684\u5927\u5c0f\u6700\u5c0f\u5316\u3002</p> <p>\u9009\u62e9\u5b58\u50a8\u9a71\u52a8</p> <p>\u5bf9\u4e8e Docker \u5982\u4f55\u9009\u62e9\u4e00\u4e2a\u5408\u9002\u7684\u5b58\u50a8\u9a71\u52a8\u7a0b\u5e8f\uff0c\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863 Docker storage drivers\u3002</p>"},{"location":"docker/overview/#docker_3","title":"Docker \u67b6\u6784","text":"<p>Docker \u4f7f\u7528 C/S \uff08\u5ba2\u6237\u7aef/\u670d\u52a1\u5668\uff09\u4f53\u7cfb\u7684\u67b6\u6784\uff0cDocker \u5ba2\u6237\u7aef\u4e0e Docker \u5b88\u62a4\u8fdb\u7a0b\uff08Dockerd\uff09\u901a\u4fe1\uff0cDocker \u5b88\u62a4\u8fdb\u7a0b\u8d1f\u8d23\u6784\u5efa\uff0c\u8fd0\u884c\u548c\u5206\u53d1 Docker \u5bb9\u5668\u3002Docker \u5ba2\u6237\u7aef\u548c\u5b88\u62a4\u8fdb\u7a0b\u53ef\u4ee5\u5728\u540c\u4e00\u4e2a\u7cfb\u7edf\u4e0a\u8fd0\u884c\uff0c\u4e5f\u53ef\u4ee5\u5c06 Docker \u5ba2\u6237\u7aef\u8fde\u63a5\u5230\u8fdc\u7a0b Docker \u5b88\u62a4\u8fdb\u7a0b\u3002Docker \u5ba2\u6237\u7aef\u548c\u5b88\u62a4\u8fdb\u7a0b\u4f7f\u7528 REST API \u901a\u8fc7 UNIX \u5957\u63a5\u5b57\u6216\u7f51\u7edc\u63a5\u53e3\u8fdb\u884c\u901a\u4fe1\u3002</p> <p></p>"},{"location":"kubernetes_basic/install/","title":"\u5b89\u88c5","text":""},{"location":"kubernetes_basic/install/#_1","title":"\u5b89\u88c5","text":"<p>Kubernetes \u96c6\u7fa4\u73af\u5883\u5b89\u88c5</p> <p>\u4e3a\u4e86\u6839\u636e\u6700\u65b0\u7684\u96c6\u7fa4\u7279\u6027\uff0c\u6211\u4eec\u8fd9\u91cc\u5b89\u88c5\u76ee\u524d\u6700\u65b0\u7684\u7248\u672c v1.16.2\uff0c\u5982\u679c\u4f60\u662f\u5728\u751f\u4ea7\u73af\u5883\u4f7f\u7528\uff0c\u5efa\u8bae\u4f7f\u7528\u4e0a\u4e00\u4e2a\u7248\u672c\u4e2d\u6700\u5927\u7684\u4fee\u6b63\u7248\u672c\uff0c\u6bd4\u5982 v1.15.5\uff0c\u7531\u4e8e v1.16 \u7248\u672c\u548c\u4e4b\u524d\u7684\u7248\u672c\u6709\u5f88\u5927\u53d8\u5316\uff0c\u4e3b\u8981\u4f53\u73b0\u5728 APIVersion \u79fb\u9664\u4e86\u4e4b\u524d\u7684\u4e00\u4e9b\u7248\u672c\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u91c7\u7528\u6700\u65b0\u7684 v1.16.2 \u7684\u7248\u672c\u3002\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u4e3b\u8981\u76ee\u7684\u4e5f\u662f\u5b66\u4e60 Kubernetes \u7684\u4e00\u4e9b\u77e5\u8bc6\u70b9\uff0c\u6240\u4ee5\u91c7\u7528\u7684\u662f Kubeadm \u6765\u5feb\u901f\u642d\u5efa\u5355 Master \u7684\u96c6\u7fa4\uff0c\u5728\u540e\u9762\u5982\u6709\u9700\u8981\u6211\u4eec\u53ef\u4ee5\u5728\u5b66\u4e60\u4e86\u8fd9\u4e9b\u77e5\u8bc6\u70b9\u540e\u6765\u642d\u5efa\u9002\u5408\u751f\u4ea7\u73af\u5883\u4f7f\u7528\u7684\u96c6\u7fa4\u3002</p> <p></p>"},{"location":"kubernetes_basic/install/#_2","title":"\u73af\u5883\u51c6\u5907","text":"<p>3\u4e2a\u8282\u70b9\uff0c\u90fd\u662f Centos 7.6 \u7cfb\u7edf\uff0c\u5185\u6838\u7248\u672c\uff1a3.10.0-957.12.2.el7.x86_64\uff0c\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u6dfb\u52a0 hosts \u4fe1\u606f\uff1a</p> <pre><code>$ cat /etc/hosts\n111 ydzs-master\n122 ydzs-node1\n123 ydzs-node2\n</code></pre> <p>hostname</p> <p>\u8282\u70b9\u7684 hostname \u5fc5\u987b\u4f7f\u7528\u6807\u51c6\u7684 DNS \u547d\u540d\uff0c\u53e6\u5916\u5343\u4e07\u4e0d\u7528\u4ec0\u4e48\u9ed8\u8ba4\u7684 <code>localhost</code> \u7684 hostname\uff0c\u4f1a\u5bfc\u81f4\u5404\u79cd\u9519\u8bef\u51fa\u73b0\u7684\u3002\u5728 Kubernetes \u9879\u76ee\u91cc\uff0c\u673a\u5668\u7684\u540d\u5b57\u4ee5\u53ca\u4e00\u5207\u5b58\u50a8\u5728 Etcd \u4e2d\u7684 API \u5bf9\u8c61\uff0c\u90fd\u5fc5\u987b\u4f7f\u7528\u6807\u51c6\u7684 DNS \u547d\u540d\uff08RFC 1123\uff09\u3002\u53ef\u4ee5\u4f7f\u7528\u547d\u4ee4 </p> <pre><code>hostnamectl set-hostname ydzs-node1\n</code></pre> <p>\u6765\u4fee\u6539 hostname\u3002</p> <p>\u7981\u7528\u9632\u706b\u5899\uff1a</p> <pre><code>$ systemctl stop firewalld\n$ systemctl disable firewalld\n</code></pre> <p>\u7981\u7528SELINUX\uff1a</p> <pre><code>$ setenforce 0\n$ cat /etc/selinux/config\nSELINUX=disabled\n</code></pre> <p>\u7531\u4e8e\u5f00\u542f\u5185\u6838 ipv4 \u8f6c\u53d1\u9700\u8981\u52a0\u8f7d br_netfilter \u6a21\u5757\uff0c\u6240\u4ee5\u52a0\u8f7d\u4e0b\u8be5\u6a21\u5757\uff1a</p> <pre><code>$ modprobe br_netfilter\n</code></pre> <p>\u521b\u5efa</p> <pre><code>/etc/sysctl.d/k8s.conf\n</code></pre> <p>\u6587\u4ef6\uff0c\u6dfb\u52a0\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>net.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\nnet.ipvip_forward = 1\n</code></pre> <p>bridge-nf</p> <p>bridge-nf \u4f7f\u5f97 netfilter \u53ef\u4ee5\u5bf9 Linux \u7f51\u6865\u4e0a\u7684 IPv4/ARP/IPv6 \u5305\u8fc7\u6ee4\u3002\u6bd4\u5982\uff0c\u8bbe\u7f6e</p> <pre><code>net.bridge.bridge-nf-call-iptables\uff1d1\n</code></pre> <p>\u540e\uff0c\u4e8c\u5c42\u7684\u7f51\u6865\u5728\u8f6c\u53d1\u5305\u65f6\u4e5f\u4f1a\u88ab iptables\u7684 FORWARD \u89c4\u5219\u6240\u8fc7\u6ee4\u3002\u5e38\u7528\u7684\u9009\u9879\u5305\u62ec\uff1a</p> <ul> <li>net.bridge.bridge-nf-call-arptables\uff1a\u662f\u5426\u5728 arptables \u7684 FORWARD \u4e2d\u8fc7\u6ee4\u7f51\u6865\u7684 ARP \u5305</li> <li>net.bridge.bridge-nf-call-ip6tables\uff1a\u662f\u5426\u5728 ip6tables \u94fe\u4e2d\u8fc7\u6ee4 IPv6 \u5305</li> <li>net.bridge.bridge-nf-call-iptables\uff1a\u662f\u5426\u5728 iptables \u94fe\u4e2d\u8fc7\u6ee4 IPv4 \u5305</li> <li>net.bridge.bridge-nf-filter-vlan-tagged\uff1a\u662f\u5426\u5728 iptables/arptables \u4e2d\u8fc7\u6ee4\u6253\u4e86 vlan \u6807\u7b7e\u7684\u5305\u3002</li> </ul> <p>\u6267\u884c\u5982\u4e0b\u547d\u4ee4\u4f7f\u4fee\u6539\u751f\u6548\uff1a</p> <pre><code>$ sysctl -p /etc/sysctl.d/k8s.conf\n</code></pre> <p>\u5b89\u88c5 ipvs\uff1a</p> <pre><code>$ cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF\n#!/bin/bash\nmodprobe -- ip_vs\nmodprobe -- ip_vs_rr\nmodprobe -- ip_vs_wrr\nmodprobe -- ip_vs_sh\nmodprobe -- nf_conntrack_ipv4\nEOF\n$ chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack_ipv4\n</code></pre> <p>\u4e0a\u9762\u811a\u672c\u521b\u5efa\u4e86\u7684</p> <pre><code>/etc/sysconfig/modules/ipvs.modules\n</code></pre> <p>\u6587\u4ef6\uff0c\u4fdd\u8bc1\u5728\u8282\u70b9\u91cd\u542f\u540e\u80fd\u81ea\u52a8\u52a0\u8f7d\u6240\u9700\u6a21\u5757\u3002\u4f7f\u7528</p> <pre><code>lsmod | grep -e ip_vs -e nf_conntrack_ipv4\n</code></pre> <p>\u547d\u4ee4\u67e5\u770b\u662f\u5426\u5df2\u7ecf\u6b63\u786e\u52a0\u8f7d\u6240\u9700\u7684\u5185\u6838\u6a21\u5757\u3002</p> <p>\u63a5\u4e0b\u6765\u8fd8\u9700\u8981\u786e\u4fdd\u5404\u4e2a\u8282\u70b9\u4e0a\u5df2\u7ecf\u5b89\u88c5\u4e86 ipset \u8f6f\u4ef6\u5305\uff1a</p> <p><code>$ yum install ipset</code></p> <p>\u4e3a\u4e86\u4fbf\u4e8e\u67e5\u770b ipvs \u7684\u4ee3\u7406\u89c4\u5219\uff0c\u6700\u597d\u5b89\u88c5\u4e00\u4e0b\u7ba1\u7406\u5de5\u5177 ipvsadm\uff1a</p> <pre><code>$ yum install ipvsadm\n</code></pre> <p>\u540c\u6b65\u670d\u52a1\u5668\u65f6\u95f4</p> <pre><code>$ yum install chrony -y\n$ systemctl enable chronyd\n$ systemctl start chronyd\n$ chronyc sources\n210 Number of sources = 4\nMS Name/IP address         Stratum Poll Reach LastRx Last sample\n\n^+ svggsrv.de                  2   6    17    32   -823us[-1128us] +/-   98ms\n^- montreal.ca.logiplex.net      2   6    17    32    -17ms[  -17ms] +/-  179ms\n^- ntpflashdance.cx            2   6    17    32    -32ms[  -32ms] +/-  161ms\n^* 11184                2   6    33    32   +661us[ +357us] +/-   38ms\n$ date\nTue Aug 27 09:28:41 CST 2019\n</code></pre> <p>\u5173\u95ed swap \u5206\u533a\uff1a</p> <p><code>$ swapoff -a</code></p> <p>\u4fee\u6539<code>/etc/fstab</code>\u6587\u4ef6\uff0c\u6ce8\u91ca\u6389 SWAP \u7684\u81ea\u52a8\u6302\u8f7d\uff0c\u4f7f\u7528<code>free -m</code>\u786e\u8ba4 swap \u5df2\u7ecf\u5173\u95ed\u3002swappiness \u53c2\u6570\u8c03\u6574\uff0c\u4fee\u6539</p> <pre><code>/etc/sysctl.d/k8s.conf\n</code></pre> <p>\u6dfb\u52a0\u4e0b\u9762\u4e00\u884c\uff1a</p> <p><code>vm.swappiness=0</code></p> <p>\u6267\u884c</p> <pre><code>sysctl -p /etc/sysctl.d/k8s.conf\n</code></pre> <p>\u4f7f\u4fee\u6539\u751f\u6548\u3002</p> <p>\u63a5\u4e0b\u6765\u53ef\u4ee5\u5b89\u88c5 Docker:</p> <pre><code>$ yum install -y yum-utils \\\\\n  device-mapper-persistent-data \\\\\n  lvm2\n# \u5982\u679c\u4e0b\u9762\u547d\u4ee4\u6267\u884c\u8d85\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528\u963f\u91cc\u4e91\u7684\u6e90\u4ee3\u66ff\uff1ahttp://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\n$ yum-config-manager \\\\\n    --add-repo \\\\\n    https://download.docker.com/linux/centos/docker-ce.repo\n$ yum list docker-ce --showduplicates | sort -r\n * updates: mirrors.tuna.tsinghua.edu.cn\nLoading mirror speeds from cached hostfile\nLoaded plugins: fastestmirror, langpacks\nInstalled Packages\n * extras: mirrors.tuna.tsinghua.edu.cn\n * epel: mirrors.yun-idc.com\ndocker-ce.x86_64            3:1-el7                     docker-ce-stable\ndocker-ce.x86_64            3:0-el7                     docker-ce-stable\ndocker-ce.x86_64            3:8-el7                     docker-ce-stable\n......\ndocker-ce.x86_64            ce-elcentos             docker-ce-stable\ndocker-ce.x86_64            ce-elcentos             docker-ce-stable\n......\n * base: mirror.lzu.edu.cn\nAvailable Packages\n</code></pre> <p>\u53ef\u4ee5\u9009\u62e9\u5b89\u88c5\u4e00\u4e2a\u7248\u672c\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u5b89\u88c5\u6700\u65b0\u7248\u672c\uff1a</p> <pre><code># \u5efa\u8bae\u5b89\u88c509\u7248\u672c\uff0c\u662f\u6700\u65b0\u9a8c\u8bc1\u7684\u7248\u672c\n$ yum install docker-ce-9\n</code></pre> <p>\u914d\u7f6e Docker \u955c\u50cf\u52a0\u901f\u5668:</p> <pre><code>$ mkdir -p /etc/docker  # \u5982\u679c\u6ca1\u6709\u8fd9\u4e2a\u76ee\u5f55\u5148\u521b\u5efa\uff0c\u7136\u540e\u6dfb\u52a0 daemon.json \u6587\u4ef6\n$ vi /etc/docker/daemon.json\n{\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"],\n  \"registry-mirrors\" : [\n    \"https://ot2k4dmirror.aliyuncs.com/\"\n  ]\n}\n</code></pre> <p>cgroup \u9a71\u52a8</p> <p>\u7531\u4e8e\u9ed8\u8ba4\u60c5\u51b5\u4e0b kubelet \u4f7f\u7528\u7684 cgroupdriver \u662f systemd\uff0c\u6240\u4ee5\u9700\u8981\u4fdd\u6301 docker \u548ckubelet \u7684 cgroupdriver \u4e00\u81f4\uff0c\u6211\u4eec\u8fd9\u91cc\u4fee\u6539 docker \u7684 cgroupdriver=systemd\u3002\u5982\u679c\u4e0d\u4fee\u6539 docker \u5219\u9700\u8981\u4fee\u6539 kubelet \u7684\u542f\u52a8\u914d\u7f6e\uff0c\u9700\u8981\u4fdd\u8bc1\u4e24\u8005\u4e00\u81f4\u3002</p> <p>\u542f\u52a8 Docker\uff1a</p> <pre><code>$ systemctl start docker\n$ systemctl enable docker\n</code></pre> <p>\u5728\u786e\u4fdd Docker \u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u4e0a\u9762\u7684\u76f8\u5173\u73af\u5883\u914d\u7f6e\u4e5f\u5b8c\u6210\u4e86\uff0c\u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u6765\u5b89\u88c5 Kubeadm \u4e86\uff0c\u6211\u4eec\u8fd9\u91cc\u662f\u901a\u8fc7\u6307\u5b9ayum \u6e90\u7684\u65b9\u5f0f\u6765\u8fdb\u884c\u5b89\u88c5\u7684\uff1a</p> <pre><code>cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg\n        https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg\nEOF\n</code></pre> <p>\u5f53\u7136\u4e86\uff0c\u4e0a\u9762\u7684 yum \u6e90\u662f\u9700\u8981\u79d1\u5b66\u4e0a\u7f51\u7684\uff0c\u5982\u679c\u4e0d\u80fd\u79d1\u5b66\u4e0a\u7f51\u7684\u8bdd\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u963f\u91cc\u4e91\u7684\u6e90\u8fdb\u884c\u5b89\u88c5\uff1a</p> <pre><code>cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64\nenabled=1\ngpgcheck=0\nrepo_gpgcheck=0\ngpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg\n        http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nEOF\n</code></pre> <p>\u7136\u540e\u5b89\u88c5 kubeadm\u3001kubelet\u3001kubectl\uff1a</p> <pre><code># --disableexcludes \u7981\u6389\u9664\u4e86kubernetes\u4e4b\u5916\u7684\u522b\u7684\u4ed3\u5e93\n$ yum install -y kubelet-2 kubeadm-2 kubectl-2 --disableexcludes=kubernetes\n$ kubeadm version\nkubeadm version: &amp;version.Info{Major:\"1\", Minor:\"16\", GitVersion:\"v2\", GitCommit:\"c97fe5036ef3df2967d086711e6c0c405941e14b\", GitTreeState:\"clean\", BuildDate:\"2019-10-15T19:15:39Z\", GoVersion:\"go10\", Compiler:\"gc\", Platform:\"linux/amd64\"}\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u8fd9\u91cc\u5b89\u88c5\u7684\u662f v1.16.2 \u7248\u672c\uff0c\u7136\u540e\u5c06 kubelet \u8bbe\u7f6e\u6210\u5f00\u673a\u542f\u52a8\uff1a</p> <pre><code>$ systemctl enable --now kubelet\n</code></pre> <p>\u5230\u8fd9\u91cc\u4e3a\u6b62\u4e0a\u9762\u6240\u6709\u7684\u64cd\u4f5c\u90fd\u9700\u8981\u5728\u6240\u6709\u8282\u70b9\u6267\u884c\u914d\u7f6e\u3002</p>"},{"location":"kubernetes_basic/install/#_3","title":"\u521d\u59cb\u5316\u96c6\u7fa4","text":"<p>\u7136\u540e\u63a5\u4e0b\u6765\u5728 master \u8282\u70b9\u914d\u7f6e kubeadm \u521d\u59cb\u5316\u6587\u4ef6\uff0c\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u5bfc\u51fa\u9ed8\u8ba4\u7684\u521d\u59cb\u5316\u914d\u7f6e\uff1a</p> <pre><code>$ kubeadm config print init-defaults &gt; kubeadm.yaml\n</code></pre> <p>\u7136\u540e\u6839\u636e\u6211\u4eec\u81ea\u5df1\u7684\u9700\u6c42\u4fee\u6539\u914d\u7f6e\uff0c\u6bd4\u5982\u4fee\u6539 imageRepository \u7684\u503c\uff0ckube-proxy \u7684\u6a21\u5f0f\u4e3a ipvs\uff0c\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\u6211\u4eec\u8fd9\u91cc\u662f\u51c6\u5907\u5b89\u88c5 flannel \u7f51\u7edc\u63d2\u4ef6\u7684\uff0c\u9700\u8981\u5c06 networking.podSubnet \u8bbe\u7f6e\u4e3a<code>10.244.0.0/16</code>\uff1a</p> <pre><code>apiVersion: kubeadm.k8s.io/v1beta2\nbootstrapTokens:\n- groups:\n  - system:bootstrappers:kubeadm:default-node-token\n  token: abcdef.0123456789abcdef\n  ttl: 24h0m0s\n  usages:\n  - signing\n  - authentication\nkind: InitConfiguration\nlocalAPIEndpoint:\n  advertiseAddress: 111  # apiserver \u8282\u70b9\u5185\u7f51IP\n  bindPort: 6443\nnodeRegistration:\n  criSocket: /var/run/dockershim.sock\n  name: ydzs-master  # \u9ed8\u8ba4\u8bfb\u53d6\u5f53\u524dmaster\u8282\u70b9\u7684hostname\n  taints:\n  - effect: NoSchedule\n    key: node-role.kubernetes.io/master\n---\napiServer:\n  timeoutForControlPlane: 4m0s\napiVersion: kubeadm.k8s.io/v1beta2\ncertificatesDir: /etc/kubernetes/pki\nclusterName: kubernetes\ncontrollerManager: {}\ndns:\n  type: CoreDNS\netcd:\n  local:\n    dataDir: /var/lib/etcd\nimageRepository: registry.aliyuncs.com/google_containers  # \u4fee\u6539\u6210\u963f\u91cc\u4e91\u955c\u50cf\u6e90\nkind: ClusterConfiguration\nkubernetesVersion: v2\nnetworking:\n  dnsDomain: cluster.local\n  podSubnet: 20/16  # Pod \u7f51\u6bb5\uff0cflannel\u63d2\u4ef6\u9700\u8981\u4f7f\u7528\u8fd9\u4e2a\u7f51\u6bb5\n  serviceSubnet: 0/12\nscheduler: {}\n---\napiVersion: kubeproxy.config.k8s.io/v1alpha1\nkind: KubeProxyConfiguration\nmode: ipvs  # kube-proxy \u6a21\u5f0f\n</code></pre> <p>\u914d\u7f6e\u63d0\u793a</p> <p>\u5bf9\u4e8e\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u7684\u6587\u6863\u6bd4\u8f83\u6742\uff0c\u8981\u60f3\u5b8c\u6574\u4e86\u89e3\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5bf9\u5e94\u7684\u5c5e\u6027\uff0c\u53ef\u4ee5\u67e5\u770b\u5bf9\u5e94\u7684 godoc \u6587\u6863\uff0c\u5730\u5740: https://godoc.org/k8s.io/kubernetes/cmd/kubeadm/app/apis/kubeadm/v1beta2\u3002</p> <p>\u7136\u540e\u4f7f\u7528\u4e0a\u9762\u7684\u914d\u7f6e\u6587\u4ef6\u8fdb\u884c\u521d\u59cb\u5316\uff1a</p> <pre><code>$ kubeadm init --config kubeadm.yaml\n[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`\nTo see the stack trace of this error execute with --v=5 or higher\n[init] Using Kubernetes version: v2\n[preflight] Running pre-flight checks\n[preflight] Pulling images required for setting up a Kubernetes cluster\n[preflight] This might take a minute or two, depending on the speed of your internet connection\n[preflight] You can also perform this action in beforehand using 'kubeadm config images pull'\n[kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\"\n[kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\"\n[kubelet-start] Activating the kubelet service\n[certs] Using certificateDir folder \"/etc/kubernetes/pki\"\n[certs] Generating \"ca\" certificate and key\nx[certs] Generating \"apiserver\" certificate and key\n[certs] apiserver serving cert is signed for DNS names [ydzs-master kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [1 111]\nxxx[certs] Generating \"apiserver-kubelet-client\" certificate and key\nx[certs] Generating \"front-proxy-ca\" certificate and key\n[certs] Generating \"front-proxy-client\" certificate and key\n[certs] Generating \"etcd/ca\" certificate and key\n[certs] Generating \"etcd/server\" certificate and key\n[certs] etcd/server serving cert is signed for DNS names [ydzs-master localhost] and IPs [111 11 ::1]\n[certs] Generating \"etcd/peer\" certificate and key\n[certs] etcd/peer serving cert is signed for DNS names [ydzs-master localhost] and IPs [111 11 ::1]\n[certs] Generating \"etcd/healthcheck-client\" certificate and key\n[certs] Generating \"apiserver-etcd-client\" certificate and key\n[certs] Generating \"sa\" key and public key\n[kubeconfig] Using kubeconfig folder \"/etc/kubernetes\"\n[kubeconfig] Writing \"admin.conf\" kubeconfig file\n[kubeconfig] Writing \"kubelet.conf\" kubeconfig file\n[kubeconfig] Writing \"controller-manager.conf\" kubeconfig file\n[kubeconfig] Writing \"scheduler.conf\" kubeconfig file\n[control-plane] Using manifest folder \"/etc/kubernetes/manifests\"\n[control-plane] Creating static Pod manifest for \"kube-apiserver\"\n[control-plane] Creating static Pod manifest for \"kube-controller-manager\"\n[control-plane] Creating static Pod manifest for \"kube-scheduler\"\n[etcd] Creating static Pod manifest for local etcd in \"/etc/kubernetes/manifests\"\n[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory \"/etc/kubernetes/manifests\". This can take up to 4m0s\n[apiclient] All control plane components are healthy after 504262 seconds\n[upload-config] Storing the configuration used in ConfigMap \"kubeadm-config\" in the \"kube-system\" Namespace\n[kubelet] Creating a ConfigMap \"kubelet-config-16\" in namespace kube-system with the configuration for the kubelets in the cluster\n[kubelet-check] Initial timeout of 40s passed.\n[upload-certs] Skipping phase. Please see --upload-certs\n[mark-control-plane] Marking the node ydzs-master as control-plane by adding the label \"node-role.kubernetes.io/master=''\"\n[mark-control-plane] Marking the node ydzs-master as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]\n[bootstrap-token] Using token: abcdef.0123456789abcdef\n[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles\n[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials\n[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token\n[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster\n[bootstrap-token] Creating the \"cluster-info\" ConfigMap in the \"kube-public\" namespace\n[addons] Applied essential addon: CoreDNS\n[addons] Applied essential addon: kube-proxy\n\nYour Kubernetes control-plane has initialized successfully!\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  mkdir -p $HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n  sudo chown $(id -u):$(id -g) $HOME/.kube/config\n\nYou should now deploy a pod network to the cluster.\nRun \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nThen you can join any number of worker nodes by running the following on each as root:\n\nkubeadm join 111:6443 --token abcdef.0123456789abcdef \\\\\n    --discovery-token-ca-cert-hash sha256:a292e66049e45264f848186d2fa3582dc360f3b5006cc160f137b5d436e078c2\n</code></pre> <p>\u62f7\u8d1d kubeconfig \u6587\u4ef6</p> <pre><code>$ mkdir -p $HOME/.kube\n$ sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n$ sudo chown $(id -u):$(id -g) $HOME/.kube/config\n</code></pre> <p><code>kubeadm init</code> \u547d\u4ee4\u6267\u884c\u6d41\u7a0b\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p>"},{"location":"kubernetes_basic/install/#_4","title":"\u6dfb\u52a0\u8282\u70b9","text":"<p>\u8bb0\u4f4f\u521d\u59cb\u5316\u96c6\u7fa4\u4e0a\u9762\u7684\u914d\u7f6e\u548c\u64cd\u4f5c\u8981\u63d0\u524d\u505a\u597d\uff0c\u5c06 master \u8282\u70b9\u4e0a\u9762\u7684 $HOME/.kube/config \u6587\u4ef6\u62f7\u8d1d\u5230 node \u8282\u70b9\u5bf9\u5e94\u7684\u6587\u4ef6\u4e2d\uff0c\u5b89\u88c5 kubeadm\u3001kubelet\u3001kubectl\uff08\u53ef\u9009\uff09\uff0c\u7136\u540e\u6267\u884c\u4e0a\u9762\u521d\u59cb\u5316\u5b8c\u6210\u540e\u63d0\u793a\u7684 join \u547d\u4ee4\u5373\u53ef\uff1a</p> <pre><code>$ kubeadm join 111:6443 --token abcdef.0123456789abcdef \\\\\n&gt;     --discovery-token-ca-cert-hash sha256:a292e66049e45264f848186d2fa3582dc360f3b5006cc160f137b5d436e078c2\n[preflight] Running pre-flight checks\n[preflight] Reading configuration from the cluster...\n[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'\n[kubelet-start] Downloading configuration for the kubelet from the \"kubelet-config-16\" ConfigMap in the kube-system namespace\n[kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\"\n[kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\"\n[kubelet-start] Activating the kubelet service\n[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...\n\nThis node has joined the cluster:\n* Certificate signing request was sent to apiserver and a response was received.\n* The Kubelet was informed of the new secure connection details.\n\nRun 'kubectl get nodes' on the control-plane to see this node join the cluster.\n</code></pre> <p>join \u547d\u4ee4</p> <p>\u5982\u679c\u5fd8\u8bb0\u4e86\u4e0a\u9762\u7684 join \u547d\u4ee4\u53ef\u4ee5\u4f7f\u7528\u547d\u4ee4 </p> <pre><code>kubeadm token create --print-join-command\n</code></pre> <p>\u91cd\u65b0\u83b7\u53d6\u3002</p> <p><code>kubeadm join</code> \u547d\u4ee4\u6267\u884c\u6d41\u7a0b\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u6267\u884c\u6210\u529f\u540e\u8fd0\u884c get nodes \u547d\u4ee4\uff1a</p> <pre><code>$ kubectl get nodes\nNAME          STATUS     ROLES    AGE    VERSION\nydzs-master   NotReady      master   39m    v3\nydzs-node1    NotReady   &lt;none&gt;   106s   v3\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u662f NotReady \u72b6\u6001\uff0c\u8fd9\u662f\u56e0\u4e3a\u8fd8\u6ca1\u6709\u5b89\u88c5\u7f51\u7edc\u63d2\u4ef6\uff0c\u63a5\u4e0b\u6765\u5b89\u88c5\u7f51\u7edc\u63d2\u4ef6\uff0c\u53ef\u4ee5\u5728\u6587\u6863 https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/ \u4e2d\u9009\u62e9\u6211\u4eec\u81ea\u5df1\u7684\u7f51\u7edc\u63d2\u4ef6\uff0c\u8fd9\u91cc\u6211\u4eec\u5b89\u88c5 flannel:</p> <pre><code>$ wget https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml\n# \u56e0\u4e3a\u6709\u8282\u70b9\u662f\u591a\u7f51\u5361\uff0c\u6240\u4ee5\u9700\u8981\u5728\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u4e2d\u6307\u5b9a\u5185\u7f51\u7f51\u5361\n# \u641c\u7d22\u5230\u540d\u4e3a kube-flannel-ds-amd64 \u7684 DaemonSet\uff0c\u5728kube-flannel\u5bb9\u5668\u4e0b\u9762\n$ vi kube-flannel.yml\n......\ncontainers:\n- name: kube-flannel\n  image: quay.io/coreos/flannel:v0-amd64\n  command:\n  - /opt/bin/flanneld\n  args:\n  - --ip-masq\n  - --kube-subnet-mgr\n  - --iface=eth0  # \u5982\u679c\u662f\u591a\u7f51\u5361\u7684\u8bdd\uff0c\u6307\u5b9a\u5185\u7f51\u7f51\u5361\u7684\u540d\u79f0\n......\n$ kubectl apply -f kube-flannel.yml  # \u5b89\u88c5 flannel \u7f51\u7edc\u63d2\u4ef6\n</code></pre> <p>\u9694\u4e00\u4f1a\u513f\u67e5\u770b Pod \u8fd0\u884c\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pods -n kube-system\nNAME                                  READY   STATUS    RESTARTS   AGE\ncoredns-667f964f9b-wb5fn              1/1     Running   0          20m\ncoredns-667f964f9b-xmwn2              1/1     Running   0          20m\netcd-ydzs-master                      1/1     Running   0          19m\nkube-apiserver-ydzs-master            1/1     Running   0          19m\nkube-controller-manager-ydzs-master   1/1     Running   0          19m\nkube-flannel-ds-amd64-8l2wr           1/1     Running   0          12m\nkube-flannel-ds-amd64-vwhbh           1/1     Running   0          12m\nkube-proxy-8r4d2                      1/1     Running   0          17m\nkube-proxy-rbjv7                      1/1     Running   0          20m\nkube-scheduler-ydzs-master            1/1     Running   0          20m\n</code></pre> <p>Flannel \u7f51\u7edc\u63d2\u4ef6</p> <p>\u5f53\u6211\u4eec\u90e8\u7f72\u5b8c\u7f51\u7edc\u63d2\u4ef6\u540e\u6267\u884c ifconfig \u547d\u4ee4\uff0c\u6b63\u5e38\u4f1a\u770b\u5230\u65b0\u589e\u7684<code>cni0</code>\u4e0e<code>flannel1</code>\u8fd9\u4e24\u4e2a\u865a\u62df\u8bbe\u5907\uff0c\u4f46\u662f\u5982\u679c\u6ca1\u6709\u770b\u5230<code>cni0</code>\u8fd9\u4e2a\u8bbe\u5907\u4e5f\u4e0d\u7528\u592a\u62c5\u5fc3\uff0c\u6211\u4eec\u53ef\u4ee5\u89c2\u5bdf<code>/var/lib/cni</code>\u76ee\u5f55\u662f\u5426\u5b58\u5728\uff0c\u5982\u679c\u4e0d\u5b58\u5728\u5e76\u4e0d\u662f\u8bf4\u90e8\u7f72\u6709\u95ee\u9898\uff0c\u800c\u662f\u8be5\u8282\u70b9\u4e0a\u6682\u65f6\u8fd8\u6ca1\u6709\u5e94\u7528\u8fd0\u884c\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5728\u8be5\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a Pod \u5c31\u53ef\u4ee5\u770b\u5230\u8be5\u76ee\u5f55\u4f1a\u88ab\u521b\u5efa\uff0c\u5e76\u4e14<code>cni0</code>\u8bbe\u5907\u4e5f\u4f1a\u88ab\u521b\u5efa\u51fa\u6765\u3002</p> <p>\u7f51\u7edc\u63d2\u4ef6\u8fd0\u884c\u6210\u529f\u4e86\uff0cnode \u72b6\u6001\u4e5f\u6b63\u5e38\u4e86\uff1a</p> <pre><code>$ kubectl get nodes\nNAME          STATUS   ROLES    AGE   VERSION\nydzs-master   Ready    master   21m   v2\nydzs-node1    Ready    &lt;none&gt;   18m   v2\n</code></pre> <p>\u7528\u540c\u6837\u7684\u65b9\u6cd5\u6dfb\u52a0\u53e6\u5916\u4e00\u4e2a\u8282\u70b9\u5373\u53ef\u3002</p>"},{"location":"kubernetes_basic/install/#dashboard","title":"Dashboard","text":"<p>v1.16.2 \u7248\u672c\u7684\u96c6\u7fa4\u9700\u8981\u5b89\u88c5\u6700\u65b0\u7684 2.0+ \u7248\u672c\u7684 Dashboard\uff1a</p> <pre><code># \u63a8\u8350\u4f7f\u7528\u4e0b\u9762\u8fd9\u79cd\u65b9\u5f0f\n$ wget https://raw.githubusercontent.com/kubernetes/dashboard/v0-beta5/aio/deploy/recommended.yaml\n$ vi recommended.yaml\n# \u4fee\u6539Service\u4e3aNodePort\u7c7b\u578b\n......\nkind: Service\napiVersion: v1\nmetadata:\n  labels:\n    k8s-app: kubernetes-dashboard\n  name: kubernetes-dashboard\n  namespace: kubernetes-dashboard\nspec:\n  ports:\n    - port: 443\n      targetPort: 8443\n  selector:\n    k8s-app: kubernetes-dashboard\n  type: NodePort  # \u52a0\u4e0atype=NodePort\u53d8\u6210NodePort\u7c7b\u578b\u7684\u670d\u52a1\n......\n</code></pre> <p>\u76d1\u63a7\u7ec4\u4ef6</p> <p>\u5728 YAML \u6587\u4ef6\u4e2d\u53ef\u4ee5\u770b\u5230\u65b0\u7248\u672c Dashboard \u96c6\u6210\u4e86\u4e00\u4e2a metrics-scraper \u7684\u7ec4\u4ef6\uff0c\u53ef\u4ee5\u901a\u8fc7 Kubernetes \u7684 Metrics API \u6536\u96c6\u4e00\u4e9b\u57fa\u7840\u8d44\u6e90\u7684\u76d1\u63a7\u4fe1\u606f\uff0c\u5e76\u5728 web \u9875\u9762\u4e0a\u5c55\u793a\uff0c\u6240\u4ee5\u8981\u60f3\u5728\u9875\u9762\u4e0a\u5c55\u793a\u76d1\u63a7\u4fe1\u606f\u5c31\u9700\u8981\u63d0\u4f9b Metrics API\uff0c\u6bd4\u5982\u5b89\u88c5 Metrics Server\u3002</p> <p>\u76f4\u63a5\u521b\u5efa\uff1a</p> <pre><code>$ kubectl apply -f recommended.yaml\n</code></pre> <p>\u65b0\u7248\u672c\u7684 Dashboard \u4f1a\u88ab\u9ed8\u8ba4\u5b89\u88c5\u5728 kubernetes-dashboard \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\uff1a</p> <pre><code>$ kubectl get pods -n kubernetes-dashboard -l k8s-app=kubernetes-dashboard\nNAME                                  READY   STATUS    RESTARTS   AGE\nkubernetes-dashboard-fcfb4cbc-t462n   1/1     Running   0          50m\n$ kubectl get svc -n kubernetes-dashboard\nNAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE\ndashboard-metrics-scraper   ClusterIP   11146   &lt;none&gt;        8000/TCP       21s\nkubernetes-dashboard        NodePort    12187   &lt;none&gt;        443:30750/TCP   22s\n</code></pre> <p>\u7136\u540e\u53ef\u4ee5\u901a\u8fc7\u4e0a\u9762\u7684 30750 \u7aef\u53e3\u53bb\u8bbf\u95ee Dashboard\uff0c\u8981\u8bb0\u4f4f\u4f7f\u7528 https\uff0cChrome \u4e0d\u751f\u6548\u53ef\u4ee5\u4f7f\u7528<code>Firefox</code> \u6d4b\u8bd5\uff0c\u5982\u679c\u6ca1\u6709 Firefox \u4e0b\u9762\u6253\u4e0d\u5f00\u9875\u9762\uff0c\u53ef\u4ee5\u70b9\u51fb\u4e0b\u9875\u9762\u4e2d\u7684<code>\u4fe1\u4efb\u8bc1\u4e66</code>\u5373\u53ef\uff1a</p> <p></p> <p>\u4fe1\u4efb\u540e\u5c31\u53ef\u4ee5\u8bbf\u95ee\u5230 Dashboard \u7684\u767b\u5f55\u9875\u9762\u4e86\uff1a</p> <p></p> <p>\u7136\u540e\u521b\u5efa\u4e00\u4e2a\u5177\u6709\u5168\u5c40\u6240\u6709\u6743\u9650\u7684\u7528\u6237\u6765\u767b\u5f55Dashboard\uff1a(admin.yaml)</p> <pre><code>kind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1beta1\nmetadata:\n  name: admin\n  annotations:\n    rbac.authorization.kubernetes.io/autoupdate: \"true\"\nroleRef:\n  kind: ClusterRole\n  name: cluster-admin\n  apiGroup: rbac.authorization.k8s.io\nsubjects:\n- kind: ServiceAccount\n  name: admin\n  namespace: kubernetes-dashboard\n\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: admin\n  namespace: kubernetes-dashboard\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\uff1a</p> <pre><code>$ kubectl apply -f admin.yaml\n$ kubectl get secret -n kubernetes-dashboard|grep admin-token\nadmin-token-lwmmx                  kubernetes.io/service-account-token   3         1d\n$ kubectl get secret admin-token-lwmmx -o jsonpath={.data.token} -n kubernetes-dashboard |base64 -d# \u4f1a\u751f\u6210\u4e00\u4e32\u5f88\u957f\u7684base64\u540e\u7684\u5b57\u7b26\u4e32\n</code></pre> <p>\u7136\u540e\u7528\u4e0a\u9762\u7684 base64 \u89e3\u7801\u540e\u7684\u5b57\u7b26\u4e32\u4f5c\u4e3a token \u767b\u5f55 Dashboard \u5373\u53ef\uff0c\u65b0\u7248\u672c\u8fd8\u65b0\u589e\u4e86\u4e00\u4e2a\u6697\u9ed1\u6a21\u5f0f\uff1a</p> <p></p> <p>\u6700\u7ec8\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u4f7f\u7528 kubeadm \u642d\u5efa v1.16.2 \u7248\u672c\u7684 kubernetes \u96c6\u7fa4\u3001coredns\u3001ipvs\u3001flannel\u3002</p>"},{"location":"kubernetes_basic/install/#_5","title":"\u6e05\u7406","text":"<p>\u5982\u679c\u4f60\u7684\u96c6\u7fa4\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u9047\u5230\u4e86\u5176\u4ed6\u95ee\u9898\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u8fdb\u884c\u91cd\u7f6e\uff1a</p> <pre><code>$ kubeadm reset\n$ ifconfig cni0 down &amp;&amp; ip link delete cni0\n$ ifconfig flannel.1 down &amp;&amp; ip link delete flannel.1\n$ rm -rf /var/lib/cni/\n</code></pre>"},{"location":"kubernetes_basic/overview/","title":"\u7b80\u4ecb","text":""},{"location":"kubernetes_basic/overview/#_1","title":"\u7b80\u4ecb","text":"<p>Kubernetes \u57fa\u672c\u6982\u5ff5\u4e0e\u7ec4\u4ef6</p> <p>Kubernetes\uff08\u7b80\u79f0 K8S\uff09 \u7684\u51fa\u73b0\u662f\u5bb9\u5668\u5316\u6280\u672f\u53d1\u5c55\u7684\u5fc5\u7136\u7ed3\u679c\uff0c<code>\u5bb9\u5668\u5316</code>\u662f\u5e94\u7528\u7a0b\u5e8f\u7ea7\u522b\u7684\u865a\u62df\u5316\uff0c\u8fd0\u884c\u5355\u4e2a\u5185\u6838\u4e0a\u6709\u591a\u4e2a\u72ec\u7acb\u7684\u7528\u6237\u7a7a\u95f4\u5b9e\u4f8b\uff0c\u8fd9\u4e9b\u5b9e\u4f8b\u5c31\u662f\u5bb9\u5668\uff1b<code>\u5bb9\u5668</code>\u63d0\u4f9b\u4e86\u5c06\u5e94\u7528\u7a0b\u5e8f\u7684\u4ee3\u7801\u3001\u8fd0\u884c\u65f6\u3001\u7cfb\u7edf\u5de5\u5177\u3001\u7cfb\u7edf\u5e93\u548c\u914d\u7f6e\u6253\u5305\u5230\u4e00\u4e2a\u5b9e\u4f8b\u4e2d\u7684\u6807\u51c6\u65b9\u6cd5\uff0c\u800c\u4e14\u5bb9\u5668\u662f\u5171\u4eab\u4e00\u4e2a\u5185\u6838\u7684\uff1b\u7531\u4e8e\u5bb9\u5668\u6280\u672f\u7684\u5174\u8d77\uff0c\u5bfc\u81f4\u5927\u91cf\u7684\u5bb9\u5668\u5e94\u7528\u51fa\u73b0\uff0c\u6240\u4ee5\u5c31\u51fa\u73b0\u4e86\u4e00\u4e9b\u7528\u6765\u652f\u6301\u5e94\u7528\u7a0b\u5e8f\u5bb9\u5668\u5316\u90e8\u7f72\u548c\u7ec4\u7ec7\u7684<code>\u5bb9\u5668\u7f16\u6392</code>\u6280\u672f\uff0c\u4e00\u4e9b\u6d41\u884c\u7684\u5f00\u6e90\u5bb9\u5668\u7f16\u6392\u5de5\u5177\u6709 Docker Swarm\u3001Kubernetes \u7b49\uff0c\u4f46\u662f\u5728\u53d1\u5c55\u8fc7\u7a0b\u4e2d Kubernetes \u73b0\u5728\u5df2\u7ecf\u6210\u4e3a\u4e86\u5bb9\u5668\u7f16\u6392\u9886\u57df\u4e8b\u5b9e\u4e0a\u7684\u4e00\u4e2a\u6807\u51c6\u4e86\u3002</p> <p></p> <p>Kubernetes \u662f Google \u56e2\u961f\u53d1\u8d77\u7684\u4e00\u4e2a\u5f00\u6e90\u9879\u76ee\uff0c\u5b83\u7684\u76ee\u6807\u662f\u7ba1\u7406\u8de8\u591a\u4e2a\u4e3b\u673a\u7684\u5bb9\u5668\uff0c\u7528\u4e8e\u81ea\u52a8\u90e8\u7f72\u3001\u6269\u5c55\u548c\u7ba1\u7406\u5bb9\u5668\u5316\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u4e3b\u8981\u5b9e\u73b0\u8bed\u8a00\u4e3a Go \u8bed\u8a00\uff0c\u4ed6\u7684\u7406\u8bba\u57fa\u7840\u6765\u6e90\u4e0e Google \u5185\u90e8\u7684 Borg \u9879\u76ee\uff0c\u6240\u4ee5 Kubernetes \u9879\u76ee\u7684\u7406\u8bba\u57fa\u7840\u5c31\u6bd4\u5176\u4ed6\u5f00\u6e90\u9879\u76ee\u8981\u5148\u8fdb\u5f88\u591a\uff0c\u56e0\u4e3a Borg \u7cfb\u7edf\u4e00\u76f4\u4f9d\u8d56\u5c31\u88ab\u79f0\u4e3a Google \u516c\u53f8\u5185\u90e8\u6700\u5f3a\u5927\u7684\u79c1\u5bc6\u6b66\u5668\u3002</p>"},{"location":"kubernetes_basic/overview/#_2","title":"\u67b6\u6784","text":"<p>Kubernetes \u9879\u76ee\u4f9d\u6258\u7740 Borg \u9879\u76ee\u7684\u7406\u8bba\u4f18\u52bf\uff0c\u786e\u5b9a\u4e86\u4e00\u4e2a\u5982\u4e0b\u56fe\u6240\u793a\u7684\u5168\u5c40\u67b6\u6784\u56fe\uff1a</p> <p></p> <p>\u4ece\u4e0a\u9762\u6211\u4eec\u53ef\u4ee5\u770b\u51fa Kubernetes \u7531 Master \u548c Node \u4e24\u79cd\u8282\u70b9\u7ec4\u6210\uff0c\u8fd9\u4e24\u79cd\u89d2\u8272\u5206\u522b\u5bf9\u5e94\u7740\u63a7\u5236\u8282\u70b9\u548c\u5de5\u4f5c\u8282\u70b9\uff08\u53ef\u4ee5\u7406\u89e3\u4e3a\u8001\u677f\u548c\u5458\u5de5\uff09\u3002</p> <p>\u5176\u4e2d Master \u8282\u70b9\u7531\u4e09\u4e2a\u72ec\u7acb\u7684\u7ec4\u4ef6\u7ec4\u6210\uff0c\u5b83\u4eec\u5206\u522b\u662f\u8d1f\u8d23\u6574\u4e2a\u96c6\u7fa4\u901a\u4fe1\u7684 API \u670d\u52a1\u7684 <code>kube-apiserver</code>\u3001\u8d1f\u8d23\u5bb9\u5668\u8c03\u5ea6\u7684 <code>kube-scheduler</code> \u4ee5\u53ca\u8d1f\u8d23\u7ef4\u62a4\u96c6\u7fa4\u72b6\u6001\u7684 </p> <pre><code>kube-controller-manager\n</code></pre> <p>\u7ec4\u4ef6\u3002\u6574\u4e2a\u96c6\u7fa4\u7684\u6570\u636e\u90fd\u662f\u901a\u8fc7 kube-apiserver \u4fdd\u5b58\u5230 etcd \u6570\u636e\u5e93\u4e2d\u7684\uff0c\u800c\u5176\u4ed6\u6240\u6709\u7ec4\u4ef6\u7684\u901a\u4fe1\u4e5f\u90fd\u662f\u901a\u8fc7 kube-apiserver \u548c etcd \u6570\u636e\u5e93\u8fdb\u884c\u901a\u4fe1\u7684\uff0c\u90fd\u4e0d\u4f1a\u76f4\u63a5\u548c etcd \u8fdb\u884c\u901a\u4fe1\u3002</p> <p>\u5de5\u4f5c\u8282\u70b9\u4e0a\u6700\u6838\u5fc3\u7684\u7ec4\u4ef6\u5c31\u662f <code>kubelet</code>\uff0c\u5f53\u7136\u8fd8\u6709\u5e95\u5c42\u7684\u5bb9\u5668\u8fd0\u884c\u65f6\uff0c\u6bd4\u5982 Docker\uff0c\u5176\u4e2d kubelet \u5c31\u662f\u4e3b\u8981\u6765\u5b9e\u73b0\u548c\u5e95\u5c42\u7684\u5bb9\u5668\u8fd0\u884c\u65f6\u8fdb\u884c\u901a\u4fe1\u7684\uff0c\u8fd9\u4e2a\u901a\u4fe1\u7684\u8fc7\u7a0b\u4e5f\u88ab Kubernetes \u62bd\u8c61\u6210\u4e86\u4e00\u4e2a <code>CRI</code>\uff08Container Runtime Interface\uff09\u7684\u8fdc\u7a0b\u8c03\u7528\u63a5\u53e3\uff0c\u8fd9\u4e2a\u63a5\u53e3\u91cc\u9762\u5b9a\u4e49\u4e86\u5bb9\u5668\u8fd0\u884c\u65f6\u7684\u6240\u6709\u6807\u51c6\u64cd\u4f5c\uff0c\u6bd4\u5982\u521b\u5efa\u5bb9\u5668\u3001\u5220\u9664\u5bb9\u5668\u7b49\u7b49\uff0c\u53ea\u662f\u76ee\u524d kubelet \u91cc\u9762\u5185\u7f6e\u4e86 Docker \u5173\u4e8e\u8fd9\u4e2a CRI \u5b9e\u73b0\u7684\u4e00\u4e2a shim\uff0c\u6240\u4ee5\u5982\u679c\u6211\u4eec\u5e95\u5c42\u662f Docker \u5bb9\u5668\u7684\u8bdd\u5c31\u4e0d\u9700\u8981\u5355\u72ec\u5b89\u88c5\u8fd9\u4e2a CRI \u7684\u5b9e\u73b0\u7684\u7ec4\u4ef6\u4e86\u3002\u5176\u4ed6\u7684\u5bb9\u5668\u8fd0\u884c\u65f6\u662f\u9700\u8981\u63d0\u4f9b\u8fd9\u6837\u7684\u4e00\u4e2a\u63a5\u53e3\u5b9e\u73b0\u7ec4\u4ef6\u7684\u3002\u6240\u4ee5\u5bf9\u4e8e Kubernetes \u6765\u8bf4\u4ed6\u6839\u672c\u4e0d\u5173\u5fc3\u4f60\u90e8\u7f72\u7684\u5230\u5e95\u662f\u4ec0\u4e48\u5bb9\u5668\u8fd0\u884c\u65f6\uff0c\u53ea\u8981\u4f60\u8fd9\u4e2a\u5bb9\u5668\u8fd0\u884c\u65f6\u53ef\u4ee5\u5b9e\u73b0 CRI \u63a5\u53e3\u5c31\u53ef\u4ee5\u88ab Kubernetes \u6765\u7ba1\u7406\u3002</p> <p>kubelet \u7684\u53e6\u5916\u4e00\u4e2a\u91cd\u8981\u529f\u80fd\u5c31\u662f\u8c03\u7528\u7f51\u7edc\u63d2\u4ef6\uff08<code>CNI</code>\uff09\u548c\u5b58\u50a8\u63d2\u4ef6\uff08<code>CSI</code>\uff09\u4e3a\u5bb9\u5668\u914d\u7f6e\u7f51\u7edc\u548c\u5b58\u50a8\u529f\u80fd\uff0c\u540c\u6837\u7684 kubelet \u4e5f\u662f\u628a\u8fd9\u4e24\u4e2a\u91cd\u8981\u529f\u80fd\u901a\u8fc7\u63a5\u53e3\u66b4\u9732\u7ed9\u5916\u90e8\u4e86\uff0c\u6240\u4ee5\u5982\u679c\u6211\u4eec\u60f3\u8981\u5b9e\u73b0\u81ea\u5df1\u7684\u7f51\u7edc\u63d2\u4ef6\uff0c\u53ea\u9700\u8981\u4f7f\u7528 CNI \u5c31\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u5bf9\u63a5\u5230 Kubernetes \u96c6\u7fa4\u5f53\u4e2d\u53bb\u3002</p> <p>\u53ef\u80fd\u4e0b\u9762\u7684\u67b6\u6784\u56fe\u770b\u4e0a\u53bb\u66f4\u6e05\u6670\u4e00\u4e9b\uff1a</p> <p></p>"},{"location":"kubernetes_basic/overview/#_3","title":"\u7ec4\u4ef6","text":"<p>\u4e0a\u9762\u6211\u4ecb\u7ecd\u4e86 Kubernetes \u96c6\u7fa4\u7684\u6574\u4f53\u67b6\u6784\uff0c\u4e0b\u9762\u6211\u4eec\u518d\u6765\u66f4\u52a0\u8be6\u7ec6\u7684\u4e86\u89e3\u4e0b\u8fd9\u4e9b\u7ec4\u4ef6\u7684\u529f\u80fd\u3002</p>"},{"location":"kubernetes_basic/overview/#kube-apiserver","title":"kube-apiserver","text":"<p>API Server \u63d0\u4f9b\u4e86\u8d44\u6e90\u5bf9\u8c61\u7684\u552f\u4e00\u64cd\u4f5c\u5165\u53e3\uff0c\u5176\u5b83\u6240\u6709\u7ec4\u4ef6\u90fd\u5fc5\u987b\u901a\u8fc7\u5b83\u63d0\u4f9b\u7684 API \u6765\u64cd\u4f5c\u8d44\u6e90\u6570\u636e\u3002<code>\u53ea\u6709 API Server \u4f1a\u4e0e etcd \u8fdb\u884c\u901a\u4fe1\uff0c\u5176\u5b83\u6a21\u5757\u90fd\u5fc5\u987b\u901a\u8fc7 API Server \u8bbf\u95ee\u96c6\u7fa4\u72b6\u6001</code>\u3002API Server \u4f5c\u4e3a Kubernetes \u7cfb\u7edf\u7684\u5165\u53e3\uff0c\u5c01\u88c5\u4e86\u6838\u5fc3\u5bf9\u8c61\u7684\u589e\u5220\u6539\u67e5\u64cd\u4f5c\u3002API Server \u4ee5 RESTFul \u63a5\u53e3\u65b9\u5f0f\u63d0\u4f9b\u7ed9\u5916\u90e8\u5ba2\u6237\u7aef\u548c\u5185\u90e8\u7ec4\u4ef6\u8c03\u7528\uff0cAPI Server \u518d\u5bf9\u76f8\u5173\u7684\u8d44\u6e90\u6570\u636e\uff08<code>\u5168\u91cf\u67e5\u8be2 + \u53d8\u5316\u76d1\u542c</code>\uff09\u8fdb\u884c\u64cd\u4f5c\uff0c\u4ee5\u8fbe\u5230\u5b9e\u65f6\u5b8c\u6210\u76f8\u5173\u7684\u4e1a\u52a1\u529f\u80fd\u3002\u4ee5 API Server \u4e3a Kubernetes \u5165\u53e3\u7684\u8bbe\u8ba1\u4e3b\u8981\u6709\u4ee5\u4e0b\u597d\u5904\uff1a</p> <ul> <li>\u4fdd\u8bc1\u4e86\u96c6\u7fa4\u72b6\u6001\u8bbf\u95ee\u7684\u5b89\u5168</li> <li>API Server \u9694\u79bb\u4e86\u96c6\u7fa4\u72b6\u6001\u8bbf\u95ee\u548c\u540e\u7aef\u5b58\u50a8\u5b9e\u73b0\uff0c\u8fd9\u6837 API Server \u72b6\u6001\u8bbf\u95ee\u7684\u65b9\u5f0f\u4e0d\u4f1a\u56e0\u4e3a\u540e\u7aef\u5b58\u50a8\u6280\u672f Etcd \u7684\u6539\u53d8\u800c\u6539\u53d8\uff0c\u8ba9\u540e\u7aef\u5b58\u50a8\u65b9\u5f0f\u9009\u62e9\u66f4\u52a0\u7075\u6d3b\uff0c\u65b9\u4fbf\u4e86\u6574\u4e2a\u67b6\u6784\u7684\u6269\u5c55</li> </ul>"},{"location":"kubernetes_basic/overview/#kube-controller-manager","title":"kube-controller-manager","text":"<p>Controller Manager \u7528\u4e8e\u5b9e\u73b0 Kubernetes \u96c6\u7fa4\u6545\u969c\u68c0\u6d4b\u548c\u6062\u590d\u7684\u81ea\u52a8\u5316\u5de5\u4f5c\u3002\u4e3b\u8981\u8d1f\u8d23\u6267\u884c\u5404\u79cd\u63a7\u5236\u5668\uff1a</p> <ul> <li>Replication Controller\uff1a\u4e3b\u8981\u662f\u5b9a\u671f\u5173\u8054 Replication Controller (RC) \u548c Pod\uff0c\u4ee5\u4fdd\u8bc1\u96c6\u7fa4\u4e2d\u4e00\u4e2a RC (\u4e00\u79cd\u8d44\u6e90\u5bf9\u8c61) \u6240\u5173\u8054\u7684 Pod \u526f\u672c\u6570\u59cb\u7ec8\u4fdd\u6301\u4e3a\u4e0e\u9884\u8bbe\u503c\u4e00\u81f4\u3002</li> <li>Node Controller\uff1aKubelet \u5728\u542f\u52a8\u65f6\u4f1a\u901a\u8fc7 API Server \u6ce8\u518c\u81ea\u8eab\u7684\u8282\u70b9\u4fe1\u606f\uff0c\u5e76\u5b9a\u65f6\u5411 API Server \u6c47\u62a5\u72b6\u6001\u4fe1\u606f\u3002API Server \u5728\u63a5\u6536\u5230\u4fe1\u606f\u540e\u5c06\u4fe1\u606f\u66f4\u65b0\u5230 Etcd \u4e2d\u3002Node Controller \u901a\u8fc7 API Server \u5b9e\u65f6\u83b7\u53d6 Node \u7684\u76f8\u5173\u4fe1\u606f\uff0c\u5b9e\u73b0\u7ba1\u7406\u548c\u76d1\u63a7\u96c6\u7fa4\u4e2d\u7684\u5404\u4e2a Node \u8282\u70b9\u7684\u76f8\u5173\u63a7\u5236\u529f\u80fd\u3002</li> <li>ResourceQuota Controller\uff1a\u8d44\u6e90\u914d\u989d\u7ba1\u7406\u63a7\u5236\u5668\u7528\u4e8e\u786e\u4fdd\u6307\u5b9a\u7684\u8d44\u6e90\u5bf9\u8c61\u5728\u4efb\u4f55\u65f6\u5019\u90fd\u4e0d\u4f1a\u8d85\u91cf\u5360\u7528\u7cfb\u7edf\u4e0a\u7269\u7406\u8d44\u6e90\u3002</li> <li>Namespace Controller\uff1a\u7528\u6237\u901a\u8fc7 API Server \u53ef\u4ee5\u521b\u5efa\u65b0\u7684 Namespace \u5e76\u4fdd\u5b58\u5728 Etcd \u4e2d\uff0cNamespace Controller \u5b9a\u65f6\u901a\u8fc7 API Server \u8bfb\u53d6\u8fd9\u4e9b Namespace \u4fe1\u606f\u6765\u64cd\u4f5c Namespace\u3002\u6bd4\u5982\uff1aNamespace \u88ab API \u6807\u8bb0\u4e3a\u4f18\u96c5\u5220\u9664\uff0c\u5219\u5c06\u8be5 Namespace \u72b6\u6001\u8bbe\u7f6e\u4e3a Terminating \u5e76\u4fdd\u5b58\u5230 Etcd \u4e2d\u3002\u540c\u65f6 Namespace Controller \u5220\u9664\u8be5 Namespace \u4e0b\u7684 ServiceAccount\u3001Deployment\u3001Pod \u7b49\u8d44\u6e90\u5bf9\u8c61\u3002</li> <li>Service Account Controller\uff1a\u670d\u52a1\u8d26\u53f7\u63a7\u5236\u5668\u4e3b\u8981\u5728\u547d\u540d\u7a7a\u95f4\u5185\u7ba1\u7406 ServiceAccount\uff0c\u4ee5\u4fdd\u8bc1\u540d\u4e3a default \u7684 ServiceAccount \u5728\u6bcf\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u5b58\u5728\u3002</li> <li>Token Controller\uff1a\u4ee4\u724c\u63a7\u5236\u5668\u4f5c\u4e3a Controller Manager \u7684\u4e00\u90e8\u5206\uff0c\u4e3b\u8981\u7528\u4f5c\uff1a\u76d1\u542c serviceAccount \u7684\u521b\u5efa\u548c\u5220\u9664\u52a8\u4f5c\u4ee5\u53ca\u76d1\u542c secret \u7684\u6dfb\u52a0\u3001\u5220\u9664\u52a8\u4f5c\u3002</li> <li>Service Controller\uff1a\u670d\u52a1\u63a7\u5236\u5668\u4e3b\u8981\u7528\u4f5c\u76d1\u542c Service \u7684\u53d8\u5316\u3002\u6bd4\u5982\uff1a\u521b\u5efa\u7684\u662f\u4e00\u4e2a LoadBalancer \u7c7b\u578b\u7684 Service\uff0cService Controller \u5219\u8981\u786e\u4fdd\u5916\u90e8\u7684\u4e91\u5e73\u53f0\u4e0a\u5bf9\u8be5 Service \u5bf9\u5e94\u7684 LoadBalancer \u5b9e\u4f8b\u88ab\u521b\u5efa\u3001\u5220\u9664\u4ee5\u53ca\u76f8\u5e94\u7684\u8def\u7531\u8f6c\u53d1\u8868\u88ab\u66f4\u65b0\u3002</li> <li>Endpoint Controller\uff1aEndpoints \u8868\u793a\u4e86\u4e00\u4e2a Service \u5bf9\u5e94\u7684\u6240\u6709 Pod \u526f\u672c\u7684\u8bbf\u95ee\u5730\u5740\uff0c\u800c Endpoints Controller \u662f\u8d1f\u8d23\u751f\u6210\u548c\u7ef4\u62a4\u6240\u6709 Endpoints \u5bf9\u8c61\u7684\u63a7\u5236\u5668\u3002Endpoint Controller \u8d1f\u8d23\u76d1\u542c Service \u548c\u5bf9\u5e94\u7684 Pod \u526f\u672c\u7684\u53d8\u5316\u3002\u5b9a\u671f\u5173\u8054 Service \u548c Pod (\u5173\u8054\u4fe1\u606f\u7531 Endpoint \u5bf9\u8c61\u7ef4\u62a4)\uff0c\u4ee5\u4fdd\u8bc1 Service \u5230 Pod \u7684\u6620\u5c04\u603b\u662f\u6700\u65b0\u7684\u3002</li> </ul>"},{"location":"kubernetes_basic/overview/#kube-scheduler","title":"kube-scheduler","text":"<p>Scheduler \u662f\u8d1f\u8d23\u6574\u4e2a\u96c6\u7fa4\u7684\u8d44\u6e90\u8c03\u5ea6\u7684\uff0c\u4e3b\u8981\u7684\u804c\u8d23\u5982\u4e0b\u6240\u793a\uff1a</p> <ul> <li>\u4e3b\u8981\u7528\u4e8e\u6536\u96c6\u548c\u5206\u6790\u5f53\u524d Kubernetes \u96c6\u7fa4\u4e2d\u6240\u6709 Node \u8282\u70b9\u7684\u8d44\u6e90 (\u5305\u62ec\u5185\u5b58\u3001CPU \u7b49) \u8d1f\u8f7d\u60c5\u51b5\uff0c\u7136\u540e\u4f9d\u636e\u8d44\u6e90\u5360\u7528\u60c5\u51b5\u5206\u53d1\u65b0\u5efa\u7684 Pod \u5230 Kubernetes \u96c6\u7fa4\u4e2d\u53ef\u7528\u7684\u8282\u70b9</li> <li>\u5b9e\u65f6\u76d1\u6d4b Kubernetes \u96c6\u7fa4\u4e2d\u672a\u5206\u53d1\u548c\u5df2\u5206\u53d1\u7684\u6240\u6709\u8fd0\u884c\u7684 Pod</li> <li>\u5b9e\u65f6\u76d1\u6d4b Node \u8282\u70b9\u4fe1\u606f\uff0c\u7531\u4e8e\u4f1a\u9891\u7e41\u67e5\u627e Node \u8282\u70b9\uff0c\u6240\u4ee5 Scheduler \u540c\u65f6\u4f1a\u7f13\u5b58\u4e00\u4efd\u6700\u65b0\u7684\u4fe1\u606f\u5728\u672c\u5730</li> <li>\u5728\u5206\u53d1 Pod \u5230\u6307\u5b9a\u7684 Node \u8282\u70b9\u540e\uff0c\u4f1a\u628a Pod \u76f8\u5173\u7684 Binding \u4fe1\u606f\u5199\u56de API Server\uff0c\u4ee5\u65b9\u4fbf\u5176\u5b83\u7ec4\u4ef6\u4f7f\u7528</li> </ul>"},{"location":"kubernetes_basic/overview/#kubelet","title":"kubelet","text":"<p>kubelet \u662f\u8d1f\u8d23\u5bb9\u5668\u771f\u6b63\u8fd0\u884c\u7684\u6838\u5fc3\u7ec4\u4ef6\uff0c\u4e3b\u8981\u7684\u804c\u8d23\u5982\u4e0b\u6240\u793a\uff1a</p> <ul> <li>\u8d1f\u8d23 Node \u8282\u70b9\u4e0a Pod \u7684\u521b\u5efa\u3001\u4fee\u6539\u3001\u76d1\u63a7\u3001\u5220\u9664\u7b49\u5168\u751f\u547d\u5468\u671f\u7684\u7ba1\u7406</li> <li>\u5b9a\u65f6\u4e0a\u62a5\u672c\u5730 Node \u7684\u72b6\u6001\u4fe1\u606f\u7ed9 API Server</li> <li>kubelet \u662f Master \u548c Node \u4e4b\u95f4\u7684\u6865\u6881\uff0c\u63a5\u6536 API Server \u5206\u914d\u7ed9\u5b83\u7684\u4efb\u52a1\u5e76\u6267\u884c</li> <li>kubelet \u901a\u8fc7 API Server \u95f4\u63a5\u4e0e Etcd \u96c6\u7fa4\u4ea4\u4e92\u6765\u8bfb\u53d6\u96c6\u7fa4\u914d\u7f6e\u4fe1\u606f</li> <li>kubelet \u5728 Node \u4e0a\u505a\u7684\u4e3b\u8981\u5de5\u4f5c\u5177\u4f53\u5982\u4e0b\uff1a<ol> <li>\u8bbe\u7f6e\u5bb9\u5668\u7684\u73af\u5883\u53d8\u91cf\u3001\u7ed9\u5bb9\u5668\u7ed1\u5b9a Volume\u3001\u7ed9\u5bb9\u5668\u7ed1\u5b9a Port\u3001\u6839\u636e\u6307\u5b9a\u7684 Pod \u8fd0\u884c\u4e00\u4e2a\u5355\u4e00\u5bb9\u5668\u3001\u7ed9\u6307\u5b9a\u7684 Pod \u521b\u5efa Network \u5bb9\u5668</li> <li>\u540c\u6b65 Pod \u7684\u72b6\u6001</li> <li>\u5728\u5bb9\u5668\u4e2d\u8fd0\u884c\u547d\u4ee4\u3001\u6740\u6b7b\u5bb9\u5668\u3001\u5220\u9664 Pod \u7684\u6240\u6709\u5bb9\u5668</li> </ol> </li> </ul> <p>\u6e90\u7801</p> <p>\u5bf9\u6e90\u7801\u611f\u5174\u8da3\u7684\u53ef\u4ee5\u67e5\u770b Kubelet \u6e90\u7801\u90e8\u5206\u7684\u89e3\u6790\uff1akubelet \u6e90\u7801\u6d45\u6790</p>"},{"location":"kubernetes_basic/overview/#kube-proxy","title":"kube-proxy","text":"<p>kube-proxy \u662f\u4e3a\u4e86\u89e3\u51b3\u5916\u90e8\u7f51\u7edc\u80fd\u591f\u8bbf\u95ee\u96c6\u7fa4\u4e2d\u5bb9\u5668\u63d0\u4f9b\u7684\u5e94\u7528\u670d\u52a1\u800c\u8bbe\u8ba1\u7684\uff0cProxy \u8fd0\u884c\u5728\u6bcf\u4e2aNode \u4e0a\u3002</p> <p>\u6bcf\u521b\u5efa\u4e00\u4e2a Service\uff0ckube-proxy \u5c31\u4f1a\u4ece API Server \u83b7\u53d6 Services \u548c Endpoints \u7684\u914d\u7f6e\u4fe1\u606f\uff0c\u7136\u540e\u6839\u636e\u5176\u914d\u7f6e\u4fe1\u606f\u5728 Node \u4e0a\u542f\u52a8\u4e00\u4e2a Proxy \u7684\u8fdb\u7a0b\u5e76\u76d1\u542c\u76f8\u5e94\u7684\u670d\u52a1\u7aef\u53e3\u3002</p> <p>\u5f53\u63a5\u6536\u5230\u5916\u90e8\u8bf7\u6c42\u65f6\uff0ckube-proxy \u4f1a\u6839\u636e Load Balancer \u5c06\u8bf7\u6c42\u5206\u53d1\u5230\u540e\u7aef\u6b63\u786e\u7684\u5bb9\u5668\u5904\u7406\u3002</p> <p>kube-proxy \u4e0d\u4f46\u89e3\u51b3\u4e86\u540c\u4e00\u5bbf\u4e3b\u673a\u76f8\u540c\u670d\u52a1\u7aef\u53e3\u51b2\u7a81\u7684\u95ee\u9898\uff0c\u8fd8\u63d0\u4f9b\u4e86 Service \u8f6c\u53d1\u670d\u52a1\u7aef\u53e3\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\u7684\u80fd\u529b\u3002</p> <p>kube-proxy \u540e\u7aef\u4f7f\u7528<code>\u968f\u673a\u3001\u8f6e\u5faa</code>\u7b49\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5\u8fdb\u884c\u8c03\u5ea6\u3002</p>"},{"location":"kubernetes_basic/overview/#kubectl","title":"kubectl","text":"<p>Kubectl \u662f Kubernetes \u7684\u96c6\u7fa4\u7ba1\u7406\u547d\u4ee4\u884c\u5ba2\u6237\u7aef\u5de5\u5177\u96c6\u3002\u901a\u8fc7 Kubectl \u547d\u4ee4\u5bf9 API Server \u8fdb\u884c\u64cd\u4f5c\uff0cAPI Server \u54cd\u5e94\u5e76\u8fd4\u56de\u5bf9\u5e94\u7684\u547d\u4ee4\u7ed3\u679c\uff0c\u4ece\u800c\u8fbe\u5230\u5bf9 Kubernetes \u96c6\u7fa4\u7684\u7ba1\u7406</p>"},{"location":"kubernetes_basic/overview/#_4","title":"\u6838\u5fc3\u8d44\u6e90\u5bf9\u8c61","text":"<p>\u4e0a\u9762\u6211\u4eec\u90fd\u662f\u5728\u67b6\u6784\u5c42\u9762\u4e86\u89e3 Kubernetes\uff0c\u4f46\u662f\u4f3c\u4e4e\u6ca1\u6709\u53d1\u73b0\u5173\u4e8e\u5bb9\u5668\u7684\u8bf4\u660e\uff0cKubernetes \u4f5c\u4e3a\u5bb9\u5668\u7f16\u6392\u5f15\u64ce\uff0c\u90a3\u4e48\u4ed6\u662f\u600e\u4e48\u53bb\u5bf9\u5bb9\u5668\u8fdb\u884c\u7f16\u6392\u7684\u5462\uff1f\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u62bd\u8c61\u4e86\u5f88\u591a\u96c6\u7fa4\u5185\u90e8\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e9b\u8d44\u6e90\u5bf9\u8c61\u53bb\u64cd\u4f5c\u5bb9\u5668\u7684\u7f16\u6392\u5de5\u4f5c\u3002</p>"},{"location":"kubernetes_basic/overview/#pod","title":"Pod","text":"<p>Pod \u662f\u4e00\u7ec4\u7d27\u5bc6\u5173\u8054\u7684<code>\u5bb9\u5668\u96c6\u5408</code>\uff0c\u5b83\u4eec\u5171\u4eab PID\u3001IPC\u3001Network \u548c UTS namespace\uff0c\u662fKubernetes \u8c03\u5ea6\u7684<code>\u57fa\u672c\u5355\u4f4d</code>\u3002Pod \u7684\u8bbe\u8ba1\u7406\u5ff5\u662f\u652f\u6301\u591a\u4e2a\u5bb9\u5668\u5728\u4e00\u4e2a Pod \u4e2d\u5171\u4eab\u7f51\u7edc\u548c\u6587\u4ef6\u7cfb\u7edf\uff0c\u53ef\u4ee5\u901a\u8fc7\u8fdb\u7a0b\u95f4\u901a\u4fe1\u548c\u6587\u4ef6\u5171\u4eab\u8fd9\u79cd\u7b80\u5355\u9ad8\u6548\u7684\u65b9\u5f0f\u7ec4\u5408\u5b8c\u6210\u670d\u52a1\u3002\u6211\u4eec\u77e5\u9053\u5bb9\u5668\u672c\u8d28\u4e0a\u5c31\u662f\u8fdb\u7a0b\uff0c\u90a3\u4e48 Pod \u5b9e\u9645\u4e0a\u5c31\u662f\u8fdb\u7a0b\u7ec4\u4e86\uff0c\u53ea\u662f\u8fd9\u4e00\u7ec4\u8fdb\u7a0b\u662f\u4f5c\u4e3a\u4e00\u4e2a\u6574\u4f53\u6765\u8fdb\u884c\u8c03\u5ea6\u7684\u3002</p> <p></p> <p>\u5728 Kubernetes \u4e2d\uff0c\u6240\u6709\u8d44\u6e90\u5bf9\u8c61\u90fd\u4f7f\u7528\u8d44\u6e90\u6e05\u5355\uff08yaml\u6216json\uff09\u6765\u5b9a\u4e49\uff0c\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u5b9a\u4e49\u4e00\u4e2a\u7b80\u5355\u7684 nginx \u670d\u52a1\uff0c\u5b83\u5305\u542b\u4e00\u4e2a\u955c\u50cf\u4e3a nginx \u7684\u5bb9\u5668\uff1a(nginx-pod.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:  \n  name: nginx  \n  labels:    \n    app: nginx\nspec:  \n  containers:  \n  - name: nginx    \n    image: nginx    \n    ports:    \n    - containerPort: 80\n</code></pre> <p>\u5b9a\u4e49\u4e86\u8fd9\u6837\u4e00\u4e2a\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5229\u7528\u4e0a\u9762\u6211\u4eec\u63d0\u5230\u7684 Kubectl \u5de5\u5177\u5c06\u8fd9\u4e2a Pod \u521b\u5efa\u5230 Kubernetes \u96c6\u7fa4\u4e2d\uff1a</p> <pre><code>$ kubectl apply -f nginx-pod.yaml\n</code></pre> <p>Pod \u5728 Kubernetes \u96c6\u7fa4\u4e2d\u88ab\u521b\u5efa\u7684\u57fa\u672c\u6d41\u7a0b\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <ul> <li>\u7528\u6237\u901a\u8fc7 REST API \u521b\u5efa\u4e00\u4e2a Pod</li> <li>apiserver \u5c06\u5176\u5199\u5165 etcd</li> <li>scheduluer \u68c0\u6d4b\u5230\u672a\u7ed1\u5b9a Node \u7684 Pod\uff0c\u5f00\u59cb\u8c03\u5ea6\u5e76\u66f4\u65b0 Pod \u7684 Node \u7ed1\u5b9a</li> <li>kubelet \u68c0\u6d4b\u5230\u6709\u65b0\u7684 Pod \u8c03\u5ea6\u8fc7\u6765\uff0c\u901a\u8fc7 container runtime \u8fd0\u884c\u8be5 Pod</li> <li>kubelet \u901a\u8fc7 container runtime \u53d6\u5230 Pod \u72b6\u6001\uff0c\u5e76\u66f4\u65b0\u5230 apiserver \u4e2d</li> </ul>"},{"location":"kubernetes_basic/overview/#label","title":"Label","text":"<p>Label \u6807\u7b7e\u5728 Kubernetes \u8d44\u6e90\u5bf9\u8c61\u4e2d\u4f7f\u7528\u5f88\u591a\uff0c\u4e5f\u662f\u975e\u5e38\u91cd\u8981\u7684\u4e00\u4e2a\u5c5e\u6027\uff0cLabel \u662f\u8bc6\u522b Kubernetes \u5bf9\u8c61\u7684\u6807\u7b7e\uff0c\u4ee5 <code>key/value</code> \u7684\u65b9\u5f0f\u9644\u52a0\u5230\u5bf9\u8c61\u4e0a\uff08key\u6700\u957f\u4e0d\u80fd\u8d85\u8fc763\u5b57\u8282\uff0cvalue \u53ef\u4ee5\u4e3a\u7a7a\uff0c\u4e5f\u53ef\u4ee5\u662f\u4e0d\u8d85\u8fc7253\u5b57\u8282\u7684\u5b57\u7b26\u4e32\uff09\u4e0a\u9762\u6211\u4eec\u5b9a\u4e49\u7684 Nginx \u7684 Pod \u5c31\u6dfb\u52a0\u4e86\u4e00\u4e2a <code>app=nginx</code> \u7684 Label \u6807\u7b7e\u3002Label \u4e0d\u63d0\u4f9b\u552f\u4e00\u6027\uff0c\u5e76\u4e14\u5b9e\u9645\u4e0a\u7ecf\u5e38\u662f\u5f88\u591a\u5bf9\u8c61\uff08\u5982Pods\uff09\u90fd\u4f7f\u7528\u76f8\u540c\u7684 Label \u6765\u6807\u5fd7\u5177\u4f53\u7684\u5e94\u7528\u3002Label \u5b9a\u4e49\u597d\u540e\u5176\u4ed6\u5bf9\u8c61\u53ef\u4ee5\u4f7f\u7528 <code>Label Selector</code> \u6765\u9009\u62e9\u4e00\u7ec4\u76f8\u540c Label \u7684\u5bf9\u8c61\uff08\u6bd4\u5982 Service \u7528 Label \u6765\u9009\u62e9\u4e00\u7ec4 Pod\uff09\u3002Label Selector \u652f\u6301\u4ee5\u4e0b\u51e0\u79cd\u65b9\u5f0f\uff1a</p> <ul> <li>\u7b49\u5f0f\uff0c\u5982 <code>app=nginx</code> \u548c <code>env!=production</code></li> <li> <p>\u96c6\u5408\uff0c\u5982 </p> <pre><code>env in (production, qa)\n</code></pre> </li> <li> <p>\u591a\u4e2a Label\uff08\u5b83\u4eec\u4e4b\u95f4\u662f<code>AND</code>\u5173\u7cfb\uff09\uff0c\u5982<code>app=nginx,env=test</code></p> </li> </ul>"},{"location":"kubernetes_basic/overview/#namespace","title":"Namespace","text":"<p>Namespace\uff08\u547d\u540d\u7a7a\u95f4\uff09\u662f\u5bf9\u4e00\u7ec4\u8d44\u6e90\u548c\u5bf9\u8c61\u7684\u62bd\u8c61\u96c6\u5408\uff0c\u6bd4\u5982\u53ef\u4ee5\u7528\u6765\u5c06\u7cfb\u7edf\u5185\u90e8\u7684\u5bf9\u8c61\u5212\u5206\u4e3a\u4e0d\u540c\u7684\u9879\u76ee\u7ec4\u6216\u7528\u6237\u7ec4\u3002\u5e38\u89c1\u7684 Pods\u3001Services\u3001Deployments \u7b49\u90fd\u662f\u5c5e\u4e8e\u67d0\u4e00\u4e2a Namespace \u7684\uff08\u9ed8\u8ba4\u662fdefault\uff09\uff0c\u6bd4\u5982\u4e0a\u9762\u6211\u4eec\u7684 Nginx Pod \u6ca1\u6709\u6307\u5b9a namespace\uff0c\u5219\u9ed8\u8ba4\u5c31\u5728 default \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\uff0c\u800c Node, PersistentVolumes \u7b49\u8d44\u6e90\u5219\u4e0d\u5c5e\u4e8e\u4efb\u4f55 Namespace\uff0c\u662f\u5168\u5c40\u7684\u3002</p> <p>\u6ce8\u610f\u5b83\u5e76\u4e0d\u662f Linux Namespace\uff0c\u4e8c\u8005\u6ca1\u6709\u4efb\u4f55\u5173\u7cfb\uff0c\u5b83\u53ea\u662f Kubernetes \u5212\u5206\u4e0d\u540c\u5de5\u4f5c\u7a7a\u95f4\u7684\u4e00\u4e2a\u903b\u8f91\u5355\u4f4d\u3002</p>"},{"location":"kubernetes_basic/overview/#deployment","title":"Deployment","text":"<p>\u6211\u4eec\u8bf4\u4e86 Pod \u662f Kubernetes \u96c6\u7fa4\u4e2d\u7684\u6700\u57fa\u672c\u7684\u8c03\u5ea6\u5355\u5143\uff0c\u4f46\u662f\u5982\u679c\u60f3\u8981\u521b\u5efa\u540c\u4e00\u4e2a\u5bb9\u5668\u7684\u591a\u4efd\u62f7\u8d1d\uff0c\u9700\u8981\u4e00\u4e2a\u4e00\u4e2a\u5206\u522b\u521b\u5efa\u51fa\u6765\u4e48\uff0c\u90a3\u4e48\u80fd\u5426\u5c06 Pods \u5212\u5230\u4e00\u4e2a\u903b\u8f91\u7ec4\u91cc\u9762\u5462\uff1fDeployment \u5c31\u662f\u6765\u7ba1\u7406 Pod \u7684\u8d44\u6e90\u5bf9\u8c61\u3002</p> <p>Deployment \u786e\u4fdd\u4efb\u610f\u65f6\u95f4\u90fd\u6709\u6307\u5b9a\u6570\u91cf\u7684 Pod\u526f\u672c\u5728\u8fd0\u884c\u3002\u5982\u679c\u4e3a\u67d0\u4e2a Pod \u521b\u5efa\u4e86 Deployment \u5e76\u4e14\u6307\u5b9a3\u4e2a\u526f\u672c\uff0c\u5b83\u4f1a\u521b\u5efa3\u4e2a Pod\uff0c\u5e76\u4e14\u6301\u7eed\u76d1\u63a7\u5b83\u4eec\u3002\u5982\u679c\u67d0\u4e2a Pod \u4e0d\u54cd\u5e94\uff0c\u90a3\u4e48 Deployment \u4f1a\u66ff\u6362\u5b83\uff0c\u59cb\u7ec8\u4fdd\u6301\u603b\u6570\u4e3a3\u3002</p> <p>\u5982\u679c\u4e4b\u524d\u4e0d\u54cd\u5e94\u7684 Pod \u6062\u590d\u4e86\uff0c\u73b0\u5728\u5c31\u67094\u4e2a Pod \u4e86\uff0c\u90a3\u4e48 Deployment \u4f1a\u5c06\u5176\u4e2d\u4e00\u4e2a\u7ec8\u6b62\u4fdd\u6301\u603b\u6570\u4e3a3\u3002\u5982\u679c\u5728\u8fd0\u884c\u4e2d\u5c06\u526f\u672c\u603b\u6570\u6539\u4e3a5\uff0cDeployment \u4f1a\u7acb\u523b\u542f\u52a82\u4e2a\u65b0 Pod\uff0c\u4fdd\u8bc1\u603b\u6570\u4e3a5\u3002\u6301\u56de\u6eda\u548c\u6eda\u52a8\u5347\u7ea7\u3002</p> <p>\u5f53\u521b\u5efa Deployment \u65f6\uff0c\u9700\u8981\u6307\u5b9a\u4e24\u4e2a\u4e1c\u897f\uff1a</p> <ul> <li>Pod \u6a21\u677f\uff1a\u7528\u6765\u521b\u5efa Pod \u526f\u672c\u7684\u6a21\u677f</li> <li>Label \u6807\u7b7e\uff1aDeployment \u9700\u8981\u76d1\u63a7\u7684 Pod \u7684\u6807\u7b7e\u3002</li> </ul> <p>\u73b0\u5728\u5df2\u7ecf\u521b\u5efa\u4e86 Pod \u7684\u4e00\u4e9b\u526f\u672c\uff0c\u90a3\u4e48\u8fd9\u4e9b\u526f\u672c\u4e0a\u5982\u4f55\u8fdb\u884c\u8d1f\u8f7d\u5462\uff1f\u5982\u4f55\u628a\u8fd9\u4e9b Pod \u66b4\u9732\u51fa\u53bb\u5462\uff1f\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u9700\u8981\u7528\u5230 Service \u8fd9\u79cd\u8d44\u6e90\u5bf9\u8c61\u4e86\u3002</p>"},{"location":"kubernetes_basic/overview/#service","title":"Service","text":"<p>Service \u662f\u5e94\u7528\u670d\u52a1\u7684\u62bd\u8c61\uff0c\u901a\u8fc7 Labels \u4e3a\u5e94\u7528\u63d0\u4f9b<code>\u8d1f\u8f7d\u5747\u8861\u548c\u670d\u52a1\u53d1\u73b0</code>\u3002\u5339\u914d Labels \u7684 Pod IP \u548c\u7aef\u53e3\u5217\u8868\u7ec4\u6210 Endpoints\uff0c\u7531 kube-proxy \u8d1f\u8d23\u5c06\u670d\u52a1 IP \u8d1f\u8f7d\u5747\u8861\u5230\u8fd9\u4e9b Endpoints \u4e0a\u3002</p> <p>\u6bcf\u4e2a Service \u90fd\u4f1a\u81ea\u52a8\u5206\u914d\u4e00\u4e2a cluster IP\uff08\u4ec5\u5728\u96c6\u7fa4\u5185\u90e8\u53ef\u8bbf\u95ee\u7684\u865a\u62df\u5730\u5740\uff09\u548c DNS \u540d\uff0c\u5176\u4ed6\u5bb9\u5668\u53ef\u4ee5\u901a\u8fc7\u8be5\u5730\u5740\u6216 DNS \u6765\u8bbf\u95ee\u670d\u52a1\uff0c\u800c\u4e0d\u9700\u8981\u4e86\u89e3\u540e\u7aef\u5bb9\u5668\u7684\u8fd0\u884c\u3002</p> <p></p> <p>\u8fc1\u79fb</p> <p>\u4e86\u89e3\u4e86\u4e0a\u9762\u7684\u51e0\u4e2a\u57fa\u672c\u6982\u5ff5\u540e\uff0c\u6211\u4eec\u5c31\u5b8c\u5168\u53ef\u4ee5\u628a\u6211\u4eec\u7684\u5bb9\u5668\u670d\u52a1\u8fc1\u79fb\u5230 Kubernetes \u96c6\u7fa4\u4e0a\u4e86\u3002\u5f53\u7136\u6211\u4eec\u8fd8\u5f97\u5148\u642d\u5efa\u597d\u6211\u4eec\u7684 Kubernetes \u96c6\u7fa4\u73af\u5883\u3002</p>"},{"location":"kubernetes_basic/pod/","title":"Pod\u539f\u7406","text":"<p>\ue3c9</p>"},{"location":"kubernetes_basic/pod/#pod","title":"Pod","text":"<p>Kubernetes \u6700\u57fa\u672c\u7684\u8c03\u5ea6\u5355\u5143</p> <p></p> <p>\u524d\u9762\u7684\u8bfe\u7a0b\u4e2d\u6211\u4eec\u4e86\u89e3\u4e86 Kubernetes \u7684\u57fa\u672c\u67b6\u6784\uff0c\u4ee5\u53ca\u5982\u4f55\u4f7f\u7528\u8d44\u6e90\u6e05\u5355\u5728\u96c6\u7fa4\u4e2d\u90e8\u7f72\u4e00\u4e2a\u5e94\u7528\u3002\u6211\u4eec\u4e5f\u4e86\u89e3\u5230\u4e86 Pod \u662f Kubernetes \u96c6\u7fa4\u4e2d\u6700\u57fa\u672c\u7684\u8c03\u5ea6\u5355\u5143\uff0c\u6211\u4eec\u5e73\u65f6\u5728\u96c6\u7fa4\u4e2d\u90e8\u7f72\u7684\u5e94\u7528\u90fd\u662f\u4ee5 Pod \u4e3a\u5355\u4f4d\u7684\uff0c\u800c\u5e76\u4e0d\u662f\u6211\u4eec\u719f\u77e5\u7684\u5bb9\u5668\uff0c\u8fd9\u6837\u8bbe\u8ba1\u7684\u76ee\u7684\u662f\u4ec0\u4e48\u5462\uff1f\u4e3a\u4f55\u4e0d\u76f4\u63a5\u4f7f\u7528\u5bb9\u5668\u5462\uff1f</p>"},{"location":"kubernetes_basic/pod/#pod_1","title":"\u4e3a\u4ec0\u4e48\u9700\u8981 Pod","text":"<p>\u5047\u8bbe Kubernetes \u4e2d\u8c03\u5ea6\u7684\u57fa\u672c\u5355\u5143\u5c31\u662f\u5bb9\u5668\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u975e\u5e38\u7b80\u5355\u7684\u5e94\u7528\u53ef\u4ee5\u76f4\u63a5\u88ab\u8c03\u5ea6\u76f4\u63a5\u4f7f\u7528\uff0c\u6ca1\u6709\u4ec0\u4e48\u95ee\u9898\uff0c\u4f46\u662f\u5f80\u5f80\u8fd8\u6709\u5f88\u591a\u5e94\u7528\u7a0b\u5e8f\u662f\u7531\u591a\u4e2a\u8fdb\u7a0b\u7ec4\u6210\u7684\uff0c\u6709\u7684\u540c\u5b66\u53ef\u80fd\u4f1a\u8bf4\u628a\u8fd9\u4e9b\u8fdb\u7a0b\u90fd\u6253\u5305\u5230\u4e00\u4e2a\u5bb9\u5668\u4e2d\u53bb\u4e0d\u5c31\u53ef\u4ee5\u4e86\u5417\uff1f\u7406\u8bba\u4e0a\u662f\u53ef\u4ee5\u5b9e\u73b0\u7684\uff0c\u4f46\u662f\u4e0d\u8981\u5fd8\u8bb0\u4e86 Docker \u7ba1\u7406\u7684\u8fdb\u7a0b\u662f pid=1 \u7684\u4e3b\u8fdb\u7a0b\uff0c\u5176\u4ed6\u8fdb\u7a0b\u6b7b\u6389\u4e86\u5c31\u4f1a\u6210\u4e3a\u50f5\u5c38\u8fdb\u7a0b\uff0c\u6ca1\u529e\u6cd5\u8fdb\u884c\u7ba1\u7406\u4e86\uff0c\u8fd9\u79cd\u65b9\u5f0f\u672c\u8eab\u4e5f\u4e0d\u662f\u5bb9\u5668\u63a8\u8350\u7684\u8fd0\u884c\u65b9\u5f0f\uff0c\u4e00\u4e2a\u5bb9\u5668\u6700\u597d<code>\u53ea\u5e72\u4e00\u4ef6\u4e8b\u60c5</code>\uff0c\u6240\u4ee5\u5728\u771f\u5b9e\u7684\u73af\u5883\u4e2d\u4e0d\u4f1a\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u3002</p> <p>\u90a3\u4e48\u6211\u4eec\u5c31\u628a\u8fd9\u4e2a\u5e94\u7528\u7684\u8fdb\u7a0b\u8fdb\u884c\u62c6\u5206\uff0c\u62c6\u5206\u6210\u4e00\u4e2a\u4e00\u4e2a\u7684\u5bb9\u5668\u603b\u53ef\u4ee5\u4e86\u5427\uff1f\u4f46\u662f\u4e0d\u8981\u5fd8\u8bb0\u4e00\u4e2a\u95ee\u9898\uff0c\u62c6\u5206\u6210\u4e00\u4e2a\u4e00\u4e2a\u7684\u5bb9\u5668\u540e\uff0c\u662f\u4e0d\u662f\u5c31\u6709\u53ef\u80fd\u51fa\u73b0\u4e00\u4e2a\u5e94\u7528\u4e0b\u9762\u7684\u67d0\u4e2a\u8fdb\u7a0b\u5bb9\u5668\u88ab\u8c03\u5ea6\u5230\u4e86\u4e0d\u540c\u7684\u8282\u70b9\u4e0a\u5440\uff1f\u5f80\u5f80\u6211\u4eec\u5e94\u7528\u5185\u90e8\u7684\u8fdb\u7a0b\u4e0e\u8fdb\u7a0b\u95f4\u901a\u4fe1\uff08\u901a\u8fc7 IPC \u6216\u8005\u5171\u4eab\u672c\u5730\u6587\u4ef6\u4e4b\u7c7b\uff09\u90fd\u662f\u8981\u6c42\u5728\u672c\u5730\u8fdb\u884c\u7684\uff0c\u4e5f\u5c31\u662f\u9700\u8981\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u3002</p> <p>\u6240\u4ee5\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u66f4\u9ad8\u7ea7\u522b\u7684\u7ed3\u6784\u6765\u5c06\u8fd9\u4e9b\u5bb9\u5668\u7ed1\u5b9a\u5728\u4e00\u8d77\uff0c\u5e76\u5c06\u4ed6\u4eec\u4f5c\u4e3a\u4e00\u4e2a\u57fa\u672c\u7684\u8c03\u5ea6\u5355\u5143\u8fdb\u884c\u7ba1\u7406\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u4fdd\u8bc1\u8fd9\u4e9b\u5bb9\u5668\u59cb\u7ec8\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a\u9762\uff0c\u8fd9\u4e5f\u5c31\u662f Pod \u8bbe\u8ba1\u7684\u521d\u8877\u3002</p>"},{"location":"kubernetes_basic/pod/#pod_2","title":"Pod \u539f\u7406","text":"<p>\u5728\u4e00\u4e2a Pod \u4e0b\u9762\u8fd0\u884c\u51e0\u4e2a\u5173\u7cfb\u975e\u5e38\u5bc6\u5207\u7684\u5bb9\u5668\u8fdb\u7a0b\uff0c\u8fd9\u6837\u4e00\u6765\u8fd9\u4e9b\u8fdb\u7a0b\u672c\u8eab\u53c8\u53ef\u4ee5\u6536\u5230\u5bb9\u5668\u7684\u7ba1\u63a7\uff0c\u53c8\u5177\u6709\u51e0\u4e4e\u4e00\u81f4\u7684\u8fd0\u884c\u73af\u5883\uff0c\u4e5f\u5c31\u5b8c\u7f8e\u89e3\u51b3\u4e86\u4e0a\u9762\u63d0\u5230\u7684\u95ee\u9898\u3002</p> <p>\u5176\u5b9e Pod \u4e5f\u53ea\u662f\u4e00\u4e2a\u903b\u8f91\u6982\u5ff5\uff0c\u771f\u6b63\u8d77\u4f5c\u7528\u7684\u8fd8\u662f Linux \u5bb9\u5668\u7684 Namespace \u548c Cgroup \u8fd9\u4e24\u4e2a\u6700\u57fa\u672c\u7684\u6982\u5ff5\uff0cPod \u88ab\u521b\u5efa\u51fa\u6765\u5176\u5b9e\u662f\u4e00\u7ec4\u5171\u4eab\u4e86\u4e00\u4e9b\u8d44\u6e90\u7684\u5bb9\u5668\u800c\u5df2\u3002\u9996\u5148 Pod \u91cc\u9762\u7684\u6240\u6709\u5bb9\u5668\uff0c\u90fd\u662f\u5171\u4eab\u7684\u540c\u4e00\u4e2a Network Namespace\uff0c\u4f46\u662f\u6d89\u53ca\u5230\u6587\u4ef6\u7cfb\u7edf\u7684\u65f6\u5019\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b Pod \u91cc\u9762\u7684\u5bb9\u5668\u4e4b\u95f4\u7684\u6587\u4ef6\u7cfb\u7edf\u662f\u5b8c\u5168\u9694\u79bb\u7684\uff0c\u4f46\u662f\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u58f0\u660e\u6765\u5171\u4eab\u540c\u4e00\u4e2a Volume\u3002</p> <p>\u5bf9\u4e8e\u5171\u4eab\u540c\u4e00\u4e2a Network Namespace \u8fd9\u4e2a\u6982\u5ff5\u662f\u4e0d\u662f\u6bd4\u8f83\u719f\u6089\uff0c\u6211\u4eec\u4e4b\u524d\u5728 Docker \u7f51\u7edc\u6a21\u5f0f\u7684\u7ae0\u8282\u4e2d\u8bb2\u89e3\u4e86\u7f51\u7edc\u7684 Container \u6a21\u5f0f\uff0c\u6211\u4eec\u53ef\u4ee5\u6307\u5b9a\u65b0\u521b\u5efa\u7684\u5bb9\u5668\u548c\u4e00\u4e2a\u5df2\u7ecf\u5b58\u5728\u7684\u5bb9\u5668\u5171\u4eab\u4e00\u4e2a Network Namespace\uff0c\u5728\u8fd0\u884c\u5bb9\u5668\u7684\u65f6\u5019\u53ea\u9700\u8981\u6307\u5b9a </p> <pre><code>--net=container:\u76ee\u6807\u5bb9\u5668\u540d\n</code></pre> <p>\u8fd9\u4e2a\u53c2\u6570\u5c31\u53ef\u4ee5\u4e86\uff0c\u4f46\u662f\u8fd9\u79cd\u6a21\u5f0f\u6709\u4e00\u4e2a\u660e\u663e\u7684\u95ee\u9898\u90a3\u5c31\u662f\u5bb9\u5668\u7684\u542f\u52a8\u6709\u5148\u540e\u987a\u5e8f\u95ee\u9898\uff0c\u90a3\u4e48 Pod \u662f\u600e\u4e48\u6765\u5904\u7406\u8fd9\u4e2a\u95ee\u9898\u7684\u5462\uff1f\u90a3\u5c31\u662f\u52a0\u5165\u4e00\u4e2a\u4e2d\u95f4\u5bb9\u5668\uff08\u6ca1\u6709\u4ec0\u4e48\u67b6\u6784\u662f\u52a0\u4e00\u4e2a\u4e2d\u95f4\u4ef6\u89e3\u51b3\u4e0d\u4e86\u7684\uff1f\uff09\uff0c\u8fd9\u4e2a\u5bb9\u5668\u53eb\u505a Infra \u5bb9\u5668\uff0c\u800c\u4e14\u8fd9\u4e2a\u5bb9\u5668\u5728 Pod \u4e2d\u6c38\u8fdc\u90fd\u662f\u7b2c\u4e00\u4e2a\u88ab\u521b\u5efa\u7684\u5bb9\u5668\uff0c\u8fd9\u6837\u662f\u4e0d\u662f\u5176\u4ed6\u5bb9\u5668\u90fd\u52a0\u5165\u5230\u8fd9\u4e2a Infra \u5bb9\u5668\u5c31\u53ef\u4ee5\u4e86\uff0c\u8fd9\u6837\u5c31\u5b8c\u5168\u5b9e\u73b0\u4e86 Pod \u4e2d\u7684\u6240\u6709\u5bb9\u5668\u90fd\u548c Infra \u5bb9\u5668\u5171\u4eab\u540c\u4e00\u4e2a Network Namespace \u4e86\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u6240\u4ee5\u5f53\u6211\u4eec\u90e8\u7f72\u5b8c\u6210 Kubernetes \u96c6\u7fa4\u7684\u65f6\u5019\uff0c\u9996\u5148\u9700\u8981\u4fdd\u8bc1\u5728\u6240\u6709\u8282\u70b9\u4e0a\u53ef\u4ee5\u62c9\u53d6\u5230\u9ed8\u8ba4\u7684 Infra \u955c\u50cf\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b Infra \u955c\u50cf\u5730\u5740\u4e3a <code>k8s.gcr.io/pause:3.1</code>\uff0c\u8fd9\u4e2a\u5bb9\u5668\u5360\u7528\u7684\u8d44\u6e90\u975e\u5e38\u5c11\uff0c\u4f46\u662f\u8fd9\u4e2a\u955c\u50cf\u9ed8\u8ba4\u662f\u9700\u8981\u79d1\u5b66\u4e0a\u7f51\u7684\uff0c\u6240\u4ee5\u5f88\u591a\u65f6\u5019\u6211\u4eec\u5728\u90e8\u7f72\u5e94\u7528\u7684\u65f6\u5019\u4e00\u76f4\u5904\u4e8e <code>Pending</code> \u72b6\u6001\uff0c\u56e0\u4e3a\u6240\u6709 Pod \u6700\u5148\u542f\u52a8\u7684\u5bb9\u5668\u955c\u50cf\u90fd\u62c9\u4e0d\u4e0b\u6765\uff0c\u80af\u5b9a\u542f\u52a8\u4e0d\u4e86\uff0c\u542f\u52a8\u4e0d\u4e86\u5176\u4ed6\u5bb9\u5668\u80af\u5b9a\u4e5f\u5c31\u4e0d\u80fd\u542f\u52a8\u4e86\uff1a</p> <pre><code>$ kubelet --help |grep infra\n      --pod-infra-container-image string                                                                          The image whose network/ipc namespaces containers in each pod will use. This docker-specific flag only works when container-runtime is set to docker. (default \"k8s.gcr.io/pause:1\")\n</code></pre> <p>\u4ece\u4e0a\u9762\u56fe\u4e2d\u6211\u4eec\u53ef\u4ee5\u770b\u51fa\u666e\u901a\u7684\u5bb9\u5668\u52a0\u5165\u5230\u4e86 Infra \u5bb9\u5668\u7684 Network Namespace \u4e2d\uff0c\u6240\u4ee5\u8fd9\u4e2a Pod \u4e0b\u9762\u7684\u6240\u6709\u5bb9\u5668\u5c31\u662f\u5171\u4eab\u540c\u4e00\u4e2a Network Namespace \u4e86\uff0c\u666e\u901a\u5bb9\u5668\u4e0d\u4f1a\u521b\u5efa\u81ea\u5df1\u7684\u7f51\u5361\uff0c\u914d\u7f6e\u81ea\u5df1\u7684 IP\uff0c\u800c\u662f\u548c Infra \u5bb9\u5668\u5171\u4eab IP\u3001\u7aef\u53e3\u8303\u56f4\u7b49\uff0c\u800c\u4e14\u5bb9\u5668\u4e4b\u95f4\u7684\u8fdb\u7a0b\u53ef\u4ee5\u901a\u8fc7 lo \u7f51\u5361\u8bbe\u5907\u8fdb\u884c\u901a\u4fe1\uff1a</p> <ul> <li>\u4e5f\u5c31\u662f\u5bb9\u5668\u4e4b\u95f4\u662f\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 <code>localhost</code> \u8fdb\u884c\u901a\u4fe1\u7684\uff1b</li> <li>\u770b\u5230\u7684\u7f51\u7edc\u8bbe\u5907\u4fe1\u606f\u90fd\u662f\u548c Infra \u5bb9\u5668\u5b8c\u5168\u4e00\u6837\u7684\uff1b</li> <li>\u4e5f\u5c31\u610f\u5473\u7740\u540c\u4e00\u4e2a Pod \u4e0b\u9762\u7684\u5bb9\u5668\u8fd0\u884c\u7684\u591a\u4e2a\u8fdb\u7a0b\u4e0d\u80fd\u7ed1\u5b9a\u76f8\u540c\u7684\u7aef\u53e3\uff1b</li> <li>\u800c\u4e14 Pod \u7684\u751f\u547d\u5468\u671f\u53ea\u8ddf Infra \u5bb9\u5668\u4e00\u81f4\uff0c\u800c\u4e0e\u5bb9\u5668 A \u548c B \u65e0\u5173\u3002</li> </ul> <p>\u5bf9\u4e8e\u6587\u4ef6\u7cfb\u7edf Kubernetes \u662f\u600e\u4e48\u5b9e\u73b0\u8ba9\u4e00\u4e2a Pod \u4e2d\u7684\u5bb9\u5668\u5171\u4eab\u7684\u5462\uff1f\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5bb9\u5668\u7684\u6587\u4ef6\u7cfb\u7edf\u662f\u4e92\u76f8\u9694\u79bb\u7684\uff0c\u8981\u5b9e\u73b0\u5171\u4eab\u53ea\u9700\u8981\u5728 Pod \u7684\u9876\u5c42\u58f0\u660e\u4e00\u4e2a Volume\uff0c\u7136\u540e\u5728\u9700\u8981\u5171\u4eab\u8fd9\u4e2a Volume \u7684\u5bb9\u5668\u4e2d\u58f0\u660e\u6302\u8f7d\u5373\u53ef\u3002</p> <p></p> <p>\u6bd4\u5982\u4e0b\u9762\u7684\u793a\u4f8b\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: counter\nspec:\n  volumes: \n  - name: varlog\n    hostPath: \n      path: /var/log/counter\n  containers:\n  - name: count\n    image: busybox\n    args:\n    - /bin/sh\n    - -c\n    - &gt;\n      i=0;\n      while true;\n      do\n        echo \"$i: $(date)\" &gt;&gt; /var/log/log;\n        i=$((i+1));\n        sleep 1;\n      done\n    volumeMounts:\n    - name: varlog\n      mountPath: /var/log\n  - name: count-log\n    image: busybox\n    args: [/bin/sh, -c, 'tail -n+1 -f /var/log/log']\n    volumeMounts:\n    - name: varlog\n      mountPath: /var/log\n</code></pre> <p>\u793a\u4f8b\u4e2d\u6211\u4eec\u5728 Pod \u7684\u9876\u5c42\u58f0\u660e\u4e86\u4e00\u4e2a\u540d\u4e3a varlog \u7684 <code>Volume</code>\uff0c\u800c\u8fd9\u4e2a <code>Volume</code> \u7684\u7c7b\u578b\u662f <code>hostPath</code>\uff0c\u4e5f\u5c31\u610f\u5473\u8fd9\u4e2a\u5bbf\u4e3b\u673a\u7684 <code>/var/log/counter</code> \u76ee\u5f55\u5c06\u88ab\u8fd9\u4e2a Pod \u5171\u4eab\uff0c\u5171\u4eab\u7ed9\u8c01\u5462\uff1f\u5728\u9700\u8981\u7528\u5230\u8fd9\u4e2a\u6570\u636e\u76ee\u5f55\u7684\u5bb9\u5668\u4e0a\u58f0\u660e\u6302\u8f7d\u5373\u53ef\uff0c\u4e5f\u5c31\u662f\u901a\u8fc7 <code>volumeMounts</code> \u58f0\u660e\u6302\u8f7d\u7684\u90e8\u5206\uff0c\u8fd9\u6837\u6211\u4eec\u8fd9\u4e2a Pod \u5c31\u5b9e\u73b0\u4e86\u5171\u4eab\u5bb9\u5668\u7684 <code>/var/log</code> \u76ee\u5f55\uff0c\u800c\u4e14\u6570\u636e\u88ab\u6301\u4e45\u5316\u5230\u4e86\u5bbf\u4e3b\u673a\u76ee\u5f55\u4e0a\u3002</p> <p>\u8fd9\u4e2a\u65b9\u5f0f\u4e5f\u662f Kubernetes \u4e2d\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u8bbe\u8ba1\u6a21\u5f0f\uff1a<code>sidecar \u6a21\u5f0f</code>\u7684\u5e38\u7528\u65b9\u5f0f\u3002\u5178\u578b\u7684\u573a\u666f\u5c31\u662f\u5bb9\u5668\u65e5\u5fd7\u6536\u96c6\uff0c\u6bd4\u5982\u4e0a\u9762\u6211\u4eec\u7684\u8fd9\u4e2a\u5e94\u7528\uff0c\u5176\u4e2d\u5e94\u7528\u7684\u65e5\u5fd7\u662f\u88ab\u8f93\u51fa\u5230\u5bb9\u5668\u7684 /var/log \u76ee\u5f55\u4e0a\u7684\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u628a Pod \u58f0\u660e\u7684 Volume \u6302\u8f7d\u5230\u5bb9\u5668\u7684 /var/log \u76ee\u5f55\u4e0a\uff0c\u7136\u540e\u5728\u8fd9\u4e2a Pod \u91cc\u9762\u540c\u65f6\u8fd0\u884c\u4e00\u4e2a sidecar \u5bb9\u5668\uff0c\u4ed6\u4e5f\u58f0\u660e\u6302\u8f7d\u76f8\u540c\u7684 Volume \u5230\u81ea\u5df1\u5bb9\u5668\u7684 /var/log \uff08\u6216\u5176\u4ed6\uff09\u76ee\u5f55\u4e0a\uff0c\u8fd9\u6837\u6211\u4eec\u8fd9\u4e2a sidecar \u5bb9\u5668\u5c31\u53ea\u9700\u8981\u4ece /var/log \u76ee\u5f55\u4e0b\u9762\u4e0d\u65ad\u6d88\u8d39\u65e5\u5fd7\u53d1\u9001\u5230 Elasticsearch \u4e2d\u5b58\u50a8\u8d77\u6765\u5c31\u5b8c\u6210\u4e86\u6700\u57fa\u672c\u7684\u5e94\u7528\u65e5\u5fd7\u7684\u57fa\u672c\u6536\u96c6\u5de5\u4f5c\u4e86\u3002</p> <p>\u9664\u4e86\u8fd9\u4e2a\u5e94\u7528\u573a\u666f\u4e4b\u5916\u4f7f\u7528\u66f4\u591a\u7684\u8fd8\u662f\u5229\u7528 Pod \u4e2d\u7684\u6240\u6709\u5bb9\u5668\u5171\u4eab\u540c\u4e00\u4e2a Network Namespace \u8fd9\u4e2a\u7279\u6027\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u628a Pod \u7f51\u7edc\u76f8\u5173\u7684\u914d\u7f6e\u548c\u7ba1\u7406\u4e5f\u53ef\u4ee5\u4ea4\u7ed9\u4e00\u4e2a sidecar \u5bb9\u5668\u6765\u5b8c\u6210\uff0c\u5b8c\u5168\u4e0d\u9700\u8981\u53bb\u5e72\u6d89\u7528\u6237\u5bb9\u5668\uff0c\u8fd9\u4e2a\u7279\u6027\u5728\u73b0\u5728\u975e\u5e38\u706b\u70ed\u7684 Service Mesh\uff08\u670d\u52a1\u7f51\u683c\uff09\u4e2d\u5e94\u7528\u975e\u5e38\u5e7f\u6cdb\uff0c\u5178\u578b\u7684\u5e94\u7528\u5c31\u662f Istio\uff0c\u4e0d\u8fc7\u4e5f\u4e0d\u7528\u7740\u6025\uff0c\u540e\u9762\u4e5f\u4f1a\u548c\u5927\u5bb6\u4e00\u8d77\u63a2\u8ba8\u7684\u3002</p>"},{"location":"kubernetes_basic/pod/#pod_3","title":"\u5982\u4f55\u5212\u5206 Pod","text":"<p>\u4e0a\u9762\u6211\u4eec\u4ecb\u7ecd\u4e86 Pod \u7684\u5b9e\u73b0\u539f\u7406\uff0c\u4e86\u89e3\u5230\u4e86\u5e94\u8be5\u628a\u5173\u7cfb\u7d27\u5bc6\u7684\u5bb9\u5668\u5212\u5206\u5230\u540c\u4e00\u4e2a Pod \u4e2d\u8fd0\u884c\uff0c\u90a3\u4e48\u600e\u4e48\u6765\u533a\u5206\u5173\u7cfb\u7d27\u5bc6\u5462\uff1f\u4e3e\u4e00\u4e2a\u7b80\u5355\u7684\u793a\u4f8b\uff0c\u6bd4\u5982\u6211\u4eec\u7684 Wordpress \u5e94\u7528\uff0c\u662f\u4e00\u4e2a\u5178\u578b\u7684\u524d\u7aef\u670d\u52a1\u5668\u548c\u540e\u7aef\u6570\u636e\u670d\u52a1\u7684\u5e94\u7528\uff0c\u90a3\u4e48\u4f60\u8ba4\u4e3a\u5e94\u8be5\u4f7f\u7528\u4e00\u4e2a Pod \u8fd8\u662f\u4e24\u4e2a Pod \u5462\uff1f</p> <p>\u5982\u679c\u5728\u540c\u4e00\u4e2a Pod \u4e2d\u540c\u65f6\u8fd0\u884c\u670d\u52a1\u5668\u7a0b\u5e8f\u548c\u540e\u7aef\u7684\u6570\u636e\u5e93\u670d\u52a1\u8fd9\u4e24\u4e2a\u5bb9\u5668\uff0c\u7406\u8bba\u4e0a\u80af\u5b9a\u662f\u53ef\u884c\u7684\uff0c\u4f46\u662f\u4e0d\u63a8\u8350\u8fd9\u6837\u4f7f\u7528\uff0c\u6211\u4eec\u77e5\u9053\u4e00\u4e2a Pod \u4e2d\u7684\u6240\u6709\u5bb9\u5668\u90fd\u662f\u540c\u4e00\u4e2a\u6574\u4f53\u8fdb\u884c\u8c03\u5ea6\u7684\uff0c\u4f46\u662f\u5bf9\u4e8e\u6211\u4eec\u8fd9\u4e2a\u5e94\u7528 Wordpress \u548c MySQL \u6570\u636e\u5e93\u4e00\u5b9a\u9700\u8981\u8fd0\u884c\u5728\u4e00\u8d77\u5417\uff1f\u5f53\u7136\u4e0d\u9700\u8981\uff0c\u6211\u4eec\u751a\u81f3\u53ef\u4ee5\u5c06 MySQL \u90e8\u7f72\u5230\u96c6\u7fa4\u4e4b\u5916\u5bf9\u5427\uff1f\u6240\u4ee5 Wordpress \u548c MySQL \u5373\u4f7f\u4e0d\u8fd0\u884c\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a\u4e5f\u662f\u53ef\u884c\u7684\uff0c\u53ea\u8981\u80fd\u591f\u8bbf\u95ee\u5230\u5373\u53ef\u3002</p> <p></p> <p>\u4f46\u662f\u5982\u679c\u4f60\u975e\u8981\u5f3a\u884c\u90e8\u7f72\u5230\u540c\u4e00\u4e2a Pod \u4e2d\u5462\uff1f\u4ece\u67d0\u4e2a\u89d2\u5ea6\u6765\u8bf4\u662f\u9519\u8bef\u7684\uff0c\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u7684\u5e94\u7528\u8bbf\u95ee\u91cf\u975e\u5e38\u5927\uff0c\u4e00\u4e2a Pod \u5df2\u7ecf\u6ee1\u8db3\u4e0d\u4e86\u6211\u4eec\u7684\u9700\u6c42\u4e86\uff0c\u600e\u4e48\u529e\u5462\uff1f\u6269\u5bb9\u5bf9\u5427\uff0c\u4f46\u662f\u6269\u5bb9\u7684\u76ee\u6807\u4e5f\u662f Pod\uff0c\u5e76\u4e0d\u662f\u5bb9\u5668\uff0c\u6bd4\u5982\u6211\u4eec\u518d\u6dfb\u52a0\u4e00\u4e2a Pod\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u6709\u4e24\u4e2a Wordpress \u7684\u5e94\u7528\u548c\u4e24\u4e2a MySQL \u6570\u636e\u5e93\u4e86\uff0c\u800c\u4e14\u8fd9\u4e24\u4e2a Pod \u4e4b\u95f4\u7684\u6570\u636e\u662f\u4e92\u76f8\u72ec\u7acb\u7684\uff0c\u56e0\u4e3a MySQL \u6570\u636e\u5e93\u5e76\u4e0d\u662f\u7b80\u5355\u7684\u589e\u52a0\u526f\u672c\u5c31\u53ef\u4ee5\u5171\u4eab\u6570\u636e\u4e86\uff0c\u6240\u4ee5\u8fd9\u4e2a\u65f6\u5019\u5c31\u5f97\u5206\u5f00\u90e8\u7f72\u4e86\uff0c\u91c7\u7528\u7b2c\u4e8c\u79cd\u65b9\u6848\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ea\u9700\u8981\u5355\u72ec\u6269\u5bb9 Wordpress \u7684\u8fd9\u4e2a Pod\uff0c\u540e\u7aef\u7684 MySQL \u6570\u636e\u5e93\u5e76\u4e0d\u4f1a\u53d7\u5230\u6269\u5bb9\u7684\u5f71\u54cd\u3002</p> <p></p> <p>\u5c06\u591a\u4e2a\u5bb9\u5668\u90e8\u7f72\u5230\u540c\u4e00\u4e2a Pod \u4e2d\u7684\u6700\u4e3b\u8981\u53c2\u8003\u5c31\u662f\u5e94\u7528\u53ef\u80fd\u7531\u4e00\u4e2a\u4e3b\u8fdb\u7a0b\u548c\u4e00\u4e2a\u6216\u591a\u4e2a\u7684\u8f85\u52a9\u8fdb\u7a0b\u7ec4\u6210\uff0c\u6bd4\u5982\u4e0a\u9762\u6211\u4eec\u7684\u65e5\u5fd7\u6536\u96c6\u7684 Pod\uff0c\u9700\u8981\u5176\u4ed6\u7684 sidecar \u5bb9\u5668\u6765\u652f\u6301\u65e5\u5fd7\u7684\u91c7\u96c6\u3002\u6240\u4ee5\u5f53\u6211\u4eec\u5224\u65ad\u662f\u5426\u9700\u8981\u5728 Pod \u4e2d\u4f7f\u7528\u591a\u4e2a\u5bb9\u5668\u7684\u65f6\u5019\uff0c\u6211\u4eec\u53ef\u4ee5\u6309\u7167\u5982\u4e0b\u7684\u51e0\u4e2a\u65b9\u5f0f\u6765\u5224\u65ad\uff1a</p> <ul> <li>\u8fd9\u4e9b\u5bb9\u5668\u662f\u5426\u4e00\u5b9a\u9700\u8981\u4e00\u8d77\u8fd0\u884c\uff0c\u662f\u5426\u53ef\u4ee5\u8fd0\u884c\u5728\u4e0d\u540c\u7684\u8282\u70b9\u4e0a</li> <li>\u8fd9\u4e9b\u5bb9\u5668\u662f\u4e00\u4e2a\u6574\u4f53\u8fd8\u662f\u72ec\u7acb\u7684\u7ec4\u4ef6</li> <li>\u8fd9\u4e9b\u5bb9\u5668\u4e00\u8d77\u8fdb\u884c\u6269\u7f29\u5bb9\u4f1a\u5f71\u54cd\u5e94\u7528\u5417</li> </ul> <p>\u57fa\u672c\u4e0a\u6211\u4eec\u80fd\u591f\u56de\u7b54\u4e0a\u9762\u7684\u51e0\u4e2a\u95ee\u9898\u5c31\u80fd\u591f\u5224\u65ad\u662f\u5426\u9700\u8981\u5728 Pod \u4e2d\u8fd0\u884c\u591a\u4e2a\u5bb9\u5668\u4e86\u3002</p> <p>Pod \u7684\u8bbe\u8ba1</p> <p>\u5176\u5b9e\u5728\u6211\u4eec\u7406\u89e3 Pod \u7684\u65f6\u5019\uff0c\u6709\u4e00\u4e2a\u6bd4\u8f83\u597d\u7684\u7c7b\u6bd4\u7684\u65b9\u5f0f\u5c31\u662f\u628a Pod \u770b\u6210\u6211\u4eec\u4e4b\u524d\u7684 \u865a\u62df\u673a\uff0c\u800c\u5bb9\u5668\u5c31\u662f\u865a\u62df\u673a\u4e2d\u8fd0\u884c\u7684\u4e00\u4e2a\u7528\u6237\u7a0b\u5e8f\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5f88\u597d\u7684\u6765\u7406\u89e3 Pod \u7684\u8bbe\u8ba1\u3002</p>"},{"location":"kubernetes_basic/pod_deep/","title":"Pod\u4f7f\u7528\u8fdb\u9636","text":"<p>\ue3c9</p>"},{"location":"kubernetes_basic/pod_deep/#pod","title":"Pod \u4f7f\u7528\u8fdb\u9636","text":"<p>\u6df1\u5165\u7406\u89e3 Pod \u5bf9\u8c61</p>"},{"location":"kubernetes_basic/pod_deep/#pod_1","title":"\u9759\u6001 Pod","text":"<p>\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u9664\u4e86\u6211\u4eec\u7ecf\u5e38\u4f7f\u7528\u5230\u7684\u666e\u901a\u7684 Pod \u5916\uff0c\u8fd8\u6709\u4e00\u79cd\u7279\u6b8a\u7684 Pod\uff0c\u53eb\u505aStatic Pod\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u8bf4\u7684\u9759\u6001 Pod\uff0c\u9759\u6001 Pod \u6709\u4ec0\u4e48\u7279\u6b8a\u7684\u5730\u65b9\u5462\uff1f</p> <p>\u9759\u6001 Pod \u76f4\u63a5\u7531\u8282\u70b9\u4e0a\u7684 kubelet \u8fdb\u7a0b\u6765\u7ba1\u7406\uff0c\u4e0d\u901a\u8fc7 master \u8282\u70b9\u4e0a\u7684 apiserver\u3002\u65e0\u6cd5\u4e0e\u6211\u4eec\u5e38\u7528\u7684\u63a7\u5236\u5668 Deployment \u6216\u8005 DaemonSet \u8fdb\u884c\u5173\u8054\uff0c\u5b83\u7531 kubelet \u8fdb\u7a0b\u81ea\u5df1\u6765\u76d1\u63a7\uff0c\u5f53 pod \u5d29\u6e83\u65f6\u4f1a\u91cd\u542f\u8be5 pod\uff0ckubelet \u4e5f\u65e0\u6cd5\u5bf9\u4ed6\u4eec\u8fdb\u884c\u5065\u5eb7\u68c0\u67e5\u3002\u9759\u6001 pod \u59cb\u7ec8\u7ed1\u5b9a\u5728\u67d0\u4e00\u4e2a kubelet \u4e0a\uff0c\u5e76\u4e14\u59cb\u7ec8\u8fd0\u884c\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a\u3002kubelet \u4f1a\u81ea\u52a8\u4e3a\u6bcf\u4e00\u4e2a\u9759\u6001 pod \u5728 Kubernetes \u7684 apiserver \u4e0a\u521b\u5efa\u4e00\u4e2a\u955c\u50cf Pod\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u5728 apiserver \u4e2d\u67e5\u8be2\u5230\u8be5 pod\uff0c\u4f46\u662f\u4e0d\u80fd\u901a\u8fc7 apiserver \u8fdb\u884c\u63a7\u5236\uff08\u4f8b\u5982\u4e0d\u80fd\u5220\u9664\uff09\u3002</p> <p>\u521b\u5efa\u9759\u6001 Pod \u6709\u4e24\u79cd\u65b9\u5f0f\uff1a<code>\u914d\u7f6e\u6587\u4ef6</code>\u548c <code>HTTP</code> \u4e24\u79cd\u65b9\u5f0f</p>"},{"location":"kubernetes_basic/pod_deep/#_1","title":"\u914d\u7f6e\u6587\u4ef6","text":"<p>\u914d\u7f6e\u6587\u4ef6\u5c31\u662f\u653e\u5728\u7279\u5b9a\u76ee\u5f55\u4e0b\u7684\u6807\u51c6\u7684 JSON \u6216 YAML \u683c\u5f0f\u7684 pod \u5b9a\u4e49\u6587\u4ef6\u3002\u7528 </p> <pre><code>kubelet --pod-manifest-path=&lt;the directory&gt;\n</code></pre> <p>\u6765\u542f\u52a8 kubelet \u8fdb\u7a0b\uff0ckubelet \u5b9a\u671f\u7684\u53bb\u626b\u63cf\u8fd9\u4e2a\u76ee\u5f55\uff0c\u6839\u636e\u8fd9\u4e2a\u76ee\u5f55\u4e0b\u51fa\u73b0\u6216\u6d88\u5931\u7684 YAML/JSON \u6587\u4ef6\u6765\u521b\u5efa\u6216\u5220\u9664\u9759\u6001 pod\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u5728 node01 \u8fd9\u4e2a\u8282\u70b9\u4e0a\u7528\u9759\u6001 pod \u7684\u65b9\u5f0f\u6765\u542f\u52a8\u4e00\u4e2a nginx \u7684\u670d\u52a1\u3002\u6211\u4eec\u767b\u5f55\u5230node01\u8282\u70b9\u4e0a\u9762\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u547d\u4ee4\u627e\u5230 kubelet \u5bf9\u5e94\u7684\u542f\u52a8\u914d\u7f6e\u6587\u4ef6</p> <pre><code>$ systemctl status kubelet\n</code></pre> <p>\u914d\u7f6e\u6587\u4ef6\u8def\u5f84\u4e3a\uff1a</p> <pre><code>$ vi /etc/systemd/system/kubelet.service.d/10-kubeadm.conf\n......\nEnvironment=\"KUBELET_SYSTEM_PODS_ARGS=--pod-manifest-path=/etc/kubernetes/manifests --allow-privileged=true\"\n</code></pre> <p>\u6253\u5f00\u8fd9\u4e2a\u6587\u4ef6\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5176\u4e2d\u6709\u4e00\u4e2a\u53c2\u6570<code>--pod-manifest-path</code>\u7684\u914d\u7f6e\uff0c \u6240\u4ee5\u5982\u679c\u6211\u4eec\u901a\u8fc7kubeadm \u7684\u65b9\u5f0f\u6765\u5b89\u88c5\u7684\u96c6\u7fa4\u73af\u5883\uff0c\u5bf9\u5e94\u7684 kubelet \u5df2\u7ecf\u914d\u7f6e\u4e86\u6211\u4eec\u7684\u9759\u6001 Pod \u6587\u4ef6\u7684\u8def\u5f84\uff0c\u9ed8\u8ba4\u5730\u5740\u4e3a </p> <pre><code>/etc/kubernetes/manifests\n</code></pre> <p>\uff0c\u6240\u4ee5\u6211\u4eec\u53ea\u9700\u8981\u5728\u8be5\u76ee\u5f55\u4e0b\u9762\u521b\u5efa\u4e00\u4e2a\u6807\u51c6\u7684 Pod \u7684 JSON \u6216\u8005 YAML \u6587\u4ef6\u5373\u53ef\uff0c\u5982\u679c\u4f60\u7684 kubelet \u542f\u52a8\u53c2\u6570\u4e2d\u6ca1\u6709\u914d\u7f6e\u4e0a\u9762\u7684<code>--pod-manifest-path</code> \u53c2\u6570\u7684\u8bdd\uff0c\u90a3\u4e48\u6dfb\u52a0\u4e0a\u8fd9\u4e2a\u53c2\u6570\u7136\u540e\u91cd\u542f kubelet \u5373\u53ef\uff1a</p> <pre><code>[root@ node01 ~] $ cat &lt;&lt;EOF &gt;/etc/kubernetes/manifest/static-web.yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: static-web\n  labels:\n    app: static\nspec:\n  containers:\n    - name: web\n      image: nginx\n      ports:\n        - name: web\n          containerPort: 80\nEOF\n</code></pre>"},{"location":"kubernetes_basic/pod_deep/#http_pods","title":"\u901a\u8fc7 HTTP \u521b\u5efa\u9759\u6001 Pods","text":"<p>kubelet \u5468\u671f\u5730\u4ece\u2013manifest-url=\u53c2\u6570\u6307\u5b9a\u7684\u5730\u5740\u4e0b\u8f7d\u6587\u4ef6\uff0c\u5e76\u4e14\u628a\u5b83\u7ffb\u8bd1\u6210 JSON/YAML \u683c\u5f0f\u7684 pod \u5b9a\u4e49\u3002\u6b64\u540e\u7684\u64cd\u4f5c\u65b9\u5f0f\u4e0e\u2013pod-manifest-path=\u76f8\u540c\uff0ckubelet \u4f1a\u4e0d\u65f6\u5730\u91cd\u65b0\u4e0b\u8f7d\u8be5\u6587\u4ef6\uff0c\u5f53\u6587\u4ef6\u53d8\u5316\u65f6\u5bf9\u5e94\u5730\u7ec8\u6b62\u6216\u542f\u52a8\u9759\u6001 pod\u3002</p> <p>kubelet \u542f\u52a8\u65f6\uff0c\u7531<code>--pod-manifest-path=</code> \u6216 <code>--manifest-url=</code>\u53c2\u6570\u6307\u5b9a\u7684\u76ee\u5f55\u4e0b\u5b9a\u4e49\u7684\u6240\u6709 pod \u90fd\u4f1a\u81ea\u52a8\u521b\u5efa\uff0c\u4f8b\u5982\uff0c\u6211\u4eec\u793a\u4f8b\u4e2d\u7684 static-web\u3002\uff08\u53ef\u80fd\u8981\u82b1\u4e9b\u65f6\u95f4\u62c9\u53d6nginx \u955c\u50cf\uff0c\u8010\u5fc3\u7b49\u5f85\u2026\uff09</p> <pre><code>$ docker ps\nCONTAINER ID IMAGE         COMMAND  CREATED        STATUS         PORTS     NAMES\nf6d05272b57e nginx:latest  \"nginx\"  8 minutes ago  Up 8 minutes             k8s_web.6f802af4_static-web-fk-node1_default_67e24ed9466ba55986d120c867395f3c_378e5f3c\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u901a\u8fc7kubectl\u5de5\u5177\u53ef\u4ee5\u770b\u5230\u8fd9\u91cc\u521b\u5efa\u4e86\u4e00\u4e2a\u65b0\u7684\u955c\u50cf Pod\uff1a</p> <pre><code>$ kubectl get pods\nNAME                       READY     STATUS    RESTARTS   AGE\nstatic-web-my-node01        1/1       Running   0          2m\n</code></pre> <p>\u9759\u6001 pod \u7684\u6807\u7b7e\u4f1a\u4f20\u9012\u7ed9\u955c\u50cf Pod\uff0c\u53ef\u4ee5\u7528\u6765\u8fc7\u6ee4\u6216\u7b5b\u9009\u3002 \u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u6211\u4eec\u4e0d\u80fd\u901a\u8fc7 API \u670d\u52a1\u5668\u6765\u5220\u9664\u9759\u6001 pod\uff08\u4f8b\u5982\uff0c\u901a\u8fc7kubectl\u547d\u4ee4\uff09\uff0ckubelet \u4e0d\u4f1a\u5220\u9664\u5b83\u3002</p> <pre><code>$ kubectl delete pod static-web-my-node01\n$ kubectl get pods\nNAME                       READY     STATUS    RESTARTS   AGE\nstatic-web-my-node01        1/1       Running   0          12s\n</code></pre> <p>\u6211\u4eec\u5c1d\u8bd5\u624b\u52a8\u7ec8\u6b62\u5bb9\u5668\uff0c\u53ef\u4ee5\u770b\u5230kubelet\u5f88\u5feb\u5c31\u4f1a\u81ea\u52a8\u91cd\u542f\u5bb9\u5668\u3002</p> <pre><code>$ docker ps\nCONTAINER ID        IMAGE         COMMAND                CREATED       ...\n5b920cbaf8b1        nginx:latest  \"nginx -g 'daemon of   2 seconds ago ...\n</code></pre>"},{"location":"kubernetes_basic/pod_deep/#pod_2","title":"\u9759\u6001 Pod \u7684\u52a8\u6001\u589e\u52a0\u548c\u5220\u9664","text":"<p>\u8fd0\u884c\u4e2d\u7684 kubelet \u5468\u671f\u626b\u63cf\u914d\u7f6e\u7684\u76ee\u5f55\uff08\u6211\u4eec\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\u5c31\u662f /etc/kubernetes/manifests\uff09\u4e0b\u6587\u4ef6\u7684\u53d8\u5316\uff0c\u5f53\u8fd9\u4e2a\u76ee\u5f55\u4e2d\u6709\u6587\u4ef6\u51fa\u73b0\u6216\u6d88\u5931\u65f6\u521b\u5efa\u6216\u5220\u9664 pods\uff1a</p> <pre><code>$ mv /etc/kubernetes/manifests/static-web.yaml /tmp\n$ sleep 20\n$ docker ps\n// no nginx container is running\n$ mv /tmp/static-web.yaml  /etc/kubernetes/manifests\n$ sleep 20\n$ docker ps\nCONTAINER ID        IMAGE         COMMAND                CREATED           ...\ne7a62e3427f1        nginx:latest  \"nginx -g 'daemon of   27 seconds ago\n</code></pre> <p>\u5176\u5b9e\u6211\u4eec\u7528 kubeadm \u5b89\u88c5\u7684\u96c6\u7fa4\uff0cmaster \u8282\u70b9\u4e0a\u9762\u7684\u51e0\u4e2a\u91cd\u8981\u7ec4\u4ef6\u90fd\u662f\u7528\u9759\u6001 Pod \u7684\u65b9\u5f0f\u8fd0\u884c\u7684\uff0c\u6211\u4eec\u767b\u5f55\u5230 master \u8282\u70b9\u4e0a\u67e5\u770b</p> <pre><code>/etc/kubernetes/manifests\n</code></pre> <p>\u76ee\u5f55\uff1a</p> <pre><code>$ ls /etc/kubernetes/manifests/\netcd.yaml  kube-apiserver.yaml  kube-controller-manager.yaml  kube-scheduler.yaml\n</code></pre> <p>\u73b0\u5728\u660e\u767d\u4e86\u5427\uff0c\u8fd9\u79cd\u65b9\u5f0f\u4e5f\u4e3a\u6211\u4eec\u5c06\u96c6\u7fa4\u7684\u4e00\u4e9b\u7ec4\u4ef6\u5bb9\u5668\u5316\u63d0\u4f9b\u4e86\u53ef\u80fd\uff0c\u56e0\u4e3a\u8fd9\u4e9b Pod \u90fd\u4e0d\u4f1a\u53d7\u5230 apiserver \u7684\u63a7\u5236\uff0c\u4e0d\u7136\u6211\u4eec\u8fd9\u91cckube-apiserver\u600e\u4e48\u81ea\u5df1\u53bb\u63a7\u5236\u81ea\u5df1\u5462\uff1f\u4e07\u4e00\u4e0d\u5c0f\u5fc3\u628a\u8fd9\u4e2a Pod \u5220\u6389\u4e86\u5462\uff1f\u6240\u4ee5\u53ea\u80fd\u6709kubelet\u81ea\u5df1\u6765\u8fdb\u884c\u63a7\u5236\uff0c\u8fd9\u5c31\u662f\u6211\u4eec\u6240\u8bf4\u7684\u9759\u6001 Pod\u3002</p>"},{"location":"kubernetes_basic/pod_deep/#downward_api","title":"Downward API","text":"<p>\u524d\u9762\u6211\u4eec\u4ece Pod \u7684\u539f\u7406\u5230\u751f\u547d\u5468\u671f\u4ecb\u7ecd\u4e86 Pod \u7684\u4e00\u4e9b\u4f7f\u7528\uff0c\u4f5c\u4e3a Kubernetes \u4e2d\u6700\u6838\u5fc3\u7684\u8d44\u6e90\u5bf9\u8c61\u3001\u6700\u57fa\u672c\u7684\u8c03\u5ea6\u5355\u5143\uff0c\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0 Pod \u4e2d\u7684\u5c5e\u6027\u8fd8\u662f\u975e\u5e38\u7e41\u591a\u7684\uff0c\u524d\u9762\u6211\u4eec\u4f7f\u7528\u8fc7\u4e00\u4e2a <code>volumes</code> \u7684\u5c5e\u6027\uff0c\u8868\u793a\u58f0\u660e\u4e00\u4e2a\u6570\u636e\u5377\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4</p> <pre><code>kubectl explain pod.spec.volumes\n</code></pre> <p>\u53bb\u67e5\u770b\u8be5\u5bf9\u8c61\u4e0b\u9762\u7684\u5c5e\u6027\u975e\u5e38\u591a\uff0c\u524d\u9762\u6211\u4eec\u53ea\u662f\u7b80\u5355\u4f7f\u7528\u4e86 <code>hostPath</code> \u548c <code>emptyDir{}</code> \u8fd9\u4e24\u79cd\u6a21\u5f0f\uff0c\u5176\u4e2d\u8fd8\u6709\u4e00\u79cd\u6a21\u5f0f\u53eb\u505a<code>downwardAPI</code>\uff0c\u8fd9\u4e2a\u6a21\u5f0f\u548c\u5176\u4ed6\u6a21\u5f0f\u4e0d\u4e00\u6837\u7684\u5730\u65b9\u5728\u4e8e\u5b83\u4e0d\u662f\u4e3a\u4e86\u5b58\u653e\u5bb9\u5668\u7684\u6570\u636e\u4e5f\u4e0d\u662f\u7528\u6765\u8fdb\u884c\u5bb9\u5668\u548c\u5bbf\u4e3b\u673a\u7684\u6570\u636e\u4ea4\u6362\u7684\uff0c\u800c\u662f\u8ba9 Pod \u91cc\u7684\u5bb9\u5668\u80fd\u591f\u76f4\u63a5\u83b7\u53d6\u5230\u8fd9\u4e2a Pod \u5bf9\u8c61\u672c\u8eab\u7684\u4e00\u4e9b\u4fe1\u606f\u3002</p> <p>\u76ee\u524d <code>Downward API</code> \u63d0\u4f9b\u4e86\u4e24\u79cd\u65b9\u5f0f\u7528\u4e8e\u5c06 Pod \u7684\u4fe1\u606f\u6ce8\u5165\u5230\u5bb9\u5668\u5185\u90e8\uff1a</p> <ul> <li>\u73af\u5883\u53d8\u91cf\uff1a\u7528\u4e8e\u5355\u4e2a\u53d8\u91cf\uff0c\u53ef\u4ee5\u5c06 Pod \u4fe1\u606f\u548c\u5bb9\u5668\u4fe1\u606f\u76f4\u63a5\u6ce8\u5165\u5bb9\u5668\u5185\u90e8</li> <li>Volume \u6302\u8f7d\uff1a\u5c06 Pod \u4fe1\u606f\u751f\u6210\u4e3a\u6587\u4ef6\uff0c\u76f4\u63a5\u6302\u8f7d\u5230\u5bb9\u5668\u5185\u90e8\u4e2d\u53bb</li> </ul>"},{"location":"kubernetes_basic/pod_deep/#_2","title":"\u73af\u5883\u53d8\u91cf","text":"<p>\u6211\u4eec\u901a\u8fc7 <code>Downward API</code> \u6765\u5c06 Pod \u7684 IP\u3001\u540d\u79f0\u4ee5\u53ca\u6240\u5bf9\u5e94\u7684 namespace \u6ce8\u5165\u5230\u5bb9\u5668\u7684\u73af\u5883\u53d8\u91cf\u4e2d\u53bb\uff0c\u7136\u540e\u5728\u5bb9\u5668\u4e2d\u6253\u5370\u5168\u90e8\u7684\u73af\u5883\u53d8\u91cf\u6765\u8fdb\u884c\u9a8c\u8bc1\uff0c\u5bf9\u5e94\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\uff1a(env-pod.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: env-pod\n  namespace: kube-system\nspec:\n  containers:\n  - name: env-pod\n    image: busybox\n    command: [\"/bin/sh\", \"-c\", \"env\"]\n    env:\n    - name: POD_NAME\n      valueFrom:\n        fieldRef:\n          fieldPath: metadata.name\n    - name: POD_NAMESPACE\n      valueFrom:\n        fieldRef:\n          fieldPath: metadata.namespace\n    - name: POD_IP\n      valueFrom:\n        fieldRef:\n          fieldPath: status.podIP\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u6211\u4eec\u4f7f\u7528\u4e86\u4e00\u79cd\u65b0\u7684\u65b9\u5f0f\u6765\u8bbe\u7f6e env \u7684\u503c\uff1a<code>valueFrom</code>\uff0c\u7531\u4e8e Pod \u7684 name \u548c namespace \u5c5e\u4e8e\u5143\u6570\u636e\uff0c\u662f\u5728 Pod \u521b\u5efa\u4e4b\u524d\u5c31\u5df2\u7ecf\u5b9a\u4e0b\u6765\u4e86\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 metata \u5c31\u53ef\u4ee5\u83b7\u53d6\u5230\u4e86\uff0c\u4f46\u662f\u5bf9\u4e8e Pod \u7684 IP \u5219\u4e0d\u4e00\u6837\uff0c\u56e0\u4e3a\u6211\u4eec\u77e5\u9053 Pod IP \u662f\u4e0d\u56fa\u5b9a\u7684\uff0cPod \u91cd\u5efa\u4e86\u5c31\u53d8\u4e86\uff0c\u5b83\u5c5e\u4e8e\u72b6\u6001\u6570\u636e\uff0c\u6240\u4ee5\u6211\u4eec\u4f7f\u7528 status \u8fd9\u4e2a\u5c5e\u6027\u53bb\u83b7\u53d6\u3002\u53e6\u5916\u9664\u4e86\u4f7f\u7528 <code>fieldRef</code>\u83b7\u53d6 Pod \u7684\u57fa\u672c\u4fe1\u606f\u5916\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7 <code>resourceFieldRef</code> \u53bb\u83b7\u53d6\u5bb9\u5668\u7684\u8d44\u6e90\u8bf7\u6c42\u548c\u8d44\u6e90\u9650\u5236\u4fe1\u606f\u3002</p> <p>\u6211\u4eec\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 Pod\uff1a</p> <pre><code>$ kubectl create -f env-pod.yaml\npod \"env-pod\" created\n</code></pre> <p>Pod \u521b\u5efa\u6210\u529f\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u65e5\u5fd7\uff1a</p> <pre><code>$ kubectl logs env-pod -n kube-system |grep POD\nkubectl logs -f env-pod -n kube-system\nPOD_IP=2121\nKUBERNETES_SERVICE_PORT=443\nKUBERNETES_PORT=tcp://1:443\nKUBE_DNS_SERVICE_PORT_DNS_TCP=53\nHOSTNAME=env-pod\nSHLVL=1\nHOME=/root\nKUBE_DNS_SERVICE_HOST=10\nKUBE_DNS_PORT_9153_TCP_ADDR=10\nKUBE_DNS_PORT_9153_TCP_PORT=9153\nKUBE_DNS_PORT_9153_TCP_PROTO=tcp\nKUBE_DNS_SERVICE_PORT=53\nKUBE_DNS_PORT=udp://10:53\nPOD_NAME=env-pod\nKUBERNETES_PORT_443_TCP_ADDR=1\nPATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\nKUBE_DNS_PORT_53_TCP_ADDR=10\nKUBERNETES_PORT_443_TCP_PORT=443\nKUBE_DNS_SERVICE_PORT_METRICS=9153\nKUBERNETES_PORT_443_TCP_PROTO=tcp\nKUBE_DNS_PORT_9153_TCP=tcp://10:9153\nKUBE_DNS_PORT_53_UDP_ADDR=10\nKUBE_DNS_PORT_53_TCP_PORT=53\nKUBE_DNS_PORT_53_TCP_PROTO=tcp\nKUBE_DNS_PORT_53_UDP_PORT=53\nKUBE_DNS_SERVICE_PORT_DNS=53\nKUBE_DNS_PORT_53_UDP_PROTO=udp\nKUBERNETES_SERVICE_PORT_HTTPS=443\nKUBERNETES_PORT_443_TCP=tcp://1:443\nPOD_NAMESPACE=kube-system\nKUBERNETES_SERVICE_HOST=1\nPWD=/\nKUBE_DNS_PORT_53_TCP=tcp://10:53\nKUBE_DNS_PORT_53_UDP=udp://10:53\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Pod \u7684 IP\u3001NAME\u3001NAMESPACE \u90fd\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u6253\u5370\u51fa\u6765\u4e86\u3002</p> <p>\u73af\u5883\u53d8\u91cf</p> <p>\u4e0a\u9762\u6253\u5370 Pod \u7684\u73af\u5883\u53d8\u91cf\u53ef\u4ee5\u770b\u5230\u6709\u5f88\u591a\u5185\u7f6e\u7684\u53d8\u91cf\uff0c\u5176\u4e2d\u5927\u90e8\u5206\u662f\u7cfb\u7edf\u81ea\u52a8\u4e3a\u6211\u4eec\u6dfb\u52a0\u7684\uff0cKubernetes \u4f1a\u628a\u5f53\u524d\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684 Service \u4fe1\u606f\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u7684\u5f62\u5f0f\u6ce8\u5165\u5230 Pod \u4e2d\u53bb\uff1a</p> <pre><code>$ kubectl get svc -n kube-system\nNAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE\nkube-dns   ClusterIP   10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   4d21h\n</code></pre>"},{"location":"kubernetes_basic/pod_deep/#volume","title":"Volume \u6302\u8f7d","text":"<p><code>Downward API</code>\u9664\u4e86\u63d0\u4f9b\u73af\u5883\u53d8\u91cf\u7684\u65b9\u5f0f\u5916\uff0c\u8fd8\u63d0\u4f9b\u4e86\u901a\u8fc7 Volume \u6302\u8f7d\u7684\u65b9\u5f0f\u53bb\u83b7\u53d6 Pod \u7684\u57fa\u672c\u4fe1\u606f\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u901a\u8fc7<code>Downward API</code>\u5c06 Pod \u7684 Label\u3001Annotation \u7b49\u4fe1\u606f\u901a\u8fc7 Volume \u6302\u8f7d\u5230\u5bb9\u5668\u7684\u67d0\u4e2a\u6587\u4ef6\u4e2d\u53bb\uff0c\u7136\u540e\u5728\u5bb9\u5668\u4e2d\u6253\u5370\u51fa\u8be5\u6587\u4ef6\u7684\u503c\u6765\u9a8c\u8bc1\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a(volume-pod.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: volume-pod\n  namespace: kube-system\n  labels:\n    k8s-app: test-volume\n    node-env: test\n  annotations:\n    own: youdianzhishi\n    build: test\nspec:\n  volumes:\n  - name: podinfo\n    downwardAPI:\n      items:\n      - path: labels\n        fieldRef:\n          fieldPath: metadata.labels\n      - path: annotations\n        fieldRef:\n          fieldPath: metadata.annotations\n  containers:\n  - name: volume-pod\n    image: busybox\n    args: \n    - sleep \n    - \"3600\"\n    volumeMounts:\n    - name: podinfo\n      mountPath: /etc/podinfo\n</code></pre> <p>\u6211\u4eec\u5c06\u5143\u6570\u636e labels \u548c annotaions \u4ee5\u6587\u4ef6\u7684\u5f62\u5f0f\u6302\u8f7d\u5230\u4e86 <code>/etc/podinfo</code> \u76ee\u5f55\u4e0b\uff0c\u521b\u5efa\u4e0a\u9762\u7684 Pod\uff1a</p> <pre><code>$ kubectl create -f volume-pod.yaml\npod \"volume-pod\" created\n</code></pre> <p>\u521b\u5efa\u6210\u529f\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u8fdb\u5165\u5230\u5bb9\u5668\u4e2d\u67e5\u770b\u5143\u4fe1\u606f\u662f\u4e0d\u662f\u5df2\u7ecf\u5b58\u5165\u5230\u6587\u4ef6\u4e2d\u4e86\uff1a</p> <pre><code>$ kubectl exec -it volume-pod /bin/sh -n kube-system\n/ # ls /etc/podinfo/\n..2019_11_13_09_57_990445016/  annotations\n..data/                           labels\n/ # cat /etc/podinfo/labels\nk8s-app=\"test-volume\"\n/ # cat /etc/podinfo/annotations\nbuild=\"test\"\nkubectl.kubernetes.io/last-applied-configuration=\"{\\\\\"apiVersion\\\\\":\\\\\"v1\\\\\",\\\\\"kind\\\\\":\\\\\"Pod\\\\\",\\\\\"metadata\\\\\":{\\\\\"annotations\\\\\":{\\\\\"build\\\\\":\\\\\"test\\\\\",\\\\\"own\\\\\":\\\\\"youdianzhishi\\\\\"},\\\\\"labels\\\\\":{\\\\\"k8s-app\\\\\":\\\\\"test-volume\\\\\",\\\\\"node-env\\\\\":\\\\\"test\\\\\"},\\\\\"name\\\\\":\\\\\"volume-pod\\\\\",\\\\\"namespace\\\\\":\\\\\"kube-system\\\\\"},\\\\\"spec\\\\\":{\\\\\"containers\\\\\":[{\\\\\"args\\\\\":[\\\\\"sleep\\\\\",\\\\\"3600\\\\\"],\\\\\"image\\\\\":\\\\\"busybox\\\\\",\\\\\"name\\\\\":\\\\\"volume-pod\\\\\",\\\\\"volumeMounts\\\\\":[{\\\\\"mountPath\\\\\":\\\\\"/etc/podinfo\\\\\",\\\\\"name\\\\\":\\\\\"podinfo\\\\\"}]}],\\\\\"volumes\\\\\":[{\\\\\"downwardAPI\\\\\":{\\\\\"items\\\\\":[{\\\\\"fieldRef\\\\\":{\\\\\"fieldPath\\\\\":\\\\\"metadata.labels\\\\\"},\\\\\"path\\\\\":\\\\\"labels\\\\\"},{\\\\\"fieldRef\\\\\":{\\\\\"fieldPath\\\\\":\\\\\"metadata.annotations\\\\\"},\\\\\"path\\\\\":\\\\\"annotations\\\\\"}]},\\\\\"name\\\\\":\\\\\"podinfo\\\\\"}]}}\\\\n\"\nkubernetes.io/config.seen=\"2019-11-13T17:57:320894744+08:00\"\nkubernetes.io/config.source=\"api\"\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Pod \u7684 Labels \u548c Annotations \u4fe1\u606f\u90fd\u88ab\u6302\u8f7d\u5230 <code>/etc/podinfo</code> \u76ee\u5f55\u4e0b\u9762\u7684 lables \u548c annotations \u6587\u4ef6\u4e86\u3002</p> <p>\u76ee\u524d\uff0c<code>Downward API</code> \u652f\u6301\u7684\u5b57\u6bb5\u5df2\u7ecf\u975e\u5e38\u4e30\u5bcc\u4e86\uff0c\u6bd4\u5982\uff1a</p> <pre><code>\u4f7f\u7528 fieldRef \u53ef\u4ee5\u58f0\u660e\u4f7f\u7528:\n\nspec.nodeName - \u5bbf\u4e3b\u673a\u540d\u5b57\nstatus.hostIP - \u5bbf\u4e3b\u673aIP\nmetadata.name - Pod\u7684\u540d\u5b57\nmetadata.namespace - Pod\u7684Namespace\nstatus.podIP - Pod\u7684IP\nspec.serviceAccountName - Pod\u7684Service Account\u7684\u540d\u5b57\nmetadata.uid - Pod\u7684UID\nmetadata.labels['&lt;KEY&gt;'] - \u6307\u5b9a&lt;KEY&gt;\u7684Label\u503c\nmetadata.annotations['&lt;KEY&gt;'] - \u6307\u5b9a&lt;KEY&gt;\u7684Annotation\u503c\nmetadata.labels - Pod\u7684\u6240\u6709Label\nmetadata.annotations - Pod\u7684\u6240\u6709Annotation\n\n \u4f7f\u7528 resourceFieldRef \u53ef\u4ee5\u58f0\u660e\u4f7f\u7528:\n\n\u5bb9\u5668\u7684 CPU limit\n\u5bb9\u5668\u7684 CPU request\n\u5bb9\u5668\u7684 memory limit\n\u5bb9\u5668\u7684 memory request\n</code></pre> <p>\u6ce8\u610f</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c<code>Downward API</code> \u80fd\u591f\u83b7\u53d6\u5230\u7684\u4fe1\u606f\uff0c\u4e00\u5b9a\u662f Pod \u91cc\u7684\u5bb9\u5668\u8fdb\u7a0b\u542f\u52a8\u4e4b\u524d\u5c31\u80fd\u591f\u786e\u5b9a\u4e0b\u6765\u7684\u4fe1\u606f\u3002\u800c\u5982\u679c\u4f60\u60f3\u8981\u83b7\u53d6 Pod \u5bb9\u5668\u8fd0\u884c\u540e\u624d\u4f1a\u51fa\u73b0\u7684\u4fe1\u606f\uff0c\u6bd4\u5982\uff0c\u5bb9\u5668\u8fdb\u7a0b\u7684 PID\uff0c\u90a3\u5c31\u80af\u5b9a\u4e0d\u80fd\u4f7f\u7528 <code>Downward API</code> \u4e86\uff0c\u800c\u5e94\u8be5\u8003\u8651\u5728 Pod \u91cc\u5b9a\u4e49\u4e00\u4e2a sidecar \u5bb9\u5668\u6765\u83b7\u53d6\u4e86\u3002</p> <p>\u5728\u5b9e\u9645\u5e94\u7528\u4e2d\uff0c\u5982\u679c\u4f60\u7684\u5e94\u7528\u6709\u83b7\u53d6 Pod \u7684\u57fa\u672c\u4fe1\u606f\u7684\u9700\u6c42\uff0c\u4e00\u822c\u6211\u4eec\u5c31\u53ef\u4ee5\u5229\u7528<code>Downward API</code>\u6765\u83b7\u53d6\u57fa\u672c\u4fe1\u606f\uff0c\u7136\u540e\u7f16\u5199\u4e00\u4e2a\u542f\u52a8\u811a\u672c\u6216\u8005\u5229\u7528<code>initContainer</code>\u5c06 Pod \u7684\u4fe1\u606f\u6ce8\u5165\u5230\u6211\u4eec\u5bb9\u5668\u4e2d\u53bb\uff0c\u7136\u540e\u5728\u6211\u4eec\u81ea\u5df1\u7684\u5e94\u7528\u4e2d\u5c31\u53ef\u4ee5\u6b63\u5e38\u7684\u5904\u7406\u76f8\u5173\u903b\u8f91\u4e86\u3002</p> <p>\u9664\u4e86\u901a\u8fc7 Downward API \u53ef\u4ee5\u83b7\u53d6\u5230 Pod \u672c\u8eab\u7684\u4fe1\u606f\u4e4b\u5916\uff0c\u5176\u5b9e\u6211\u4eec\u8fd8\u53ef\u4ee5\u901a\u8fc7\u6620\u5c04\u5176\u4ed6\u8d44\u6e90\u5bf9\u8c61\u6765\u83b7\u53d6\u5bf9\u5e94\u7684\u4fe1\u606f\uff0c\u6bd4\u5982 Secret\u3001ConfigMap \u8d44\u6e90\u5bf9\u8c61\uff0c\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u548c\u6302\u8f7d Volume \u7684\u65b9\u5f0f\u6765\u83b7\u53d6\u4ed6\u4eec\u7684\u4fe1\u606f\uff0c\u4f46\u662f\uff0c\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u83b7\u53d6\u8fd9\u4e9b\u4fe1\u606f\u7684\u65b9\u5f0f\uff0c\u4e0d\u5177\u5907\u81ea\u52a8\u66f4\u65b0\u7684\u80fd\u529b\u3002\u6240\u4ee5\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u90fd\u5efa\u8bae\u4f7f\u7528 Volume \u6587\u4ef6\u7684\u65b9\u5f0f\u83b7\u53d6\u8fd9\u4e9b\u4fe1\u606f\uff0c\u56e0\u4e3a\u901a\u8fc7 Volume \u7684\u65b9\u5f0f\u6302\u8f7d\u7684\u6587\u4ef6\u5728 Pod \u4e2d\u4f1a\u8fdb\u884c\u70ed\u66f4\u65b0\u3002</p>"},{"location":"kubernetes_basic/pod_deep/#podpreset","title":"PodPreset","text":"<p>\u6211\u4eec\u5df2\u7ecf\u5b66\u4e60\u4e86\u5f88\u591a Pod \u7684\u77e5\u8bc6\u70b9\uff0c\u4f46\u662f\u53ef\u80fd\u6709\u90e8\u5206\u540c\u5b66\u8fd8\u662f\u89c9\u5f97 Pod \u7684\u5b57\u6bb5\u5c5e\u6027\u592a\u591a\u4e86\uff0c\u5f88\u591a\u8bb0\u4e0d\u4f4f\uff0c\u67e5\u8be2\u6587\u6863\u6548\u7387\u4e0d\u9ad8\uff0c\u4f60\u662f\u4e0d\u662f\u5e0c\u671b Kubernetes \u80fd\u591f\u63d0\u4f9b\u4e00\u4e2a\u529f\u80fd\u4e3a Pod \u81ea\u52a8\u586b\u5145\u4e00\u4e9b\u5b57\u6bb5\u5462\uff1f\u8fd9\u4e2a\u9700\u6c42\u8fd8\u662f\u5f88\u5b9e\u9645\u7684\uff0c\u6bd4\u5982\u6211\u4eec\u6309\u7167\u547d\u540d\u7a7a\u95f4\u6765\u5212\u5206\u4e0d\u540c\u7684\u73af\u5883\uff0c\u7136\u540e\u6211\u4eec\u5728\u4e0d\u540c\u7684\u73af\u5883\u4e0a\u90e8\u7f72 Pod \u540e\u81ea\u52a8\u4e3a\u6211\u4eec\u52a0\u4e0a\u73af\u5883\u76f8\u5173\u7684 Labels\u3001Annotations \u7b49\u7b49\u4fe1\u606f\uff0c\u8fd9\u6837\u5c31\u5927\u5927\u63d0\u9ad8\u4e86\u7f16\u5199 YAML \u7684\u6548\u7387\uff0c\u4e3a\u6b64\uff0c\u5728 Kubernetes v1.11 \u7248\u672c\u540e\u5c31\u63d0\u4f9b\u4e86\u4e00\u4e2a\u53eb\u505a <code>PodPreset\uff08Pod \u9884\u8bbe\u503c\uff09</code>\u7684\u529f\u80fd\u53ef\u4ee5\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u3002</p> <p>Kubernetes \u63d0\u4f9b\u4e86\u4e00\u4e2a <code>PodPreset</code> \u51c6\u5165\u63a7\u5236\u5668\uff0c\u5f53\u542f\u7528\u540e\uff0cPodPreset \u4f1a\u5c06\u5e94\u7528\u521b\u5efa\u8bf7\u6c42\u4f20\u5165\u5230\u8be5\u63a7\u5236\u5668\u4e0a\u3002\u5f53\u6709 Pod \u521b\u5efa\u8bf7\u6c42\u53d1\u751f\u65f6\uff0c\u7cfb\u7edf\u5c06\u6267\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a</p> <ul> <li>\u68c0\u7d22\u6240\u6709\u53ef\u7528\u7684 PodPreset</li> <li>\u68c0\u67e5\u6709 PodPreset \u7684\u6807\u7b7e\u9009\u62e9\u5668\u4e0a\u7684\u6807\u7b7e\u4e0e\u6b63\u5728\u521b\u5efa\u7684 Pod \u4e0a\u7684\u6807\u7b7e\u662f\u5426\u5339\u914d</li> <li>\u5c1d\u8bd5\u5c06\u7531 PodPreset \u5b9a\u4e49\u7684\u5404\u79cd\u8d44\u6e90\u5408\u5e76\u5230\u6b63\u5728\u521b\u5efa\u7684 Pod \u4e2d</li> <li>\u51fa\u73b0\u9519\u8bef\u65f6\uff0c\u5728\u8be5 Pod \u4e0a\u5f15\u53d1\u8bb0\u5f55\u5408\u5e76\u9519\u8bef\u7684\u4e8b\u4ef6\uff0cPodPreset \u4e0d\u4f1a\u6ce8\u5165\u4efb\u4f55\u8d44\u6e90\u5230\u521b\u5efa\u7684 Pod \u4e2d</li> <li> <p>\u6ce8\u91ca\u521a\u751f\u6210\u7684\u4fee\u6539\u8fc7\u7684 Pod spec\uff0c\u4ee5\u8868\u660e\u5b83\u5df2\u88ab PodPreset \u4fee\u6539\u8fc7\u3002\u6ce8\u91ca\u7684\u683c\u5f0f\u4e3a </p> <pre><code>podpreset.admission.kubernetes.io/podpreset-&lt;pod-preset name&gt;\": \"&lt;resource version&gt;\"\n</code></pre> </li> </ul> <p>\u6bcf\u4e2a Pod \u53ef\u4ee5\u5339\u914d\u96f6\u4e2a\u6216\u591a\u4e2a PodPrestet\uff1b\u5e76\u4e14\u6bcf\u4e2a PodPreset \u53ef\u4ee5\u5e94\u7528\u4e8e\u96f6\u4e2a\u6216\u591a\u4e2a Pod\u3002 PodPreset \u5e94\u7528\u4e8e\u4e00\u4e2a\u6216\u591a\u4e2a Pod \u65f6\uff0cKubernetes \u4f1a\u4fee\u6539 Pod Spec\u3002\u5bf9\u4e8e Env\u3001EnvFrom \u548c VolumeMounts \u7684\u66f4\u6539\uff0cKubernetes \u4fee\u6539 Pod \u4e2d\u6240\u6709\u5bb9\u5668\u7684\u5bb9\u5668 spec\uff1b\u5bf9\u4e8e Volume \u7684\u66f4\u6539\uff0cKubernetes \u4fee\u6539 Pod Spec\u3002</p> <p>\u53ef\u80fd\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u60a8\u5e0c\u671b\u4f60\u7684 Pod \u4e0d\u4f1a\u88ab\u4efb\u4f55 Pod Preset \u6240\u6539\u53d8\u3002\u5728\u8fd9\u4e9b\u60c5\u51b5\u4e0b\uff0c\u60a8\u53ef\u4ee5\u5728 Pod \u7684 Pod Spec \u4e2d\u6dfb\u52a0\u4e0a\u8fd9\u6837\u4e00\u4e2a annotation\uff1a</p> <pre><code>podpreset.admission.kubernetes.io/exclude\uff1a\"true\"\n</code></pre> <p>\u3002</p>"},{"location":"kubernetes_basic/pod_deep/#podpreset_1","title":"\u542f\u7528 PodPreset","text":"<p>\u8981\u542f\u7528<code>PodPreset</code>\u529f\u80fd\uff0c\u9700\u8981\u786e\u4fdd\u4f60\u4f7f\u7528\u7684\u662f kubernetes 1.8\u7248\u672c\u4ee5\u4e0a\uff0c\u7136\u540e\u9700\u8981\u5728\u51c6\u5165\u63a7\u5236\u4e2d\u52a0\u5165<code>PodPreset</code>\uff0c\u53e6\u5916\u4e3a\u4e86\u5b9a\u4e49 PodPreset \u5bf9\u8c61\uff0c\u8fd8\u9700\u8981\u5176\u4e2d PodPreset \u7684 API \u7248\u672c\uff0c\u5728 APIServer \u542f\u52a8\u53c2\u6570\u4e2d\u6dfb\u52a0\u5982\u4e0b\u914d\u7f6e\uff1a</p> <pre><code>- --enable-admission-plugins=NodeRestriction,PodPreset\n- --runtime-config=settings.k8s.io/v1alpha1=true\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u662f\u4f7f\u7528\u7684 kubeadm \u642d\u5efa\u7684\u96c6\u7fa4\uff0c\u6240\u4ee5\u53ea\u9700\u8981\u4fee\u6539\u9759\u6001 Pod \u914d\u7f6e\u5373\u53ef\uff0c\u8def\u5f84 </p> <pre><code>/etc/kubernetes/manifests/kube-apiserver.yaml\n</code></pre> <p>\uff0c\u4fee\u6539\u5b8c\u6210\u540e\uff0c\u5c06 <code>kube-apiserver.yaml</code> \u6587\u4ef6\u79fb\u9664 manifests \u76ee\u5f55\uff0c\u7136\u540e\u79fb\u52a8\u56de\u6765\uff0c\u76f8\u5f53\u4e8e\u5f3a\u5236\u91cd\u542f\uff0c\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl api-versions |grep settings\nsettings.k8s.io/v1alpha1\n$ kubectl get podpreset\nNo resources found in default namespace.\n</code></pre> <p>\u51fa\u73b0\u5982\u4e0a\u7684\u63d0\u793a\u8bc1\u660e\u5df2\u7ecf\u5f00\u542f\u6210\u529f\u3002</p>"},{"location":"kubernetes_basic/pod_deep/#_3","title":"\u793a\u4f8b","text":"<p>\u6211\u4eec\u7ecf\u5e38\u6709\u4e00\u4e2a\u9700\u6c42\u5c31\u662f\u9700\u8981\u540c\u6b65 Pod \u548c\u5bbf\u4e3b\u673a\u7684\u65f6\u95f4\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u662f\u901a\u8fc7\u6302\u8f7d\u5bbf\u4e3b\u673a\u7684 localtime \u6765\u5b8c\u6210\u7684\uff0c\u5982\u4e0b Pod\uff1a\uff08time-demo.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Pod\nmetadata:\n  name: time-demo\n  labels:\n    app: time\nspec:\n  containers:\n  - name: time-demo\n    image: nginx\n    ports:\n    - containerPort: 80\n</code></pre> <p>\u6211\u4eec\u76f4\u63a5\u521b\u5efa\u8be5 Pod\uff1a</p> <pre><code>$ kubectl apply -f time-demo.yaml\n$ kubectl get pods\nNAME         READY   STATUS    RESTARTS   AGE\ntime-demo    1/1     Running   0          2m8s\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5bf9\u6bd4\u4e0b\u8282\u70b9\u7684\u65f6\u95f4\u548c Pod \u7684\u65f6\u95f4\uff1a</p> <pre><code>$ date\nThu Nov 14 12:08:27 CST 2019\n$ kubectl exec time-demo date\nThu Nov 14 04:08:41 UTC 2019\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Pod \u7684\u65f6\u95f4\u662f UTC \u65f6\u95f4\uff0c\u548c\u8282\u70b9\u4e0d\u540c\u6b65\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u6302\u8f7d\u5bbf\u4e3b\u673a\u7684 localtime \u6587\u4ef6\u5230 Pod \u4e2d\u53bb\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: Pod\nmetadata:\n  name: time-demo\n  labels:\n    app: time\nspec:\n  volumes:\n  - name: host-time\n    hostPath:\n      path: /etc/localtime\n  containers:\n  - name: time-demo\n    image: nginx\n    volumeMounts:\n    - name: host-time\n      mountPath: /etc/localtime\n    ports:\n    - containerPort: 80\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u91cd\u65b0\u6765\u6d4b\u8bd5\u4e0b\uff1a</p> <pre><code>$ kubectl delete -f time-demo.yaml\n$ kubectl apply -f time-demo.yaml\n$ kubectl get pods\nNAME         READY   STATUS    RESTARTS   AGE\ntime-demo    1/1     Running   0          2m8s\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u518d\u6765\u770b\u4e0b\u65f6\u95f4\u662f\u5426\u540c\u6b65\u4e86\uff1a</p> <pre><code>$ date\nThu Nov 14 12:13:40 CST 2019\n$ kubectl exec time-demo date\nThu Nov 14 12:13:45 CST 2019\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u751f\u6548\u4e86\u3002\u4f46\u662f\u5f80\u5f80\u6211\u4eec\u6240\u6709\u7684 Pod \u90fd\u6709\u65f6\u95f4\u540c\u6b65\u7684\u9700\u6c42\uff0c\u5982\u679c\u6240\u6709\u7684 Pod \u90fd\u6765\u624b\u52a8\u8fdb\u884c\u6302\u8f7d\uff0c\u662f\u4e0d\u662f\u663e\u5f97\u7e41\u7410\u591a\u4f59\u554a\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u53ef\u4ee5\u5229\u7528 PodPreset \u6765\u9884\u8bbe\u6a21\u677f\uff0c\u5b9a\u4e49\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 PodPreset \u8d44\u6e90\u5bf9\u8c61\uff1a\uff08time-preset.yaml\uff09</p> <pre><code>apiVersion: settings.k8s.io/v1alpha1\nkind: PodPreset\nmetadata:\n  name: time-preset\n  namespace: default\nspec:\n  selector:\n    matchLabels:\n  volumeMounts:\n  - name: localtime\n    mountPath: /etc/localtime\n  volumes:\n  - name: localtime\n    hostPath:\n      path: /etc/localtime\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f time-preset.yaml\npodpreset.settings.k8s.io/time-preset created\n$ kubectl get podpreset\nNAME          CREATED AT\ntime-preset   2019-11-14T06:52:11Z\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u518d\u6765\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 Pod\uff1a(time-demo.yaml)</p> <pre><code>apiVersion: apps/v1\nkind: Pod\nmetadata:\n  name: time-demo\n  labels:\n    app: time\nspec:\n  containers:\n  - name: time-demo\n    image: nginx\n    ports:\n    - containerPort: 80\n</code></pre> <p>\u8fd9\u4e2a Pod \u6211\u4eec\u6ca1\u6709\u4e3b\u52a8\u6302\u8f7d\u65f6\u95f4\u6587\u4ef6\uff0c\u76f4\u63a5\u521b\u5efa\uff1a</p> <pre><code>$ kubectl delete -f time-demo.yaml\n$ kubectl apply -f time-demo.yaml\n$  kubectl get pods -l app=time\nNAME        READY   STATUS    RESTARTS   AGE\ntime-demo   1/1     Running   0          60s\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u9a8c\u8bc1\u4e0b Pod \u65f6\u95f4\u662f\u5426\u548c\u5bbf\u4e3b\u673a\u4e00\u81f4\uff1a</p> <pre><code>$ date\nThu Nov 14 14:55:02 CST 2019\n$ kubectl exec time-demo date\nThu Nov 14 14:55:21 CST 2019\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u540c\u6b65\u4e86~\uff0c\u53ef\u4ee5\u76f4\u63a5\u5bfc\u51fa Pod \u7684\u8d44\u6e90\u6e05\u5355\u67e5\u770b\uff1a</p> <pre><code>$ kubectl get pod time-demo -o yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  annotations:\n    kubectl.kubernetes.io/last-applied-configuration: |\n      {\"apiVersion\":\"v1\",\"kind\":\"Pod\",\"metadata\":{\"annotations\":{},\"labels\":{\"app\":\"time\"},\"name\":\"time-demo\",\"namespace\":\"default\"},\"spec\":{\"containers\":[{\"image\":\"nginx\",\"name\":\"time-demo\",\"ports\":[{\"containerPort\":80}]}]}}\n    podpreset.admission.kubernetes.io/podpreset-time-preset: \"1469811\"\n  creationTimestamp: \"2019-11-14T06:54:06Z\"\n  labels:\n    app: time\n  name: time-demo\n  namespace: default\n  resourceVersion: \"1470398\"\n  selfLink: /api/v1/namespaces/default/pods/time-demo\n  uid: 37a7ab94-c2c3-4b10-88df-0c486fb8d422\nspec:\n  containers:\n  - image: nginx\n    imagePullPolicy: Always\n    name: time-demo\n    ports:\n    - containerPort: 80\n      protocol: TCP\n    resources: {}\n    terminationMessagePath: /dev/termination-log\n    terminationMessagePolicy: File\n    volumeMounts:\n    - mountPath: /etc/localtime\n      name: localtime\n    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount\n      name: default-token-5tsh4\n      readOnly: true\n  dnsPolicy: ClusterFirst\n  enableServiceLinks: true\n  nodeName: ydzs-node3\n  priority: 0\n  restartPolicy: Always\n  schedulerName: default-scheduler\n  securityContext: {}\n  serviceAccount: default\n  serviceAccountName: default\n  terminationGracePeriodSeconds: 30\n  tolerations:\n  - effect: NoExecute\n    key: node.kubernetes.io/not-ready\n    operator: Exists\n    tolerationSeconds: 300\n  - effect: NoExecute\n    key: node.kubernetes.io/unreachable\n    operator: Exists\n    tolerationSeconds: 300\n  volumes:\n  - hostPath:\n      path: /etc/localtime\n      type: \"\"\n    name: localtime\n  - name: default-token-5tsh4\n    secret:\n      defaultMode: 420\n      secretName: default-token-5tsh4\nstatus:\n  conditions:\n  - lastProbeTime: null\n    lastTransitionTime: \"2019-11-14T06:54:06Z\"\n    status: \"True\"\n    type: Initialized\n  - lastProbeTime: null\n    lastTransitionTime: \"2019-11-14T06:54:22Z\"\n    status: \"True\"\n    type: Ready\n  - lastProbeTime: null\n    lastTransitionTime: \"2019-11-14T06:54:22Z\"\n    status: \"True\"\n    type: ContainersReady\n  - lastProbeTime: null\n    lastTransitionTime: \"2019-11-14T06:54:06Z\"\n    status: \"True\"\n    type: PodScheduled\n  containerStatuses:\n  - containerID: docker://a774e82d4ebfde98c37b675f1a46377ccf01c0bba931507172309616dbf49165\n    image: nginx:latest\n    imageID: docker-pullable://nginx@sha256:922c815aa4df050d4df476e92daed4231f466acc8ee90e0e774951b0fd7195a4\n    lastState: {}\n    name: time-demo\n    ready: true\n    restartCount: 0\n    started: true\n    state:\n      running:\n        startedAt: \"2019-11-14T06:54:21Z\"\n  hostIP: 157\n  phase: Running\n  podIP: 264\n  podIPs:\n  - ip: 264\n  qosClass: BestEffort\n  startTime: \"2019-11-14T06:54:06Z\"\n</code></pre> <p>\u4ece\u4e0a\u9762 YAML \u4e2d\u4e5f\u53ef\u4ee5\u770b\u51fa Pod \u88ab\u81ea\u52a8\u6ce8\u5165\u4e86 PodPreset \u58f0\u660e\u7684\u6a21\u677f\uff0c\u800c\u4e14\u8be5\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684\u6240\u6709 Pod \u9ed8\u8ba4\u90fd\u4f1a\u88ab\u6ce8\u5165\u8be5\u6a21\u677f\u3002</p> <p>\u6ce8\u610f</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f PodPreset \u8d44\u6e90\u5bf9\u8c61\u662f namespace scope \u7684\uff0c\u5c31\u662f\u4e0d\u540c\u7684\u547d\u540d\u7a7a\u95f4\u9700\u8981\u521b\u5efa\u4e0d\u540c\u7684 PodPreset\u3002</p>"},{"location":"kubernetes_basic/pod_life/","title":"Pod\u7684\u751f\u547d\u5468\u671f","text":"<p>\ue3c9</p>"},{"location":"kubernetes_basic/pod_life/#pod","title":"Pod \u7684\u751f\u547d\u5468\u671f","text":"<p>\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u4e86\u89e3\u4e86 Pod \u7684\u8bbe\u8ba1\u539f\u7406\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u4e86\u89e3\u4e0b Pod \u7684\u751f\u547d\u5468\u671f\u3002\u4e0b\u56fe\u5c55\u793a\u4e86\u4e00\u4e2a Pod \u7684\u5b8c\u6574\u751f\u547d\u5468\u671f\u8fc7\u7a0b\uff0c\u5176\u4e2d\u5305\u542b <code>Init Container</code>\u3001<code>Pod Hook</code>\u3001<code>\u5065\u5eb7\u68c0\u67e5</code> \u4e09\u4e2a\u4e3b\u8981\u90e8\u5206\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u5206\u522b\u4ecb\u7ecd\u5f71\u54cd Pod \u751f\u547d\u5468\u671f\u7684\u90e8\u5206\uff1a</p> <p>\u9996\u5148\u5728\u4ecb\u7ecd Pod \u7684\u751f\u547d\u5468\u671f\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u4e86\u89e3\u4e0b Pod \u7684\u72b6\u6001\uff0c\u56e0\u4e3a Pod \u72b6\u6001\u53ef\u4ee5\u53cd\u5e94\u51fa\u5f53\u524d\u6211\u4eec\u7684 Pod \u7684\u5177\u4f53\u72b6\u6001\u4fe1\u606f\uff0c\u4e5f\u662f\u6211\u4eec\u5206\u6790\u6392\u9519\u7684\u4e00\u4e2a\u5fc5\u5907\u7684\u65b9\u5f0f\u3002</p>"},{"location":"kubernetes_basic/pod_life/#pod_1","title":"Pod \u72b6\u6001","text":"<p>\u9996\u5148\u5148\u4e86\u89e3\u4e0b Pod \u7684\u72b6\u6001\u503c\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 </p> <pre><code>kubectl explain pod.status\n</code></pre> <p>\u547d\u4ee4\u6765\u4e86\u89e3\u5173\u4e8e Pod \u72b6\u6001\u7684\u4e00\u4e9b\u4fe1\u606f\uff0cPod \u7684\u72b6\u6001\u5b9a\u4e49\u5728 <code>PodStatus</code> \u5bf9\u8c61\u4e2d\uff0c\u5176\u4e2d\u6709\u4e00\u4e2a <code>phase</code> \u5b57\u6bb5\uff0c\u4e0b\u9762\u662f <code>phase</code> \u7684\u53ef\u80fd\u53d6\u503c\uff1a</p> <ul> <li>\u6302\u8d77\uff08Pending\uff09\uff1aPod \u4fe1\u606f\u5df2\u7ecf\u63d0\u4ea4\u7ed9\u4e86\u96c6\u7fa4\uff0c\u4f46\u662f\u8fd8\u6ca1\u6709\u88ab\u8c03\u5ea6\u5668\u8c03\u5ea6\u5230\u5408\u9002\u7684\u8282\u70b9\u6216\u8005 Pod \u91cc\u7684\u955c\u50cf\u6b63\u5728\u4e0b\u8f7d</li> <li>\u8fd0\u884c\u4e2d\uff08Running\uff09\uff1a\u8be5 Pod \u5df2\u7ecf\u7ed1\u5b9a\u5230\u4e86\u4e00\u4e2a\u8282\u70b9\u4e0a\uff0cPod \u4e2d\u6240\u6709\u7684\u5bb9\u5668\u90fd\u5df2\u88ab\u521b\u5efa\u3002\u81f3\u5c11\u6709\u4e00\u4e2a\u5bb9\u5668\u6b63\u5728\u8fd0\u884c\uff0c\u6216\u8005\u6b63\u5904\u4e8e\u542f\u52a8\u6216\u91cd\u542f\u72b6\u6001</li> <li>\u6210\u529f\uff08Succeeded\uff09\uff1aPod \u4e2d\u7684\u6240\u6709\u5bb9\u5668\u90fd\u88ab\u6210\u529f\u7ec8\u6b62\uff0c\u5e76\u4e14\u4e0d\u4f1a\u518d\u91cd\u542f</li> <li>\u5931\u8d25\uff08Failed\uff09\uff1aPod \u4e2d\u7684\u6240\u6709\u5bb9\u5668\u90fd\u5df2\u7ec8\u6b62\u4e86\uff0c\u5e76\u4e14\u81f3\u5c11\u6709\u4e00\u4e2a\u5bb9\u5668\u662f\u56e0\u4e3a\u5931\u8d25\u7ec8\u6b62\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5bb9\u5668\u4ee5\u975e<code>0</code>\u72b6\u6001\u9000\u51fa\u6216\u8005\u88ab\u7cfb\u7edf\u7ec8\u6b62</li> <li>\u672a\u77e5\uff08Unknown\uff09\uff1a\u56e0\u4e3a\u67d0\u4e9b\u539f\u56e0\u65e0\u6cd5\u53d6\u5f97 Pod \u7684\u72b6\u6001\uff0c\u901a\u5e38\u662f\u56e0\u4e3a\u4e0e Pod \u6240\u5728\u4e3b\u673a\u901a\u4fe1\u5931\u8d25\u5bfc\u81f4\u7684</li> </ul> <p>\u9664\u6b64\u4e4b\u5916\uff0c<code>PodStatus</code> \u5bf9\u8c61\u4e2d\u8fd8\u5305\u542b\u4e00\u4e2a <code>PodCondition</code> \u7684\u6570\u7ec4\uff0c\u91cc\u9762\u5305\u542b\u7684\u5c5e\u6027\u6709\uff1a</p> <ul> <li>lastProbeTime\uff1a\u6700\u540e\u4e00\u6b21\u63a2\u6d4b Pod Condition \u7684\u65f6\u95f4\u6233\u3002</li> <li>lastTransitionTime\uff1a\u4e0a\u6b21 Condition \u4ece\u4e00\u79cd\u72b6\u6001\u8f6c\u6362\u5230\u53e6\u4e00\u79cd\u72b6\u6001\u7684\u65f6\u95f4\u3002</li> <li>message\uff1a\u4e0a\u6b21 Condition \u72b6\u6001\u8f6c\u6362\u7684\u8be6\u7ec6\u63cf\u8ff0\u3002</li> <li>reason\uff1aCondition \u6700\u540e\u4e00\u6b21\u8f6c\u6362\u7684\u539f\u56e0\u3002</li> <li>status\uff1aCondition \u72b6\u6001\u7c7b\u578b\uff0c\u53ef\u4ee5\u4e3a \u201cTrue\u201d, \u201cFalse\u201d, and \u201cUnknown\u201d.</li> <li>type\uff1aCondition \u7c7b\u578b\uff0c\u5305\u62ec\u4ee5\u4e0b\u65b9\u9762\uff1a<ul> <li>PodScheduled\uff08Pod \u5df2\u7ecf\u88ab\u8c03\u5ea6\u5230\u5176\u4ed6 node \u91cc\uff09</li> <li>Ready\uff08Pod \u80fd\u591f\u63d0\u4f9b\u670d\u52a1\u8bf7\u6c42\uff0c\u53ef\u4ee5\u88ab\u6dfb\u52a0\u5230\u6240\u6709\u53ef\u5339\u914d\u670d\u52a1\u7684\u8d1f\u8f7d\u5e73\u8861\u6c60\u4e2d\uff09</li> <li>Initialized\uff08\u6240\u6709\u7684<code>init containers</code>\u5df2\u7ecf\u542f\u52a8\u6210\u529f\uff09</li> <li>Unschedulable\uff08\u8c03\u5ea6\u7a0b\u5e8f\u73b0\u5728\u65e0\u6cd5\u8c03\u5ea6 Pod\uff0c\u4f8b\u5982\u7531\u4e8e\u7f3a\u4e4f\u8d44\u6e90\u6216\u5176\u4ed6\u9650\u5236\uff09</li> <li>ContainersReady\uff08Pod \u91cc\u7684\u6240\u6709\u5bb9\u5668\u90fd\u662f ready \u72b6\u6001\uff09</li> </ul> </li> </ul>"},{"location":"kubernetes_basic/pod_life/#_1","title":"\u91cd\u542f\u7b56\u7565","text":"<p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e<code>restartPolicy</code>\u5b57\u6bb5\u6765\u8bbe\u7f6e Pod \u4e2d\u6240\u6709\u5bb9\u5668\u7684\u91cd\u542f\u7b56\u7565\uff0c\u5176\u53ef\u80fd\u503c\u4e3a</p> <pre><code>Always\uff0cOnFailure \u548c Never\n</code></pre> <p>\uff0c\u9ed8\u8ba4\u503c\u4e3a <code>Always</code>\u3002restartPolicy \u4ec5\u6307\u901a\u8fc7 kubelet \u5728\u540c\u4e00\u8282\u70b9\u4e0a\u91cd\u65b0\u542f\u52a8\u5bb9\u5668\u3002\u901a\u8fc7 kubelet \u91cd\u65b0\u542f\u52a8\u7684\u9000\u51fa\u5bb9\u5668\u5c06\u4ee5\u6307\u6570\u589e\u52a0\u5ef6\u8fdf\uff0810s\uff0c20s\uff0c40s\u2026\uff09\u91cd\u65b0\u542f\u52a8\uff0c\u4e0a\u9650\u4e3a 5 \u5206\u949f\uff0c\u5e76\u5728\u6210\u529f\u6267\u884c 10 \u5206\u949f\u540e\u91cd\u7f6e\u3002\u4e0d\u540c\u7c7b\u578b\u7684\u7684\u63a7\u5236\u5668\u53ef\u4ee5\u63a7\u5236 Pod \u7684\u91cd\u542f\u7b56\u7565\uff1a</p> <ul> <li>Job\uff1a\u9002\u7528\u4e8e\u4e00\u6b21\u6027\u4efb\u52a1\u5982\u6279\u91cf\u8ba1\u7b97\uff0c\u4efb\u52a1\u7ed3\u675f\u540e Pod \u4f1a\u88ab\u6b64\u7c7b\u63a7\u5236\u5668\u6e05\u9664\u3002Job \u7684\u91cd\u542f\u7b56\u7565\u53ea\u80fd\u662f<code>\"OnFailure\"</code>\u6216\u8005<code>\"Never\"</code>\u3002</li> <li>Replication Controller, ReplicaSet, or Deployment\uff0c\u6b64\u7c7b\u63a7\u5236\u5668\u5e0c\u671b Pod \u4e00\u76f4\u8fd0\u884c\u4e0b\u53bb\uff0c\u5b83\u4eec\u7684\u91cd\u542f\u7b56\u7565\u53ea\u80fd\u662f<code>\"Always\"</code>\u3002</li> <li>DaemonSet\uff1a\u6bcf\u4e2a\u8282\u70b9\u4e0a\u542f\u52a8\u4e00\u4e2a Pod\uff0c\u5f88\u660e\u663e\u6b64\u7c7b\u63a7\u5236\u5668\u7684\u91cd\u542f\u7b56\u7565\u4e5f\u5e94\u8be5\u662f<code>\"Always\"</code>\u3002</li> </ul>"},{"location":"kubernetes_basic/pod_life/#_2","title":"\u521d\u59cb\u5316\u5bb9\u5668","text":"<p>\u4e86\u89e3\u4e86 Pod \u72b6\u6001\u540e\uff0c\u9996\u5148\u6765\u4e86\u89e3\u4e0b Pod \u4e2d\u6700\u65b0\u542f\u52a8\u7684 <code>Init Container</code>\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u5e73\u65f6\u5e38\u8bf4\u7684<code>\u521d\u59cb\u5316\u5bb9\u5668</code>\u3002<code>Init Container</code>\u5c31\u662f\u7528\u6765\u505a\u521d\u59cb\u5316\u5de5\u4f5c\u7684\u5bb9\u5668\uff0c\u53ef\u4ee5\u662f\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\uff0c\u5982\u679c\u6709\u591a\u4e2a\u7684\u8bdd\uff0c\u8fd9\u4e9b\u5bb9\u5668\u4f1a\u6309\u5b9a\u4e49\u7684\u987a\u5e8f\u4f9d\u6b21\u6267\u884c\u3002\u6211\u4eec\u77e5\u9053\u4e00\u4e2a Pod \u91cc\u9762\u7684\u6240\u6709\u5bb9\u5668\u662f\u5171\u4eab\u6570\u636e\u5377\u548cNetwork Namespace \u7684\uff0c\u6240\u4ee5<code>Init Container</code>\u91cc\u9762\u4ea7\u751f\u7684\u6570\u636e\u53ef\u4ee5\u88ab\u4e3b\u5bb9\u5668\u4f7f\u7528\u5230\u3002\u4ece\u4e0a\u9762\u7684 Pod \u751f\u547d\u5468\u671f\u7684\u56fe\u4e2d\u53ef\u4ee5\u770b\u51fa\u521d\u59cb\u5316\u5bb9\u5668\u662f\u72ec\u7acb\u4e0e\u4e3b\u5bb9\u5668\u4e4b\u5916\u7684\uff0c\u53ea\u6709\u6240\u6709\u7684`\u521d\u59cb\u5316\u5bb9\u5668\u6267\u884c\u5b8c\u4e4b\u540e\uff0c\u4e3b\u5bb9\u5668\u624d\u4f1a\u88ab\u542f\u52a8\u3002\u90a3\u4e48\u521d\u59cb\u5316\u5bb9\u5668\u6709\u54ea\u4e9b\u5e94\u7528\u573a\u666f\u5462\uff1a</p> <ul> <li>\u7b49\u5f85\u5176\u4ed6\u6a21\u5757 Ready\uff1a\u8fd9\u4e2a\u53ef\u4ee5\u7528\u6765\u89e3\u51b3\u670d\u52a1\u4e4b\u95f4\u7684\u4f9d\u8d56\u95ee\u9898\uff0c\u6bd4\u5982\u6211\u4eec\u6709\u4e00\u4e2a Web \u670d\u52a1\uff0c\u8be5\u670d\u52a1\u53c8\u4f9d\u8d56\u4e8e\u53e6\u5916\u4e00\u4e2a\u6570\u636e\u5e93\u670d\u52a1\uff0c\u4f46\u662f\u5728\u6211\u4eec\u542f\u52a8\u8fd9\u4e2a Web \u670d\u52a1\u7684\u65f6\u5019\u6211\u4eec\u5e76\u4e0d\u80fd\u4fdd\u8bc1\u4f9d\u8d56\u7684\u8fd9\u4e2a\u6570\u636e\u5e93\u670d\u52a1\u5c31\u5df2\u7ecf\u542f\u52a8\u8d77\u6765\u4e86\uff0c\u6240\u4ee5\u53ef\u80fd\u4f1a\u51fa\u73b0\u4e00\u6bb5\u65f6\u95f4\u5185 Web \u670d\u52a1\u8fde\u63a5\u6570\u636e\u5e93\u5f02\u5e38\u3002\u8981\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u7684\u8bdd\u6211\u4eec\u5c31\u53ef\u4ee5\u5728 Web \u670d\u52a1\u7684 Pod \u4e2d\u4f7f\u7528\u4e00\u4e2a <code>InitContainer</code>\uff0c\u5728\u8fd9\u4e2a\u521d\u59cb\u5316\u5bb9\u5668\u4e2d\u53bb\u68c0\u67e5\u6570\u636e\u5e93\u662f\u5426\u5df2\u7ecf\u51c6\u5907\u597d\u4e86\uff0c\u51c6\u5907\u597d\u4e86\u8fc7\u540e\u521d\u59cb\u5316\u5bb9\u5668\u5c31\u7ed3\u675f\u9000\u51fa\uff0c\u7136\u540e\u6211\u4eec\u4e3b\u5bb9\u5668\u7684 Web \u670d\u52a1\u624d\u88ab\u542f\u52a8\u8d77\u6765\uff0c\u8fd9\u4e2a\u65f6\u5019\u53bb\u8fde\u63a5\u6570\u636e\u5e93\u5c31\u4e0d\u4f1a\u6709\u95ee\u9898\u4e86\u3002</li> <li>\u505a\u521d\u59cb\u5316\u914d\u7f6e\uff1a\u6bd4\u5982\u96c6\u7fa4\u91cc\u68c0\u6d4b\u6240\u6709\u5df2\u7ecf\u5b58\u5728\u7684\u6210\u5458\u8282\u70b9\uff0c\u4e3a\u4e3b\u5bb9\u5668\u51c6\u5907\u597d\u96c6\u7fa4\u7684\u914d\u7f6e\u4fe1\u606f\uff0c\u8fd9\u6837\u4e3b\u5bb9\u5668\u8d77\u6765\u540e\u5c31\u80fd\u7528\u8fd9\u4e2a\u914d\u7f6e\u4fe1\u606f\u52a0\u5165\u96c6\u7fa4\u3002</li> <li>\u5176\u5b83\u573a\u666f\uff1a\u5982\u5c06 Pod \u6ce8\u518c\u5230\u4e00\u4e2a\u4e2d\u592e\u6570\u636e\u5e93\u3001\u914d\u7f6e\u4e2d\u5fc3\u7b49\u3002</li> </ul> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u6765\u5b9e\u73b0\u4e00\u4e2a\u529f\u80fd\uff0c\u5728 Nginx Pod \u542f\u52a8\u4e4b\u524d\u53bb\u91cd\u65b0\u521d\u59cb\u5316\u9996\u9875\u5185\u5bb9\uff0c\u5982\u4e0b\u6240\u793a\u7684\u8d44\u6e90\u6e05\u5355\uff1a\uff08init-pod.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: init-demo\nspec:\n  volumes:\n  - name: workdir\n    emptyDir: {}\n  initContainers:\n  - name: install\n    image: busybox\n    command:\n    - wget\n    - \"-O\"\n    - \"/work-dir/index.html\"\n    - http://www.baidu.com\n    volumeMounts:\n    - name: workdir\n      mountPath: \"/work-dir\"\n  containers:\n  - name: nginx\n    image: nginx\n    ports:\n    - containerPort: 80\n    volumeMounts:\n    - name: workdir\n      mountPath: /usr/share/nginx/html\n</code></pre> <p>\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u4e2d\u6211\u4eec\u9996\u5148\u5728 Pod \u9876\u5c42\u58f0\u660e\u4e86\u4e00\u4e2a\u540d\u4e3a workdir \u7684 <code>Volume</code>\uff0c\u524d\u9762\u6211\u4eec\u7528\u4e86 hostPath \u7684\u6a21\u5f0f\uff0c\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u7684\u662f <code>emptyDir{}</code>\uff0c\u8fd9\u4e2a\u662f\u4e00\u4e2a\u4e34\u65f6\u7684\u76ee\u5f55\uff0c\u6570\u636e\u4f1a\u4fdd\u5b58\u5728 kubelet \u7684\u5de5\u4f5c\u76ee\u5f55\u4e0b\u9762\uff0c\u751f\u547d\u5468\u671f\u7b49\u540c\u4e8e Pod \u7684\u751f\u547d\u5468\u671f\u3002</p> <p>\u7136\u540e\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a\u521d\u59cb\u5316\u5bb9\u5668\uff0c\u8be5\u5bb9\u5668\u4f1a\u4e0b\u8f7d\u4e00\u4e2a html \u6587\u4ef6\u5230 <code>/work-dir</code> \u76ee\u5f55\u4e0b\u9762\uff0c\u4f46\u662f\u7531\u4e8e\u6211\u4eec\u53c8\u5c06\u8be5\u76ee\u5f55\u58f0\u660e\u6302\u8f7d\u5230\u4e86\u5168\u5c40\u7684 Volume\uff0c\u540c\u6837\u7684\u4e3b\u5bb9\u5668 nginx \u4e5f\u5c06\u76ee\u5f55 </p> <pre><code>/usr/share/nginx/html\n</code></pre> <p>\u58f0\u660e\u6302\u8f7d\u5230\u4e86\u5168\u5c40\u7684 Volume\uff0c\u6240\u4ee5\u5728\u4e3b\u5bb9\u5668\u7684\u8be5\u76ee\u5f55\u4e0b\u9762\u4f1a\u540c\u6b65\u521d\u59cb\u5316\u5bb9\u5668\u4e2d\u521b\u5efa\u7684 <code>index.html</code> \u6587\u4ef6\u3002</p> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 Pod\uff1a</p> <pre><code>$ kubectl apply -f init-pod.yaml\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u53ef\u4ee5\u67e5\u770b\u8be5 Pod \u7684\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pods\nNAME                            READY   STATUS     RESTARTS   AGE\ninit-demo                       0/1     Init:0/1   0          4s\n</code></pre> <p>\u53ef\u4ee5\u53d1\u73b0 Pod \u73b0\u5728\u7684\u72b6\u6001\u5904\u4e8e <code>Init:0/1</code> \u72b6\u6001\uff0c\u610f\u601d\u5c31\u662f\u73b0\u5728\u7b2c\u4e00\u4e2a\u521d\u59cb\u5316\u5bb9\u5668\u8fd8\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u6b64\u65f6\u6211\u4eec\u53ef\u4ee5\u67e5\u770b Pod \u7684\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe pod init-demo\nName:         init-demo\nNamespace:    default\nPriority:     0\nNode:         ydzs-node3/157\nStart Time:   Mon, 11 Nov 2019 20:10:54 +0800\nLabels:       &lt;none&gt;\nAnnotations:  kubectl.kubernetes.io/last-applied-configuration:\n                {\"apiVersion\":\"v1\",\"kind\":\"Pod\",\"metadata\":{\"annotations\":{},\"name\":\"init-demo\",\"namespace\":\"default\"},\"spec\":{\"containers\":[{\"image\":\"ngi...\nStatus:       Pending\nIP:           254\nIPs:\n  IP:  254\nInit Containers:\n  install:\n    Container ID:  docker://762f64641abb913804bc8a3b71b553744afeb1169547ef35d9f6ef0e09a458e0\n    Image:         busybox\n    Image ID:      docker-pullable://busybox@sha256:1303dbf110c57f3edf68d9f5a16c082ec06c4cf7604831669faf2c712260b5a0\n    Port:          &lt;none&gt;\n    Host Port:     &lt;none&gt;\n    Command:\n      wget\n      -O\n      /work-dir/index.html\n      http://www.baidu.com\n    State:          Running\n      Started:      Mon, 11 Nov 2019 20:10:59 +0800\n    Ready:          False\n    Restart Count:  0\n    Environment:    &lt;none&gt;\n    Mounts:\n      /var/run/secrets/kubernetes.io/serviceaccount from default-token-5tsh4 (ro)\n      /work-dir from workdir (rw)\nContainers:\n  nginx:\n    Container ID:\n    Image:          nginx\n    Image ID:\n    Port:           80/TCP\n    Host Port:      0/TCP\n    State:          Waiting\n      Reason:       PodInitializing\n    Ready:          False\n    Restart Count:  0\n    Environment:    &lt;none&gt;\n    Mounts:\n      /usr/share/nginx/html from workdir (rw)\n      /var/run/secrets/kubernetes.io/serviceaccount from default-token-5tsh4 (ro)\nConditions:\n  Type              Status\n  Initialized       False\n  Ready             False\n  ContainersReady   False\n  PodScheduled      True\nVolumes:\n  workdir:\n    Type:       EmptyDir (a temporary directory that shares a pod's lifetime)\n    Medium:\n    SizeLimit:  &lt;unset&gt;\n  default-token-5tsh4:\n    Type:        Secret (a volume populated by a Secret)\n    SecretName:  default-token-5tsh4\n    Optional:    false\nQoS Class:       BestEffort\nNode-Selectors:  &lt;none&gt;\nTolerations:     node.kubernetes.io/not-ready:NoExecute for 300s\n                 node.kubernetes.io/unreachable:NoExecute for 300s\nEvents:\n  Type    Reason     Age        From                 Message\n  ----    ------     ----       ----                 -------\n  Normal  Scheduled  &lt;unknown&gt;  default-scheduler    Successfully assigned default/init-demo to ydzs-node3\n  Normal  Pulling    20s        kubelet, ydzs-node3  Pulling image \"busybox\"\n  Normal  Pulled     17s        kubelet, ydzs-node3  Successfully pulled image \"busybox\"\n  Normal  Created    17s        kubelet, ydzs-node3  Created container install\n  Normal  Started    16s        kubelet, ydzs-node3  Started container install\n</code></pre> <p>\u4ece\u4e0a\u9762\u7684\u63cf\u8ff0\u4fe1\u606f\u91cc\u9762\u53ef\u4ee5\u770b\u5230\u521d\u59cb\u5316\u5bb9\u5668\u5df2\u7ecf\u542f\u52a8\u4e86\uff0c\u73b0\u5728\u5904\u4e8e <code>Running</code> \u72b6\u6001\uff0c\u6240\u4ee5\u8fd8\u9700\u8981\u7a0d\u7b49\uff0c\u5230\u521d\u59cb\u5316\u5bb9\u5668\u6267\u884c\u5b8c\u6210\u540e\u9000\u51fa\u521d\u59cb\u5316\u5bb9\u5668\u4f1a\u53d8\u6210 <code>Completed</code> \u72b6\u6001\uff0c\u7136\u540e\u624d\u4f1a\u542f\u52a8\u4e3b\u5bb9\u5668\u3002\u5f85\u5230\u4e3b\u5bb9\u5668\u4e5f\u542f\u52a8\u5b8c\u6210\u540e\uff0cPod \u5c31\u4f1a\u53d8\u6210<code>Running</code> \u72b6\u6001\uff0c\u7136\u540e\u6211\u4eec\u53bb\u8bbf\u95ee\u4e0b Pod \u4e3b\u9875\uff0c\u9a8c\u8bc1\u4e0b\u662f\u5426\u6709\u6211\u4eec\u521d\u59cb\u5316\u5bb9\u5668\u4e2d\u4e0b\u8f7d\u7684\u9875\u9762\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get pods -o wide\nNAME                            READY   STATUS    RESTARTS   AGE     IP             NODE         NOMINATED NODE   READINESS GATES\ninit-demo                       1/1     Running   0          3m39s   254    ydzs-node3   &lt;none&gt;           &lt;none&gt;\n$ curl 254\n&lt;!DOCTYPE html&gt;\n&lt;!--STATUS OK--&gt;&lt;html&gt; &lt;head&gt;&lt;meta http-equiv=content-type content=text/html;charset=utf-8&gt;&lt;meta http-equiv=X-UA-Compatible content=IE=Edge&gt;&lt;meta content=always name=referrer&gt;&lt;link rel=stylesheet type=text/css href=http://sbdstatic.com/r/www/cache/bdorz/baidu.min.css&gt;&lt;title&gt;\u767e\u5ea6\u4e00\u4e0b\uff0c\u4f60\u5c31\u77e5\u9053&lt;/title&gt;&lt;/head&gt; &lt;body link=#0000cc&gt; &lt;div id=wrapper&gt; &lt;div id=head&gt; &lt;div class=head_wrapper&gt; &lt;div class=s_form&gt; &lt;div class=s_form_wrapper&gt; &lt;div id=lg&gt; &lt;img hidefocus=true src=//www.baidu.com/img/bd_logopng width=270 height=129&gt; &lt;/div&gt; &lt;form id=form name=f action=//www.baidu.com/s class=fm&gt; &lt;input type=hidden name=bdorz_come value=1&gt; &lt;input type=hidden name=ie value=utf-8&gt; &lt;input type=hidden name=f value=8&gt; &lt;input type=hidden name=rsv_bp value=1&gt; &lt;input type=hidden name=rsv_idx value=1&gt; &lt;input type=hidden name=tn value=baidu&gt;&lt;span class=\"bg s_ipt_wr\"&gt;&lt;input id=kw name=wd class=s_ipt value maxlength=255 autocomplete=off autofocus&gt;&lt;/span&gt;&lt;span class=\"bg s_btn_wr\"&gt;&lt;input type=submit id=su value=\u767e\u5ea6\u4e00\u4e0b class=\"bg s_btn\"&gt;&lt;/span&gt; &lt;/form&gt; &lt;/div&gt; &lt;/div&gt; &lt;div id=u1&gt; &lt;a href=http://news.baidu.com name=tj_trnews class=mnav&gt;\u65b0\u95fb&lt;/a&gt; &lt;a href=http://www.hao1com name=tj_trhao123 class=mnav&gt;hao123&lt;/a&gt; &lt;a href=http://map.baidu.com name=tj_trmap class=mnav&gt;\u5730\u56fe&lt;/a&gt; &lt;a href=http://v.baidu.com name=tj_trvideo class=mnav&gt;\u89c6\u9891&lt;/a&gt; &lt;a href=http://tieba.baidu.com name=tj_trtieba class=mnav&gt;\u8d34\u5427&lt;/a&gt; &lt;noscript&gt; &lt;a href=http://www.baidu.com/bdorz/login.gif?login&amp;amp;tpl=mn&amp;amp;u=http%3A%2F%2Fwww.baidu.com%2f%3fbdorz_come%3d1 name=tj_login class=lb&gt;\u767b\u5f55&lt;/a&gt; &lt;/noscript&gt; &lt;script&gt;document.write('&lt;a href=\"http://www.baidu.com/bdorz/login.gif?login&amp;tpl=mn&amp;u='+ encodeURIComponent(window.location.href+ (window.location.search === \"\" ? \"?\" : \"&amp;\")+ \"bdorz_come=1\")+ '\" name=\"tj_login\" class=\"lb\"&gt;\u767b\u5f55&lt;/a&gt;');&lt;/script&gt; &lt;a href=//www.baidu.com/more/ name=tj_briicon class=bri style=\"display: block;\"&gt;\u66f4\u591a\u4ea7\u54c1&lt;/a&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;div id=ftCon&gt; &lt;div id=ftConw&gt; &lt;p id=lh&gt; &lt;a href=http://home.baidu.com&gt;\u5173\u4e8e\u767e\u5ea6&lt;/a&gt; &lt;a href=http://ir.baidu.com&gt;About Baidu&lt;/a&gt; &lt;/p&gt; &lt;p id=cp&gt;&amp;copy;2017&amp;nbsp;Baidu&amp;nbsp;&lt;a href=http://www.baidu.com/duty/&gt;\u4f7f\u7528\u767e\u5ea6\u524d\u5fc5\u8bfb&lt;/a&gt;&amp;nbsp; &lt;a href=http://jianyi.baidu.com/ class=cp-feedback&gt;\u610f\u89c1\u53cd\u9988&lt;/a&gt;&amp;nbsp;\u4eacICP\u8bc1030173\u53f7&amp;nbsp; &lt;img src=//www.baidu.com/img/gs.gif&gt; &lt;/p&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;/body&gt; &lt;/html&gt;\n</code></pre>"},{"location":"kubernetes_basic/pod_life/#pod_hook","title":"Pod Hook","text":"<p>\u6211\u4eec\u77e5\u9053 Pod \u662f Kubernetes \u96c6\u7fa4\u4e2d\u7684\u6700\u5c0f\u5355\u5143\uff0c\u800c Pod \u662f\u7531\u5bb9\u5668\u7ec4\u6210\u7684\uff0c\u6240\u4ee5\u5728\u8ba8\u8bba Pod \u7684\u751f\u547d\u5468\u671f\u7684\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u5148\u6765\u8ba8\u8bba\u4e0b\u5bb9\u5668\u7684\u751f\u547d\u5468\u671f\u3002\u5b9e\u9645\u4e0a Kubernetes \u4e3a\u6211\u4eec\u7684\u5bb9\u5668\u63d0\u4f9b\u4e86\u751f\u547d\u5468\u671f\u7684\u94a9\u5b50\uff0c\u5c31\u662f\u6211\u4eec\u8bf4\u7684<code>Pod Hook</code>\uff0cPod Hook \u662f\u7531 kubelet \u53d1\u8d77\u7684\uff0c\u5f53\u5bb9\u5668\u4e2d\u7684\u8fdb\u7a0b\u542f\u52a8\u524d\u6216\u8005\u5bb9\u5668\u4e2d\u7684\u8fdb\u7a0b\u7ec8\u6b62\u4e4b\u524d\u8fd0\u884c\uff0c\u8fd9\u662f\u5305\u542b\u5728\u5bb9\u5668\u7684\u751f\u547d\u5468\u671f\u4e4b\u4e2d\u3002\u6211\u4eec\u53ef\u4ee5\u540c\u65f6\u4e3a Pod \u4e2d\u7684\u6240\u6709\u5bb9\u5668\u90fd\u914d\u7f6e hook\u3002</p> <p>Kubernetes \u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u4e24\u79cd\u94a9\u5b50\u51fd\u6570\uff1a</p> <ul> <li><code>PostStart</code>\uff1a\u8fd9\u4e2a\u94a9\u5b50\u5728\u5bb9\u5668\u521b\u5efa\u540e\u7acb\u5373\u6267\u884c\u3002\u4f46\u662f\uff0c\u5e76\u4e0d\u80fd\u4fdd\u8bc1\u94a9\u5b50\u5c06\u5728\u5bb9\u5668 ENTRYPOINT \u4e4b\u524d\u8fd0\u884c\uff0c\u56e0\u4e3a\u6ca1\u6709\u53c2\u6570\u4f20\u9012\u7ed9\u5904\u7406\u7a0b\u5e8f\u3002\u4e3b\u8981\u7528\u4e8e\u8d44\u6e90\u90e8\u7f72\u3001\u73af\u5883\u51c6\u5907\u7b49\u3002\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u5982\u679c\u94a9\u5b50\u82b1\u8d39\u592a\u957f\u65f6\u95f4\u4ee5\u81f3\u4e8e\u4e0d\u80fd\u8fd0\u884c\u6216\u8005\u6302\u8d77\uff0c\u5bb9\u5668\u5c06\u4e0d\u80fd\u8fbe\u5230 running \u72b6\u6001\u3002</li> <li><code>PreStop</code>\uff1a\u8fd9\u4e2a\u94a9\u5b50\u5728\u5bb9\u5668\u7ec8\u6b62\u4e4b\u524d\u7acb\u5373\u88ab\u8c03\u7528\u3002\u5b83\u662f\u963b\u585e\u7684\uff0c\u610f\u5473\u7740\u5b83\u662f\u540c\u6b65\u7684\uff0c\u6240\u4ee5\u5b83\u5fc5\u987b\u5728\u5220\u9664\u5bb9\u5668\u7684\u8c03\u7528\u53d1\u51fa\u4e4b\u524d\u5b8c\u6210\u3002\u4e3b\u8981\u7528\u4e8e\u4f18\u96c5\u5173\u95ed\u5e94\u7528\u7a0b\u5e8f\u3001\u901a\u77e5\u5176\u4ed6\u7cfb\u7edf\u7b49\u3002\u5982\u679c\u94a9\u5b50\u5728\u6267\u884c\u671f\u95f4\u6302\u8d77\uff0cPod \u9636\u6bb5\u5c06\u505c\u7559\u5728 running \u72b6\u6001\u5e76\u4e14\u6c38\u4e0d\u4f1a\u8fbe\u5230 failed \u72b6\u6001\u3002</li> </ul> <p>\u5982\u679c PostStart \u6216\u8005 PreStop \u94a9\u5b50\u5931\u8d25\uff0c \u5b83\u4f1a\u6740\u6b7b\u5bb9\u5668\u3002\u6240\u4ee5\u6211\u4eec\u5e94\u8be5\u8ba9\u94a9\u5b50\u51fd\u6570\u5c3d\u53ef\u80fd\u7684\u8f7b\u91cf\u3002\u5f53\u7136\u6709\u4e9b\u60c5\u51b5\u4e0b\uff0c\u957f\u65f6\u95f4\u8fd0\u884c\u547d\u4ee4\u662f\u5408\u7406\u7684\uff0c \u6bd4\u5982\u5728\u505c\u6b62\u5bb9\u5668\u4e4b\u524d\u9884\u5148\u4fdd\u5b58\u72b6\u6001\u3002</p> <p>\u53e6\u5916\u6211\u4eec\u6709\u4e24\u79cd\u65b9\u5f0f\u6765\u5b9e\u73b0\u4e0a\u9762\u7684\u94a9\u5b50\u51fd\u6570\uff1a</p> <ul> <li><code>Exec</code> - \u7528\u4e8e\u6267\u884c\u4e00\u6bb5\u7279\u5b9a\u7684\u547d\u4ee4\uff0c\u4e0d\u8fc7\u8981\u6ce8\u610f\u7684\u662f\u8be5\u547d\u4ee4\u6d88\u8017\u7684\u8d44\u6e90\u4f1a\u88ab\u8ba1\u5165\u5bb9\u5668\u3002</li> <li><code>HTTP</code> - \u5bf9\u5bb9\u5668\u4e0a\u7684\u7279\u5b9a\u7684\u7aef\u70b9\u6267\u884c HTTP \u8bf7\u6c42\u3002</li> </ul> <p>\u4ee5\u4e0b\u793a\u4f8b\u4e2d\uff0c\u5b9a\u4e49\u4e86\u4e00\u4e2a Nginx Pod\uff0c\u5176\u4e2d\u8bbe\u7f6e\u4e86 PostStart \u94a9\u5b50\u51fd\u6570\uff0c\u5373\u5728\u5bb9\u5668\u521b\u5efa\u6210\u529f\u540e\uff0c\u5199\u5165\u4e00\u53e5\u8bdd\u5230 /usr/share/message \u6587\u4ef6\u4e2d\uff1a\uff08pod-poststart.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: hook-demo1\nspec:\n  containers:\n  - name: hook-demo1\n    image: nginx\n    lifecycle:\n      postStart:\n        exec:\n          command: [\"/bin/sh\", \"-c\", \"echo Hello from the postStart handler &gt; /usr/share/message\"]\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 Pod\uff1a</p> <pre><code>$ kubectl apply -f pod-poststart.yaml\n$ kubectl get pods\nNAME                            READY   STATUS    RESTARTS   AGE\nhook-demo1                      1/1     Running   0          43s\n</code></pre> <p>\u521b\u5efa\u6210\u529f\u540e\u53ef\u4ee5\u67e5\u770b\u5bb9\u5668\u4e2d <code>/usr/share/message</code> \u6587\u4ef6\u662f\u5426\u5185\u5bb9\u6b63\u786e\uff1a</p> <pre><code>$ kubectl exec -it hook-demo1 cat /usr/share/message\nHello from the postStart handler\n</code></pre> <p>\u5f53\u7528\u6237\u8bf7\u6c42\u5220\u9664\u542b\u6709 Pod \u7684\u8d44\u6e90\u5bf9\u8c61\u65f6\uff08\u5982 Deployment \u7b49\uff09\uff0cK8S \u4e3a\u4e86\u8ba9\u5e94\u7528\u7a0b\u5e8f\u4f18\u96c5\u5173\u95ed\uff08\u5373\u8ba9\u5e94\u7528\u7a0b\u5e8f\u5b8c\u6210\u6b63\u5728\u5904\u7406\u7684\u8bf7\u6c42\u540e\uff0c\u518d\u5173\u95ed\u8f6f\u4ef6\uff09\uff0cK8S \u63d0\u4f9b\u4e24\u79cd\u4fe1\u606f\u901a\u77e5\uff1a</p> <ul> <li>\u9ed8\u8ba4\uff1aK8S \u901a\u77e5 node \u6267\u884c<code>docker stop</code>\u547d\u4ee4\uff0cdocker \u4f1a\u5148\u5411\u5bb9\u5668\u4e2d PID \u4e3a 1 \u7684\u8fdb\u7a0b\u53d1\u9001\u7cfb\u7edf\u4fe1\u53f7<code>SIGTERM</code>\uff0c\u7136\u540e\u7b49\u5f85\u5bb9\u5668\u4e2d\u7684\u5e94\u7528\u7a0b\u5e8f\u7ec8\u6b62\u6267\u884c\uff0c\u5982\u679c\u7b49\u5f85\u65f6\u95f4\u8fbe\u5230\u8bbe\u5b9a\u7684\u8d85\u65f6\u65f6\u95f4\uff0c\u6216\u8005\u9ed8\u8ba4\u8d85\u65f6\u65f6\u95f4\uff0830s\uff09\uff0c\u4f1a\u7ee7\u7eed\u53d1\u9001<code>SIGKILL</code>\u7684\u7cfb\u7edf\u4fe1\u53f7\u5f3a\u884c kill \u6389\u8fdb\u7a0b</li> <li>\u4f7f\u7528 Pod \u751f\u547d\u5468\u671f\uff08\u5229\u7528<code>PreStop</code>\u56de\u8c03\u51fd\u6570\uff09\uff0c\u5b83\u5728\u53d1\u9001\u7ec8\u6b62\u4fe1\u53f7\u4e4b\u524d\u6267\u884c</li> </ul> <p>\u9ed8\u8ba4\u6240\u6709\u7684\u4f18\u96c5\u9000\u51fa\u65f6\u95f4\u90fd\u572830\u79d2\u5185\u3002kubectl delete \u547d\u4ee4\u652f\u6301 </p> <pre><code>--grace-period=&lt;seconds&gt;\n</code></pre> <p>\u9009\u9879\uff0c\u8fd9\u4e2a\u9009\u9879\u5141\u8bb8\u7528\u6237\u7528\u4ed6\u4eec\u81ea\u5df1\u6307\u5b9a\u7684\u503c\u8986\u76d6\u9ed8\u8ba4\u503c\u3002\u503c0\u4ee3\u8868\u5f3a\u5236\u5220\u9664 pod\u3002 \u5728 kubectl 1.5 \u53ca\u4ee5\u4e0a\u7684\u7248\u672c\u91cc\uff0c\u6267\u884c\u5f3a\u5236\u5220\u9664\u65f6\u5fc5\u987b\u540c\u65f6\u6307\u5b9a </p> <pre><code>--force --grace-period=0\n</code></pre> <p>\u3002</p> <p>\u5f3a\u5236\u5220\u9664\u4e00\u4e2a pod \u662f\u4ece\u96c6\u7fa4\u72b6\u6001\u8fd8\u6709 etcd \u91cc\u7acb\u523b\u5220\u9664\u8fd9\u4e2a pod\uff0c\u53ea\u662f\u5f53 Pod \u88ab\u5f3a\u5236\u5220\u9664\u65f6\uff0c APIServer \u4e0d\u4f1a\u7b49\u5f85\u6765\u81ea Pod \u6240\u5728\u8282\u70b9\u4e0a\u7684 kubelet \u7684\u786e\u8ba4\u4fe1\u606f\uff1apod \u5df2\u7ecf\u88ab\u7ec8\u6b62\u3002\u5728 API \u91cc pod \u4f1a\u88ab\u7acb\u523b\u5220\u9664\uff0c\u5728\u8282\u70b9\u4e0a\uff0c pods \u88ab\u8bbe\u7f6e\u6210\u7acb\u523b\u7ec8\u6b62\u540e\uff0c\u5728\u5f3a\u884c\u6740\u6389\u524d\u8fd8\u4f1a\u6709\u4e00\u4e2a\u5f88\u5c0f\u7684\u5bbd\u9650\u671f\u3002</p> <p>\u4ee5\u4e0b\u793a\u4f8b\u4e2d\uff0c\u5b9a\u4e49\u4e86\u4e00\u4e2a Nginx Pod\uff0c\u5176\u4e2d\u8bbe\u7f6e\u4e86<code>PreStop</code>\u94a9\u5b50\u51fd\u6570\uff0c\u5373\u5728\u5bb9\u5668\u9000\u51fa\u4e4b\u524d\uff0c\u4f18\u96c5\u7684\u5173\u95ed Nginx\uff1a\uff08pod-prestop.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: hook-demo2\nspec:\n  containers:\n  - name: hook-demo2\n    image: nginx\n    lifecycle:\n      preStop:\n        exec:\n          command: [\"/usr/sbin/nginx\",\"-s\",\"quit\"]  # \u4f18\u96c5\u9000\u51fa\n\n---\napiVersion: v1\nkind: Pod\nmetadata:\n  name: hook-demo3\nspec:\n  volumes:\n  - name: message\n    hostPath:\n      path: /tmp\n  containers:\n  - name: hook-demo2\n    image: nginx\n    ports:\n    - containerPort: 80\n    volumeMounts:\n    - name: message\n      mountPath: /usr/share/\n    lifecycle:\n      preStop:\n        exec:\n          command: ['/bin/sh', '-c', 'echo Hello from the preStop Handler &gt; /usr/share/message']\n</code></pre> <p>\u4e0a\u9762\u5b9a\u4e49\u7684\u4e24\u4e2a Pod\uff0c\u4e00\u4e2a\u662f\u5229\u7528 <code>preStop</code> \u6765\u8fdb\u884c\u4f18\u96c5\u5220\u9664\uff0c\u53e6\u5916\u4e00\u4e2a\u662f\u5229\u7528 <code>preStop</code> \u6765\u505a\u4e00\u4e9b\u4fe1\u606f\u8bb0\u5f55\u7684\u4e8b\u60c5\uff0c\u540c\u6837\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 Pod\uff1a</p> <pre><code>$ kubectl apply -f pod-prestop.yaml\n$ kubectl get pods\nNAME                            READY   STATUS    RESTARTS   AGE\nhook-demo2                      1/1     Running   0          67s\nhook-demo3                      1/1     Running   0          67s\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5220\u9664 hook-demo2 \u8fd9\u4e2a Pod\uff0c\u5728\u5bb9\u5668\u5220\u9664\u4e4b\u524d\u4f1a\u6267\u884c preStop \u91cc\u9762\u7684\u4f18\u96c5\u5173\u95ed\u547d\u4ee4\uff0c\u8fd9\u4e2a\u7528\u6cd5\u5728\u540e\u9762\u6211\u4eec\u7684\u6eda\u52a8\u66f4\u65b0\u7684\u65f6\u5019\u7528\u6765\u4fdd\u8bc1\u6211\u4eec\u7684\u5e94\u7528\u96f6\u5b95\u673a\u975e\u5e38\u6709\u7528\u3002\u7b2c\u4e8c\u4e2a Pod \u6211\u4eec\u58f0\u660e\u4e86\u4e00\u4e2a hostPath \u7c7b\u578b\u7684 Volume\uff0c\u5728\u5bb9\u5668\u91cc\u9762\u58f0\u660e\u6302\u8f7d\u5230\u4e86\u8fd9\u4e2a Volume\uff0c\u6240\u4ee5\u5f53\u6211\u4eec\u5220\u9664 Pod\uff0c\u9000\u51fa\u5bb9\u5668\u4e4b\u524d\uff0c\u5728\u5bb9\u5668\u91cc\u9762\u8f93\u51fa\u7684\u4fe1\u606f\u4e5f\u4f1a\u540c\u6837\u7684\u4fdd\u5b58\u5230\u5bbf\u4e3b\u673a\uff08\u4e00\u5b9a\u8981\u662f Pod \u88ab\u8c03\u5ea6\u5230\u7684\u76ee\u6807\u8282\u70b9\uff09\u7684 <code>/tmp</code> \u76ee\u5f55\u4e0b\u9762\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b hook-demo3 \u8fd9\u4e2a Pod \u88ab\u8c03\u5ea6\u7684\u8282\u70b9\uff1a</p> <pre><code>$ kubectl describe pod hook-demo3\nName:         hook-demo3\nNamespace:    default\nPriority:     0\nNode:         ydzs-node1/122\nStart Time:   Tue, 12 Nov 2019 14:33:54 +0800\n......\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a Pod \u88ab\u8c03\u5ea6\u5230\u4e86 <code>ydzs-node1</code> \u8fd9\u4e2a\u8282\u70b9\u4e0a\uff0c\u6211\u4eec\u53ef\u4ee5\u5148\u5230\u8be5\u8282\u70b9\u4e0a\u67e5\u770b <code>/tmp</code> \u76ee\u5f55\u4e0b\u9762\u76ee\u524d\u6ca1\u6709\u4efb\u4f55\u5185\u5bb9\uff1a</p> <p><code>$ ls /tmp/</code></p> <p>\u73b0\u5728\u6211\u4eec\u6765\u5220\u9664 hook-demo3 \u8fd9\u4e2a Pod\uff0c\u5b89\u88c5\u6211\u4eec\u7684\u8bbe\u5b9a\u5728\u5bb9\u5668\u9000\u51fa\u4e4b\u524d\u4f1a\u6267\u884c <code>preStop</code> \u91cc\u9762\u7684\u547d\u4ee4\uff0c\u4e5f\u5c31\u662f\u4f1a\u5f80 message \u6587\u4ef6\u4e2d\u8f93\u51fa\u4e00\u4e9b\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl delete pod hook-demo3\npod \"hook-demo3\" deleted\n$ ls /tmp/\nmessage\n$ cat /tmp/message\nHello from the preStop Handler\n</code></pre> <p>\u53e6\u5916 Hook \u8c03\u7528\u7684\u65e5\u5fd7\u6ca1\u6709\u66b4\u9732\u4e2a\u7ed9 Pod\uff0c\u6240\u4ee5\u53ea\u80fd\u901a\u8fc7 describe \u547d\u4ee4\u6765\u83b7\u53d6\uff0c\u5982\u679c\u6709\u9519\u8bef\u5c06\u53ef\u4ee5\u770b\u5230 <code>FailedPostStartHook</code> \u6216 <code>FailedPreStopHook</code> \u8fd9\u6837\u7684 event\u3002</p>"},{"location":"kubernetes_basic/pod_life/#pod_2","title":"Pod \u5065\u5eb7\u68c0\u67e5","text":"<p>\u73b0\u5728\u5728 Pod \u7684\u6574\u4e2a\u751f\u547d\u5468\u671f\u4e2d\uff0c\u80fd\u5f71\u54cd\u5230 Pod \u7684\u5c31\u53ea\u5269\u4e0b\u5065\u5eb7\u68c0\u67e5\u8fd9\u4e00\u90e8\u5206\u4e86\u3002\u5728 Kubernetes \u96c6\u7fa4\u5f53\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e<code>liveness probe\uff08\u5b58\u6d3b\u63a2\u9488</code>\uff09\u548c</p> <pre><code>readiness probe\uff08\u53ef\u8bfb\u6027\u63a2\u9488\uff09\n</code></pre> <p>\u6765\u5f71\u54cd\u5bb9\u5668\u7684\u751f\u547d\u5468\u671f\uff1a</p> <ul> <li>kubelet \u901a\u8fc7\u4f7f\u7528 <code>liveness probe</code> \u6765\u786e\u5b9a\u4f60\u7684\u5e94\u7528\u7a0b\u5e8f\u662f\u5426\u6b63\u5728\u8fd0\u884c\uff0c\u901a\u4fd7\u70b9\u5c06\u5c31\u662f<code>\u662f\u5426\u8fd8\u6d3b\u7740</code>\u3002\u4e00\u822c\u6765\u8bf4\uff0c\u5982\u679c\u4f60\u7684\u7a0b\u5e8f\u4e00\u65e6\u5d29\u6e83\u4e86\uff0c Kubernetes \u5c31\u4f1a\u7acb\u523b\u77e5\u9053\u8fd9\u4e2a\u7a0b\u5e8f\u5df2\u7ecf\u7ec8\u6b62\u4e86\uff0c\u7136\u540e\u5c31\u4f1a\u91cd\u542f\u8fd9\u4e2a\u7a0b\u5e8f\u3002\u800c\u6211\u4eec\u7684 liveness probe \u7684\u76ee\u7684\u5c31\u662f\u6765\u6355\u83b7\u5230\u5f53\u524d\u5e94\u7528\u7a0b\u5e8f\u8fd8\u6ca1\u6709\u7ec8\u6b62\uff0c\u8fd8\u6ca1\u6709\u5d29\u6e83\uff0c\u5982\u679c\u51fa\u73b0\u4e86\u8fd9\u4e9b\u60c5\u51b5\uff0c\u90a3\u4e48\u5c31\u91cd\u542f\u5904\u4e8e\u8be5\u72b6\u6001\u4e0b\u7684\u5bb9\u5668\uff0c\u4f7f\u5e94\u7528\u7a0b\u5e8f\u5728\u5b58\u5728 bug \u7684\u60c5\u51b5\u4e0b\u4f9d\u7136\u80fd\u591f\u7ee7\u7eed\u8fd0\u884c\u4e0b\u53bb\u3002</li> <li>kubelet \u4f7f\u7528 <code>readiness probe</code> \u6765\u786e\u5b9a\u5bb9\u5668\u662f\u5426\u5df2\u7ecf\u5c31\u7eea\u53ef\u4ee5\u63a5\u6536\u6d41\u91cf\u8fc7\u6765\u4e86\u3002\u8fd9\u4e2a\u63a2\u9488\u901a\u4fd7\u70b9\u8bb2\u5c31\u662f\u8bf4<code>\u662f\u5426\u51c6\u5907\u597d\u4e86</code>\uff0c\u73b0\u5728\u53ef\u4ee5\u5f00\u59cb\u5de5\u4f5c\u4e86\u3002\u53ea\u6709\u5f53 Pod \u4e2d\u7684\u5bb9\u5668\u90fd\u5904\u4e8e\u5c31\u7eea\u72b6\u6001\u7684\u65f6\u5019 kubelet \u624d\u4f1a\u8ba4\u5b9a\u8be5 Pod \u5904\u4e8e\u5c31\u7eea\u72b6\u6001\uff0c\u56e0\u4e3a\u4e00\u4e2a Pod \u4e0b\u9762\u53ef\u80fd\u4f1a\u6709\u591a\u4e2a\u5bb9\u5668\u3002\u5f53\u7136 Pod \u5982\u679c\u5904\u4e8e\u975e\u5c31\u7eea\u72b6\u6001\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u4f1a\u5c06\u4ed6\u4ece Service \u7684 Endpoints \u5217\u8868\u4e2d\u79fb\u9664\u51fa\u6765\uff0c\u8fd9\u6837\u6211\u4eec\u7684\u6d41\u91cf\u5c31\u4e0d\u4f1a\u88ab\u8def\u7531\u5230\u8fd9\u4e2a Pod \u91cc\u9762\u6765\u4e86\u3002</li> </ul> <p>\u548c\u524d\u9762\u7684\u94a9\u5b50\u51fd\u6570\u4e00\u6837\u7684\uff0c\u6211\u4eec\u8fd9\u4e24\u4e2a\u63a2\u9488\u7684\u652f\u6301\u4e0b\u9762\u51e0\u79cd\u914d\u7f6e\u65b9\u5f0f\uff1a</p> <ul> <li>exec\uff1a\u6267\u884c\u4e00\u6bb5\u547d\u4ee4</li> <li>http\uff1a\u68c0\u6d4b\u67d0\u4e2a http \u8bf7\u6c42</li> <li>tcpSocket\uff1a\u4f7f\u7528\u6b64\u914d\u7f6e\uff0ckubelet \u5c06\u5c1d\u8bd5\u5728\u6307\u5b9a\u7aef\u53e3\u4e0a\u6253\u5f00\u5bb9\u5668\u7684\u5957\u63a5\u5b57\u3002\u5982\u679c\u53ef\u4ee5\u5efa\u7acb\u8fde\u63a5\uff0c\u5bb9\u5668\u88ab\u8ba4\u4e3a\u662f\u5065\u5eb7\u7684\uff0c\u5982\u679c\u4e0d\u80fd\u5c31\u8ba4\u4e3a\u662f\u5931\u8d25\u7684\u3002\u5b9e\u9645\u4e0a\u5c31\u662f\u68c0\u67e5\u7aef\u53e3\u3002</li> </ul> <p>\u6211\u4eec\u5148\u6765\u7ed9\u5927\u5bb6\u6f14\u793a\u4e0b\u5b58\u6d3b\u63a2\u9488\u7684\u4f7f\u7528\u65b9\u6cd5\uff0c\u9996\u5148\u6211\u4eec\u7528 exec \u6267\u884c\u547d\u4ee4\u7684\u65b9\u5f0f\u6765\u68c0\u6d4b\u5bb9\u5668\u7684\u5b58\u6d3b\uff0c\u5982\u4e0b\uff1a\uff08liveness-exec.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: liveness-exec\nspec:\n  containers:\n  - name: liveness\n    image: busybox\n    args:\n    - /bin/sh\n    - -c\n    - touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600\n    livenessProbe:\n      exec:\n        command:\n        - cat\n        - /tmp/healthy\n      initialDelaySeconds: 5\n      periodSeconds: 5\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u9700\u8981\u7528\u5230\u4e00\u4e2a\u65b0\u7684\u5c5e\u6027\uff1a<code>livenessProbe</code>\uff0c\u4e0b\u9762\u901a\u8fc7 exec \u6267\u884c\u4e00\u6bb5\u547d\u4ee4:</p> <ul> <li><code>periodSeconds</code>\uff1a\u8868\u793a\u8ba9 kubelet \u6bcf\u96945\u79d2\u6267\u884c\u4e00\u6b21\u5b58\u6d3b\u63a2\u9488\uff0c\u4e5f\u5c31\u662f\u6bcf5\u79d2\u6267\u884c\u4e00\u6b21\u4e0a\u9762\u7684<code>cat /tmp/healthy</code>\u547d\u4ee4\uff0c\u5982\u679c\u547d\u4ee4\u6267\u884c\u6210\u529f\u4e86\uff0c\u5c06\u8fd4\u56de0\uff0c\u90a3\u4e48 kubelet \u5c31\u4f1a\u8ba4\u4e3a\u5f53\u524d\u8fd9\u4e2a\u5bb9\u5668\u662f\u5b58\u6d3b\u7684\uff0c\u5982\u679c\u8fd4\u56de\u7684\u662f\u975e0\u503c\uff0c\u90a3\u4e48 kubelet \u5c31\u4f1a\u628a\u8be5\u5bb9\u5668\u6740\u6389\u7136\u540e\u91cd\u542f\u5b83\u3002\u9ed8\u8ba4\u662f10\u79d2\uff0c\u6700\u5c0f1\u79d2\u3002</li> <li><code>initialDelaySeconds</code>\uff1a\u8868\u793a\u5728\u7b2c\u4e00\u6b21\u6267\u884c\u63a2\u9488\u7684\u65f6\u5019\u8981\u7b49\u5f855\u79d2\uff0c\u8fd9\u6837\u80fd\u591f\u786e\u4fdd\u6211\u4eec\u7684\u5bb9\u5668\u80fd\u591f\u6709\u8db3\u591f\u7684\u65f6\u95f4\u542f\u52a8\u8d77\u6765\u3002\u5927\u5bb6\u53ef\u4ee5\u60f3\u8c61\u4e0b\uff0c\u5982\u679c\u4f60\u7684\u7b2c\u4e00\u6b21\u6267\u884c\u63a2\u9488\u7b49\u5019\u7684\u65f6\u95f4\u592a\u77ed\uff0c\u662f\u4e0d\u662f\u5f88\u6709\u53ef\u80fd\u5bb9\u5668\u8fd8\u6ca1\u6b63\u5e38\u542f\u52a8\u8d77\u6765\uff0c\u6240\u4ee5\u5b58\u6d3b\u63a2\u9488\u5f88\u53ef\u80fd\u59cb\u7ec8\u90fd\u662f\u5931\u8d25\u7684\uff0c\u8fd9\u6837\u5c31\u4f1a\u65e0\u4f11\u6b62\u7684\u91cd\u542f\u4e0b\u53bb\u4e86\uff0c\u5bf9\u5427\uff1f</li> </ul> <p>\u6211\u4eec\u5728\u5bb9\u5668\u542f\u52a8\u7684\u65f6\u5019\uff0c\u6267\u884c\u4e86\u5982\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ /bin/sh -c \"touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600\"\n</code></pre> <p>\u610f\u601d\u662f\u8bf4\u5728\u5bb9\u5668\u6700\u5f00\u59cb\u768430\u79d2\u5185\u521b\u5efa\u4e86\u4e00\u4e2a<code>/tmp/healthy</code>\u6587\u4ef6\uff0c\u5728\u8fd930\u79d2\u5185\u6267\u884c<code>cat /tmp/healthy</code>\u547d\u4ee4\u90fd\u4f1a\u8fd4\u56de\u4e00\u4e2a\u6210\u529f\u7684\u8fd4\u56de\u7801\u300230 \u79d2\u540e\uff0c\u6211\u4eec\u5220\u9664\u8fd9\u4e2a\u6587\u4ef6\uff0c\u73b0\u5728\u6267\u884c<code>cat /tmp/healthy</code>\u662f\u4e0d\u662f\u5c31\u4f1a\u5931\u8d25\u4e86\uff08\u9ed8\u8ba4\u68c0\u6d4b\u5931\u8d253\u6b21\u624d\u8ba4\u4e3a\u5931\u8d25\uff09\uff0c\u6240\u4ee5\u8fd9\u4e2a\u65f6\u5019\u5c31\u4f1a\u91cd\u542f\u5bb9\u5668\u4e86\u3002</p> <p>\u6211\u4eec\u6765\u521b\u5efa\u4e0b\u8be5 Pod\uff0c\u7136\u540e\u5728 30 \u79d2\u5185\uff0c\u67e5\u770b Pod \u7684 Event\uff1a</p> <pre><code>$ kubectl apply -f liveness-exec.yaml\n$ kubectl describe pod liveness-exec\n......\n  Normal  Started    20s        kubelet, ydzs-node4  Started container liveness\n......\n Normal   Started    46s               kubelet, ydzs-node4  Started container liveness\n  Warning  Unhealthy  3s (x3 over 13s)  kubelet, ydzs-node4  Liveness probe failed: cat: can't open '/tmp/healthy': No such file or directory\n  Normal   Killing    3s                kubelet, ydzs-node4  Container liveness failed liveness probe, will be restarted\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u89c2\u5bdf\u5230\u5bb9\u5668\u662f\u6b63\u5e38\u542f\u52a8\u7684\uff0c\u5728\u9694\u4e00\u4f1a\u513f\uff0c\u6bd4\u5982 40s \u540e\uff0c\u518d\u67e5\u770b\u4e0b Pod \u7684 Event\uff0c\u5728\u6700\u4e0b\u9762\u6709\u4e00\u6761\u4fe1\u606f\u663e\u793a liveness probe \u5931\u8d25\u4e86\uff0c\u5bb9\u5668\u5c06\u8981\u91cd\u542f\u3002\u7136\u540e\u53ef\u4ee5\u67e5\u770b\u5230 Pod \u7684 <code>RESTARTS</code> \u503c\u52a0 1 \u4e86\uff1a</p> <pre><code>$ kubectl get pods\nNAME            READY   STATUS    RESTARTS   AGE\nliveness-exec   1/1     Running   1          1m\n</code></pre> <p>\u540c\u6837\u7684\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528<code>HTTP GET</code>\u8bf7\u6c42\u6765\u914d\u7f6e\u6211\u4eec\u7684\u5b58\u6d3b\u63a2\u9488\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u4e00\u4e2a liveness \u955c\u50cf\u6765\u9a8c\u8bc1\u6f14\u793a\u4e0b\uff1a\uff08liveness-http.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: liveness-http\nspec:\n  containers:\n  - name: liveness\n    image: cnych/liveness\n    args:\n    - /server\n    livenessProbe:\n      httpGet:\n        path: /healthz\n        port: 8080\n        httpHeaders:\n        - name: X-Custom-Header\n          value: Awesome\n      initialDelaySeconds: 3\n      periodSeconds: 3\n</code></pre> <p>\u540c\u6837\u7684\uff0c\u6839\u636e periodSeconds \u5c5e\u6027\u6211\u4eec\u53ef\u4ee5\u77e5\u9053 kubelet \u9700\u8981\u6bcf\u96943\u79d2\u6267\u884c\u4e00\u6b21 liveness Probe\uff0c\u8be5\u63a2\u9488\u5c06\u5411\u5bb9\u5668\u4e2d\u7684 server \u7684 8080 \u7aef\u53e3\u53d1\u9001\u4e00\u4e2a HTTP GET \u8bf7\u6c42\u3002\u5982\u679c server \u7684 /healthz \u8def\u5f84\u7684 handler \u8fd4\u56de\u4e00\u4e2a\u6210\u529f\u7684\u8fd4\u56de\u7801\uff0ckubelet \u5c31\u4f1a\u8ba4\u5b9a\u8be5\u5bb9\u5668\u662f\u6d3b\u7740\u7684\u5e76\u4e14\u5f88\u5065\u5eb7\uff0c\u5982\u679c\u8fd4\u56de\u5931\u8d25\u7684\u8fd4\u56de\u7801\uff0ckubelet \u5c06\u6740\u6389\u8be5\u5bb9\u5668\u5e76\u91cd\u542f\u5b83\u3002initialDelaySeconds \u6307\u5b9akubelet \u5728\u8be5\u6267\u884c\u7b2c\u4e00\u6b21\u63a2\u6d4b\u4e4b\u524d\u9700\u8981\u7b49\u5f853\u79d2\u949f\u3002</p> <p>\u8fd4\u56de\u7801</p> <p>\u901a\u5e38\u6765\u8bf4\uff0c\u4efb\u4f55\u5927\u4e8e<code>200</code>\u5c0f\u4e8e<code>400</code>\u7684\u72b6\u6001\u7801\u90fd\u4f1a\u8ba4\u5b9a\u662f\u6210\u529f\u7684\u8fd4\u56de\u7801\u3002\u5176\u4ed6\u8fd4\u56de\u7801\u90fd\u4f1a\u88ab\u8ba4\u4e3a\u662f\u5931\u8d25\u7684\u8fd4\u56de\u7801\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u6765\u67e5\u770b\u4e0b\u4e0a\u9762\u7684 healthz \u7684\u5b9e\u73b0\uff1a</p> <pre><code>http.HandleFunc(\"/healthz\", func(w http.ResponseWriter, r *http.Request) {\n    duration := time.Now().Sub(started)\n    if duration.Seconds() &gt; 10 {\n        w.WriteHeader(500)\n        w.Write([]byte(fmt.Sprintf(\"error: %v\", duration.Seconds())))\n    } else {\n        w.WriteHeader(200)\n        w.Write([]byte(\"ok\"))\n    }\n})\n</code></pre> <p>\u5927\u6982\u610f\u601d\u5c31\u662f\u6700\u5f00\u59cb\u524d 10s \u8fd4\u56de\u72b6\u6001\u7801200\uff0c10s \u8fc7\u540e\u5c31\u8fd4\u56de\u72b6\u6001\u7801500\u3002\u6240\u4ee5\u5f53\u5bb9\u5668\u542f\u52a83\u79d2\u540e\uff0ckubelet \u5f00\u59cb\u6267\u884c\u5065\u5eb7\u68c0\u67e5\u3002\u7b2c\u4e00\u6b21\u5065\u5eb7\u68c0\u67e5\u4f1a\u6210\u529f\uff0c\u56e0\u4e3a\u662f\u5728 10s \u4e4b\u5185\uff0c\u4f46\u662f 10 \u79d2\u540e\uff0c\u5065\u5eb7\u68c0\u67e5\u5c06\u5931\u8d25\uff0c\u56e0\u4e3a\u73b0\u5728\u8fd4\u56de\u7684\u662f\u4e00\u4e2a\u9519\u8bef\u7684\u72b6\u6001\u7801\u4e86\uff0c\u6240\u4ee5 kubelet \u5c06\u4f1a\u6740\u6389\u548c\u91cd\u542f\u5bb9\u5668\u3002</p> <p>\u540c\u6837\u7684\uff0c\u6211\u4eec\u6765\u521b\u5efa\u4e0b\u8be5 Pod \u6d4b\u8bd5\u4e0b\u6548\u679c\uff0c10 \u79d2\u540e\uff0c\u67e5\u770b Pod \u7684 event\uff0c\u786e\u8ba4 liveness probe \u5931\u8d25\u5e76\u91cd\u542f\u4e86\u5bb9\u5668\uff1a</p> <pre><code>$ kubectl apply -f liveness-http.yaml\n$ kubectl describe pod liveness-http\n......\n Normal   Pulled     12s (x3 over 76s)  kubelet, ydzs-node1  Successfully pulled image \"cnych/liveness\"\n  Normal   Created    12s (x3 over 76s)  kubelet, ydzs-node1  Created container liveness\n  Normal   Started    11s (x3 over 76s)  kubelet, ydzs-node1  Started container liveness\n......\n Normal   Pulling    15s (x4 over 102s)  kubelet, ydzs-node1  Pulling image \"cnych/liveness\"\n  Warning  Unhealthy  15s (x9 over 87s)   kubelet, ydzs-node1  Liveness probe failed: HTTP probe failed with statuscode: 500\n  Normal   Killing    15s (x3 over 81s)   kubelet, ydzs-node1  Container liveness failed liveness probe, will be restarted\n......\n$ kubectl get pods\nNAME            READY   STATUS             RESTARTS   AGE\nliveness-http   1/1     Running            3          2m2s\n</code></pre> <p>\u9664\u4e86\u4e0a\u9762\u7684 <code>exec</code> \u548c <code>httpGet</code> \u4e24\u79cd\u68c0\u6d4b\u65b9\u5f0f\u4e4b\u5916\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7 <code>tcpSocket</code> \u65b9\u5f0f\u6765\u68c0\u6d4b\u7aef\u53e3\u662f\u5426\u6b63\u5e38\uff0c\u5927\u5bb6\u53ef\u4ee5\u6309\u7167\u4e0a\u9762\u7684\u65b9\u5f0f\u7ed3\u5408<code>kubectl explain</code>\u547d\u4ee4\u81ea\u5df1\u6765\u9a8c\u8bc1\u4e0b\u8fd9\u79cd\u65b9\u5f0f\u3002</p> <p>\u53e6\u5916\u524d\u9762\u6211\u4eec\u63d0\u5230\u4e86\u63a2\u9488\u91cc\u9762\u6709\u4e00\u4e2a<code>initialDelaySeconds</code>\u7684\u5c5e\u6027\uff0c\u53ef\u4ee5\u6765\u914d\u7f6e\u7b2c\u4e00\u6b21\u6267\u884c\u63a2\u9488\u7684\u7b49\u5f85\u65f6\u95f4\uff0c\u5bf9\u4e8e\u542f\u52a8\u975e\u5e38\u6162\u7684\u5e94\u7528\u8fd9\u4e2a\u53c2\u6570\u975e\u5e38\u6709\u7528\uff0c\u6bd4\u5982 <code>Jenkins</code>\u3001<code>Gitlab</code> \u8fd9\u7c7b\u5e94\u7528\uff0c\u4f46\u662f\u5982\u4f55\u8bbe\u7f6e\u4e00\u4e2a\u5408\u9002\u7684\u521d\u59cb\u5ef6\u8fdf\u65f6\u95f4\u5462\uff1f\u8fd9\u4e2a\u5c31\u548c\u5e94\u7528\u5177\u4f53\u7684\u73af\u5883\u6709\u5173\u7cfb\u4e86\uff0c\u6240\u4ee5\u8fd9\u4e2a\u503c\u5f80\u5f80\u4e0d\u662f\u901a\u7528\u7684\uff0c\u8fd9\u6837\u7684\u8bdd\u53ef\u80fd\u5c31\u4f1a\u5bfc\u81f4\u4e00\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u7684\u8d44\u6e90\u6e05\u5355\u5728\u522b\u7684\u73af\u5883\u4e0b\u53ef\u80fd\u5c31\u4f1a\u5065\u5eb7\u68c0\u67e5\u5931\u8d25\u4e86\uff0c\u4e3a\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5728 Kubernetes v1.16 \u7248\u672c\u5b98\u65b9\u7279\u5730\u65b0\u589e\u4e86\u4e00\u4e2a <code>startupProbe\uff08\u542f\u52a8\u63a2\u9488\uff09</code>\uff0c\u8be5\u63a2\u9488\u5c06\u63a8\u8fdf\u6240\u6709\u5176\u4ed6\u63a2\u9488\uff0c\u76f4\u5230 Pod \u5b8c\u6210\u542f\u52a8\u4e3a\u6b62\uff0c\u4f7f\u7528\u65b9\u6cd5\u548c\u5b58\u6d3b\u63a2\u9488\u4e00\u6837\uff1a</p> <pre><code>startupProbe:\n  httpGet:\n    path: /healthz\n    port: 8080\n  failureThreshold: 30  # \u5c3d\u91cf\u8bbe\u7f6e\u5927\u70b9\n  periodSeconds: 10\n</code></pre> <p>\u6bd4\u5982\u4e0a\u9762\u8fd9\u91cc\u7684\u914d\u7f6e\u8868\u793a\u6211\u4eec\u7684\u6162\u901f\u5bb9\u5668\u6700\u591a\u53ef\u4ee5\u67095\u5206\u949f\uff0830\u4e2a\u68c0\u67e5 * 10\u79d2= 300s\uff09\u6765\u5b8c\u6210\u542f\u52a8\u3002</p> <p>\u6709\u7684\u65f6\u5019\uff0c\u5e94\u7528\u7a0b\u5e8f\u53ef\u80fd\u6682\u65f6\u65e0\u6cd5\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\uff0c\u4f8b\u5982\uff0c\u5e94\u7528\u7a0b\u5e8f\u53ef\u80fd\u9700\u8981\u5728\u542f\u52a8\u671f\u95f4\u52a0\u8f7d\u5927\u91cf\u6570\u636e\u6216\u914d\u7f6e\u6587\u4ef6\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u60a8\u4e0d\u60f3\u6740\u6b7b\u5e94\u7528\u7a0b\u5e8f\uff0c\u4e5f\u4e0d\u60f3\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\u3002\u90a3\u4e48\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528<code>readiness probe</code>\u6765\u68c0\u6d4b\u548c\u51cf\u8f7b\u8fd9\u4e9b\u60c5\u51b5\u3002 Pod \u4e2d\u7684\u5bb9\u5668\u53ef\u4ee5\u62a5\u544a\u81ea\u5df1\u8fd8\u6ca1\u6709\u51c6\u5907\uff0c\u4e0d\u80fd\u5904\u7406 Kubernetes \u670d\u52a1\u53d1\u9001\u8fc7\u6765\u7684\u6d41\u91cf\u3002<code>readiness probe</code>\u7684\u914d\u7f6e\u8ddf<code>liveness probe</code>\u57fa\u672c\u4e0a\u4e00\u81f4\u7684\u3002\u552f\u4e00\u7684\u4e0d\u540c\u662f\u4f7f\u7528<code>readinessProbe</code>\u800c\u4e0d\u662f<code>livenessProbe</code>\u3002\u4e24\u8005\u5982\u679c\u540c\u65f6\u4f7f\u7528\u7684\u8bdd\u5c31\u53ef\u4ee5\u786e\u4fdd\u6d41\u91cf\u4e0d\u4f1a\u5230\u8fbe\u8fd8\u672a\u51c6\u5907\u597d\u7684\u5bb9\u5668\uff0c\u51c6\u5907\u597d\u8fc7\u540e\uff0c\u5982\u679c\u5e94\u7528\u7a0b\u5e8f\u51fa\u73b0\u4e86\u9519\u8bef\uff0c\u5219\u4f1a\u91cd\u65b0\u542f\u52a8\u5bb9\u5668\u3002\u5bf9\u4e8e\u5c31\u7eea\u63a2\u9488\u6211\u4eec\u4f1a\u5728\u540e\u9762 Service \u7684\u7ae0\u8282\u548c\u5927\u5bb6\u7ee7\u7eed\u4ecb\u7ecd\u3002</p> <p>\u53e6\u5916\u9664\u4e86\u4e0a\u9762\u7684<code>initialDelaySeconds</code>\u548c<code>periodSeconds</code>\u5c5e\u6027\u5916\uff0c\u63a2\u9488\u8fd8\u53ef\u4ee5\u914d\u7f6e\u5982\u4e0b\u51e0\u4e2a\u53c2\u6570\uff1a</p> <ul> <li>timeoutSeconds\uff1a\u63a2\u6d4b\u8d85\u65f6\u65f6\u95f4\uff0c\u9ed8\u8ba41\u79d2\uff0c\u6700\u5c0f1\u79d2\u3002</li> <li>successThreshold\uff1a\u63a2\u6d4b\u5931\u8d25\u540e\uff0c\u6700\u5c11\u8fde\u7eed\u63a2\u6d4b\u6210\u529f\u591a\u5c11\u6b21\u624d\u88ab\u8ba4\u5b9a\u4e3a\u6210\u529f\u3002\u9ed8\u8ba4\u662f 1\uff0c\u4f46\u662f\u5982\u679c\u662f<code>liveness</code>\u5219\u5fc5\u987b\u662f 1\u3002\u6700\u5c0f\u503c\u662f 1\u3002</li> <li>failureThreshold\uff1a\u63a2\u6d4b\u6210\u529f\u540e\uff0c\u6700\u5c11\u8fde\u7eed\u63a2\u6d4b\u5931\u8d25\u591a\u5c11\u6b21\u624d\u88ab\u8ba4\u5b9a\u4e3a\u5931\u8d25\u3002\u9ed8\u8ba4\u662f 3\uff0c\u6700\u5c0f\u503c\u662f 1\u3002</li> </ul>"},{"location":"kubernetes_basic/pod_life/#pod_3","title":"Pod \u8d44\u6e90\u914d\u7f6e","text":"<p>\u5b9e\u9645\u4e0a\u4e0a\u9762\u51e0\u4e2a\u6b65\u9aa4\u5c31\u662f\u5f71\u54cd\u4e00\u4e2a Pod \u751f\u547d\u5468\u671f\u7684\u5927\u7684\u90e8\u5206\uff0c\u4f46\u662f\u8fd8\u6709\u4e00\u4e9b\u7ec6\u8282\u4e5f\u4f1a\u5728 Pod \u7684\u542f\u52a8\u8fc7\u7a0b\u8fdb\u884c\u8bbe\u7f6e\uff0c\u6bd4\u5982\u5728\u5bb9\u5668\u542f\u52a8\u4e4b\u524d\u8fd8\u4f1a\u4e3a\u5f53\u524d\u7684\u5bb9\u5668\u8bbe\u7f6e\u5206\u914d\u7684 CPU\u3001\u5185\u5b58\u7b49\u8d44\u6e90\uff0c\u6211\u4eec\u77e5\u9053\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 CGroup \u6765\u5bf9\u5bb9\u5668\u7684\u8d44\u6e90\u8fdb\u884c\u9650\u5236\uff0c\u540c\u6837\u7684\uff0c\u5728 Pod \u4e2d\u6211\u4eec\u4e5f\u53ef\u4ee5\u76f4\u63a5\u914d\u7f6e\u67d0\u4e2a\u5bb9\u5668\u7684\u4f7f\u7528\u7684 CPU \u6216\u8005\u5185\u5b58\u7684\u4e0a\u9650\u3002\u90a3\u4e48 Pod \u662f\u5982\u4f55\u6765\u4f7f\u7528\u548c\u63a7\u5236\u8fd9\u4e9b\u8d44\u6e90\u7684\u5206\u914d\u7684\u5462\uff1f</p> <p>\u9996\u5148\u5bf9\u4e8e CPU\uff0c\u6211\u4eec\u77e5\u9053\u8ba1\u7b97\u673a\u91cc CPU \u7684\u8d44\u6e90\u662f\u6309<code>\u65f6\u95f4\u7247</code>\u7684\u65b9\u5f0f\u6765\u8fdb\u884c\u5206\u914d\u7684\uff0c\u7cfb\u7edf\u91cc\u7684\u6bcf\u4e00\u4e2a\u64cd\u4f5c\u90fd\u9700\u8981 CPU \u7684\u5904\u7406\uff0c\u6240\u4ee5\uff0c\u54ea\u4e2a\u4efb\u52a1\u8981\u662f\u7533\u8bf7\u7684 CPU \u65f6\u95f4\u7247\u8d8a\u591a\uff0c\u90a3\u4e48\u5b83\u5f97\u5230\u7684 CPU \u8d44\u6e90\u5c31\u8d8a\u591a\uff0c\u8fd9\u4e2a\u5f88\u5bb9\u5668\u7406\u89e3\u3002</p> <p>\u7136\u540e\u8fd8\u9700\u8981\u4e86\u89e3\u4e0b CGroup \u91cc\u9762\u5bf9\u4e8e CPU \u8d44\u6e90\u7684\u5355\u4f4d\u6362\u7b97\uff1a</p> <pre><code>1 CPU =  1000 millicpu\uff081 Core = 1000m\uff09\n\n5 CPU = 500 millicpu \uff085 Core = 500m\uff09\n</code></pre> <p>\u8fd9\u91cc\u7684 <code>m</code> \u5c31\u662f\u6beb\u3001\u6beb\u6838\u7684\u610f\u601d\uff0cKubernetes \u96c6\u7fa4\u4e2d\u7684\u6bcf\u4e00\u4e2a\u8282\u70b9\u53ef\u4ee5\u901a\u8fc7\u64cd\u4f5c\u7cfb\u7edf\u7684\u547d\u4ee4\u6765\u786e\u8ba4\u672c\u8282\u70b9\u7684 CPU \u5185\u6838\u6570\u91cf\uff0c\u7136\u540e\u5c06\u8fd9\u4e2a\u6570\u91cf\u4e58\u4ee51000\uff0c\u5f97\u5230\u7684\u5c31\u662f\u8282\u70b9\u603b CPU \u603b\u6beb\u6570\u3002\u6bd4\u5982\u4e00\u4e2a\u8282\u70b9\u6709\u56db\u6838\uff0c\u90a3\u4e48\u8be5\u8282\u70b9\u7684 CPU \u603b\u6beb\u91cf\u4e3a 4000m\uff0c\u5982\u679c\u4f60\u8981\u4f7f\u75280.5 core\uff0c\u5219\u4f60\u8981\u6c42\u7684\u662f 4000*0.5 = 2000m\u3002\u5728 Pod \u91cc\u9762\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u4e24\u4e2a\u53c2\u6570\u6765\u73b0\u5728\u548c\u8bf7\u6c42 CPU \u8d44\u6e90\uff1a</p> <ul> <li> <p><code>spec.containers[].resources.limits.cpu</code></p> <p>\uff1aCPU \u4e0a\u9650\u503c\uff0c\u53ef\u4ee5\u77ed\u6682\u8d85\u8fc7\uff0c\u5bb9\u5668\u4e5f\u4e0d\u4f1a\u88ab\u505c\u6b62 *   <code>spec.containers[].resources.requests.cpu</code></p> <p>\uff1aCPU\u8bf7\u6c42\u503c\uff0cKubernetes \u8c03\u5ea6\u7b97\u6cd5\u91cc\u7684\u4f9d\u636e\u503c\uff0c\u53ef\u4ee5\u8d85\u8fc7</p> </li> </ul> <p>\u8fd9\u91cc\u9700\u8981\u660e\u767d\u7684\u662f\uff0c\u5982\u679c</p> <pre><code>resources.requests.cpu\n</code></pre> <p>\u8bbe\u7f6e\u7684\u503c\u5927\u4e8e\u96c6\u7fa4\u91cc\u6bcf\u4e2a\u8282\u70b9\u7684\u6700\u5927 CPU \u6838\u5fc3\u6570\uff0c\u90a3\u4e48\u8fd9\u4e2a Pod \u5c06\u65e0\u6cd5\u8c03\u5ea6\uff0c\u56e0\u4e3a\u6ca1\u6709\u8282\u70b9\u80fd\u6ee1\u8db3\u5b83\u3002</p> <p>\u5230\u8fd9\u91cc\u5e94\u8be5\u660e\u767d\u4e86\uff0c<code>requests</code> \u662f\u7528\u4e8e\u96c6\u7fa4\u8c03\u5ea6\u4f7f\u7528\u7684\u8d44\u6e90\uff0c\u800c <code>limits</code> \u624d\u662f\u771f\u6b63\u7684\u7528\u4e8e\u8d44\u6e90\u9650\u5236\u7684\u914d\u7f6e\uff0c\u5982\u679c\u4f60\u9700\u8981\u4fdd\u8bc1\u7684\u4f60\u5e94\u7528\u4f18\u5148\u7ea7\u5f88\u9ad8\uff0c\u4e5f\u5c31\u662f\u8d44\u6e90\u5403\u7d27\u7684\u60c5\u51b5\u4e0b\u6700\u540e\u518d\u6740\u6389\u4f60\u7684 Pod\uff0c\u90a3\u4e48\u4f60\u5c31\u628a\u4f60\u7684 requests \u548c limits \u7684\u503c\u8bbe\u7f6e\u6210\u4e00\u81f4\uff0c\u5728\u540e\u9762\u5e94\u7528\u7684 <code>Qos</code> \u4e2d\u4f1a\u5177\u4f53\u8bb2\u89e3\u3002</p> <p>\u6bd4\u5982\uff0c\u73b0\u5728\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a Pod\uff0c\u7ed9\u5bb9\u5668\u7684\u914d\u7f6e\u5982\u4e0b\u7684\u8d44\u6e90\uff1a\uff08pod-resource-demo1.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: resource-demo1\nspec:\n  containers:\n  - name: resource-demo1\n    image: nginx\n    ports:\n    - containerPort: 80\n    resources:\n      requests:\n        memory: 50Mi\n        cpu: 50m\n      limits:\n        memory: 100Mi\n        cpu: 100m\n</code></pre> <p>\u8fd9\u91cc\uff0cCPU \u6211\u4eec\u7ed9\u7684\u662f 50m\uff0c\u4e5f\u5c31\u662f 0.05core\uff0c\u8fd9 0.05 core \u4e5f\u5c31\u662f\u5360\u4e86 1 CPU \u91cc\u7684 5% \u7684\u8d44\u6e90\u65f6\u95f4\u3002\u800c\u9650\u5236\u8d44\u6e90\u662f\u7ed9\u7684\u662f 100m\uff0c\u4f46\u662f\u9700\u8981\u6ce8\u610f\u7684\u662f CPU \u8d44\u6e90\u662f\u53ef\u538b\u7f29\u8d44\u6e90\uff0c\u4e5f\u5c31\u662f\u5bb9\u5668\u8fbe\u5230\u4e86\u8fd9\u4e2a\u8bbe\u5b9a\u7684\u4e0a\u9650\u540e\uff0c\u5bb9\u5668\u6027\u80fd\u4f1a\u4e0b\u964d\uff0c\u4f46\u662f\u4e0d\u4f1a\u7ec8\u6b62\u6216\u9000\u51fa\u3002\u6bd4\u5982\u6211\u4eec\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u8fd9\u4e2a Pod\uff1a</p> <pre><code>$ kubectl apply -f pod-resource-demoyaml\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Pod \u88ab\u8c03\u5ea6\u5230 node3 \u8fd9\u4e2a\u8282\u70b9\u4e0a\uff1a</p> <pre><code>$ kubectl get pods -o wide\nNAME             READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES\nresource-demo1   1/1     Running   0          12m   258    ydzs-node3   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u5230 node3 \u8282\u70b9\u4e0a\u53bb\u67e5\u770b Pod \u91cc\u9762\u542f\u52a8\u7684 <code>resource-demo1</code> \u8fd9\u4e2a\u5bb9\u5668\uff1a</p> <pre><code>$ docker ps |grep resource-demo1\nc9e654d573fd        nginx                                      \"nginx -g 'daemon of\u2026\"   14 minutes ago      Up 14 minutes                           k8s_resource-demo1_resource-demo1_default_020bc461-170a-4936-9c22-7c8516972d39_0\n37ab54a2490a        gcr.azk8s.cn/google_containers/pause:1   \"/pause\"                 14 minutes ago      Up 14 minutes                           k8s_POD_resource-demo1_default_020bc461-170a-4936-9c22-7c8516972d39_0\n</code></pre> <p>\u5176\u4e2d\u7b2c\u4e00\u4e2a\u5bb9\u5668\u5c31\u662f\u6211\u4eec\u7684\u4e3b\u5bb9\u5668\uff0c\u7b2c\u4e8c\u5bb9\u5668\u662f Infra \u5bb9\u5668\uff0c\u6211\u4eec\u53ef\u4ee5\u53bb\u67e5\u770b\u4e0b\u4e3b\u5bb9\u5668\u7684\u4fe1\u606f\uff1a</p> <pre><code>$ docker inspect c9e654d573fd\n......\n\"CpuShares\": 51,\n\"Memory\": 104857600,\n\"NanoCpus\": 0,\n\"CgroupParent\": \"kubepods-burstable-pod020bc461_170a_4936_9c22_7c8516972dslice\",\n\"BlkioWeight\": 0,\n\"BlkioWeightDevice\": null,\n\"BlkioDeviceReadBps\": null,\n\"BlkioDeviceWriteBps\": null,\n\"BlkioDeviceReadIOps\": null,\n\"BlkioDeviceWriteIOps\": null,\n\"CpuPeriod\": 100000,\n\"CpuQuota\": 10000,\n\"CpuRealtimePeriod\": 0,\n\"CpuRealtimeRuntime\": 0,\n\"CpusetCpus\": \"\",\n\"CpusetMems\": \"\",\n\"Devices\": [],\n\"DeviceCgroupRules\": null,\n\"DiskQuota\": 0,\n\"KernelMemory\": 0,\n\"MemoryReservation\": 0,\n\"MemorySwap\": 104857600,\n\"MemorySwappiness\": null,\n\"OomKillDisable\": false,\n......\n</code></pre> <p>\u5b9e\u9645\u4e0a\u6211\u4eec\u5c31\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a\u5bb9\u5668\u7684\u4e00\u4e9b\u8d44\u6e90\u60c5\u51b5\uff0cPod \u4e0a\u7684\u8d44\u6e90\u914d\u7f6e\u6700\u7ec8\u4e5f\u8fd8\u662f\u901a\u8fc7\u5e95\u5c42\u7684\u5bb9\u5668\u8fd0\u884c\u65f6\u53bb\u63a7\u5236 CGroup \u6765\u5b9e\u73b0\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u8fdb\u5165\u5982\u4e0b\u76ee\u5f55\u67e5\u770b CGroup \u7684\u914d\u7f6e\uff0c\u8be5\u76ee\u5f55\u5c31\u662f CGroup \u7236\u7ea7\u76ee\u5f55\uff0c\u800c CGroup \u662f\u901a\u8fc7\u6587\u4ef6\u7cfb\u7edf\u6765\u8fdb\u884c\u8d44\u6e90\u9650\u5236\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u4e0a\u9762\u9650\u5236\u5bb9\u5668\u7684\u8d44\u6e90\u5c31\u53ef\u4ee5\u5728\u8be5\u76ee\u5f55\u4e0b\u9762\u53cd\u6620\u51fa\u6765\uff1a</p> <pre><code>$ cd /sys/fs/cgroup/cpu/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-pod020bc461_170a_4936_9c22_7c8516972dslice\n$ ls\ncgroup.clone_children  cpu.cfs_period_us  docker-37ab54a2490a48c88918f53572e053784238bf3720cb1ae5bf01052040aba9ascope\ncgroup.event_control   cpu.cfs_quota_us   docker-c9e654d573fd3e3e9a8bb78f3f904e60a59aa3384b344117fd401529e982aescope\ncgroup.procs           cpu.rt_period_us   notify_on_release\ncpuacct.stat           cpu.rt_runtime_us  tasks\ncpuacct.usage          cpu.shares\ncpuacct.usage_percpu   cpu.stat\n$ cat cpu.cfs_quota_us\n10000\n</code></pre> <p>\u5176\u4e2d <code>cpu.cfs_quota_us</code> \u5c31\u662f CPU \u7684\u9650\u5236\u503c\uff0c\u5982\u679c\u8981\u67e5\u770b\u5177\u4f53\u7684\u5bb9\u5668\u7684\u8d44\u6e90\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u8fdb\u5165\u5230\u5bb9\u5668\u76ee\u5f55\u4e0b\u9762\u53bb\u67e5\u770b\u5373\u53ef\u3002</p> <p>\u6700\u540e\u6211\u4eec\u4e86\u89e3\u4e0b\u5185\u5b58\u8fd9\u5757\u7684\u8d44\u6e90\u63a7\u5236\uff0c\u5185\u5b58\u7684\u5355\u4f4d\u6362\u7b97\u6bd4\u8f83\u7b80\u5355\uff1a</p> <p><code>1 MiB = 1024 KiB</code>\uff0c\u5185\u5b58\u8fd9\u5757\u5728 Kubernetes \u91cc\u4e00\u822c\u7528\u7684\u662f<code>Mi</code>\u5355\u4f4d\uff0c\u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528<code>Ki\u3001Gi</code>\u751a\u81f3<code>Pi</code>\uff0c\u770b\u5177\u4f53\u7684\u4e1a\u52a1\u9700\u6c42\u548c\u8d44\u6e90\u5bb9\u91cf\u3002</p> <p>\u5355\u4f4d\u6362\u7b97</p> <p>\u8fd9\u91cc\u6ce8\u610f\u7684\u662f<code>MiB \u2260 MB</code>\uff0cMB \u662f\u5341\u8fdb\u5236\u5355\u4f4d\uff0cMiB \u662f\u4e8c\u8fdb\u5236\uff0c\u5e73\u65f6\u6211\u4eec\u4ee5\u4e3a MB \u7b49\u4e8e 1024KB\uff0c\u5176\u5b9e<code>1MB=1000KB</code>\uff0c<code>1MiB</code>\u624d\u7b49\u4e8e<code>1024KiB</code>\u3002\u4e2d\u95f4\u5e26\u5b57\u6bcd i \u7684\u662f\u56fd\u9645\u7535\u5de5\u534f\u4f1a\uff08IEC\uff09\u5b9a\u7684\uff0c\u8d701024\u4e58\u79ef\uff1bKB\u3001MB\u3001GB\u662f\u56fd\u9645\u5355\u4f4d\u5236\uff0c\u8d701000\u4e58\u79ef\u3002</p> <p>\u8fd9\u91cc\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5185\u5b58\u662f\u53ef\u538b\u7f29\u6027\u8d44\u6e90\uff0c\u5982\u679c\u5bb9\u5668\u4f7f\u7528\u5185\u5b58\u8d44\u6e90\u5230\u8fbe\u4e86\u4e0a\u9650\uff0c\u90a3\u4e48\u4f1a<code>OOM</code>\uff0c\u9020\u6210\u5185\u5b58\u6ea2\u51fa\uff0c\u5bb9\u5668\u5c31\u4f1a\u7ec8\u6b62\u548c\u9000\u51fa\u3002\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4e0a\u9762\u7684\u65b9\u5f0f\u53bb\u901a\u8fc7\u67e5\u770b CGroup \u6587\u4ef6\u7684\u503c\u6765\u9a8c\u8bc1\u8d44\u6e90\u9650\u5236\u3002</p>"},{"location":"kubernetes_basic/yaml/","title":"\u8d44\u6e90\u6e05\u5355","text":"<p>\ue3c9</p>"},{"location":"kubernetes_basic/yaml/#yaml","title":"YAML \u6587\u4ef6","text":"<p>YAML \u6587\u4ef6\u57fa\u672c\u8bed\u6cd5\u683c\u5f0f</p> <p>\u524d\u9762\u6211\u4eec\u5f97 Kubernetes \u96c6\u7fa4\u5df2\u7ecf\u642d\u5efa\u6210\u529f\u4e86\uff0c\u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u5728\u96c6\u7fa4\u91cc\u9762\u6765\u8dd1\u6211\u4eec\u7684\u5e94\u7528\u4e86\u3002\u8981\u5728\u96c6\u7fa4\u91cc\u9762\u8fd0\u884c\u6211\u4eec\u81ea\u5df1\u7684\u5e94\u7528\uff0c\u9996\u5148\u6211\u4eec\u9700\u8981\u77e5\u9053\u51e0\u4e2a\u6982\u5ff5\u3002</p> <p>\u7b2c\u4e00\u4e2a\u5f53\u7136\u5c31\u662f\u5e94\u7528\u7684\u955c\u50cf\uff0c\u56e0\u4e3a\u6211\u4eec\u5728\u96c6\u7fa4\u4e2d\u8fd0\u884c\u7684\u662f\u5bb9\u5668\uff0c\u6240\u4ee5\u9996\u5148\u9700\u8981\u5c06\u6211\u4eec\u7684\u5e94\u7528\u6253\u5305\u6210\u955c\u50cf\uff0c\u524d\u9762\u7684\u8bfe\u7a0b\u4e2d\u6211\u4eec\u5df2\u7ecf\u5b66\u4e60\u8fc7\u5982\u4f55\u5c06\u5e94\u7528\u6253\u5305\u6210\u955c\u50cf\uff0c\u8fd9\u91cc\u5c31\u4e0d\u518d\u8d58\u8ff0\u4e86\u3002</p> <p>\u955c\u50cf\u51c6\u5907\u597d\u4e86\uff0cKubernetes \u96c6\u7fa4\u4e5f\u51c6\u5907\u597d\u4e86\uff0c\u5176\u5b9e\u6211\u4eec\u5c31\u53ef\u4ee5\u628a\u6211\u4eec\u7684\u5e94\u7528\u90e8\u7f72\u5230\u96c6\u7fa4\u4e2d\u4e86\u3002\u4f46\u662f\u955c\u50cf\u5230\u96c6\u7fa4\u4e2d\u8fd0\u884c\u8fd9\u4e2a\u8fc7\u7a0b\u5982\u4f55\u5b8c\u6210\u5462\uff1f\u5fc5\u7136\u6709\u4e00\u4e2a\u5730\u65b9\u53ef\u4ee5\u6765\u63cf\u8ff0\u6211\u4eec\u7684\u5e94\u7528\uff0c\u7136\u540e\u628a\u8fd9\u4efd\u63cf\u8ff0\u544a\u8bc9\u96c6\u7fa4\uff0c\u7136\u540e\u96c6\u7fa4\u6309\u7167\u8fd9\u4e2a\u63cf\u8ff0\u6765\u90e8\u7f72\u5e94\u7528\u3002</p> <p>\u5728\u4e4b\u524d Docker \u73af\u5883\u4e0b\u9762\u6211\u4eec\u662f\u76f4\u63a5\u901a\u8fc7\u547d\u4ee4 <code>docker run</code> \u6765\u8fd0\u884c\u6211\u4eec\u7684\u5e94\u7528\u7684\uff0c\u5728 Kubernetes \u73af\u5883\u4e0b\u9762\u6211\u4eec\u540c\u6837\u4e5f\u53ef\u4ee5\u7528\u7c7b\u4f3c <code>kubectl run</code> \u8fd9\u6837\u7684\u547d\u4ee4\u6765\u8fd0\u884c\u6211\u4eec\u7684\u5e94\u7528\uff0c\u4f46\u662f\u5728 Kubernetes \u4e2d\u5374\u662f\u4e0d\u63a8\u8350\u4f7f\u7528\u547d\u4ee4\u884c\u7684\u65b9\u5f0f\uff0c\u800c\u662f\u5e0c\u671b\u4f7f\u7528\u6211\u4eec\u79f0\u4e3a<code>\u8d44\u6e90\u6e05\u5355</code>\u7684\u4e1c\u897f\u6765\u63cf\u8ff0\u5e94\u7528\uff0c\u8d44\u6e90\u6e05\u5355\u53ef\u4ee5\u7528 YAML \u6216\u8005 JSON \u6587\u4ef6\u6765\u7f16\u5199\uff0c\u4e00\u822c\u6765\u8bf4 YAML \u6587\u4ef6\u66f4\u65b9\u4fbf\u9605\u8bfb\u548c\u7406\u89e3\uff0c\u6240\u4ee5\u6211\u4eec\u7684\u8bfe\u7a0b\u4e2d\u90fd\u4f1a\u4f7f\u7528 YAML \u6587\u4ef6\u6765\u8fdb\u884c\u63cf\u8ff0\u3002</p> <p>\u901a\u8fc7\u4e00\u4e2a\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u6765\u5b9a\u4e49\u597d\u4e00\u4e2a\u5e94\u7528\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 kubectl \u5de5\u5177\u6765\u76f4\u63a5\u8fd0\u884c\u5b83\uff1a</p> <pre><code>$ kubectl create -f xxxx.yaml\n</code></pre> <p>\u6211\u4eec\u77e5\u9053 kubectl \u662f\u76f4\u63a5\u64cd\u4f5c APIServer \u7684\uff0c\u6240\u4ee5\u5c31\u76f8\u5f53\u4e8e\u628a\u6211\u4eec\u7684\u6e05\u5355\u63d0\u4ea4\u7ed9\u4e86 APIServer\uff0c\u7136\u540e\u96c6\u7fa4\u83b7\u53d6\u5230\u6e05\u5355\u63cf\u8ff0\u7684\u5e94\u7528\u4fe1\u606f\u540e\u5b58\u5165\u5230 etcd \u6570\u636e\u5e93\u4e2d\uff0c\u7136\u540e kube-scheduler \u7ec4\u4ef6\u53d1\u73b0\u8fd9\u4e2a\u65f6\u5019\u6709\u4e00\u4e2a Pod \u8fd8\u6ca1\u6709\u7ed1\u5b9a\u5230\u8282\u70b9\u4e0a\uff0c\u5c31\u4f1a\u5bf9\u8fd9\u4e2a Pod \u8fdb\u884c\u4e00\u7cfb\u5217\u7684\u8c03\u5ea6\uff0c\u628a\u5b83\u8c03\u5ea6\u5230\u4e00\u4e2a\u6700\u5408\u9002\u7684\u8282\u70b9\u4e0a\uff0c\u7136\u540e\u628a\u8fd9\u4e2a\u8282\u70b9\u548c Pod \u7ed1\u5b9a\u5230\u4e00\u8d77\uff08\u5199\u56de\u5230 etcd\uff09\uff0c\u7136\u540e\u8282\u70b9\u4e0a\u7684 kubelet \u7ec4\u4ef6\u8fd9\u4e2a\u65f6\u5019 watch \u5230\u6709\u4e00\u4e2a Pod \u88ab\u5206\u914d\u8fc7\u6765\u4e86\uff0c\u5c31\u53bb\u628a\u8fd9\u4e2a Pod \u7684\u4fe1\u606f\u62c9\u53d6\u4e0b\u6765\uff0c\u7136\u540e\u6839\u636e\u63cf\u8ff0\u901a\u8fc7\u5bb9\u5668\u8fd0\u884c\u65f6\u628a\u5bb9\u5668\u521b\u5efa\u51fa\u6765\uff0c\u6700\u540e\u5f53\u7136\u540c\u6837\u628a Pod \u72b6\u6001\u518d\u5199\u56de\u5230 etcd \u4e2d\u53bb\uff0c\u8fd9\u6837\u5c31\u5b8c\u6210\u4e86\u4e00\u6574\u4e2a\u7684\u521b\u5efa\u6d41\u7a0b\u3002</p>"},{"location":"kubernetes_basic/yaml/#_1","title":"\u7b2c\u4e00\u4e2a\u5bb9\u5668\u5316\u5e94\u7528","text":"<p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u901a\u8fc7 YAML \u6587\u4ef6\u7f16\u5199\u4e86\u4e00\u4e2a\u5982\u4e0b\u7684\u8d44\u6e90\u6e05\u5355\uff0c\u547d\u540d\u4e3a nginx-deployment.yaml\uff1a</p> <pre><code>apiVersion: apps/v1  # API\u7248\u672c\nkind: Deployment  # API\u5bf9\u8c61\u7c7b\u578b\nmetadata:\n  name: nginx-deploy\n  labels:\n    chapter: first-app\nspec:\n  selector:\n    matchLabels:\n      app: nginx\n  replicas: 2  # Pod \u526f\u672c\u6570\u91cf\n  template:  # Pod \u6a21\u677f\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:9\n        ports:\n        - containerPort: 80\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u7528 kubectl \u547d\u4ee4\u6765\u521b\u5efa\u8fd9\u4e2a\u5e94\u7528\uff1a</p> <pre><code>$ kubectl create -f nginx-deployment.yaml\ndeployment.apps/nginx-deploy created\n$ kubectl get pods\nNAME                            READY   STATUS    RESTARTS   AGE\nnginx-deploy-54f57cf6bf-2fdjz   1/1     Running   0          7s\nnginx-deploy-54f57cf6bf-57287   1/1     Running   0          7s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4f1a\u5728\u96c6\u7fa4\u4e2d\u751f\u6210\u4e24\u4e2a Pod \u51fa\u6765\u3002\u800c\u6574\u4e2a\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5bf9\u5e94\u5230 Kubernetes \u4e2d\u5c31\u662f\u4e00\u4e2a API Object\uff08API \u5bf9\u8c61\uff09\uff0c\u6211\u4eec\u6309\u7167\u8fd9\u4e9b\u5bf9\u8c61\u7684\u8981\u6c42\u586b\u5145\u4e0a\u5bf9\u5e94\u7684\u5c5e\u6027\u540e\uff0c\u63d0\u4ea4\u7ed9 Kubernetes \u96c6\u7fa4\uff0c\u5c31\u53ef\u4ee5\u4e3a\u6211\u4eec\u521b\u5efa\u51fa\u5bf9\u5e94\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u5b9a\u4e49\u7684\u662f\u4e00\u4e2a Deployment \u7c7b\u578b\u7684 API \u5bf9\u8c61\uff0c\u6211\u4eec\u6309\u7167\u8fd9\u4e2a API \u5bf9\u8c61\u7684\u8981\u6c42\u586b\u5145\u4e86\u4e00\u4e9b\u5c5e\u6027\uff0c\u5c31\u4f1a\u4e3a\u6211\u4eec\u521b\u5efa\u51fa\u5bf9\u5e94\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u83b7\u53d6\uff1a</p> <pre><code>$ kubectl get deployment\nNAME           READY   UP-TO-DATE   AVAILABLE   AGE\nnginx-deploy   2/2     2            2           12m\n</code></pre> <p>Deployment \u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u5c31\u662f\u7528\u6765\u5b9a\u4e49\u591a\u526f\u672c\u5e94\u7528\u7684\u5bf9\u8c61\uff0c\u800c\u4e14\u8fd8\u652f\u6301\u5bf9\u6bcf\u4e2a\u526f\u672c\u8fdb\u884c\u6eda\u52a8\u66f4\u65b0\uff0c\u4e0a\u9762\u6211\u4eec\u7684\u8d44\u6e90\u6e05\u5355\u4e2d\u7684\u63cf\u8ff0\u4e2d\u6709\u4e00\u4e2a\u5c5e\u6027 <code>replicas: 2</code>\uff0c\u6240\u4ee5\u6700\u540e\u751f\u6210\u4e24\u4e2a\u526f\u672c\u7684 Pod\u3002</p> <p>\u800c\u8fd9\u4e2a Deployment \u5b9a\u4e49\u7684\u526f\u672c Pod \u5177\u4f53\u662f\u4ec0\u4e48\u6837\u7684\uff0c\u662f\u901a\u8fc7\u4e0b\u9762\u7684 Pod \u6a21\u677f\u6765\u5b9a\u4e49\u7684\uff0c\u5c31\u662f template \u4e0b\u9762\u7684\u5b9a\u4e49\uff0c\u8fd9\u4e2a\u6a21\u677f\u4e2d\u5b9a\u4e49\u4e86\u6211\u4eec\u7684 Pod \u4e2d\u53ea\u6709\u4e00\u4e2a\u540d\u4e3a nginx \u7684\u5bb9\u5668\uff0c\u5bb9\u5668\u4f7f\u7528\u7684\u955c\u50cf\u662f <code>nginx:1.7.9</code>\uff08spec.containers[0].image\uff09\uff0c\u5e76\u4e14\u8fd9\u4e2a\u5bb9\u5668\u76d1\u542c\u7684\u7aef\u53e3\u662f 80\uff08spec.containers[0].ports[0].containerPort\uff09\uff0c\u53e6\u5916\u6211\u4eec\u8fd8\u4e3a Pod \u6dfb\u52a0\u4e86\u4e00\u4e2a<code>app: nginx</code>\u8fd9\u6837\u7684 Label \u6807\u7b7e\uff0c\u8fd9\u91cc\u9700\u8981\u975e\u5e38\u6ce8\u610f\u7684\u662f\u4e0a\u9762\u7684 <code>selector.matchLabels</code> \u533a\u57df\u5c31\u662f\u6765\u8868\u793a\u6211\u4eec\u7684 Deployment \u6765\u7ba1\u7406\u54ea\u4e9b Pod \u7684\uff0c\u6240\u4ee5\u8fd9\u4e2a\u5730\u65b9\u9700\u8981\u548c Pod \u6a21\u677f\u4e2d\u7684 Label \u6807\u7b7e\u4fdd\u6301\u4e00\u81f4\uff0c\u8fd9\u4e2a Label \u6807\u7b7e\u4e4b\u524d\u6211\u4eec\u4e5f\u63d0\u5230\u8fc7\u662f\u975e\u5e38\u91cd\u8981\u7684\u3002</p> <p>\u53e6\u5916\u6211\u4eec\u4e5f\u53ef\u4ee5\u53d1\u73b0\u6bcf\u4e2a API \u5bf9\u8c61\u90fd\u6709\u4e00\u4e2a <code>Metadata</code> \u7684\u5b57\u6bb5\uff0c\u7528\u6765\u8868\u793a\u8be5\u5bf9\u8c61\u7684\u5143\u6570\u636e\u7684\uff0c\u6bd4\u5982\u5b9a\u4e49 name\u3001namespace \u7b49\uff0c\u6bd4\u5982\u4e0a\u9762 Deployment \u548c Pod \u6a21\u677f\u4e2d\u90fd\u6709\u8fd9\u4e2a\u5b57\u6bb5\uff0c\u81f3\u4e8e\u4e3a\u4ec0\u4e48 Pod \u6a21\u677f\u4e2d\u6ca1\u6709 name \u8fd9\u4e2a\u5143\u4fe1\u606f\u5462\uff0c\u8fd9\u662f\u56e0\u4e3a Deployment \u8fd9\u4e2a\u63a7\u5236\u5668\u4f1a\u81ea\u52a8\u5728\u4ed6\u81ea\u5df1\u7684 name \u57fa\u7840\u4e0a\u751f\u6210 Pod \u540d\uff0c\u4e0d\u8fc7 Deployment \u4e0b\u9762\u5b9a\u4e49\u7684 Label \u6807\u7b7e\u5c31\u6ca1\u6709 Pod \u4e2d\u5b9a\u4e49\u7684 Label \u6807\u7b7e\u90a3\u4e48\u91cd\u8981\u4e86\uff0c\u53ea\u662f\u8d77\u5230\u4e00\u4e2a\u5bf9\u8be5\u5bf9\u8c61\u6807\u8bc6\u548c\u8fc7\u6ee4\u7684\u4f5c\u7528\u3002\u6bd4\u5982\u6211\u4eec\u5728\u67e5\u8be2\u5bf9\u8c61\u7684\u65f6\u5019\u53ef\u4ee5\u5e26\u4e0a\u6807\u7b7e\u6765\u8fdb\u884c\u8fc7\u6ee4\uff1a</p> <pre><code>$ kubectl get deployment -l chapter=first-app\nNAME           READY   UP-TO-DATE   AVAILABLE   AGE\nnginx-deploy   2/2     2            2           51m\n$ kubectl get pods -l app=nginx\nNAME                            READY   STATUS    RESTARTS   AGE\nnginx-deploy-54f57cf6bf-2fdjz   1/1     Running   0          51m\nnginx-deploy-54f57cf6bf-57287   1/1     Running   0          51m\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u6211\u4eec\u7684\u7b2c\u4e00\u4e2a\u5e94\u7528\u7684\u5bb9\u5668\u5316\u90e8\u7f72\uff0c\u4f46\u662f\u5f80\u5f80\u6211\u4eec\u5728\u90e8\u7f72\u5e94\u7528\u7684\u8fc7\u7a0b\u4e2d\u6216\u591a\u6216\u5c11\u4f1a\u9047\u5230\u4e00\u4e9b\u95ee\u9898\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a <code>kubectl describe</code> \u547d\u4ee4\u6765\u67e5\u770b\u8d44\u6e90\u5bf9\u8c61\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u6bd4\u5982\u6211\u4eec\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u67e5\u770b Pod \u7684\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe pod nginx-deploy-54f57cf6bf-2fdjz\nName:         nginx-deploy-54f57cf6bf-2fdjz\nNamespace:    default\nPriority:     0\nNode:         ydzs-node2/123\nStart Time:   Sat, 09 Nov 2019 15:20:32 +0800\nLabels:       app=nginx\n              pod-template-hash=54f57cf6bf\nAnnotations:  &lt;none&gt;\nStatus:       Running\nIP:           2199\nIPs:\n  IP:           2199\nControlled By:  ReplicaSet/nginx-deploy-54f57cf6bf\nContainers:\n  nginx:\n    Container ID:   docker://e40e78eee7a431b6e7277b414967cce936ac750e2a8ba30298302cdd89e54300\n    Image:          nginx:9\n    Image ID:       docker-pullable://nginx@sha256:e3456c851a152494c3e4ff5fcc26f240206abac0c9d794affb40e0714846c451\n    Port:           80/TCP\n    Host Port:      0/TCP\n    State:          Running\n      Started:      Sat, 09 Nov 2019 15:20:35 +0800\n    Ready:          True\n    Restart Count:  0\n    Environment:    &lt;none&gt;\n    Mounts:\n      /var/run/secrets/kubernetes.io/serviceaccount from default-token-5tsh4 (ro)\nConditions:\n  Type              Status\n  Initialized       True\n  Ready             True\n  ContainersReady   True\n  PodScheduled      True\nVolumes:\n  default-token-5tsh4:\n    Type:        Secret (a volume populated by a Secret)\n    SecretName:  default-token-5tsh4\n    Optional:    false\nQoS Class:       BestEffort\nNode-Selectors:  &lt;none&gt;\nTolerations:     node.kubernetes.io/not-ready:NoExecute for 300s\n                 node.kubernetes.io/unreachable:NoExecute for 300s\nEvents:\n  Type    Reason     Age        From                 Message\n  ----    ------     ----       ----                 -------\n  Normal  Scheduled  &lt;unknown&gt;  default-scheduler    Successfully assigned default/nginx-deploy-54f57cf6bf-2fdjz to ydzs-node2\n  Normal  Pulled     52m        kubelet, ydzs-node2  Container image \"nginx:9\" already present on machine\n  Normal  Created    52m        kubelet, ydzs-node2  Created container nginx\n  Normal  Started    52m        kubelet, ydzs-node2  Started container nginx\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u770b\u5230\u5f88\u591a\u8fd9\u4e2a Pod \u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u6bd4\u5982\u8c03\u5ea6\u5230\u7684\u8282\u70b9\u3001\u72b6\u6001\u3001IP \u7b49\uff0c\u4e00\u822c\u6211\u4eec\u6bd4\u8f83\u5173\u5fc3\u7684\u662f\u4e0b\u9762\u7684 <code>Events</code> \u90e8\u5206\uff0c\u5c31\u662f\u6211\u4eec\u8bf4\u7684<code>\u4e8b\u4ef6</code>\u3002</p> <p>\u5728 Kubernetes \u521b\u5efa\u8d44\u6e90\u5bf9\u8c61\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5bf9\u8be5\u5bf9\u8c61\u7684\u4e00\u4e9b\u91cd\u8981\u64cd\u4f5c\uff0c\u90fd\u4f1a\u88ab\u8bb0\u5f55\u5728\u8fd9\u4e2a\u5bf9\u8c61\u7684 <code>Events</code> \u91cc\u9762\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>kubectl describe</code> \u6307\u4ee4\u67e5\u770b\u5bf9\u5e94\u7684\u7ed3\u679c\u3002\u6240\u4ee5\u8fd9\u4e2a\u6307\u4ee4\u4e5f\u4f1a\u662f\u4ee5\u540e\u6211\u4eec\u6392\u9519\u8fc7\u7a0b\u4e2d\u4f1a\u7ecf\u5e38\u4f7f\u7528\u7684\u547d\u4ee4\uff0c\u4e00\u5b9a\u8981\u8bb0\u4f4f\u8fd9\u4e2a\u91cd\u8981\u7684\u547d\u4ee4\u3002\u6bd4\u5982\u4e0a\u9762\u6211\u4eec\u63cf\u8ff0\u7684\u8fd9\u4e2a Pod\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5b83\u88ab\u521b\u5efa\u4e4b\u540e\uff0c\u88ab\u8c03\u5ea6\u5668\u8c03\u5ea6\uff08Successfully assigned\uff09\u5230\u4e86 ydzs-node2 \u8282\u70b9\u4e0a\uff0c\u7136\u540e\u6307\u5b9a\u7684\u955c\u50cf\u5df2\u7ecf\u5728\u8be5\u8282\u70b9\u4e0a\u5b58\u5728\u4e86\uff0c\u6240\u4ee5\u6ca1\u6709\u518d\u53bb\u62c9\u53d6\u955c\u50cf\uff0c\u7136\u540e\u521b\u5efa\u6211\u4eec\u5b9a\u4e49\u7684 nginx \u5bb9\u5668\uff0c\u6700\u540e\u542f\u52a8\u5b9a\u4e49\u7684\u5bb9\u5668\u3002</p> <p>\u53e6\u5916\u4e00\u4e2a\u65b9\u9762\u5982\u679c\u6211\u4eec\u76f8\u5bf9\u6211\u4eec\u7684\u5e94\u7528\u8fdb\u884c\u5347\u7ea7\u7684\u8bdd\u5e94\u8be5\u600e\u4e48\u529e\u5462\uff1f\u8fd9\u4e2a\u64cd\u4f5c\u5728\u6211\u4eec\u65e5\u5e38\u5de5\u4f5c\u4e2d\u8fd8\u662f\u975e\u5e38\u5e38\u89c1\u7684\uff0c\u800c\u5728 Kubernetes \u8fd9\u91cc\u4e5f\u662f\u975e\u5e38\u7b80\u5355\u7684\uff0c\u6211\u4eec\u53ea\u9700\u8981\u4fee\u6539\u6211\u4eec\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5373\u53ef\uff0c\u6bd4\u5982\u6211\u4eec\u628a\u955c\u50cf\u5347\u7ea7\u5230\u6700\u65b0\u7248\u672c<code>nginx:latest</code>\uff1a</p> <pre><code>...    \n    spec:\n      containers:\n      - name: nginx\n        image: nginx:latest  # \u8fd9\u91cc\u88ab\u4ece 9 \u4fee\u6539\u4e3alatest\n        ports:\n      - containerPort: 80\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7<code>kubectl apply</code>\u547d\u4ee4\u6765\u76f4\u63a5\u66f4\u65b0\uff0c\u8fd9\u4e2a\u547d\u4ee4\u4e5f\u662f\u63a8\u8350\u6211\u4eec\u4f7f\u7528\u7684\uff0c\u6211\u4eec\u4e0d\u5fc5\u5173\u5fc3\u5f53\u524d\u7684\u64cd\u4f5c\u662f\u521b\u5efa\uff0c\u8fd8\u662f\u66f4\u65b0\uff0c\u6267\u884c\u7684\u547d\u4ee4\u59cb\u7ec8\u662f <code>kubectl apply</code>\uff0cKubernetes \u5219\u4f1a\u6839\u636e YAML \u6587\u4ef6\u7684\u5185\u5bb9\u53d8\u5316\uff0c\u81ea\u52a8\u8fdb\u884c\u5177\u4f53\u7684\u5904\u7406\uff0c\u6240\u4ee5\u65e0\u8bba\u662f\u521b\u5efa\u8fd8\u662f\u66f4\u65b0\u90fd\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl apply -f nginx-deployment.yaml\n</code></pre> <p>\u901a\u8fc7\u8fd9\u4e2a\u547d\u4ee4\u5c31\u53ef\u4ee5\u6765\u66f4\u65b0\u6211\u4eec\u7684\u5e94\u7528\u4e86\uff0c\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u662f\u4e00\u4e2a Deployment \u7684\u63a7\u5236\u5668\uff0c\u6240\u4ee5\u4f1a\u6eda\u52a8\u66f4\u65b0\u6211\u4eec\u7684\u5e94\u7528\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5728\u547d\u4ee4\u540e\u9762\u52a0\u4e0a <code>--watch</code> \u53c2\u6570\u6765\u67e5\u770b Pod \u7684\u66f4\u65b0\u8fc7\u7a0b\uff1a</p> <pre><code>$ kubectl get pods -l app=nginx --watch\nNAME                            READY   STATUS              RESTARTS   AGE\nnginx-deploy-54f57cf6bf-2fdjz   1/1     Terminating         0          72m\nnginx-deploy-54f57cf6bf-57287   1/1     Running             0          72m\nnginx-deploy-786b576769-69lrl   1/1     Running             0          4s\nnginx-deploy-786b576769-wwmvz   0/1     ContainerCreating   0          2s\nnginx-deploy-54f57cf6bf-2fdjz   0/1     Terminating         0          72m\nnginx-deploy-786b576769-wwmvz   1/1     Running             0          3s\nnginx-deploy-54f57cf6bf-57287   1/1     Terminating         0          72m\nnginx-deploy-54f57cf6bf-57287   0/1     Terminating         0          72m\nnginx-deploy-54f57cf6bf-57287   0/1     Terminating         0          72m\nnginx-deploy-54f57cf6bf-57287   0/1     Terminating         0          72m\nnginx-deploy-54f57cf6bf-2fdjz   0/1     Terminating         0          72m\nnginx-deploy-54f57cf6bf-2fdjz   0/1     Terminating         0          72m\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u66f4\u65b0\u8fc7\u7a0b\u662f\u5148\u6740\u6389\u4e86\u4e00\u4e2a Pod\uff0c\u7136\u540e\u53c8\u91cd\u65b0\u521b\u5efa\u4e86\u4e00\u4e2a\u65b0\u7684 Pod\uff0c\u7136\u540e\u53c8\u6740\u6389\u4e00\u4e2a\u65e7\u7684 Pod\uff0c\u518d\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Pod\uff0c\u8fd9\u6837\u4ea4\u66ff\u66ff\u6362\u7684\uff0c\u6700\u540e\u5269\u4e0b\u4e24\u4e2a\u65b0\u7684 Pod\uff0c\u8fd9\u5c31\u662f\u6211\u4eec\u6240\u8bf4\u7684\u6eda\u52a8\u66f4\u65b0\uff0c\u6eda\u52a8\u66f4\u65b0\u5bf9\u4e8e\u6211\u4eec\u7684\u5e94\u7528\u6301\u7eed\u63d0\u4f9b\u670d\u52a1\u662f\u975e\u5e38\u91cd\u8981\u7684\u624b\u6bb5\uff0c\u5728\u65e5\u5e38\u5de5\u4f5c\u4e2d\u66f4\u65b0\u5e94\u7528\u80af\u5b9a\u4f1a\u91c7\u7528\u8fd9\u79cd\u65b9\u5f0f\u3002</p> <p>\u6700\u540e\uff0c\u5982\u679c\u9700\u8981\u628a\u6211\u4eec\u7684\u5e94\u7528\u4ece\u96c6\u7fa4\u4e2d\u5220\u9664\u6389\uff0c\u53ef\u4ee5\u7528 <code>kubectl delete</code> \u547d\u4ee4\u6765\u6e05\u7406\uff1a</p> <pre><code>$ kubectl delete -f nginx-deployment.yaml\n</code></pre>"},{"location":"kubernetes_basic/yaml/#yaml_1","title":"YAML \u6587\u4ef6","text":"<p>\u4e0a\u9762\u6211\u4eec\u5728 Kubernetes \u4e2d\u90e8\u7f72\u4e86\u6211\u4eec\u7684\u7b2c\u4e00\u4e2a\u5bb9\u5668\u5316\u5e94\u7528\uff0c\u6211\u4eec\u4e86\u89e3\u5230\u8981\u90e8\u7f72\u5e94\u7528\u6700\u91cd\u8981\u7684\u5c31\u662f\u7f16\u5199\u5e94\u7528\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u3002\u90a3\u4e48\u5982\u4f55\u7f16\u5199\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5462\uff1f\u65e5\u5e38\u4f7f\u7528\u7684\u65f6\u5019\u6211\u4eec\u90fd\u662f\u4f7f\u7528 YAML \u6587\u4ef6\u6765\u7f16\u5199\uff0c\u4f46\u662f\u73b0\u72b6\u5374\u662f\u5927\u90e8\u5206\u540c\u5b66\u5bf9 JSON \u66f4\u52a0\u719f\u6089\uff0c\u5bf9 YAML \u6587\u4ef6\u7684\u683c\u5f0f\u4e0d\u662f\u5f88\u719f\u6089\uff0c\u6240\u4ee5\u4e5f\u5bfc\u81f4\u5f88\u591a\u540c\u5b66\u5728\u7f16\u5199\u8d44\u6e90\u6e05\u5355\u7684\u65f6\u5019\u4f3c\u61c2\u975e\u61c2\u7684\u611f\u89c9\uff0c\u6240\u4ee5\u5728\u4e86\u89e3\u5982\u4f55\u7f16\u5199\u8d44\u6e90\u6e05\u5355\u4e4b\u524d\u6211\u4eec\u975e\u5e38\u6709\u5fc5\u8981\u6765\u4e86\u89e3\u4e0b YAML \u6587\u4ef6\u7684\u7528\u6cd5\u3002</p> <p><code>YAML</code> \u662f\u4e13\u95e8\u7528\u6765\u5199\u914d\u7f6e\u6587\u4ef6\u7684\u8bed\u8a00\uff0c\u975e\u5e38\u7b80\u6d01\u548c\u5f3a\u5927\uff0c\u8fdc\u6bd4 <code>JSON</code> \u683c\u5f0f\u65b9\u4fbf\u3002<code>YAML</code>\u8bed\u8a00\uff08\u53d1\u97f3 /\u02c8j\u00e6m\u0259l/\uff09\u7684\u8bbe\u8ba1\u76ee\u6807\uff0c\u5c31\u662f\u65b9\u4fbf\u4eba\u7c7b\u8bfb\u5199\u3002\u5b83\u5b9e\u8d28\u4e0a\u662f\u4e00\u79cd\u901a\u7528\u7684\u6570\u636e\u4e32\u884c\u5316\u683c\u5f0f\u3002</p> <p>\u5b83\u7684\u57fa\u672c\u8bed\u6cd5\u89c4\u5219\u5982\u4e0b\uff1a</p> <ul> <li>\u5927\u5c0f\u5199\u654f\u611f</li> <li>\u4f7f\u7528\u7f29\u8fdb\u8868\u793a\u5c42\u7ea7\u5173\u7cfb</li> <li>\u7f29\u8fdb\u65f6\u4e0d\u5141\u8bb8\u4f7f\u7528<code>Tab</code>\u952e\uff0c\u53ea\u5141\u8bb8\u4f7f\u7528\u7a7a\u683c</li> <li>\u7f29\u8fdb\u7684\u7a7a\u683c\u6570\u76ee\u4e0d\u91cd\u8981\uff0c\u53ea\u8981\u76f8\u540c\u5c42\u7ea7\u7684\u5143\u7d20\u5de6\u4fa7\u5bf9\u9f50\u5373\u53ef</li> <li><code>#</code> \u8868\u793a\u6ce8\u91ca\uff0c\u4ece\u8fd9\u4e2a\u5b57\u7b26\u4e00\u76f4\u5230\u884c\u5c3e\uff0c\u90fd\u4f1a\u88ab\u89e3\u6790\u5668\u5ffd\u7565</li> </ul> <p>\u5728 Kubernetes \u4e2d\uff0c\u6211\u4eec\u53ea\u9700\u8981\u4e86\u89e3\u4e24\u79cd\u7ed3\u6784\u7c7b\u578b\u5c31\u884c\u4e86\uff1a</p> <ul> <li>Lists\uff08\u5217\u8868\uff09</li> <li>Maps\uff08\u5b57\u5178\uff09</li> </ul> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u4f60\u53ef\u80fd\u4f1a\u9047\u5230 Lists \u7684 Maps \u548c Maps \u7684 Lists\uff0c\u7b49\u7b49\u3002\u4e0d\u8fc7\u4e0d\u7528\u62c5\u5fc3\uff0c\u4f60\u53ea\u8981\u638c\u63e1\u4e86\u8fd9\u4e24\u79cd\u7ed3\u6784\u4e5f\u5c31\u53ef\u4ee5\u4e86\uff0c\u5176\u4ed6\u66f4\u52a0\u590d\u6742\u7684\u6211\u4eec\u6682\u4e0d\u8ba8\u8bba\u3002</p>"},{"location":"kubernetes_basic/yaml/#maps","title":"Maps","text":"<p>\u9996\u5148\u6211\u4eec\u6765\u770b\u770b <code>Maps</code>\uff0c\u6211\u4eec\u90fd\u77e5\u9053 <code>Map</code> \u662f\u5b57\u5178\uff0c\u5c31\u662f\u4e00\u4e2a <code>key:value</code> \u7684\u952e\u503c\u5bf9\uff0c<code>Maps</code> \u53ef\u4ee5\u8ba9\u6211\u4eec\u66f4\u52a0\u65b9\u4fbf\u7684\u53bb\u4e66\u5199\u914d\u7f6e\u4fe1\u606f\uff0c\u4f8b\u5982\uff1a</p> <pre><code>---\napiVersion: v1\nkind: Pod\n</code></pre> <p>\u7b2c\u4e00\u884c\u7684<code>---</code>\u662f\u5206\u9694\u7b26\uff0c\u662f\u53ef\u9009\u7684\uff0c\u5728\u5355\u4e00\u6587\u4ef6\u4e2d\uff0c\u53ef\u7528\u8fde\u7eed\u4e09\u4e2a\u8fde\u5b57\u53f7<code>---</code>\u533a\u5206\u591a\u4e2a\u6587\u4ef6\u3002\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u6211\u4eec\u6709\u4e24\u4e2a\u952e\uff1akind \u548c apiVersion\uff0c\u4ed6\u4eec\u5bf9\u5e94\u7684\u503c\u5206\u522b\u662f\uff1av1 \u548c Pod\u3002\u4e0a\u9762\u7684 YAML \u6587\u4ef6\u8f6c\u6362\u6210 JSON \u683c\u5f0f\u7684\u8bdd\uff0c\u4f60\u80af\u5b9a\u5c31\u5bb9\u6613\u660e\u767d\u4e86\uff1a</p> <pre><code>{\n    \"apiVersion\": \"v1\",\n    \"kind\": \"pod\"\n}\n</code></pre> <p>\u6211\u4eec\u5728\u521b\u5efa\u4e00\u4e2a\u76f8\u5bf9\u590d\u6742\u4e00\u70b9\u7684 YAML \u6587\u4ef6\uff0c\u521b\u5efa\u4e00\u4e2a KEY \u5bf9\u5e94\u7684\u503c\u4e0d\u662f\u5b57\u7b26\u4e32\u800c\u662f\u4e00\u4e2a Maps\uff1a</p> <pre><code>---\napiVersion: v1\nkind: Pod\nmetadata:\n  name: ydzs-site\n  labels:\n    app: web\n</code></pre> <p>\u4e0a\u9762\u7684 YAML \u6587\u4ef6\uff0cmetadata \u8fd9\u4e2a KEY \u5bf9\u5e94\u7684\u503c\u5c31\u662f\u4e00\u4e2a <code>Maps</code> \u4e86\uff0c\u800c\u4e14\u5d4c\u5957\u7684 labels \u8fd9\u4e2a KEY \u7684\u503c\u53c8\u662f\u4e00\u4e2a Map\uff0c\u4f60\u53ef\u4ee5\u6839\u636e\u4f60\u81ea\u5df1\u7684\u60c5\u51b5\u8fdb\u884c\u591a\u5c42\u5d4c\u5957\u3002</p> <p>\u4e0a\u9762\u6211\u4eec\u4e5f\u63d0\u5230\u4e86 YAML \u6587\u4ef6\u7684\u8bed\u6cd5\u89c4\u5219\uff0cYAML \u5904\u7406\u5668\u662f\u6839\u636e\u884c\u7f29\u8fdb\u6765\u77e5\u9053\u5185\u5bb9\u4e4b\u95f4\u7684\u55ef\u5173\u8054\u6027\u7684\u3002\u6bd4\u5982\u6211\u4eec\u4e0a\u9762\u7684 YAML \u6587\u4ef6\uff0c<code>\u6211\u7528\u4e86\u4e24\u4e2a\u7a7a\u683c\u4f5c\u4e3a\u7f29\u8fdb\uff0c\u7a7a\u683c\u7684\u6570\u91cf\u5e76\u4e0d\u91cd\u8981\uff0c\u4f46\u662f\u4f60\u5f97\u4fdd\u6301\u4e00\u81f4\uff0c\u5e76\u4e14\u81f3\u5c11\u8981\u6c42\u4e00\u4e2a\u7a7a\u683c</code>\uff08\u4ec0\u4e48\u610f\u601d\uff1f\u5c31\u662f\u4f60\u522b\u4e00\u4f1a\u7f29\u8fdb\u4e24\u4e2a\u7a7a\u683c\uff0c\u4e00\u4f1a\u7f29\u8fdb4\u4e2a\u7a7a\u683c\uff09\u3002\u6211\u4eec\u53ef\u4ee5\u770b\u5230 name \u548c labels \u662f\u76f8\u540c\u7ea7\u522b\u7684\u7f29\u8fdb\uff0c\u6240\u4ee5 YAML \u5904\u7406\u5668\u5c31\u77e5\u9053\u4e86\u4ed6\u4eec\u5c5e\u4e8e\u540c\u4e00\u4e2a Map\uff0c\u800c app \u662f labels \u7684\u503c\u662f\u56e0\u4e3a app \u7684\u7f29\u8fdb\u66f4\u5927\u3002</p> <p>\u6ce8\u610f</p> <p>\u6ce8\u610f\uff1a\u5728 YAML \u6587\u4ef6\u4e2d\u7edd\u5bf9\u4e0d\u8981\u4f7f\u7528 tab \u952e\u6765\u8fdb\u884c\u7f29\u8fdb\u3002</p> <p>\u540c\u6837\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u4e0a\u9762\u7684 YAML \u6587\u4ef6\u8f6c\u6362\u6210 JSON \u6587\u4ef6\uff1a</p> <pre><code>{\n    \"apiVersion\": \"v1\",\n    \"kind\": \"Pod\",\n    \"metadata\": {\n        \"name\": \"kube100-site\",\n        \"labels\": {\n            \"app\": \"web\"\n        }\n    }\n}\n</code></pre> <p>\u6216\u8bb8\u4f60\u5bf9\u4e0a\u9762\u7684 JSON \u6587\u4ef6\u66f4\u719f\u6089\uff0c\u4f46\u662f\u4f60\u4e0d\u5f97\u4e0d\u627f\u8ba4 YAML \u6587\u4ef6\u7684\u8bed\u4e49\u5316\u7a0b\u5ea6\u66f4\u9ad8\u5427\uff1f</p>"},{"location":"kubernetes_basic/yaml/#lists","title":"Lists","text":"<p><code>Lists</code>\u5c31\u662f\u5217\u8868\uff0c\u8bf4\u767d\u4e86\u5c31\u662f\u6570\u7ec4\uff0c\u5728 YAML \u6587\u4ef6\u4e2d\u6211\u4eec\u53ef\u4ee5\u8fd9\u6837\u5b9a\u4e49\uff1a</p> <pre><code>args\n  - Cat\n  - Dog\n  - Fish\n</code></pre> <p>\u4f60\u53ef\u4ee5\u6709\u4efb\u4f55\u6570\u91cf\u7684\u9879\u5728\u5217\u8868\u4e2d\uff0c\u6bcf\u4e2a\u9879\u7684\u5b9a\u4e49\u4ee5\u7834\u6298\u53f7\uff08<code>-</code>\uff09\u5f00\u5934\u7684\uff0c\u4e0e\u7236\u5143\u7d20\u4e4b\u95f4\u53ef\u4ee5\u7f29\u8fdb\u4e5f\u53ef\u4ee5\u4e0d\u7f29\u8fdb\u3002\u5bf9\u5e94\u7684 JSON \u683c\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>{\n    \"args\": [ 'Cat', 'Dog', 'Fish' ]\n}\n</code></pre> <p>\u5f53\u7136\uff0cLists \u7684\u5b50\u9879\u4e5f\u53ef\u4ee5\u662f Maps\uff0cMaps \u7684\u5b50\u9879\u4e5f\u53ef\u4ee5\u662f Lists \u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>---\napiVersion: v1\nkind: Pod\nmetadata:\n  name: ydzs-site\n  labels:\n    app: web\nspec:\n  containers:\n    - name: front-end\n      image: nginx\n      ports:\n        - containerPort: 80\n    - name: flaskapp-demo\n      image: cnych/flaskapp\n      ports:\n        - containerPort: 5000\n</code></pre> <p>\u6bd4\u5982\u8fd9\u4e2a YAML \u6587\u4ef6\uff0c\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a\u53eb containers \u7684 List \u5bf9\u8c61\uff0c\u6bcf\u4e2a\u5b50\u9879\u90fd\u7531 name\u3001image\u3001ports \u7ec4\u6210\uff0c\u6bcf\u4e2a ports \u90fd\u6709\u4e00\u4e2a key \u4e3a containerPort \u7684 Map \u7ec4\u6210\uff0c\u540c\u6837\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u8f6c\u6210\u5982\u4e0b JSON \u683c\u5f0f\u6587\u4ef6\uff1a</p> <pre><code>{\n    \"apiVersion\": \"v1\",\n    \"kind\": \"Pod\",\n    \"metadata\": {\n        \"name\": \"ydzs-site\",\n        \"labels\": {\n            \"app\": \"web\"\n        }\n    },\n    \"spec\": {\n        \"containers\": [{\n            \"name\": \"front-end\",\n            \"image\": \"nginx\",\n            \"ports\": [{\n                \"containerPort\": \"80\"\n            }]\n        }, {\n            \"name\": \"flaskapp-demo\",\n            \"image\": \"cnych/flaskapp\",\n            \"ports\": [{\n                \"containerPort\": \"5000\"\n            }]\n        }]\n    }\n}\n</code></pre> <p>\u662f\u4e0d\u662f\u89c9\u5f97\u7528 JSON \u683c\u5f0f\u7684\u8bdd\u6587\u4ef6\u660e\u663e\u6bd4 YAML \u6587\u4ef6\u66f4\u590d\u6742\u4e86\u5462\uff1f</p>"},{"location":"kubernetes_basic/yaml/#_2","title":"\u5982\u4f55\u7f16\u5199\u8d44\u6e90\u6e05\u5355","text":"<p>\u4e0a\u9762\u6211\u4eec\u4e86\u89e3\u4e86 YAML \u6587\u4ef6\u7684\u57fa\u672c\u8bed\u6cd5\uff0c\u73b0\u5728\u81f3\u5c11\u53ef\u4ee5\u4fdd\u8bc1\u6211\u4eec\u7684\u7f16\u5199\u7684 YAML \u6587\u4ef6\u8bed\u6cd5\u662f\u5408\u6cd5\u7684\uff0c\u90a3\u4e48\u8981\u600e\u4e48\u7f16\u5199\u7b26\u5408 Kubernetes API \u5bf9\u8c61\u7684\u8d44\u6e90\u6e05\u5355\u5462\uff1f\u6bd4\u5982\u6211\u4eec\u600e\u4e48\u77e5\u9053 Pod\u3001Deployment \u8fd9\u4e9b\u8d44\u6e90\u5bf9\u8c61\u6709\u54ea\u4e9b\u529f\u80fd\u3001\u6709\u54ea\u4e9b\u5b57\u6bb5\u5462\uff1f</p> <p>\u4e00\u4e9b\u7b80\u5355\u7684\u8d44\u6e90\u5bf9\u8c61\u6211\u4eec\u53ef\u80fd\u53ef\u4ee5\u51ed\u501f\u8bb0\u5fc6\u5199\u51fa\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\uff0c\u4f46\u662f Kubernetes \u53d1\u5c55\u4e5f\u975e\u5e38\u5feb\uff0c\u7248\u672c\u8fed\u4ee3\u4e5f\u5f88\u5feb\uff0c\u6bcf\u4e2a\u7248\u672c\u4e2d\u8d44\u6e90\u5bf9\u8c61\u53ef\u80fd\u53c8\u6709\u5f88\u591a\u53d8\u5316\uff0c\u90a3\u4e48\u6709\u6ca1\u6709\u4e00\u79cd\u529e\u6cd5\u53ef\u4ee5\u8ba9\u6211\u4eec\u505a\u5230\u6709\u7684\u653e\u77e2\u5462\uff1f</p> <p>\u5b9e\u9645\u4e0a\u662f\u6709\u7684\uff0c\u6700\u7b80\u5355\u7684\u65b9\u6cd5\u5c31\u662f\u67e5\u627e Kubernetes API \u6587\u6863\uff0c\u6bd4\u5982\u6211\u4eec\u73b0\u5728\u4f7f\u7528\u7684\u662f v1.16.2 \u7248\u672c\u7684\u96c6\u7fa4\uff0c\u53ef\u4ee5\u901a\u8fc7\u5730\u5740 https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.16/ \u67e5\u627e\u5230\u5bf9\u5e94\u7684 API \u6587\u6863\uff0c\u5728\u8fd9\u4e2a\u6587\u6863\u4e2d\u6211\u4eec\u53ef\u4ee5\u627e\u5230\u6240\u6709\u8d44\u6e90\u5bf9\u8c61\u7684\u4e00\u4e9b\u5b57\u6bb5\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u8981\u4e86\u89e3\u521b\u5efa\u4e00\u4e2a Deployment \u8d44\u6e90\u5bf9\u8c61\u9700\u8981\u54ea\u4e9b\u5b57\u6bb5\uff0c\u6211\u4eec\u53ef\u4ee5\u6253\u5f00\u4e0a\u9762\u7684 API \u6587\u6863\u9875\u9762\uff0c\u5728\u5de6\u4fa7\u4fa7\u8fb9\u680f\u627e\u5230 <code>Deployment v1 apps</code>\uff0c\u70b9\u51fb\u4e0b\u9762\u7684 <code>Write Operations</code>\uff0c\u7136\u540e\u70b9\u51fb <code>Create</code>\uff0c\u7136\u540e\u6211\u4eec\u67e5\u627e\u5230\u521b\u5efa Deployment \u9700\u8981\u63d0\u4ea4\u7684 Body \u53c2\u6570</p> <p></p> <p>\u7136\u540e\u70b9\u51fb Body\uff0c\u8fdb\u5165\u5230\u53c2\u6570\u8be6\u60c5\u9875\uff1a</p> <p></p> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u521b\u5efa Deployment \u9700\u8981\u7684\u4e00\u4e9b\u5b57\u6bb5\u4e86\uff0c\u6bd4\u5982 apiVersion\u3001kind\u3001metadata\u3001spec \u7b49\uff0c\u800c\u4e14\u6bcf\u4e2a\u5b57\u6bb5\u90fd\u6709\u5bf9\u5e94\u7684\u6587\u6863\u8bf4\u660e\uff0c\u6bd4\u5982\u6211\u4eec\u50cf\u8981\u4e86\u89e3 DeploymentSpec \u4e0b\u9762\u6709\u54ea\u4e9b\u5b57\u6bb5\uff0c\u7ee7\u7eed\u70b9\u51fb\u8fdb\u53bb\u67e5\u770b\u5c31\u884c\uff1a</p> <p></p> <p>\u6bcf\u4e2a\u5b57\u6bb5\u5177\u4f53\u4ec0\u4e48\u542b\u4e49\u4ee5\u53ca\u6bcf\u4e2a\u5b57\u6bb5\u4e0b\u9762\u662f\u5426\u8fd8\u6709\u5176\u4ed6\u5b57\u6bb5\u90fd\u53ef\u4ee5\u8fd9\u6837\u53bb\u8ffd\u6eaf\u3002</p> <p>\u4f46\u662f\u5982\u679c\u5e73\u65f6\u6211\u4eec\u7f16\u5199\u8d44\u6e90\u6e05\u5355\u7684\u65f6\u5019\u90fd\u8fd9\u6837\u53bb\u67e5\u627e\u6587\u6863\u52bf\u5fc5\u4f1a\u6548\u7387\u4f4e\u4e0b\uff0cKubernetes \u4e5f\u8003\u8651\u5230\u4e86\u8fd9\u70b9\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 kubectl \u547d\u4ee4\u884c\u5de5\u5177\u6765\u83b7\u53d6\u8fd9\u4e9b\u5b57\u6bb5\u4fe1\u606f\uff0c\u540c\u6837\u7684\uff0c\u6bd4\u5982\u6211\u4eec\u8981\u83b7\u53d6 Deployment \u7684\u5b57\u6bb5\u4fe1\u606f\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>kubectl explain</code> \u547d\u4ee4\u6765\u4e86\u89e3\uff1a</p> <pre><code>$ kubectl explain deployment\nKIND:     Deployment\nVERSION:  apps/v1\n\nDESCRIPTION:\n     Deployment enables declarative updates for Pods and ReplicaSets.\n\nFIELDS:\n   apiVersion   &lt;string&gt;\n     APIVersion defines the versioned schema of this representation of an\n     object. Servers should convert recognized schemas to the latest internal\n     value, and may reject unrecognized values. More info:\n     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources\n\n   kind &lt;string&gt;\n     Kind is a string value representing the REST resource this object\n     represents. Servers may infer this from the endpoint the client submits\n     requests to. Cannot be updated. In CamelCase. More info:\n     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds\n\n   metadata &lt;Object&gt;\n     Standard object metadata.\n\n   spec &lt;Object&gt;\n     Specification of the desired behavior of the Deployment.\n\n   status   &lt;Object&gt;\n     Most recently observed status of the Deployment.\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u7684\u4fe1\u606f\u548c\u6211\u4eec\u5728 API \u6587\u6863\u4e2d\u67e5\u770b\u5230\u7684\u57fa\u672c\u4e00\u81f4\uff0c\u6bd4\u5982\u6211\u4eec\u770b\u5230\u5176\u4e2d <code>spec</code> \u5b57\u6bb5\u662f\u4e00\u4e2a <code>&lt;Object&gt;</code> \u7c7b\u578b\u7684\uff0c\u8bc1\u660e\u8be5\u5b57\u6bb5\u4e0b\u9762\u662f\u4e00\u4e2a\u5bf9\u8c61\uff0c\u6211\u4eec\u53ef\u4ee5\u7ee7\u7eed\u53bb\u67e5\u770b\u8fd9\u4e2a\u5b57\u6bb5\u4e0b\u9762\u7684\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl explain deployment.spec\nKIND:     Deployment\nVERSION:  apps/v1\n\nRESOURCE: spec &lt;Object&gt;\n\nDESCRIPTION:\n     Specification of the desired behavior of the Deployment.\n\n     DeploymentSpec is the specification of the desired behavior of the\n     Deployment.\n\nFIELDS:\n   minReadySeconds  &lt;integer&gt;\n     Minimum number of seconds for which a newly created pod should be ready\n     without any of its container crashing, for it to be considered available.\n     Defaults to 0 (pod will be considered available as soon as it is ready)\n\n   paused   &lt;boolean&gt;\n     Indicates that the deployment is paused.\n\n   progressDeadlineSeconds  &lt;integer&gt;\n     The maximum time in seconds for a deployment to make progress before it is\n     considered to be failed. The deployment controller will continue to process\n     failed deployments and a condition with a ProgressDeadlineExceeded reason\n     will be surfaced in the deployment status. Note that progress will not be\n     estimated during the time a deployment is paused. Defaults to 600s.\n\n   replicas &lt;integer&gt;\n     Number of desired pods. This is a pointer to distinguish between explicit\n     zero and not specified. Defaults to \n\n   revisionHistoryLimit &lt;integer&gt;\n     The number of old ReplicaSets to retain to allow rollback. This is a\n     pointer to distinguish between explicit zero and not specified. Defaults to\n\n   selector &lt;Object&gt; -required-\n     Label selector for pods. Existing ReplicaSets whose pods are selected by\n     this will be the ones affected by this deployment. It must match the pod\n     template's labels.\n\n   strategy &lt;Object&gt;\n     The deployment strategy to use to replace existing pods with new ones.\n\n   template &lt;Object&gt; -required-\n     Template describes the pods that will be created.\n</code></pre> <p>\u5982\u679c\u4e00\u4e2a\u5b57\u6bb5\u663e\u793a\u7684\u662f <code>required</code>\uff0c\u8fd9\u5c31\u8bc1\u660e\u8be5\u81ea\u52a8\u662f\u5fc5\u586b\u7684\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u5728\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u7684\u65f6\u5019\u5fc5\u987b\u58f0\u660e\u8fd9\u4e2a\u5b57\u6bb5\uff0c\u6bcf\u4e2a\u5b57\u6bb5\u7684\u7c7b\u578b\u4e5f\u90fd\u5b8c\u5168\u4e3a\u6211\u4eec\u8fdb\u884c\u4e86\u8bf4\u660e\uff0c\u6240\u4ee5\u6709\u4e86 <code>kubectl explain</code> \u8fd9\u4e2a\u547d\u4ee4\u6211\u4eec\u5c31\u5b8c\u5168\u53ef\u4ee5\u5199\u51fa\u4e00\u4e2a\u4e0d\u719f\u6089\u7684\u8d44\u6e90\u5bf9\u8c61\u7684\u6e05\u5355\u8bf4\u660e\u4e86\uff0c\u8fd9\u4e2a\u547d\u4ee4\u6211\u4eec\u4e5f\u662f\u5fc5\u987b\u8981\u8bb0\u4f4f\u7684\uff0c\u4f1a\u5728\u4ee5\u540e\u7684\u5de5\u4f5c\u4e2d\u4e3a\u6211\u4eec\u63d0\u4f9b\u5f88\u5927\u7684\u5e2e\u52a9\u3002</p>"},{"location":"kubernetes_config/config_map/","title":"ConfigMap","text":"<p>\ue3c9</p>"},{"location":"kubernetes_config/config_map/#configmap","title":"ConfigMap","text":"<p>\u53ef\u53d8\u914d\u7f6e\u7ba1\u7406</p> <p>\u524d\u9762\u6211\u4eec\u5b66\u4e60\u4e86\u4e00\u4e9b\u5e38\u7528\u7684\u8d44\u6e90\u5bf9\u8c61\u7684\u4f7f\u7528\uff0c\u4f46\u662f\u5355\u7eaf\u4f9d\u9760\u8fd9\u4e9b\u8d44\u6e90\u5bf9\u8c61\uff0c\u8fd8\u4e0d\u8db3\u4ee5\u6ee1\u8db3\u6211\u4eec\u7684\u65e5\u5e38\u9700\u6c42\uff0c\u4e00\u4e2a\u91cd\u8981\u7684\u9700\u6c42\u5c31\u662f\u5e94\u7528\u7684\u914d\u7f6e\u7ba1\u7406\u3001\u654f\u611f\u4fe1\u606f\u7684\u5b58\u50a8\u548c\u4f7f\u7528\uff08\u5982\uff1a\u5bc6\u7801\u3001Token \u7b49\uff09\u3001\u5bb9\u5668\u8fd0\u884c\u8d44\u6e90\u7684\u914d\u7f6e\u3001\u5b89\u5168\u7ba1\u63a7\u3001\u8eab\u4efd\u8ba4\u8bc1\u7b49\u7b49\u3002</p> <p>\u5bf9\u4e8e\u5e94\u7528\u7684\u53ef\u53d8\u914d\u7f6e\u5728 Kubernetes \u4e2d\u662f\u901a\u8fc7\u4e00\u4e2a <code>ConfigMap</code> \u8d44\u6e90\u5bf9\u8c61\u6765\u5b9e\u73b0\u7684\uff0c\u6211\u4eec\u77e5\u9053\u8bb8\u591a\u5e94\u7528\u7ecf\u5e38\u4f1a\u6709\u4ece\u914d\u7f6e\u6587\u4ef6\u3001\u547d\u4ee4\u884c\u53c2\u6570\u6216\u8005\u73af\u5883\u53d8\u91cf\u4e2d\u8bfb\u53d6\u4e00\u4e9b\u914d\u7f6e\u4fe1\u606f\u7684\u9700\u6c42\uff0c\u8fd9\u4e9b\u914d\u7f6e\u4fe1\u606f\u6211\u4eec\u80af\u5b9a\u4e0d\u4f1a\u76f4\u63a5\u5199\u6b7b\u5230\u5e94\u7528\u7a0b\u5e8f\u4e2d\u53bb\u7684\uff0c\u6bd4\u5982\u4f60\u4e00\u4e2a\u5e94\u7528\u8fde\u63a5\u4e00\u4e2a redis \u670d\u52a1\uff0c\u4e0b\u4e00\u6b21\u60f3\u66f4\u6362\u4e00\u4e2a\u4e86\u7684\uff0c\u8fd8\u5f97\u91cd\u65b0\u53bb\u4fee\u6539\u4ee3\u7801\uff0c\u91cd\u65b0\u5236\u4f5c\u4e00\u4e2a\u955c\u50cf\uff0c\u8fd9\u80af\u5b9a\u662f\u4e0d\u53ef\u53d6\u7684\uff0c\u800c<code>ConfigMap</code> \u5c31\u7ed9\u6211\u4eec\u63d0\u4f9b\u4e86\u5411\u5bb9\u5668\u4e2d\u6ce8\u5165\u914d\u7f6e\u4fe1\u606f\u7684\u80fd\u529b\uff0c\u4e0d\u4ec5\u53ef\u4ee5\u7528\u6765\u4fdd\u5b58\u5355\u4e2a\u5c5e\u6027\uff0c\u8fd8\u53ef\u4ee5\u7528\u6765\u4fdd\u5b58\u6574\u4e2a\u914d\u7f6e\u6587\u4ef6\uff0c\u6bd4\u5982\u6211\u4eec\u53ef\u4ee5\u7528\u6765\u914d\u7f6e\u4e00\u4e2a redis \u670d\u52a1\u7684\u8bbf\u95ee\u5730\u5740\uff0c\u4e5f\u53ef\u4ee5\u7528\u6765\u4fdd\u5b58\u6574\u4e2a redis \u7684\u914d\u7f6e\u6587\u4ef6\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u4e86\u89e3\u4e0b <code>ConfigMap</code> \u8fd9\u79cd\u8d44\u6e90\u5bf9\u8c61\u7684\u4f7f\u7528\u65b9\u6cd5\u3002</p>"},{"location":"kubernetes_config/config_map/#_1","title":"\u521b\u5efa","text":"<p><code>ConfigMap</code> \u8d44\u6e90\u5bf9\u8c61\u4f7f\u7528 <code>key-value</code> \u5f62\u5f0f\u7684\u952e\u503c\u5bf9\u6765\u914d\u7f6e\u6570\u636e\uff0c\u8fd9\u4e9b\u6570\u636e\u53ef\u4ee5\u5728 Pod \u91cc\u9762\u4f7f\u7528\uff0c\u5982\u4e0b\u6240\u793a\u7684\u8d44\u6e90\u6e05\u5355\uff1a</p> <pre><code>kind: ConfigMap\napiVersion: v1\nmetadata:\n  name: cm-demo\n  namespace: default\ndata:\n  data.1: hello\n  data.2: world\n  config: |\n    property.1=value-1\n    property.2=value-2\n    property.3=value-3\n</code></pre> <p>\u5176\u4e2d\u914d\u7f6e\u6570\u636e\u5728 <code>data</code> \u5c5e\u6027\u4e0b\u9762\u8fdb\u884c\u914d\u7f6e\uff0c\u524d\u4e24\u4e2a\u88ab\u7528\u6765\u4fdd\u5b58\u5355\u4e2a\u5c5e\u6027\uff0c\u540e\u9762\u4e00\u4e2a\u88ab\u7528\u6765\u4fdd\u5b58\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\u3002</p> <p>\u5f53\u7136\u540c\u6837\u7684\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528</p> <pre><code>kubectl create -f xx.yaml\n</code></pre> <p>\u6765\u521b\u5efa\u4e0a\u9762\u7684 <code>ConfigMap</code> \u5bf9\u8c61\uff0c\u4f46\u662f\u5982\u679c\u6211\u4eec\u4e0d\u77e5\u9053\u600e\u4e48\u521b\u5efa <code>ConfigMap</code> \u7684\u8bdd\uff0c\u4e0d\u8981\u5fd8\u8bb0 kubectl \u662f\u6211\u4eec\u6700\u597d\u7684\u5e2e\u624b\uff0c\u53ef\u4ee5\u4f7f\u7528</p> <pre><code>kubectl create configmap -h\n</code></pre> <p>\u6765\u67e5\u770b\u5173\u4e8e\u521b\u5efa <code>ConfigMap</code> \u7684\u5e2e\u52a9\u4fe1\u606f\uff1a</p> <pre><code>Examples:\n  # Create a new configmap named my-config based on folder bar\n  kubectl create configmap my-config --from-file=path/to/bar\n  # Create a new configmap named my-config with specified keys instead of file basenames on disk\n  kubectl create configmap my-config --from-file=key1=/path/to/bar/filetxt --from-file=key2=/path/to/bar/filetxt\n  # Create a new configmap named my-config with key1=config1 and key2=config2\n  kubectl create configmap my-config --from-literal=key1=config1 --from-literal=key2=config2\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u53ef\u4ee5\u4ece\u4e00\u4e2a\u7ed9\u5b9a\u7684\u76ee\u5f55\u6765\u521b\u5efa\u4e00\u4e2a <code>ConfigMap</code> \u5bf9\u8c61\uff0c\u6bd4\u5982\u6211\u4eec\u6709\u4e00\u4e2a testcm \u7684\u76ee\u5f55\uff0c\u8be5\u76ee\u5f55\u4e0b\u9762\u5305\u542b\u4e00\u4e9b\u914d\u7f6e\u6587\u4ef6\uff0credis \u548c mysql \u7684\u8fde\u63a5\u4fe1\u606f\uff0c\u5982\u4e0b\uff1a</p> <pre><code>$ ls testcm\nredis.conf\nmysql.conf\n$ cat testcm/redis.conf\nhost=11\nport=6379\n$ cat testcm/mysql.conf\nhost=11\nport=3306\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528 <code>from-file</code> \u5173\u952e\u5b57\u6765\u521b\u5efa\u5305\u542b\u8fd9\u4e2a\u76ee\u5f55\u4e0b\u9762\u6240\u4ee5\u914d\u7f6e\u6587\u4ef6\u7684 <code>ConfigMap</code>\uff1a</p> <pre><code>$ kubectl create configmap cm-demo1 --from-file=testcm\nconfigmap \"cm-demo1\" created\n</code></pre> <p>\u5176\u4e2d <code>from-file</code> \u53c2\u6570\u6307\u5b9a\u5728\u8be5\u76ee\u5f55\u4e0b\u9762\u7684\u6240\u6709\u6587\u4ef6\u90fd\u4f1a\u88ab\u7528\u5728 <code>ConfigMap</code> \u91cc\u9762\u521b\u5efa\u4e00\u4e2a\u952e\u503c\u5bf9\uff0c\u952e\u7684\u540d\u5b57\u5c31\u662f\u6587\u4ef6\u540d\uff0c\u503c\u5c31\u662f\u6587\u4ef6\u7684\u5185\u5bb9\u3002\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u6765\u67e5\u770b <code>ConfigMap</code> \u5217\u8868\uff1a</p> <pre><code>$ kubectl get configmap\nNAME       DATA      AGE\ncm-demo1   2         17s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u521b\u5efa\u4e86\u4e00\u4e2a cm-demo1 \u7684 <code>ConfigMap</code> \u5bf9\u8c61\uff0c\u7136\u540e\u53ef\u4ee5\u4f7f\u7528 <code>describe</code> \u547d\u4ee4\u67e5\u770b\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe configmap cm-demo1\nName:         cm-demo1\nNamespace:    default\nLabels:       &lt;none&gt;\nAnnotations:  &lt;none&gt;\n\nData\n====\nmysql.conf:\n----\nhost=11\nport=3306\n\nredis.conf:\n----\nhost=11\nport=6379\n\nEvents:  &lt;none&gt;\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e24\u4e2a <code>key</code> \u662f testcm \u76ee\u5f55\u4e0b\u9762\u7684\u6587\u4ef6\u540d\u79f0\uff0c\u5bf9\u5e94\u7684 <code>value</code> \u503c\u5c31\u662f\u6587\u4ef6\u5185\u5bb9\uff0c\u8fd9\u91cc\u503c\u5f97\u6ce8\u610f\u7684\u662f\u5982\u679c\u6587\u4ef6\u91cc\u9762\u7684\u914d\u7f6e\u4fe1\u606f\u5f88\u5927\u7684\u8bdd\uff0c<code>describe</code> \u7684\u65f6\u5019\u53ef\u80fd\u4e0d\u4f1a\u663e\u793a\u5bf9\u5e94\u7684\u503c\uff0c\u8981\u67e5\u770b\u5b8c\u6574\u7684\u952e\u503c\uff0c\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl get configmap cm-demo1 -o yaml\napiVersion: v1\ndata:\n  mysql.conf: |\n    host=11\n    port=3306\n  redis.conf: |\n    host=11\n    port=6379\nkind: ConfigMap\nmetadata:\n  creationTimestamp: 2018-06-14T16:24:36Z\n  name: cm-demo1\n  namespace: default\n  resourceVersion: \"3109975\"\n  selfLink: /api/v1/namespaces/default/configmaps/cm-demo1\n  uid: 6e0f4d82-6fef-11e8-a101-525400db4df7\n</code></pre> <p>\u9664\u4e86\u901a\u8fc7\u6587\u4ef6\u76ee\u5f55\u8fdb\u884c\u521b\u5efa\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528\u6307\u5b9a\u7684\u6587\u4ef6\u8fdb\u884c\u521b\u5efa <code>ConfigMap</code>\uff0c\u540c\u6837\u7684\uff0c\u4ee5\u4e0a\u9762\u7684\u914d\u7f6e\u6587\u4ef6\u4e3a\u4f8b\uff0c\u6211\u4eec\u521b\u5efa\u4e00\u4e2a redis \u7684\u914d\u7f6e\u7684\u4e00\u4e2a\u5355\u72ec <code>ConfigMap</code> \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create configmap cm-demo2 --from-file=testcm/redis.conf\nconfigmap \"cm-demo2\" created\n$ kubectl get configmap cm-demo2 -o yaml\napiVersion: v1\ndata:\n  redis.conf: |\n    host=11\n    port=6379\nkind: ConfigMap\nmetadata:\n  creationTimestamp: 2018-06-14T16:34:29Z\n  name: cm-demo2\n  namespace: default\n  resourceVersion: \"3110758\"\n  selfLink: /api/v1/namespaces/default/configmaps/cm-demo2\n  uid: cf59675d-6ff0-11e8-a101-525400db4df7\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e00\u4e2a\u5173\u8054 redis.conf \u6587\u4ef6\u914d\u7f6e\u4fe1\u606f\u7684 <code>ConfigMap</code> \u5bf9\u8c61\u521b\u5efa\u6210\u529f\u4e86\uff0c\u53e6\u5916\u503c\u5f97\u6ce8\u610f\u7684\u662f <code>--from-file</code> \u8fd9\u4e2a\u53c2\u6570\u53ef\u4ee5\u4f7f\u7528\u591a\u6b21\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u4e24\u6b21\u5206\u522b\u6307\u5b9a redis.conf \u548c mysql.conf \u6587\u4ef6\uff0c\u5c31\u548c\u76f4\u63a5\u6307\u5b9a\u6574\u4e2a\u76ee\u5f55\u662f\u4e00\u6837\u7684\u6548\u679c\u4e86\u3002</p> <p>\u53e6\u5916\uff0c\u901a\u8fc7\u5e2e\u52a9\u6587\u6863\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u8fd8\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u5b57\u7b26\u4e32\u8fdb\u884c\u521b\u5efa\uff0c\u901a\u8fc7 <code>--from-literal</code> \u53c2\u6570\u4f20\u9012\u914d\u7f6e\u4fe1\u606f\uff0c\u540c\u6837\u7684\uff0c\u8fd9\u4e2a\u53c2\u6570\u53ef\u4ee5\u4f7f\u7528\u591a\u6b21\uff0c\u683c\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>$ kubectl create configmap cm-demo3 --from-literal=db.host=localhost --from-literal=db.port=3306\nconfigmap \"cm-demo3\" created\n$ kubectl get configmap cm-demo3 -o yaml\napiVersion: v1\ndata:\n  db.host: localhost\n  db.port: \"3306\"\nkind: ConfigMap\nmetadata:\n  creationTimestamp: 2018-06-14T16:43:12Z\n  name: cm-demo3\n  namespace: default\n  resourceVersion: \"3111447\"\n  selfLink: /api/v1/namespaces/default/configmaps/cm-demo3\n  uid: 06eeec7e-6ff2-11e8-a101-525400db4df7\n</code></pre>"},{"location":"kubernetes_config/config_map/#_2","title":"\u4f7f\u7528","text":"<p><code>ConfigMap</code> \u521b\u5efa\u6210\u529f\u4e86\uff0c\u90a3\u4e48\u6211\u4eec\u5e94\u8be5\u600e\u4e48\u5728 Pod \u4e2d\u6765\u4f7f\u7528\u5462\uff1f\u6211\u4eec\u8bf4 <code>ConfigMap</code> \u8fd9\u4e9b\u914d\u7f6e\u6570\u636e\u53ef\u4ee5\u901a\u8fc7\u5f88\u591a\u79cd\u65b9\u5f0f\u5728 Pod \u91cc\u4f7f\u7528\uff0c\u4e3b\u8981\u6709\u4ee5\u4e0b\u51e0\u79cd\u65b9\u5f0f\uff1a</p> <ul> <li>\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf\u7684\u503c</li> <li>\u5728\u5bb9\u5668\u91cc\u8bbe\u7f6e\u547d\u4ee4\u884c\u53c2\u6570</li> <li>\u5728\u6570\u636e\u5377\u91cc\u9762\u6302\u8f7d\u914d\u7f6e\u6587\u4ef6</li> </ul> <p>\u9996\u5148\uff0c\u6211\u4eec\u4f7f\u7528 <code>ConfigMap</code> \u6765\u586b\u5145\u6211\u4eec\u7684\u73af\u5883\u53d8\u91cf\uff0c\u5982\u4e0b\u6240\u793a\u7684 Pod \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: testcm1-pod\nspec:\n  containers:\n    - name: testcm1\n      image: busybox\n      command: [ \"/bin/sh\", \"-c\", \"env\" ]\n      env:\n        - name: DB_HOST\n          valueFrom:\n            configMapKeyRef:\n              name: cm-demo3\n              key: db.host\n        - name: DB_PORT\n          valueFrom:\n            configMapKeyRef:\n              name: cm-demo3\n              key: db.port\n      envFrom:\n        - configMapRef:\n            name: cm-demo1\n</code></pre> <p>\u8fd9\u4e2a Pod \u8fd0\u884c\u540e\u4f1a\u8f93\u51fa\u5982\u4e0b\u6240\u793a\u7684\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl logs testcm1-pod\n......\nDB_HOST=localhost\nDB_PORT=3306\nmysql.conf=host=11\nport=3306\nredis.conf=host=11\nport=6379\n......\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 DB_HOST \u548c DB_PORT \u90fd\u5df2\u7ecf\u6b63\u5e38\u8f93\u51fa\u4e86\uff0c\u53e6\u5916\u7684\u73af\u5883\u53d8\u91cf\u662f\u56e0\u4e3a\u6211\u4eec\u8fd9\u91cc\u76f4\u63a5\u628a cm-demo1 \u7ed9\u6ce8\u5165\u8fdb\u6765\u4e86\uff0c\u6240\u4ee5\u628a\u4ed6\u4eec\u7684\u6574\u4e2a\u952e\u503c\u7ed9\u8f93\u51fa\u51fa\u6765\u4e86\uff0c\u8fd9\u4e5f\u662f\u7b26\u5408\u9884\u671f\u7684\u3002</p> <p>\u53e6\u5916\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528 <code>ConfigMap</code>\u6765\u8bbe\u7f6e\u547d\u4ee4\u884c\u53c2\u6570\uff0c<code>ConfigMap</code> \u4e5f\u53ef\u4ee5\u88ab\u7528\u6765\u8bbe\u7f6e\u5bb9\u5668\u4e2d\u7684\u547d\u4ee4\u6216\u8005\u53c2\u6570\u503c\uff0c\u5982\u4e0b Pod:</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: testcm2-pod\nspec:\n  containers:\n    - name: testcm2\n      image: busybox\n      command: [ \"/bin/sh\", \"-c\", \"echo $(DB_HOST) $(DB_PORT)\" ]\n      env:\n        - name: DB_HOST\n          valueFrom:\n            configMapKeyRef:\n              name: cm-demo3\n              key: db.host\n        - name: DB_PORT\n          valueFrom:\n            configMapKeyRef:\n              name: cm-demo3\n              key: db.port\n</code></pre> <p>\u8fd0\u884c\u8fd9\u4e2a Pod \u540e\u4f1a\u8f93\u51fa\u5982\u4e0b\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl logs testcm2-pod\nlocalhost 3306\n</code></pre> <p>\u53e6\u5916\u4e00\u79cd\u662f\u975e\u5e38\u5e38\u89c1\u7684\u4f7f\u7528 <code>ConfigMap</code> \u7684\u65b9\u5f0f\uff1a\u901a\u8fc7<code>\u6570\u636e\u5377</code>\u4f7f\u7528\uff0c\u5728\u6570\u636e\u5377\u91cc\u9762\u4f7f\u7528 ConfigMap\uff0c\u5c31\u662f\u5c06\u6587\u4ef6\u586b\u5165\u6570\u636e\u5377\uff0c\u5728\u8fd9\u4e2a\u6587\u4ef6\u4e2d\uff0c\u952e\u5c31\u662f\u6587\u4ef6\u540d\uff0c\u952e\u503c\u5c31\u662f\u6587\u4ef6\u5185\u5bb9\uff0c\u5982\u4e0b\u8d44\u6e90\u5bf9\u8c61\u6240\u793a\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: testcm3-pod\nspec:\n  volumes:\n    - name: config-volume\n      configMap:\n        name: cm-demo2\n  containers:\n    - name: testcm3\n      image: busybox\n      command: [ \"/bin/sh\", \"-c\", \"cat /etc/config/redis.conf\" ]\n      volumeMounts:\n      - name: config-volume\n        mountPath: /etc/config\n</code></pre> <p>\u8fd0\u884c\u8fd9\u4e2a Pod \u7684\uff0c\u67e5\u770b\u65e5\u5fd7\uff1a</p> <pre><code>$ kubectl logs testcm3-pod\nhost=11\nport=6379\n</code></pre> <p>\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u5728 <code>ConfigMap</code> \u503c\u88ab\u6620\u5c04\u7684\u6570\u636e\u5377\u91cc\u53bb\u63a7\u5236\u8def\u5f84\uff0c\u5982\u4e0b Pod \u5b9a\u4e49\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: testcm4-pod\nspec:\n  volumes:\n    - name: config-volume\n      configMap:\n        name: cm-demo1\n        items:\n        - key: mysql.conf\n          path: path/to/msyql.conf\n  containers:\n    - name: testcm4\n      image: busybox\n      command: [ \"/bin/sh\",\"-c\",\"cat /etc/config/path/to/msyql.conf\" ]\n      volumeMounts:\n      - name: config-volume\n        mountPath: /etc/config\n</code></pre> <p>\u8fd0\u884c\u8fd9\u4e2aPod\u7684\uff0c\u67e5\u770b\u65e5\u5fd7\uff1a</p> <pre><code>$ kubectl logs testcm4-pod\nhost=11\nport=3306\n</code></pre> <p>\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5f53 <code>ConfigMap</code> \u4ee5\u6570\u636e\u5377\u7684\u5f62\u5f0f\u6302\u8f7d\u8fdb <code>Pod</code> \u7684\u65f6\uff0c\u8fd9\u65f6\u66f4\u65b0 </p> <pre><code>ConfigMap\uff08\u6216\u5220\u6389\u91cd\u5efaConfigMap\uff09\n</code></pre> <p>\uff0cPod \u5185\u6302\u8f7d\u7684\u914d\u7f6e\u4fe1\u606f\u4f1a\u70ed\u66f4\u65b0\u3002\u8fd9\u65f6\u53ef\u4ee5\u589e\u52a0\u4e00\u4e9b\u76d1\u6d4b\u914d\u7f6e\u6587\u4ef6\u53d8\u66f4\u7684\u811a\u672c\uff0c\u7136\u540e\u91cd\u52a0\u8f7d\u5bf9\u5e94\u670d\u52a1\u5c31\u53ef\u4ee5\u5b9e\u73b0\u5e94\u7528\u7684\u70ed\u66f4\u65b0\u3002</p> <p>\u4f7f\u7528\u6ce8\u610f</p> <p>\u53ea\u6709\u901a\u8fc7 Kubernetes API \u521b\u5efa\u7684 Pod \u624d\u80fd\u4f7f\u7528 <code>ConfigMap</code>\uff0c\u5176\u4ed6\u65b9\u5f0f\u521b\u5efa\u7684\uff08\u6bd4\u5982\u9759\u6001 Pod\uff09\u4e0d\u80fd\u4f7f\u7528\uff1bConfigMap \u6587\u4ef6\u5927\u5c0f\u9650\u5236\u4e3a <code>1MB</code>\uff08ETCD \u7684\u8981\u6c42\uff09\u3002</p>"},{"location":"kubernetes_config/secret/","title":"Secret","text":"<p>\ue3c9</p>"},{"location":"kubernetes_config/secret/#secret","title":"Secret","text":"<p>\u654f\u611f\u4fe1\u606f\u914d\u7f6e\u7ba1\u7406</p> <p>\u524d\u6587\u6211\u4eec\u5b66\u4e60 <code>ConfigMap</code> \u7684\u65f6\u5019\uff0c\u6211\u4eec\u8bf4 <code>ConfigMap</code> \u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u662f Kubernetes \u5f53\u4e2d\u975e\u5e38\u91cd\u8981\u7684\u4e00\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b ConfigMap \u662f\u7528\u6765\u5b58\u50a8\u4e00\u4e9b\u975e\u5b89\u5168\u7684\u914d\u7f6e\u4fe1\u606f\uff0c\u5982\u679c\u6d89\u53ca\u5230\u4e00\u4e9b\u5b89\u5168\u76f8\u5173\u7684\u6570\u636e\u7684\u8bdd\u7528 ConfigMap \u5c31\u975e\u5e38\u4e0d\u59a5\u4e86\uff0c\u56e0\u4e3aConfigMa \u662f\u660e\u6587\u5b58\u50a8\u7684\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u9700\u8981\u7528\u5230\u53e6\u5916\u4e00\u4e2a\u8d44\u6e90\u5bf9\u8c61\u4e86\uff1a<code>Secret</code>\uff0c<code>Secret</code>\u7528\u6765\u4fdd\u5b58\u654f\u611f\u4fe1\u606f\uff0c\u4f8b\u5982\u5bc6\u7801\u3001OAuth \u4ee4\u724c\u548c ssh key \u7b49\u7b49\uff0c\u5c06\u8fd9\u4e9b\u4fe1\u606f\u653e\u5728 <code>Secret</code> \u4e2d\u6bd4\u653e\u5728 Pod \u7684\u5b9a\u4e49\u4e2d\u6216\u8005 Docker \u955c\u50cf\u4e2d\u8981\u66f4\u52a0\u5b89\u5168\u548c\u7075\u6d3b\u3002</p> <p><code>Secret</code> \u4e3b\u8981\u4f7f\u7528\u7684\u6709\u4ee5\u4e0b\u4e09\u79cd\u7c7b\u578b\uff1a</p> <ul> <li><code>Opaque</code>\uff1abase64 \u7f16\u7801\u683c\u5f0f\u7684 Secret\uff0c\u7528\u6765\u5b58\u50a8\u5bc6\u7801\u3001\u5bc6\u94a5\u7b49\uff1b\u4f46\u6570\u636e\u4e5f\u53ef\u4ee5\u901a\u8fc7<code>base64 \u2013decode</code>\u89e3\u7801\u5f97\u5230\u539f\u59cb\u6570\u636e\uff0c\u6240\u6709\u52a0\u5bc6\u6027\u5f88\u5f31\u3002</li> <li> <p><code>kubernetes.io/dockerconfigjson</code></p> <p>\uff1a\u7528\u6765\u5b58\u50a8\u79c1\u6709<code>docker registry</code>\u7684\u8ba4\u8bc1\u4fe1\u606f\u3002 *   <code>kubernetes.io/service-account-token <pre><code>\uff1a\u7528\u4e8e\u88ab `ServiceAccount` ServiceAccount \u521b\u5efa\u65f6 Kubernetes \u4f1a\u9ed8\u8ba4\u521b\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7684 Secret \u5bf9\u8c61\u3002Pod \u5982\u679c\u4f7f\u7528\u4e86 ServiceAccount\uff0c\u5bf9\u5e94\u7684 Secret \u4f1a\u81ea\u52a8\u6302\u8f7d\u5230 Pod \u76ee\u5f55 \n</code></pre> /run/secrets/kubernetes.io/serviceaccount</code></p> <p>\u4e2d\u3002 *   <code>bootstrap.kubernetes.io/token</code></p> <p>\uff1a\u7528\u4e8e\u8282\u70b9\u63a5\u5165\u96c6\u7fa4\u7684\u6821\u9a8c\u7684 Secret</p> </li> </ul>"},{"location":"kubernetes_config/secret/#opaque_secret","title":"Opaque Secret","text":"<p><code>Opaque</code> \u7c7b\u578b\u7684\u6570\u636e\u662f\u4e00\u4e2a map \u7c7b\u578b\uff0c\u8981\u6c42 value \u5fc5\u987b\u662f <code>base64</code> \u7f16\u7801\u683c\u5f0f\uff0c\u6bd4\u5982\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a\u7528\u6237\u540d\u4e3a admin\uff0c\u5bc6\u7801\u4e3a admin321 \u7684 <code>Secret</code> \u5bf9\u8c61\uff0c\u9996\u5148\u6211\u4eec\u9700\u8981\u5148\u628a\u7528\u6237\u540d\u548c\u5bc6\u7801\u505a <code>base64</code> \u7f16\u7801\uff1a</p> <pre><code>$ echo -n \"admin\" | base64\nYWRtaW4=\n$ echo -n \"admin321\" | base64\nYWRtaW4zMjE=\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u5229\u7528\u4e0a\u9762\u7f16\u7801\u8fc7\u540e\u7684\u6570\u636e\u6765\u7f16\u5199\u4e00\u4e2a YAML \u6587\u4ef6\uff1a(secret-demo.yaml)</p> <pre><code>apiVersion: v1\nkind: Secret\nmetadata:\n  name: mysecret\ntype: Opaque\ndata:\n  username: YWRtaW4=\n  password: YWRtaW4zMjE=\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528 kubectl \u547d\u4ee4\u6765\u521b\u5efa\u4e86\uff1a</p> <pre><code>$ kubectl create -f secret-demo.yaml\nsecret \"mysecret\" created\n</code></pre> <p>\u5229\u7528<code>get secret</code>\u547d\u4ee4\u67e5\u770b\uff1a</p> <pre><code>$ kubectl get secret\nNAME                  TYPE                                  DATA      AGE\ndefault-token-n9w2d   kubernetes.io/service-account-token   3         33d\nmysecret              Opaque                                2         40s\n</code></pre> <p>\u5176\u4e2d default-token-n9w2d \u4e3a\u521b\u5efa\u96c6\u7fa4\u65f6\u9ed8\u8ba4\u521b\u5efa\u7684 Secret\uff0c\u88ab </p> <pre><code>serviceacount/default\n</code></pre> <p>\u5f15\u7528\u3002\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>describe</code> \u547d\u4ee4\u67e5\u770b\u8be6\u60c5\uff1a</p> <pre><code>$ kubectl describe secret mysecret\nName:         mysecret\nNamespace:    default\nLabels:       &lt;none&gt;\nAnnotations:  &lt;none&gt;\n\nType:  Opaque\n\nData\n====\npassword:  8 bytes\nusername:  5 bytes\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5229\u7528 describe \u547d\u4ee4\u67e5\u770b\u5230\u7684 Data \u6ca1\u6709\u76f4\u63a5\u663e\u793a\u51fa\u6765\uff0c\u5982\u679c\u60f3\u770b\u5230 Data \u91cc\u9762\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u8f93\u51fa\u6210YAML \u6587\u4ef6\u8fdb\u884c\u67e5\u770b\uff1a</p> <pre><code>$ kubectl get secret mysecret -o yaml\napiVersion: v1\ndata:\n  password: YWRtaW4zMjE=\n  username: YWRtaW4=\nkind: Secret\nmetadata:\n  creationTimestamp: 2018-06-19T15:27:06Z\n  name: mysecret\n  namespace: default\n  resourceVersion: \"3694084\"\n  selfLink: /api/v1/namespaces/default/secrets/mysecret\n  uid: 39c139f5-73d5-11e8-a101-525400db4df7\ntype: Opaque\n</code></pre> <p>\u521b\u5efa\u597d <code>Secret</code>\u5bf9\u8c61\u540e\uff0c\u6709\u4e24\u79cd\u65b9\u5f0f\u6765\u4f7f\u7528\u5b83\uff1a</p> <ul> <li>\u4ee5\u73af\u5883\u53d8\u91cf\u7684\u5f62\u5f0f</li> <li>\u4ee5Volume\u7684\u5f62\u5f0f\u6302\u8f7d</li> </ul>"},{"location":"kubernetes_config/secret/#_1","title":"\u73af\u5883\u53d8\u91cf","text":"<p>\u9996\u5148\u6211\u4eec\u6765\u6d4b\u8bd5\u4e0b\u73af\u5883\u53d8\u91cf\u7684\u65b9\u5f0f\uff0c\u540c\u6837\u7684\uff0c\u6211\u4eec\u6765\u4f7f\u7528\u4e00\u4e2a\u7b80\u5355\u7684 busybox \u955c\u50cf\u6765\u6d4b\u8bd5\u4e0b:(secret1-pod.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: secret1-pod\nspec:\n  containers:\n  - name: secret1\n    image: busybox\n    command: [ \"/bin/sh\", \"-c\", \"env\" ]\n    env:\n    - name: USERNAME\n      valueFrom:\n        secretKeyRef:\n          name: mysecret\n          key: username\n    - name: PASSWORD\n      valueFrom:\n        secretKeyRef:\n          name: mysecret\n          key: password\n</code></pre> <p>\u4e3b\u8981\u9700\u8981\u6ce8\u610f\u7684\u662f\u4e0a\u9762\u73af\u5883\u53d8\u91cf\u4e2d\u5b9a\u4e49\u7684 <code>secretKeyRef</code> \u5b57\u6bb5\uff0c\u548c\u6211\u4eec\u524d\u6587\u7684 <code>configMapKeyRef</code> \u7c7b\u4f3c\uff0c\u4e00\u4e2a\u662f\u4ece <code>Secret</code> \u5bf9\u8c61\u4e2d\u83b7\u53d6\uff0c\u4e00\u4e2a\u662f\u4ece <code>ConfigMap</code> \u5bf9\u8c61\u4e2d\u83b7\u53d6\uff0c\u521b\u5efa\u4e0a\u9762\u7684 Pod\uff1a</p> <pre><code>$ kubectl create -f secret1-pod.yaml\npod \"secret1-pod\" created\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u67e5\u770bPod\u7684\u65e5\u5fd7\u8f93\u51fa\uff1a</p> <pre><code>$ kubectl logs secret1-pod\n...\nUSERNAME=admin\nPASSWORD=admin321\n...\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6709 USERNAME \u548c PASSWORD \u4e24\u4e2a\u73af\u5883\u53d8\u91cf\u8f93\u51fa\u51fa\u6765\u3002</p>"},{"location":"kubernetes_config/secret/#volume","title":"Volume \u6302\u8f7d","text":"<p>\u540c\u6837\u7684\u6211\u4eec\u7528\u4e00\u4e2a Pod \u6765\u9a8c\u8bc1\u4e0b <code>Volume</code> \u6302\u8f7d\uff0c\u521b\u5efa\u4e00\u4e2a Pod \u6587\u4ef6\uff1a(secret2-pod.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: secret2-pod\nspec:\n  containers:\n  - name: secret2\n    image: busybox\n    command: [\"/bin/sh\", \"-c\", \"ls /etc/secrets\"]\n    volumeMounts:\n    - name: secrets\n      mountPath: /etc/secrets\n  volumes:\n  - name: secrets\n    secret:\n     secretName: mysecret\n</code></pre> <p>\u521b\u5efa Pod\uff0c\u7136\u540e\u67e5\u770b\u8f93\u51fa\u65e5\u5fd7\uff1a</p> <pre><code>$ kubectl create -f secret-podyaml\npod \"secret2-pod\" created\n$ kubectl logs secret2-pod\npassword\nusername\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 Secret \u628a\u4e24\u4e2a key \u6302\u8f7d\u6210\u4e86\u4e24\u4e2a\u5bf9\u5e94\u7684\u6587\u4ef6\u3002\u5f53\u7136\u5982\u679c\u60f3\u8981\u6302\u8f7d\u5230\u6307\u5b9a\u7684\u6587\u4ef6\u4e0a\u9762\uff0c\u662f\u4e0d\u662f\u4e5f\u53ef\u4ee5\u4f7f\u7528\u4e0a\u4e00\u8282\u8bfe\u7684\u65b9\u6cd5\uff1a\u5728 <code>secretName</code> \u4e0b\u9762\u6dfb\u52a0 <code>items</code> \u6307\u5b9a <code>key</code> \u548c <code>path</code>\uff0c\u8fd9\u4e2a\u5927\u5bb6\u53ef\u4ee5\u53c2\u8003\u4e0a\u8282\u8bfe <code>ConfigMap</code> \u4e2d\u7684\u65b9\u6cd5\u53bb\u6d4b\u8bd5\u4e0b\u3002</p>"},{"location":"kubernetes_config/secret/#kubernetesiodockerconfigjson","title":"kubernetes.io/dockerconfigjson","text":"<p>\u9664\u4e86\u4e0a\u9762\u7684 <code>Opaque</code> \u8fd9\u79cd\u7c7b\u578b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u6765\u521b\u5efa\u7528\u6237 <code>docker registry</code> \u8ba4\u8bc1\u7684 <code>Secret</code>\uff0c\u76f4\u63a5\u4f7f\u7528<code>`kubectl create</code> \u547d\u4ee4\u521b\u5efa\u5373\u53ef\uff0c\u5982\u4e0b\uff1a</p> <pre><code>$ kubectl create secret docker-registry myregistry --docker-server=DOCKER_SERVER --docker-username=DOCKER_USER --docker-password=DOCKER_PASSWORD --docker-email=DOCKER_EMAIL\nsecret \"myregistry\" created\n</code></pre> <p>\u9664\u4e86\u4e0a\u9762\u8fd9\u79cd\u65b9\u6cd5\u4e4b\u5916\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u6307\u5b9a\u6587\u4ef6\u7684\u65b9\u5f0f\u6765\u521b\u5efa\u955c\u50cf\u4ed3\u5e93\u8ba4\u8bc1\u4fe1\u606f\uff0c\u9700\u8981\u6ce8\u610f\u5bf9\u5e94\u7684 <code>KEY</code> \u548c <code>TYPE</code>\uff1a</p> <pre><code>$ kubectl create secret generic myregistry --from-file=.dockerconfigjson=/root/.docker/config.json --type=kubernetes.io/dockerconfigjson\n</code></pre> <p>\u7136\u540e\u67e5\u770b Secret \u5217\u8868\uff1a</p> <pre><code>$ kubectl get secret\nNAME                  TYPE                                  DATA      AGE\ndefault-token-n9w2d   kubernetes.io/service-account-token   3         33d\nmyregistry            kubernetes.io/dockerconfigjson        1         15s\nmysecret              Opaque                                2         34m\n</code></pre> <p>\u6ce8\u610f\u770b\u4e0a\u9762\u7684 TYPE \u7c7b\u578b\uff0cmyregistry \u5bf9\u5e94\u7684\u662f </p> <pre><code>kubernetes.io/dockerconfigjson\n</code></pre> <p>\uff0c\u540c\u6837\u7684\u53ef\u4ee5\u4f7f\u7528 describe \u547d\u4ee4\u6765\u67e5\u770b\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe secret myregistry\nName:         myregistry\nNamespace:    default\nLabels:       &lt;none&gt;\nAnnotations:  &lt;none&gt;\n\nType:  kubernetes.io/dockerconfigjson\n\nData\n====\n.dockerconfigjson:  152 bytes\n</code></pre> <p>\u540c\u6837\u7684\u53ef\u4ee5\u770b\u5230 Data \u533a\u57df\u6ca1\u6709\u76f4\u63a5\u5c55\u793a\u51fa\u6765\uff0c\u5982\u679c\u60f3\u67e5\u770b\u7684\u8bdd\u53ef\u4ee5\u4f7f\u7528 <code>-o yaml</code> \u6765\u8f93\u51fa\u5c55\u793a\u51fa\u6765\uff1a</p> <pre><code>$ kubectl get secret myregistry -o yaml\napiVersion: v1\ndata:\n  .dockerconfigjson: eyJhdXRocyI6eyJET0NLRVJfU0VSVkVSIjp7InVzZXJuYW1lIjoiRE9DS0VSX1VTRVIiLCJwYXNzd29yZCI6IkRPQ0tFUl9QQVNTV09SRCIsImVtYWlsIjoiRE9DS0VSX0VNQUlMIiwiYXV0aCI6IlJFOURTMFZTWDFWVFJWSTZSRTlEUzBWU1gxQkJVMU5YVDFKRSJ9fX0=\nkind: Secret\nmetadata:\n  creationTimestamp: 2018-06-19T16:01:05Z\n  name: myregistry\n  namespace: default\n  resourceVersion: \"3696966\"\n  selfLink: /api/v1/namespaces/default/secrets/myregistry\n  uid: f91db707-73d9-11e8-a101-525400db4df7\ntype: kubernetes.io/dockerconfigjson\n</code></pre> <p>\u53ef\u4ee5\u628a\u4e0a\u9762\u7684 </p> <pre><code>data.dockerconfigjson\n</code></pre> <p>\u4e0b\u9762\u7684\u6570\u636e\u505a\u4e00\u4e2a <code>base64</code> \u89e3\u7801\uff0c\u770b\u770b\u91cc\u9762\u7684\u6570\u636e\u662f\u600e\u6837\u7684\u5462\uff1f</p> <pre><code>$ echo eyJhdXRocyI6eyJET0NLRVJfU0VSVkVSIjp7InVzZXJuYW1lIjoiRE9DS0VSX1VTRVIiLCJwYXNzd29yZCI6IkRPQ0tFUl9QQVNTV09SRCIsImVtYWlsIjoiRE9DS0VSX0VNQUlMIiwiYXV0aCI6IlJFOURTMFZTWDFWVFJWSTZSRTlEUzBWU1gxQkJVMU5YVDFKRSJ9fX0= | base64 -d\n{\"auths\":{\"DOCKER_SERVER\":{\"username\":\"DOCKER_USER\",\"password\":\"DOCKER_PASSWORD\",\"email\":\"DOCKER_EMAIL\",\"auth\":\"RE9DS0VSX1VTRVI6RE9DS0VSX1BBU1NXT1JE\"}}}\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u9700\u8981\u62c9\u53d6\u79c1\u6709\u4ed3\u5e93\u4e2d\u7684 Docker \u955c\u50cf\u7684\u8bdd\u5c31\u9700\u8981\u4f7f\u7528\u5230\u4e0a\u9762\u7684 myregistry \u8fd9\u4e2a <code>Secret</code>\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: foo\nspec:\n  containers:\n  - name: foo\n    image: 11100:5000/test:v1\n  imagePullSecrets:\n  - name: myregistry\n</code></pre> <p>imagePullSecrets</p> <p><code>ImagePullSecrets</code> \u4e0e <code>Secrets</code> \u4e0d\u540c\uff0c\u56e0\u4e3a <code>Secrets</code> \u53ef\u4ee5\u6302\u8f7d\u5230 Pod \u4e2d\uff0c\u4f46\u662f <code>ImagePullSecrets</code> \u53ea\u80fd\u7531 Kubelet \u8bbf\u95ee\u3002</p> <p>\u6211\u4eec\u9700\u8981\u62c9\u53d6\u79c1\u6709\u4ed3\u5e93\u955c\u50cf </p> <pre><code>11100:5000/test:v1\n</code></pre> <p>\uff0c\u6211\u4eec\u5c31\u9700\u8981\u9488\u5bf9\u8be5\u79c1\u6709\u4ed3\u5e93\u6765\u521b\u5efa\u4e00\u4e2a\u5982\u4e0a\u7684 <code>Secret</code>\uff0c\u7136\u540e\u5728 Pod \u4e2d\u6307\u5b9a <code>imagePullSecrets</code>\u3002</p> <p>\u9664\u4e86\u8bbe\u7f6e </p> <pre><code>Pod.spec.imagePullSecrets\n</code></pre> <p>\u8fd9\u79cd\u65b9\u5f0f\u6765\u83b7\u53d6\u79c1\u6709\u955c\u50cf\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u901a\u8fc7\u5728 <code>ServiceAccount</code> \u4e2d\u8bbe\u7f6e <code>imagePullSecrets</code>\uff0c\u7136\u540e\u5c31\u4f1a\u81ea\u52a8\u4e3a\u4f7f\u7528\u8be5 SA \u7684 Pod \u6ce8\u5165 <code>imagePullSecrets</code> \u4fe1\u606f\uff1a</p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  creationTimestamp: \"2019-11-08T12:00:04Z\"\n  name: default\n  namespace: default\n  resourceVersion: \"332\"\n  selfLink: /api/v1/namespaces/default/serviceaccounts/default\n  uid: cc37a719-c4fe-4ebf-92da-e92c3e24d5d0\nsecrets:\n- name: default-token-5tsh4\nimagePullSecrets:\n- name: myregistry\n</code></pre>"},{"location":"kubernetes_config/secret/#kubernetesioservice-account-token","title":"kubernetes.io/service-account-token","text":"<p>\u53e6\u5916\u4e00\u79cd <code>Secret</code> \u7c7b\u578b\u5c31\u662f </p> <pre><code>kubernetes.io/service-account-token\n</code></pre> <p>\uff0c\u7528\u4e8e\u88ab <code>ServiceAccount</code> \u5f15\u7528\u3002<code>ServiceAccout</code> \u521b\u5efa\u65f6 Kubernetes \u4f1a\u9ed8\u8ba4\u521b\u5efa\u5bf9\u5e94\u7684 <code>Secret</code>\u3002Pod \u5982\u679c\u4f7f\u7528\u4e86 <code>ServiceAccount</code>\uff0c\u5bf9\u5e94\u7684 <code>Secret</code> \u4f1a\u81ea\u52a8\u6302\u8f7d\u5230 Pod \u7684 </p> <pre><code>/var/run/secrets/kubernetes.io/serviceaccount/\n</code></pre> <p>\u76ee\u5f55\u4e2d\u3002\u5982\u4e0b\u6240\u793a\u6211\u4eec\u968f\u610f\u521b\u5efa\u4e00\u4e2a Pod\uff1a</p> <pre><code>$ kubectl run secret-pod3 --image nginx:9\ndeployment.apps \"secret-pod3\" created\n$ kubectl get pods\nNAME                           READY     STATUS    RESTARTS   AGE\n...\nsecret-pod3-78c8c76db8-7zmqm   1/1       Running   0          13s\n...\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u67e5\u770b\u8fd9\u4e2a Pod \u7684\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>volumeMounts:\n    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount\n      name: default-token-5tsh4\n      readOnly: true\n  ......\n  serviceAccount: default\n  serviceAccountName: default\n  volumes:\n  - name: default-token-5tsh4\n    secret:\n      defaultMode: 420\n      secretName: default-token-5tsh4\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u9ed8\u8ba4\u628a\u540d\u4e3a <code>default</code>\uff08\u81ea\u52a8\u521b\u5efa\u7684\uff09\u7684 <code>ServiceAccount</code> \u5bf9\u5e94\u7684 Secret \u5bf9\u8c61\u901a\u8fc7 Volume \u6302\u8f7d\u5230\u4e86\u5bb9\u5668\u7684 </p> <pre><code>/var/run/secrets/kubernetes.io/serviceaccount\n</code></pre> <p>\u7684\u76ee\u5f55\u4e2d\uff0c\u5bf9\u4e8e\u8be5\u76ee\u5f55\u7684\u4f5c\u7528\u6211\u4eec\u4f1a\u5728\u540e\u9762\u7684\u5b89\u5168\u7ae0\u8282\u4e2d\u7ee7\u7eed\u548c\u5927\u5bb6\u5b66\u4e60\u3002</p>"},{"location":"kubernetes_config/secret/#secret_vs_configmap","title":"Secret vs ConfigMap","text":"<p>\u6700\u540e\u6211\u4eec\u6765\u5bf9\u6bd4\u4e0b <code>Secret</code> \u548c <code>ConfigMap</code>\u8fd9\u4e24\u79cd\u8d44\u6e90\u5bf9\u8c61\u7684\u5f02\u540c\u70b9\uff1a</p>"},{"location":"kubernetes_config/secret/#_2","title":"\u76f8\u540c\u70b9","text":"<ul> <li>key/value\u7684\u5f62\u5f0f</li> <li>\u5c5e\u4e8e\u67d0\u4e2a\u7279\u5b9a\u7684\u547d\u540d\u7a7a\u95f4</li> <li>\u53ef\u4ee5\u5bfc\u51fa\u5230\u73af\u5883\u53d8\u91cf</li> <li>\u53ef\u4ee5\u901a\u8fc7\u76ee\u5f55/\u6587\u4ef6\u5f62\u5f0f\u6302\u8f7d</li> <li>\u901a\u8fc7 volume \u6302\u8f7d\u7684\u914d\u7f6e\u4fe1\u606f\u5747\u53ef\u70ed\u66f4\u65b0</li> </ul>"},{"location":"kubernetes_config/secret/#_3","title":"\u4e0d\u540c\u70b9","text":"<ul> <li>Secret \u53ef\u4ee5\u88ab ServerAccount \u5173\u8054</li> <li>Secret \u53ef\u4ee5\u5b58\u50a8 <code>docker register</code> \u7684\u9274\u6743\u4fe1\u606f\uff0c\u7528\u5728 <code>ImagePullSecret</code> \u53c2\u6570\u4e2d\uff0c\u7528\u4e8e\u62c9\u53d6\u79c1\u6709\u4ed3\u5e93\u7684\u955c\u50cf</li> <li>Secret \u652f\u6301 <code>Base64</code> \u52a0\u5bc6</li> <li> <p>Secret \u5206\u4e3a </p> <pre><code>kubernetes.io/service-account-token\n</code></pre> <p>\u3001</p> <pre><code>kubernetes.io/dockerconfigjson\n</code></pre> <p>\u3001<code>Opaque</code> \u4e09\u79cd\u7c7b\u578b\uff0c\u800c <code>Configmap</code> \u4e0d\u533a\u5206\u7c7b\u578b</p> </li> </ul> <p>\u4f7f\u7528\u6ce8\u610f</p> <p>\u540c\u6837 Secret \u6587\u4ef6\u5927\u5c0f\u9650\u5236\u4e3a <code>1MB</code>\uff08ETCD \u7684\u8981\u6c42\uff09\uff1bSecret \u867d\u7136\u91c7\u7528 <code>Base64</code> \u7f16\u7801\uff0c\u4f46\u662f\u6211\u4eec\u8fd8\u662f\u53ef\u4ee5\u5f88\u65b9\u4fbf\u89e3\u7801\u83b7\u53d6\u5230\u539f\u59cb\u4fe1\u606f\uff0c\u6240\u4ee5\u5bf9\u4e8e\u975e\u5e38\u91cd\u8981\u7684\u6570\u636e\u8fd8\u662f\u9700\u8981\u614e\u91cd\u8003\u8651\uff0c\u53ef\u4ee5\u8003\u8651\u4f7f\u7528 Vault \u6765\u8fdb\u884c\u52a0\u5bc6\u7ba1\u7406\u3002</p>"},{"location":"kubernetes_config/service_account/","title":"ServiceAccount","text":"<p>\ue3c9</p>"},{"location":"kubernetes_config/service_account/#serviceaccount","title":"ServiceAccount","text":"<p><code>ServiceAccount</code> \u4e3b\u8981\u662f\u7528\u4e8e\u89e3\u51b3 Pod \u5728\u96c6\u7fa4\u4e2d\u7684\u8eab\u4efd\u8ba4\u8bc1\u95ee\u9898\u7684\u3002\u8ba4\u8bc1\u4f7f\u7528\u7684\u6388\u6743\u4fe1\u606f\u5176\u5b9e\u5c31\u662f\u5229\u7528\u524d\u9762\u6211\u4eec\u8bb2\u5230\u7684\u4e00\u4e2a\u7c7b\u578b\u4e3a </p> <pre><code>kubernetes.io/service-account-token\n</code></pre> <p>\u8fdb\u884c\u7ba1\u7406\u7684\u3002</p>"},{"location":"kubernetes_config/service_account/#_1","title":"\u4ecb\u7ecd","text":"<p><code>ServiceAccount</code> \u662f\u547d\u540d\u7a7a\u95f4\u7ea7\u522b\u7684\uff0c\u6bcf\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u521b\u5efa\u7684\u65f6\u5019\u5c31\u4f1a\u81ea\u52a8\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>default</code> \u7684 <code>ServiceAccount</code> \u5bf9\u8c61:</p> <pre><code>$ kubectl create ns kube-test\nnamespace/kube-test created\n$ kubectl get sa -n kube-test\nNAME      SECRETS   AGE\ndefault   1         9s\n$ kubectl get secret -n kube-test\nNAME                  TYPE                                  DATA   AGE\ndefault-token-vn4tr   kubernetes.io/service-account-token   3      2m27s\n</code></pre> <p>\u8fd9\u4e2a <code>ServiceAccount</code> \u4f1a\u81ea\u52a8\u5173\u8054\u5230\u4e00\u4e2a <code>Secret</code> \u5bf9\u8c61\u4e0a\uff1a</p> <pre><code>$ kubectl get sa default -n kube-test  -o yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  creationTimestamp: \"2019-11-23T04:19:47Z\"\n  name: default\n  namespace: kube-test\n  resourceVersion: \"4297522\"\n  selfLink: /api/v1/namespaces/kube-test/serviceaccounts/default\n  uid: 75b3314b-e949-4f7b-9450-9bcd89c8c972\nsecrets:\n- name: default-token-vn4tr\n</code></pre> <p>\u8fd9\u4e2a Secret \u5bf9\u8c61\u662f ServiceAccount \u63a7\u5236\u5668\u81ea\u52a8\u521b\u5efa\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u8fd9\u4e2a\u5173\u8054\u7684 <code>Secret</code> \u5bf9\u8c61\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get secret default-token-vn4tr -n kube-test -o yaml\napiVersion: v1\ndata:\n  ca.crt: LS0tLS...\n  namespace: a3ViZS10ZXN0\n  token: ZXlKaG...\nkind: Secret\nmetadata:\n  annotations:\n    kubernetes.io/service-account.name: default\n    kubernetes.io/service-account.uid: 75b3314b-e949-4f7b-9450-9bcd89c8c972\n  creationTimestamp: \"2019-11-23T04:19:47Z\"\n  name: default-token-vn4tr\n  namespace: kube-test\n  resourceVersion: \"4297521\"\n  selfLink: /api/v1/namespaces/kube-test/secrets/default-token-vn4tr\n  uid: e3e60f95-f255-471b-a6c0-600a3c0ee53a\ntype: kubernetes.io/service-account-token\n</code></pre> <p>\u5728 <code>data</code> \u533a\u57df\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u67093\u4e2a\u4fe1\u606f\uff1a</p> <ul> <li><code>ca.crt</code>\uff1a\u7528\u4e8e\u6821\u9a8c\u670d\u52a1\u7aef\u7684\u8bc1\u4e66\u4fe1\u606f</li> <li><code>namespace</code>\uff1a\u8868\u793a\u5f53\u524d\u7ba1\u7406\u7684\u547d\u540d\u7a7a\u95f4</li> <li><code>token</code>\uff1a\u7528\u4e8e Pod \u8eab\u4efd\u8ba4\u8bc1\u7684 Token</li> </ul> <p>\u524d\u9762\u6211\u4eec\u4e5f\u63d0\u5230\u4e86\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5f53\u524d namespace \u4e0b\u9762\u7684 Pod \u4f1a\u9ed8\u8ba4\u4f7f\u7528 <code>default</code> \u8fd9\u4e2a ServiceAccount\uff0c\u5bf9\u5e94\u7684 <code>Secret</code> \u4f1a\u81ea\u52a8\u6302\u8f7d\u5230 Pod \u7684 </p> <pre><code>/var/run/secrets/kubernetes.io/serviceaccount/\n</code></pre> <p>\u76ee\u5f55\u4e2d\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u5728 Pod \u91cc\u9762\u83b7\u53d6\u5230\u7528\u4e8e\u8eab\u4efd\u8ba4\u8bc1\u7684\u4fe1\u606f\u4e86\u3002</p>"},{"location":"kubernetes_config/service_account/#_2","title":"\u5b9e\u73b0\u539f\u7406","text":"<p>\u5b9e\u9645\u4e0a\u8fd9\u4e2a\u81ea\u52a8\u6302\u8f7d\u8fc7\u7a0b\u662f\u5728 Pod \u521b\u5efa\u7684\u65f6\u5019\u901a\u8fc7 </p> <pre><code>Admisson Controller\uff08\u51c6\u5165\u63a7\u5236\u5668\uff09\n</code></pre> <p>\u6765\u5b9e\u73b0\u7684\uff0c\u5173\u4e8e\u51c6\u5165\u63a7\u5236\u5668\u7684\u8be6\u7ec6\u4fe1\u606f\u6211\u4eec\u4f1a\u5728\u540e\u9762\u7684\u5b89\u5168\u7ae0\u8282\u4e2d\u548c\u5927\u5bb6\u7ee7\u7eed\u5b66\u4e60\u3002</p> <p>Admisson Controller</p> <p><code>Admission Controller\uff08\u51c6\u5165\u63a7\u5236\uff09 <pre><code>\u662f Kubernetes API Server \u7528\u4e8e\u62e6\u622a\u8bf7\u6c42\u7684\u4e00\u79cd\u624b\u6bb5\u3002`Admission` \u53ef\u4ee5\u505a\u5230\u5bf9\u8bf7\u6c42\u7684\u8d44\u6e90\u5bf9\u8c61\u8fdb\u884c\u6821\u9a8c\uff0c\u4fee\u6539\uff0cPod \u521b\u5efa\u65f6 `Admission Controller` \u4f1a\u6839\u636e\u6307\u5b9a\u7684\u7684 `ServiceAccount`\uff08\u9ed8\u8ba4\u7684 default\uff09\u628a\u5bf9\u5e94\u7684 `Secret` \u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\u7684\u56fa\u5b9a\u76ee\u5f55\u4e0b \n</code></pre> /var/run/secrets/kubernetes.io/serviceaccount/</code></p> <p>\u3002</p> <p>\u7136\u540e\u5f53\u6211\u4eec\u5728 Pod \u91cc\u9762\u8bbf\u95ee\u96c6\u7fa4\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u4ee5\u9ed8\u8ba4\u5229\u7528\u6302\u8f7d\u5230 Pod \u5185\u90e8\u7684 <code>token</code> \u6587\u4ef6\u6765\u8ba4\u8bc1 Pod \u7684\u8eab\u4efd\uff0c<code>ca.crt</code> \u5219\u7528\u6765\u6821\u9a8c\u670d\u52a1\u7aef\u3002\u5728 Pod \u4e2d\u8bbf\u95ee Kubernetes \u96c6\u7fa4\u7684\u4e00\u4e2a\u5178\u578b\u7684\u65b9\u5f0f\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u4ee3\u7801\u4e2d\u6211\u4eec\u6307\u5b9a\u4e86 <code>ServiceAccount</code> \u80cc\u540e\u7684 Secret \u6302\u8f7d\u5230 Pod \u91cc\u9762\u7684\u4e24\u4e2a\u6587\u4ef6\uff1a<code>token</code> \u548c <code>ca.crt</code>\uff0c\u7136\u540e\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u83b7\u53d6\u5230 APIServer \u7684\u8bbf\u95ee\u5730\u5740\uff08\u524d\u9762\u6211\u4eec\u63d0\u5230\u8fc7\u4f1a\u628a Service \u4fe1\u606f\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u7684\u65b9\u5f0f\u6ce8\u5165\u5230 Pod \u4e2d\uff09\uff0c\u7136\u540e\u901a\u8fc7 <code>ca.cart</code> \u6821\u9a8c\u670d\u52a1\u7aef\u662f\u5426\u53ef\u4fe1\uff0c\u6700\u540e\u670d\u52a1\u7aef\u4f1a\u6839\u636e\u6211\u4eec\u63d0\u4f9b\u7684 <code>token</code> \u6587\u4ef6\u5bf9 Pod \u8fdb\u884c\u8ba4\u8bc1\u3002</p> <p>Pod \u8eab\u4efd\u88ab\u8ba4\u8bc1\u5408\u6cd5\u8fc7\u540e\uff0c\u5177\u4f53\u5177\u6709\u54ea\u4e9b\u8d44\u6e90\u7684\u8bbf\u95ee\u6743\u9650\uff0c\u5c31\u9700\u8981\u901a\u8fc7\u540e\u9762\u7684 <code>RBAC</code> \u6765\u8fdb\u884c\u58f0\u660e\u4e86\u3002\u6240\u4ee5\u6211\u4eec\u5728\u5b66\u4e60 Kubernetes \u7684\u6743\u9650\u8ba4\u8bc1\u7684\u65f6\u5019\u9700\u8981\u628a\u6574\u4e2a\u6d41\u7a0b\u5f04\u6e05\u695a\uff0c<code>ServiceAccount</code> \u662f\u5e72\u561b\u7684\uff1f\u4e3a\u4ec0\u4e48\u8fd8\u9700\u8981 <code>RBAC</code>\uff1f\u8fd9\u4e9b\u90fd\u662f\u4e0a\u4e0b\u6587\u5173\u8054\u7684\u3002</p>"},{"location":"kubernetes_controller/daemonset/","title":"DaemonSet","text":"<p>\ue3c9</p>"},{"location":"kubernetes_controller/daemonset/#daemonset","title":"DaemonSet \u63a7\u5236\u5668","text":"<p>\u901a\u8fc7\u8be5\u63a7\u5236\u5668\u7684\u540d\u79f0\u6211\u4eec\u53ef\u4ee5\u770b\u51fa\u5b83\u7684\u7528\u6cd5\uff1a<code>Daemon</code>\uff0c\u5c31\u662f\u7528\u6765\u90e8\u7f72\u5b88\u62a4\u8fdb\u7a0b\u7684\uff0c<code>DaemonSet</code>\u7528\u4e8e\u5728\u6bcf\u4e2a Kubernetes \u8282\u70b9\u4e2d\u5c06\u5b88\u62a4\u8fdb\u7a0b\u7684\u526f\u672c\u4f5c\u4e3a\u540e\u53f0\u8fdb\u7a0b\u8fd0\u884c\uff0c\u8bf4\u767d\u4e86\u5c31\u662f\u5728\u6bcf\u4e2a\u8282\u70b9\u90e8\u7f72\u4e00\u4e2a Pod\u526f\u672c\uff0c\u5f53\u8282\u70b9\u52a0\u5165\u5230 Kubernetes \u96c6\u7fa4\u4e2d\uff0cPod \u4f1a\u88ab\u8c03\u5ea6\u5230\u8be5\u8282\u70b9\u4e0a\u8fd0\u884c\uff0c\u5f53\u8282\u70b9\u4ece\u96c6\u7fa4\u53ea\u80fd\u591f\u88ab\u79fb\u9664\u540e\uff0c\u8be5\u8282\u70b9\u4e0a\u7684\u8fd9\u4e2a Pod \u4e5f\u4f1a\u88ab\u79fb\u9664\uff0c\u5f53\u7136\uff0c\u5982\u679c\u6211\u4eec\u5220\u9664 DaemonSet\uff0c\u6240\u6709\u548c\u8fd9\u4e2a\u5bf9\u8c61\u76f8\u5173\u7684 Pods\u90fd\u4f1a\u88ab\u5220\u9664\u3002\u90a3\u4e48\u5728\u54ea\u79cd\u60c5\u51b5\u4e0b\u6211\u4eec\u4f1a\u9700\u8981\u7528\u5230\u8fd9\u79cd\u4e1a\u52a1\u573a\u666f\u5462\uff1f\u5176\u5b9e\u8fd9\u79cd\u573a\u666f\u8fd8\u662f\u6bd4\u8f83\u666e\u901a\u7684\uff0c\u6bd4\u5982\uff1a</p> <ul> <li>\u96c6\u7fa4\u5b58\u50a8\u5b88\u62a4\u7a0b\u5e8f\uff0c\u5982 glusterd\u3001ceph \u8981\u90e8\u7f72\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u4ee5\u63d0\u4f9b\u6301\u4e45\u6027\u5b58\u50a8\uff1b</li> <li>\u8282\u70b9\u76d1\u63a7\u5b88\u62a4\u8fdb\u7a0b\uff0c\u5982 Prometheus \u76d1\u63a7\u96c6\u7fa4\uff0c\u53ef\u4ee5\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e00\u4e2a node-exporter \u8fdb\u7a0b\u6765\u6536\u96c6\u76d1\u63a7\u8282\u70b9\u7684\u4fe1\u606f\uff1b</li> <li>\u65e5\u5fd7\u6536\u96c6\u5b88\u62a4\u7a0b\u5e8f\uff0c\u5982 fluentd \u6216 logstash\uff0c\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4ee5\u6536\u96c6\u5bb9\u5668\u7684\u65e5\u5fd7</li> <li>\u8282\u70b9\u7f51\u7edc\u63d2\u4ef6\uff0c\u6bd4\u5982 flannel\u3001calico\uff0c\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e3a Pod \u63d0\u4f9b\u7f51\u7edc\u670d\u52a1\u3002</li> </ul> <p>\u8fd9\u91cc\u9700\u8981\u7279\u522b\u8bf4\u660e\u7684\u4e00\u4e2a\u5c31\u662f\u5173\u4e8e DaemonSet \u8fd0\u884c\u7684 Pod \u7684\u8c03\u5ea6\u95ee\u9898\uff0c\u6b63\u5e38\u60c5\u51b5\u4e0b\uff0cPod \u8fd0\u884c\u5728\u54ea\u4e2a\u8282\u70b9\u4e0a\u662f\u7531 Kubernetes \u7684\u8c03\u5ea6\u5668\u7b56\u7565\u6765\u51b3\u5b9a\u7684\uff0c\u7136\u800c\uff0c\u7531 DaemonSet \u63a7\u5236\u5668\u521b\u5efa\u7684 Pod \u5b9e\u9645\u4e0a\u63d0\u524d\u5df2\u7ecf\u786e\u5b9a\u4e86\u5728\u54ea\u4e2a\u8282\u70b9\u4e0a\u4e86\uff08Pod\u521b\u5efa\u65f6\u6307\u5b9a\u4e86<code>.spec.nodeName</code>\uff09\uff0c\u6240\u4ee5\uff1a</p> <ul> <li><code>DaemonSet</code> \u5e76\u4e0d\u5173\u5fc3\u4e00\u4e2a\u8282\u70b9\u7684 <code>unshedulable</code> \u5b57\u6bb5\uff0c\u8fd9\u4e2a\u6211\u4eec\u4f1a\u5728\u540e\u9762\u7684\u8c03\u5ea6\u7ae0\u8282\u548c\u5927\u5bb6\u8bb2\u89e3\u7684\u3002</li> <li><code>DaemonSet</code> \u53ef\u4ee5\u521b\u5efa Pod\uff0c\u5373\u4f7f\u8c03\u5ea6\u5668\u8fd8\u6ca1\u6709\u542f\u52a8\u3002</li> </ul> <p>\u4e0b\u9762\u6211\u4eec\u76f4\u63a5\u4f7f\u7528\u4e00\u4e2a\u793a\u4f8b\u6765\u6f14\u793a\u4e0b\uff0c\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u90e8\u7f72\u4e00\u4e2a Nginx Pod\uff1a(nginx-ds.yaml)</p> <pre><code>apiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: nginx-ds\n  namespace: default\nspec:\n  selector:\n    matchLabels:\n      k8s-app: nginx\n  template:\n    metadata:\n      labels:\n        k8s-app: nginx\n    spec:\n      containers:\n      - image: nginx:9\n        name: nginx\n        ports:\n        - name: http\n          containerPort: 80\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u521b\u5efa\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f nginx-ds.yaml\ndaemonset.apps/nginx-ds created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u67e5\u770b Pod \u7684\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get nodes\nNAME          STATUS   ROLES    AGE     VERSION\nydzs-master   Ready    master   8d      v2\nydzs-node1    Ready    &lt;none&gt;   8d      v2\nydzs-node2    Ready    &lt;none&gt;   8d      v2\nydzs-node3    Ready    &lt;none&gt;   6d23h   v2\nydzs-node4    Ready    &lt;none&gt;   6d23h   v2\n$ kubectl get pods -l k8s-app=nginx -o wide\nNAME             READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES\nnginx-ds-bpsb7   1/1     Running   0          75s   2102   ydzs-node3   &lt;none&gt;           &lt;none&gt;\nnginx-ds-f4s2w   1/1     Running   0          75s   274    ydzs-node2   &lt;none&gt;           &lt;none&gt;\nnginx-ds-j9789   1/1     Running   0          75s   285    ydzs-node4   &lt;none&gt;           &lt;none&gt;\nnginx-ds-ngkt2   1/1     Running   0          75s   2178   ydzs-node1   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u6211\u4eec\u89c2\u5bdf\u53ef\u4ee5\u53d1\u73b0\u9664\u4e86 master \u8282\u70b9\u4e4b\u5916\u76844\u4e2a\u8282\u70b9\u4e0a\u90fd\u6709\u4e00\u4e2a\u76f8\u5e94\u7684 Pod \u8fd0\u884c\uff0c\u56e0\u4e3a master \u8282\u70b9\u4e0a\u9ed8\u8ba4\u88ab\u6253\u4e0a\u4e86<code>\u6c61\u70b9</code>\uff0c\u6240\u4ee5\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4e0d\u80fd\u8c03\u5ea6\u666e\u901a\u7684 Pod \u4e0a\u53bb\uff0c\u540e\u9762\u8bb2\u89e3\u8c03\u5ea6\u5668\u7684\u65f6\u5019\u4f1a\u548c\u5927\u5bb6\u5b66\u4e60\u5982\u4f55\u8c03\u5ea6\u4e0a\u53bb\u3002</p> <p>\u57fa\u672c\u4e0a\u6211\u4eec\u53ef\u4ee5\u7528\u4e0b\u56fe\u6765\u63cf\u8ff0 DaemonSet \u7684\u62d3\u6251\u56fe\uff1a</p> <p></p> <p>\u96c6\u7fa4\u4e2d\u7684 Pod \u548c Node \u662f<code>\u4e00\u4e00</code>\u5bf9\u5e94d\u7684\uff0c\u800c DaemonSet \u4f1a\u7ba1\u7406\u5168\u90e8\u673a\u5668\u4e0a\u7684 Pod \u526f\u672c\uff0c\u8d1f\u8d23\u5bf9\u5b83\u4eec\u8fdb\u884c\u66f4\u65b0\u548c\u5220\u9664\u3002</p> <p>\u90a3\u4e48\uff0cDaemonSet \u63a7\u5236\u5668\u662f\u5982\u4f55\u4fdd\u8bc1\u6bcf\u4e2a Node \u4e0a\u6709\u4e14\u53ea\u6709\u4e00\u4e2a\u88ab\u7ba1\u7406\u7684 Pod \u5462\uff1f</p> <ul> <li>\u9996\u5148\u63a7\u5236\u5668\u4ece Etcd \u83b7\u53d6\u5230\u6240\u6709\u7684 Node \u5217\u8868\uff0c\u7136\u540e\u904d\u5386\u6240\u6709\u7684 Node\u3002</li> <li>\u6839\u636e\u8d44\u6e90\u5bf9\u8c61\u5b9a\u4e49\u662f\u5426\u6709\u8c03\u5ea6\u76f8\u5173\u7684\u914d\u7f6e\uff0c\u7136\u540e\u5206\u522b\u68c0\u67e5 Node \u662f\u5426\u7b26\u5408\u8981\u6c42\u3002</li> <li>\u5728\u53ef\u8fd0\u884c Pod \u7684\u8282\u70b9\u4e0a\u68c0\u67e5\u662f\u5426\u5df2\u6709\u5bf9\u5e94\u7684 Pod\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u5219\u5728\u8fd9\u4e2a Node \u4e0a\u521b\u5efa\u8be5 Pod\uff1b\u5982\u679c\u6709\uff0c\u5e76\u4e14\u6570\u91cf\u5927\u4e8e 1\uff0c\u90a3\u5c31\u628a\u591a\u4f59\u7684 Pod \u4ece\u8fd9\u4e2a\u8282\u70b9\u4e0a\u5220\u9664\uff1b\u5982\u679c\u6709\u4e14\u53ea\u6709\u4e00\u4e2a Pod\uff0c\u90a3\u5c31\u8bf4\u660e\u662f\u6b63\u5e38\u60c5\u51b5\u3002</li> </ul> <p>\u5b9e\u9645\u4e0a\u5f53\u6211\u4eec\u5b66\u4e60\u4e86\u8d44\u6e90\u8c03\u5ea6\u540e\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u81ea\u5df1\u7528 Deployment \u6765\u5b9e\u73b0 DaemonSet \u7684\u6548\u679c\uff0c\u8fd9\u91cc\u6211\u4eec\u660e\u767d DaemonSet \u5982\u4f55\u4f7f\u7528\u7684\u5373\u53ef\uff0c\u5f53\u7136\u8be5\u8d44\u6e90\u5bf9\u8c61\u4e5f\u6709\u5bf9\u5e94\u7684\u66f4\u65b0\u7b56\u7565\uff0c\u6709<code>OnDelete</code>\u548c<code>RollingUpdate</code>\u4e24\u79cd\u65b9\u5f0f\uff0c\u9ed8\u8ba4\u662f\u6eda\u52a8\u66f4\u65b0\u3002</p>"},{"location":"kubernetes_controller/deployment/","title":"Deployment","text":""},{"location":"kubernetes_controller/deployment/#deployment","title":"Deployment \u63a7\u5236\u5668","text":"<p>\u524d\u9762\u6211\u4eec\u5b66\u4e60\u4e86 ReplicaSet \u63a7\u5236\u5668\uff0c\u4e86\u89e3\u5230\u8be5\u63a7\u5236\u5668\u662f\u7528\u6765\u7ef4\u62a4\u96c6\u7fa4\u4e2d\u8fd0\u884c\u7684 Pod \u6570\u91cf\u7684\uff0c\u4f46\u662f\u5f80\u5f80\u5728\u5b9e\u9645\u64cd\u4f5c\u7684\u65f6\u5019\uff0c\u6211\u4eec\u53cd\u800c\u4e0d\u4f1a\u53bb\u76f4\u63a5\u4f7f\u7528 RS\uff0c\u800c\u662f\u4f1a\u4f7f\u7528\u66f4\u4e0a\u5c42\u7684\u63a7\u5236\u5668\uff0c\u6bd4\u5982\u6211\u4eec\u4eca\u5929\u8981\u5b66\u4e60\u7684\u4e3b\u89d2 Deployment\uff0cDeployment \u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u529f\u80fd\u5c31\u662f\u5b9e\u73b0\u4e86 Pod \u7684\u6c34\u5e73\u6269\u5c55/\u6536\u7f29\uff0c\u6bd4\u5982\u6211\u4eec\u5e94\u7528\u66f4\u65b0\u4e86\uff0c\u6211\u4eec\u53ea\u9700\u8981\u66f4\u65b0\u6211\u4eec\u7684\u5bb9\u5668\u955c\u50cf\uff0c\u7136\u540e\u4fee\u6539 Deployment \u91cc\u9762\u7684 Pod \u6a21\u677f\u955c\u50cf\uff0c\u90a3\u4e48 Deployment \u5c31\u4f1a\u7528<code>\u6eda\u52a8\u66f4\u65b0\uff08Rolling Update\uff09</code>\u7684\u65b9\u5f0f\u6765\u5347\u7ea7\u73b0\u5728\u7684 Pod\uff0c\u8fd9\u4e2a\u80fd\u529b\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u56e0\u4e3a\u5bf9\u4e8e\u7ebf\u4e0a\u7684\u670d\u52a1\u6211\u4eec\u9700\u8981\u505a\u5230\u4e0d\u4e2d\u65ad\u670d\u52a1\uff0c\u6240\u4ee5\u6eda\u52a8\u66f4\u65b0\u5c31\u6210\u4e86\u5fc5\u987b\u7684\u4e00\u4e2a\u529f\u80fd\u3002\u800c Deployment \u8fd9\u4e2a\u80fd\u529b\u7684\u5b9e\u73b0\uff0c\u4f9d\u8d56\u7684\u5c31\u662f\u4e0a\u8282\u8bfe\u6211\u4eec\u5b66\u4e60\u7684 ReplicaSet \u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff0c\u5b9e\u9645\u4e0a\u6211\u4eec\u53ef\u4ee5\u901a\u4fd7\u7684\u7406\u89e3\u5c31\u662f<code>\u6bcf\u4e2a Deployment \u5c31\u5bf9\u5e94\u96c6\u7fa4\u4e2d\u7684\u4e00\u6b21\u90e8\u7f72</code>\uff0c\u8fd9\u6837\u5c31\u66f4\u597d\u7406\u89e3\u4e86\u3002</p>"},{"location":"kubernetes_controller/deployment/#deployment_1","title":"Deployment","text":"<p>Deployment \u8d44\u6e90\u5bf9\u8c61\u7684\u683c\u5f0f\u548c ReplicaSet \u51e0\u4e4e\u4e00\u81f4\uff0c\u5982\u4e0b\u8d44\u6e90\u5bf9\u8c61\u5c31\u662f\u4e00\u4e2a\u5e38\u89c1\u7684 Deployment \u8d44\u6e90\u7c7b\u578b\uff1a\uff08nginx-deploy.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Deployment  \nmetadata:\n  name:  nginx-deploy\n  namespace: default\nspec:\n  replicas: 3  # \u671f\u671b\u7684 Pod \u526f\u672c\u6570\u91cf\uff0c\u9ed8\u8ba4\u503c\u4e3a1\n  selector:  # Label Selector\uff0c\u5fc5\u987b\u5339\u914d Pod \u6a21\u677f\u4e2d\u7684\u6807\u7b7e\n    matchLabels:\n      app: nginx\n  template:  # Pod \u6a21\u677f\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx\n        ports:\n        - containerPort: 80\n</code></pre> <p>\u6211\u4eec\u8fd9\u91cc\u53ea\u662f\u5c06\u7c7b\u578b\u66ff\u6362\u6210\u4e86 Deployment\uff0c\u6211\u4eec\u53ef\u4ee5\u5148\u6765\u521b\u5efa\u4e0b\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f nginx-deploy.yaml\ndeployment.apps/nginx-deploy created\n$ kubectl get deployment\nNAME           READY   UP-TO-DATE   AVAILABLE   AGE\nnginx-deploy   3/3     3            3           58s\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u67e5\u770b Pod \u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pods -l app=nginx\nNAME                            READY   STATUS    RESTARTS   AGE\nnginx-deploy-85ff79dd56-7r76h   1/1     Running   0          41s\nnginx-deploy-85ff79dd56-d5gjs   1/1     Running   0          41s\nnginx-deploy-85ff79dd56-txc4h   1/1     Running   0          41s\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u53d1\u73b0\u548c\u4e4b\u524d\u7684 RS \u5bf9\u8c61\u662f\u5426\u6ca1\u6709\u4ec0\u4e48\u4e24\u6837\uff0c\u90fd\u662f\u6839\u636e<code>spec.replicas</code>\u6765\u7ef4\u6301\u7684\u526f\u672c\u6570\u91cf\uff0c\u6211\u4eec\u968f\u610f\u67e5\u770b\u4e00\u4e2a Pod \u7684\u63cf\u8ff0\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe pod nginx-deploy-85ff79dd56-txc4h\nName:               nginx-deploy-85ff79dd56-txc4h\nNamespace:          default\nPriority:           0\nPriorityClassName:  &lt;none&gt;\nNode:               ydzs-node1/122\nStart Time:         Sat, 16 Nov 2019 16:01:25 +0800\nLabels:             app=nginx\n                    pod-template-hash=85ff79dd56\nAnnotations:        podpreset.admission.kubernetes.io/podpreset-time-preset: 2062768\nStatus:             Running\nIP:                 2166\nControlled By:      ReplicaSet/nginx-deploy-85ff79dd56\n......\nEvents:\n  Type    Reason     Age        From                 Message\n  ----    ------     ----       ----                 -------\n  Normal  Scheduled  &lt;unknown&gt;  default-scheduler    Successfully assigned default/nginx-deploy-85ff79dd56-txc4h to ydzs-node1\n  Normal  Pulling    2m         kubelet, ydzs-node1  Pulling image \"nginx\"\n  Normal  Pulled     117s       kubelet, ydzs-node1  Successfully pulled image \"nginx\"\n  Normal  Created    117s       kubelet, ydzs-node1  Created container nginx\n  Normal  Started    116s       kubelet, ydzs-node1  Started container nginx\n</code></pre> <p>\u6211\u4eec\u4ed4\u7ec6\u67e5\u770b\u5176\u4e2d\u6709\u8fd9\u6837\u4e00\u4e2a\u4fe1\u606f</p> <pre><code>Controlled By: ReplicaSet/nginx-deploy-85ff79dd56\n</code></pre> <p>\uff0c\u4ec0\u4e48\u610f\u601d\uff1f\u662f\u4e0d\u662f\u8868\u793a\u5f53\u524d\u6211\u4eec\u8fd9\u4e2a Pod \u7684\u63a7\u5236\u5668\u662f\u4e00\u4e2a ReplicaSet \u5bf9\u8c61\u554a\uff0c\u6211\u4eec\u4e0d\u662f\u521b\u5efa\u7684\u4e00\u4e2a Deployment \u5417\uff1f\u4e3a\u4ec0\u4e48 Pod \u4f1a\u88ab RS \u6240\u63a7\u5236\u5462\uff1f\u90a3\u6211\u4eec\u518d\u53bb\u770b\u4e0b\u8fd9\u4e2a\u5bf9\u5e94\u7684 RS \u5bf9\u8c61\u7684\u8be6\u7ec6\u4fe1\u606f\u5982\u4f55\u5462\uff1a</p> <pre><code>$ kubectl describe rs nginx-deploy-85ff79dd56\nName:           nginx-deploy-85ff79dd56\nNamespace:      default\nSelector:       app=nginx,pod-template-hash=85ff79dd56\nLabels:         app=nginx\n                pod-template-hash=85ff79dd56\nAnnotations:    deployment.kubernetes.io/desired-replicas: 3\n                deployment.kubernetes.io/max-replicas: 4\n                deployment.kubernetes.io/revision: 1\nControlled By:  Deployment/nginx-deploy\nReplicas:       3 current / 3 desired\nPods Status:    3 Running / 0 Waiting / 0 Succeeded / 0 Failed\n......\nEvents:\n  Type    Reason            Age    From                   Message\n  ----    ------            ----   ----                   -------\n  Normal  SuccessfulCreate  4m52s  replicaset-controller  Created pod: nginx-deploy-85ff79dd56-7r76h\n  Normal  SuccessfulCreate  4m52s  replicaset-controller  Created pod: nginx-deploy-85ff79dd56-d5gjs\n  Normal  SuccessfulCreate  4m52s  replicaset-controller  Created pod: nginx-deploy-85ff79dd56-txc4h\n</code></pre> <p>\u5176\u4e2d\u6709\u8fd9\u6837\u7684\u4e00\u4e2a\u4fe1\u606f\uff1a</p> <pre><code>Controlled By: Deployment/nginx-deploy\n</code></pre> <p>\uff0c\u660e\u767d\u4e86\u5427\uff1f\u610f\u601d\u5c31\u662f\u6211\u4eec\u7684 Pod \u4f9d\u8d56\u7684\u63a7\u5236\u5668 RS \u5b9e\u9645\u4e0a\u88ab\u6211\u4eec\u7684 Deployment \u63a7\u5236\u7740\u5462\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u4e0b\u56fe\u6765\u8bf4\u660e Pod\u3001ReplicaSet\u3001Deployment \u4e09\u8005\u4e4b\u95f4\u7684\u5173\u7cfb\uff1a</p> <p></p> <p>\u901a\u8fc7\u4e0a\u56fe\u6211\u4eec\u53ef\u4ee5\u5f88\u6e05\u695a\u7684\u770b\u5230\uff0c\u5b9a\u4e49\u4e863\u4e2a\u526f\u672c\u7684 Deployment \u4e0e ReplicaSet \u548c Pod \u7684\u5173\u7cfb\uff0c\u5c31\u662f\u4e00\u5c42\u4e00\u5c42\u8fdb\u884c\u63a7\u5236\u7684\u3002ReplicaSet \u4f5c\u7528\u548c\u4e4b\u524d\u4e00\u6837\u8fd8\u662f\u6765\u4fdd\u8bc1 Pod \u7684\u4e2a\u6570\u59cb\u7ec8\u4fdd\u5b58\u6307\u5b9a\u7684\u6570\u91cf\uff0c\u6240\u4ee5 Deployment \u4e2d\u7684\u5bb9\u5668 <code>restartPolicy=Always</code> \u662f\u552f\u4e00\u7684\u5c31\u662f\u8fd9\u4e2a\u539f\u56e0\uff0c\u56e0\u4e3a\u5bb9\u5668\u5fc5\u987b\u59cb\u7ec8\u4fdd\u8bc1\u81ea\u5df1\u5904\u4e8e Running \u72b6\u6001\uff0cReplicaSet \u624d\u53ef\u4ee5\u53bb\u660e\u786e\u8c03\u6574 Pod \u7684\u4e2a\u6570\u3002\u800c Deployment \u662f\u901a\u8fc7\u7ba1\u7406 ReplicaSet \u7684\u6570\u91cf\u548c\u5c5e\u6027\u6765\u5b9e\u73b0<code>\u6c34\u5e73\u6269\u5c55/\u6536\u7f29</code>\u4ee5\u53ca<code>\u6eda\u52a8\u66f4\u65b0</code>\u4e24\u4e2a\u529f\u80fd\u7684\u3002</p>"},{"location":"kubernetes_controller/deployment/#_1","title":"\u6c34\u5e73\u4f38\u7f29","text":"<p><code>\u6c34\u5e73\u6269\u5c55/\u6536\u7f29</code>\u7684\u529f\u80fd\u6bd4\u8f83\u7b80\u5355\uff0c\u56e0\u4e3a ReplicaSet \u5c31\u53ef\u4ee5\u5b9e\u73b0\uff0c\u6240\u4ee5 Deployment \u63a7\u5236\u5668\u53ea\u9700\u8981\u53bb\u4fee\u6539\u5b83\u7f29\u63a7\u5236\u7684 ReplicaSet \u7684 Pod \u526f\u672c\u6570\u91cf\u5c31\u53ef\u4ee5\u4e86\u3002\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u628a Pod \u7684\u526f\u672c\u8c03\u6574\u5230 4 \u4e2a\uff0c\u90a3\u4e48 Deployment \u6240\u5bf9\u5e94\u7684 ReplicaSet \u5c31\u4f1a\u81ea\u52a8\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 Pod \u51fa\u6765\uff0c\u8fd9\u6837\u5c31\u6c34\u5e73\u6269\u5c55\u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a\u65b0\u7684\u547d\u4ee4 <code>kubectl scale</code> \u547d\u4ee4\u6765\u5b8c\u6210\u8fd9\u4e2a\u64cd\u4f5c\uff1a</p> <pre><code>$ kubectl scale deployment nginx-deploy --replicas=4\ndeployment.apps/nginx-deployment scaled\n</code></pre> <p>\u6269\u5c55\u5b8c\u6210\u540e\u53ef\u4ee5\u67e5\u770b\u5f53\u524d\u7684 RS \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl get rs\nNAME                      DESIRED   CURRENT   READY   AGE\nnginx-deploy-85ff79dd56   4         4         3       40m\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u671f\u671b\u7684 Pod \u6570\u91cf\u5df2\u7ecf\u53d8\u6210 4 \u4e86\uff0c\u53ea\u662f Pod \u8fd8\u6ca1\u51c6\u5907\u5b8c\u6210\uff0c\u6240\u4ee5 READY \u72b6\u6001\u6570\u91cf\u8fd8\u662f 3\uff0c\u540c\u6837\u67e5\u770b RS \u7684\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe rs nginx-deploy-85ff79dd56\nName:           nginx-deploy-85ff79dd56\nNamespace:      default\nSelector:       app=nginx,pod-template-hash=85ff79dd56\n......\nEvents:\n  Type    Reason            Age   From                   Message\n  ----    ------            ----  ----                   -------\n  Normal  SuccessfulCreate  40m   replicaset-controller  Created pod: nginx-deploy-85ff79dd56-7r76h\n  Normal  SuccessfulCreate  40m   replicaset-controller  Created pod: nginx-deploy-85ff79dd56-d5gjs\n  Normal  SuccessfulCreate  40m   replicaset-controller  Created pod: nginx-deploy-85ff79dd56-txc4h\n  Normal  SuccessfulCreate  17s   replicaset-controller  Created pod: nginx-deploy-85ff79dd56-tph9g\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 ReplicaSet \u63a7\u5236\u5668\u589e\u52a0\u4e86\u4e00\u4e2a\u65b0\u7684 Pod\uff0c\u540c\u6837\u7684 Deployment \u8d44\u6e90\u5bf9\u8c61\u7684\u4e8b\u4ef6\u4e2d\u4e5f\u53ef\u4ee5\u770b\u5230\u5b8c\u6210\u4e86\u6269\u5bb9\u7684\u64cd\u4f5c\uff1a</p> <pre><code>$ kubectl describe deploy nginx-deploy\nName:                   nginx-deploy\nNamespace:              default\n......\nOldReplicaSets:  &lt;none&gt;\nNewReplicaSet:   nginx-deploy-85ff79dd56 (4/4 replicas created)\nEvents:\n  Type    Reason             Age    From                   Message\n  ----    ------             ----   ----                   -------\n  Normal  ScalingReplicaSet  43m    deployment-controller  Scaled up replica set nginx-deploy-85ff79dd56 to 3\n  Normal  ScalingReplicaSet  3m16s  deployment-controller  Scaled up replica set nginx-deploy-85ff79dd56 to 4\n</code></pre>"},{"location":"kubernetes_controller/deployment/#_2","title":"\u6eda\u52a8\u66f4\u65b0","text":"<p>\u5982\u679c\u53ea\u662f<code>\u6c34\u5e73\u6269\u5c55/\u6536\u7f29</code>\u8fd9\u4e24\u4e2a\u529f\u80fd\uff0c\u5c31\u5b8c\u5168\u6ca1\u5fc5\u8981\u8bbe\u8ba1 Deployment \u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u4e86\uff0cDeployment \u6700\u7a81\u51fa\u7684\u4e00\u4e2a\u529f\u80fd\u662f\u652f\u6301<code>\u6eda\u52a8\u66f4\u65b0</code>\uff0c\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u9700\u8981\u628a\u5e94\u7528\u5bb9\u5668\u66f4\u6539\u4e3a <code>nginx:1.7.9</code> \u7248\u672c\uff0c\u4fee\u6539\u540e\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: Deployment  \nmetadata:\n  name:  nginx-deploy\n  namespace: default\nspec:\n  replicas: 3  \n  selector:  \n    matchLabels:\n      app: nginx\n  minReadySeconds: 5\n  strategy:  \n    type: RollingUpdate  # \u6307\u5b9a\u66f4\u65b0\u7b56\u7565\uff1aRollingUpdate\u548cRecreate\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 1\n  template:  \n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:9\n        ports:\n        - containerPort: 80\n</code></pre> <p>\u540e\u524d\u9762\u76f8\u6bd4\u8f83\uff0c\u9664\u4e86\u66f4\u6539\u4e86\u955c\u50cf\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u6307\u5b9a\u4e86\u66f4\u65b0\u7b56\u7565\uff1a</p> <pre><code>minReadySeconds: 5\nstrategy:\n  type: RollingUpdate\n  rollingUpdate:\n    maxSurge: 1\n    maxUnavailable: 1\n</code></pre> <ul> <li><code>minReadySeconds</code>\uff1a\u8868\u793a Kubernetes \u5728\u7b49\u5f85\u8bbe\u7f6e\u7684\u65f6\u95f4\u540e\u624d\u8fdb\u884c\u5347\u7ea7\uff0c\u5982\u679c\u6ca1\u6709\u8bbe\u7f6e\u8be5\u503c\uff0cKubernetes \u4f1a\u5047\u8bbe\u8be5\u5bb9\u5668\u542f\u52a8\u8d77\u6765\u540e\u5c31\u63d0\u4f9b\u670d\u52a1\u4e86\uff0c\u5982\u679c\u6ca1\u6709\u8bbe\u7f6e\u8be5\u503c\uff0c\u5728\u67d0\u4e9b\u6781\u7aef\u60c5\u51b5\u4e0b\u53ef\u80fd\u4f1a\u9020\u6210\u670d\u52a1\u4e0d\u6b63\u5e38\u8fd0\u884c\uff0c\u9ed8\u8ba4\u503c\u5c31\u662f0\u3002</li> <li><code>type=RollingUpdate</code>\uff1a\u8868\u793a\u8bbe\u7f6e\u66f4\u65b0\u7b56\u7565\u4e3a\u6eda\u52a8\u66f4\u65b0\uff0c\u53ef\u4ee5\u8bbe\u7f6e\u4e3a<code>Recreate</code>\u548c<code>RollingUpdate</code>\u4e24\u4e2a\u503c\uff0c<code>Recreate</code>\u8868\u793a\u5168\u90e8\u91cd\u65b0\u521b\u5efa\uff0c\u9ed8\u8ba4\u503c\u5c31\u662f<code>RollingUpdate</code>\u3002</li> <li> <p><code>maxSurge</code>\uff1a\u8868\u793a\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u6700\u591a\u53ef\u4ee5\u6bd4\u539f\u5148\u8bbe\u7f6e\u591a\u51fa\u7684 Pod \u6570\u91cf\uff0c\u4f8b\u5982\uff1a</p> <pre><code>maxSurage=1\uff0creplicas=5\n</code></pre> <p>\uff0c\u5c31\u8868\u793aKubernetes \u4f1a\u5148\u542f\u52a8\u4e00\u4e2a\u65b0\u7684 Pod\uff0c\u7136\u540e\u624d\u5220\u6389\u4e00\u4e2a\u65e7\u7684 Pod\uff0c\u6574\u4e2a\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u6700\u591a\u4f1a\u6709<code>5+1</code>\u4e2a Pod\u3002 *   <code>maxUnavaible</code>\uff1a\u8868\u793a\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u6700\u591a\u6709\u591a\u5c11\u4e2a Pod \u5904\u4e8e\u65e0\u6cd5\u63d0\u4f9b\u670d\u52a1\u7684\u72b6\u6001\uff0c\u5f53<code>maxSurge</code>\u4e0d\u4e3a0\u65f6\uff0c\u8be5\u503c\u4e5f\u4e0d\u80fd\u4e3a0\uff0c\u4f8b\u5982\uff1a<code>maxUnavaible=1</code>\uff0c\u5219\u8868\u793a Kubernetes \u6574\u4e2a\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u6700\u591a\u4f1a\u67091\u4e2a Pod \u5904\u4e8e\u65e0\u6cd5\u670d\u52a1\u7684\u72b6\u6001\u3002</p> </li> </ul> <p>\u73b0\u5728\u6211\u4eec\u6765\u76f4\u63a5\u66f4\u65b0\u4e0a\u9762\u7684 Deployment \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f nginx-deploy.yaml\n</code></pre> <p>record \u53c2\u6570</p> <p>\u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0\u4e86\u4e00\u4e2a\u989d\u5916\u7684 <code>--record</code> \u53c2\u6570\u6765\u8bb0\u5f55\u4e0b\u6211\u4eec\u7684\u6bcf\u6b21\u64cd\u4f5c\u6240\u6267\u884c\u7684\u547d\u4ee4\uff0c\u4ee5\u65b9\u4fbf\u540e\u9762\u67e5\u770b\u3002</p> <p>\u66f4\u65b0\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u6267\u884c\u4e0b\u9762\u7684 </p> <pre><code>kubectl rollout status\n</code></pre> <p>\u547d\u4ee4\u6765\u67e5\u770b\u6211\u4eec\u6b64\u6b21\u6eda\u52a8\u66f4\u65b0\u7684\u72b6\u6001\uff1a</p> <pre><code>$ kubectl rollout status deployment/nginx-deploy\nWaiting for deployment \"nginx-deploy\" rollout to finish: 2 out of 3 new replicas have been updated...\n</code></pre> <p>\u4ece\u4e0a\u9762\u7684\u4fe1\u606f\u53ef\u4ee5\u770b\u51fa\u6211\u4eec\u7684\u6eda\u52a8\u66f4\u65b0\u5df2\u7ecf\u6709\u4e24\u4e2a Pod \u5df2\u7ecf\u66f4\u65b0\u5b8c\u6210\u4e86\uff0c\u5728\u6eda\u52a8\u66f4\u65b0\u8fc7\u7a0b\u4e2d\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u6267\u884c\u5982\u4e0b\u7684\u547d\u4ee4\u6765\u6682\u505c\u66f4\u65b0\uff1a</p> <pre><code>$ kubectl rollout pause deployment/nginx-deploy\ndeployment.apps/nginx-deploy paused\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u7684\u6eda\u52a8\u66f4\u65b0\u5c31\u6682\u505c\u4e86\uff0c\u6b64\u65f6\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u4e0b Deployment \u7684\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe deploy nginx-deploy\nName:                   nginx-deploy\nNamespace:              default\nCreationTimestamp:      Sat, 16 Nov 2019 16:01:24 +0800\nLabels:                 &lt;none&gt;\nAnnotations:            deployment.kubernetes.io/revision: 2\n                        kubectl.kubernetes.io/last-applied-configuration:\n                          {\"apiVersion\":\"apps/v1\",\"kind\":\"Deployment\",\"metadata\":{\"annotations\":{},\"name\":\"nginx-deploy\",\"namespace\":\"default\"},\"spec\":{\"minReadySec...\nSelector:               app=nginx\nReplicas:               3 desired | 2 updated | 4 total | 4 available | 0 unavailable\nStrategyType:           RollingUpdate\nMinReadySeconds:        5\nRollingUpdateStrategy:  1 max unavailable, 1 max surge\n......\nOldReplicaSets:  nginx-deploy-85ff79dd56 (2/2 replicas created)\nNewReplicaSet:   nginx-deploy-5b7b9ccb95 (2/2 replicas created)\nEvents:\n  Type    Reason             Age    From                   Message\n  ----    ------             ----   ----                   -------\n  Normal  ScalingReplicaSet  26m    deployment-controller  Scaled up replica set nginx-deploy-85ff79dd56 to 4\n  Normal  ScalingReplicaSet  3m44s  deployment-controller  Scaled down replica set nginx-deploy-85ff79dd56 to 3\n  Normal  ScalingReplicaSet  3m44s  deployment-controller  Scaled up replica set nginx-deploy-5b7b9ccb95 to 1\n  Normal  ScalingReplicaSet  3m44s  deployment-controller  Scaled down replica set nginx-deploy-85ff79dd56 to 2\n  Normal  ScalingReplicaSet  3m44s  deployment-controller  Scaled up replica set nginx-deploy-5b7b9ccb95 to 2\n</code></pre> <p></p> <p>\u6211\u4eec\u4ed4\u7ec6\u89c2\u5bdf Events \u4e8b\u4ef6\u533a\u57df\u7684\u53d8\u5316\uff0c\u4e0a\u9762\u6211\u4eec\u7528 <code>kubectl scale</code> \u547d\u4ee4\u5c06 Pod \u526f\u672c\u8c03\u6574\u5230\u4e86 4\uff0c\u73b0\u5728\u6211\u4eec\u66f4\u65b0\u7684\u65f6\u5019\u662f\u4e0d\u662f\u58f0\u660e\u53c8\u53d8\u6210 3 \u4e86\uff0c\u6240\u4ee5 Deployment \u63a7\u5236\u5668\u9996\u5148\u662f\u5c06\u4e4b\u524d\u63a7\u5236\u7684 </p> <pre><code>nginx-deploy-85ff79dd56\n</code></pre> <p>\u8fd9\u4e2a RS \u8d44\u6e90\u5bf9\u8c61\u8fdb\u884c\u7f29\u5bb9\u64cd\u4f5c\uff0c\u7136\u540e\u6eda\u52a8\u66f4\u65b0\u5f00\u59cb\u4e86\uff0c\u53ef\u4ee5\u53d1\u73b0 Deployment \u4e3a\u4e00\u4e2a\u65b0\u7684 </p> <pre><code>nginx-deploy-5b7b9ccb95\n</code></pre> <p>RS \u8d44\u6e90\u5bf9\u8c61\u9996\u5148\u65b0\u5efa\u4e86\u4e00\u4e2a\u65b0\u7684 Pod\uff0c\u7136\u540e\u5c06\u4e4b\u524d\u7684 RS \u5bf9\u8c61\u7f29\u5bb9\u5230 2 \u4e86\uff0c\u518d\u7136\u540e\u65b0\u7684 RS \u5bf9\u8c61\u6269\u5bb9\u5230 2\uff0c\u540e\u9762\u7531\u4e8e\u6211\u4eec\u6682\u505c\u6eda\u52a8\u5347\u7ea7\u4e86\uff0c\u6240\u4ee5\u6ca1\u6709\u540e\u7eed\u7684\u4e8b\u4ef6\u4e86\uff0c\u5927\u5bb6\u6709\u770b\u660e\u767d\u8fd9\u4e2a\u8fc7\u7a0b\u5427\uff1f\u8fd9\u4e2a\u8fc7\u7a0b\u5c31\u662f\u6eda\u52a8\u66f4\u65b0\u7684\u8fc7\u7a0b\uff0c\u542f\u52a8\u4e00\u4e2a\u65b0\u7684 Pod\uff0c\u6740\u6389\u4e00\u4e2a\u65e7\u7684 Pod\uff0c\u7136\u540e\u518d\u542f\u52a8\u4e00\u4e2a\u65b0\u7684 Pod\uff0c\u8fd9\u6837\u6eda\u52a8\u66f4\u65b0\u4e0b\u53bb\uff0c\u76f4\u5230\u5168\u90fd\u53d8\u6210\u65b0\u7684 Pod\uff0c\u8fd9\u4e2a\u65f6\u5019\u7cfb\u7edf\u4e2d\u5e94\u8be5\u5b58\u5728 4 \u4e2a Pod\uff0c\u56e0\u4e3a\u6211\u4eec\u8bbe\u7f6e\u7684\u7b56\u7565<code>maxSurge=1</code>\uff0c\u6240\u4ee5\u5728\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u662f\u5141\u8bb8\u7684\uff0c\u800c\u4e14\u662f\u4e24\u4e2a\u65b0\u7684 Pod\uff0c\u4e24\u4e2a\u65e7\u7684 Pod\uff1a</p> <pre><code>$ kubectl get pods -l app=nginx\nNAME                            READY   STATUS    RESTARTS   AGE\nnginx-deploy-5b7b9ccb95-k6pkh   1/1     Running   0          11m\nnginx-deploy-5b7b9ccb95-l6lmx   1/1     Running   0          11m\nnginx-deploy-85ff79dd56-7r76h   1/1     Running   0          75m\nnginx-deploy-85ff79dd56-txc4h   1/1     Running   0          75m\n</code></pre> <p>\u67e5\u770b Deployment \u7684\u72b6\u6001\u4e5f\u53ef\u4ee5\u770b\u5230\u5f53\u524d\u7684 Pod \u72b6\u6001\uff1a</p> <pre><code>$ kubectl get deployment  \nNAME           READY   UP-TO-DATE   AVAILABLE   AGE\nnginx-deploy   4/3     2            4           75m\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528</p> <pre><code>kubectl rollout resume\n</code></pre> <p>\u6765\u6062\u590d\u6211\u4eec\u7684\u6eda\u52a8\u66f4\u65b0\uff1a</p> <pre><code>$ kubectl rollout resume deployment/nginx-deploy\ndeployment.apps/nginx-deploy resumed\n$ kubectl rollout status deployment/nginx-deploy\nWaiting for deployment \"nginx-deploy\" rollout to finish: 2 of 3 updated replicas are available...\ndeployment \"nginx-deploy\" successfully rolled out\n</code></pre> <p>\u770b\u5230\u4e0a\u9762\u7684\u4fe1\u606f\u8bc1\u660e\u6211\u4eec\u7684\u6eda\u52a8\u66f4\u65b0\u5df2\u7ecf\u6210\u529f\u4e86\uff0c\u540c\u6837\u53ef\u4ee5\u67e5\u770b\u4e0b\u8d44\u6e90\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pod -l app=nginx\nNAME                            READY   STATUS    RESTARTS   AGE\nnginx-deploy-5b7b9ccb95-gmq7v   1/1     Running   0          115s\nnginx-deploy-5b7b9ccb95-k6pkh   1/1     Running   0          15m\nnginx-deploy-5b7b9ccb95-l6lmx   1/1     Running   0          15m\n$ kubectl get deployment                        \nNAME           READY   UP-TO-DATE   AVAILABLE   AGE\nnginx-deploy   3/3     3            3           79m\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u67e5\u770b ReplicaSet \u5bf9\u8c61\uff0c\u53ef\u4ee5\u53d1\u73b0\u4f1a\u51fa\u73b0\u4e24\u4e2a\uff1a</p> <pre><code>$ kubectl get rs -l app=nginx\nNAME                      DESIRED   CURRENT   READY   AGE\nnginx-deploy-5b7b9ccb95   3         3         3       18m\nnginx-deploy-85ff79dd56   0         0         0       81m\n</code></pre> <p>\u4ece\u4e0a\u9762\u53ef\u4ee5\u770b\u51fa\u6eda\u52a8\u66f4\u65b0\u4e4b\u524d\u6211\u4eec\u4f7f\u7528\u7684 RS \u8d44\u6e90\u5bf9\u8c61\u7684 Pod \u526f\u672c\u6570\u5df2\u7ecf\u53d8\u6210 0 \u4e86\uff0c\u800c\u6eda\u52a8\u66f4\u65b0\u540e\u7684 RS \u8d44\u6e90\u5bf9\u8c61\u53d8\u6210\u4e86 3 \u4e2a\u526f\u672c\uff0c\u6211\u4eec\u53ef\u4ee5\u5bfc\u51fa\u4e4b\u524d\u7684 RS \u5bf9\u8c61\u67e5\u770b\uff1a</p> <pre><code>$ kubectl get rs nginx-deploy-85ff79dd56 -o yaml\napiVersion: apps/v1\nkind: ReplicaSet\nmetadata:\n  annotations:\n    deployment.kubernetes.io/desired-replicas: \"3\"\n    deployment.kubernetes.io/max-replicas: \"4\"\n    deployment.kubernetes.io/revision: \"1\"\n  creationTimestamp: \"2019-11-16T08:01:24Z\"\n  generation: 5\n  labels:\n    app: nginx\n    pod-template-hash: 85ff79dd56\n  name: nginx-deploy-85ff79dd56\n  namespace: default\n  ownerReferences:\n  - apiVersion: apps/v1\n    blockOwnerDeletion: true\n    controller: true\n    kind: Deployment\n    name: nginx-deploy\n    uid: b0fc5614-ef58-496c-9111-740353bd90d4\n  resourceVersion: \"2140545\"\n  selfLink: /apis/apps/v1/namespaces/default/replicasets/nginx-deploy-85ff79dd56\n  uid: 8eca2998-3610-4f80-9c21-5482ba579892\nspec:\n  replicas: 0\n  selector:\n    matchLabels:\n      app: nginx\n      pod-template-hash: 85ff79dd56\n  template:\n    metadata:\n      creationTimestamp: null\n      labels:\n        app: nginx\n        pod-template-hash: 85ff79dd56\n    spec:\n      containers:\n      - image: nginx\n        imagePullPolicy: Always\n        name: nginx\n        ports:\n        - containerPort: 80\n          protocol: TCP\n        resources: {}\n        terminationMessagePath: /dev/termination-log\n        terminationMessagePolicy: File\n      dnsPolicy: ClusterFirst\n      restartPolicy: Always\n      schedulerName: default-scheduler\n      securityContext: {}\n      terminationGracePeriodSeconds: 30\nstatus:\n  observedGeneration: 5\n  replicas: 0\n</code></pre> <p>\u6211\u4eec\u4ed4\u7ec6\u89c2\u5bdf\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u91cc\u9762\u7684\u63cf\u8ff0\u4fe1\u606f\u9664\u4e86\u526f\u672c\u6570\u53d8\u6210\u4e86<code>replicas=0</code>\u4e4b\u5916\uff0c\u548c\u66f4\u65b0\u4e4b\u524d\u6ca1\u6709\u4ec0\u4e48\u533a\u522b\u5427\uff1f\u5927\u5bb6\u770b\u5230\u8fd9\u91cc\u60f3\u5230\u4e86\u4ec0\u4e48\uff1f\u6709\u4e86\u8fd9\u4e2a RS \u7684\u8bb0\u5f55\u5b58\u5728\uff0c\u662f\u4e0d\u662f\u6211\u4eec\u5c31\u53ef\u4ee5\u56de\u6eda\u4e86\u554a\uff1f\u800c\u4e14\u8fd8\u53ef\u4ee5\u56de\u6eda\u5230\u524d\u9762\u7684\u4efb\u610f\u4e00\u4e2a\u7248\u672c\uff0c\u8fd9\u4e2a\u7248\u672c\u662f\u5982\u4f55\u5b9a\u4e49\u7684\u5462\uff1f\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4 <code>rollout history</code> \u6765\u83b7\u53d6\uff1a</p> <pre><code>$ kubectl rollout history deployment nginx-deploy\ndeployment.apps/nginx-deploy \nREVISION  CHANGE-CAUSE\n1         &lt;none&gt;\n2         &lt;none&gt;\n</code></pre> <p>\u5176\u5b9e <code>rollout history</code> \u4e2d\u8bb0\u5f55\u7684 <code>revision</code> \u662f\u548c <code>ReplicaSets</code> \u4e00\u4e00\u5bf9\u5e94\u3002\u5982\u679c\u6211\u4eec\u624b\u52a8\u5220\u9664\u67d0\u4e2a <code>ReplicaSet</code>\uff0c\u5bf9\u5e94\u7684<code>rollout history</code>\u5c31\u4f1a\u88ab\u5220\u9664\uff0c\u4e5f\u5c31\u662f\u8bf4\u4f60\u65e0\u6cd5\u56de\u6eda\u5230\u8fd9\u4e2a<code>revison</code>\u4e86\uff0c\u540c\u6837\u6211\u4eec\u8fd8\u53ef\u4ee5\u67e5\u770b\u4e00\u4e2a<code>revison</code>\u7684\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl rollout history deployment nginx-deploy --revision=1 \ndeployment.apps/nginx-deploy with revision #1\nPod Template:\n  Labels:       app=nginx\n        pod-template-hash=85ff79dd56\n  Containers:\n   nginx:\n    Image:      nginx\n    Port:       80/TCP\n    Host Port:  0/TCP\n    Environment:        &lt;none&gt;\n    Mounts:     &lt;none&gt;\n  Volumes:      &lt;none&gt;\n</code></pre> <p>\u5047\u5982\u73b0\u5728\u8981\u76f4\u63a5\u56de\u9000\u5230\u5f53\u524d\u7248\u672c\u7684\u524d\u4e00\u4e2a\u7248\u672c\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u8fdb\u884c\u64cd\u4f5c\uff1a</p> <pre><code>$ kubectl rollout undo deployment nginx-deploy\n</code></pre> <p>\u5f53\u7136\u4e5f\u53ef\u4ee5\u56de\u9000\u5230\u6307\u5b9a\u7684<code>revision</code>\u7248\u672c\uff1a</p> <pre><code>$ kubectl rollout undo deployment nginx-deploy --to-revision=1\ndeployment \"nginx-deploy\" rolled back\n</code></pre> <p>\u56de\u6eda\u7684\u8fc7\u7a0b\u4e2d\u6211\u4eec\u540c\u6837\u53ef\u4ee5\u67e5\u770b\u56de\u6eda\u72b6\u6001\uff1a</p> <pre><code>$ kubectl rollout status deployment/nginx-deploy\nWaiting for deployment \"nginx-deploy\" rollout to finish: 1 old replicas are pending termination...\nWaiting for deployment \"nginx-deploy\" rollout to finish: 1 old replicas are pending termination...\nWaiting for deployment \"nginx-deploy\" rollout to finish: 1 old replicas are pending termination...\nWaiting for deployment \"nginx-deploy\" rollout to finish: 2 of 3 updated replicas are available...\nWaiting for deployment \"nginx-deploy\" rollout to finish: 2 of 3 updated replicas are available...\ndeployment \"nginx-deploy\" successfully rolled out\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u67e5\u770b\u5bf9\u5e94\u7684 RS \u8d44\u6e90\u5bf9\u8c61\u53ef\u4ee5\u770b\u5230 Pod \u526f\u672c\u5df2\u7ecf\u56de\u5230\u4e4b\u524d\u7684 RS \u91cc\u9762\u53bb\u4e86\u3002</p> <pre><code>$ kubectl get rs -l app=nginx\nNAME                      DESIRED   CURRENT   READY   AGE\nnginx-deploy-5b7b9ccb95   0         0         0       31m\nnginx-deploy-85ff79dd56   3         3         3       95m\n</code></pre> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u56de\u6eda\u7684\u64cd\u4f5c\u6eda\u52a8\u7684<code>revision</code>\u59cb\u7ec8\u662f\u9012\u589e\u7684\uff1a</p> <pre><code>$ kubectl rollout history deployment nginx-deploy\ndeployment.apps/nginx-deploy \nREVISION  CHANGE-CAUSE\n2         &lt;none&gt;\n3         &lt;none&gt;\n</code></pre> <p>\u4fdd\u7559\u65e7\u7248\u672c</p> <p>\u5728\u5f88\u65e9\u4e4b\u524d\u7684 Kubernetes \u7248\u672c\u4e2d\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f1a\u4e3a\u6211\u4eec\u66b4\u9732\u4e0b\u6240\u6709\u6eda\u52a8\u5347\u7ea7\u7684\u5386\u53f2\u8bb0\u5f55\uff0c\u4e5f\u5c31\u662f ReplicaSet \u5bf9\u8c61\uff0c\u4f46\u4e00\u822c\u60c5\u51b5\u4e0b\u6ca1\u5fc5\u8981\u4fdd\u7559\u6240\u6709\u7684\u7248\u672c\uff0c\u6bd5\u7adf\u4f1a\u5b58\u5728 etcd \u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e </p> <pre><code>spec.revisionHistoryLimit\n</code></pre> <p>\u5c5e\u6027\u6765\u8bbe\u7f6e\u4fdd\u7559\u7684\u5386\u53f2\u8bb0\u5f55\u6570\u91cf\uff0c\u4e0d\u8fc7\u65b0\u7248\u672c\u4e2d\u8be5\u503c\u9ed8\u8ba4\u4e3a 10\uff0c\u5982\u679c\u5e0c\u671b\u591a\u4fdd\u5b58\u51e0\u4e2a\u7248\u672c\u53ef\u4ee5\u8bbe\u7f6e\u8be5\u5b57\u6bb5\u3002</p>"},{"location":"kubernetes_controller/hpa/","title":"HPA","text":"\ue3c9"},{"location":"kubernetes_controller/hpa/#hpa","title":"HPA \u63a7\u5236\u5668","text":"<p>\u5728\u524d\u9762\u7684\u5b66\u4e60\u4e2d\u6211\u4eec\u4f7f\u7528\u7528\u4e00\u4e2a <code>kubectl scale</code> \u547d\u4ee4\u53ef\u4ee5\u6765\u5b9e\u73b0 Pod \u7684\u6269\u7f29\u5bb9\u529f\u80fd\uff0c\u4f46\u662f\u8fd9\u4e2a\u6bd5\u7adf\u662f\u5b8c\u5168\u624b\u52a8\u64cd\u4f5c\u7684\uff0c\u8981\u5e94\u5bf9\u7ebf\u4e0a\u7684\u5404\u79cd\u590d\u6742\u60c5\u51b5\uff0c\u6211\u4eec\u9700\u8981\u80fd\u591f\u505a\u5230\u81ea\u52a8\u5316\u53bb\u611f\u77e5\u4e1a\u52a1\uff0c\u6765\u81ea\u52a8\u8fdb\u884c\u6269\u7f29\u5bb9\u3002\u4e3a\u6b64\uff0cKubernetes \u4e5f\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u8fd9\u6837\u7684\u4e00\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a<code>Horizontal Pod Autoscaling\uff08Pod \u6c34\u5e73\u81ea\u52a8\u4f38\u7f29\uff09</code>\uff0c\u7b80\u79f0<code>HPA</code>\uff0cHPA \u901a\u8fc7\u76d1\u63a7\u5206\u6790\u4e00\u4e9b\u63a7\u5236\u5668\u63a7\u5236\u7684\u6240\u6709 Pod \u7684\u8d1f\u8f7d\u53d8\u5316\u60c5\u51b5\u6765\u786e\u5b9a\u662f\u5426\u9700\u8981\u8c03\u6574 Pod \u7684\u526f\u672c\u6570\u91cf\uff0c\u8fd9\u662f HPA \u6700\u57fa\u672c\u7684\u539f\u7406\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u7b80\u5355\u7684\u901a\u8fc7 <code>kubectl autoscale</code> \u547d\u4ee4\u6765\u521b\u5efa\u4e00\u4e2a HPA \u8d44\u6e90\u5bf9\u8c61\uff0c<code>HPA Controller</code>\u9ed8\u8ba4<code>30s</code>\u8f6e\u8be2\u4e00\u6b21\uff08\u53ef\u901a\u8fc7 <code>kube-controller-manager</code> \u7684<code>--horizontal-pod-autoscaler-sync-period</code> \u53c2\u6570\u8fdb\u884c\u8bbe\u7f6e\uff09\uff0c\u67e5\u8be2\u6307\u5b9a\u7684\u8d44\u6e90\u4e2d\u7684 Pod \u8d44\u6e90\u4f7f\u7528\u7387\uff0c\u5e76\u4e14\u4e0e\u521b\u5efa\u65f6\u8bbe\u5b9a\u7684\u503c\u548c\u6307\u6807\u505a\u5bf9\u6bd4\uff0c\u4ece\u800c\u5b9e\u73b0\u81ea\u52a8\u4f38\u7f29\u7684\u529f\u80fd\u3002</p>"},{"location":"kubernetes_controller/hpa/#metrics-server","title":"Metrics Server","text":"<p>\u5728 HPA \u7684\u7b2c\u4e00\u4e2a\u7248\u672c\u4e2d\uff0c\u6211\u4eec\u9700\u8981 <code>Heapster</code> \u63d0\u4f9b CPU \u548c\u5185\u5b58\u6307\u6807\uff0c\u5728 HPA v2 \u8fc7\u540e\u5c31\u9700\u8981\u5b89\u88c5 Metrcis Server \u4e86\uff0c<code>Metrics Server</code> \u53ef\u4ee5\u901a\u8fc7\u6807\u51c6\u7684 Kubernetes API \u628a\u76d1\u63a7\u6570\u636e\u66b4\u9732\u51fa\u6765\uff0c\u6709\u4e86 <code>Metrics Server</code> \u4e4b\u540e\uff0c\u6211\u4eec\u5c31\u5b8c\u5168\u53ef\u4ee5\u901a\u8fc7\u6807\u51c6\u7684 Kubernetes API \u6765\u8bbf\u95ee\u6211\u4eec\u60f3\u8981\u83b7\u53d6\u7684\u76d1\u63a7\u6570\u636e\u4e86\uff1a </p><pre><code>https://10.96.0.1/apis/metrics.k8s.io/v1beta1/namespaces/&lt;namespace-name&gt;/pods/&lt;pod-name&gt;</code></pre><p></p> <p>\u6bd4\u5982\u5f53\u6211\u4eec\u8bbf\u95ee\u4e0a\u9762\u7684 API \u7684\u65f6\u5019\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u83b7\u53d6\u5230\u8be5 Pod \u7684\u8d44\u6e90\u6570\u636e\uff0c\u8fd9\u4e9b\u6570\u636e\u5176\u5b9e\u662f\u6765\u81ea\u4e8e kubelet \u7684 <code>Summary API</code> \u91c7\u96c6\u800c\u6765\u7684\u3002\u4e0d\u8fc7\u9700\u8981\u8bf4\u660e\u7684\u662f\u6211\u4eec\u8fd9\u91cc\u53ef\u4ee5\u901a\u8fc7\u6807\u51c6\u7684 API \u6765\u83b7\u53d6\u8d44\u6e90\u76d1\u63a7\u6570\u636e\uff0c\u5e76\u4e0d\u662f\u56e0\u4e3a <code>Metrics Server</code> \u5c31\u662f APIServer \u7684\u4e00\u90e8\u5206\uff0c\u800c\u662f\u901a\u8fc7 Kubernetes \u63d0\u4f9b\u7684 <code>Aggregator</code> \u6c47\u805a\u63d2\u4ef6\u6765\u5b9e\u73b0\u7684\uff0c\u662f\u72ec\u7acb\u4e8e APIServer \u4e4b\u5916\u8fd0\u884c\u7684\u3002</p> <p></p>"},{"location":"kubernetes_controller/hpa/#api","title":"\u805a\u5408 API","text":"<p><code>Aggregator</code> \u5141\u8bb8\u5f00\u53d1\u4eba\u5458\u7f16\u5199\u4e00\u4e2a\u81ea\u5df1\u7684\u670d\u52a1\uff0c\u628a\u8fd9\u4e2a\u670d\u52a1\u6ce8\u518c\u5230 Kubernetes \u7684 APIServer \u91cc\u9762\u53bb\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u50cf\u539f\u751f\u7684 APIServer \u63d0\u4f9b\u7684 API \u4f7f\u7528\u81ea\u5df1\u7684 API \u4e86\uff0c\u6211\u4eec\u628a\u81ea\u5df1\u7684\u670d\u52a1\u8fd0\u884c\u5728 Kubernetes \u96c6\u7fa4\u91cc\u9762\uff0c\u7136\u540e Kubernetes \u7684 <code>Aggregator</code> \u901a\u8fc7 Service \u540d\u79f0\u5c31\u53ef\u4ee5\u8f6c\u53d1\u5230\u6211\u4eec\u81ea\u5df1\u5199\u7684 Service \u91cc\u9762\u53bb\u4e86\u3002\u8fd9\u6837\u8fd9\u4e2a\u805a\u5408\u5c42\u5c31\u5e26\u6765\u4e86\u5f88\u591a\u597d\u5904\uff1a</p> <ul> <li>\u589e\u52a0\u4e86 API \u7684\u6269\u5c55\u6027\uff0c\u5f00\u53d1\u4eba\u5458\u53ef\u4ee5\u7f16\u5199\u81ea\u5df1\u7684 API \u670d\u52a1\u6765\u66b4\u9732\u4ed6\u4eec\u60f3\u8981\u7684 API\u3002</li> <li>\u4e30\u5bcc\u4e86 API\uff0c\u6838\u5fc3 kubernetes \u56e2\u961f\u963b\u6b62\u4e86\u5f88\u591a\u65b0\u7684 API \u63d0\u6848\uff0c\u901a\u8fc7\u5141\u8bb8\u5f00\u53d1\u4eba\u5458\u5c06\u4ed6\u4eec\u7684 API \u4f5c\u4e3a\u5355\u72ec\u7684\u670d\u52a1\u516c\u5f00\uff0c\u8fd9\u6837\u5c31\u65e0\u987b\u793e\u533a\u7e41\u6742\u7684\u5ba1\u67e5\u4e86\u3002</li> <li>\u5f00\u53d1\u5206\u9636\u6bb5\u5b9e\u9a8c\u6027 API\uff0c\u65b0\u7684 API \u53ef\u4ee5\u5728\u5355\u72ec\u7684\u805a\u5408\u670d\u52a1\u4e2d\u5f00\u53d1\uff0c\u5f53\u5b83\u7a33\u5b9a\u4e4b\u540e\uff0c\u5728\u5408\u5e76\u4f1a APIServer \u5c31\u5f88\u5bb9\u6613\u4e86\u3002</li> <li>\u786e\u4fdd\u65b0 API \u9075\u5faa Kubernetes \u7ea6\u5b9a\uff0c\u5982\u679c\u6ca1\u6709\u8fd9\u91cc\u63d0\u51fa\u7684\u673a\u5236\uff0c\u793e\u533a\u6210\u5458\u53ef\u80fd\u4f1a\u88ab\u8feb\u63a8\u51fa\u81ea\u5df1\u7684\u4e1c\u897f\uff0c\u8fd9\u6837\u5f88\u53ef\u80fd\u9020\u6210\u793e\u533a\u6210\u5458\u548c\u793e\u533a\u7ea6\u5b9a\u4e0d\u4e00\u81f4\u3002</li> </ul>"},{"location":"kubernetes_controller/hpa/#_1","title":"\u5b89\u88c5","text":"<p>\u6240\u4ee5\u73b0\u5728\u6211\u4eec\u8981\u4f7f\u7528 HPA\uff0c\u5c31\u9700\u8981\u5728\u96c6\u7fa4\u4e2d\u5b89\u88c5 <code>Metrics Server</code> \u670d\u52a1\uff0c\u8981\u5b89\u88c5 <code>Metrics Server</code> \u5c31\u9700\u8981\u5f00\u542f <code>Aggregator</code>\uff0c\u56e0\u4e3a <code>Metrics Server</code> \u5c31\u662f\u901a\u8fc7\u8be5\u4ee3\u7406\u8fdb\u884c\u6269\u5c55\u7684\uff0c\u4e0d\u8fc7\u6211\u4eec\u96c6\u7fa4\u662f\u901a\u8fc7 Kubeadm \u642d\u5efa\u7684\uff0c\u9ed8\u8ba4\u5df2\u7ecf\u5f00\u542f\u4e86\uff0c\u5982\u679c\u662f\u4e8c\u8fdb\u5236\u65b9\u5f0f\u5b89\u88c5\u7684\u96c6\u7fa4\uff0c\u9700\u8981\u5355\u72ec\u914d\u7f6e kube-apsierver \u6dfb\u52a0\u5982\u4e0b\u6240\u793a\u7684\u53c2\u6570\uff1a </p><pre><code>--requestheader-client-ca-file=&lt;path to aggregator CA cert&gt;\n--requestheader-allowed-names=aggregator\n--requestheader-extra-headers-prefix=X-Remote-Extra-\n--requestheader-group-headers=X-Remote-Group\n--requestheader-username-headers=X-Remote-User\n--proxy-client-cert-file=&lt;path to aggregator proxy cert&gt;\n--proxy-client-key-file=&lt;path to aggregator proxy key&gt;</code></pre><p></p> <p>\u5982\u679c <code>kube-proxy</code> \u6ca1\u6709\u548c APIServer \u8fd0\u884c\u5728\u540c\u4e00\u53f0\u4e3b\u673a\u4e0a\uff0c\u90a3\u4e48\u9700\u8981\u786e\u4fdd\u542f\u7528\u4e86\u5982\u4e0b kube-apsierver \u7684\u53c2\u6570\uff1a </p><pre><code>--enable-aggregator-routing=true</code></pre><p></p> <p>\u5bf9\u4e8e\u8fd9\u4e9b\u8bc1\u4e66\u7684\u751f\u6210\u65b9\u5f0f\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863\uff1ahttps://github.com/kubernetes-sigs/apiserver-builder-alpha/blob/master/docs/concepts/auth.md\u3002</p> <p><code>Aggregator</code> \u805a\u5408\u5c42\u542f\u52a8\u5b8c\u6210\u540e\uff0c\u5c31\u53ef\u4ee5\u6765\u5b89\u88c5 <code>Metrics Server</code> \u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u83b7\u53d6\u8be5\u4ed3\u5e93\u7684\u5b98\u65b9\u5b89\u88c5\u8d44\u6e90\u6e05\u5355\uff1a </p><pre><code># \u5b98\u65b9\u4ed3\u5e93\u5730\u5740\uff1ahttps://github.com/kubernetes-sigs/metrics-server\n$ wget https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.3.6/components.yaml</code></pre><p></p> <p>\u5728\u90e8\u7f72\u4e4b\u524d\uff0c\u4fee\u6539 <code>components.yaml</code> \u7684\u955c\u50cf\u5730\u5740\u4e3a\uff1a </p><pre><code>hostNetwork: true  # \u4f7f\u7528hostNetwork\u6a21\u5f0f\ncontainers:\n- name: metrics-server\n  image: registry.aliyuncs.com/google_containers/metrics-server-amd64:v0.3.6</code></pre><p></p> <p>\u7b49\u90e8\u7f72\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u67e5\u770b Pod \u65e5\u5fd7\u662f\u5426\u6b63\u5e38\uff1a </p><pre><code>$ kubectl apply -f components.yaml\n$ kubectl get pods -n kube-system -l k8s-app=metrics-server\nNAME                              READY   STATUS    RESTARTS   AGE\nmetrics-server-6886856d7c-g5k6q   1/1     Running   0          2m39s\n$ kubectl logs -f metrics-server-6886856d7c-g5k6q -n kube-system\n......\nE1119 09:05:57.234312       1 manager.go:111] unable to fully collect metrics: [unable to fully scrape metrics from source kubelet_summary:ydzs-node1: unable to fetch metrics from Kubelet ydzs-node1 (ydzs-node1): Get https://ydzs-node1:10250/stats/summary?only_cpu_and_memory=true: dial tcp: lookup ydzs-node1 on 10.96.0.10:53: no such host, unable to fully scrape metrics from source kubelet_summary:ydzs-node4: unable to fetch metrics from Kubelet ydzs-node4 (ydzs-node4): Get https://ydzs-node4:10250/stats/summary?only_cpu_and_memory=true: dial tcp: lookup ydzs-node4 on 10.96.0.10:53: no such host, unable to fully scrape metrics from source kubelet_summary:ydzs-node3: unable to fetch metrics from Kubelet ydzs-node3 (ydzs-node3): Get https://ydzs-node3:10250/stats/summary?only_cpu_and_memory=true: dial tcp: lookup ydzs-node3 on 10.96.0.10:53: no such host, unable to fully scrape metrics from source kubelet_summary:ydzs-master: unable to fetch metrics from Kubelet ydzs-master (ydzs-master): Get https://ydzs-master:10250/stats/summary?only_cpu_and_memory=true: dial tcp: lookup ydzs-master on 10.96.0.10:53: no such host, unable to fully scrape metrics from source kubelet_summary:ydzs-node2: unable to fetch metrics from Kubelet ydzs-node2 (ydzs-node2): Get https://ydzs-node2:10250/stats/summary?only_cpu_and_memory=true: dial tcp: lookup ydzs-node2 on 10.96.0.10:53: no such host]</code></pre><p></p> <p>\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0 Pod \u4e2d\u51fa\u73b0\u4e86\u4e00\u4e9b\u9519\u8bef\u4fe1\u606f\uff1a<code>xxx: no such host</code>\uff0c\u6211\u4eec\u770b\u5230\u8fd9\u4e2a\u9519\u8bef\u4fe1\u606f\u4e00\u822c\u5c31\u53ef\u4ee5\u786e\u5b9a\u662f DNS \u89e3\u6790\u4e0d\u4e86\u9020\u6210\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Metrics Server \u4f1a\u901a\u8fc7 kubelet \u7684 10250 \u7aef\u53e3\u83b7\u53d6\u4fe1\u606f\uff0c\u4f7f\u7528\u7684\u662f hostname\uff0c\u6211\u4eec\u90e8\u7f72\u96c6\u7fa4\u7684\u65f6\u5019\u5728\u8282\u70b9\u7684 <code>/etc/hosts</code> \u91cc\u9762\u6dfb\u52a0\u4e86\u8282\u70b9\u7684 hostname \u548c ip \u7684\u6620\u5c04\uff0c\u4f46\u662f\u662f\u6211\u4eec\u7684 Metrics Server \u7684 Pod \u5185\u90e8\u5e76\u6ca1\u6709\u8fd9\u4e2a hosts \u4fe1\u606f\uff0c\u5f53\u7136\u4e5f\u5c31\u4e0d\u8bc6\u522b hostname \u4e86\uff0c\u8981\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u6709\u4e24\u79cd\u65b9\u6cd5\uff1a</p> <p>\u7b2c\u4e00\u79cd\u65b9\u6cd5\u5c31\u662f\u5728\u96c6\u7fa4\u5185\u90e8\u7684 DNS \u670d\u52a1\u91cc\u9762\u6dfb\u52a0\u4e0a hostname \u7684\u89e3\u6790\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u96c6\u7fa4\u4e2d\u4f7f\u7528\u7684\u662f <code>CoreDNS</code>\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u53bb\u4fee\u6539\u4e0b CoreDNS \u7684 Configmap \u4fe1\u606f\uff0c\u6dfb\u52a0\u4e0a hosts \u4fe1\u606f\uff1a </p><pre><code>$ kubectl edit configmap coredns -n kube-system\napiVersion: v1\ndata:\n  Corefile: |\n    .:53 {\n        errors\n        health\n        hosts {  # \u6dfb\u52a0\u96c6\u7fa4\u8282\u70b9hosts\u9690\u5c04\u4fe1\u606f\n          10.151.30.11 ydzs-master\n          10.151.30.57 ydzs-node3\n          10.151.30.59 ydzs-node4\n          10.151.30.22 ydzs-node1\n          10.151.30.23 ydzs-node2\n          fallthrough\n        }\n        kubernetes cluster.local in-addr.arpa ip6.arpa {\n           pods insecure\n           upstream\n           fallthrough in-addr.arpa ip6.arpa\n        }\n        prometheus :9153\n        proxy . /etc/resolv.conf\n        cache 30\n        reload\n    }\nkind: ConfigMap\nmetadata:\n  creationTimestamp: 2019-05-18T11:07:46Z\n  name: coredns\n  namespace: kube-system</code></pre><p></p> <p>\u8fd9\u6837\u5f53\u5728\u96c6\u7fa4\u5185\u90e8\u8bbf\u95ee\u96c6\u7fa4\u7684 hostname \u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u89e3\u6790\u5230\u5bf9\u5e94\u7684 ip \u4e86\uff0c\u53e6\u5916\u4e00\u79cd\u65b9\u6cd5\u5c31\u662f\u5728 metrics-server \u7684\u542f\u52a8\u53c2\u6570\u4e2d\u4fee\u6539 <code>kubelet-preferred-address-types</code> \u53c2\u6570\uff0c\u5982\u4e0b\uff1a </p><pre><code>args:\n- --cert-dir=/tmp\n- --secure-port=4443\n- --kubelet-preferred-address-types=InternalIP</code></pre><p></p> <p>\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7b2c\u4e8c\u79cd\u65b9\u5f0f\uff0c\u7136\u540e\u91cd\u65b0\u5b89\u88c5\uff1a </p><pre><code>$ kubectl get pods -n kube-system -l k8s-app=metrics-server\nNAME                              READY   STATUS        RESTARTS   AGE\nmetrics-server-6dcfdf89b5-tvdcp   1/1     Running       0          33s\n$ kubectl logs -f metric-metrics-server-58fc94d9f-jlxcb -n kube-system\n......\nE1119 09:08:49.805959       1 manager.go:111] unable to fully collect metrics: [unable to fully scrape metrics from source kubelet_summary:ydzs-node3: unable to fetch metrics from Kubelet ydzs-node3 (10.151.30.57): Get https://10.151.30.57:10250/stats/summary?only_cpu_and_memory=true: x509: cannot validate certificate for 10.151.30.57 because it doesn't contain any IP SANs, unable to fully scrape metrics from source kubelet_summary:ydzs-node4: unable to fetch metrics from Kubelet ydzs-node4 (10.151.30.59): Get https://10.151.30.59:10250/stats/summary?only_cpu_and_memory=true: x509: cannot validate certificate for 10.151.30.59 because it doesn't contain any IP SANs, unable to fully scrape metrics from source kubelet_summary:ydzs-node2: unable to fetch metrics from Kubelet ydzs-node2 (10.151.30.23): Get https://10.151.30.23:10250/stats/summary?only_cpu_and_memory=true: x509: cannot validate certificate for 10.151.30.23 because it doesn't contain any IP SANs, unable to fully scrape metrics from source kubelet_summary:ydzs-master: unable to fetch metrics from Kubelet ydzs-master (10.151.30.11): Get https://10.151.30.11:10250/stats/summary?only_cpu_and_memory=true: x509: cannot validate certificate for 10.151.30.11 because it doesn't contain any IP SANs, unable to fully scrape metrics from source kubelet_summary:ydzs-node1: unable to fetch metrics from Kubelet ydzs-node1 (10.151.30.22): Get https://10.151.30.22:10250/stats/summary?only_cpu_and_memory=true: x509: cannot validate certificate for 10.151.30.22 because it doesn't contain any IP SANs]</code></pre><p></p> <p>\u56e0\u4e3a\u90e8\u7f72\u96c6\u7fa4\u7684\u65f6\u5019\uff0cCA \u8bc1\u4e66\u5e76\u6ca1\u6709\u628a\u5404\u4e2a\u8282\u70b9\u7684 IP \u7b7e\u4e0a\u53bb\uff0c\u6240\u4ee5\u8fd9\u91cc <code>Metrics Server</code> \u901a\u8fc7 IP \u53bb\u8bf7\u6c42\u65f6\uff0c\u63d0\u793a\u7b7e\u7684\u8bc1\u4e66\u6ca1\u6709\u5bf9\u5e94\u7684 IP\uff08\u9519\u8bef\uff1a<code>x509: cannot validate certificate for 10.151.30.22 because it doesn\u2019t contain any IP SANs</code>\uff09\uff0c\u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0\u4e00\u4e2a<code>--kubelet-insecure-tls</code>\u53c2\u6570\u8df3\u8fc7\u8bc1\u4e66\u6821\u9a8c\uff1a </p><pre><code>args:\n- --cert-dir=/tmp\n- --secure-port=4443\n- --kubelet-insecure-tls\n- --kubelet-preferred-address-types=InternalIP</code></pre><p></p> <p>\u7136\u540e\u518d\u91cd\u65b0\u5b89\u88c5\u5373\u53ef\u6210\u529f\uff01\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u6765\u9a8c\u8bc1\uff1a </p><pre><code>$ kubectl apply -f components.yaml\n$ kubectl get pods -n kube-system -l k8s-app=metrics-server\nNAME                              READY   STATUS    RESTARTS   AGE\nmetrics-server-5d4dbb78bb-6klw6   1/1     Running   0          14s\n$ kubectl logs -f metrics-server-5d4dbb78bb-6klw6 -n kube-system\nI1119 09:10:44.249092       1 serving.go:312] Generated self-signed cert (/tmp/apiserver.crt, /tmp/apiserver.key)\nI1119 09:10:45.264076       1 secure_serving.go:116] Serving securely on [::]:4443\n$ kubectl get apiservice | grep metrics\nv1beta1.metrics.k8s.io                 kube-system/metrics-server   True        9m\n$ kubectl get --raw \"/apis/metrics.k8s.io/v1beta1/nodes\"\n{\"kind\":\"NodeMetricsList\",\"apiVersion\":\"metrics.k8s.io/v1beta1\",\"metadata\":{\"selfLink\":\"/apis/metrics.k8s.io/v1beta1/nodes\"},\"items\":[{\"metadata\":{\"name\":\"ydzs-node3\",\"selfLink\":\"/apis/metrics.k8s.io/v1beta1/nodes/ydzs-node3\",\"creationTimestamp\":\"2019-11-19T09:11:53Z\"},\"timestamp\":\"2019-11-19T09:11:38Z\",\"window\":\"30s\",\"usage\":{\"cpu\":\"240965441n\",\"memory\":\"3004360Ki\"}},{\"metadata\":{\"name\":\"ydzs-node4\",\"selfLink\":\"/apis/metrics.k8s.io/v1beta1/nodes/ydzs-node4\",\"creationTimestamp\":\"2019-11-19T09:11:53Z\"},\"timestamp\":\"2019-11-19T09:11:37Z\",\"window\":\"30s\",\"usage\":{\"cpu\":\"167036681n\",\"memory\":\"2574664Ki\"}},{\"metadata\":{\"name\":\"ydzs-master\",\"selfLink\":\"/apis/metrics.k8s.io/v1beta1/nodes/ydzs-master\",\"creationTimestamp\":\"2019-11-19T09:11:53Z\"},\"timestamp\":\"2019-11-19T09:11:38Z\",\"window\":\"30s\",\"usage\":{\"cpu\":\"350907350n\",\"memory\":\"2986716Ki\"}},{\"metadata\":{\"name\":\"ydzs-node1\",\"selfLink\":\"/apis/metrics.k8s.io/v1beta1/nodes/ydzs-node1\",\"creationTimestamp\":\"2019-11-19T09:11:53Z\"},\"timestamp\":\"2019-11-19T09:11:39Z\",\"window\":\"30s\",\"usage\":{\"cpu\":\"1319638039n\",\"memory\":\"2094376Ki\"}},{\"metadata\":{\"name\":\"ydzs-node2\",\"selfLink\":\"/apis/metrics.k8s.io/v1beta1/nodes/ydzs-node2\",\"creationTimestamp\":\"2019-11-19T09:11:53Z\"},\"timestamp\":\"2019-11-19T09:11:36Z\",\"window\":\"30s\",\"usage\":{\"cpu\":\"320381888n\",\"memory\":\"3270368Ki\"}}]}\n$ kubectl top nodes\nNAME          CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   \nydzs-master   351m         17%    2916Mi          79%       \nydzs-node1    1320m        33%    2045Mi          26%       \nydzs-node2    321m         8%     3193Mi          41%       \nydzs-node3    241m         6%     2933Mi          37%       \nydzs-node4    168m         4%     2514Mi          32% </code></pre><p></p> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>kubectl top</code> \u547d\u4ee4\u6765\u83b7\u53d6\u5230\u8d44\u6e90\u6570\u636e\u4e86\uff0c\u8bc1\u660e <code>Metrics Server</code> \u5df2\u7ecf\u5b89\u88c5\u6210\u529f\u4e86\u3002</p>"},{"location":"kubernetes_controller/hpa/#hpa_1","title":"HPA","text":"<p>\u73b0\u5728\u6211\u4eec\u7528 Deployment \u6765\u521b\u5efa\u4e00\u4e2a Nginx Pod\uff0c\u7136\u540e\u5229\u7528 <code>HPA</code> \u6765\u8fdb\u884c\u81ea\u52a8\u6269\u7f29\u5bb9\u3002\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a\uff08hpa-demo.yaml\uff09 </p><pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: hpa-demo\nspec:\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx\n        ports:\n        - containerPort: 80</code></pre><p></p> <p>\u7136\u540e\u76f4\u63a5\u521b\u5efa Deployment\uff1a </p><pre><code>$ kubectl apply -f hpa-demo.yaml\ndeployment.apps/hpa-demo created\n$ kubectl get pods -l app=nginx\nNAME                        READY   STATUS    RESTARTS   AGE\nhpa-demo-85ff79dd56-pz8th   1/1     Running   0          21s</code></pre><p></p> <p>\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a <code>HPA</code> \u8d44\u6e90\u5bf9\u8c61\uff0c\u53ef\u4ee5\u4f7f\u7528<code>kubectl autoscale</code>\u547d\u4ee4\u6765\u521b\u5efa\uff1a </p><pre><code>$ kubectl autoscale deployment hpa-demo --cpu-percent=10 --min=1 --max=10\nhorizontalpodautoscaler.autoscaling/hpa-demo autoscaled\n$ kubectl get hpa\nNAME       REFERENCE             TARGETS         MINPODS   MAXPODS   REPLICAS   AGE\nhpa-demo   Deployment/hpa-demo   &lt;unknown&gt;/10%   1         10        1          16s</code></pre><p></p> <p>\u6b64\u547d\u4ee4\u521b\u5efa\u4e86\u4e00\u4e2a\u5173\u8054\u8d44\u6e90 hpa-demo \u7684 HPA\uff0c\u6700\u5c0f\u7684 Pod \u526f\u672c\u6570\u4e3a1\uff0c\u6700\u5927\u4e3a10\u3002HPA \u4f1a\u6839\u636e\u8bbe\u5b9a\u7684 cpu \u4f7f\u7528\u7387\uff0810%\uff09\u52a8\u6001\u7684\u589e\u52a0\u6216\u8005\u51cf\u5c11 Pod \u6570\u91cf\u3002</p> <p>\u5f53\u7136\u6211\u4eec\u4f9d\u7136\u8fd8\u662f\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa YAML \u6587\u4ef6\u7684\u5f62\u5f0f\u6765\u521b\u5efa HPA \u8d44\u6e90\u5bf9\u8c61\u3002\u5982\u679c\u6211\u4eec\u4e0d\u77e5\u9053\u600e\u4e48\u7f16\u5199\u7684\u8bdd\uff0c\u53ef\u4ee5\u67e5\u770b\u4e0a\u9762\u547d\u4ee4\u884c\u521b\u5efa\u7684HPA\u7684YAML\u6587\u4ef6\uff1a </p><pre><code>$ kubectl get hpa hpa-demo -o yaml\napiVersion: autoscaling/v1\nkind: HorizontalPodAutoscaler\nmetadata:\n  annotations:\n    autoscaling.alpha.kubernetes.io/conditions: '[{\"type\":\"AbleToScale\",\"status\":\"True\",\"lastTransitionTime\":\"2019-11-19T09:15:12Z\",\"reason\":\"SucceededGetScale\",\"message\":\"the\n      HPA controller was able to get the target''s current scale\"},{\"type\":\"ScalingActive\",\"status\":\"False\",\"lastTransitionTime\":\"2019-11-19T09:15:12Z\",\"reason\":\"FailedGetResourceMetric\",\"message\":\"the\n      HPA was unable to compute the replica count: missing request for cpu\"}]'\n  creationTimestamp: \"2019-11-19T09:14:56Z\"\n  name: hpa-demo\n  namespace: default\n  resourceVersion: \"3094084\"\n  selfLink: /apis/autoscaling/v1/namespaces/default/horizontalpodautoscalers/hpa-demo\n  uid: b84d79f1-75b0-46e0-95b5-4cbe3509233b\nspec:\n  maxReplicas: 10\n  minReplicas: 1\n  scaleTargetRef:\n    apiVersion: apps/v1\n    kind: Deployment\n    name: hpa-demo\n  targetCPUUtilizationPercentage: 10\nstatus:\n  currentReplicas: 1\n  desiredReplicas: 0</code></pre><p></p> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u4e0a\u9762\u7684 YAML \u6587\u4ef6\u5c31\u53ef\u4ee5\u81ea\u5df1\u6765\u521b\u5efa\u4e00\u4e2a\u57fa\u4e8e YAML \u7684 HPA \u63cf\u8ff0\u6587\u4ef6\u4e86\u3002\u4f46\u662f\u6211\u4eec\u53d1\u73b0\u4e0a\u9762\u4fe1\u606f\u91cc\u9762\u51fa\u73b0\u4e86\u4e00\u4e9b Fail \u4fe1\u606f\uff0c\u6211\u4eec\u6765\u67e5\u770b\u4e0b\u8fd9\u4e2a HPA \u5bf9\u8c61\u7684\u4fe1\u606f\uff1a </p><pre><code>$ kubectl describe hpa hpa-demo\nName:                                                  hpa-demo\nNamespace:                                             default\nLabels:                                                &lt;none&gt;\nAnnotations:                                           &lt;none&gt;\nCreationTimestamp:                                     Tue, 19 Nov 2019 17:14:56 +0800\nReference:                                             Deployment/hpa-demo\nMetrics:                                               ( current / target )\n  resource cpu on pods  (as a percentage of request):  &lt;unknown&gt; / 10%\nMin replicas:                                          1\nMax replicas:                                          10\nDeployment pods:                                       1 current / 0 desired\nConditions:\n  Type           Status  Reason                   Message\n  ----           ------  ------                   -------\n  AbleToScale    True    SucceededGetScale        the HPA controller was able to get the target's current scale\n  ScalingActive  False   FailedGetResourceMetric  the HPA was unable to compute the replica count: missing request for cpu\nEvents:\n  Type     Reason                        Age                From                       Message\n  ----     ------                        ----               ----                       -------\n  Warning  FailedGetResourceMetric       14s (x4 over 60s)  horizontal-pod-autoscaler  missing request for cpu\n  Warning  FailedComputeMetricsReplicas  14s (x4 over 60s)  horizontal-pod-autoscaler  invalid metrics (1 invalid out of 1), first error is: failed to get cpu utilization: missing request for cpu</code></pre><p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u7684\u4e8b\u4ef6\u4fe1\u606f\u91cc\u9762\u51fa\u73b0\u4e86 <code>failed to get cpu utilization: missing request for cpu</code> \u8fd9\u6837\u7684\u9519\u8bef\u4fe1\u606f\u3002\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u4e0a\u9762\u521b\u5efa\u7684 Pod \u5bf9\u8c61\u6ca1\u6709\u6dfb\u52a0 request \u8d44\u6e90\u58f0\u660e\uff0c\u8fd9\u6837\u5bfc\u81f4 HPA \u8bfb\u53d6\u4e0d\u5230 CPU \u6307\u6807\u4fe1\u606f\uff0c\u6240\u4ee5\u5982\u679c\u8981\u60f3\u8ba9 HPA \u751f\u6548\uff0c\u5bf9\u5e94\u7684 Pod \u8d44\u6e90\u5fc5\u987b\u6dfb\u52a0 requests \u8d44\u6e90\u58f0\u660e\uff0c\u66f4\u65b0\u6211\u4eec\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff1a </p><pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: hpa-demo\nspec:\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx\n        ports:\n        - containerPort: 80\n        resources:\n          requests:\n            memory: 50Mi\n            cpu: 50m</code></pre><p></p> <p>\u7136\u540e\u91cd\u65b0\u66f4\u65b0 Deployment\uff0c\u91cd\u65b0\u521b\u5efa HPA \u5bf9\u8c61\uff1a </p><pre><code>$ kubectl apply -f hpa.yaml \ndeployment.apps/hpa-demo configured\n$ kubectl get pods -o wide -l app=nginx\nNAME                        READY   STATUS    RESTARTS   AGE     IP            NODE         NOMINATED NODE   READINESS GATES\nhpa-demo-69968bb59f-twtdp   1/1     Running   0          4m11s   10.244.4.97   ydzs-node4   &lt;none&gt;           &lt;none&gt;\n$ kubectl delete hpa hpa-demo\nhorizontalpodautoscaler.autoscaling \"hpa-demo\" deleted\n$ kubectl autoscale deployment hpa-demo --cpu-percent=10 --min=1 --max=10\nhorizontalpodautoscaler.autoscaling/hpa-demo autoscaled\n$ kubectl describe hpa hpa-demo                                          \nName:                                                  hpa-demo\nNamespace:                                             default\nLabels:                                                &lt;none&gt;\nAnnotations:                                           &lt;none&gt;\nCreationTimestamp:                                     Tue, 19 Nov 2019 17:23:49 +0800\nReference:                                             Deployment/hpa-demo\nMetrics:                                               ( current / target )\n  resource cpu on pods  (as a percentage of request):  0% (0) / 10%\nMin replicas:                                          1\nMax replicas:                                          10\nDeployment pods:                                       1 current / 1 desired\nConditions:\n  Type            Status  Reason               Message\n  ----            ------  ------               -------\n  AbleToScale     True    ScaleDownStabilized  recent recommendations were higher than current one, applying the highest recent recommendation\n  ScalingActive   True    ValidMetricFound     the HPA was able to successfully calculate a replica count from cpu resource utilization (percentage of request)\n  ScalingLimited  False   DesiredWithinRange   the desired count is within the acceptable range\nEvents:           &lt;none&gt;\n$ kubectl get hpa                                                        \nNAME       REFERENCE             TARGETS   MINPODS   MAXPODS   REPLICAS   AGE\nhpa-demo   Deployment/hpa-demo   0%/10%    1         10        1          52s</code></pre><p></p> <p>\u73b0\u5728\u53ef\u4ee5\u770b\u5230 HPA \u8d44\u6e90\u5bf9\u8c61\u5df2\u7ecf\u6b63\u5e38\u4e86\uff0c\u73b0\u5728\u6211\u4eec\u6765\u589e\u5927\u8d1f\u8f7d\u8fdb\u884c\u6d4b\u8bd5\uff0c\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a busybox \u7684 Pod\uff0c\u5e76\u4e14\u5faa\u73af\u8bbf\u95ee\u4e0a\u9762\u521b\u5efa\u7684 Pod\uff1a </p><pre><code>$ kubectl run -it --image busybox test-hpa --restart=Never --rm /bin/sh\nIf you don't see a command prompt, try pressing enter.\n/ # while true; do wget -q -O- http://10.244.4.97; done</code></pre><p></p> <p>\u4e0b\u56fe\u53ef\u4ee5\u770b\u5230\uff0cHPA \u5df2\u7ecf\u5f00\u59cb\u5de5\u4f5c\uff1a </p><pre><code>$  kubectl get hpa\nNAME       REFERENCE             TARGETS    MINPODS   MAXPODS   REPLICAS   AGE\nhpa-demo   Deployment/hpa-demo   338%/10%   1         10        1          5m15s\n$ kubectl get pods -l app=nginx --watch \nNAME                        READY   STATUS              RESTARTS   AGE\nhpa-demo-69968bb59f-8hjnn   1/1     Running             0          22s\nhpa-demo-69968bb59f-9ss9f   1/1     Running             0          22s\nhpa-demo-69968bb59f-bllsd   1/1     Running             0          22s\nhpa-demo-69968bb59f-lnh8k   1/1     Running             0          37s\nhpa-demo-69968bb59f-r8zfh   1/1     Running             0          22s\nhpa-demo-69968bb59f-twtdp   1/1     Running             0          6m43s\nhpa-demo-69968bb59f-w792g   1/1     Running             0          37s\nhpa-demo-69968bb59f-zlxkp   1/1     Running             0          37s\nhpa-demo-69968bb59f-znp6q   0/1     ContainerCreating   0          6s\nhpa-demo-69968bb59f-ztnvx   1/1     Running             0          6s\n</code></pre><p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u81ea\u52a8\u62c9\u8d77\u4e86\u5f88\u591a\u65b0\u7684 Pod\uff0c\u6700\u540e\u5b9a\u683c\u5728\u4e86\u6211\u4eec\u4e0a\u9762\u8bbe\u7f6e\u7684 10 \u4e2a Pod\uff0c\u540c\u65f6\u67e5\u770b\u8d44\u6e90 hpa-demo \u7684\u526f\u672c\u6570\u91cf\uff0c\u526f\u672c\u6570\u91cf\u5df2\u7ecf\u4ece\u539f\u6765\u76841\u53d8\u6210\u4e8610\u4e2a\uff1a </p><pre><code>$ kubectl get deployment hpa-demo\nNAME       READY   UP-TO-DATE   AVAILABLE   AGE\nhpa-demo   10/10   10           10          17m</code></pre><p></p> <p>\u67e5\u770b HPA \u8d44\u6e90\u7684\u5bf9\u8c61\u4e86\u89e3\u5de5\u4f5c\u8fc7\u7a0b\uff1a </p><pre><code>$ kubectl describe hpa hpa-demo\nName:                                                  hpa-demo\nNamespace:                                             default\nLabels:                                                &lt;none&gt;\nAnnotations:                                           &lt;none&gt;\nCreationTimestamp:                                     Tue, 19 Nov 2019 17:23:49 +0800\nReference:                                             Deployment/hpa-demo\nMetrics:                                               ( current / target )\n  resource cpu on pods  (as a percentage of request):  0% (0) / 10%\nMin replicas:                                          1\nMax replicas:                                          10\nDeployment pods:                                       10 current / 10 desired\nConditions:\n  Type            Status  Reason               Message\n  ----            ------  ------               -------\n  AbleToScale     True    ScaleDownStabilized  recent recommendations were higher than current one, applying the highest recent recommendation\n  ScalingActive   True    ValidMetricFound     the HPA was able to successfully calculate a replica count from cpu resource utilization (percentage of request)\n  ScalingLimited  True    TooManyReplicas      the desired replica count is more than the maximum replica count\nEvents:\n  Type    Reason             Age    From                       Message\n  ----    ------             ----   ----                       -------\n  Normal  SuccessfulRescale  5m45s  horizontal-pod-autoscaler  New size: 4; reason: cpu resource utilization (percentage of request) above target\n  Normal  SuccessfulRescale  5m30s  horizontal-pod-autoscaler  New size: 8; reason: cpu resource utilization (percentage of request) above target\n  Normal  SuccessfulRescale  5m14s  horizontal-pod-autoscaler  New size: 10; reason: cpu resource utilization (percentage of request) above target</code></pre><p></p> <p>\u540c\u6837\u7684\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u6765\u5173\u6389 busybox \u6765\u51cf\u5c11\u8d1f\u8f7d\uff0c\u7136\u540e\u7b49\u5f85\u4e00\u6bb5\u65f6\u95f4\u89c2\u5bdf\u4e0b HPA \u548c Deployment \u5bf9\u8c61\uff1a </p><pre><code>$ kubectl get hpa\nNAME       REFERENCE             TARGETS   MINPODS   MAXPODS   REPLICAS   AGE\nhpa-demo   Deployment/hpa-demo   0%/10%    1         10        1          14m\n$ kubectl get deployment hpa-demo\nNAME       READY   UP-TO-DATE   AVAILABLE   AGE\nhpa-demo   1/1     1            1           24m</code></pre><p></p> <p>\u7f29\u653e\u95f4\u9699</p> <p>\u4ece Kubernetes <code>v1.12</code> \u7248\u672c\u5f00\u59cb\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e <code>kube-controller-manager</code> \u7ec4\u4ef6\u7684<code>--horizontal-pod-autoscaler-downscale-stabilization</code> \u53c2\u6570\u6765\u8bbe\u7f6e\u4e00\u4e2a\u6301\u7eed\u65f6\u95f4\uff0c\u7528\u4e8e\u6307\u5b9a\u5728\u5f53\u524d\u64cd\u4f5c\u5b8c\u6210\u540e\uff0c<code>HPA</code> \u5fc5\u987b\u7b49\u5f85\u591a\u957f\u65f6\u95f4\u624d\u80fd\u6267\u884c\u53e6\u4e00\u6b21\u7f29\u653e\u64cd\u4f5c\u3002\u9ed8\u8ba4\u4e3a5\u5206\u949f\uff0c\u4e5f\u5c31\u662f\u9ed8\u8ba4\u9700\u8981\u7b49\u5f855\u5206\u949f\u540e\u624d\u4f1a\u5f00\u59cb\u81ea\u52a8\u7f29\u653e\u3002</p> <p>\u53ef\u4ee5\u770b\u5230\u526f\u672c\u6570\u91cf\u5df2\u7ecf\u7531 10 \u53d8\u4e3a 1\uff0c\u5f53\u524d\u6211\u4eec\u53ea\u662f\u6f14\u793a\u4e86 CPU \u4f7f\u7528\u7387\u8fd9\u4e00\u4e2a\u6307\u6807\uff0c\u5728\u540e\u9762\u7684\u8bfe\u7a0b\u4e2d\u6211\u4eec\u8fd8\u4f1a\u5b66\u4e60\u5230\u6839\u636e\u81ea\u5b9a\u4e49\u7684\u76d1\u63a7\u6307\u6807\u6765\u81ea\u52a8\u5bf9 Pod \u8fdb\u884c\u6269\u7f29\u5bb9\u3002</p>"},{"location":"kubernetes_controller/job/","title":"Job","text":""},{"location":"kubernetes_controller/job/#job_cronjob","title":"Job \u4e0e CronJob","text":"<p>\u4eca\u5929\u6211\u4eec\u6765\u7ed9\u5927\u5bb6\u4ecb\u7ecd\u53e6\u5916\u4e00\u7c7b\u8d44\u6e90\u5bf9\u8c61\uff1a<code>Job</code>\uff0c\u6211\u4eec\u5728\u65e5\u5e38\u7684\u5de5\u4f5c\u4e2d\u7ecf\u5e38\u90fd\u4f1a\u9047\u5230\u4e00\u4e9b\u9700\u8981\u8fdb\u884c\u6279\u91cf\u6570\u636e\u5904\u7406\u548c\u5206\u6790\u7684\u9700\u6c42\uff0c\u5f53\u7136\u4e5f\u4f1a\u6709\u6309\u65f6\u95f4\u6765\u8fdb\u884c\u8c03\u5ea6\u7684\u5de5\u4f5c\uff0c\u5728\u6211\u4eec\u7684 Kubernetes \u96c6\u7fa4\u4e2d\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86 <code>Job</code> \u548c <code>CronJob</code> \u4e24\u79cd\u8d44\u6e90\u5bf9\u8c61\u6765\u5e94\u5bf9\u6211\u4eec\u7684\u8fd9\u79cd\u9700\u6c42\u3002</p> <p><code>Job</code> \u8d1f\u8d23\u5904\u7406\u4efb\u52a1\uff0c\u5373\u4ec5\u6267\u884c\u4e00\u6b21\u7684\u4efb\u52a1\uff0c\u5b83\u4fdd\u8bc1\u6279\u5904\u7406\u4efb\u52a1\u7684\u4e00\u4e2a\u6216\u591a\u4e2a Pod \u6210\u529f\u7ed3\u675f\u3002\u800c<code>CronJob</code> \u5219\u5c31\u662f\u5728 <code>Job</code> \u4e0a\u52a0\u4e0a\u4e86\u65f6\u95f4\u8c03\u5ea6\u3002</p>"},{"location":"kubernetes_controller/job/#job","title":"Job","text":"<p>\u6211\u4eec\u7528 <code>Job</code> \u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u6765\u521b\u5efa\u4e00\u4e2a\u4efb\u52a1\uff0c\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a <code>Job</code> \u6765\u6267\u884c\u4e00\u4e2a\u5012\u8ba1\u65f6\u7684\u4efb\u52a1\uff0c\u5bf9\u5e94\u7684\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a(job-demo.yaml)</p> <pre><code>apiVersion: batch/v1\nkind: Job\nmetadata:\n  name: job-demo\nspec:\n  template:\n    spec:\n      restartPolicy: Never\n      containers:\n      - name: counter\n        image: busybox\n        command:\n        - \"bin/sh\"\n        - \"-c\"\n        - \"for i in 9 8 7 6 5 4 3 2 1; do echo $i; done\"\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 <code>Job</code> \u4e2d\u4e5f\u662f\u4e00\u4e2a Pod \u6a21\u677f\uff0c\u548c\u4e4b\u524d\u7684 Deployment\u3001StatefulSet \u4e4b\u7c7b\u7684\u662f\u4e00\u81f4\u7684\uff0c\u53ea\u662f Pod \u4e2d\u7684\u5bb9\u5668\u8981\u6c42\u662f\u4e00\u4e2a\u4efb\u52a1\uff0c\u800c\u4e0d\u662f\u4e00\u4e2a\u5e38\u9a7b\u524d\u53f0\u7684\u8fdb\u7a0b\u4e86\uff0c\u56e0\u4e3a\u9700\u8981\u9000\u51fa\uff0c\u53e6\u5916\u503c\u5f97\u6ce8\u610f\u7684\u662f <code>Job</code> \u7684 <code>RestartPolicy</code> \u4ec5\u652f\u6301 <code>Never</code> \u548c <code>OnFailure</code> \u4e24\u79cd\uff0c\u4e0d\u652f\u6301 <code>Always</code>\uff0c\u6211\u4eec\u77e5\u9053 <code>Job</code> \u5c31\u76f8\u5f53\u4e8e\u6765\u6267\u884c\u4e00\u4e2a\u6279\u5904\u7406\u4efb\u52a1\uff0c\u6267\u884c\u5b8c\u5c31\u7ed3\u675f\u4e86\uff0c\u5982\u679c\u652f\u6301 <code>Always</code> \u7684\u8bdd\u662f\u4e0d\u662f\u5c31\u9677\u5165\u4e86\u6b7b\u5faa\u73af\u4e86\uff1f</p> <p>\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a Job \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f job-demo.yaml\njob.batch/job-demo created\n$ kubectl get job \nNAME       COMPLETIONS   DURATION   AGE\njob-demo   1/1           26s        3m4s\n$ kubectl get pods         \nNAME                      READY   STATUS      RESTARTS   AGE\njob-demo-frs2r            0/1     Completed   0          2m41s\n</code></pre> <p><code>Job</code> \u5bf9\u8c61\u521b\u5efa\u6210\u529f\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u4e0b\u5bf9\u8c61\u7684\u8be6\u7ec6\u63cf\u8ff0\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe job job-demo\nName:           job-demo\nNamespace:      default\nSelector:       controller-uid=b1191631-c71c-45e7-86c9-ebca69cb6125\nLabels:         controller-uid=b1191631-c71c-45e7-86c9-ebca69cb6125\n                job-name=job-demo\n.......\nPod Template:\n  Labels:  controller-uid=b1191631-c71c-45e7-86c9-ebca69cb6125\n           job-name=job-demo\n  Containers:\n   ......\nEvents:\n  Type    Reason            Age   From            Message\n  ----    ------            ----  ----            -------\n  Normal  SuccessfulCreate  49s   job-controller  Created pod: job-demo-z48h2\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0cJob \u5bf9\u8c61\u5728\u521b\u5efa\u540e\uff0c\u5b83\u7684 Pod \u6a21\u677f\uff0c\u88ab\u81ea\u52a8\u52a0\u4e0a\u4e86\u4e00\u4e2a </p> <pre><code>controller-uid=&lt; \u4e00\u4e2a\u968f\u673a\u5b57\u7b26\u4e32 &gt;\n</code></pre> <p>\u8fd9\u6837\u7684 Label \u6807\u7b7e\uff0c\u800c\u8fd9\u4e2a Job \u5bf9\u8c61\u672c\u8eab\uff0c\u5219\u88ab\u81ea\u52a8\u52a0\u4e0a\u4e86\u8fd9\u4e2a Label \u5bf9\u5e94\u7684 Selector\uff0c\u4ece\u800c \u4fdd\u8bc1\u4e86 Job \u4e0e\u5b83\u6240\u7ba1\u7406\u7684 Pod \u4e4b\u95f4\u7684\u5339\u914d\u5173\u7cfb\u3002\u800c Job \u63a7\u5236\u5668\u4e4b\u6240\u4ee5\u8981\u4f7f\u7528\u8fd9\u79cd\u643a\u5e26\u4e86 UID \u7684 Label\uff0c\u5c31\u662f\u4e3a\u4e86\u907f\u514d\u4e0d\u540c Job \u5bf9\u8c61\u6240\u7ba1\u7406\u7684 Pod \u53d1\u751f\u91cd\u5408\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5f88\u5feb Pod \u53d8\u6210\u4e86 <code>Completed</code> \u72b6\u6001\uff0c\u8fd9\u662f\u56e0\u4e3a\u5bb9\u5668\u7684\u4efb\u52a1\u6267\u884c\u5b8c\u6210\u6b63\u5e38\u9000\u51fa\u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5bf9\u5e94\u7684\u65e5\u5fd7\uff1a</p> <pre><code>$ kubectl logs job-demo-frs2r\n9\n8\n7\n6\n5\n4\n3\n2\n1\n</code></pre> <p>\u5982\u679c\u7684\u4efb\u52a1\u6267\u884c\u5931\u8d25\u4e86\uff0c\u6211\u4eec\u8fd9\u91cc\u5b9a\u4e49\u4e86 <code>restartPolicy=Never</code>\uff0c\u90a3\u4e48\u4efb\u52a1\u5728\u6267\u884c\u5931\u8d25\u540e Job \u63a7\u5236\u5668\u5c31\u4f1a\u4e0d\u65ad\u5730\u5c1d\u8bd5\u521b\u5efa\u4e00\u4e2a\u65b0 Pod\uff0c\u5f53\u7136\uff0c\u8fd9\u4e2a\u5c1d\u8bd5\u80af\u5b9a\u4e0d\u80fd\u65e0\u9650\u8fdb\u884c\u4e0b\u53bb\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Job \u5bf9\u8c61\u7684 <code>spec.backoffLimit</code> \u5b57\u6bb5\u6765\u5b9a\u4e49\u91cd\u8bd5\u6b21\u6570\uff0c\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f Job \u63a7\u5236\u5668\u91cd\u65b0\u521b\u5efa Pod \u7684\u95f4\u9694\u662f\u5448\u6307\u6570\u589e\u52a0\u7684\uff0c\u5373\u4e0b\u4e00\u6b21\u91cd\u65b0\u521b\u5efa Pod \u7684\u52a8\u4f5c\u4f1a\u5206\u522b\u53d1\u751f\u5728 10s\u300120s\u300140s\u2026 \u540e\u3002</p> <p>\u5982\u679c\u6211\u4eec\u5b9a\u4e49\u7684 </p> <pre><code>restartPolicy=OnFailure\n</code></pre> <p>\uff0c\u90a3\u4e48\u4efb\u52a1\u6267\u884c\u5931\u8d25\u540e\uff0cJob \u63a7\u5236\u5668\u5c31\u4e0d\u4f1a\u53bb\u5c1d\u8bd5\u521b\u5efa\u65b0\u7684 Pod\u4e86\uff0c\u5b83\u4f1a\u4e0d\u65ad\u5730\u5c1d\u8bd5\u91cd\u542f Pod \u91cc\u7684\u5bb9\u5668\u3002</p> <p>\u4e0a\u9762\u6211\u4eec\u8fd9\u91cc\u7684 Job \u4efb\u52a1\u5bf9\u5e94\u7684 Pod \u5728\u8fd0\u884c\u7ed3\u675f\u540e\uff0c\u4f1a\u53d8\u6210 <code>Completed</code> \u72b6\u6001\uff0c\u4f46\u662f\u5982\u679c\u6267\u884c\u4efb\u52a1\u7684 Pod \u56e0\u4e3a\u67d0\u79cd\u539f\u56e0\u4e00\u76f4\u6ca1\u6709\u7ed3\u675f\u600e\u4e48\u529e\u5462\uff1f\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u5728 Job \u5bf9\u8c61\u4e2d\u901a\u8fc7\u8bbe\u7f6e\u5b57\u6bb5 </p> <pre><code>spec.activeDeadlineSeconds\n</code></pre> <p>\u6765\u9650\u5236\u4efb\u52a1\u8fd0\u884c\u7684\u6700\u957f\u65f6\u95f4\uff0c\u6bd4\u5982\uff1a</p> <pre><code>spec:\n activeDeadlineSeconds: 100\n</code></pre> <p>\u90a3\u4e48\u5f53\u6211\u4eec\u7684\u4efb\u52a1 Pod \u8fd0\u884c\u8d85\u8fc7\u4e86 100s \u540e\uff0c\u8fd9\u4e2a Job \u7684\u6240\u6709 Pod \u90fd\u4f1a\u88ab\u7ec8\u6b62\uff0c\u5e76\u4e14\uff0c Pod \u7684\u7ec8\u6b62\u539f\u56e0\u4f1a\u53d8\u6210 <code>DeadlineExceeded</code>\u3002</p> <p>\u9664\u6b64\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e <code>spec.parallelism</code> \u53c2\u6570\u6765\u8fdb\u884c\u5e76\u884c\u63a7\u5236\uff0c\u8be5\u53c2\u6570\u5b9a\u4e49\u4e86\u4e00\u4e2a Job \u5728\u4efb\u610f\u65f6\u95f4\u6700\u591a\u53ef\u4ee5\u6709\u591a\u5c11\u4e2a Pod \u540c\u65f6\u8fd0\u884c\u3002<code>spec.completions</code> \u53c2\u6570\u53ef\u4ee5\u5b9a\u4e49 Job \u81f3\u5c11\u8981\u5b8c\u6210\u7684 Pod \u6570\u76ee\u3002</p>"},{"location":"kubernetes_controller/job/#cronjob","title":"CronJob","text":"<p><code>CronJob</code> \u5176\u5b9e\u5c31\u662f\u5728 <code>Job</code> \u7684\u57fa\u7840\u4e0a\u52a0\u4e0a\u4e86\u65f6\u95f4\u8c03\u5ea6\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u7ed9\u5b9a\u7684\u65f6\u95f4\u70b9\u8fd0\u884c\u4e00\u4e2a\u4efb\u52a1\uff0c\u4e5f\u53ef\u4ee5\u5468\u671f\u6027\u5730\u5728\u7ed9\u5b9a\u65f6\u95f4\u70b9\u8fd0\u884c\u3002\u8fd9\u4e2a\u5b9e\u9645\u4e0a\u548c\u6211\u4eec Linux \u4e2d\u7684 <code>crontab</code> \u5c31\u975e\u5e38\u7c7b\u4f3c\u4e86\u3002</p> <p>\u4e00\u4e2a <code>CronJob</code> \u5bf9\u8c61\u5176\u5b9e\u5c31\u5bf9\u5e94\u4e2d <code>crontab</code> \u6587\u4ef6\u4e2d\u7684\u4e00\u884c\uff0c\u5b83\u6839\u636e\u914d\u7f6e\u7684\u65f6\u95f4\u683c\u5f0f\u5468\u671f\u6027\u5730\u8fd0\u884c\u4e00\u4e2a<code>Job</code>\uff0c\u683c\u5f0f\u548c <code>crontab</code> \u4e5f\u662f\u4e00\u6837\u7684\u3002</p> <p>crontab \u7684\u683c\u5f0f\u4e3a\uff1a<code>\u5206 \u65f6 \u65e5 \u6708 \u661f\u671f \u8981\u8fd0\u884c\u7684\u547d\u4ee4</code> \u3002</p> <ul> <li>\u7b2c1\u5217\u5206\u949f0\uff5e59</li> <li>\u7b2c2\u5217\u5c0f\u65f60\uff5e23\uff09</li> <li>\u7b2c3\u5217\u65e51\uff5e31</li> <li>\u7b2c4\u5217\u67081\uff5e12</li> <li>\u7b2c5\u5217\u661f\u671f0\uff5e7\uff080\u548c7\u8868\u793a\u661f\u671f\u5929\uff09</li> <li>\u7b2c6\u5217\u8981\u8fd0\u884c\u7684\u547d\u4ee4</li> </ul> <p>\u73b0\u5728\uff0c\u6211\u4eec\u7528 <code>CronJob</code> \u6765\u7ba1\u7406\u6211\u4eec\u4e0a\u9762\u7684 <code>Job</code> \u4efb\u52a1\uff0c\u5b9a\u4e49\u5982\u4e0b\u6240\u793a\u7684\u8d44\u6e90\u6e05\u5355\uff1a(cronjob-demo.yaml)</p> <pre><code>apiVersion: batch/v1beta1\nkind: CronJob\nmetadata:\n  name: cronjob-demo\nspec:\n  schedule: \"*/1 * * * *\"\n  jobTemplate:\n    spec:\n      template:\n        spec:\n          restartPolicy: OnFailure\n          containers:\n          - name: hello\n            image: busybox\n            args:\n            - \"bin/sh\"\n            - \"-c\"\n            - \"for i in 9 8 7 6 5 4 3 2 1; do echo $i; done\"\n</code></pre> <p>\u8fd9\u91cc\u7684 Kind \u53d8\u6210\u4e86 <code>CronJob</code> \u4e86\uff0c\u8981\u6ce8\u610f\u7684\u662f<code>.spec.schedule</code>\u5b57\u6bb5\u662f\u5fc5\u987b\u586b\u5199\u7684\uff0c\u7528\u6765\u6307\u5b9a\u4efb\u52a1\u8fd0\u884c\u7684\u5468\u671f\uff0c\u683c\u5f0f\u5c31\u548c <code>crontab</code> \u4e00\u6837\uff0c\u53e6\u5916\u4e00\u4e2a\u5b57\u6bb5\u662f<code>.spec.jobTemplate</code>, \u7528\u6765\u6307\u5b9a\u9700\u8981\u8fd0\u884c\u7684\u4efb\u52a1\uff0c\u683c\u5f0f\u5f53\u7136\u548c <code>Job</code> \u662f\u4e00\u81f4\u7684\u3002\u8fd8\u6709\u4e00\u4e9b\u503c\u5f97\u6211\u4eec\u5173\u6ce8\u7684\u5b57\u6bb5 </p> <pre><code>.spec.successfulJobsHistoryLimit\n</code></pre> <p>\u548c </p> <pre><code>.spec.failedJobsHistoryLimit\n</code></pre> <p>\uff0c\u8868\u793a\u5386\u53f2\u9650\u5236\uff0c\u662f\u53ef\u9009\u7684\u5b57\u6bb5\uff0c\u6307\u5b9a\u53ef\u4ee5\u4fdd\u7559\u591a\u5c11\u5b8c\u6210\u548c\u5931\u8d25\u7684 <code>Job</code>\uff0c\u9ed8\u8ba4\u6ca1\u6709\u9650\u5236\uff0c\u6240\u6709\u6210\u529f\u548c\u5931\u8d25\u7684 <code>Job</code> \u90fd\u4f1a\u88ab\u4fdd\u7559\u3002\u7136\u800c\uff0c\u5f53\u8fd0\u884c\u4e00\u4e2a <code>CronJob</code> \u65f6\uff0c<code>Job</code> \u53ef\u4ee5\u5f88\u5feb\u5c31\u5806\u79ef\u5f88\u591a\uff0c\u6240\u4ee5\u4e00\u822c\u63a8\u8350\u8bbe\u7f6e\u8fd9\u4e24\u4e2a\u5b57\u6bb5\u7684\u503c\u3002\u5982\u679c\u8bbe\u7f6e\u9650\u5236\u7684\u503c\u4e3a 0\uff0c\u90a3\u4e48\u76f8\u5173\u7c7b\u578b\u7684 <code>Job</code> \u5b8c\u6210\u540e\u5c06\u4e0d\u4f1a\u88ab\u4fdd\u7559\u3002</p> <p>\u6211\u4eec\u76f4\u63a5\u65b0\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create -f cronjob-demo.yaml\ncronjob \"cronjob-demo\" created\n</code></pre> <p>\u7136\u540e\u53ef\u4ee5\u67e5\u770b\u5bf9\u5e94\u7684 Cronjob \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl get cronjob\nNAME           SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE\ncronjob-demo   */1 * * * *   False     0        &lt;none&gt;          7s\n</code></pre> <p>\u7a0d\u5fae\u7b49\u4e00\u4f1a\u513f\u67e5\u770b\u53ef\u4ee5\u53d1\u73b0\u591a\u4e86\u51e0\u4e2a Job \u8d44\u6e90\u5bf9\u8c61\uff0c\u8fd9\u4e2a\u5c31\u662f\u56e0\u4e3a\u4e0a\u9762\u6211\u4eec\u8bbe\u7f6e\u7684 CronJob \u8d44\u6e90\u5bf9\u8c61\uff0c\u6bcf1\u5206\u949f\u6267\u884c\u4e00\u4e2a\u65b0\u7684 Job\uff1a</p> <pre><code>$ kubectl get job \nNAME                      COMPLETIONS   DURATION   AGE\ncronjob-demo-1574147280   1/1           6s         2m45s\ncronjob-demo-1574147340   1/1           11s        105s\ncronjob-demo-1574147400   1/1           5s         45s\n$ kubectl get pods\nNAME                      READY   STATUS      RESTARTS   AGE\ncronjob-demo-1574147340-ksd5x   0/1     Completed           0          3m7s\ncronjob-demo-1574147400-pts94   0/1     Completed           0          2m7s\ncronjob-demo-1574147460-t5hcd   0/1     Completed           0          67s\ncronjob-demo-1574147520-vmjfr   0/1     ContainerCreating   0          7s\n</code></pre> <p>\u8fd9\u4e2a\u5c31\u662f CronJob \u7684\u57fa\u672c\u7528\u6cd5\uff0c\u4e00\u65e6\u4e0d\u518d\u9700\u8981 CronJob\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 kubectl \u547d\u4ee4\u5220\u9664\u5b83\uff1a</p> <pre><code>$ kubectl delete cronjob cronjob-demo\ncronjob \"cronjob-demo\" deleted\n</code></pre> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u8fd9\u5c06\u4f1a\u7ec8\u6b62\u6b63\u5728\u521b\u5efa\u7684 Job\uff0c\u4f46\u662f\u8fd0\u884c\u4e2d\u7684 Job \u5c06\u4e0d\u4f1a\u88ab\u7ec8\u6b62\uff0c\u4e0d\u4f1a\u5220\u9664 Job \u6216 \u5b83\u4eec\u7684 Pod\u3002</p>"},{"location":"kubernetes_controller/replicaset/","title":"ReplicaSet","text":"<p>\ue3c9</p>"},{"location":"kubernetes_controller/replicaset/#replicaset","title":"ReplicaSet \u63a7\u5236\u5668","text":"<p>\u524d\u9762\u6211\u4eec\u4e00\u8d77\u5b66\u4e60\u4e86 Pod \u7684\u539f\u7406\u548c\u4e00\u4e9b\u57fa\u672c\u4f7f\u7528\uff0c\u4f46\u662f\u5728\u5b9e\u9645\u4f7f\u7528\u7684\u65f6\u5019\u5e76\u4e0d\u4f1a\u76f4\u63a5\u4f7f\u7528 Pod\uff0c\u800c\u662f\u4f1a\u4f7f\u7528\u5404\u79cd\u63a7\u5236\u5668\u6765\u6ee1\u8db3\u6211\u4eec\u7684\u9700\u6c42\uff0cKubernetes \u4e2d\u8fd0\u884c\u4e86\u4e00\u7cfb\u5217\u63a7\u5236\u5668\u6765\u786e\u4fdd\u96c6\u7fa4\u7684\u5f53\u524d\u72b6\u6001\u4e0e\u671f\u671b\u72b6\u6001\u4fdd\u6301\u4e00\u81f4\uff0c\u5b83\u4eec\u5c31\u662f Kubernetes \u7684\u5927\u8111\u3002\u4f8b\u5982\uff0cReplicaSet \u63a7\u5236\u5668\u8d1f\u8d23\u7ef4\u62a4\u96c6\u7fa4\u4e2d\u8fd0\u884c\u7684 Pod \u6570\u91cf\uff1bNode \u63a7\u5236\u5668\u8d1f\u8d23\u76d1\u63a7\u8282\u70b9\u7684\u72b6\u6001\uff0c\u5e76\u5728\u8282\u70b9\u51fa\u73b0\u6545\u969c\u65f6\u53ca\u65f6\u505a\u51fa\u54cd\u5e94\u3002\u603b\u800c\u8a00\u4e4b\uff0c\u5728 Kubernetes \u4e2d\uff0c\u6bcf\u4e2a\u63a7\u5236\u5668\u53ea\u8d1f\u8d23\u67d0\u79cd\u7c7b\u578b\u7684\u7279\u5b9a\u8d44\u6e90\u3002</p>"},{"location":"kubernetes_controller/replicaset/#_1","title":"\u63a7\u5236\u5668","text":"<p>Kubernetes \u63a7\u5236\u5668\u4f1a\u76d1\u542c\u8d44\u6e90\u7684 <code>\u521b\u5efa/\u66f4\u65b0/\u5220\u9664</code> \u4e8b\u4ef6\uff0c\u5e76\u89e6\u53d1 <code>Reconcile</code> \u51fd\u6570\u4f5c\u4e3a\u54cd\u5e94\u3002\u6574\u4e2a\u8c03\u6574\u8fc7\u7a0b\u88ab\u79f0\u4f5c </p> <pre><code>Reconcile Loop\uff08\u8c03\u8c10\u5faa\u73af\uff09\n</code></pre> <p>\u6216\u8005 <code>Sync Loop\uff08\u540c\u6b65\u5faa\u73af\uff09</code>\u3002Reconcile \u662f\u4e00\u4e2a\u4f7f\u7528\u8d44\u6e90\u5bf9\u8c61\u7684\u547d\u540d\u7a7a\u95f4\u548c\u8d44\u6e90\u5bf9\u8c61\u540d\u79f0\u6765\u8c03\u7528\u7684\u51fd\u6570\uff0c\u4f7f\u5f97\u8d44\u6e90\u5bf9\u8c61\u7684\u5b9e\u9645\u72b6\u6001\u4e0e \u8d44\u6e90\u6e05\u5355\u4e2d\u5b9a\u4e49\u7684\u72b6\u6001\u4fdd\u6301\u4e00\u81f4\u3002\u8c03\u7528\u5b8c\u6210\u540e\uff0cReconcile \u4f1a\u5c06\u8d44\u6e90\u5bf9\u8c61\u7684\u72b6\u6001\u66f4\u65b0\u4e3a\u5f53\u524d\u5b9e\u9645\u72b6\u6001\u3002\u6211\u4eec\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u4e00\u6bb5\u4f2a\u4ee3\u7801\u6765\u8868\u793a\u8fd9\u4e2a\u8fc7\u7a0b\uff1a</p> <pre><code>for {\n  desired := getDesiredState()  // \u671f\u671b\u7684\u72b6\u6001\n  current := getCurrentState()  // \u5f53\u524d\u5b9e\u9645\u72b6\u6001\n  if current == desired {  // \u5982\u679c\u72b6\u6001\u4e00\u81f4\u5219\u4ec0\u4e48\u90fd\u4e0d\u505a\n    // nothing to do\n  } else {  // \u5982\u679c\u72b6\u6001\u4e0d\u4e00\u81f4\u5219\u8c03\u6574\u7f16\u6392\uff0c\u5230\u4e00\u81f4\u4e3a\u6b62\n    // change current to desired status\n  }\n}\n</code></pre> <p>\u8fd9\u4e2a\u7f16\u6392\u6a21\u578b\u5c31\u662f Kubernetes \u9879\u76ee\u4e2d\u7684\u4e00\u4e2a\u901a\u7528\u7f16\u6392\u6a21\u5f0f\uff0c\u5373\uff1a<code>\u63a7\u5236\u5faa\u73af\uff08control loop\uff09</code>\u3002</p>"},{"location":"kubernetes_controller/replicaset/#replicaset_1","title":"ReplicaSet","text":"<p>\u5047\u5982\u6211\u4eec\u73b0\u5728\u6709\u4e00\u4e2a Pod \u6b63\u5728\u63d0\u4f9b\u7ebf\u4e0a\u7684\u670d\u52a1\uff0c\u6211\u4eec\u6765\u60f3\u60f3\u4e00\u4e0b\u6211\u4eec\u53ef\u80fd\u4f1a\u9047\u5230\u7684\u4e00\u4e9b\u573a\u666f\uff1a</p> <ul> <li>\u67d0\u6b21\u8fd0\u8425\u6d3b\u52a8\u975e\u5e38\u6210\u529f\uff0c\u7f51\u7ad9\u8bbf\u95ee\u91cf\u7a81\u7136\u66b4\u589e</li> <li>\u8fd0\u884c\u5f53\u524d Pod \u7684\u8282\u70b9\u53d1\u751f\u6545\u969c\u4e86\uff0cPod \u4e0d\u80fd\u6b63\u5e38\u63d0\u4f9b\u670d\u52a1\u4e86</li> </ul> <p>\u7b2c\u4e00\u79cd\u60c5\u51b5\uff0c\u53ef\u80fd\u6bd4\u8f83\u597d\u5e94\u5bf9\uff0c\u6d3b\u52a8\u4e4b\u524d\u6211\u4eec\u53ef\u4ee5\u5927\u6982\u8ba1\u7b97\u4e0b\u4f1a\u6709\u591a\u5927\u7684\u8bbf\u95ee\u91cf\uff0c\u63d0\u524d\u591a\u542f\u52a8\u51e0\u4e2a Pod \u526f\u672c\uff0c\u6d3b\u52a8\u7ed3\u675f\u540e\u518d\u628a\u591a\u4f59\u7684 Pod \u6740\u6389\uff0c\u867d\u7136\u6709\u70b9\u9ebb\u70e6\uff0c\u4f46\u662f\u8fd8\u662f\u80fd\u591f\u5e94\u5bf9\u8fd9\u79cd\u60c5\u51b5\u7684\u3002</p> <p>\u7b2c\u4e8c\u79cd\u60c5\u51b5\uff0c\u53ef\u80fd\u67d0\u5929\u591c\u91cc\u6536\u5230\u5927\u91cf\u62a5\u8b66\u8bf4\u670d\u52a1\u6302\u4e86\uff0c\u7136\u540e\u8d77\u6765\u6253\u5f00\u7535\u8111\u5728\u53e6\u5916\u7684\u8282\u70b9\u4e0a\u91cd\u65b0\u542f\u52a8\u4e00\u4e2a\u65b0\u7684 Pod\uff0c\u95ee\u9898\u53ef\u4ee5\u89e3\u51b3\u3002</p> <p>\u4f46\u662f\u5982\u679c\u6211\u4eec\u90fd\u4eba\u5de5\u7684\u53bb\u89e3\u51b3\u9047\u5230\u7684\u8fd9\u4e9b\u95ee\u9898\uff0c\u4f3c\u4e4e\u53c8\u56de\u5230\u4e86\u4ee5\u524d\u5200\u8015\u706b\u79cd\u7684\u65f6\u4ee3\u4e86\u662f\u5427\uff1f\u5982\u679c\u6709\u4e00\u79cd\u5de5\u5177\u80fd\u591f\u6765\u5e2e\u52a9\u6211\u4eec\u81ea\u52a8\u7ba1\u7406 Pod \u5c31\u597d\u4e86\uff0cPod \u6302\u4e86\u81ea\u52a8\u5e2e\u6211\u5728\u5408\u9002\u7684\u8282\u70b9\u4e0a\u91cd\u65b0\u542f\u52a8\u4e00\u4e2a Pod\uff0c\u8fd9\u6837\u662f\u4e0d\u662f\u9047\u5230\u4e0a\u9762\u7684\u95ee\u9898\u6211\u4eec\u90fd\u4e0d\u9700\u8981\u624b\u52a8\u53bb\u89e3\u51b3\u4e86\u3002</p> <p>\u800c ReplicaSet \u8fd9\u79cd\u8d44\u6e90\u5bf9\u8c61\u5c31\u53ef\u4ee5\u6765\u5e2e\u52a9\u6211\u4eec\u5b9e\u73b0\u8fd9\u4e2a\u529f\u80fd\uff0c<code>ReplicaSet\uff08RS\uff09</code> \u7684\u4e3b\u8981\u4f5c\u7528\u5c31\u662f\u7ef4\u6301\u4e00\u7ec4 Pod \u526f\u672c\u7684\u8fd0\u884c\uff0c\u4fdd\u8bc1\u4e00\u5b9a\u6570\u91cf\u7684 Pod \u5728\u96c6\u7fa4\u4e2d\u6b63\u5e38\u8fd0\u884c\uff0cReplicaSet \u63a7\u5236\u5668\u4f1a\u6301\u7eed\u76d1\u542c\u5b83\u8bf4\u63a7\u5236\u7684\u8fd9\u4e9b Pod \u7684\u8fd0\u884c\u72b6\u6001\uff0c\u5728 Pod \u53d1\u9001\u6545\u969c\u6570\u91cf\u51cf\u5c11\u6216\u8005\u589e\u52a0\u65f6\u4f1a\u89e6\u53d1\u8c03\u8c10\u8fc7\u7a0b\uff0c\u59cb\u7ec8\u4fdd\u6301\u526f\u672c\u6570\u91cf\u4e00\u5b9a\u3002</p> <p>\u548c Pod \u4e00\u6837\u6211\u4eec\u4ecd\u7136\u8fd8\u662f\u901a\u8fc7 YAML \u6587\u4ef6\u6765\u63cf\u8ff0\u6211\u4eec\u7684 ReplicaSet \u8d44\u6e90\u5bf9\u8c61\uff0c\u5982\u4e0b YAML \u6587\u4ef6\u662f\u4e00\u4e2a\u5e38\u89c1\u7684 ReplicaSet \u5b9a\u4e49\uff1a(nginx-rs.yaml)</p> <pre><code>apiVersion: apps/v1\nkind: ReplicaSet  \nmetadata:\n  name:  nginx-rs\n  namespace: default\nspec:\n  replicas: 3  # \u671f\u671b\u7684 Pod \u526f\u672c\u6570\u91cf\uff0c\u9ed8\u8ba4\u503c\u4e3a1\n  selector:  # Label Selector\uff0c\u5fc5\u987b\u5339\u914d Pod \u6a21\u677f\u4e2d\u7684\u6807\u7b7e\n    matchLabels:\n      app: nginx\n  template:  # Pod \u6a21\u677f\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx\n        ports:\n        - containerPort: 80\n</code></pre> <p>\u4e0a\u9762\u7684 YAML \u6587\u4ef6\u7ed3\u6784\u548c\u6211\u4eec\u4e4b\u524d\u5b9a\u4e49\u7684 Pod \u770b\u4e0a\u53bb\u6ca1\u592a\u5927\u4e24\u6837\uff0c\u6709\u5e38\u89c1\u7684 apiVersion\u3001kind\u3001metadata\uff0c\u5728 spec \u4e0b\u9762\u63cf\u8ff0 ReplicaSet \u7684\u57fa\u672c\u4fe1\u606f\uff0c\u5176\u4e2d\u5305\u542b3\u4e2a\u91cd\u8981\u5185\u5bb9\uff1a</p> <ul> <li>replias\uff1a\u8868\u793a\u671f\u671b\u7684 Pod \u7684\u526f\u672c\u6570\u91cf</li> <li>selector\uff1aLabel Selector\uff0c\u7528\u6765\u5339\u914d\u8981\u63a7\u5236\u7684 Pod \u6807\u7b7e\uff0c\u9700\u8981\u548c\u4e0b\u9762\u7684 Pod \u6a21\u677f\u4e2d\u7684\u6807\u7b7e\u4e00\u81f4</li> <li>template\uff1aPod \u6a21\u677f\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f\u4ee5\u524d\u6211\u4eec\u5b9a\u4e49\u7684 Pod \u5185\u5bb9\uff0c\u76f8\u5f53\u4e8e\u628a\u4e00\u4e2a Pod \u7684\u63cf\u8ff0\u4ee5\u6a21\u677f\u7684\u5f62\u5f0f\u5d4c\u5165\u5230\u4e86 ReplicaSet \u4e2d\u6765\u3002</li> </ul> <p>Pod \u6a21\u677f</p> <p>Pod \u6a21\u677f\u8fd9\u4e2a\u6982\u5ff5\u975e\u5e38\u91cd\u8981\uff0c\u56e0\u4e3a\u540e\u9762\u6211\u4eec\u8bb2\u89e3\u5230\u7684\u5927\u591a\u6570\u63a7\u5236\u5668\uff0c\u90fd\u4f1a\u4f7f\u7528 Pod \u6a21\u677f\u6765\u7edf\u4e00\u5b9a\u4e49\u5b83\u6240\u8981\u7ba1\u7406\u7684 Pod\u3002\u66f4\u6709\u610f\u601d\u7684\u662f\uff0c\u6211\u4eec\u8fd8\u4f1a\u770b\u5230\u5176\u4ed6\u7c7b\u578b\u7684\u5bf9\u8c61\u6a21\u677f\uff0c\u6bd4\u5982 Volume \u7684\u6a21\u677f\u767b\u3002</p> <p>\u4e0a\u9762\u5c31\u662f\u6211\u4eec\u5b9a\u4e49\u7684\u4e00\u4e2a\u666e\u901a\u7684 ReplicaSet \u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0cReplicaSet \u63a7\u5236\u5668\u4f1a\u901a\u8fc7\u5b9a\u4e49\u7684 Label Selector \u6807\u7b7e\u53bb\u67e5\u627e\u96c6\u7fa4\u4e2d\u7684 Pod \u5bf9\u8c61\uff1a</p> <p></p> <p>\u6211\u4eec\u76f4\u63a5\u6765\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f nginx-rs.yaml\nreplicaset.apps/nginx-rs created\n$ kubectl get rs nginx-rs\nNAME       DESIRED   CURRENT   READY   AGE\nnginx-rs   3         3         3       17m\n</code></pre> <p>\u901a\u8fc7\u67e5\u770b RS \u53ef\u4ee5\u770b\u5230\u5f53\u524d\u8d44\u6e90\u5bf9\u8c61\u7684\u63cf\u8ff0\u4fe1\u606f\uff0c\u5305\u62ec<code>DESIRED</code>\u3001<code>CURRENT</code>\u3001<code>READY</code>\u7684\u72b6\u6001\u503c\uff0c\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u5229\u7528\u5982\u4e0b\u547d\u4ee4\u67e5\u770b\u4e0b Pod \u5217\u8868\uff1a</p> <pre><code>$ kubectl get pods -l app=nginx\nNAME             READY   STATUS              RESTARTS   AGE\nnginx-rs-nxklf   1/1     Running   0          52s\nnginx-rs-t46qc   1/1     Running   0          52s\nnginx-rs-xfqrn   1/1     Running   0          52s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u73b0\u5728\u6709 3 \u4e2a Pod\uff0c\u8fd9 3 \u4e2a Pod \u5c31\u662f\u6211\u4eec\u5728 RS \u4e2d\u58f0\u660e\u7684 3 \u4e2a\u526f\u672c\uff0c\u6bd4\u5982\u6211\u4eec\u5220\u9664\u5176\u4e2d\u4e00\u4e2a Pod\uff1a</p> <pre><code>$ kubectl delete pod nginx-rs-xfqrn\npod \"nginx-rs-xfqrn\" deleted\n</code></pre> <p>\u7136\u540e\u518d\u67e5\u770b Pod \u5217\u8868\uff1a</p> <pre><code>$ kubectl get pods -l app=nginx    \nNAME             READY   STATUS    RESTARTS   AGE\nnginx-rs-nxklf   1/1     Running   0          3m19s\nnginx-rs-t46qc   1/1     Running   0          3m19s\nnginx-rs-xsb59   1/1     Running   0          10s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u53c8\u91cd\u65b0\u51fa\u73b0\u4e86\u4e00\u4e2a Pod\uff0c\u8fd9\u4e2a\u5c31\u662f\u4e0a\u9762\u6211\u4eec\u6240\u8bf4\u7684 ReplicaSet \u63a7\u5236\u5668\u4e3a\u6211\u4eec\u505a\u7684\u5de5\u4f5c\uff0c\u6211\u4eec\u5728 YAML \u6587\u4ef6\u4e2d\u58f0\u660e\u4e86 3 \u4e2a\u526f\u672c\uff0c\u7136\u540e\u73b0\u5728\u6211\u4eec\u5220\u9664\u4e86\u4e00\u4e2a\u526f\u672c\uff0c\u5c31\u53d8\u6210\u4e86\u4e24\u4e2a\uff0c\u8fd9\u4e2a\u65f6\u5019 ReplicaSet \u63a7\u5236\u5668\u76d1\u63a7\u5230\u63a7\u5236\u7684 Pod \u6570\u91cf\u548c\u671f\u671b\u7684 3 \u4e0d\u4e00\u81f4\uff0c\u6240\u4ee5\u5c31\u9700\u8981\u542f\u52a8\u4e00\u4e2a\u65b0\u7684 Pod \u6765\u4fdd\u6301 3 \u4e2a\u526f\u672c\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u4e0a\u9762\u6211\u4eec\u8bf4\u4e86\u5c31\u662f<code>\u8c03\u8c10</code>\u7684\u8fc7\u7a0b\u3002\u540c\u6837\u53ef\u4ee5\u67e5\u770b RS \u7684\u63cf\u8ff0\u4fe1\u606f\u6765\u67e5\u770b\u5230\u76f8\u5173\u7684\u4e8b\u4ef6\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe rs nginx-rs\nName:         nginx-rs\nNamespace:    default\nSelector:     app=nginx\nLabels:       &lt;none&gt;\nAnnotations:  kubectl.kubernetes.io/last-applied-configuration:\n                {\"apiVersion\":\"apps/v1\",\"kind\":\"ReplicaSet\",\"metadata\":{\"annotations\":{},\"name\":\"nginx-rs\",\"namespace\":\"default\"},\"spec\":{\"replicas\":3,\"se...\nReplicas:     3 current / 3 desired\nPods Status:  3 Running / 0 Waiting / 0 Succeeded / 0 Failed\nPod Template:\n  Labels:  app=nginx\n  Containers:\n   nginx:\n    Image:        nginx\n    Port:         80/TCP\n    Host Port:    0/TCP\n    Environment:  &lt;none&gt;\n    Mounts:       &lt;none&gt;\n  Volumes:        &lt;none&gt;\nEvents:\n  Type    Reason            Age   From                   Message\n  ----    ------            ----  ----                   -------\n  Normal  SuccessfulCreate  17m   replicaset-controller  Created pod: nginx-rs-xfqrn\n  Normal  SuccessfulCreate  17m   replicaset-controller  Created pod: nginx-rs-nxklf\n  Normal  SuccessfulCreate  17m   replicaset-controller  Created pod: nginx-rs-t46qc\n  Normal  SuccessfulCreate  14m   replicaset-controller  Created pod: nginx-rs-xsb59\n</code></pre> <p>\u53ef\u4ee5\u53d1\u73b0\u6700\u5f00\u59cb\u901a\u8fc7 ReplicaSet \u63a7\u5236\u5668\u521b\u5efa\u4e86 3 \u4e2a Pod\uff0c\u540e\u9762\u6211\u4eec\u5220\u9664\u4e86 Pod \u540e\uff0c ReplicaSet \u63a7\u5236\u5668\u53c8\u4e3a\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2a Pod\uff0c\u548c\u4e0a\u9762\u6211\u4eec\u7684\u63cf\u8ff0\u662f\u4e00\u81f4\u7684\u3002\u5982\u679c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u628a RS \u8d44\u6e90\u5bf9\u8c61\u7684 Pod \u526f\u672c\u66f4\u6539\u4e3a 2 <code>spec.replicas=2</code>\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u6765\u66f4\u65b0\u4e0b\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f rs.yaml \nreplicaset.apps/nginx-rs configured\n$ kubectl get rs nginx-rs \nNAME       DESIRED   CURRENT   READY   AGE\nnginx-rs   2         2         2       27m\n$ kubectl describe rs nginx-rs\nName:         nginx-rs\nNamespace:    default\nSelector:     app=nginx\nLabels:       &lt;none&gt;\nAnnotations:  kubectl.kubernetes.io/last-applied-configuration:\n                {\"apiVersion\":\"apps/v1\",\"kind\":\"ReplicaSet\",\"metadata\":{\"annotations\":{},\"name\":\"nginx-rs\",\"namespace\":\"default\"},\"spec\":{\"replicas\":2,\"se...\nReplicas:     2 current / 2 desired\nPods Status:  2 Running / 1 Waiting / 0 Succeeded / 0 Failed\nPod Template:\n  Labels:  app=nginx\n  Containers:\n   nginx:\n    Image:        nginx\n    Port:         80/TCP\n    Host Port:    0/TCP\n    Environment:  &lt;none&gt;\n    Mounts:       &lt;none&gt;\n  Volumes:        &lt;none&gt;\nEvents:\n  Type    Reason            Age   From                   Message\n  ----    ------            ----  ----                   -------\n  Normal  SuccessfulCreate  27m   replicaset-controller  Created pod: nginx-rs-xfqrn\n  Normal  SuccessfulCreate  27m   replicaset-controller  Created pod: nginx-rs-nxklf\n  Normal  SuccessfulCreate  27m   replicaset-controller  Created pod: nginx-rs-t46qc\n  Normal  SuccessfulCreate  24m   replicaset-controller  Created pod: nginx-rs-xsb59\n  Normal  SuccessfulDelete  7s    replicaset-controller  Deleted pod: nginx-rs-xsb59\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 Replicaset \u63a7\u5236\u5668\u5728\u53d1\u73b0\u6211\u4eec\u7684\u8d44\u6e90\u58f0\u660e\u4e2d\u526f\u672c\u6570\u53d8\u66f4\u4e3a 2 \u540e\uff0c\u5c31\u4e3b\u52a8\u53bb\u5220\u9664\u4e86\u4e00\u4e2a Pod\uff0c\u8fd9\u6837\u526f\u672c\u6570\u5c31\u548c\u671f\u671b\u7684\u59cb\u7ec8\u4fdd\u6301\u4e00\u81f4\u4e86\uff1a</p> <pre><code>$ kubectl get pods -l app=nginx\nNAME             READY   STATUS    RESTARTS   AGE\nnginx-rs-nxklf   1/1     Running   0          30m\nnginx-rs-t46qc   1/1     Running   0          30m\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u968f\u4fbf\u67e5\u770b\u4e00\u4e2a Pod \u7684\u63cf\u8ff0\u4fe1\u606f\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a Pod \u7684\u6240\u5c5e\u63a7\u5236\u5668\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe pod nginx-rs-xsb59\nName:               nginx-rs-xsb59\nNamespace:          default\nPriority:           0\nPriorityClassName:  &lt;none&gt;\nNode:               ydzs-node1/122\nStart Time:         Fri, 15 Nov 2019 14:18:10 +0800\nLabels:             app=nginx\nAnnotations:        &lt;none&gt;\nStatus:             Running\nIP:                 2148\nControlled By:      ReplicaSet/nginx-rs\n.......\n</code></pre> <p>\u53e6\u5916\u88ab ReplicaSet \u6301\u6709\u7684 Pod \u6709\u4e00\u4e2a </p> <pre><code>metadata.ownerReferences\n</code></pre> <p>\u6307\u9488\u6307\u5411\u5f53\u524d\u7684 ReplicaSet\uff0c\u8868\u793a\u5f53\u524d Pod \u7684\u6240\u6709\u8005\uff0c\u8fd9\u4e2a\u5f15\u7528\u4e3b\u8981\u4f1a\u88ab\u96c6\u7fa4\u4e2d\u7684<code>\u5783\u573e\u6536\u96c6\u5668</code>\u4f7f\u7528\u4ee5\u6e05\u7406\u5931\u53bb\u6240\u6709\u8005\u7684 Pod \u5bf9\u8c61\u3002\u8fd9\u4e2a <code>ownerReferences</code> \u548c\u6570\u636e\u5e93\u4e2d\u7684<code>\u5916\u952e</code>\u662f\u4e0d\u662f\u975e\u5e38\u7c7b\u4f3c\u3002\u53ef\u4ee5\u901a\u8fc7\u5c06 Pod \u8d44\u6e90\u63cf\u8ff0\u4fe1\u606f\u5bfc\u51fa\u67e5\u770b\uff1a</p> <pre><code>$ kubectl get pod nginx-rs-xsb59 -o yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  creationTimestamp: \"2019-11-15T06:18:10Z\"\n  generateName: nginx-rs-\n  labels:\n    app: nginx\n  name: nginx-rs-xsb59\n  namespace: default\n  ownerReferences:  \n  - apiVersion: apps/v1\n    blockOwnerDeletion: true\n    controller: true\n    kind: ReplicaSet\n    name: nginx-rs\n    uid: 4a3121fa-b5ae-4def-b2d2-bf17bc06b7b7\n  resourceVersion: \"1781596\"\n  selfLink: /api/v1/namespaces/default/pods/nginx-rs-xsb59\n  uid: 0a4cae9a-105b-4024-ae96-ee516bfb2d23\n......\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Pod \u4e2d\u6709\u4e00\u4e2a </p> <pre><code>metadata.ownerReferences\n</code></pre> <p>\u7684\u5b57\u6bb5\u6307\u5411\u4e86 ReplicaSet \u8d44\u6e90\u5bf9\u8c61\u3002\u5982\u679c\u8981\u5f7b\u5e95\u5220\u9664 Pod\uff0c\u6211\u4eec\u5c31\u53ea\u80fd\u5220\u9664 RS \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl delete rs nginx-rs\n# \u6216\u8005\u6267\u884c kubectl delete -f nginx-rs.yaml\n</code></pre> <p>\u8fd9\u5c31\u662f ReplicaSet \u5bf9\u8c61\u7684\u57fa\u672c\u4f7f\u7528\u3002</p>"},{"location":"kubernetes_controller/replicaset/#replication_controller","title":"Replication Controller","text":"<p>Replication Controller \u7b80\u79f0 RC\uff0c\u5b9e\u9645\u4e0a RC \u548c RS \u7684\u529f\u80fd\u51e0\u4e4e\u4e00\u81f4\uff0cRS \u7b97\u662f\u5bf9 RC \u7684\u6539\u8fdb\uff0c\u76ee\u524d\u552f\u4e00\u7684\u4e00\u4e2a\u533a\u522b\u5c31\u662f RC \u53ea\u652f\u6301\u57fa\u4e8e\u7b49\u5f0f\u7684 selector\uff08env=dev\u6216environment!=qa\uff09\uff0c\u4f46 RS \u8fd8\u652f\u6301\u57fa\u4e8e\u96c6\u5408\u7684 selector\uff08version in (v1.0, v2.0)\uff09\uff0c\u8fd9\u5bf9\u590d\u6742\u7684\u8fd0\u7ef4\u7ba1\u7406\u5c31\u975e\u5e38\u65b9\u4fbf\u4e86\u3002</p> <p>\u6bd4\u5982\u4e0a\u9762\u8d44\u6e90\u5bf9\u8c61\u5982\u679c\u6211\u4eec\u8981\u4f7f\u7528 RC \u7684\u8bdd\uff0c\u5bf9\u5e94\u7684 selector \u662f\u8fd9\u6837\u7684\uff1a</p> <pre><code>selector: \n  app: nginx\n</code></pre> <p>RC \u53ea\u652f\u6301\u5355\u4e2a Label \u7684\u7b49\u5f0f\uff0c\u800c RS \u4e2d\u7684 Label Selector \u652f\u6301 <code>matchLabels</code> \u548c <code>matchExpressions</code> \u4e24\u79cd\u5f62\u5f0f\uff1a</p> <pre><code>selector:  \n  matchLabels:\n    app: nginx\n\n---\nselector:\n  matchExpressions:  # \u8be5\u9009\u62e9\u5668\u8981\u6c42 Pod \u5305\u542b\u540d\u4e3a app \u7684\u6807\u7b7e\n  - key: app\n    operator: In\n    values:  # \u5e76\u4e14\u6807\u7b7e\u7684\u503c\u5fc5\u987b\u662f nginx\n    - nginx\n</code></pre> <p>\u603b\u7684\u6765\u8bf4 RS \u662f\u65b0\u4e00\u4ee3\u7684 RC\uff0c\u6240\u4ee5\u4ee5\u540e\u6211\u4eec\u4e0d\u4f7f\u7528 RC\uff0c\u76f4\u63a5\u4f7f\u7528 RS \u5373\u53ef\uff0c\u4ed6\u4eec\u7684\u529f\u80fd\u90fd\u662f\u4e00\u81f4\u7684\uff0c\u4f46\u662f\u5b9e\u9645\u4e0a\u5728\u5b9e\u9645\u4f7f\u7528\u4e2d\u6211\u4eec\u4e5f\u4e0d\u4f1a\u76f4\u63a5\u4f7f\u7528 RS\uff0c\u800c\u662f\u4f7f\u7528\u66f4\u4e0a\u5c42\u7684\u7c7b\u4f3c\u4e8e Deployment \u8fd9\u6837\u7684\u8d44\u6e90\u5bf9\u8c61\u3002</p>"},{"location":"kubernetes_controller/statefulset/","title":"StatefulSet","text":"<p>\ue3c9</p>"},{"location":"kubernetes_controller/statefulset/#statefulset","title":"StatefulSet \u63a7\u5236\u5668","text":"<p>\u524d\u9762\u6211\u4eec\u5b66\u4e60\u4e86 Deployment \u548c ReplicaSet \u4e24\u79cd\u8d44\u6e90\u5bf9\u8c61\u5f97\u4f7f\u7528\uff0c\u5728\u5b9e\u9645\u4f7f\u7528\u7684\u8fc7\u7a0b\u4e2d\uff0cDeployment \u5e76\u4e0d\u80fd\u7f16\u6392\u6240\u6709\u7c7b\u578b\u7684\u5e94\u7528\uff0c\u5bf9<code>\u65e0\u72b6\u6001\u670d\u52a1</code>\u7f16\u6392\u662f\u975e\u5e38\u5bb9\u6613\u7684\uff0c\u4f46\u662f\u5bf9\u4e8e<code>\u6709\u72b6\u6001\u670d\u52a1</code>\u5c31\u65e0\u80fd\u4e3a\u529b\u4e86\u3002\u6211\u4eec\u9700\u8981\u5148\u660e\u767d\u4e00\u4e2a\u6982\u5ff5\uff1a\u4ec0\u4e48\u662f\u6709\u72b6\u6001\u670d\u52a1\uff0c\u4ec0\u4e48\u662f\u65e0\u72b6\u6001\u670d\u52a1\u3002</p> <ul> <li> <p><code>\u65e0\u72b6\u6001\u670d\u52a1\uff08Stateless Service\uff09</code></p> <p>\uff1a\u8be5\u670d\u52a1\u8fd0\u884c\u7684\u5b9e\u4f8b\u4e0d\u4f1a\u5728\u672c\u5730\u5b58\u50a8\u9700\u8981\u6301\u4e45\u5316\u7684\u6570\u636e\uff0c\u5e76\u4e14\u591a\u4e2a\u5b9e\u4f8b\u5bf9\u4e8e\u540c\u4e00\u4e2a\u8bf7\u6c42\u54cd\u5e94\u7684\u7ed3\u679c\u662f\u5b8c\u5168\u4e00\u81f4\u7684\uff0c\u6bd4\u5982\u524d\u9762\u6211\u4eec\u8bb2\u89e3\u7684 WordPress \u5b9e\u4f8b\uff0c\u6211\u4eec\u662f\u4e0d\u662f\u53ef\u4ee5\u540c\u65f6\u542f\u52a8\u591a\u4e2a\u5b9e\u4f8b\uff0c\u4f46\u662f\u6211\u4eec\u8bbf\u95ee\u4efb\u610f\u4e00\u4e2a\u5b9e\u4f8b\u5f97\u5230\u7684\u7ed3\u679c\u90fd\u662f\u4e00\u6837\u7684\u5427\uff1f\u56e0\u4e3a\u4ed6\u552f\u4e00\u9700\u8981\u6301\u4e45\u5316\u7684\u6570\u636e\u662f\u5b58\u50a8\u5728MySQL\u6570\u636e\u5e93\u4e2d\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u8bf4 WordPress \u8fd9\u4e2a\u5e94\u7528\u662f\u65e0\u72b6\u6001\u670d\u52a1\uff0c\u4f46\u662f MySQL \u6570\u636e\u5e93\u5c31\u4e0d\u662f\u4e86\uff0c\u56e0\u4e3a\u4ed6\u9700\u8981\u628a\u6570\u636e\u6301\u4e45\u5316\u5230\u672c\u5730\u3002 *   <code>\u6709\u72b6\u6001\u670d\u52a1\uff08Stateful Service\uff09</code></p> <p>\uff1a\u5c31\u548c\u4e0a\u9762\u7684\u6982\u5ff5\u662f\u5bf9\u7acb\u7684\u4e86\uff0c\u8be5\u670d\u52a1\u8fd0\u884c\u7684\u5b9e\u4f8b\u9700\u8981\u5728\u672c\u5730\u5b58\u50a8\u6301\u4e45\u5316\u6570\u636e\uff0c\u6bd4\u5982\u4e0a\u9762\u7684 MySQL \u6570\u636e\u5e93\uff0c\u4f60\u73b0\u5728\u8fd0\u884c\u5728\u8282\u70b9 A\uff0c\u90a3\u4e48\u4ed6\u7684\u6570\u636e\u5c31\u5b58\u50a8\u5728\u8282\u70b9 A \u4e0a\u9762\u7684\uff0c\u5982\u679c\u8fd9\u4e2a\u65f6\u5019\u4f60\u628a\u8be5\u670d\u52a1\u8fc1\u79fb\u5230\u8282\u70b9 B \u53bb\u7684\u8bdd\uff0c\u90a3\u4e48\u5c31\u6ca1\u6709\u4e4b\u524d\u7684\u6570\u636e\u4e86\uff0c\u56e0\u4e3a\u4ed6\u9700\u8981\u53bb\u5bf9\u5e94\u7684\u6570\u636e\u76ee\u5f55\u91cc\u9762\u6062\u590d\u6570\u636e\uff0c\u800c\u6b64\u65f6\u6ca1\u6709\u4efb\u4f55\u6570\u636e\u3002</p> </li> </ul> <p>\u73b0\u5728\u5bf9<code>\u6709\u72b6\u6001</code>\u548c<code>\u65e0\u72b6\u6001</code>\u6709\u4e00\u5b9a\u7684\u8ba4\u8bc6\u4e86\u5427\uff0c\u6bd4\u5982\u6211\u4eec\u5e38\u89c1\u7684 WEB \u5e94\u7528\uff0c\u662f\u901a\u8fc7 Session \u6765\u4fdd\u6301\u7528\u6237\u7684\u767b\u5f55\u72b6\u6001\u7684\uff0c\u5982\u679c\u6211\u4eec\u5c06 Session \u6301\u4e45\u5316\u5230\u8282\u70b9\u4e0a\uff0c\u90a3\u4e48\u8be5\u5e94\u7528\u5c31\u662f\u4e00\u4e2a\u6709\u72b6\u6001\u7684\u670d\u52a1\u4e86\uff0c\u56e0\u4e3a\u6211\u73b0\u5728\u767b\u5f55\u8fdb\u6765\u4f60\u628a\u6211\u7684 Session \u6301\u4e45\u5316\u5230\u8282\u70b9 A \u4e0a\u4e86\uff0c\u4e0b\u6b21\u6211\u767b\u5f55\u7684\u65f6\u5019\u53ef\u80fd\u4f1a\u5c06\u8bf7\u6c42\u8def\u7531\u5230\u8282\u70b9 B \u4e0a\u53bb\u4e86\uff0c\u4f46\u662f\u8282\u70b9 B \u4e0a\u6839\u672c\u5c31\u6ca1\u6709\u6211\u5f53\u524d\u7684 Session \u6570\u636e\uff0c\u5c31\u4f1a\u88ab\u8ba4\u4e3a\u662f\u672a\u767b\u5f55\u72b6\u6001\u4e86\uff0c\u8fd9\u6837\u5c31\u5bfc\u81f4\u6211\u524d\u540e\u4e24\u6b21\u8bf7\u6c42\u5f97\u5230\u7684\u7ed3\u679c\u4e0d\u4e00\u81f4\u4e86\u3002\u6240\u4ee5\u4e00\u822c\u4e3a\u4e86\u6a2a\u5411\u6269\u5c55\uff0c\u6211\u4eec\u90fd\u4f1a\u628a\u8fd9\u7c7b WEB \u5e94\u7528\u6539\u6210\u65e0\u72b6\u6001\u7684\u670d\u52a1\uff0c\u600e\u4e48\u6539\uff1f\u5c06 Session \u6570\u636e\u5b58\u5165\u4e00\u4e2a\u516c\u5171\u7684\u5730\u65b9\uff0c\u6bd4\u5982 Redis \u91cc\u9762\uff0c\u662f\u4e0d\u662f\u5c31\u53ef\u4ee5\u4e86\uff0c\u5bf9\u4e8e\u4e00\u4e9b\u5ba2\u6237\u7aef\u8bf7\u6c42 API \u7684\u60c5\u51b5\uff0c\u6211\u4eec\u5c31\u4e0d\u4f7f\u7528 Session \u6765\u4fdd\u6301\u7528\u6237\u72b6\u6001\uff0c\u6539\u6210\u7528 Token \u4e5f\u662f\u53ef\u4ee5\u7684\u3002</p> <p>\u65e0\u72b6\u6001\u670d\u52a1\u5229\u7528\u6211\u4eec\u524d\u9762\u7684 Deployment \u53ef\u4ee5\u5f88\u597d\u7684\u8fdb\u884c\u7f16\u6392\uff0c\u5bf9\u5e94\u6709\u72b6\u6001\u670d\u52a1\uff0c\u9700\u8981\u8003\u8651\u7684\u7ec6\u8282\u5c31\u8981\u591a\u5f88\u591a\u4e86\uff0c\u5bb9\u5668\u5316\u5e94\u7528\u7a0b\u5e8f\u6700\u56f0\u96be\u7684\u4efb\u52a1\u4e4b\u4e00\uff0c\u5c31\u662f\u8bbe\u8ba1\u6709\u72b6\u6001\u5206\u5e03\u5f0f\u7ec4\u4ef6\u7684\u90e8\u7f72\u4f53\u7cfb\u7ed3\u6784\u3002\u7531\u4e8e\u65e0\u72b6\u6001\u7ec4\u4ef6\u6ca1\u6709\u9884\u5b9a\u4e49\u7684\u542f\u52a8\u987a\u5e8f\u3001\u96c6\u7fa4\u8981\u6c42\u3001\u70b9\u5bf9\u70b9 TCP \u8fde\u63a5\u3001\u552f\u4e00\u7684\u7f51\u7edc\u6807\u8bc6\u7b26\u3001\u6b63\u5e38\u7684\u542f\u52a8\u548c\u7ec8\u6b62\u8981\u6c42\u7b49\uff0c\u56e0\u6b64\u53ef\u4ee5\u5f88\u5bb9\u6613\u5730\u8fdb\u884c\u5bb9\u5668\u5316\u3002\u8bf8\u5982\u6570\u636e\u5e93\uff0c\u5927\u6570\u636e\u5206\u6790\u7cfb\u7edf\uff0c\u5206\u5e03\u5f0f key/value \u5b58\u50a8\u3001\u6d88\u606f\u4e2d\u95f4\u4ef6\u9700\u8981\u6709\u590d\u6742\u7684\u5206\u5e03\u5f0f\u4f53\u7cfb\u7ed3\u6784\uff0c\u90fd\u53ef\u80fd\u4f1a\u7528\u5230\u4e0a\u8ff0\u529f\u80fd\u3002\u4e3a\u6b64\uff0cKubernetes \u5f15\u5165\u4e86 <code>StatefulSet</code> \u8fd9\u79cd\u8d44\u6e90\u5bf9\u8c61\u6765\u652f\u6301\u8fd9\u79cd\u590d\u6742\u7684\u9700\u6c42\u3002<code>StatefulSet</code> \u7c7b\u4f3c\u4e8e <code>ReplicaSet</code>\uff0c\u4f46\u662f\u5b83\u53ef\u4ee5\u5904\u7406 Pod \u7684\u542f\u52a8\u987a\u5e8f\uff0c\u4e3a\u4fdd\u7559\u6bcf\u4e2a Pod \u7684\u72b6\u6001\u8bbe\u7f6e\u552f\u4e00\u6807\u8bc6\uff0c\u5177\u6709\u4ee5\u4e0b\u51e0\u4e2a\u529f\u80fd\u7279\u6027\uff1a</p> <ul> <li>\u7a33\u5b9a\u7684\u3001\u552f\u4e00\u7684\u7f51\u7edc\u6807\u8bc6\u7b26</li> <li>\u7a33\u5b9a\u7684\u3001\u6301\u4e45\u5316\u7684\u5b58\u50a8</li> <li>\u6709\u5e8f\u7684\u3001\u4f18\u96c5\u7684\u90e8\u7f72\u548c\u7f29\u653e</li> <li>\u6709\u5e8f\u7684\u3001\u4f18\u96c5\u7684\u5220\u9664\u548c\u7ec8\u6b62</li> <li>\u6709\u5e8f\u7684\u3001\u81ea\u52a8\u6eda\u52a8\u66f4\u65b0</li> </ul>"},{"location":"kubernetes_controller/statefulset/#headless_service","title":"Headless Service","text":"<p>\u5728\u6211\u4eec\u5b66\u4e60 StatefulSet \u5bf9\u8c61\u4e4b\u524d\uff0c\u6211\u4eec\u8fd8\u5fc5\u987b\u4e86\u89e3\u4e00\u4e2a\u65b0\u7684\u6982\u5ff5\uff1a<code>Headless Service</code>\u3002<code>Service</code> \u5176\u5b9e\u5728\u4e4b\u524d\u6211\u4eec\u548c\u5927\u5bb6\u63d0\u5230\u8fc7\uff0cService \u662f\u5e94\u7528\u670d\u52a1\u7684\u62bd\u8c61\uff0c\u901a\u8fc7 Labels \u4e3a\u5e94\u7528\u63d0\u4f9b\u8d1f\u8f7d\u5747\u8861\u548c\u670d\u52a1\u53d1\u73b0\uff0c\u6bcf\u4e2a Service \u90fd\u4f1a\u81ea\u52a8\u5206\u914d\u4e00\u4e2a cluster IP \u548c DNS \u540d\uff0c\u5728\u96c6\u7fa4\u5185\u90e8\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8be5\u5730\u5740\u6216\u8005\u901a\u8fc7 FDQN \u7684\u5f62\u5f0f\u6765\u8bbf\u95ee\u670d\u52a1\u3002\u6bd4\u5982\uff0c\u4e00\u4e2a Deployment \u6709 3 \u4e2a Pod\uff0c\u90a3\u4e48\u6211\u5c31\u53ef\u4ee5\u5b9a\u4e49\u4e00\u4e2a Service\uff0c\u6709\u5982\u4e0b\u4e24\u79cd\u65b9\u5f0f\u6765\u8bbf\u95ee\u8fd9\u4e2a Service\uff1a</p> <ul> <li>cluster IP \u7684\u65b9\u5f0f\uff0c\u6bd4\u5982\uff1a\u5f53\u6211\u8bbf\u95ee 10.109.169.155 \u8fd9\u4e2a Service \u7684 IP \u5730\u5740\u65f6\uff0c10.109.169.155 \u5176\u5b9e\u5c31\u662f\u4e00\u4e2a VIP\uff0c\u5b83\u4f1a\u628a\u8bf7\u6c42\u8f6c\u53d1\u5230\u8be5 Service \u6240\u4ee3\u7406\u7684 Endpoints \u5217\u8868\u4e2d\u7684\u67d0\u4e00\u4e2a Pod \u4e0a\u3002\u5177\u4f53\u539f\u7406\u6211\u4eec\u4f1a\u5728\u540e\u9762\u7684 Service \u7ae0\u8282\u4e2d\u548c\u5927\u5bb6\u6df1\u5165\u4e86\u89e3\u3002</li> <li> <p>Service \u7684 DNS \u65b9\u5f0f\uff0c\u6bd4\u5982\u6211\u4eec\u8bbf\u95ee</p> <pre><code>\u201cmysvc.mynamespace.svc.cluster.local\u201d\n</code></pre> <p>\u8fd9\u6761 DNS \u8bb0\u5f55\uff0c\u5c31\u53ef\u4ee5\u8bbf\u95ee\u5230 mynamespace \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u540d\u4e3a mysvc \u7684 Service \u6240\u4ee3\u7406\u7684\u67d0\u4e00\u4e2a Pod\u3002</p> </li> </ul> <p>\u5bf9\u4e8e DNS \u8fd9\u79cd\u65b9\u5f0f\u5b9e\u9645\u4e0a\u4e5f\u6709\u4e24\u79cd\u60c5\u51b5\uff1a</p> <ul> <li> <p>\u7b2c\u4e00\u79cd\u5c31\u662f\u666e\u901a\u7684 Service\uff0c\u6211\u4eec\u8bbf\u95ee</p> <pre><code>\u201cmysvc.mynamespace.svc.cluster.local\u201d\n</code></pre> <p>\u7684\u65f6\u5019\u662f\u901a\u8fc7\u96c6\u7fa4\u4e2d\u7684 DNS \u670d\u52a1\u89e3\u6790\u5230\u7684 mysvc \u8fd9\u4e2a Service \u7684 cluster IP \u7684 *   \u7b2c\u4e8c\u79cd\u60c5\u51b5\u5c31\u662f<code>Headless Service</code>\uff0c\u5bf9\u4e8e\u8fd9\u79cd\u60c5\u51b5\uff0c\u6211\u4eec\u8bbf\u95ee</p> <pre><code>\u201cmysvc.mynamespace.svc.cluster.local\u201d\n</code></pre> <p>\u7684\u65f6\u5019\u662f\u76f4\u63a5\u89e3\u6790\u5230\u7684 mysvc \u4ee3\u7406\u7684\u67d0\u4e00\u4e2a\u5177\u4f53\u7684 Pod \u7684 IP \u5730\u5740\uff0c\u4e2d\u95f4\u5c11\u4e86 cluster IP \u7684\u8f6c\u53d1\uff0c\u8fd9\u5c31\u662f\u4e8c\u8005\u7684\u6700\u5927\u533a\u522b\uff0cHeadless Service \u4e0d\u9700\u8981\u5206\u914d\u4e00\u4e2a VIP\uff0c\u800c\u662f\u53ef\u4ee5\u76f4\u63a5\u4ee5 DNS \u7684\u8bb0\u5f55\u65b9\u5f0f\u89e3\u6790\u5230\u540e\u9762\u7684 Pod \u7684 IP \u5730\u5740\u3002</p> </li> </ul> <p>\u6bd4\u5982\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a\u5982\u4e0b\u7684 <code>Headless Service</code>\uff1a(headless-svc.yaml)</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: nginx\n  namespace: default\n  labels:\n    app: nginx\nspec:\n  ports:\n  - name: http\n    port: 80\n  clusterIP: None\n  selector:\n    app: nginx\n</code></pre> <p>\u5b9e\u9645\u4e0a <code>Headless Service</code> \u5728\u5b9a\u4e49\u4e0a\u548c\u666e\u901a\u7684 Service \u51e0\u4e4e\u4e00\u81f4, \u53ea\u662f\u4ed6\u7684 <code>clusterIP=None</code>\uff0c\u6240\u4ee5\uff0c\u8fd9\u4e2a Service \u88ab\u521b\u5efa\u540e\u5e76\u4e0d\u4f1a\u88ab\u5206\u914d\u4e00\u4e2a cluster IP\uff0c\u800c\u662f\u4f1a\u4ee5 DNS \u8bb0\u5f55\u7684\u65b9\u5f0f\u66b4\u9732\u51fa\u5b83\u6240\u4ee3\u7406\u7684 Pod\uff0c\u800c\u4e14\u8fd8\u6709\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u7279\u6027\uff0c\u5bf9\u4e8e <code>Headless Service</code> \u6240\u4ee3\u7406\u7684\u6240\u6709 Pod \u7684 IP \u5730\u5740\u90fd\u4f1a\u7ed1\u5b9a\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 DNS \u8bb0\u5f55\uff1a</p> <pre><code>&lt;pod-name&gt;.&lt;svc-name&gt;.&lt;namespace&gt;.svc.cluster.local\n</code></pre> <p>\u8fd9\u4e2a DNS \u8bb0\u5f55\u6b63\u662f Kubernetes \u96c6\u7fa4\u4e3a Pod \u5206\u914d\u7684\u4e00\u4e2a\u552f\u4e00\u6807\u8bc6\uff0c\u53ea\u8981\u6211\u4eec\u77e5\u9053 Pod \u7684\u540d\u5b57\uff0c\u4ee5\u53ca\u5b83\u5bf9\u5e94\u7684 Service \u540d\u5b57\uff0c\u5c31\u53ef\u4ee5\u7ec4\u88c5\u51fa\u8fd9\u6837\u4e00\u6761 DNS \u8bb0\u5f55\u8bbf\u95ee\u5230 Pod \u7684 IP \u5730\u5740\uff0c\u8fd9\u4e2a\u80fd\u529b\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u770b\u4e0b StatefulSet \u8d44\u6e90\u5bf9\u8c61\u662f\u5982\u4f55\u7ed3\u5408 Headless Service \u63d0\u4f9b\u670d\u52a1\u7684\u3002</p>"},{"location":"kubernetes_controller/statefulset/#statefulset_1","title":"StatefulSet","text":"<p>\u5728\u5f00\u59cb\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u51c6\u5907\u4e24\u4e2a 1G \u7684\u5b58\u50a8\u5377\uff08PV\uff09\uff0c\u5728\u540e\u9762\u7684\u8bfe\u7a0b\u4e2d\u6211\u4eec\u4e5f\u4f1a\u548c\u5927\u5bb6\u8be6\u7ec6\u8bb2\u89e3 PV \u548c PVC \u7684\u4f7f\u7528\u65b9\u6cd5\u7684\uff0c\u8fd9\u91cc\u6211\u4eec\u5148\u4e0d\u6df1\u7a76\uff1a\uff08pv.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: pv001\nspec:\n  capacity:\n    storage: 1Gi\n  accessModes:\n  - ReadWriteOnce\n  hostPath:\n    path: /tmp/pv001\n\n---\n\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: pv002\nspec:\n  capacity:\n    storage: 1Gi\n  accessModes:\n  - ReadWriteOnce\n  hostPath:\n    path: /tmp/pv002\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u521b\u5efa PV \u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f pv.yaml\npersistentvolume \"pv001\" created\npersistentvolume \"pv002\" created\n$ kubectl get pv\nkubectl get pv\nNAME      CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM     STORAGECLASS   REASON    AGE\npv001     1Gi        RWO            Recycle          Available                                      12s\npv002     1Gi        RWO            Recycle          Available                                      11s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6210\u529f\u521b\u5efa\u4e86\u4e24\u4e2a PV \u5bf9\u8c61\uff0c\u72b6\u6001\u662f\uff1a<code>Available</code>\u3002</p>"},{"location":"kubernetes_controller/statefulset/#_1","title":"\u7279\u6027","text":"<p>\u7136\u540e\u63a5\u4e0b\u6765\u58f0\u660e\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 StatefulSet \u8d44\u6e90\u6e05\u5355\uff1a\uff08nginx-sts.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: web\n  namespace: default\nspec:\n  serviceName: \"nginx\"\n  replicas: 2\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:9\n        ports:\n        - name: web\n          containerPort: 80\n        volumeMounts:\n        - name: www\n          mountPath: /usr/share/nginx/html\n  volumeClaimTemplates:\n  - metadata:\n      name: www\n    spec:\n      accessModes: [ \"ReadWriteOnce\" ]\n      resources:\n        requests:\n          storage: 1Gi\n</code></pre> <p>\u4ece\u4e0a\u9762\u7684\u8d44\u6e90\u6e05\u5355\u4e2d\u53ef\u4ee5\u770b\u51fa\u548c\u6211\u4eec\u524d\u9762\u7684 Deployment \u57fa\u672c\u4e0a\u4e5f\u662f\u4e00\u81f4\u7684\uff0c\u4e5f\u662f\u901a\u8fc7\u58f0\u660e\u7684 Pod \u6a21\u677f\u6765\u521b\u5efa Pod \u7684\uff0c\u53e6\u5916\u4e0a\u9762\u8d44\u6e90\u6e05\u5355\u4e2d\u548c <code>volumeMounts</code> \u8fdb\u884c\u5173\u8054\u7684\u4e0d\u662f <code>volumes</code> \u800c\u662f\u4e00\u4e2a\u65b0\u7684\u5c5e\u6027\uff1a<code>volumeClaimTemplates</code>\uff0c\u8be5\u5c5e\u6027\u4f1a\u81ea\u52a8\u521b\u5efa\u4e00\u4e2a PVC \u5bf9\u8c61\uff0c\u5176\u5b9e\u8fd9\u91cc\u5c31\u662f\u4e00\u4e2a PVC \u7684\u6a21\u677f\uff0c\u548c Pod \u6a21\u677f\u7c7b\u4f3c\uff0cPVC \u88ab\u521b\u5efa\u540e\u4f1a\u81ea\u52a8\u53bb\u5173\u8054\u5f53\u524d\u7cfb\u7edf\u4e2d\u548c\u4ed6\u5408\u9002\u7684 PV \u8fdb\u884c\u7ed1\u5b9a\u3002\u9664\u6b64\u4e4b\u5916\uff0c\u8fd8\u591a\u4e86\u4e00\u4e2a <code>serviceName: \"nginx\"</code> \u7684\u5b57\u6bb5\uff0c<code>serviceName</code> \u5c31\u662f\u7ba1\u7406\u5f53\u524d <code>StatefulSet</code> \u7684\u670d\u52a1\u540d\u79f0\uff0c\u8be5\u670d\u52a1\u5fc5\u987b\u5728 StatefulSet \u4e4b\u524d\u5b58\u5728\uff0c\u5e76\u4e14\u8d1f\u8d23\u8be5\u96c6\u5408\u7684\u7f51\u7edc\u6807\u8bc6\uff0cPod \u4f1a\u9075\u5faa\u4ee5\u4e0b\u683c\u5f0f\u83b7\u53d6 DNS/\u4e3b\u673a\u540d\uff1a</p> <pre><code>pod-specific-string.serviceName.default.svc.cluster.local\n</code></pre> <p>\uff0c\u5176\u4e2d <code>pod-specific-string</code> \u7531 StatefulSet \u63a7\u5236\u5668\u7ba1\u7406\u3002</p> <p></p> <p><code>StatefulSet</code> \u7684\u62d3\u6251\u7ed3\u6784\u548c\u5176\u4ed6\u7528\u4e8e\u90e8\u7f72\u7684\u8d44\u6e90\u5bf9\u8c61\u5176\u5b9e\u6bd4\u8f83\u7c7b\u4f3c\uff0c\u6bd4\u8f83\u5927\u7684\u533a\u522b\u5728\u4e8e <code>StatefulSet</code> \u5f15\u5165\u4e86 PV \u548c PVC \u5bf9\u8c61\u6765\u6301\u4e45\u5b58\u50a8\u670d\u52a1\u4ea7\u751f\u7684\u72b6\u6001\uff0c\u8fd9\u6837\u6240\u6709\u7684\u670d\u52a1\u867d\u7136\u53ef\u4ee5\u88ab\u6740\u6389\u6216\u8005\u91cd\u542f\uff0c\u4f46\u662f\u5176\u4e2d\u7684\u6570\u636e\u7531\u4e8e PV \u7684\u539f\u56e0\u4e0d\u4f1a\u4e22\u5931\u3002</p> <p>\u6ce8\u610f</p> <p>\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u7528<code>volumeClaimTemplates</code>\u58f0\u660e\u7684\u6a21\u677f\u662f\u6302\u8f7d\u70b9\u7684\u65b9\u5f0f\uff0c\u5e76\u4e0d\u662f volume\uff0c\u6240\u6709\u5b9e\u9645\u4e0a\u4e0a\u5f53\u4e8e\u628a PV \u7684\u5b58\u50a8\u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\uff0c\u6240\u4ee5\u4f1a\u8986\u76d6\u6389\u5bb9\u5668\u4e2d\u7684\u6570\u636e\uff0c\u5728\u5bb9\u5668\u542f\u52a8\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u624b\u52a8\u5728 PV \u7684\u5b58\u50a8\u91cc\u9762\u65b0\u5efa index.html \u6587\u4ef6\u6765\u4fdd\u8bc1\u5bb9\u5668\u7684\u6b63\u5e38\u8bbf\u95ee\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u8fdb\u5165\u5230\u5bb9\u5668\u4e2d\u53bb\u521b\u5efa\uff0c\u8fd9\u6837\u66f4\u52a0\u65b9\u4fbf\uff1a</p> <pre><code>$ for i in 0 1; do kubectl exec web-$i -- sh -c 'echo hello $(hostname) &gt; /usr/share/nginx/html/index.html'; done\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u4f18\u5148\u521b\u5efa\u4e0a\u9762\u5b9a\u4e49\u7684 <code>Headless Service</code>\uff1a</p> <pre><code>$ kubectl apply -f headless-svc.yaml\nservice/nginx created\n$ kubectl get service nginx\nNAME    TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE\nnginx   ClusterIP   None         &lt;none&gt;        80/TCP    9s\n</code></pre> <p><code>Headless Service</code> \u521b\u5efa\u5b8c\u6210\u540e\u5c31\u53ef\u4ee5\u6765\u521b\u5efa\u5bf9\u5e94\u7684 StatefulSet \u5bf9\u8c61\u4e86\uff1a</p> <pre><code>$ kubectl apply -f nginx-sts.yaml \nstatefulset.apps/web created\n$ kubectl get pvc\nNAME        STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE\nwww-web-0   Bound    pv001    1Gi        RWO                           10m\nwww-web-1   Bound    pv002    1Gi        RWO                           6m26s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u8fd9\u91cc\u901a\u8fc7 Volume \u6a21\u677f\u81ea\u52a8\u751f\u6210\u4e86\u4e24\u4e2a PVC \u5bf9\u8c61\uff0c\u4e5f\u81ea\u52a8\u548c PV \u8fdb\u884c\u4e86\u7ed1\u5b9a\u3002\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u5feb\u901f\u901a\u8fc7\u4e00\u4e2a <code>--watch</code> \u53c2\u6570\u6765\u67e5\u770b Pod \u7684\u521b\u5efa\u8fc7\u7a0b\uff1a</p> <pre><code>$ kubectl get pods -l app=nginx --watch \nNAME                      READY   STATUS              RESTARTS   AGE\nweb-0                     0/1     ContainerCreating   0          1s\nweb-0                     1/1     Running             0          2s\nweb-1                     0/1     Pending             0          0s\nweb-1                     0/1     Pending             0          0s\nweb-1                     0/1     ContainerCreating   0          0s\nweb-1                     1/1     Running             0          6s\n</code></pre> <p>\u6211\u4eec\u4ed4\u7ec6\u89c2\u5bdf\u6574\u4e2a\u8fc7\u7a0b\u51fa\u73b0\u4e86\u4e24\u4e2a Pod\uff1a<code>web-0</code> \u548c <code>web-1</code>\uff0c\u800c\u4e14\u8fd9\u4e24\u4e2a Pod \u662f\u6309\u7167\u987a\u5e8f\u8fdb\u884c\u521b\u5efa\u7684\uff0c<code>web-0</code> \u542f\u52a8\u8d77\u6765\u540e <code>web-1</code> \u624d\u5f00\u59cb\u521b\u5efa\u3002\u5982\u540c\u4e0a\u9762 StatefulSet \u6982\u5ff5\u4e2d\u6240\u63d0\u5230\u7684\uff0cStatefulSet \u4e2d\u7684 Pod \u62e5\u6709\u4e00\u4e2a\u5177\u6709\u7a33\u5b9a\u7684\u3001\u72ec\u4e00\u65e0\u4e8c\u7684\u8eab\u4efd\u6807\u5fd7\u3002\u8fd9\u4e2a\u6807\u5fd7\u57fa\u4e8e StatefulSet \u63a7\u5236\u5668\u5206\u914d\u7ed9\u6bcf\u4e2a Pod \u7684\u552f\u4e00\u987a\u5e8f\u7d22\u5f15\u3002Pod \u7684\u540d\u79f0\u7684\u5f62\u5f0f\u4e3a</p> <pre><code>&lt;statefulset name&gt;-&lt;ordinal index&gt;\n</code></pre> <p>\u3002\u6211\u4eec\u8fd9\u91cc\u7684\u5bf9\u8c61\u62e5\u6709\u4e24\u4e2a\u526f\u672c\uff0c\u6240\u4ee5\u5b83\u521b\u5efa\u4e86\u4e24\u4e2a Pod \u540d\u79f0\u5206\u522b\u4e3a\uff1aweb-0 \u548c web-1\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>kubectl exec</code> \u547d\u4ee4\u8fdb\u5165\u5230\u5bb9\u5668\u4e2d\u67e5\u770b\u5b83\u4eec\u7684 hostname\uff1a</p> <pre><code>$ kubectl exec web-0 hostname\nweb-0\n$ kubectl exec web-1 hostname\nweb-1\n</code></pre> <p>\u987a\u5e8f</p> <p>StatefulSet \u4e2d Pod \u526f\u672c\u7684\u521b\u5efa\u4f1a\u6309\u7167\u5e8f\u5217\u53f7<code>\u5347\u5e8f</code>\u5904\u7406\uff0c\u526f\u672c\u7684\u66f4\u65b0\u548c\u5220\u9664\u4f1a\u6309\u7167\u5e8f\u5217\u53f7<code>\u964d\u5e8f</code>\u5904\u7406\u3002</p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e24\u4e2a Pod \u7684 hostname \u4e0e Pod \u540d\u5b57\u662f\u4e00\u81f4\u7684\uff0c\u90fd\u88ab\u5206\u914d\u4e86\u5bf9\u5e94\u7684\u7f16\u53f7\u3002\u6211\u4eec\u968f\u610f\u67e5\u770b\u4e00\u4e2a Pod \u7684\u63cf\u8ff0\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl describe pod web-0\nName:               web-0\nNamespace:          default\nPriority:           0\nPriorityClassName:  &lt;none&gt;\nNode:               ydzs-node3/157\nStart Time:         Sun, 17 Nov 2019 12:32:50 +0800\nLabels:             app=nginx\n                    controller-revision-hash=web-6c5c7fd59b\n                    statefulset.kubernetes.io/pod-name=web-0\nAnnotations:        podpreset.admission.kubernetes.io/podpreset-time-preset: 2062768\nStatus:             Running\nIP:                 298\nControlled By:      StatefulSet/web\n......\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230</p> <pre><code>Controlled By: StatefulSet/web\n</code></pre> <p>\uff0c\u8bc1\u660e\u6211\u4eec\u7684 Pod \u662f\u76f4\u63a5\u53d7\u5230 StatefulSet \u63a7\u5236\u5668\u7ba1\u7406\u7684\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u521b\u5efa\u4e00\u4e2a busybox\uff08\u8be5\u955c\u50cf\u4e2d\u6709\u4e00\u7cfb\u5217\u7684\u5de5\u5177\uff09\u7684\u5bb9\u5668\uff0c\u5728\u5bb9\u5668\u4e2d\u7528 DNS \u7684\u65b9\u5f0f\u6765\u8bbf\u95ee\u4e00\u4e0b\u8fd9\u4e2a <code>Headless Service</code>\uff0c\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u53ea\u662f\u5355\u7eaf\u7684\u4e3a\u4e86\u6d4b\u8bd5\uff0c\u6240\u4ee5\u6ca1\u5fc5\u8981\u5199\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u6765\u58f0\u660e\uff0c\u7528<code>kubectl run</code>\u547d\u4ee4\u542f\u52a8\u4e00\u4e2a\u6d4b\u8bd5\u7684\u5bb9\u5668\u5373\u53ef\uff1a</p> <pre><code>$ kubectl run -it --image busybox:3 test --restart=Never --rm /bin/sh\nIf you don't see a command prompt, try pressing enter.\n/ #\n</code></pre> <p>busybox \u955c\u50cf</p> <p><code>busybox</code> \u6700\u65b0\u7248\u672c\u7684\u955c\u50cf\u6709 BUG\uff0c\u4f1a\u51fa\u73b0<code>nslookup</code>\u63d0\u793a\u65e0\u6cd5\u89e3\u6790\u7684\u95ee\u9898\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u8001\u4e00\u70b9\u7684\u955c\u50cf\u7248\u672c<code>1.28.3</code>\u5373\u53ef\u3002</p> <p>\u5982\u679c\u5bf9 <code>kubectl run</code> \u547d\u4ee4\u7684\u4f7f\u7528\u53c2\u6570\u4e0d\u6e05\u695a\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>kubectl run --help</code> \u547d\u4ee4\u67e5\u770b\u53ef\u4f7f\u7528\u7684\u53c2\u6570\u3002\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 <code>kubectl run</code> \u547d\u4ee4\u542f\u52a8\u4e86\u4e00\u4e2a\u4ee5 busybox \u4e3a\u955c\u50cf\u7684 Pod\uff0c<code>--rm</code> \u53c2\u6570\u610f\u5473\u7740\u6211\u4eec\u9000\u51fa Pod \u540e\u5c31\u4f1a\u88ab\u5220\u9664\uff0c\u548c\u4e4b\u524d\u7684 <code>docker run</code> \u547d\u4ee4\u7528\u6cd5\u57fa\u672c\u4e00\u81f4\uff0c\u73b0\u5728\u6211\u4eec\u5728\u8fd9\u4e2a Pod \u5bb9\u5668\u91cc\u9762\u53ef\u4ee5\u4f7f\u7528 <code>nslookup</code> \u547d\u4ee4\u6765\u5c1d\u8bd5\u89e3\u6790\u4e0b\u4e0a\u9762\u6211\u4eec\u521b\u5efa\u7684 <code>Headless Service</code>\uff1a</p> <pre><code>/ # nslookup nginx\nServer:    10\nAddress 1: 10 kube-dns.kube-system.svc.cluster.local\n\nName:      nginx\nAddress 1: 2175 web-nginx.default.svc.cluster.local\nAddress 2: 283 web-nginx.default.svc.cluster.local\n/ # ping nginx\nPING nginx (2175): 56 data bytes\n64 bytes from 2175: seq=0 ttl=62 time=076 ms\n64 bytes from 2175: seq=1 ttl=62 time=029 ms\n64 bytes from 2175: seq=2 ttl=62 time=075 ms\n</code></pre> <p>\u6211\u4eec\u76f4\u63a5\u89e3\u6790 <code>Headless Service</code> \u7684\u540d\u79f0\uff0c\u53ef\u4ee5\u770b\u5230\u5f97\u5230\u7684\u662f\u4e24\u4e2a Pod \u7684\u89e3\u6790\u8bb0\u5f55\uff0c\u4f46\u5b9e\u9645\u4e0a\u5982\u679c\u6211\u4eec\u901a\u8fc7<code>nginx</code>\u8fd9\u4e2a DNS \u53bb\u8bbf\u95ee\u6211\u4eec\u7684\u670d\u52a1\u7684\u8bdd\uff0c\u5e76\u4e0d\u4f1a\u968f\u673a\u6216\u8005\u8f6e\u8be2\u80cc\u540e\u7684\u4e24\u4e2a Pod\uff0c\u800c\u662f\u8bbf\u95ee\u5230\u4e00\u4e2a\u56fa\u5b9a\u7684 Pod\uff0c\u6240\u4ee5\u4e0d\u80fd\u4ee3\u66ff\u666e\u901a\u7684 Service\u3002\u5982\u679c\u5206\u522b\u89e3\u6790\u5bf9\u5e94\u7684 Pod \u5462\uff1f</p> <pre><code>$ / # nslookup web-nginx\nServer:    10\nAddress 1: 10 kube-dns.kube-system.svc.cluster.local\n\nName:      web-nginx\nAddress 1: 283 web-nginx.default.svc.cluster.local\n/ # nslookup web-nginx\nServer:    10\nAddress 1: 10 kube-dns.kube-system.svc.cluster.local\n\nName:      web-nginx\nAddress 1: 2175 web-nginx.default.svc.cluster.local\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u89e3\u6790 <code>web-0.nginx</code> \u7684\u65f6\u5019\u89e3\u6790\u5230\u4e86 <code>web-0</code> \u8fd9\u4e2a Pod \u7684 IP\uff0c<code>web-1.nginx</code> \u89e3\u6790\u5230\u4e86 <code>web-1</code> \u8fd9\u4e2a Pod \u7684 IP\uff0c\u800c\u4e14\u8fd9\u4e2a DNS \u5730\u5740\u8fd8\u662f\u7a33\u5b9a\u7684\uff0c\u56e0\u4e3a Pod \u540d\u79f0\u5c31\u662f\u56fa\u5b9a\u7684\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u4e2a\u65f6\u5019\u53bb\u5220\u6389 <code>web-0</code> \u548c <code>web-1</code> \u8fd9\u4e24\u4e2a Pod\uff1a</p> <pre><code>$ kubectl delete pod -l app=nginx\npod \"web-0\" deleted\npod \"web-1\" deleted\n</code></pre> <p>\u5220\u9664\u5b8c\u6210\u540e\u624d\u770b Pod \u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pods -l app=nginx  \nNAME    READY   STATUS    RESTARTS   AGE\nweb-0   1/1     Running   0          42s\nweb-1   1/1     Running   0          39s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230 StatefulSet \u63a7\u5236\u5668\u4ecd\u7136\u4f1a\u5b89\u88c5\u987a\u5e8f\u521b\u5efa\u51fa\u4e24\u4e2a Pod \u526f\u672c\u51fa\u6765\uff0c\u800c\u4e14 Pod \u7684\u552f\u4e00\u6807\u8bc6\u4f9d\u7136\u6ca1\u53d8\uff0c\u6240\u4ee5\u8fd9\u4e24\u4e2a Pod \u7684\u7f51\u7edc\u6807\u8bc6\u8fd8\u662f\u56fa\u5b9a\u7684\uff0c\u6211\u4eec\u4f9d\u7136\u53ef\u4ee5\u901a\u8fc7<code>web-0.nginx</code>\u53bb\u8bbf\u95ee\u5230<code>web-0</code>\u8fd9\u4e2a Pod\uff0c\u867d\u7136 Pod \u5df2\u7ecf\u91cd\u5efa\u4e86\uff0c\u5bf9\u5e94 Pod IP \u5df2\u7ecf\u53d8\u5316\u4e86\uff0c\u4f46\u662f\u8bbf\u95ee\u8fd9\u4e2a Pod \u7684\u5730\u5740\u4f9d\u7136\u6ca1\u53d8\uff0c\u5e76\u4e14\u4ed6\u4eec\u4f9d\u7136\u8fd8\u662f\u5173\u8054\u7684\u4e4b\u524d\u7684 PVC\uff0c\u6570\u636e\u5e76\u4e0d\u4f1a\u4e22\u5931\uff1a</p> <pre><code>/ # nslookup web-nginx\nServer:    10\nAddress 1: 10 kube-dns.kube-system.svc.cluster.local\n\nName:      web-nginx\nAddress 1: 298 web-nginx.default.svc.cluster.local\n/ # nslookup web-nginx\nServer:    10\nAddress 1: 10 kube-dns.kube-system.svc.cluster.local\n\nName:      web-nginx\nAddress 1: 2176 web-nginx.default.svc.cluster.local\n</code></pre> <p>\u901a\u8fc7 <code>Headless Service</code>\uff0cStatefulSet \u5c31\u4fdd\u8bc1\u4e86 Pod \u7f51\u7edc\u6807\u8bc6\u7684\u552f\u4e00\u7a33\u5b9a\u6027\uff0c\u7531\u4e8e Pod IP \u5e76\u4e0d\u662f\u56fa\u5b9a\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u8bbf\u95ee<code>\u6709\u72b6\u6001\u5e94\u7528</code>\u5b9e\u4f8b\u7684\u65f6\u5019\uff0c\u5c31\u5fc5\u987b\u4f7f\u7528 DNS \u8bb0\u5f55\u7684\u65b9\u5f0f\u6765\u8bbf\u95ee\u4e86\uff0c\u6240\u4ee5\u5f88\u591a\u540c\u5b66\u5076\u5c14\u6709\u56fa\u5b9a\u7684 Pod IP \u7684\u9700\u6c42\uff0c\u6216\u8bb8\u53ef\u4ee5\u7528\u8fd9\u79cd\u65b9\u5f0f\u6765\u4ee3\u66ff\u3002</p> <p>\u6700\u540e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5220\u9664 StatefulSet \u5bf9\u8c61\u6765\u5220\u9664\u6240\u6709\u7684 Pod\uff0c\u4ed4\u7ec6\u89c2\u5bdf\u4e5f\u4f1a\u53d1\u73b0\u662f\u6309\u7167\u5012\u5e8f\u7684\u65b9\u5f0f\u8fdb\u884c\u5220\u9664\u7684\uff1a</p> <pre><code>$ kubectl delete statefulsets  web\nstatefulset.apps \"web\" deleted\n$ kubectl get pods --watch\nNAME    READY   STATUS    RESTARTS   AGE\nweb-1   1/1   Terminating   0     3h/31m\nweb-0   1/1   Terminating   0     3h/31m\n</code></pre>"},{"location":"kubernetes_controller/statefulset/#_2","title":"\u7ba1\u7406\u7b56\u7565","text":"<p>\u5bf9\u4e8e\u67d0\u4e9b\u5206\u5e03\u5f0f\u7cfb\u7edf\u6765\u8bf4\uff0cStatefulSet \u7684\u987a\u5e8f\u6027\u4fdd\u8bc1\u662f\u4e0d\u5fc5\u8981\u548c/\u6216\u8005\u4e0d\u5e94\u8be5\u7684\uff0c\u8fd9\u4e9b\u7cfb\u7edf\u4ec5\u4ec5\u8981\u6c42\u552f\u4e00\u6027\u548c\u8eab\u4efd\u6807\u5fd7\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5728\u58f0\u660e StatefulSet \u7684\u65f6\u5019\u91cd\u65b0\u8bbe\u7f6e </p> <pre><code>spec.podManagementPolicy\n</code></pre> <p>\u7684\u7b56\u7565\u5373\u53ef\u3002</p> <p>\u9ed8\u8ba4\u7684\u7ba1\u7406\u7b56\u7565\u662f <code>OrderedReady</code>\uff0c\u8868\u793a\u8ba9 StatefulSet \u63a7\u5236\u5668\u9075\u5faa\u4e0a\u6587\u6f14\u793a\u7684\u987a\u5e8f\u6027\u4fdd\u8bc1\u3002\u9664\u6b64\u4e4b\u5916\uff0c\u8fd8\u53ef\u4ee5\u8bbe\u7f6e\u4e3a <code>Parallel</code> \u7ba1\u7406\u6a21\u5f0f\uff0c\u8868\u793a\u8ba9 StatefulSet \u63a7\u5236\u5668\u5e76\u884c\u7684\u7ec8\u6b62\u6240\u6709 Pod\uff0c\u5728\u542f\u52a8\u6216\u7ec8\u6b62\u53e6\u4e00\u4e2a Pod \u524d\uff0c\u4e0d\u5fc5\u7b49\u5f85\u8fd9\u4e9b Pod \u53d8\u6210 Running \u548c Ready \u6216\u8005\u5b8c\u5168\u7ec8\u6b62\u72b6\u6001\u3002</p>"},{"location":"kubernetes_controller/statefulset/#_3","title":"\u66f4\u65b0\u7b56\u7565","text":"<p>\u524d\u9762\u8bfe\u7a0b\u4e2d\u6211\u4eec\u5b66\u4e60\u4e86 Deployment \u7684\u5347\u7ea7\u7b56\u7565\uff0c\u5728 StatefulSet \u4e2d\u540c\u6837\u4e5f\u652f\u6301\u4e24\u79cd\u5347\u7ea7\u7b56\u7565\uff1a<code>onDelete</code> \u548c <code>RollingUpdate</code>\uff0c\u540c\u6837\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e </p> <pre><code>.spec.updateStrategy.type\n</code></pre> <p>\u8fdb\u884c\u6307\u5b9a\u3002</p> <ul> <li><code>OnDelete</code>: \u8be5\u7b56\u7565\u8868\u793a\u5f53\u66f4\u65b0\u4e86 <code>StatefulSet</code> \u7684\u6a21\u677f\u540e\uff0c\u53ea\u6709\u624b\u52a8\u5220\u9664\u65e7\u7684 Pod \u624d\u4f1a\u521b\u5efa\u65b0\u7684 Pod\u3002</li> <li><code>RollingUpdate</code>\uff1a\u8be5\u7b56\u7565\u8868\u793a\u5f53\u66f4\u65b0 StatefulSet \u6a21\u677f\u540e\u4f1a\u81ea\u52a8\u5220\u9664\u65e7\u7684 Pod \u5e76\u521b\u5efa\u65b0\u7684Pod\uff0c\u5982\u679c\u66f4\u65b0\u53d1\u751f\u4e86\u9519\u8bef\uff0c\u8fd9\u6b21\u201c\u6eda\u52a8\u66f4\u65b0\u201d\u5c31\u4f1a\u505c\u6b62\u3002\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f StatefulSet \u7684 Pod \u5728\u90e8\u7f72\u65f6\u662f\u987a\u5e8f\u4ece 0~n \u7684\uff0c\u800c\u5728\u6eda\u52a8\u66f4\u65b0\u65f6\uff0c\u8fd9\u4e9b Pod \u5219\u662f\u6309\u9006\u5e8f\u7684\u65b9\u5f0f\u5373 n~0 \u4e00\u6b21\u5220\u9664\u5e76\u521b\u5efa\u3002</li> </ul> <p>\u53e6\u5916<code>SatefulSet</code> \u7684\u6eda\u52a8\u5347\u7ea7\u8fd8\u652f\u6301 <code>Partitions</code>\u7684\u7279\u6027\uff0c\u53ef\u4ee5\u901a\u8fc7</p> <pre><code>.spec.updateStrategy.rollingUpdate.partition\n</code></pre> <p>\u8fdb\u884c\u8bbe\u7f6e\uff0c\u5728\u8bbe\u7f6e partition \u540e\uff0cSatefulSet \u7684 Pod \u4e2d\u5e8f\u53f7\u5927\u4e8e\u6216\u7b49\u4e8e partition \u7684 Pod \u4f1a\u5728 StatefulSet \u7684\u6a21\u677f\u66f4\u65b0\u540e\u8fdb\u884c\u6eda\u52a8\u5347\u7ea7\uff0c\u800c\u5176\u4f59\u7684 Pod \u4fdd\u6301\u4e0d\u53d8\uff0c\u8fd9\u4e2a\u529f\u80fd\u662f\u4e0d\u662f\u53ef\u4ee5\u5b9e\u73b0<code>\u7070\u5ea6\u53d1\u5e03</code>\uff1f\u5927\u5bb6\u53ef\u4ee5\u53bb\u624b\u52a8\u9a8c\u8bc1\u4e0b\u3002</p> <p>\u5728\u5b9e\u9645\u7684\u9879\u76ee\u4e2d\uff0c\u5176\u5b9e\u6211\u4eec\u8fd8\u662f\u5f88\u5c11\u4f1a\u53bb\u76f4\u63a5\u901a\u8fc7 StatefulSet \u6765\u90e8\u7f72\u6211\u4eec\u7684\u6709\u72b6\u6001\u670d\u52a1\u7684\uff0c\u9664\u975e\u4f60\u81ea\u5df1\u80fd\u591f\u5b8c\u5168\u80fd\u591f hold \u4f4f\uff0c\u5bf9\u4e8e\u4e00\u4e9b\u7279\u5b9a\u7684\u670d\u52a1\uff0c\u6211\u4eec\u53ef\u80fd\u4f1a\u4f7f\u7528\u66f4\u52a0\u9ad8\u7ea7\u7684 Operator \u6765\u90e8\u7f72\uff0c\u6bd4\u5982 etcd-operator\u3001prometheus-operator \u7b49\u7b49\uff0c\u8fd9\u4e9b\u5e94\u7528\u90fd\u80fd\u591f\u5f88\u597d\u7684\u6765\u7ba1\u7406\u6709\u72b6\u6001\u7684\u670d\u52a1\uff0c\u800c\u4e0d\u662f\u5355\u7eaf\u7684\u4f7f\u7528\u4e00\u4e2a StatefulSet \u6765\u90e8\u7f72\u4e00\u4e2a Pod \u5c31\u884c\uff0c\u56e0\u4e3a\u5bf9\u4e8e\u6709\u72b6\u6001\u7684\u5e94\u7528\u6700\u91cd\u8981\u7684\u8fd8\u662f\u6570\u636e\u6062\u590d\u3001\u6545\u969c\u8f6c\u79fb\u7b49\u7b49\u3002</p>"},{"location":"kubernetes_network/flannel/","title":"\u7f51\u7edc\u63d2\u4ef6","text":"<p>\ue3c9</p>"},{"location":"kubernetes_network/flannel/#flannel","title":"Flannel","text":"<p>\u6211\u4eec\u77e5\u9053 Docker \u7684\u7f51\u7edc\u6a21\u5f0f\u53ef\u4ee5\u89e3\u51b3\u4e00\u4e2a\u8282\u70b9\u4e0a\u7684\u5bb9\u5668\u4e4b\u95f4\u7684\u7f51\u7edc\u901a\u4fe1\u95ee\u9898\uff0c\u4f46\u662f\u5bf9\u4e8e\u8de8\u4e3b\u673a\u7684\u5bb9\u5668\u4e4b\u95f4\u7684\u901a\u4fe1\u5c31\u65e0\u80fd\u4e3a\u529b\u4e86\uff0c\u5c31\u9700\u8981\u501f\u52a9\u7b2c\u4e09\u65b9\u7684\u5de5\u5177\u6765\u5b9e\u73b0\u5bb9\u5668\u7684\u8de8\u4e3b\u673a\u901a\u4fe1\u3002\u4e3a\u89e3\u51b3\u5bb9\u5668\u8de8\u4e3b\u673a\u901a\u4fe1\u95ee\u9898\uff0c\u793e\u533a\u51fa\u73b0\u4e86\u5f88\u591a\u79cd\u7f51\u7edc\u89e3\u51b3\u65b9\u6848\uff0c\u4e0d\u540c\u7684\u65b9\u6848\u5de5\u4f5c\u539f\u7406\u5404\u6709\u4e0d\u540c\uff0c\u5bf9\u4e8e\u7f51\u7edc\u73af\u5883\u7684\u8981\u6c42\u4e5f\u5404\u6709\u4e0d\u540c\uff0c\u6211\u4eec\u8fd9\u91cc\u4ee5\u4f7f\u7528\u6700\u591a\u7684 <code>Flannel</code> \u8fd9\u4e2a\u7f51\u7edc\u63d2\u4ef6\u4e3a\u4f8b\uff0c\u6765\u7ed9\u5927\u5bb6\u8bb2\u89e3\u8be5\u7ecf\u5178\u7f51\u7edc\u63d2\u4ef6\u7684\u5de5\u4f5c\u539f\u7406\u3002</p> <p><code>Flannel</code> \u662f CoreOS\uff08Etcd \u7684\u516c\u53f8\uff09\u63a8\u51fa\u7684\u4e00\u4e2a Overlay \u7c7b\u578b\u7684\u5bb9\u5668\u7f51\u7edc\u63d2\u4ef6\uff0c\u76ee\u524d\u652f\u6301\u4e09\u79cd\u540e\u7aef\u5b9e\u73b0\uff1a<code>UDP</code>\u3001<code>VXLAN</code>\u3001<code>host-gw</code> \u4e09\u79cd\u65b9\u5f0f\u3002UDP \u662f\u6700\u5f00\u59cb\u652f\u6301\u7684\u6700\u7b80\u5355\u7684\u4f46\u662f\u5374\u662f\u6027\u80fd\u6700\u5dee\u7684\u4e00\u79cd\u65b9\u5f0f\uff0c\u56e0\u6b64\u57fa\u672c\u4e0a\u5728\u6b63\u5f0f\u4f7f\u7528\u7684\u65f6\u5019\u4e0d\u4f1a\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\uff0c\u4e0d\u8fc7\u8be5\u65b9\u5f0f\u7531\u4e8e\u975e\u5e38\u7b80\u5355\u6240\u6709\u53ef\u4ee5\u6709\u52a9\u4e8e\u6211\u4eec\u6765\u7406\u89e3\u5bb9\u5668\u8de8\u4e3b\u673a\u7f51\u7edc\u901a\u4fe1\u7684\u5b9e\u73b0\u539f\u7406\uff0c\u6240\u4ee5\u6211\u4eec\u5148\u6765\u548c\u5927\u5bb6\u4e86\u89e3\u4e0b UDP \u65b9\u5f0f\u7684\u5b9e\u73b0\u65b9\u5f0f\u3002</p>"},{"location":"kubernetes_network/flannel/#udp","title":"UDP \u65b9\u5f0f","text":"<p>\u8fd8\u662f\u8981 <code>UDP</code> \u6a21\u5f0f\u6211\u4eec\u9700\u8981\u5728 Flannel \u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u6307\u5b9a <code>Backend type</code> \u4e3a <code>UDP</code>\uff0c\u53ef\u4ee5\u76f4\u63a5\u4fee\u6539 Flannel \u7684\u65b9\u5f0f\u5b9e\u73b0\uff1a</p> <pre><code>$ kubectl edit cm kube-flannel-cfg -n kube-system\napiVersion: v1\ndata:\n  cni-conf.json: |\n    {\n      \"cniVersion\": \"0\",\n      \"name\": \"cbr0\",\n      \"plugins\": [\n        {\n          \"type\": \"flannel\",\n          \"delegate\": {\n            \"hairpinMode\": true,\n            \"isDefaultGateway\": true\n          }\n        },\n        {\n          \"type\": \"portmap\",\n          \"capabilities\": {\n            \"portMappings\": true\n          }\n        }\n      ]\n    }\n  net-conf.json: |\n    {\n        {\n      \"Network\": \"20/16\",\n      \"Backend\": {\n        \"Type\": \"udp\"  # \u4fee\u6539\u540e\u7aef\u7c7b\u578b\u4e3a UDP\n      }\n    }\nkind: ConfigMap\n......\n</code></pre> <p>\u9700\u8981\u5c06 <code>Backend</code> \u7684\u7c7b\u578b\u66f4\u6539\u4e3a <code>udp</code>\uff0c\u91c7\u7528 UDP \u6a21\u5f0f\u65f6\u540e\u7aef\u9ed8\u8ba4\u4e3a\u7aef\u53e3\u4e3a 8285\uff0c\u5373 Flanneld \u7684\u76d1\u542c\u7aef\u53e3\u3002\u5f53\u91c7\u7528 UDP \u6a21\u5f0f\u65f6\uff0cFlanneld \u8fdb\u7a0b\u5728\u542f\u52a8\u65f6\u4f1a\u901a\u8fc7\u6253\u5f00 <code>/dev/net/tun</code> \u7684\u65b9\u5f0f\u751f\u6210\u4e00\u4e2a <code>TUN</code> \u8bbe\u5907\uff0c<code>TUN</code> \u8bbe\u5907\u53ef\u4ee5\u7b80\u5355\u7406\u89e3\u4e3a Linux \u5f53\u4e2d\u63d0\u4f9b\u7684\u4e00\u79cd\u5185\u6838\u7f51\u7edc\u4e0e\u7528\u6237\u7a7a\u95f4\u901a\u4fe1\u7684\u4e00\u79cd\u673a\u5236\uff0c\u5373\u5e94\u7528\u53ef\u4ee5\u901a\u8fc7\u76f4\u63a5\u8bfb\u5199 TUN \u8bbe\u5907\u7684\u65b9\u5f0f\u6536\u53d1 RAW IP \u5305\u3002\u6240\u4ee5\u6211\u4eec\u8fd8\u9700\u8981\u5c06\u5bbf\u4e3b\u673a\u7684 <code>/dev/net/tun</code> \u6587\u4ef6\u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\u53bb\uff1a</p> <pre><code>$ kubectl edit ds kube-flannel-ds-amd64 -n kube-system\n......\n  volumeMounts:\n    - mountPath: /run/flannel\n    name: run\n    - mountPath: /etc/kube-flannel/\n    name: flannel-cfg\n    - mountPath: /dev/net\n    name: tun\n......\nvolumes:\n- hostPath:\n    path: /run/flannel\n    type: \"\"\n  name: run\n- hostPath:\n    path: /etc/cni/net.d\n    type: \"\"\n  name: cni\n- hostPath:\n    path: /dev/net  # \u6302\u8f7d\u5bbf\u4e3b\u673a\u7684 /dev/net/tun \u6587\u4ef6\n    type: \"\"\n  name: tun\n......\n</code></pre> <p>\u7136\u540e Flanneld \u7684 Pod \u4f1a\u81ea\u52a8\u91cd\u5efa\uff0c\u91cd\u5efa\u5b8c\u6210\u540e\uff0c\u53ef\u4ee5\u968f\u4fbf\u67e5\u770b\u4e00\u4e2a Pod \u7684\u65e5\u5fd7\uff1a</p> <pre><code>$ kubectl logs -f kube-flannel-ds-amd64-5bk4dmd64 -n kube-system\nI1128 08:26:663566       1 main.go:527] Using interface with name eth0 and address 111\nI1128 08:26:663838       1 main.go:544] Defaulting external address to interface address (111)\nI1128 08:26:857634       1 kube.go:126] Waiting 10m0s for node controller to sync\nI1128 08:26:857805       1 kube.go:309] Starting kube subnet manager\nI1128 08:26:858137       1 kube.go:133] Node controller sync successful\nI1128 08:26:858324       1 main.go:244] Created subnet manager: Kubernetes Subnet Manager - ydzs-master\nI1128 08:26:858357       1 main.go:247] Installing signal handlers\nI1128 08:26:858933       1 main.go:386] Found network config - Backend type: udp\nI1128 08:26:089114       1 main.go:317] Wrote subnet file to /run/flannel/subnet.env\nI1128 08:26:089177       1 main.go:321] Running backend.\nI1128 08:26:089227       1 main.go:339] Waiting for all goroutines to exit\nI1128 08:26:089280       1 udp_network_amdgo:100] Watching for new subnet leases\nI1128 08:26:089350       1 udp_network_amdgo:195] Subnet added: 20/24\nI1128 08:26:089443       1 udp_network_amdgo:195] Subnet added: 20/24\nI1128 08:26:089487       1 udp_network_amdgo:195] Subnet added: 20/24\nI1128 08:26:089518       1 udp_network_amdgo:195] Subnet added: 20/24\nI1128 08:27:936553       1 udp_network_amdgo:195] Subnet added: 20/24\nI1128 08:27:341176       1 udp_network_amdgo:195] Subnet added: 20/24\nI1128 08:27:136280       1 udp_network_amdgo:195] Subnet added: 20/24\nI1128 08:27:863379       1 udp_network_amdgo:195] Subnet added: 20/24\n</code></pre> <p>\u770b\u5230</p> <pre><code>Found network config - Backend type: udp\n</code></pre> <p>\u8fd9\u4e2a\u4fe1\u606f\u8bc1\u660e\u6211\u4eec\u73b0\u5728\u5df2\u7ecf\u53d8\u6210\u4e86 <code>UDP</code> \u6a21\u5f0f\u4e86\u3002</p> <p>Flanneld \u8fdb\u7a0b\u542f\u52a8\u540e\u901a\u8fc7 <code>ip a</code> \u547d\u4ee4\u53ef\u4ee5\u53d1\u73b0\u8282\u70b9\u5f53\u4e2d\u5df2\u7ecf\u591a\u4e86\u4e00\u4e2a\u53eb <code>flannel0</code> \u7684\u7f51\u7edc\u8bbe\u5907\uff1a</p> <pre><code>$ ip -d link show flannel0\n210: flannel0: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1472 qdisc pfifo_fast state UNKNOWN mode DEFAULT group default qlen 500\n    link/none  promiscuity 0\n    tun addrgenmode random numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535\n</code></pre> <p>\u7531\u4e8e\u662f UDP \u7684\u670d\u52a1\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u901a\u8fc7 <code>netstat -ulnp</code> \u547d\u4ee4\u67e5\u770b\u8fdb\u7a0b\uff1a</p> <pre><code>$ netstat -ulnp | grep flanneld\nudp        0      0 111:8285       0:*                           24844/flanneld\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u6709\u4e24\u4e2a Pod\uff0c\u5206\u522b\u5728\u8282\u70b9 ydzs-node1 \u548c\u8282\u70b9 ydzs-node2 \u4e0a\u9762\uff0c\u73b0\u5728\u8ba9 pod-a\uff0810.244.1.236\uff09\u5411 pod-b\uff0810.244.2.123\uff09\u53d1\u9001\u4e00\u4e2a\u8bf7\u6c42\u62a5\u6587\uff08ping\uff09\uff0c\u6211\u4eec\u6765\u5206\u6790\u4ee5\u4e0b\u62a5\u6587\u662f\u5982\u4f55\u4ece pod-a \u5230\u8fbe pod-b \u7684\uff1a</p> <pre><code>$ kubectl get pods -o wide\nNAME                        READY   STATUS    RESTARTS   AGE     IP             NODE         NOMINATED NODE   READINESS GATES\npod-a                       1/1     Running   0          73s     2236   ydzs-node1   &lt;none&gt;           &lt;none&gt;\npod-b                       1/1     Running   0          38s     2123   ydzs-node2   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>1\u3001\u5728 pod-a \u5f53\u4e2d\u53d1\u51fa ICMP \u8bf7\u6c42\u62a5\u6587\uff0c\u5176\u6e90\u5730\u5740\u5c31\u662f 10.244.1.236\uff0c\u76ee\u6807\u5730\u5740\u662f 10.244.2.123\uff0c\u6b64\u65f6\u901a\u8fc7 pod-a \u5185\u7684\u8def\u7531\u8868\u5339\u914d\u5230\u5e94\u8be5\u5c06\u8be5 IP \u5305\u53d1\u9001\u5230 ydzs-node1 \u8282\u70b9\u4e0a\u7f51\u5173 10.244.1.1\uff08<code>cni0</code>\u7f51\u6865\uff09\u3002</p> <pre><code>$ kubectl exec pod-a -- route -n\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n0         21      0         UG    0      0        0 eth0\n20      21      220     UG    0      0        0 eth0\n20      0         2220   U     0      0        0 eth0\n</code></pre> <p>\u5728 ydzs-node1 \u8282\u70b9\u4e0a\u53ef\u4ee5\u67e5\u770b\u5230 pod-a \u4e2d\u7684\u7f51\u5173 10.244.1.1 \u5c31\u662f\u8282\u70b9\u4e0a\u7684 <code>cni0</code> \u7f51\u6865\uff1a</p> <pre><code>[root@ydzs-node1 ~]# ifconfig -a\ncni0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450\n        inet 21  netmask 2220  broadcast 0\n        inet6 fe80::64c2:65ff:fe15:3669  prefixlen 64  scopeid 0x20&lt;link&gt;\n        ether f6:f9:99:71:81:a2  txqueuelen 1000  (Ethernet)\n        RX packets 33385207  bytes 24883992070 (1 GiB)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 31653673  bytes 19703556786 (3 GiB)\n        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0\n......\n</code></pre> <p>2\u3001\u8fd9\u4e2a\u65f6\u5019\uff0cIP \u5305\u7684\u4e0b\u4e00\u4e2a\u76ee\u7684\u5730\uff0c\u5c31\u53d6\u51b3\u4e8e\u5bbf\u4e3b\u673a\u4e0a\u9762\u7684\u8def\u7531\u89c4\u5219\u4e86\uff0cFlanneld \u8fdb\u7a0b\u5df2\u7ecf\u5728\u5bbf\u4e3b\u673a\u4e0a\u9762\u521b\u5efa\u4e86\u4e00\u7cfb\u5217\u7684\u8def\u7531\u89c4\u5219\uff0c\u6bd4\u5982\u5f53\u524d\u7684 ydzs-node1 \u8282\u70b9\uff1a</p> <pre><code>[root@ydzs-node1 ~]# ip route\ndefault via 111 dev eth0  proto static  metric 100\n10/24 dev eth0  proto kernel  scope link  src 122  metric 100\n20/16 dev flannel0\n20/24 dev cni0  proto kernel  scope link  src 21\n10/16 dev docker0  proto kernel  scope link  src 11\n</code></pre> <p>\u6b64\u65f6\u5230\u8fbe <code>cni0</code> \u7684 IP \u5305\u76ee\u6807\u5730\u5740 10.244.2.123 \u5339\u914d\u4e0d\u5230\u672c\u673a\u7684 <code>cni0</code> \u7f51\u6865\u5bf9\u5e94\u7684 <code>10.244.1.0/24</code> \u7f51\u6bb5\uff0c\u53ea\u80fd\u5339\u914d\u5230\u7b2c\u4e09\u6761 <code>10.244.0.0/16</code> \u5bf9\u5e94\u7684\u8fd9\u6761\u8def\u7531\u89c4\u5219\uff0c\u8fd9\u4e2a\u65f6\u5019\u5185\u6838\u5c06 RAW IP \u5305\u53d1\u9001\u7ed9 <code>flannel0</code> \u8bbe\u5907\u3002</p> <p><code>flannel0</code> \u8bbe\u5907\u5b83\u662f\u4e00\u4e2a <code>TUN</code> \u8bbe\u5907\uff08Tunnel \u8bbe\u5907\uff09\u3002\u5728 Linux \u4e2d\uff0cTUN \u8bbe\u5907\u662f\u4e00\u79cd\u5de5\u4f5c\u5728\u4e09\u5c42\uff08Network Layer\uff09\u7684\u865a\u62df\u7f51\u7edc\u8bbe\u5907\uff0cTUN \u8bbe\u5907\u7684\u529f\u80fd\u975e\u5e38\u7b80\u5355\uff0c\u5373\uff1a<code>\u5728\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u548c\u7528\u6237\u5e94\u7528\u7a0b\u5e8f\u4e4b\u95f4\u4f20\u9012 IP \u5305</code>\u3002</p> <p>3\u3001\u7531\u4e8e <code>flannel0</code> \u662f\u4e00\u4e2a <code>TUN</code> \u8bbe\u5907\uff0c\u53d1\u9001\u7ed9 <code>flannel0</code> \u63a5\u53e3\u7684 <code>RAW IP</code> \u5305\u5c06\u88ab Flanneld \u8fdb\u7a0b\u63a5\u6536\u5230\uff0c\u7136\u540e\u5728\u539f\u6709\u7684\u57fa\u7840\u4e0a\u8fdb\u884c UDP \u5c01\u5305\uff0c\u7136\u540e\u53d1\u9001\u5230 ydzs-node2 \u8282\u70b9\u4e0a\u7684 <code>Flanneld</code> \u8fdb\u884c\u89e3\u5305\u3002</p> <p>\u5c01\u5305</p> <p>UDP \u5c01\u5305\u7684\u5f62\u5f0f\u4e3a\uff1a10.151.30.22:src port -&gt; 10.151.30.23:8285\u3002</p> <p>\u8fd9\u91cc\u6700\u5173\u952e\u7684\u5c31\u662f UDP \u5c01\u5305\u53d1\u9001\u5230\u6211\u4eec\u7684\u76ee\u6807 IP 10.244.2.123 \u8fd9\u4e2a\u5bb9\u5668\u6240\u5728\u7684\u8282\u70b9\uff0c\u4f46\u662f\u662f\u5982\u4f55\u77e5\u9053\u8fd9\u4e2a\u8282\u70b9\u7684\u5462\uff1f</p> <p>\u8fd9\u4e2a\u5c31\u9700\u8981\u4e86\u89e3\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u6982\u5ff5*\u5b50\u7f51\uff08Subnet\uff09\uff0cFlannel \u7ba1\u7406\u7684\u5bb9\u5668\u7f51\u7edc\uff0c\u4e00\u53f0\u5bbf\u4e3b\u673a\u4e0a\u7684\u6240\u6709\u5bb9\u5668\uff0c\u90fd\u5c5e\u4e8e\u8be5\u5bbf\u4e3b\u673a\u88ab\u5206\u914d\u7684\u4e00\u4e2a\u5b50\u7f51\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u7684 ydzs-node1 \u8282\u70b9\u7684\u5b50\u7f51\u662f <code>10.244.1.0/24</code>\uff0810.244.1.1-10.244.1.254\uff09\uff0cpod-a \u7684 IP \u5730\u5740\u662f <code>10.244.1.236</code>\uff1bydzs-node2 \u8282\u70b9\u7684\u5b50\u7f51\u662f <code>10.244.2.0/24</code>\uff0810.244.2.1-10.244.2.254\uff09\uff0cpod-b \u7684 IP \u5730\u5740\u662f <code>10.244.2.123</code>\uff0c\u8fd9\u4e9b\u5b50\u7f51\u4fe1\u606f\u662f\u5f53 Flanneld \u8fdb\u7a0b\u5728\u542f\u52a8\u65f6\u901a\u8fc7 api-server \u4fdd\u5b58\u5230 etcd \u5f53\u4e2d\uff0c\u6240\u4ee5\u5728\u53d1\u9001\u62a5\u6587\u65f6\u53ef\u4ee5\u901a\u8fc7\u76ee\u7684\u5730\u5740 <code>10.244.2.123</code> \u5339\u914d\u5230\u5bf9\u5e94\u7684\u5b50\u7f51\u662f <code>10.244.2.0/24</code>\uff0c\u8fd9\u4e2a\u65f6\u5019\u67e5\u8be2 etcd \u5f97\u5230\u8fd9\u4e2a\u5b50\u7f51\u5bf9\u5e94\u7684\u5bbf\u4e3b\u673a\u7684 IP \u5730\u5740 10.151.30.23\uff0c\u4e5f\u5c31\u662f ydzs-node2 \u8282\u70b9\u3002</p> <p>4\u3001ydzs-node2 \u8282\u70b9\u6536\u5230 UDP \u62a5\u6587\u8fc7\u540e\u7ecf\u8fc7 Linux \u5185\u6838\u901a\u8fc7 UDP \u7aef\u53e3 8285 \u5c06\u5305\u4ea4\u7ed9\u8282\u70b9\u4e0a\u7684 Flanneld \u8fdb\u7a0b\u3002</p> <p>5\u3001\u7136\u540e ydzs-node2 \u8282\u70b9\u4e0a\u7684 Flanneld \u8fdb\u7a0b\u5c06\u63a5\u6536\u5230\u7684 UDP \u5305\u89e3\u5305\u540e\u5f97\u5230 RAW IP \u5305\uff1a</p> <pre><code>2236 -&gt; 2123\n</code></pre> <p>\u3002</p> <p>6\u3001\u89e3\u5305\u540e\u7684 RAW IP \u5305\u5339\u914d\u5230 ydzs-node2 \u8282\u70b9\u4e0a\u7684\u8def\u7531\u89c4\u5219\uff0810.244.2.0/24\uff09\uff0c\u5185\u6838\u5c06 RAW IP \u5305\u53d1\u9001\u7ed9 <code>cni0</code> \u8bbe\u5907</p> <pre><code>[root@ydzs-node2 ~]# ip route\ndefault via 111 dev eth0  proto static  metric 100\n10/24 dev eth0  proto kernel  scope link  src 123  metric 100\n20/16 dev flannel0\n20/24 dev cni0  proto kernel  scope link  src 21\n10/16 dev docker0  proto kernel  scope link  src 11\n</code></pre> <p>7\u3001<code>cni0</code> \u5c06 IP \u5305\u8f6c\u53d1\u7ed9\u8fde\u63a5\u5728 <code>cni0</code> \u7f51\u6865\u4e0a\u7684 pod-b\uff0c\u8fd9\u6837\u5c31\u5b8c\u6210\u4e86\u8fd9\u4e2a\u901a\u4fe1\u8fc7\u7a0b\uff1a</p> <pre><code>$ kubectl exec pod-a ping 2123\nPING 2123 (2123): 56 data bytes\n64 bytes from 2123: seq=0 ttl=62 time=452 ms\n64 bytes from 2123: seq=1 ttl=62 time=160 ms\n64 bytes from 2123: seq=2 ttl=62 time=853 ms\n</code></pre> <p>\u4e0a\u9762\u5c31\u662f\u57fa\u4e8e Flannel UDP \u6a21\u5f0f\u7684\u8de8\u4e3b\u901a\u4fe1\u7684\u57fa\u672c\u6d41\u7a0b\u4e86\uff0c\u4ece\u4e0a\u9762\u7684\u6574\u4e2a\u6d41\u7a0b\u6765\u770b\uff0c<code>Flanneld</code> \u4e3b\u8981\u6709\u4e24\u65b9\u9762\u7684\u529f\u80fd\uff1a</p> <ul> <li>UDP \u5c01\u5305\u89e3\u5305</li> <li>\u8282\u70b9\u4e0a\u7684\u8def\u7531\u8868\u7684\u52a8\u6001\u66f4\u65b0</li> </ul> <p>\u6211\u4eec\u53ef\u4ee5\u660e\u663e\u770b\u51fa\u6765\u6570\u636e\u5305\u662f\u901a\u8fc7 tun \u8bbe\u5907\u4ece\u5185\u6838\u6001\u590d\u5236\u5230\u7528\u6237\u6001\u7684\u5e94\u7528\u4e2d\u7684\uff0c\u7136\u540e\u518d\u901a\u8fc7\u7528\u6237\u6001\u590d\u5236\u5230\u5185\u6838\u6001\uff0c\u4ec5\u4e00\u6b21\u7f51\u7edc\u4f20\u8f93\u5c31\u8fdb\u884c\u4e86\u4e24\u6b21\u7528\u6237\u6001\u548c\u5185\u6838\u6001\u7684\u5207\u6362\uff0c\u663e\u7136\u8fd9\u79cd\u6548\u7387\u662f\u4e0d\u4f1a\u5f88\u9ad8\u7684\uff0c\u7531\u4e8e\u4f4e\u6548\u7387\u6240\u4ee5\u8fd9\u79cd\u65b9\u5f0f\u57fa\u672c\u4e0a\u4e0d\u662f\u5440\uff0c\u8981\u63d0\u9ad8\u6548\u7387\u6700\u7b80\u5355\u7684\u65b9\u5f0f\u5c31\u662f\u628a\u5c01\u5305\u89e3\u5305\u8fd9\u4e9b\u4e8b\u60c5\u90fd\u4ea4\u7ed9\u5185\u6838\u53bb\u5e72\u597d\u4e86\uff0c\u4e8b\u5b9e\u4e0a Linux \u5185\u6838\u672c\u8eab\u4e5f\u63d0\u4f9b\u4e86\u6bd4\u8f83\u6210\u719f\u7684\u7f51\u7edc\u5c01\u5305\u89e3\u5305\uff08\u96a7\u9053\u4f20\u8f93\uff09\u5b9e\u73b0\u65b9\u6848 <code>VXLAN</code>\uff0cFlanneld \u4e5f\u5b9e\u73b0\u4e86\u57fa\u4e8e <code>VXLAN</code> \u7684\u65b9\u6848\uff0c\u8be5\u65b9\u6848\u5728\u6211\u4eec\u65e5\u5e38\u4f7f\u7528\u7684\u65f6\u5019\u4e5f\u662f\u6700\u666e\u904d\u7684\u3002</p>"},{"location":"kubernetes_network/flannel/#vxlan","title":"VXLAN \u65b9\u5f0f","text":"<p><code>VXLAN</code>\uff0c\u5373 Virtual Extensible LAN\uff08\u865a\u62df\u53ef\u6269\u5c55\u5c40\u57df\u7f51\uff09\uff0c\u662f Linux \u5185\u6838\u672c\u8eab\u5c31\u652f\u6301\u7684\u4e00\u79cd\u7f51\u7edc\u865a\u4f3c\u5316\u6280\u672f\u3002\u6240\u4ee5\u8bf4\uff0cVXLAN \u53ef\u4ee5\u5b8c\u5168\u5728\u5185\u6838\u6001\u5b9e\u73b0\u4e0a\u8ff0\u5c01\u88c5\u548c\u89e3\u5c01\u88c5\u7684\u5de5\u4f5c\uff0c\u4ece\u800c\u901a\u8fc7\u4e0e\u524d\u9762\u76f8\u4f3c\u7684\u96a7\u9053\u673a\u5236\uff0c\u6784\u5efa\u51fa\u8986\u76d6\u7f51\u7edc\uff08Overlay Network\uff09\u3002</p> <p>\u540c\u6837\u7684\u5f53\u6211\u4eec\u4f7f\u7528 <code>VXLAN</code> \u6a21\u5f0f\u7684\u65f6\u5019\u9700\u8981\u5c06 Flanneld \u7684 Backend \u7c7b\u578b\u4fee\u6539\u4e3a <code>vxlan</code>\uff1a</p> <pre><code>$ kubectl edit cm kube-flannel-cfg -n kube-system\napiVersion: v1\ndata:\n  cni-conf.json: |\n    {\n      \"cniVersion\": \"0\",\n      \"name\": \"cbr0\",\n      \"plugins\": [\n        {\n          \"type\": \"flannel\",\n          \"delegate\": {\n            \"hairpinMode\": true,\n            \"isDefaultGateway\": true\n          }\n        },\n        {\n          \"type\": \"portmap\",\n          \"capabilities\": {\n            \"portMappings\": true\n          }\n        }\n      ]\n    }\n  net-conf.json: |\n    {\n        {\n      \"Network\": \"20/16\",\n      \"Backend\": {\n        \"Type\": \"vxlan\"  # \u4fee\u6539\u540e\u7aef\u7c7b\u578b\u4e3a vxlan\n      }\n    }\nkind: ConfigMap\n......\n</code></pre> <p>\u5c06\u7c7b\u578b\u4fee\u6539\u4e3a <code>vxlan</code> \u8fc7\u540e\uff0c\u9700\u8981\u91cd\u5efa\u4e0b Flanneld \u7684\u6240\u6709 Pod \u624d\u80fd\u751f\u6548\uff1a</p> <pre><code>$ kubectl delete pod -n kube-system -l app=flannel\n</code></pre> <p>\u91cd\u5efa\u5b8c\u6210\u540e\u540c\u6837\u53ef\u4ee5\u968f\u4fbf\u67e5\u770b\u4e00\u4e2a Pod \u7684\u65e5\u5fd7\uff0c\u51fa\u73b0\u5982\u4e0b</p> <pre><code>Found network config - Backend type: vxlan\n</code></pre> <p>\u7684\u65e5\u5fd7\u4fe1\u606f\u5c31\u8bc1\u660e\u5df2\u7ecf\u914d\u7f6e\u6210\u529f\u4e86\uff1a</p> <pre><code>$ kubectl logs -f kube-flannel-ds-amd64-pfb8h -n kube-system\nI1129 03:33:588549       1 main.go:527] Using interface with name eth0 and address 123\nI1129 03:33:588893       1 main.go:544] Defaulting external address to interface address (123)\nI1129 03:33:698562       1 kube.go:126] Waiting 10m0s for node controller to sync\nI1129 03:33:698726       1 kube.go:309] Starting kube subnet manager\nI1129 03:33:698910       1 kube.go:133] Node controller sync successful\nI1129 03:33:698980       1 main.go:244] Created subnet manager: Kubernetes Subnet Manager - ydzs-node2\nI1129 03:33:699000       1 main.go:247] Installing signal handlers\nI1129 03:33:699375       1 main.go:386] Found network config - Backend type: vxlan\nI1129 03:33:699553       1 vxlan.go:120] VXLAN config: VNI=1 Port=0 GBP=false DirectRouting=false\nI1129 03:33:703715       1 main.go:317] Wrote subnet file to /run/flannel/subnet.env\nI1129 03:33:703785       1 main.go:321] Running backend.\nI1129 03:33:703825       1 main.go:339] Waiting for all goroutines to exit\nI1129 03:33:703940       1 vxlan_network.go:60] watching for new subnet leases\n</code></pre> <p>Flanneld \u5728\u542f\u52a8\u65f6\u4f1a\u901a\u8fc7 <code>Netlink</code> \u673a\u5236\u4e0e Linux \u5185\u6838\u901a\u4fe1\uff0c\u5efa\u7acb\u4e00\u4e2a </p> <pre><code>VTEP\uff08Virtual Tunnel Access End Point\uff09\n</code></pre> <p>\u8bbe\u5907 <code>flannel.1</code>\uff08\u547d\u540d\u89c4\u5219\u4e3a<code>flannel.[VNI]</code>\uff0cVNI \u9ed8\u8ba4\u4e3a1\uff09\uff0c\u7c7b\u4f3c\u4e8e\u4ea4\u6362\u673a\u5f53\u4e2d\u7684\u4e00\u4e2a\u7f51\u53e3\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>ip -d link</code> \u547d\u4ee4\u67e5\u770b <code>VTEP</code> \u8bbe\u5907 <code>flannel.1</code> \u7684\u914d\u7f6e\u4fe1\u606f\uff1a</p> <pre><code>$ ip -d link show flannel.1\n6: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN mode DEFAULT\n    link/ether 72:f7:e9:40:97:1e brd ff:ff:ff:ff:ff:ff promiscuity 0\n    vxlan id 1 local 122 dev eth0 srcport 0 0 dstport 8472 nolearning ageing 300 addrgenmode eui64\n</code></pre> <p>\u4ece\u4e0a\u9762\u8f93\u51fa\u53ef\u4ee5\u770b\u5230\uff0c<code>VTEP</code> \u7684 local IP \u4e3a 10.151.30.22\uff0cdestination port \u4e3a <code>8472</code>\u3002\u540c\u6837\u6211\u4eec\u4e5f\u53ef\u4ee5\u5728\u8282\u70b9\u4e0a\u67e5\u770b\u8fdb\u7a0b\u76d1\u542c\u60c5\u51b5\uff1a</p> <pre><code>$ netstat -ulnp | grep 8472\nudp        0      0 0:8472            0:*                           -\n</code></pre> <p>\u6211\u4eec\u4ed4\u7ec6\u770b\u548c UDP \u6a21\u5f0f\u4e0b\u67e5\u770b Flanneld \u76d1\u542c\u7684\u7aef\u53e3\u662f\u6709\u533a\u522b\u7684\uff0c\u6700\u540e\u4e00\u680f\u663e\u793a\u7684\u4e0d\u662f\u8fdb\u7a0b\u7684 ID \u548c\u540d\u79f0\uff0c\u800c\u662f\u4e00\u4e2a\u7834\u6298\u53f7<code>-</code>\uff0c\u8fd9\u8bf4\u660e UDP \u76848472\u7aef\u53e3\u4e0d\u662f\u7531\u7528\u6237\u6001\u7684\u8fdb\u7a0b\u5728\u76d1\u542c\u7684\uff0c\u4e5f\u8bc1\u5b9e\u4e86<code>VXLAN</code>\u6a21\u5757\u5de5\u4f5c\u5728\u5185\u6838\u6001\u6a21\u5f0f\u4e0b\u3002</p> <p>\u5728 UDP \u6a21\u5f0f\u4e0b\u7531 Flanneld \u8fdb\u7a0b\u8fdb\u884c\u7f51\u7edc\u5305\u7684\u5c01\u5305\u548c\u89e3\u5305\u7684\u5de5\u4f5c\uff0c\u800c\u5728 <code>VXLAN</code> \u6a21\u5f0f\u4e0b\u89e3\u5c01\u5305\u7684\u4e8b\u60c5\u4ea4\u7531\u5185\u6838\u5904\u7406\uff0c\u4e0b\u9762\u6211\u4eec\u6765\u770b\u4e0b Flanneld \u540e\u7aef\u7684\u5177\u4f53\u5de5\u5177\u6d41\u7a0b\u3002\u5f53 Flanneld \u542f\u52a8\u65f6\u5c06\u521b\u5efa <code>VTEP</code> \u8bbe\u5907 <code>flannel.1</code>\uff0c\u5e76\u5c06 <code>VTEP</code> \u8bbe\u5907\u7684\u76f8\u5173\u4fe1\u606f\u4e0a\u62a5\u5230 etcd \u5f53\u4e2d\uff0c\u800c\u5f53\u5728 Flannel \u7f51\u7edc\u4e2d\u6709\u65b0\u7684\u8282\u70b9\u53d1\u73b0\u65f6\uff0c\u5404\u4e2a\u8282\u70b9\u4e0a\u7684 Flanneld \u8fdb\u7a0b\u5c06\u4f9d\u6b21\u6267\u884c\u4ee5\u4e0b\u6d41\u7a0b\uff1a</p> <p>1\u3001\u5728\u8282\u70b9\u5f53\u4e2d\u521b\u5efa\u4e00\u6761\u8be5\u8282\u70b9\u6240\u5c5e\u7f51\u6bb5\u7684\u8def\u7531\u8868\uff0c\u4e3b\u8981\u662f\u80fd\u8ba9 Pod \u5f53\u4e2d\u7684\u6d41\u91cf\u8def\u7531\u5230 <code>flannel.1</code> \u63a5\u53e3\u3002\u901a\u8fc7<code>route -n</code>\u53ef\u4ee5\u67e5\u770b\u5230\u8282\u70b9\u5f53\u4e2d\u5df2\u7ecf\u6709\u56db\u6761 <code>flannel.1</code> \u63a5\u53e3\u7684\u8def\u7531\uff1a</p> <pre><code>$ route -n\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n0         111    0         UG    100    0        0 eth0\n10     0         2220   U     100    0        0 eth0\n20      20      2220   UG    0      0        0 flannel.1\n20      0         2220   U     0      0        0 cni0\n20      20      2220   UG    0      0        0 flannel.1\n20      20      2220   UG    0      0        0 flannel.1\n20      20      2220   UG    0      0        0 flannel.1\n10      0         220     U     0      0        0 docker0\n</code></pre> <p>\u6bd4\u5982 <code>10.244.2.0</code> \u8fd9\u6761\u8def\u7531\u89c4\u5219\uff0c\u4ed6\u7684\u610f\u601d\u5c31\u662f\u53d1\u5f80 <code>10.244.2.0/24</code> \u7f51\u6bb5\u7684 IP \u5305\uff0c\u90fd\u9700\u8981\u7ecf\u8fc7 <code>flannel.1</code> \u8bbe\u5907\u53d1\u51fa\uff0c\u800c\u4e14\u6700\u540e\u88ab\u53d1\u9001\u5230\u7684\u7f51\u5173\u5730\u5740\u662f <code>10.244.2.0</code>\u3002\u800c\u5176\u5b9e\u8fd9\u4e2a\u7f51\u5173\u5730\u5740\u5c31\u662f ydzs-node2 \u8282\u70b9\u4e0a\u7684 VTEP \u8bbe\u5907\uff08\u4e5f\u5c31\u662f flannel.1\uff09\u7684 IP \u5730\u5740\uff1a</p> <pre><code>[root@ydzs-node2 ~]# ifconfig\nflannel.1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450\n        inet 20  netmask 222255  broadcast 0\n        inet6 fe80::2467:52ff:fe6b:1bf9  prefixlen 64  scopeid 0x20&lt;link&gt;\n        ether 26:67:52:6b:1b:f9  txqueuelen 0  (Ethernet)\n        RX packets 42050890  bytes 27691009839 (7 GiB)\n        RX errors 0  dropped 0  overruns 0  frame 0\n        TX packets 36287976  bytes 46894346975 (6 GiB)\n        TX errors 0  dropped 163 overruns 0  carrier 0  collisions 0\n......\n</code></pre> <p>2\u3001\u4e0a\u9762\u77e5\u9053\u4e86\u76ee\u7684 VTEP \u8bbe\u5907\u7684 IP \u5730\u5740\u4e86\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u9700\u8981\u77e5\u9053\u76ee\u7684 MAC \u5730\u5740\uff0c\u624d\u80fd\u628a\u6570\u636e\u5305\u53d1\u9001\u8fc7\u53bb\uff0c\u8fd9\u4e2a\u65f6\u5019\u5176\u5b9e Flanneld \u8fdb\u7a0b\u5c31\u4f1a\u5728\u8282\u70b9\u5f53\u4e2d\u7ef4\u62a4\u6240\u6709\u8282\u70b9\u7684 IP \u4ee5\u53ca <code>VTEP</code> \u8bbe\u5907\u7684\u9759\u6001 <code>ARP</code> \u7f13\u5b58\u3002\u53ef\u901a\u8fc7 <code>arp -n</code> \u547d\u4ee4\u67e5\u770b\u5230\u5f53\u524d\u8282\u70b9\u5f53\u4e2d\u5df2\u7ecf\u7f13\u5b58\u4e86\u53e6\u5916\u56db\u4e2a\u8282\u70b9\u4ee5\u53ca <code>VTEP</code> \u7684 ARP \u4fe1\u606f\u3002</p> <pre><code>$ arp -n\nAddress                  HWtype  HWaddress           Flags Mask            Iface\n20               ether   32:f1:e0:a9:97:ab   CM                    flannel.1\n20               ether   26:67:52:6b:1b:f9   CM                    flannel.1\n20               ether   0a:24:5e:40:ff:da   CM                    flannel.1\n20               ether   4a:09:1f:42:ed:c1   CM                    flannel.1\n......\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u770b\u5230 IP \u5730\u5740 <code>10.244.2.0</code> \u5bf9\u5e94\u7684 MAC \u5730\u5740\u662f <code>26:67:52:6b:1b:f9</code>\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u77e5\u9053\u4e86\u76ee\u7684 VTEP \u8bbe\u5907\u7684 MAC \u5730\u5740\u3002\u4f46\u662f\u73b0\u5728\u6211\u4eec\u53ea\u662f\u77e5\u9053\u4e86\u76ee\u6807\u8bbe\u5907\u7684 MAC \u5730\u5740\uff0c\u5374\u4e0d\u77e5\u9053\u5bf9\u5e94\u7684\u5bbf\u4e3b\u673a\u7684\u5730\u5740\u662f\u4ec0\u4e48\uff1f</p> <p>3\u3001\u8fd9\u4e2a\u65f6\u5019 Flanneld \u8fdb\u7a0b\u8fd8\u4f1a\u5728\u8282\u70b9\u5f53\u4e2d\u6dfb\u52a0\u4e00\u6761\u8be5\u8282\u70b9\u7684\u8f6c\u53d1\u8868\uff0c\u901a\u8fc7 <code>bridge</code> \u547d\u4ee4\u67e5\u770b\u8282\u70b9\u4e0a\u7684 VXLAN \u8f6c\u53d1\u8868\uff08FDB entry\uff09\uff0cMAC \u4e3a <code>VTEP</code> \u8bbe\u5907\u5373 <code>flannel.1</code> \u7684 MAC \u5730\u5740\uff0cIP \u4e3a VTEP \u5bf9\u5e94\u7684\u5bf9\u5916 IP\uff08\u53ef\u901a\u8fc7 Flanneld \u7684\u542f\u52a8\u53c2\u6570 <code>--iface=eth0</code> \u6307\u5b9a\uff0c\u82e5\u4e0d\u6307\u5b9a\u5219\u6309\u9ed8\u8ba4\u7f51\u5173\u67e5\u627e\u7f51\u7edc\u63a5\u53e3\u5bf9\u5e94\u7684 IP\uff09\uff0c\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u6709\u56db\u6761\u8f6c\u53d1\u8868\u3002</p> <pre><code>$ bridge fdb show dev flannel.1\n32:f1:e0:a9:97:ab dst 157 self permanent\n26:67:52:6b:1b:f9 dst 123 self permanent\n4a:09:1f:42:ed:c1 dst 159 self permanent\n0a:24:5e:40:ff:da dst 111 self permanent\n</code></pre> <p>\u8fd9\u6837\u6211\u4eec\u5c31\u627e\u5230\u4e86\u4e0a\u9762\u76ee\u7684 VTEP \u8bbe\u5907\u7684 MAC \u5730\u5740\u5bf9\u5e94\u7684 IP \u5730\u5740\u4e3a 10.151.30.23 \u7684\u4e3b\u673a\uff0c\u8fd9\u5c31\u662f\u6211\u4eec\u7684 ydzs-node2 \u8282\u70b9\uff0c\u6240\u4ee5\u6211\u4eec\u5c31\u627e\u5230\u4e86\u8981\u53d1\u5f80\u7684\u76ee\u7684\u5730\u5740\u3002</p> <p>\u8fd9\u4e2a\u65f6\u5019\u5bb9\u5668\u8de8\u8282\u70b9\u7f51\u7edc\u901a\u4fe1\u5b9e\u73b0\u7684\u5b8c\u6574\u6d41\u7a0b\u4e3a\uff1a</p> <ul> <li>\u548c UDP \u6a21\u5f0f\u4e00\u6837\uff0cpod-a\uff0810.244.1.236\uff09\u5f53\u4e2d\u7684 IP \u5305\u901a\u8fc7 pod-a \u5185\u7684\u8def\u7531\u8868\u88ab\u53d1\u9001\u5230 <code>cni0</code></li> <li>\u5230\u8fbe <code>cni0</code> \u5f53\u4e2d\u7684 IP \u5305\u901a\u8fc7\u5339\u914d\u8282\u70b9 ydzs-node1 \u5f53\u4e2d\u7684\u8def\u7531\u8868\u53d1\u73b0\u901a\u5f80 10.244.2.13 \u7684 IP \u5305\u5e94\u8be5\u4ea4\u7ed9 <code>flannel.1</code> \u63a5\u53e3</li> <li><code>flannel.1</code> \u4f5c\u4e3a\u4e00\u4e2a VTEP \u8bbe\u5907\uff0c\u6536\u5230\u62a5\u6587\u540e\u5c06\u6309\u7167 <code>VTEP</code> \u7684\u914d\u7f6e\u8fdb\u884c\u5c01\u5305\uff0c\u901a\u8fc7 ydzs-node1 \u8282\u70b9\u4e0a\u7684 arp \u548c\u8f6c\u53d1\u8868\u5f97\u77e5 10.244.2.123 \u5c5e\u4e8e\u8282\u70b9 ydzs-node2\uff0c\u5e76\u4e14\u4f1a\u5c06 ydzs-node2 \u8282\u70b9\u5bf9\u5e94\u7684 VTEP \u8bbe\u5907\u7684 MAC \u5730\u5740\uff0c\u6839\u636e <code>flannel.1</code> \u8bbe\u5907\u521b\u5efa\u65f6\u7684\u8bbe\u7f6e\u7684\u53c2\u6570\uff08VNI\u3001local IP\u3001Port\uff09\u8fdb\u884c VXLAN \u5c01\u5305</li> <li>\u901a\u8fc7\u8282\u70b9 ydzs-node2 \u8ddf ydzs-node1 \u4e4b\u95f4\u7684\u7f51\u7edc\u8fde\u63a5\uff0cVXLAN \u5305\u5230\u8fbe ydzs-node2 \u7684 eth0 \u63a5\u53e3</li> <li>\u901a\u8fc7\u7aef\u53e3 8472\uff0cVXLAN \u5305\u88ab\u8f6c\u53d1\u7ed9 VTEP \u8bbe\u5907 <code>flannel.1</code> \u8fdb\u884c\u89e3\u5305</li> <li>\u89e3\u5c01\u88c5\u540e\u7684 IP \u5305\u5339\u914d\u8282\u70b9 ydzs-node2 \u5f53\u4e2d\u7684\u8def\u7531\u8868\uff0810.244.2.0\uff09\uff0c\u5185\u6838\u5c06 IP \u5305\u8f6c\u53d1\u7ed9<code>cni0</code></li> <li><code>cni0</code>\u5c06 IP \u5305\u8f6c\u53d1\u7ed9\u8fde\u63a5\u5728 <code>cni0</code> \u4e0a\u7684 pod-b</li> </ul>"},{"location":"kubernetes_network/flannel/#host-gw","title":"host-gw","text":"<p><code>host-gw</code> \u5373 Host Gateway\uff0c\u4ece\u540d\u5b57\u4e2d\u5c31\u53ef\u4ee5\u60f3\u5230\u8fd9\u79cd\u65b9\u5f0f\u662f\u901a\u8fc7\u628a\u4e3b\u673a\u5f53\u4f5c\u7f51\u5173\u6765\u5b9e\u73b0\u8de8\u8282\u70b9\u7f51\u7edc\u901a\u4fe1\u7684\u3002\u90a3\u4e48\u5177\u4f53\u5982\u4f55\u5b9e\u73b0\u8de8\u8282\u70b9\u901a\u4fe1\u5462\uff1f</p> <p>\u540c\u7406 UDP \u6a21\u5f0f\u548c VXLAN \u6a21\u5f0f\uff0c\u9996\u5148\u5c06 Backend \u4e2d\u7684 type \u6539\u4e3a<code>host-gw</code>\uff0c\u8fd9\u91cc\u5c31\u4e0d\u518d\u8d58\u8ff0\uff0c\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u968f\u4fbf\u67e5\u770b\u4e00\u4e2a flannel \u7684 Pod \u65e5\u5fd7\uff0c\u5982\u679c\u51fa\u73b0\u5982\u4e0b\u6240\u793a\u7684 </p> <pre><code>Found network config - Backend type: host-gw\n</code></pre> <p>\u65e5\u5fd7\u5c31\u8bc1\u660e\u5df2\u7ecf\u662f <code>host-gw</code> \u6a21\u5f0f\u4e86\uff1a</p> <pre><code>$ kubectl logs -f kube-flannel-ds-amd64-642l6 -n kube-system\nI1129 04:53:309992       1 main.go:527] Using interface with name eth0 and address 159\nI1129 04:53:310292       1 main.go:544] Defaulting external address to interface address (159)\nI1129 04:53:510618       1 kube.go:126] Waiting 10m0s for node controller to sync\nI1129 04:53:607860       1 kube.go:309] Starting kube subnet manager\nI1129 04:53:511530       1 kube.go:133] Node controller sync successful\nI1129 04:53:511624       1 main.go:244] Created subnet manager: Kubernetes Subnet Manager - ydzs-node4\nI1129 04:53:511646       1 main.go:247] Installing signal handlers\nI1129 04:53:511899       1 main.go:386] Found network config - Backend type: host-gw\nI1129 04:53:611040       1 main.go:317] Wrote subnet file to /run/flannel/subnet.env\nI1129 04:53:611120       1 main.go:321] Running backend.\nI1129 04:53:611165       1 main.go:339] Waiting for all goroutines to exit\nI1129 04:53:611280       1 route_network.go:53] Watching for new subnet leases\nI1129 04:53:611768       1 route_network.go:85] Subnet added: 20/24 via 111\nW1129 04:53:612268       1 route_network.go:102] Replacing existing route to 20/24 via 20 dev index 6 with 20/24 via 111 dev index \nI1129 04:53:612705       1 route_network.go:85] Subnet added: 20/24 via 122\nW1129 04:53:612777       1 route_network.go:88] Ignoring non-host-gw subnet: type=vxlan\nI1129 04:53:612829       1 route_network.go:85] Subnet added: 20/24 via 123\nW1129 04:53:612868       1 route_network.go:88] Ignoring non-host-gw subnet: type=vxlan\nI1129 04:53:612935       1 route_network.go:85] Subnet added: 20/24 via 157\nW1129 04:53:612995       1 route_network.go:88] Ignoring non-host-gw subnet: type=vxlan\nI1129 04:53:808989       1 route_network.go:85] Subnet added: 20/24 via 157\nW1129 04:53:809279       1 route_network.go:102] Replacing existing route to 20/24 via 20 dev index 6 with 20/24 via 157 dev index \nI1129 04:53:012832       1 route_network.go:85] Subnet added: 20/24 via 122\nW1129 04:53:013132       1 route_network.go:102] Replacing existing route to 20/24 via 20 dev index 6 with 20/24 via 122 dev index \nI1129 04:53:713684       1 route_network.go:85] Subnet added: 20/24 via 123\nW1129 04:53:714022       1 route_network.go:102] Replacing existing route to 20/24 via 20 dev index 6 with 20/24 via 123 dev index\n</code></pre> <p>\u91c7\u7528 <code>host-gw</code> \u6a21\u5f0f\u540e Flanneld \u7684\u552f\u4e00\u4f5c\u7528\u5c31\u662f<code>\u8d1f\u8d23\u4e3b\u673a\u4e0a\u8def\u7531\u8868\u7684\u52a8\u6001\u66f4\u65b0</code>\uff0c\u5176\u5b9e\u5c31\u662f\u5c06\u6bcf\u4e2a Flannel \u5b50\u7f51\uff08Flannel Subnet\uff0c\u6bd4\u5982\uff1a10.244.1.0/24\uff09\u7684<code>\u4e0b\u4e00\u8df3</code>\uff0c\u8bbe\u7f6e\u6210\u4e86\u8be5\u5b50\u7f51\u5bf9\u5e94\u7684\u5bbf\u4e3b\u673a\u7684 IP \u5730\u5740\uff0c\u5f53\u7136\uff0cFlannel \u5b50\u7f51\u548c\u4e3b\u673a\u7684\u4fe1\u606f\uff0c\u90fd\u662f\u4fdd\u5b58\u5728 etcd \u5f53\u4e2d\u7684\u3002Fanneld \u53ea\u9700\u8981 WACTH \u8fd9\u4e9b\u6570\u636e\u7684\u53d8\u5316\uff0c\u7136\u540e\u5b9e\u65f6\u66f4\u65b0\u8def\u7531\u8868\u5373\u53ef\u3002\u4e3b\u8981\u6d41\u7a0b\u5982\u4e0b\u6240\u793a\uff1a</p> <p>1\u3001\u540c UDP\u3001VXLAN \u6a21\u5f0f\u4e00\u81f4\uff0c\u901a\u8fc7\u5bb9\u5668A \u7684\u8def\u7531\u8868 IP \u5305\u5230\u8fbe<code>cni0</code> 2\u3001\u5230\u8fbe <code>cni0</code> \u7684 IP \u5305\u5339\u914d\u5230 ydzs-node1 \u5f53\u4e2d\u7684\u8def\u7531\u89c4\u5219\uff0810.244.2.0\uff09\uff0c\u5e76\u4e14\u7f51\u5173\u4e3a 10.151.30.23\uff0c\u5373\u8282\u70b9 ydzs-node2\uff0c\u6240\u4ee5\u5185\u6838\u5c06 IP \u5305\u53d1\u9001\u7ed9\u8282\u70b9 ydzs-node2\uff0810.151.30.23\uff09:</p> <pre><code>$ route -n\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n0         111    0         UG    100    0        0 eth0\n10     0         2220   U     100    0        0 eth0\n20      111    2220   UG    0      0        0 eth0\n20      0         2220   U     0      0        0 cni0\n20      123    2220   UG    0      0        0 eth0\n20      157    2220   UG    0      0        0 eth0\n20      159    2220   UG    0      0        0 eth0\n10      0         220     U     0      0        0 docker0\n</code></pre> <p>3\u3001IP \u5305\u901a\u8fc7\u7269\u7406\u7f51\u7edc\u5230\u8fbe\u8282\u70b9\u7684 ydzs-node2 \u7684 eth0 \u8bbe\u5907 4\u3001\u5230\u8fbe ydzs-node2 \u8282\u70b9 eth0 \u7684 IP \u5305\u5339\u914d\u5230\u8282\u70b9\u5f53\u4e2d\u7684\u8def\u7531\u8868\uff0810.244.2.0/24\uff09\uff0cIP \u5305\u88ab\u8f6c\u53d1\u7ed9 <code>cni0</code> \u8bbe\u5907 5\u3001<code>cni0</code> \u5c06 IP \u5305\u8f6c\u53d1\u7ed9\u8fde\u63a5\u5728 <code>cni0</code> \u4e0a\u7684 pod-b</p> <p>\u8fd9\u6837\u5c31\u5b8c\u6210\u4e86\u6574\u4e2a\u8de8\u4e3b\u673a\u901a\u4fe1\u6d41\u7a0b\uff0c\u8fd9\u4e2a\u6d41\u7a0b\u53ef\u80fd\u662f\u6700\u7b80\u5355\u6700\u5bb9\u5668\u7406\u89e3\u7684\u6a21\u5f0f\u4e86\uff0c\u800c\u4e14\u5bb9\u5668\u901a\u4fe1\u7684\u8fc7\u7a0b\u8fd8\u514d\u9664\u4e86\u989d\u5916\u7684\u5c01\u5305\u548c\u89e3\u5305\u5e26\u6765\u7684\u6027\u80fd\u635f\u8017\uff0c\u6240\u4ee5\u7406\u8bba\u4e0a\u6027\u80fd\u80af\u5b9a\u8981\u66f4\u597d\uff0c\u4f46\u662f\u8be5\u6a21\u5f0f\u662f\u901a\u8fc7\u8282\u70b9\u4e0a\u7684<code>\u8def\u7531\u8868</code>\u6765\u5b9e\u73b0\u5404\u4e2a\u8282\u70b9\u4e4b\u95f4\u7684\u8de8\u8282\u70b9\u7f51\u7edc\u901a\u4fe1\uff0c\u90a3\u4e48\u5c31\u5f97\u4fdd\u8bc1\u4e24\u4e2a\u8282\u70b9\u662f\u53ef\u4ee5<code>\u76f4\u63a5\u8def\u7531</code>\u8fc7\u53bb\u7684\u3002\u6309\u7167\u5185\u6838\u5f53\u4e2d\u7684\u8def\u7531\u89c4\u5219\uff0c\u7f51\u5173\u5fc5\u987b\u5728\u8ddf\u4e3b\u673a\u5f53\u4e2d\u81f3\u5c11\u4e00\u4e2a IP \u5904\u4e8e\u540c\u4e00\u7f51\u6bb5\uff0c\u6545\u9020\u6210\u7684\u7ed3\u679c\u5c31\u662f\u91c7\u7528<code>host-gw</code> \u8fd9\u79cd\u6a21\u5f0f\u7684\u65f6\u5019\uff0c\u96c6\u7fa4\u4e2d\u6240\u6709\u7684\u8282\u70b9\u5fc5\u987b\u5904\u4e8e\u540c\u4e00\u4e2a\u7f51\u7edc\u5f53\u4e2d\uff0c\u8fd9\u5bf9\u4e8e\u96c6\u7fa4\u89c4\u6a21\u6bd4\u8f83\u5927\u65f6\u9700\u8981\u5bf9\u8282\u70b9\u8fdb\u884c\u7f51\u6bb5\u5212\u5206\u7684\u8bdd\u4f1a\u5b58\u5728\u4e00\u5b9a\u7684\u5c40\u9650\u6027\uff0c\u53e6\u5916\u4e00\u4e2a\u5219\u662f\u968f\u7740\u96c6\u7fa4\u5f53\u4e2d\u8282\u70b9\u89c4\u6a21\u7684\u589e\u5927\uff0cFlanneld \u9700\u8981\u7ef4\u62a4\u4e3b\u673a\u4e0a\u6210\u5343\u4e0a\u4e07\u6761\u8def\u7531\u8868\u7684\u52a8\u6001\u66f4\u65b0\u4e5f\u662f\u4e00\u4e2a\u4e0d\u5c0f\u7684\u538b\u529b\u3002</p> <p>\u9664\u4e86 Flannel \u4e4b\u5916\uff0c<code>Calico</code> \u8fd9\u79cd\u7f51\u7edc\u63d2\u4ef6\u548c Flannel \u7684 <code>host-gw</code> \u6a21\u5f0f\u57fa\u672c\u4e0a\u662f\u4e00\u6837\u7684\uff0c\u90fd\u662f\u5728\u6bcf\u53f0\u4e66\u4e3b\u673a\u4e0a\u9762\u6dfb\u52a0\u5b50\u7f51\u548c\u5bf9\u5e94\u7684\u4e66\u4e3b\u673a\u7684 IP \u5730\u5740\u4e3a\u7f51\u5173\u8fd9\u6837\u7684\u8def\u7531\u4fe1\u606f\uff0c\u4e0d\u8fc7\uff0c\u4e0d\u540c\u4e8e Flannel \u901a\u8fc7 Etcd \u548c\u5bbf\u4e3b\u673a\u4e0a\u7684 flanneld \u6765\u7ef4\u62a4\u8def\u7531\u4fe1\u606f\u7684\u505a\u6cd5\uff0cCalico \u4f7f\u7528 <code>bgp</code> \u6765\u81ea\u52a8\u5730\u5728\u6574\u4e2a\u96c6\u7fa4\u4e2d\u5206\u53d1\u8def\u7531\u4fe1\u606f\u3002</p>"},{"location":"kubernetes_network/policy/","title":"\u7f51\u7edc\u7b56\u7565","text":"<p>\ue3c9</p>"},{"location":"kubernetes_network/policy/#networkpolicy","title":"NetworkPolicy","text":"<p>\u5728 Kubernetes \u4e2d\u8981\u5b9e\u73b0\u5bb9\u5668\u4e4b\u95f4\u7f51\u7edc\u7684\u9694\u79bb\uff0c\u662f\u901a\u8fc7\u4e00\u4e2a\u4e13\u95e8\u7684 API \u5bf9\u8c61 <code>NetworkPolicy</code>\uff08\u7f51\u7edc\u7b56\u7565\uff09\u6765\u5b9e\u73b0\u7684\uff0c\u8981\u8ba9\u7f51\u7edc\u7b56\u7565\u751f\u6548\uff0c\u5c31\u9700\u8981\u7279\u5b9a\u7684\u7f51\u7edc\u63d2\u4ef6\u652f\u6301\uff0c\u76ee\u524d\u5df2\u7ecf\u5b9e\u73b0\u4e86 <code>NetworkPolicy</code> \u7684\u7f51\u7edc\u63d2\u4ef6\u5305\u62ec Calico\u3001Weave \u548c kube-router \u7b49\u9879\u76ee\uff0c\u4f46\u662f\u5e76\u4e0d\u5305\u62ec Flannel \u9879\u76ee\u3002\u6240\u4ee5\u8bf4\uff0c\u5982\u679c\u60f3\u8981\u5728\u4f7f\u7528 Flannel \u7684\u540c\u65f6\u8fd8\u4f7f\u7528 NetworkPolicy \u7684\u8bdd\uff0c\u4f60\u5c31\u9700\u8981\u518d\u989d\u5916\u5b89\u88c5\u4e00\u4e2a\u7f51\u7edc\u63d2\u4ef6\uff0c\u6bd4\u5982 Calico \u9879\u76ee\uff0c\u6765\u8d1f\u8d23\u6267\u884c NetworkPolicy\u3002\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u662f Flannel \u7f51\u7edc\u63d2\u4ef6\uff0c\u6240\u4ee5\u9996\u5148\u9700\u8981\u5b89\u88c5 Calico \u6765\u8d1f\u8d23\u7f51\u7edc\u7b56\u7565\u3002</p>"},{"location":"kubernetes_network/policy/#calico","title":"\u5b89\u88c5 Calico","text":"<p>\u9996\u5148\u786e\u5b9a kube-controller-manager \u914d\u7f6e\u4e86\u5982\u4e0b\u7684\u4e24\u4e2a\u53c2\u6570\uff1a</p> <pre><code>......\nspec:\n  containers:\n  - command:\n    - kube-controller-manager\n    - --allocate-node-cidrs=true\n    - --cluster-cidr=20/16\n......\n</code></pre> <p>\u7136\u540e\u4e0b\u8f7d\u9700\u8981\u4f7f\u7528\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff1a</p> <pre><code>$ curl https://docs.projectcalico.org/v10/manifests/canal.yaml -O\n</code></pre> <p>\u5982\u679c\u4e4b\u524d\u914d\u7f6e\u7684 pod CIDR \u5c31\u662f <code>10.244.0.0/16</code> \u7f51\u6bb5\uff0c\u5219\u53ef\u4ee5\u8df3\u8fc7\u4e0b\u9762\u7684\u914d\u7f6e\uff0c\u5982\u679c\u4e0d\u540c\u5219\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u65b9\u5f0f\u8fdb\u884c\u66ff\u6362\uff1a</p> <pre><code>$ POD_CIDR=\"&lt;your-pod-cidr&gt;\" \\\\\n$ sed -i -e \"s?20/16?$POD_CIDR?g\" canal.yaml\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u5b89\u88c5\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f canal.yaml\n</code></pre>"},{"location":"kubernetes_network/policy/#_1","title":"\u7f51\u7edc\u7b56\u7565","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b Pod \u662f\u53ef\u4ee5\u63a5\u6536\u6765\u81ea\u4efb\u4f55\u53d1\u9001\u65b9\u7684\u8bf7\u6c42\uff0c\u4e5f\u53ef\u4ee5\u5411\u4efb\u4f55\u63a5\u6536\u65b9\u53d1\u9001\u8bf7\u6c42\u3002\u800c\u5982\u679c\u6211\u4eec\u8981\u5bf9\u8fd9\u4e2a\u60c5\u51b5\u4f5c\u51fa\u9650\u5236\uff0c\u5c31\u5fc5\u987b\u901a\u8fc7 <code>NetworkPolicy</code> \u5bf9\u8c61\u6765\u6307\u5b9a\u3002</p> <p>\u5982\u4e0b\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u6240\u793a\uff0c\u6211\u4eec\u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a\u7f51\u7edc\u7b56\u7565\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff1a(test-networkpolicy.yaml)</p> <pre><code>apiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: test-network-policy\n  namespace: default\nspec:\n  podSelector:\n    matchLabels:\n      role: db\n  policyTypes:\n  - Ingress\n  - Egress\n  ingress:\n  - from:\n    - ipBlock:\n        cidr: 10/16\n        except:\n        - 10/24\n    - namespaceSelector:\n        matchLabels:\n          project: myproject\n    - podSelector:\n        matchLabels:\n          role: frontend\n  - ports:\n    - protocol: TCP\n      port: 80\n  egress:\n  - to:\n    - ipBlock:\n        cidr: 0/24\n    ports:\n    - protocol: TCP\n      port: 5978\n</code></pre> <p>\u4e0e\u6240\u6709\u5176\u4ed6\u7684 Kubernetes \u8d44\u6e90\u5bf9\u8c61\u4e00\u6837\uff0cNetworkPolicy \u9700\u8981 <code>apiVersion</code>\u3001<code>kind</code> \u548c <code>metadata</code> \u5b57\u6bb5\uff0c\u6211\u4eec\u901a\u8fc7 <code>spec.podSelector</code> \u5b57\u6bb5\u5b9a\u4e49\u8fd9\u4e2a NetworkPolicy \u7684\u9650\u5236\u8303\u56f4\uff0c\u56e0\u4e3a NetworkPolicy \u76ee\u524d\u53ea\u652f\u6301\u5b9a\u4e49 <code>ingress</code> \u89c4\u5219\uff0c\u6240\u4ee5\u8fd9\u91cc\u7684 <code>podSelector</code> \u672c\u8d28\u4e0a\u662f\u4e3a\u8be5\u7b56\u7565\u5b9a\u4e49 \u76ee\u6807pod, \u6bd4\u5982\u6211\u4eec\u8fd9\u91cc <code>matchLabels:role=db</code> \u8868\u793a\u7684\u5c31\u662f\u5f53\u524d Namespace \u91cc\u643a\u5e26\u4e86 <code>role=db</code> \u6807\u7b7e\u7684 Pod\u3002\u800c\u5982\u679c\u4f60\u628a <code>podSelector</code> \u5b57\u6bb5\u7559\u7a7a\uff1a</p> <pre><code>spec: \n  podSelector: {}\n</code></pre> <p>\u90a3\u4e48\u8fd9\u4e2a NetworkPolicy \u5c31\u4f1a\u4f5c\u7528\u4e8e\u5f53\u524d Namespace \u4e0b\u7684\u6240\u6709 Pod\u3002</p> <p>\u7136\u540e\u6bcf\u4e2a NetworkPolicy \u5305\u542b\u4e00\u4e2a <code>policyTypes</code> \u5217\u8868\uff0c\u53ef\u4ee5\u662f\u4e00\u4e2a <code>Ingress</code>\u3001<code>Egress</code> \u6216\u8005\u90fd\u5305\u542b\uff0c\u8be5\u5b57\u6bb5\u8868\u793a\u7ed9\u5f53\u524d\u7b56\u7565\u662f\u5426\u5e94\u7528\u4e8e\u6240\u5339\u914d\u7684 Pod \u7684\u5165\u53e3\u6d41\u91cf\u3001\u51fa\u53e3\u6d41\u91cf\u6216\u8005\u4e8c\u8005\u90fd\u5305\u542b\uff0c\u5982\u679c\u6ca1\u6709\u6307\u5b9a <code>policyTypes</code>\uff0c\u5219\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u8868\u793a <code>Ingress</code> \u5165\u53e3\u6d41\u91cf\uff0c\u5982\u679c\u914d\u7f6e\u4e86\u4efb\u4f55\u51fa\u53e3\u6d41\u91cf\u89c4\u5219\uff0c\u5219\u5c06\u6307\u5b9a\u4e3a <code>Egress</code>\u3002</p> <p>\u89c4\u5219</p> <p>\u4e00\u65e6 Pod \u88ab NetworkPolicy \u9009\u4e2d\uff0c\u90a3\u4e48\u8fd9\u4e2a Pod \u5c31\u4f1a\u8fdb\u5165<code>\u62d2\u7edd\u6240\u6709\uff08Deny All\uff09</code>\u7684\u72b6\u6001\uff0c\u5373\u8fd9\u4e2a Pod \u65e2\u4e0d\u5141\u8bb8\u88ab\u5916\u754c\u8bbf\u95ee\uff0c\u4e5f\u4e0d\u5141\u8bb8\u5bf9\u5916\u754c\u53d1\u8d77\u8bbf\u95ee\uff0c\u6240\u4ee5 NetworkPolicy \u5b9a\u4e49\u7684\u89c4\u5219\uff0c\u5176\u5b9e\u5c31\u662f\u767d\u540d\u5355\u4e86\u3002</p> <p>\u6bd4\u5982\u4e0a\u9762\u793a\u4f8b\u8868\u793a\u7684\u662f\u8be5\u9694\u79bb\u89c4\u5219\u53ea\u5bf9 default \u547d\u540d\u7a7a\u95f4\u4e0b\u7684\uff0c\u643a\u5e26\u4e86 <code>role=db</code> \u6807\u7b7e\u7684 Pod \u6709\u6548\u3002\u9650\u5236\u7684\u8bf7\u6c42\u7c7b\u578b\u5305\u62ec ingress\uff08\u6d41\u5165\uff09\u548c egress\uff08\u6d41\u51fa\uff09\u3002</p> <p><code>ingress</code>: \u6bcf\u4e2a NetworkPolicy \u5305\u542b\u4e00\u4e2a ingress \u89c4\u5219\u7684\u767d\u540d\u5355\u5217\u8868\u3002\u5176\u4e2d\u7684\u89c4\u5219\u5141\u8bb8\u540c\u65f6\u5339\u914d <code>from</code> \u548c <code>ports</code> \u90e8\u5206\u7684\u6d41\u91cf\u3002\u6bd4\u5982\u4e0a\u9762\u793a\u4f8b\u4e2d\u6211\u4eec\u914d\u7f6e\u7684\u5165\u53e3\u6d41\u91cf\u89c4\u5219\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>ingress:\n  - from:\n    - ipBlock:\n        cidr: 10/16\n        except:\n        - 10/24\n    - namespaceSelector:\n        matchLabels:\n          project: myproject\n    - podSelector:\n        matchLabels:\n          role: frontend\n  - ports:\n    - protocol: TCP\n      port: 80\n</code></pre> <p>\u8fd9\u91cc\u7684 ingress \u89c4\u5219\u4e2d\u6211\u4eec\u5b9a\u4e49\u4e86 <code>from</code> \u548c <code>ports</code>\uff0c\u8868\u793a\u5141\u8bb8\u6d41\u5165\u7684<code>\u767d\u540d\u5355</code>\u548c\u7aef\u53e3\uff0c\u4e0a\u9762\u6211\u4eec\u4e5f\u8bf4\u4e86 Kubernetes \u4f1a\u62d2\u7edd\u4efb\u4f55\u8bbf\u95ee\u88ab\u9694\u79bb Pod \u7684\u8bf7\u6c42\uff0c\u9664\u975e\u8fd9\u4e2a\u8bf7\u6c42\u6765\u81ea\u4e8e\u4ee5\u4e0b\u767d\u540d\u5355\u91cc\u7684\u5bf9\u8c61\uff0c\u5e76\u4e14\u8bbf\u95ee\u7684\u662f\u88ab\u9694\u79bb Pod \u7684 8- \u7aef\u53e3\u3002\u800c\u8fd9\u4e2a\u5141\u8bb8\u6d41\u5165\u7684<code>\u767d\u540d\u5355</code>\u4e2d\u6307\u5b9a\u4e86\u4e09\u79cd\u5e76\u5217\u7684\u60c5\u51b5\uff0c\u5206\u522b\u662f\uff1a<code>ipBlock</code>\u3001<code>namespaceSelector</code> \u548c <code>podSelector</code>\uff1a</p> <ul> <li>default \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u5e26\u6709 <code>role=frontend</code> \u6807\u7b7e\u7684 Pod</li> <li>\u5e26\u6709 <code>project=myproject</code> \u6807\u7b7e\u7684 Namespace \u4e0b\u7684\u4efb\u4f55 Pod</li> <li>\u4efb\u4f55\u6e90\u5730\u5740\u5c5e\u4e8e <code>172.17.0.0/16</code> \u7f51\u6bb5\uff0c\u4e14\u4e0d\u5c5e\u4e8e <code>172.17.1.0/24</code> \u7f51\u6bb5\u7684\u8bf7\u6c42\u3002</li> </ul> <p><code>egress</code>: \u6bcf\u4e2a NetworkPolicy \u5305\u542b\u4e00\u4e2a egress \u89c4\u5219\u7684\u767d\u540d\u5355\u5217\u8868\u3002\u6bcf\u4e2a\u89c4\u5219\u90fd\u5141\u8bb8\u5339\u914d <code>to</code> \u548c <code>port</code> \u90e8\u5206\u7684\u6d41\u91cf\u3002\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u793a\u4f8b\u89c4\u5219\u7684\u914d\u7f6e\uff1a</p> <pre><code>egress:\n  - to:\n    - ipBlock:\n        cidr: 0/24\n    ports:\n    - protocol: TCP\n      port: 5978\n</code></pre> <p>\u8868\u793a Kubernetes \u4f1a\u62d2\u7edd\u88ab\u9694\u79bb Pod \u5bf9\u5916\u53d1\u8d77\u4efb\u4f55\u8bf7\u6c42\uff0c\u9664\u975e\u8bf7\u6c42\u7684\u76ee\u7684\u5730\u5740\u5c5e\u4e8e <code>10.0.0.0/24</code> \u7f51\u6bb5\uff0c\u5e76\u4e14\u8bbf\u95ee\u7684\u662f\u8be5\u7f51\u6bb5\u5730\u5740\u7684 <code>5978</code> \u7aef\u53e3\u3002</p>"},{"location":"kubernetes_network/policy/#_2","title":"\u6d4b\u8bd5","text":"<p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u521b\u5efa\u4e00\u4e2a Pod\uff0c\u5e26\u6709 <code>role=db</code> \u7684 Label \u6807\u7b7e\uff1a(test-networkpolicy-pod.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: test-networkpolicy\n  labels:\n    role: db\nspec:\n  containers:\n  - name: testnp\n    image: nginx\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a Pod\uff1a</p> <pre><code>$ kubectl apply -f test-networkpolicy-pod.yaml\n$ kubectl get pods -o wide\nNAME                        READY   STATUS    RESTARTS   AGE     IP             NODE         NOMINATED NODE   READINESS GATES\npod-a                       1/1     Running   4          4h3m    2236   ydzs-node1   &lt;none&gt;           &lt;none&gt;\npod-b                       1/1     Running   4          4h3m    2123   ydzs-node2   &lt;none&gt;           &lt;none&gt;\ntest-networkpolicy          1/1     Running   0          4m49s   22     ydzs-node3   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u7528\u4e00\u4e2a\u5df2\u7ecf\u5b58\u5728\u7684 Pod \u6765\u5bf9\u8fd9\u4e2a Pod \u53d1\u8d77\u4e00\u4e2a\u7f51\u7edc\u8bf7\u6c42\uff1a</p> <pre><code>$ kubectl exec pod-a wget 22\nConnecting to 22 (22:80)\nsaving to 'index.html'\nindex.html           100% |********************************|   612  0:00:00 ETA\n'index.html' saved\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u53ef\u4ee5\u6210\u529f\u8bf7\u6c42\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u6765\u521b\u5efa\u4e0a\u9762\u7684 NetworkPolicy \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f test-networkpolicy.yaml\nnetworkpolicy.networking.k8s.io/test-network-policy created\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2a\u7f51\u7edc\u7b56\u7565\uff0c\u7531\u4e8e\u5339\u914d\u4e86\u7f51\u7edc\u7b56\u7565\u7684\u5c31\u4f1a\u62d2\u7edd\u6240\u6709\u7684\u7f51\u7edc\u8bf7\u6c42\uff0c\u9700\u8981\u901a\u8fc7\u767d\u540d\u5355\u6765\u8fdb\u884c\u5f00\u542f\u8bf7\u6c42\uff0c\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u7684\u6d4b\u8bd5 Pod \u660e\u663e\u6ca1\u6709\u5728\u767d\u540d\u5355\u4e4b\u4e2d\uff0c\u6240\u4ee5\u5c31\u4f1a\u62d2\u7edd\u7f51\u7edc\u8bf7\u6c42\u4e86\uff1a</p> <pre><code>$ kubectl exec pod-a wget 22\nConnecting to 22 (22:80)\n# \u8bf7\u6c42\u4f1a\u4e00\u76f4 hang \u4f4f\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u7528 NetworkPolicy \u767d\u540d\u5355\u91cc\u9762\u5339\u914d\u7684 Pod \u6765\u5bf9\u4e0a\u9762\u7684 Pod \u53d1\u8d77\u7f51\u7edc\u8bf7\u6c42\uff0c\u6bd4\u5982\u5728\u5e26\u6709\u6807\u7b7e <code>project=myproject</code> \u7684 Namespace \u4e0b\u9762\u7684 Pod \u6765\u53d1\u8d77\u7f51\u7edc\u8bf7\u6c42\uff0c\u6216\u8005\u7ed9 pod-a \u52a0\u4e0a\u4e00\u4e2a <code>role=frontend</code> \u7684\u6807\u7b7e\uff1a</p> <pre><code>$ kubectl label pod pod-a role=frontend\npod/pod-a labeled\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u91cd\u65b0\u53d1\u8d77\u4e00\u4e2a\u7f51\u7edc\u8bf7\u6c42\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u53ef\u4ee5\u6210\u529f\u4e86\uff0c\u56e0\u4e3a\u6211\u4eec\u8bbf\u95ee\u7684 Pod \u8fdb\u7a0b\u9ed8\u8ba4\u7684\u7aef\u53e3\u5c31\u662f 80 \u7aef\u53e3\uff0c\u662f\u5339\u914d\u767d\u540d\u5355\u7684\uff1a</p> <pre><code>$ kubectl exec pod-a -- wget 22 -O-\nConnecting to 22 (22:80)\nwriting to stdout\n-                    100% |********************************|   612  0:00:00 ETA\nwritten to stdout\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n    body {\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    }\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u6210\u529f\u4e86\uff0cKubernetes \u7684 NetworkPolicy \u5b9e\u73b0\u4e86\u8bbf\u95ee\u63a7\u5236\uff0c\u4f9d\u8d56\u7684\u5e95\u5c42\u662f\u4f9d\u9760\u7f51\u7edc\u63d2\u4ef6\u6dfb\u52a0 iptables \u89c4\u5219\u6765\u8fdb\u884c\u63a7\u5236\u7684\uff0c\u4f46\u662f\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u90fd\u9700\u8981\u914d\u7f6e\u5927\u91cf iptables \u89c4\u5219\uff0c\u52a0\u4e0a\u4e0d\u540c\u7ef4\u5ea6\u63a7\u5236\u7684\u589e\u52a0\uff0c\u5bfc\u81f4\u8fd0\u7ef4\u3001\u6392\u969c\u96be\u5ea6\u8f83\u5927\uff0c\u6240\u4ee5\u5982\u679c\u4e0d\u662f\u7279\u522b\u9700\u8981\u7684\u573a\u666f\uff0c\u6700\u597d\u4e0d\u8981\u4f7f\u7528\u4e86\u3002</p>"},{"location":"kubernetes_network/service/","title":"Service \u670d\u52a1","text":"<p>\ue3c9</p>"},{"location":"kubernetes_network/service/#service","title":"Service","text":"<p>\u6211\u4eec\u524d\u9762\u7684\u8bfe\u7a0b\u4e2d\u5b66\u4e60\u4e86\u4e00\u4e9b\u5e38\u7528\u63a7\u5236\u5668\u7684\u57fa\u672c\u7528\u6cd5\uff0c\u6211\u4eec\u4e5f\u4e86\u89e3\u5230 Pod \u7684\u751f\u547d\u662f\u6709\u9650\u7684\uff0c\u6b7b\u4ea1\u8fc7\u540e\u4e0d\u4f1a\u590d\u6d3b\u4e86\u3002\u7136\u540e\u6211\u4eec\u77e5\u9053\u53ef\u4ee5\u7528 ReplicaSet \u548cDeployment \u6765\u52a8\u6001\u7684\u521b\u5efa\u548c\u9500\u6bc1 Pod\uff0c\u6bcf\u4e2a Pod \u90fd\u6709\u81ea\u5df1\u7684 IP \u5730\u5740\uff0c\u4f46\u662f\u5982\u679c Pod \u91cd\u5efa\u4e86\u7684\u8bdd\u90a3\u4e48\u4ed6\u7684 IP \u5f88\u6709\u53ef\u80fd\u4e5f\u5c31\u53d8\u5316\u4e86\u3002\u8fd9\u5c31\u4f1a\u5e26\u6765\u4e00\u4e2a\u95ee\u9898\uff1a\u6bd4\u5982\u6211\u4eec\u6709\u4e00\u4e9b\u540e\u7aef\u7684 Pod \u96c6\u5408\u4e3a\u96c6\u7fa4\u4e2d\u7684\u5176\u4ed6\u5e94\u7528\u63d0\u4f9b API \u670d\u52a1\uff0c\u5982\u679c\u6211\u4eec\u5728\u524d\u7aef\u5e94\u7528\u4e2d\u628a\u6240\u6709\u7684\u8fd9\u4e9b\u540e\u7aef\u7684 Pod \u7684\u5730\u5740\u90fd\u5199\u6b7b\uff0c\u7136\u540e\u4ee5\u67d0\u79cd\u65b9\u5f0f\u53bb\u8bbf\u95ee\u5176\u4e2d\u4e00\u4e2a Pod \u7684\u670d\u52a1\uff0c\u8fd9\u6837\u770b\u4e0a\u53bb\u662f\u53ef\u4ee5\u5de5\u4f5c\u7684\uff0c\u5bf9\u5427\uff1f\u4f46\u662f\u5982\u679c\u8fd9\u4e2a Pod \u6302\u6389\u4e86\uff0c\u7136\u540e\u91cd\u65b0\u542f\u52a8\u8d77\u6765\u4e86\uff0c\u662f\u4e0d\u662f IP \u5730\u5740\u975e\u5e38\u6709\u53ef\u80fd\u5c31\u53d8\u4e86\uff0c\u8fd9\u4e2a\u65f6\u5019\u524d\u7aef\u5c31\u6781\u5927\u53ef\u80fd\u8bbf\u95ee\u4e0d\u5230\u540e\u7aef\u7684\u670d\u52a1\u4e86\u3002</p> <p>\u9047\u5230\u8fd9\u6837\u7684\u95ee\u9898\u8be5\u600e\u4e48\u89e3\u51b3\u5462\uff1f\u5728\u6ca1\u6709\u4f7f\u7528 Kubernetes \u4e4b\u524d\uff0c\u6211\u76f8\u4fe1\u53ef\u80fd\u5f88\u591a\u540c\u5b66\u90fd\u9047\u5230\u8fc7\u8fd9\u6837\u7684\u95ee\u9898\uff0c\u4e0d\u4e00\u5b9a\u662f IP \u53d8\u5316\u7684\u95ee\u9898\uff0c\u6bd4\u5982\u6211\u4eec\u5728\u90e8\u7f72\u4e00\u4e2aWEB \u670d\u52a1\u7684\u65f6\u5019\uff0c\u524d\u7aef\u4e00\u822c\u90e8\u7f72\u4e00\u4e2a Nginx \u4f5c\u4e3a\u670d\u52a1\u7684\u5165\u53e3\uff0c\u7136\u540e Nginx \u540e\u9762\u80af\u5b9a\u5c31\u662f\u6302\u8f7d\u7684\u8fd9\u4e2a\u670d\u52a1\u7684\u5927\u91cf\u540e\u7aef\u670d\u52a1\uff0c\u5f88\u65e9\u4ee5\u524d\u6211\u4eec\u53ef\u80fd\u662f\u53bb\u624b\u52a8\u66f4\u6539Nginx \u914d\u7f6e\u4e2d\u7684 upstream \u9009\u9879\uff0c\u6765\u52a8\u6001\u6539\u53d8\u63d0\u4f9b\u670d\u52a1\u7684\u6570\u91cf\uff0c\u5230\u540e\u9762\u51fa\u73b0\u4e86\u4e00\u4e9b\u670d\u52a1\u53d1\u73b0\u7684\u5de5\u5177\uff0c\u6bd4\u5982 Consul\u3001ZooKeeper \u8fd8\u6709\u6211\u4eec\u719f\u6089\u7684 etcd \u7b49\u5de5\u5177\uff0c\u6709\u4e86\u8fd9\u4e9b\u5de5\u5177\u8fc7\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u53ea\u9700\u8981\u628a\u6211\u4eec\u7684\u670d\u52a1\u6ce8\u518c\u5230\u8fd9\u4e9b\u670d\u52a1\u53d1\u73b0\u4e2d\u5fc3\u53bb\u5c31\u53ef\u4ee5\uff0c\u7136\u540e\u8ba9\u8fd9\u4e9b\u5de5\u5177\u52a8\u6001\u7684\u53bb\u66f4\u65b0 Nginx \u7684\u914d\u7f6e\u5c31\u53ef\u4ee5\u4e86\uff0c\u6211\u4eec\u5b8c\u5168\u4e0d\u7528\u53bb\u624b\u5de5\u7684\u64cd\u4f5c\u4e86\uff0c\u662f\u4e0d\u662f\u975e\u5e38\u65b9\u4fbf\u3002</p> <p></p> <p>\u540c\u6837\u7684\uff0c\u8981\u89e3\u51b3\u6211\u4eec\u4e0a\u9762\u9047\u5230\u7684\u95ee\u9898\u662f\u4e0d\u662f\u5b9e\u73b0\u4e00\u4e2a\u670d\u52a1\u53d1\u73b0\u7684\u5de5\u5177\u4e5f\u53ef\u4ee5\u89e3\u51b3\uff1f\u6ca1\u9519\u7684\uff0c\u5f53\u6211\u4eec Pod \u88ab\u9500\u6bc1\u6216\u8005\u65b0\u5efa\u8fc7\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u8fd9\u4e2a Pod \u7684\u5730\u5740\u6ce8\u518c\u5230\u8fd9\u4e2a\u670d\u52a1\u53d1\u73b0\u4e2d\u5fc3\u53bb\u5c31\u53ef\u4ee5\uff0c\u4f46\u662f\u8fd9\u6837\u7684\u8bdd\u6211\u4eec\u7684\u524d\u7aef\u5e94\u7528\u5c31\u4e0d\u80fd\u76f4\u63a5\u53bb\u8fde\u63a5\u540e\u53f0\u7684 Pod \u96c6\u5408\u4e86\uff0c\u5e94\u8be5\u8fde\u63a5\u5230\u4e00\u4e2a\u80fd\u591f\u505a\u670d\u52a1\u53d1\u73b0\u7684\u4e2d\u95f4\u4ef6\u4e0a\u9762\uff0c\u5bf9\u5427\uff1f</p> <p>\u4e3a\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898 Kubernetes \u5c31\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u8fd9\u6837\u7684\u4e00\u4e2a\u5bf9\u8c61 - Service\uff0cService \u662f\u4e00\u79cd\u62bd\u8c61\u7684\u5bf9\u8c61\uff0c\u5b83\u5b9a\u4e49\u4e86\u4e00\u7ec4 Pod \u7684\u903b\u8f91\u96c6\u5408\u548c\u4e00\u4e2a\u7528\u4e8e\u8bbf\u95ee\u5b83\u4eec\u7684\u7b56\u7565\uff0c\u5176\u5b9e\u8fd9\u4e2a\u6982\u5ff5\u548c\u5fae\u670d\u52a1\u975e\u5e38\u7c7b\u4f3c\u3002\u4e00\u4e2a Serivce \u4e0b\u9762\u5305\u542b\u7684 Pod \u96c6\u5408\u662f\u7531 Label Selector \u6765\u51b3\u5b9a\u7684\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u4e0a\u9762\u7684\u4f8b\u5b50\uff0c\u5047\u5982\u6211\u4eec\u540e\u7aef\u8fd0\u884c\u4e863\u4e2a\u526f\u672c\uff0c\u8fd9\u4e9b\u526f\u672c\u90fd\u662f\u53ef\u4ee5\u66ff\u4ee3\u7684\uff0c\u56e0\u4e3a\u524d\u7aef\u5e76\u4e0d\u5173\u5fc3\u5b83\u4eec\u4f7f\u7528\u7684\u662f\u54ea\u4e00\u4e2a\u540e\u7aef\u670d\u52a1\u3002\u5c3d\u7ba1\u7531\u4e8e\u5404\u79cd\u539f\u56e0\u540e\u7aef\u7684 Pod \u96c6\u5408\u4f1a\u53d1\u9001\u53d8\u5316\uff0c\u4f46\u662f\u524d\u7aef\u5374\u4e0d\u9700\u8981\u77e5\u9053\u8fd9\u4e9b\u53d8\u5316\uff0c\u4e5f\u4e0d\u9700\u8981\u81ea\u5df1\u7528\u4e00\u4e2a\u5217\u8868\u6765\u8bb0\u5f55\u8fd9\u4e9b\u540e\u7aef\u7684\u670d\u52a1\uff0cService \u7684\u8fd9\u79cd\u62bd\u8c61\u5c31\u53ef\u4ee5\u5e2e\u6211\u4eec\u8fbe\u5230\u8fd9\u79cd\u89e3\u8026\u7684\u76ee\u7684\u3002</p>"},{"location":"kubernetes_network/service/#ip","title":"\u4e09\u79cdIP","text":"<p>\u5728\u7ee7\u7eed\u5f80\u4e0b\u5b66\u4e60 Service \u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u5148\u5f04\u660e\u767d Kubernetes \u7cfb\u7edf\u4e2d\u7684\u4e09\u79cdIP\uff0c\u56e0\u4e3a\u7ecf\u5e38\u6709\u540c\u5b66\u6df7\u4e71\u3002</p> <ul> <li>Node IP\uff1aNode \u8282\u70b9\u7684 IP \u5730\u5740</li> <li>Pod IP: Pod \u7684 IP \u5730\u5740</li> <li>Cluster IP: Service \u7684 IP \u5730\u5740</li> </ul> <p>\u9996\u5148\uff0cNode IP \u662f Kubernetes \u96c6\u7fa4\u4e2d\u8282\u70b9\u7684\u7269\u7406\u7f51\u5361 IP \u5730\u5740(\u4e00\u822c\u4e3a\u5185\u7f51)\uff0c\u6240\u6709\u5c5e\u4e8e\u8fd9\u4e2a\u7f51\u7edc\u7684\u670d\u52a1\u5668\u4e4b\u95f4\u90fd\u53ef\u4ee5\u76f4\u63a5\u901a\u4fe1\uff0c\u6240\u4ee5 Kubernetes \u96c6\u7fa4\u5916\u8981\u60f3\u8bbf\u95ee Kubernetes \u96c6\u7fa4\u5185\u90e8\u7684\u67d0\u4e2a\u8282\u70b9\u6216\u8005\u670d\u52a1\uff0c\u80af\u5b9a\u5f97\u901a\u8fc7 Node IP \u8fdb\u884c\u901a\u4fe1\uff08\u8fd9\u4e2a\u65f6\u5019\u4e00\u822c\u662f\u901a\u8fc7\u5916\u7f51 IP \u4e86\uff09</p> <p>\u7136\u540e Pod IP \u662f\u6bcf\u4e2a Pod \u7684 IP \u5730\u5740\uff0c\u5b83\u662f\u7f51\u7edc\u63d2\u4ef6\u8fdb\u884c\u5206\u914d\u7684\uff0c\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u8bb2\u89e3\u8fc7</p> <p>\u6700\u540e Cluster IP \u662f\u4e00\u4e2a\u865a\u62df\u7684 IP\uff0c\u4ec5\u4ec5\u4f5c\u7528\u4e8e Kubernetes Service \u8fd9\u4e2a\u5bf9\u8c61\uff0c\u7531 Kubernetes \u81ea\u5df1\u6765\u8fdb\u884c\u7ba1\u7406\u548c\u5206\u914d\u5730\u5740\u3002</p>"},{"location":"kubernetes_network/service/#service_1","title":"\u5b9a\u4e49 Service","text":"<p>\u5b9a\u4e49 Service \u7684\u65b9\u5f0f\u548c\u6211\u4eec\u524d\u9762\u5b9a\u4e49\u7684\u5404\u79cd\u8d44\u6e90\u5bf9\u8c61\u7684\u65b9\u5f0f\u7c7b\u578b\uff0c\u4f8b\u5982\uff0c\u5047\u5b9a\u6211\u4eec\u6709\u4e00\u7ec4 Pod \u670d\u52a1\uff0c\u5b83\u4eec\u5bf9\u5916\u66b4\u9732\u4e86 8080 \u7aef\u53e3\uff0c\u540c\u65f6\u90fd\u88ab\u6253\u4e0a\u4e86 app=myapp \u8fd9\u6837\u7684\u6807\u7b7e\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u53ef\u4ee5\u50cf\u4e0b\u9762\u8fd9\u6837\u6765\u5b9a\u4e49\u4e00\u4e2a Service \u5bf9\u8c61\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: myservice\nspec:\n  selector:\n    app: myapp\n  ports:\n  - protocol: TCP\n    port: 80\n    targetPort: 8080\n    name: myapp-http\n</code></pre> <p>\u7136\u540e\u901a\u8fc7\u7684\u4f7f\u7528 </p> <pre><code>kubectl create -f myservice.yaml\n</code></pre> <p>\u5c31\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a myservice \u7684 Service \u5bf9\u8c61\uff0c\u5b83\u4f1a\u5c06\u8bf7\u6c42\u4ee3\u7406\u5230\u4f7f\u7528 TCP \u7aef\u53e3\u4e3a 8080\uff0c\u5177\u6709\u6807\u7b7e <code>app=myapp</code> \u7684 Pod \u4e0a\uff0c\u8fd9\u4e2a Service \u4f1a\u88ab\u7cfb\u7edf\u5206\u914d\u4e00\u4e2a\u6211\u4eec\u4e0a\u9762\u8bf4\u7684 Cluster IP\uff0c\u8be5 Service \u8fd8\u4f1a\u6301\u7eed\u7684\u76d1\u542c selector \u4e0b\u9762\u7684 Pod\uff0c\u4f1a\u628a\u8fd9\u4e9b Pod \u4fe1\u606f\u66f4\u65b0\u5230\u4e00\u4e2a\u540d\u4e3a myservice \u7684Endpoints \u5bf9\u8c61\u4e0a\u53bb\uff0c\u8fd9\u4e2a\u5bf9\u8c61\u5c31\u7c7b\u4f3c\u4e8e\u6211\u4eec\u4e0a\u9762\u8bf4\u7684 Pod \u96c6\u5408\u4e86\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cService \u80fd\u591f\u5c06\u4e00\u4e2a\u63a5\u6536\u7aef\u53e3\u6620\u5c04\u5230\u4efb\u610f\u7684 targetPort\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0ctargetPort \u5c06\u88ab\u8bbe\u7f6e\u4e3a\u4e0e port \u5b57\u6bb5\u76f8\u540c\u7684\u503c\u3002\u53ef\u80fd\u66f4\u6709\u8da3\u7684\u662f\uff0ctargetPort \u53ef\u4ee5\u662f\u4e00\u4e2a\u5b57\u7b26\u4e32\uff0c\u5f15\u7528\u4e86 backend Pod \u7684\u4e00\u4e2a\u7aef\u53e3\u7684\u540d\u79f0\u3002\u56e0\u5b9e\u9645\u6307\u6d3e\u7ed9\u8be5\u7aef\u53e3\u540d\u79f0\u7684\u7aef\u53e3\u53f7\uff0c\u5728\u6bcf\u4e2a backend Pod \u4e2d\u53ef\u80fd\u5e76\u4e0d\u76f8\u540c\uff0c\u6240\u4ee5\u5bf9\u4e8e\u90e8\u7f72\u548c\u8bbe\u8ba1 Service\uff0c\u8fd9\u79cd\u65b9\u5f0f\u4f1a\u63d0\u4f9b\u66f4\u5927\u7684\u7075\u6d3b\u6027\u3002</p> <p>\u53e6\u5916 Service \u80fd\u591f\u652f\u6301 TCP \u548c UDP \u534f\u8bae\uff0c\u9ed8\u8ba4\u662f TCP \u534f\u8bae\u3002</p>"},{"location":"kubernetes_network/service/#kube-proxy","title":"kube-proxy","text":"<p>\u524d\u9762\u6211\u4eec\u8bb2\u5230\u8fc7\uff0c\u5728 Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u6bcf\u4e2a Node \u4f1a\u8fd0\u884c\u4e00\u4e2a kube-proxy \u8fdb\u7a0b, \u8d1f\u8d23\u4e3a Service \u5b9e\u73b0\u4e00\u79cd VIP\uff08\u865a\u62df IP\uff0c\u5c31\u662f\u6211\u4eec\u4e0a\u9762\u8bf4\u7684 clusterIP\uff09\u7684\u4ee3\u7406\u5f62\u5f0f\uff0c\u73b0\u5728\u7684 Kubernetes \u4e2d\u9ed8\u8ba4\u662f\u4f7f\u7528\u7684 iptables \u8fd9\u79cd\u6a21\u5f0f\u6765\u4ee3\u7406\u3002</p>"},{"location":"kubernetes_network/service/#iptables","title":"iptables","text":"<p>\u8fd9\u79cd\u6a21\u5f0f\uff0ckube-proxy \u4f1a\u76d1\u89c6 apiserver \u5bf9 Service \u5bf9\u8c61\u548c Endpoints \u5bf9\u8c61\u7684\u6dfb\u52a0\u548c\u79fb\u9664\u3002\u5bf9\u6bcf\u4e2a Service\uff0c\u5b83\u4f1a\u6dfb\u52a0\u4e0a iptables \u89c4\u5219\uff0c\u4ece\u800c\u6355\u83b7\u5230\u8fbe\u8be5 Service \u7684 clusterIP\uff08\u865a\u62df IP\uff09\u548c\u7aef\u53e3\u7684\u8bf7\u6c42\uff0c\u8fdb\u800c\u5c06\u8bf7\u6c42\u91cd\u5b9a\u5411\u5230 Service \u7684\u4e00\u7ec4 backend \u4e2d\u7684\u67d0\u4e00\u4e2a Pod \u4e0a\u9762\u3002\u6211\u4eec\u8fd8\u53ef\u4ee5\u4f7f\u7528 <code>Pod readiness \u63a2\u9488</code> \u9a8c\u8bc1\u540e\u7aef Pod \u53ef\u4ee5\u6b63\u5e38\u5de5\u4f5c\uff0c\u4ee5\u4fbf iptables \u6a21\u5f0f\u4e0b\u7684 kube-proxy \u4ec5\u770b\u5230\u6d4b\u8bd5\u6b63\u5e38\u7684\u540e\u7aef\uff0c\u8fd9\u6837\u505a\u610f\u5473\u7740\u53ef\u4ee5\u907f\u514d\u5c06\u6d41\u91cf\u901a\u8fc7 <code>kube-proxy</code> \u53d1\u9001\u5230\u5df2\u77e5\u5931\u8d25\u7684 Pod \u4e2d\uff0c\u6240\u4ee5\u5bf9\u4e8e\u7ebf\u4e0a\u7684\u5e94\u7528\u6765\u8bf4\u4e00\u5b9a\u8981\u505a readiness \u63a2\u9488\u3002</p> <p></p> <p>iptables \u6a21\u5f0f\u7684 kube-proxy \u9ed8\u8ba4\u7684\u7b56\u7565\u662f\uff0c\u968f\u673a\u9009\u62e9\u4e00\u4e2a\u540e\u7aef Pod\u3002</p> <p>\u6bd4\u5982\u5f53\u521b\u5efa backend Service \u65f6\uff0cKubernetes \u4f1a\u7ed9\u5b83\u6307\u6d3e\u4e00\u4e2a\u865a\u62df IP \u5730\u5740\uff0c\u6bd4\u5982 10.0.0.1\u3002\u5047\u8bbe Service \u7684\u7aef\u53e3\u662f 1234\uff0c\u8be5 Service \u4f1a\u88ab\u96c6\u7fa4\u4e2d\u6240\u6709\u7684 kube-proxy \u5b9e\u4f8b\u89c2\u5bdf\u5230\u3002\u5f53 kube-proxy \u770b\u5230\u4e00\u4e2a\u65b0\u7684 Service\uff0c\u5b83\u4f1a\u5b89\u88c5\u4e00\u7cfb\u5217\u7684 iptables \u89c4\u5219\uff0c\u4ece VIP \u91cd\u5b9a\u5411\u5230 <code>per-Service</code> \u89c4\u5219\u3002 \u8be5 <code>per-Service</code> \u89c4\u5219\u8fde\u63a5\u5230 <code>per-Endpoint</code> \u89c4\u5219\uff0c\u8be5 <code>per-Endpoint</code> \u89c4\u5219\u4f1a\u91cd\u5b9a\u5411\uff08\u76ee\u6807 <code>NAT</code>\uff09\u5230\u540e\u7aef\u7684 Pod\u3002</p>"},{"location":"kubernetes_network/service/#ipvs","title":"ipvs","text":"<p>\u9664\u4e86 iptables \u6a21\u5f0f\u4e4b\u5916\uff0ckubernetes \u4e5f\u652f\u6301 ipvs \u6a21\u5f0f\uff0c\u5728 ipvs \u6a21\u5f0f\u4e0b\uff0ckube-proxy \u76d1\u89c6 Kubernetes \u670d\u52a1\u548c\u7aef\u70b9\uff0c\u8c03\u7528 <code>netlink</code> \u63a5\u53e3\u76f8\u5e94\u5730\u521b\u5efa IPVS \u89c4\u5219\uff0c \u5e76\u5b9a\u671f\u5c06 IPVS \u89c4\u5219\u4e0e Kubernetes \u670d\u52a1\u548c\u7aef\u70b9\u540c\u6b65\u3002\u8be5\u63a7\u5236\u5faa\u73af\u53ef\u786e\u4fdd IPVS \u72b6\u6001\u4e0e\u6240\u9700\u72b6\u6001\u5339\u914d\u3002\u8bbf\u95ee\u670d\u52a1\u65f6\uff0cIPVS\u3000\u5c06\u6d41\u91cf\u5b9a\u5411\u5230\u540e\u7aef Pod \u4e4b\u4e00\u3002</p> <p>IPVS \u4ee3\u7406\u6a21\u5f0f\u57fa\u4e8e\u7c7b\u4f3c\u4e8e iptables \u6a21\u5f0f\u7684 netfilter \u94a9\u5b50\u51fd\u6570\uff0c\u4f46\u662f\u4f7f\u7528<code>\u54c8\u5e0c\u8868</code>\u4f5c\u4e3a\u57fa\u7840\u6570\u636e\u7ed3\u6784\uff0c\u5e76\u4e14\u5728\u5185\u6838\u7a7a\u95f4\u4e2d\u5de5\u4f5c\u3002 \u6240\u4ee5\u4e0e iptables \u6a21\u5f0f\u4e0b\u7684 kube-proxy \u76f8\u6bd4\uff0cIPVS \u6a21\u5f0f\u4e0b\u7684 kube-proxy \u91cd\u5b9a\u5411\u901a\u4fe1\u7684\u5ef6\u8fdf\u8981\u77ed\uff0c\u5e76\u4e14\u5728\u540c\u6b65\u4ee3\u7406\u89c4\u5219\u65f6\u5177\u6709\u66f4\u597d\u7684\u6027\u80fd\u3002\u4e0e\u5176\u4ed6\u4ee3\u7406\u6a21\u5f0f\u76f8\u6bd4\uff0cIPVS \u6a21\u5f0f\u8fd8\u652f\u6301\u66f4\u9ad8\u7684\u7f51\u7edc\u6d41\u91cf\u541e\u5410\u91cf\u3002\u6240\u4ee5\u5bf9\u4e8e\u8f83\u5927\u89c4\u6a21\u7684\u96c6\u7fa4\u4f1a\u4f7f\u7528 ipvs \u6a21\u5f0f\u7684 kube-proxy\uff0c\u53ea\u9700\u8981\u6ee1\u8db3\u8282\u70b9\u4e0a\u8fd0\u884c ipvs \u7684\u6761\u4ef6\uff0c\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u5c06 kube-proxy \u7684\u6a21\u5f0f\u4fee\u6539\u4e3a ipvs\uff0c\u5982\u679c\u4e0d\u6ee1\u8db3\u8fd0\u884c\u6761\u4ef6\u4f1a\u81ea\u52a8\u964d\u7ea7\u4e3a iptables \u6a21\u5f0f\uff0c\u73b0\u5728\u90fd\u63a8\u8350\u4f7f\u7528 ipvs \u6a21\u5f0f\uff0c\u53ef\u4ee5\u5927\u5e45\u5ea6\u63d0\u9ad8 Service \u6027\u80fd\u3002</p> <p>IPVS \u63d0\u4f9b\u4e86\u66f4\u591a\u9009\u9879\u6765\u5e73\u8861\u540e\u7aef Pod \u7684\u6d41\u91cf\uff0c\u9ed8\u8ba4\u662f <code>rr</code>\uff0c\u6709\u5982\u4e0b\u4e00\u4e9b\u7b56\u7565\uff1a</p> <ul> <li>rr: round-robin</li> <li>lc: least connection (smallest number of open connections)</li> <li>dh: destination hashing</li> <li>sh: source hashing</li> <li>sed: shortest expected delay</li> <li>nq: never queue</li> </ul> <p>\u4e0d\u8fc7\u73b0\u5728\u53ea\u80fd\u6574\u4f53\u4fee\u6539\u7b56\u7565\uff0c\u53ef\u4ee5\u901a\u8fc7 kube-proxy \u4e2d\u914d\u7f6e <code>\u2013ipvs-scheduler</code> \u53c2\u6570\u6765\u5b9e\u73b0\uff0c\u6682\u65f6\u4e0d\u652f\u6301\u7279\u5b9a\u7684 Service \u8fdb\u884c\u914d\u7f6e\u3002</p> <p></p> <p>\u6211\u4eec\u4e5f\u53ef\u4ee5\u5b9e\u73b0\u57fa\u4e8e\u5ba2\u6237\u7aef IP \u7684\u4f1a\u8bdd\u4eb2\u548c\u6027\uff0c\u53ef\u4ee5\u5c06 service.spec.sessionAffinity \u7684\u503c\u8bbe\u7f6e\u4e3a \"ClientIP\" \uff08\u9ed8\u8ba4\u503c\u4e3a \"None\"\uff09\u5373\u53ef\uff0c\u6b64\u5916\u8fd8\u53ef\u4ee5\u901a\u8fc7\u9002\u5f53\u8bbe\u7f6e </p> <pre><code>service.spec.sessionAffinityConfig.clientIP.timeoutSeconds\n</code></pre> <p>\u6765\u8bbe\u7f6e\u6700\u5927\u4f1a\u8bdd\u505c\u7559\u65f6\u95f4\uff08\u9ed8\u8ba4\u503c\u4e3a 10800 \u79d2\uff0c\u5373 3 \u5c0f\u65f6\uff09:</p> <pre><code>apiVersion: v1\nkind: Service\nspec:\n  sessionAffinity: ClientIP\n  ...\n</code></pre> <p>\u4eb2\u548c\u6027</p> <p>Service \u53ea\u652f\u6301\u4e24\u79cd\u5f62\u5f0f\u7684\u4f1a\u8bdd\u4eb2\u548c\u6027\u670d\u52a1\uff1aNone \u548c ClientIP\uff0c\u4e0d\u652f\u6301\u57fa\u4e8e cookie \u7684\u4f1a\u8bdd\u4eb2\u548c\u6027\uff0c\u8fd9\u662f\u56e0\u4e3a Service \u4e0d\u662f\u5728 HTTP \u5c42\u9762\u4e0a\u5de5\u4f5c\u7684\uff0c\u5904\u7406\u7684\u662f TCP \u548c UDP \u5305\uff0c\u5e76\u4e0d\u5173\u5fc3\u5176\u4e2d\u7684\u8f7d\u8377\u5185\u5bb9\uff0c\u56e0\u4e3a cookie \u662f HTTP \u534f\u8bae\u7684\u4e00\u90e8\u5206\uff0cService \u5e76\u4e0d\u77e5\u9053\u5b83\u4eec\uff0c\u6240\u6709\u4f1a\u8bdd\u4eb2\u548c\u6027\u4e0d\u80fd\u57fa\u4e8e Cookie\u3002</p>"},{"location":"kubernetes_network/service/#service_2","title":"Service","text":"<p>\u6211\u4eec\u5728\u5b9a\u4e49 Service \u7684\u65f6\u5019\u53ef\u4ee5\u6307\u5b9a\u4e00\u4e2a\u81ea\u5df1\u9700\u8981\u7684\u7c7b\u578b\u7684 Service\uff0c\u5982\u679c\u4e0d\u6307\u5b9a\u7684\u8bdd\u9ed8\u8ba4\u662f <code>ClusterIP</code>\u7c7b\u578b\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u7684\u670d\u52a1\u7c7b\u578b\u5982\u4e0b\uff1a</p> <ul> <li> <p>ClusterIP\uff1a\u901a\u8fc7\u96c6\u7fa4\u7684\u5185\u90e8 IP \u66b4\u9732\u670d\u52a1\uff0c\u9009\u62e9\u8be5\u503c\uff0c\u670d\u52a1\u53ea\u80fd\u591f\u5728\u96c6\u7fa4\u5185\u90e8\u53ef\u4ee5\u8bbf\u95ee\uff0c\u8fd9\u4e5f\u662f\u9ed8\u8ba4\u7684\u670d\u52a1\u7c7b\u578b\u3002</p> </li> <li> <p>NodePort\uff1a\u901a\u8fc7\u6bcf\u4e2a Node \u8282\u70b9\u4e0a\u7684 IP \u548c\u9759\u6001\u7aef\u53e3\uff08NodePort\uff09\u66b4\u9732\u670d\u52a1\u3002NodePort \u670d\u52a1\u4f1a\u8def\u7531\u5230 ClusterIP \u670d\u52a1\uff0c\u8fd9\u4e2a ClusterIP \u670d\u52a1\u4f1a\u81ea\u52a8\u521b\u5efa\u3002\u901a\u8fc7\u8bf7\u6c42 <code>NodeIp:NodePort</code>\uff0c\u53ef\u4ee5\u4ece\u96c6\u7fa4\u7684\u5916\u90e8\u8bbf\u95ee\u4e00\u4e2a NodePort \u670d\u52a1\u3002</p> </li> <li> <p>LoadBalancer\uff1a\u4f7f\u7528\u4e91\u63d0\u4f9b\u5546\u7684\u8d1f\u8f7d\u5c40\u8861\u5668\uff0c\u53ef\u4ee5\u5411\u5916\u90e8\u66b4\u9732\u670d\u52a1\u3002\u5916\u90e8\u7684\u8d1f\u8f7d\u5747\u8861\u5668\u53ef\u4ee5\u8def\u7531\u5230 NodePort \u670d\u52a1\u548c ClusterIP \u670d\u52a1\uff0c\u8fd9\u4e2a\u9700\u8981\u7ed3\u5408\u5177\u4f53\u7684\u4e91\u5382\u5546\u8fdb\u884c\u64cd\u4f5c\u3002</p> </li> <li> <p>ExternalName\uff1a\u901a\u8fc7\u8fd4\u56de <code>CNAME</code> \u548c\u5b83\u7684\u503c\uff0c\u53ef\u4ee5\u5c06\u670d\u52a1\u6620\u5c04\u5230 <code>externalName</code> \u5b57\u6bb5\u7684\u5185\u5bb9\uff08\u4f8b\u5982\uff0c foo.bar.example.com\uff09\u3002</p> </li> </ul>"},{"location":"kubernetes_network/service/#nodeport","title":"NodePort \u7c7b\u578b","text":"<p>\u5982\u679c\u8bbe\u7f6e type \u7684\u503c\u4e3a \"NodePort\"\uff0cKubernetes master \u5c06\u4ece\u7ed9\u5b9a\u7684\u914d\u7f6e\u8303\u56f4\u5185\uff08\u9ed8\u8ba4\uff1a30000-32767\uff09\u5206\u914d\u7aef\u53e3\uff0c\u6bcf\u4e2a Node \u5c06\u4ece\u8be5\u7aef\u53e3\uff08\u6bcf\u4e2a Node \u4e0a\u7684\u540c\u4e00\u7aef\u53e3\uff09\u4ee3\u7406\u5230 Service\u3002\u8be5\u7aef\u53e3\u5c06\u901a\u8fc7 Service \u7684 </p> <pre><code>spec.ports[*].nodePort\n</code></pre> <p>\u5b57\u6bb5\u88ab\u6307\u5b9a\uff0c\u5982\u679c\u4e0d\u6307\u5b9a\u7684\u8bdd\u4f1a\u81ea\u52a8\u751f\u6210\u4e00\u4e2a\u7aef\u53e3\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cService \u5c06\u80fd\u591f\u901a\u8fc7 </p> <pre><code>spec.ports[].nodePort\n</code></pre> <p>\u548c </p> <pre><code>spec.clusterIp:spec.ports[].port\n</code></pre> <p>\u800c\u5bf9\u5916\u53ef\u89c1\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u7ed9\u5927\u5bb6\u521b\u5efa\u4e00\u4e2a NodePort \u7684\u670d\u52a1\u6765\u8bbf\u95ee\u6211\u4eec\u524d\u9762\u7684 Nginx \u670d\u52a1\uff1a(service-nodeport-demo.yaml)</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: myservice\nspec:\n  selector:\n    app: myapp\n  type: NodePort\n  ports:\n  - protocol: TCP\n    port: 80\n    targetPort: 80\n    name: myapp-http\n</code></pre> <p>\u521b\u5efa\u8be5 Service:</p> <pre><code>$ kubectl apply -f service-demo.yaml\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u67e5\u770b Service \u5bf9\u8c61\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get svc\nNAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE\nkubernetes   ClusterIP   1       &lt;none&gt;        443/TCP        27d\nmyservice    NodePort    1198   &lt;none&gt;        80:32560/TCP   14h\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 myservice \u7684 TYPE \u7c7b\u578b\u5df2\u7ecf\u53d8\u6210\u4e86 NodePort\uff0c\u540e\u9762\u7684 PORT(S) \u90e8\u5206\u4e5f\u591a\u4e86\u4e00\u4e2a 32560 \u7684\u6620\u5c04\u7aef\u53e3\u3002</p>"},{"location":"kubernetes_network/service/#externalname","title":"ExternalName","text":"<p>ExternalName \u662f Service \u7684\u7279\u4f8b\uff0c\u5b83\u6ca1\u6709 <code>selector</code>\uff0c\u4e5f\u6ca1\u6709\u5b9a\u4e49\u4efb\u4f55\u7684\u7aef\u53e3\u548c Endpoint\u3002\u5bf9\u4e8e\u8fd0\u884c\u5728\u96c6\u7fa4\u5916\u90e8\u7684\u670d\u52a1\uff0c\u5b83\u901a\u8fc7\u8fd4\u56de\u8be5\u5916\u90e8\u670d\u52a1\u7684\u522b\u540d\u8fd9\u79cd\u65b9\u5f0f\u6765\u63d0\u4f9b\u670d\u52a1\u3002</p> <pre><code>kind: Service\napiVersion: v1\nmetadata:\n  name: my-service\n  namespace: prod\nspec:\n  type: ExternalName\n  externalName: my.database.example.com\n</code></pre> <p>\u5f53\u8bbf\u95ee\u5730\u5740 </p> <pre><code>my-service.prod.svc.cluster.local\n</code></pre> <p>\uff08\u540e\u9762\u670d\u52a1\u53d1\u73b0\u7684\u65f6\u5019\u6211\u4eec\u4f1a\u518d\u6df1\u5165\u8bb2\u89e3\uff09\u65f6\uff0c\u96c6\u7fa4\u7684 DNS \u670d\u52a1\u5c06\u8fd4\u56de\u4e00\u4e2a\u503c\u4e3a my.database.example.com \u7684 <code>CNAME</code> \u8bb0\u5f55\u3002\u8bbf\u95ee\u8fd9\u4e2a\u670d\u52a1\u7684\u5de5\u4f5c\u65b9\u5f0f\u4e0e\u5176\u5b83\u7684\u76f8\u540c\uff0c\u552f\u4e00\u4e0d\u540c\u7684\u662f\u91cd\u5b9a\u5411\u53d1\u751f\u5728 DNS \u5c42\uff0c\u800c\u4e14\u4e0d\u4f1a\u8fdb\u884c\u4ee3\u7406\u6216\u8f6c\u53d1\u3002\u5982\u679c\u540e\u7eed\u51b3\u5b9a\u8981\u5c06\u6570\u636e\u5e93\u8fc1\u79fb\u5230 Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u53ef\u4ee5\u542f\u52a8\u5bf9\u5e94\u7684 Pod\uff0c\u589e\u52a0\u5408\u9002\u7684 Selector \u6216 Endpoint\uff0c\u4fee\u6539 Service \u7684 type\uff0c\u5b8c\u5168\u4e0d\u9700\u8981\u4fee\u6539\u8c03\u7528\u7684\u4ee3\u7801\uff0c\u8fd9\u6837\u5c31\u5b8c\u5168\u89e3\u8026\u4e86\u3002</p> <p>\u9664\u4e86\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 <code>externalName</code> \u6307\u5b9a\u5916\u90e8\u670d\u52a1\u7684\u57df\u540d\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u901a\u8fc7\u81ea\u5b9a\u4e49 Endpoints \u6765\u521b\u5efa Service\uff0c\u524d\u63d0\u662f <code>clusterIP=None</code>\uff0c\u540d\u79f0\u8981\u548c Service \u4fdd\u6301\u4e00\u81f4\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: etcd-k8s\n  namespace: kube-system\n  labels:\n    k8s-app: etcd\nspec:\n  type: ClusterIP\n  clusterIP: None\n  ports:\n  - name: port\n    port: 2379\n\n---\n\napiVersion: v1\nkind: Endpoints\nmetadata:\n  name: etcd-k8s  # \u540d\u79f0\u5fc5\u987b\u548c Service \u4e00\u81f4\n  namespace: kube-system\n  labels:\n    k8s-app: etcd\nsubsets:\n- addresses:\n  - ip: 157  # Service \u5c06\u8fde\u63a5\u91cd\u5b9a\u5411\u5230 endpoint\n  ports:\n  - name: port\n    port: 2379   # endpoint \u7684\u76ee\u6807\u7aef\u53e3\n</code></pre> <p>\u4e0a\u9762\u8fd9\u4e2a\u670d\u52a1\u5c31\u662f\u5c06\u5916\u90e8\u7684 etcd \u670d\u52a1\u5f15\u5165\u5230 Kubernetes \u96c6\u7fa4\u4e2d\u6765\u3002</p>"},{"location":"kubernetes_network/service/#ip_1","title":"\u83b7\u53d6\u5ba2\u6237\u7aef IP","text":"<p>\u901a\u5e38\uff0c\u5f53\u96c6\u7fa4\u5185\u7684\u5ba2\u6237\u7aef\u8fde\u63a5\u5230\u670d\u52a1\u7684\u65f6\u5019\uff0c\u662f\u652f\u6301\u670d\u52a1\u7684 Pod \u53ef\u4ee5\u83b7\u53d6\u5230\u5ba2\u6237\u7aef\u7684 IP \u5730\u5740\u7684\uff0c\u4f46\u662f\uff0c\u5f53\u901a\u8fc7\u8282\u70b9\u7aef\u53e3\u63a5\u6536\u5230\u8fde\u63a5\u65f6\uff0c\u7531\u4e8e\u5bf9\u6570\u636e\u5305\u6267\u884c\u4e86\u6e90\u7f51\u7edc\u5730\u5740\u8f6c\u6362\uff08SNAT\uff09\uff0c\u56e0\u6b64\u6570\u636e\u5305\u7684\u6e90 IP \u5730\u5740\u4f1a\u53d1\u751f\u53d8\u5316\uff0c\u540e\u7aef\u7684 Pod \u65e0\u6cd5\u770b\u5230\u5b9e\u9645\u7684\u5ba2\u6237\u7aef IP\uff0c\u5bf9\u4e8e\u67d0\u4e9b\u5e94\u7528\u6765\u8bf4\u662f\u4e2a\u95ee\u9898\uff0c\u6bd4\u5982\uff0cnginx \u7684\u8bf7\u6c42\u65e5\u5fd7\u5c31\u65e0\u6cd5\u83b7\u53d6\u51c6\u786e\u7684\u5ba2\u6237\u7aef\u8bbf\u95ee IP \u4e86\uff0c\u6bd4\u5982\u4e0b\u9762\u6211\u4eec\u7684\u5e94\u7528\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:9\n        ports:\n        - containerPort: 80\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: nginx\nspec:\n  selector:\n    app: nginx\n  type: NodePort\n  ports:\n  - protocol: TCP\n    port: 80\n    targetPort: 80\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u540e\u53ef\u4ee5\u67e5\u770b nginx \u670d\u52a1\u88ab\u81ea\u52a8\u5206\u914d\u4e86\u4e00\u4e2a 32761 \u7684 NodePort \u7aef\u53e3\uff1a</p> <pre><code>$ kubectl get svc\nNAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE\nkubernetes   ClusterIP   1        &lt;none&gt;        443/TCP        28d\nnginx        NodePort    11194   &lt;none&gt;        80:32761/TCP   48m\n$ kubectl get pods -o wide\nNAME                              READY   STATUS    RESTARTS   AGE     IP             NODE         NOMINATED NODE   READINESS GATES\nnginx-54f57cf6bf-nwtjp            1/1     Running   0          3m      215    ydzs-node3   &lt;none&gt;           &lt;none&gt;\nnginx-54f57cf6bf-ptvgs            1/1     Running   0          2m59s   213    ydzs-node2   &lt;none&gt;           &lt;none&gt;\nnginx-54f57cf6bf-xhs8g            1/1     Running   0          2m59s   216    ydzs-node1   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a3\u4e2a Pod \u88ab\u5206\u914d\u5230\u4e86 3 \u4e2a\u4e0d\u540c\u7684\u8282\u70b9\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u901a\u8fc7 master \u8282\u70b9\u7684 NodePort \u7aef\u53e3\u6765\u8bbf\u95ee\u4e0b\u6211\u4eec\u7684\u670d\u52a1\uff0c\u56e0\u4e3a\u6211\u8fd9\u91cc\u53ea\u6709 master \u8282\u70b9\u53ef\u4ee5\u8bbf\u95ee\u5916\u7f51\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u67e5\u770b nginx \u7684 Pod \u65e5\u5fd7\u53ef\u4ee5\u770b\u5230\u5176\u4e2d\u83b7\u53d6\u5230\u7684 clientIP \u662f <code>10.151.30.11</code>\uff0c\u5176\u5b9e\u662f master \u8282\u70b9\u7684\u5185\u7f51 IP\uff0c\u5e76\u4e0d\u662f\u6211\u4eec\u671f\u671b\u7684\u771f\u6b63\u7684\u6d4f\u89c8\u5668\u7aef\u8bbf\u95ee\u7684 IP \u5730\u5740\uff1a</p> <pre><code>$ kubectl logs -f nginx-54f57cf6bf-xhs8g\n111 - - [07/Dec/2019:16:44:38 +0800] \"GET / HTTP/1\" 200 612 \"-\" \"Mozilla/0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/536 (KHTML, like Gecko) Chrome/39108 Safari/536\" \"-\"\n</code></pre> <p>\u8fd9\u4e2a\u662f\u56e0\u4e3a\u6211\u4eec master \u8282\u70b9\u4e0a\u5e76\u6ca1\u6709\u5bf9\u5e94\u7684 Pod\uff0c\u6240\u4ee5\u901a\u8fc7 master \u8282\u70b9\u53bb\u8bbf\u95ee\u5e94\u7528\u7684\u65f6\u5019\u5fc5\u7136\u9700\u8981\u989d\u5916\u7684\u7f51\u7edc\u8df3\u8f6c\u624d\u80fd\u5230\u8fbe\u5176\u4ed6\u8282\u70b9\u4e0a Pod\uff0c\u5728\u8df3\u8f6c\u8fc7\u7a0b\u4e2d\u7531\u4e8e\u5bf9\u6570\u636e\u5305\u8fdb\u884c\u4e86 SNAT\uff0c\u6240\u4ee5\u770b\u5230\u7684\u662f master \u8282\u70b9\u7684 IP\u3002\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u5728 Service \u8bbe\u7f6e </p> <pre><code>externalTrafficPolicy\n</code></pre> <p>\u6765\u51cf\u5c11\u7f51\u7edc\u8df3\u6570\uff1a</p> <pre><code>spec:\n  externalTrafficPolicy: Local\n</code></pre> <p>\u5982\u679c Service \u4e2d\u914d\u7f6e\u4e86 </p> <pre><code>externalTrafficPolicy=Local\n</code></pre> <p>\uff0c\u5e76\u4e14\u901a\u8fc7\u670d\u52a1\u7684\u8282\u70b9\u7aef\u53e3\u6765\u6253\u5f00\u5916\u90e8\u8fde\u63a5\uff0c\u5219 Service \u4f1a\u4ee3\u7406\u5230\u672c\u5730\u8fd0\u884c\u7684 Pod\uff0c\u5982\u679c\u672c\u5730\u6ca1\u6709\u672c\u5730 Pod \u5b58\u5728\uff0c\u5219\u8fde\u63a5\u5c06\u6302\u8d77\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u8bbe\u7f6e\u4e0a\u8be5\u5b57\u6bb5\u66f4\u65b0\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53bb\u901a\u8fc7 master \u8282\u70b9\u7684 NodePort \u8bbf\u95ee\u5e94\u7528\u662f\u8bbf\u95ee\u4e0d\u5230\u7684\uff0c\u56e0\u4e3a master \u8282\u70b9\u4e0a\u5e76\u6ca1\u6709\u5bf9\u5e94\u7684 Pod \u8fd0\u884c\uff0c\u6240\u4ee5\u9700\u8981\u786e\u4fdd\u8d1f\u8f7d\u5747\u8861\u5668\u5c06\u8fde\u63a5\u8f6c\u53d1\u7ed9\u81f3\u5c11\u5177\u6709\u4e00\u4e2a Pod \u7684\u8282\u70b9\u3002</p> <p>\u4f46\u662f\u9700\u8981\u6ce8\u610f\u7684\u662f\u4f7f\u7528\u8fd9\u4e2a\u53c2\u6570\u6709\u4e00\u4e2a\u7f3a\u70b9\uff0c\u901a\u5e38\u60c5\u51b5\u4e0b\uff0c\u8bf7\u6c42\u90fd\u662f\u5747\u5300\u5206\u5e03\u5728\u6240\u6709 Pod \u4e0a\u7684\uff0c\u4f46\u662f\u4f7f\u7528\u4e86\u8fd9\u4e2a\u914d\u7f6e\u7684\u8bdd\uff0c\u60c5\u51b5\u5c31\u6709\u53ef\u80fd\u4e0d\u4e00\u6837\u4e86\u3002\u6bd4\u5982\u6211\u4eec\u6709\u4e24\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e86 3 \u4e2a Pod\uff0c\u5047\u5982\u8282\u70b9 A \u8fd0\u884c\u4e00\u4e2a Pod\uff0c\u8282\u70b9 B \u8fd0\u884c\u4e24\u4e2a Pod\uff0c\u5982\u679c\u8d1f\u8f7d\u5747\u8861\u5668\u5728\u4e24\u4e2a\u8282\u70b9\u95f4\u5747\u8861\u5206\u5e03\u8fde\u63a5\uff0c\u5219\u8282\u70b9 A \u4e0a\u7684 Pod \u5c06\u63a5\u6536\u5230\u6240\u6709\u8bf7\u6c42\u7684 50%\uff0c\u4f46\u8282\u70b9 B \u4e0a\u7684\u4e24\u4e2a Pod \u6bcf\u4e2a\u5c31\u53ea\u63a5\u6536 25% \u3002</p> <p>\u7531\u4e8e\u589e\u52a0\u4e86</p> <pre><code>externalTrafficPolicy: Local\n</code></pre> <p>\u8fd9\u4e2a\u914d\u7f6e\u540e\uff0c\u63a5\u6536\u8bf7\u6c42\u7684\u8282\u70b9\u548c\u76ee\u6807 Pod \u90fd\u5728\u4e00\u4e2a\u8282\u70b9\u4e0a\uff0c\u6240\u4ee5\u6ca1\u6709\u989d\u5916\u7684\u7f51\u7edc\u8df3\u8f6c\uff08\u4e0d\u6267\u884c SNAT\uff09\uff0c\u6240\u4ee5\u5c31\u53ef\u4ee5\u62ff\u5230\u6b63\u786e\u7684\u5ba2\u6237\u7aef IP\uff0c\u5982\u4e0b\u6240\u793a\u6211\u4eec\u628a Pod \u90fd\u56fa\u5b9a\u5230 master \u8282\u70b9\u4e0a\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name:  nginx\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      tolerations:\n      - operator: \"Exists\"\n      nodeSelector:\n        kubernetes.io/hostname: ydzs-master\n      containers:\n      - name: nginx\n        image: nginx:9\n        ports:\n        - containerPort: 80\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: nginx\nspec:\n externalTrafficPolicy: Local\n  selector:\n    app: nginx\n  type: NodePort\n  ports:\n  - protocol: TCP\n    port: 80\n    targetPort: 80\n</code></pre> <p>\u66f4\u65b0\u670d\u52a1\u540e\uff0c\u7136\u540e\u518d\u901a\u8fc7 NodePort \u8bbf\u95ee\u670d\u52a1\u53ef\u4ee5\u770b\u5230\u62ff\u5230\u7684\u5c31\u662f\u6b63\u786e\u7684\u5ba2\u6237\u7aef IP \u5730\u5740\u4e86\uff1a</p> <pre><code>$ kubectl logs -f nginx-ddc8f997b-ptb7b\n11111 - - [07/Dec/2019:17:03:43 +0800] \"GET / HTTP/1\" 200 612 \"-\" \"Mozilla/0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/536 (KHTML, like Gecko) Chrome/39108 Safari/536\" \"-\"\n</code></pre>"},{"location":"kubernetes_network/service/#_1","title":"\u670d\u52a1\u53d1\u73b0","text":"<p>\u4e0a\u9762\u6211\u4eec\u8bb2\u89e3\u4e86 Service \u7684\u7528\u6cd5\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 Service \u751f\u6210\u7684 ClusterIP(VIP) \u6765\u8bbf\u95ee Pod \u63d0\u4f9b\u7684\u670d\u52a1\uff0c\u4f46\u662f\u5728\u4f7f\u7528\u7684\u65f6\u5019\u8fd8\u6709\u4e00\u4e2a\u95ee\u9898\uff1a\u6211\u4eec\u600e\u4e48\u77e5\u9053\u67d0\u4e2a\u5e94\u7528\u7684 VIP \u5462\uff1f\u6bd4\u5982\u6211\u4eec\u6709\u4e24\u4e2a\u5e94\u7528\uff0c\u4e00\u4e2a\u662f api \u5e94\u7528\uff0c\u4e00\u4e2a\u662f db \u5e94\u7528\uff0c\u4e24\u4e2a\u5e94\u7528\u90fd\u662f\u901a\u8fc7 Deployment \u8fdb\u884c\u7ba1\u7406\u7684\uff0c\u5e76\u4e14\u90fd\u901a\u8fc7 Service \u66b4\u9732\u51fa\u4e86\u7aef\u53e3\u63d0\u4f9b\u670d\u52a1\u3002api \u9700\u8981\u8fde\u63a5\u5230 db \u8fd9\u4e2a\u5e94\u7528\uff0c\u6211\u4eec\u53ea\u77e5\u9053 db \u5e94\u7528\u7684\u540d\u79f0\u548c db \u5bf9\u5e94\u7684 Service \u7684\u540d\u79f0\uff0c\u4f46\u662f\u5e76\u4e0d\u77e5\u9053\u5b83\u7684 VIP \u5730\u5740\uff0c\u6211\u4eec\u524d\u9762\u7684 Service \u8bfe\u7a0b\u4e2d\u662f\u4e0d\u662f\u5b66\u4e60\u5230\u6211\u4eec\u901a\u8fc7 ClusterIP \u5c31\u53ef\u4ee5\u8bbf\u95ee\u5230\u540e\u9762\u7684 Pod \u670d\u52a1\uff0c\u5982\u679c\u6211\u4eec\u77e5\u9053\u4e86 VIP \u7684\u5730\u5740\u662f\u4e0d\u662f\u5c31\u884c\u4e86\uff1f</p>"},{"location":"kubernetes_network/service/#_2","title":"\u73af\u5883\u53d8\u91cf","text":"<p>\u4e3a\u4e86\u89e3\u51b3\u4e0a\u9762\u7684\u95ee\u9898\uff0c\u5728\u4e4b\u524d\u7684\u7248\u672c\u4e2d\uff0cKubernetes \u91c7\u7528\u4e86\u73af\u5883\u53d8\u91cf\u7684\u65b9\u6cd5\uff0c\u6bcf\u4e2a Pod \u542f\u52a8\u7684\u65f6\u5019\uff0c\u4f1a\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u8bbe\u7f6e\u6240\u6709\u670d\u52a1\u7684 IP \u548c port \u4fe1\u606f\uff0c\u8fd9\u6837 Pod \u4e2d\u7684\u5e94\u7528\u53ef\u4ee5\u901a\u8fc7\u8bfb\u53d6\u73af\u5883\u53d8\u91cf\u6765\u83b7\u53d6\u4f9d\u8d56\u670d\u52a1\u7684\u5730\u5740\u4fe1\u606f\uff0c\u8fd9\u79cd\u65b9\u6cd5\u4f7f\u7528\u8d77\u6765\u76f8\u5bf9\u7b80\u5355\uff0c\u4f46\u662f\u6709\u4e00\u4e2a\u5f88\u5927\u7684\u95ee\u9898\u5c31\u662f\u4f9d\u8d56\u7684\u670d\u52a1\u5fc5\u987b\u5728 Pod \u542f\u52a8\u4e4b\u524d\u5c31\u5b58\u5728\uff0c\u4e0d\u7136\u662f\u4e0d\u4f1a\u88ab\u6ce8\u5165\u5230\u73af\u5883\u53d8\u91cf\u4e2d\u7684\u3002\u6bd4\u5982\u6211\u4eec\u9996\u5148\u521b\u5efa\u4e00\u4e2a Nginx \u670d\u52a1\uff1a(test-nginx.yaml)</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx-deploy\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:9\n        ports:\n        - containerPort: 80\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: nginx-service\n  labels:\n    name: nginx-service\nspec:\n  ports:\n  - port: 5000\n    targetPort: 80\n  selector:\n    app: nginx\n</code></pre> <p>\u521b\u5efa\u4e0a\u9762\u7684\u670d\u52a1\uff1a</p> <pre><code>$ kubectl apply -f test-nginx.yaml\ndeployment.apps \"nginx-deploy\" created\nservice \"nginx-service\" created\n$ kubectl get pods\nNAME                                      READY     STATUS    RESTARTS   AGE\n...\nnginx-deploy-75675f5897-47h4t             1/1       Running   0          53s\nnginx-deploy-75675f5897-mmm8w             1/1       Running   0          53s\n...\n$ kubectl get svc\nNAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE\n...\nnginx-service   ClusterIP   1242    &lt;none&gt;        5000/TCP         1m\n...\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e24\u4e2a Pod \u548c\u4e00\u4e2a\u540d\u4e3a nginx-service \u7684\u670d\u52a1\u521b\u5efa\u6210\u529f\u4e86\uff0c\u8be5 Service \u76d1\u542c\u7684\u7aef\u53e3\u662f 5000\uff0c\u540c\u65f6\u5b83\u4f1a\u628a\u6d41\u91cf\u8f6c\u53d1\u7ed9\u5b83\u4ee3\u7406\u7684\u6240\u6709 Pod\uff08\u6211\u4eec\u8fd9\u91cc\u5c31\u662f\u62e5\u6709 <code>app: nginx</code> \u6807\u7b7e\u7684\u4e24\u4e2a Pod\uff09\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u518d\u6765\u521b\u5efa\u4e00\u4e2a\u666e\u901a\u7684 Pod\uff0c\u89c2\u5bdf\u4e0b\u8be5 Pod \u4e2d\u7684\u73af\u5883\u53d8\u91cf\u662f\u5426\u5305\u542b\u4e0a\u9762\u7684 <code>nginx-service</code> \u7684\u670d\u52a1\u4fe1\u606f\uff1a\uff08test-pod.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: test-pod\nspec:\n  containers:\n  - name: test-service-pod\n    image: busybox\n    command: [\"/bin/sh\", \"-c\", \"env\"]\n</code></pre> <p>\u7136\u540e\u521b\u5efa\u8be5\u6d4b\u8bd5\u7684 Pod\uff1a</p> <pre><code>$ kubectl apply -f test-pod.yaml\npod \"test-pod\" created\n</code></pre> <p>\u7b49 Pod \u521b\u5efa\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u67e5\u770b\u65e5\u5fd7\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl logs test-pod\n...\nKUBERNETES_PORT=tcp://1:443\nKUBERNETES_SERVICE_PORT=443\nHOSTNAME=test-pod\nHOME=/root\nNGINX_SERVICE_PORT_5000_TCP_ADDR=1242\nNGINX_SERVICE_PORT_5000_TCP_PORT=5000\nNGINX_SERVICE_PORT_5000_TCP_PROTO=tcp\nKUBERNETES_PORT_443_TCP_ADDR=1\nPATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\nNGINX_SERVICE_SERVICE_HOST=1242\nNGINX_SERVICE_PORT_5000_TCP=tcp://1242:5000\nKUBERNETES_PORT_443_TCP_PORT=443\nKUBERNETES_PORT_443_TCP_PROTO=tcp\nNGINX_SERVICE_SERVICE_PORT=5000\nNGINX_SERVICE_PORT=tcp://1242:5000\nKUBERNETES_SERVICE_PORT_HTTPS=443\nKUBERNETES_PORT_443_TCP=tcp://1:443\nKUBERNETES_SERVICE_HOST=1\nPWD=/\n...\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6253\u5370\u4e86\u5f88\u591a\u73af\u5883\u53d8\u91cf\u4fe1\u606f\uff0c\u5176\u4e2d\u5c31\u5305\u62ec\u6211\u4eec\u521a\u521a\u521b\u5efa\u7684 nginx-service \u8fd9\u4e2a\u670d\u52a1\uff0c\u6709 HOST\u3001PORT\u3001PROTO\u3001ADDR \u7b49\uff0c\u4e5f\u5305\u62ec\u5176\u4ed6\u5df2\u7ecf\u5b58\u5728\u7684 Service \u7684\u73af\u5883\u53d8\u91cf\uff0c\u73b0\u5728\u5982\u679c\u6211\u4eec\u9700\u8981\u5728\u8fd9\u4e2a Pod \u91cc\u9762\u8bbf\u95ee nginx-service \u7684\u670d\u52a1\uff0c\u6211\u4eec\u662f\u4e0d\u662f\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7 </p> <pre><code>NGINX_SERVICE_SERVICE_HOST\n</code></pre> <p>\u548c </p> <pre><code>NGINX_SERVICE_SERVICE_PORT\n</code></pre> <p>\u5c31\u53ef\u4ee5\u4e86\uff0c\u4f46\u662f\u5982\u679c\u8fd9\u4e2a Pod \u542f\u52a8\u8d77\u6765\u7684\u65f6\u5019 nginx-service \u670d\u52a1\u8fd8\u6ca1\u542f\u52a8\u8d77\u6765\uff0c\u5728\u73af\u5883\u53d8\u91cf\u4e2d\u6211\u4eec\u662f\u65e0\u6cd5\u83b7\u53d6\u5230\u8fd9\u4e9b\u4fe1\u606f\u7684\uff0c\u5f53\u7136\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>initContainer</code> \u4e4b\u7c7b\u7684\u65b9\u6cd5\u6765\u786e\u4fdd nginx-service \u542f\u52a8\u540e\u518d\u542f\u52a8 Pod\uff0c\u4f46\u662f\u8fd9\u79cd\u65b9\u6cd5\u6bd5\u7adf\u589e\u52a0\u4e86 Pod \u542f\u52a8\u7684\u590d\u6742\u6027\uff0c\u6240\u4ee5\u8fd9\u4e0d\u662f\u6700\u4f18\u7684\u65b9\u6cd5\uff0c\u5c40\u9650\u6027\u592a\u591a\u4e86\u3002</p>"},{"location":"kubernetes_network/service/#dns","title":"DNS","text":"<p>\u7531\u4e8e\u4e0a\u9762\u73af\u5883\u53d8\u91cf\u8fd9\u79cd\u65b9\u5f0f\u7684\u5c40\u9650\u6027\uff0c\u6211\u4eec\u9700\u8981\u4e00\u79cd\u66f4\u52a0\u667a\u80fd\u7684\u65b9\u6848\uff0c\u5176\u5b9e\u6211\u4eec\u53ef\u4ee5\u81ea\u5df1\u601d\u8003\u4e00\u79cd\u6bd4\u8f83\u7406\u60f3\u7684\u65b9\u6848\uff1a\u90a3\u5c31\u662f\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 Service \u7684\u540d\u79f0\uff0c\u56e0\u4e3a Service \u7684\u540d\u79f0\u4e0d\u4f1a\u53d8\u5316\uff0c\u6211\u4eec\u4e0d\u9700\u8981\u53bb\u5173\u5fc3\u5206\u914d\u7684 ClusterIP \u7684\u5730\u5740\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u5730\u5740\u5e76\u4e0d\u662f\u56fa\u5b9a\u4e0d\u53d8\u7684\uff0c\u6240\u4ee5\u5982\u679c\u6211\u4eec\u76f4\u63a5\u4f7f\u7528 Service \u7684\u540d\u5b57\uff0c\u7136\u540e\u5bf9\u5e94\u7684 ClusterIP \u5730\u5740\u7684\u8f6c\u6362\u80fd\u591f\u81ea\u52a8\u5b8c\u6210\u5c31\u5f88\u597d\u4e86\u3002\u6211\u4eec\u77e5\u9053\u540d\u5b57\u548c IP \u76f4\u63a5\u7684\u8f6c\u6362\u662f\u4e0d\u662f\u548c\u6211\u4eec\u5e73\u65f6\u8bbf\u95ee\u7684\u7f51\u7ad9\u975e\u5e38\u7c7b\u4f3c\u554a\uff1f\u4ed6\u4eec\u4e4b\u95f4\u7684\u8f6c\u6362\u529f\u80fd\u901a\u8fc7 DNS \u5c31\u53ef\u4ee5\u89e3\u51b3\u4e86\uff0c\u540c\u6837\u7684\uff0cKubernetes \u4e5f\u63d0\u4f9b\u4e86 DNS \u7684\u65b9\u6848\u6765\u89e3\u51b3\u4e0a\u9762\u7684\u670d\u52a1\u53d1\u73b0\u7684\u95ee\u9898\u3002</p> <p>DNS \u670d\u52a1\u4e0d\u662f\u4e00\u4e2a\u72ec\u7acb\u7684\u7cfb\u7edf\u670d\u52a1\uff0c\u800c\u662f\u4f5c\u4e3a\u4e00\u79cd addon \u63d2\u4ef6\u800c\u5b58\u5728\uff0c\u73b0\u5728\u6bd4\u8f83\u63a8\u8350\u7684\u4e24\u4e2a\u63d2\u4ef6\uff1akube-dns \u548c CoreDNS\uff0c\u5b9e\u9645\u4e0a\u5728\u6bd4\u8f83\u65b0\u70b9\u7684\u7248\u672c\u4e2d\u5df2\u7ecf\u9ed8\u8ba4\u662f CoreDNS \u4e86\uff0c\u56e0\u4e3a kube-dns \u9ed8\u8ba4\u4e00\u4e2a Pod \u4e2d\u9700\u89813\u4e2a\u5bb9\u5668\u914d\u5408\u4f7f\u7528\uff0cCoreDNS \u53ea\u9700\u8981\u4e00\u4e2a\u5bb9\u5668\u5373\u53ef\uff0c\u6211\u4eec\u5728\u524d\u9762\u4f7f\u7528 kubeadm \u642d\u5efa\u96c6\u7fa4\u7684\u65f6\u5019\u76f4\u63a5\u5b89\u88c5\u7684\u5c31\u662f CoreDNS \u63d2\u4ef6\uff1a</p> <pre><code>$ kubectl get pods -n kube-system -l k8s-app=kube-dns\nNAME                       READY   STATUS    RESTARTS   AGE\ncoredns-667f964f9b-sthqq   1/1     Running   0          32m\ncoredns-667f964f9b-zj4r4   1/1     Running   0          33m\n</code></pre> <p>CoreDns \u662f\u7528 GO \u5199\u7684\u9ad8\u6027\u80fd\uff0c\u9ad8\u6269\u5c55\u6027\u7684 DNS \u670d\u52a1\uff0c\u57fa\u4e8e HTTP/2 Web \u670d\u52a1 Caddy \u8fdb\u884c\u7f16\u5199\u7684\u3002CoreDns \u5185\u90e8\u91c7\u7528\u63d2\u4ef6\u673a\u5236\uff0c\u6240\u6709\u529f\u80fd\u90fd\u662f\u63d2\u4ef6\u5f62\u5f0f\u7f16\u5199\uff0c\u7528\u6237\u4e5f\u53ef\u4ee5\u6269\u5c55\u81ea\u5df1\u7684\u63d2\u4ef6\uff0c\u4ee5\u4e0b\u662f Kubernetes \u90e8\u7f72 CoreDns \u65f6\u7684\u9ed8\u8ba4\u914d\u7f6e\uff1a</p> <pre><code>$ kubectl get cm coredns -n kube-system -o yaml\napiVersion: v1\ndata:\n  Corefile: |\n    .:53 {\n        errors  # \u542f\u7528\u9519\u8bef\u8bb0\u5f55\n        health  # \u542f\u7528\u68c0\u67e5\u68c0\u67e5\u7aef\u70b9\uff0c8080:health\n        ready\n        kubernetes cluster.local in-addr.arpa iparpa {  # \u5904\u7406 k8s \u57df\u540d\u89e3\u6790\n           pods insecure\n           fallthrough in-addr.arpa iparpa\n           ttl 30\n        }\n        prometheus :9153  # \u542f\u7528 prometheus metrics \u6307\u6807\uff0c9153:metrics\n        forward . /etc/resolv.conf  # \u901a\u8fc7 resolv.conf \u5185\u7684 nameservers \u89e3\u6790\n        cache 30  # \u542f\u7528\u7f13\u5b58\uff0c\u6240\u6709\u5185\u5bb9\u9650\u5236\u4e3a 30s \u7684TTL\n        loop  # \u68c0\u67e5\u7b80\u5355\u7684\u8f6c\u53d1\u5faa\u73af\u5e76\u505c\u6b62\u670d\u52a1\n        reload  # \u8fd0\u884c\u81ea\u52a8\u91cd\u65b0\u52a0\u8f7d corefile\uff0c\u70ed\u66f4\u65b0\n        loadbalance  # \u8d1f\u8f7d\u5747\u8861\uff0c\u9ed8\u8ba4 round_robin\n    }\nkind: ConfigMap\nmetadata:\n  creationTimestamp: \"2019-11-08T11:59:49Z\"\n  name: coredns\n  namespace: kube-system\n  resourceVersion: \"188\"\n  selfLink: /api/v1/namespaces/kube-system/configmaps/coredns\n  uid: 21966186-c2d9-467a-b87f-d061c5c9e4d7\n</code></pre> <ul> <li>\u6bcf\u4e2a <code>{}</code> \u4ee3\u8868\u4e00\u4e2a zone,\u683c\u5f0f\u662f <code>\u201cZone:port{}\u201d</code>, \u5176\u4e2d<code>\".\"</code>\u4ee3\u8868\u9ed8\u8ba4zone</li> <li> <p><code>{}</code> \u5185\u7684\u6bcf\u4e2a\u540d\u79f0\u4ee3\u8868\u63d2\u4ef6\u7684\u540d\u79f0\uff0c\u53ea\u6709\u914d\u7f6e\u7684\u63d2\u4ef6\u624d\u4f1a\u542f\u7528\uff0c\u5f53\u89e3\u6790\u57df\u540d\u65f6\uff0c\u4f1a\u5148\u5339\u914d zone\uff08\u90fd\u672a\u5339\u914d\u4f1a\u6267\u884c\u9ed8\u8ba4 zone\uff09\uff0c\u7136\u540e zone \u5185\u7684\u63d2\u4ef6\u4ece\u4e0a\u5230\u4e0b\u4f9d\u6b21\u6267\u884c(\u8fd9\u4e2a\u987a\u5e8f\u5e76\u4e0d\u662f\u914d\u7f6e\u6587\u4ef6\u5185\u8c01\u5728\u524d\u9762\u7684\u987a\u5e8f\uff0c\u800c\u662f</p> <pre><code>core/dnsserver/zdirectives.go\n</code></pre> <p>\u5185\u7684\u987a\u5e8f)\uff0c\u5339\u914d\u540e\u8fd4\u56de\u5904\u7406\uff08\u6267\u884c\u8fc7\u7684\u63d2\u4ef6\u4ece\u4e0b\u5230\u4e0a\u4f9d\u6b21\u5904\u7406\u8fd4\u56de\u903b\u8f91\uff09\uff0c\u4e0d\u518d\u6267\u884c\u4e0b\u4e00\u4e2a\u63d2\u4ef6</p> </li> </ul> <p>CoreDNS \u7684 Service \u5730\u5740\u4e00\u822c\u60c5\u51b5\u4e0b\u662f\u56fa\u5b9a\u7684\uff0c\u7c7b\u4f3c\u4e8e kubernetes \u8fd9\u4e2a Service \u5730\u5740\u4e00\u822c\u5c31\u662f\u7b2c\u4e00\u4e2a IP \u5730\u5740 <code>10.96.0.1</code>\uff0cCoreDNS \u7684 Service \u5730\u5740\u5c31\u662f <code>10.96.0.10</code>\uff0c\u8be5 IP \u88ab\u5206\u914d\u540e\uff0ckubelet \u4f1a\u5c06\u4f7f\u7528 </p> <pre><code>--cluster-dns=&lt;dns-service-ip&gt;\n</code></pre> <p>\u53c2\u6570\u914d\u7f6e\u7684 DNS \u4f20\u9012\u7ed9\u6bcf\u4e2a\u5bb9\u5668\u3002DNS \u540d\u79f0\u4e5f\u9700\u8981\u57df\u540d\uff0c\u672c\u5730\u57df\u53ef\u4ee5\u4f7f\u7528\u53c2\u6570</p> <pre><code>--cluster-domain = &lt;default-local-domain&gt;\n</code></pre> <p>\u5728 kubelet \u4e2d\u914d\u7f6e\uff1a</p> <pre><code>$ cat /var/lib/kubelet/config.yaml\n......\nclusterDNS:\n- 10\nclusterDomain: cluster.local\n......\n</code></pre> <p>\u6211\u4eec\u524d\u9762\u8bf4\u4e86\u5982\u679c\u6211\u4eec\u5efa\u7acb\u7684 Service \u5982\u679c\u652f\u6301\u57df\u540d\u5f62\u5f0f\u8fdb\u884c\u89e3\u6790\uff0c\u5c31\u53ef\u4ee5\u89e3\u51b3\u6211\u4eec\u7684\u670d\u52a1\u53d1\u73b0\u7684\u529f\u80fd\uff0c\u90a3\u4e48\u5229\u7528 kubedns \u53ef\u4ee5\u5c06 Service \u751f\u6210\u600e\u6837\u7684 DNS \u8bb0\u5f55\u5462\uff1f</p> <ul> <li> <p>\u666e\u901a\u7684 Service\uff1a\u4f1a\u751f\u6210 </p> <pre><code>servicename.namespace.svc.cluster.local\n</code></pre> <p>\u7684\u57df\u540d\uff0c\u4f1a\u89e3\u6790\u5230 Service \u5bf9\u5e94\u7684 ClusterIP \u4e0a\uff0c\u5728 Pod \u4e4b\u95f4\u7684\u8c03\u7528\u53ef\u4ee5\u7b80\u5199\u6210 </p> <pre><code>servicename.namespace\n</code></pre> <p>\uff0c\u5982\u679c\u5904\u4e8e\u540c\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\uff0c\u751a\u81f3\u53ef\u4ee5\u53ea\u5199\u6210 <code>servicename</code> \u5373\u53ef\u8bbf\u95ee *   Headless Service\uff1a\u65e0\u5934\u670d\u52a1\uff0c\u5c31\u662f\u628a clusterIP \u8bbe\u7f6e\u4e3a None \u7684\uff0c\u4f1a\u88ab\u89e3\u6790\u4e3a\u6307\u5b9a Pod \u7684 IP \u5217\u8868\uff0c\u540c\u6837\u8fd8\u53ef\u4ee5\u901a\u8fc7 </p> <pre><code>podname.servicename.namespace.svc.cluster.local\n</code></pre> <p>\u8bbf\u95ee\u5230\u5177\u4f53\u7684\u67d0\u4e00\u4e2a Pod\u3002</p> </li> </ul> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u4f7f\u7528\u4e00\u4e2a\u7b80\u5355 Pod \u6765\u6d4b\u8bd5\u4e0b Service \u7684\u57df\u540d\u8bbf\u95ee\uff1a</p> <pre><code>$ kubectl run -it --image busybox:3 test-dns --restart=Never --rm /bin/sh\nIf you don't see a command prompt, try pressing enter.\n/ # cat /etc/resolv.conf\nnameserver 10\nsearch default.svc.cluster.local svc.cluster.local cluster.local\noptions ndots:5\n/ #\n</code></pre> <p>\u6211\u4eec\u8fdb\u5165\u5230 Pod \u4e2d\uff0c\u67e5\u770b <code>/etc/resolv.conf</code> \u4e2d\u7684\u5185\u5bb9\uff0c\u53ef\u4ee5\u770b\u5230 <code>nameserver</code> \u7684\u5730\u5740 <code>10.96.0.10</code>\uff0c\u8be5 IP \u5730\u5740\u5373\u662f\u5728\u5b89\u88c5 CoreDNS \u63d2\u4ef6\u7684\u65f6\u5019\u96c6\u7fa4\u5206\u914d\u7684\u4e00\u4e2a\u56fa\u5b9a\u7684\u9759\u6001 IP \u5730\u5740\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u8fdb\u884c\u67e5\u770b\uff1a</p> <pre><code>$ kubectl get svc -n kube-system\nNAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                  AGE\nkube-dns                  ClusterIP   10       &lt;none&gt;        53/UDP,53/TCP,9153/TCP   28d\n</code></pre> <p>\u4e5f\u5c31\u662f\u8bf4\u6211\u4eec\u8fd9\u4e2a Pod \u73b0\u5728\u9ed8\u8ba4\u7684 <code>nameserver</code> \u5c31\u662f <code>kube-dns</code> \u7684\u5730\u5740\uff0c\u73b0\u5728\u6211\u4eec\u6765\u8bbf\u95ee\u4e0b\u524d\u9762\u6211\u4eec\u521b\u5efa\u7684 nginx-service \u670d\u52a1\uff1a</p> <pre><code>/ # wget -q -O- nginx-service.default.svc.cluster.local\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u6211\u4eec\u4f7f\u7528 wget \u547d\u4ee4\u53bb\u8bbf\u95ee nginx-service \u670d\u52a1\u7684\u57df\u540d\u7684\u65f6\u5019\u88ab hang \u4f4f\u4e86\uff0c\u6ca1\u6709\u5f97\u5230\u671f\u671b\u7684\u7ed3\u679c\uff0c\u8fd9\u662f\u56e0\u4e3a\u4e0a\u9762\u6211\u4eec\u5efa\u7acb Service \u7684\u65f6\u5019\u66b4\u9732\u7684\u7aef\u53e3\u662f 5000\uff1a</p> <pre><code>/ # wget -q -O- nginx-service.default.svc.cluster.local:5000\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n    body {\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    }\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>\u52a0\u4e0a 5000 \u7aef\u53e3\uff0c\u5c31\u6b63\u5e38\u8bbf\u95ee\u5230\u670d\u52a1\uff0c\u518d\u8bd5\u4e00\u8bd5\u8bbf\u95ee\uff1a</p> <pre><code>nginx-service.default.svc\n</code></pre> <p>\u3001</p> <pre><code>nginx-service.default\n</code></pre> <p>\u3001<code>nginx-service</code>\uff0c\u4e0d\u51fa\u610f\u5916\u8fd9\u4e9b\u57df\u540d\u90fd\u53ef\u4ee5\u6b63\u5e38\u8bbf\u95ee\u5230\u671f\u671b\u7684\u7ed3\u679c\u3002</p> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u662f\u4e0d\u662f\u5c31\u5b9e\u73b0\u4e86\u5728\u96c6\u7fa4\u5185\u90e8\u901a\u8fc7 Service \u7684\u57df\u540d\u5f62\u5f0f\u8fdb\u884c\u4e92\u76f8\u901a\u4fe1\u4e86\uff0c\u5927\u5bb6\u4e0b\u53bb\u8bd5\u7740\u770b\u770b\u8bbf\u95ee\u4e0d\u540c namespace \u4e0b\u9762\u7684\u670d\u52a1\u5462\uff1f\u4e0b\u8282\u8bfe\u6211\u4eec\u6765\u7ed9\u5927\u5bb6\u8bb2\u89e3\u4f7f\u7528 ingress \u66b4\u9732\u670d\u52a1\u3002</p>"},{"location":"kubernetes_network/ingress/nginx/","title":"NGINX Controller","text":"<p>\ue3c9</p>"},{"location":"kubernetes_network/ingress/nginx/#ingress","title":"Ingress","text":"<p>\u5bf9\u5916\u66b4\u9732\u96c6\u7fa4\u670d\u52a1</p> <p>\u524d\u9762\u6211\u4eec\u5b66\u4e60\u4e86\u5728 Kubernetes \u96c6\u7fa4\u5185\u90e8\u4f7f\u7528 kube-dns \u5b9e\u73b0\u670d\u52a1\u53d1\u73b0\u7684\u529f\u80fd\uff0c\u90a3\u4e48\u6211\u4eec\u90e8\u7f72\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u7684\u5e94\u7528\u5982\u4f55\u66b4\u9732\u7ed9\u5916\u90e8\u7684\u7528\u6237\u4f7f\u7528\u5462\uff1f\u6211\u4eec\u77e5\u9053\u53ef\u4ee5\u4f7f\u7528 <code>NodePort</code> \u548c <code>LoadBlancer</code> \u7c7b\u578b\u7684 Service \u53ef\u4ee5\u628a\u5e94\u7528\u66b4\u9732\u7ed9\u5916\u90e8\u7528\u6237\u4f7f\u7528\uff0c\u9664\u6b64\u4e4b\u5916\uff0cKubernetes \u8fd8\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u8d44\u6e90\u5bf9\u8c61\u53ef\u4ee5\u7528\u6765\u66b4\u9732\u670d\u52a1\u7ed9\u5916\u90e8\u7528\u6237\uff0c\u90a3\u5c31\u662f <code>Ingress</code>\u3002\u5bf9\u4e8e\u5c0f\u89c4\u6a21\u7684\u5e94\u7528\u6211\u4eec\u4f7f\u7528 NodePort \u6216\u8bb8\u80fd\u591f\u6ee1\u8db3\u6211\u4eec\u7684\u9700\u6c42\uff0c\u4f46\u662f\u5f53\u4f60\u7684\u5e94\u7528\u8d8a\u6765\u8d8a\u591a\u7684\u65f6\u5019\uff0c\u4f60\u5c31\u4f1a\u53d1\u73b0\u5bf9\u4e8e NodePort \u7684\u7ba1\u7406\u5c31\u975e\u5e38\u9ebb\u70e6\u4e86\uff0c\u8fd9\u4e2a\u65f6\u5019\u4f7f\u7528 Ingress \u5c31\u975e\u5e38\u65b9\u4fbf\u4e86\uff0c\u53ef\u4ee5\u907f\u514d\u7ba1\u7406\u5927\u91cf\u7684\u7aef\u53e3\u3002</p> <p>Ingress \u5176\u5b9e\u5c31\u662f\u4ece Kuberenets \u96c6\u7fa4\u5916\u90e8\u8bbf\u95ee\u96c6\u7fa4\u7684\u4e00\u4e2a\u5165\u53e3\uff0c\u5c06\u5916\u90e8\u7684\u8bf7\u6c42\u8f6c\u53d1\u5230\u96c6\u7fa4\u5185\u4e0d\u540c\u7684 Service \u4e0a\uff0c\u5176\u5b9e\u5c31\u76f8\u5f53\u4e8e nginx\u3001haproxy \u7b49\u8d1f\u8f7d\u5747\u8861\u4ee3\u7406\u670d\u52a1\u5668\uff0c\u53ef\u80fd\u4f60\u4f1a\u89c9\u5f97\u6211\u4eec\u76f4\u63a5\u4f7f\u7528 nginx \u5c31\u5b9e\u73b0\u4e86\uff0c\u4f46\u662f\u53ea\u4f7f\u7528 nginx \u8fd9\u79cd\u65b9\u5f0f\u6709\u5f88\u5927\u7f3a\u9677\uff0c\u6bcf\u6b21\u6709\u65b0\u670d\u52a1\u52a0\u5165\u7684\u65f6\u5019\u600e\u4e48\u6539 Nginx \u914d\u7f6e\uff1f\u4e0d\u53ef\u80fd\u8ba9\u6211\u4eec\u53bb\u624b\u52a8\u66f4\u6539\u6216\u8005\u6eda\u52a8\u66f4\u65b0\u524d\u7aef\u7684 Nginx Pod \u5427\uff1f\u90a3\u6211\u4eec\u518d\u52a0\u4e0a\u4e00\u4e2a\u670d\u52a1\u53d1\u73b0\u7684\u5de5\u5177\u6bd4\u5982 consul \u5982\u4f55\uff1f\u8c8c\u4f3c\u662f\u53ef\u4ee5\uff0c\u5bf9\u5427\uff1fIngress \u5b9e\u9645\u4e0a\u5c31\u662f\u8fd9\u6837\u5b9e\u73b0\u7684\uff0c\u53ea\u662f\u670d\u52a1\u53d1\u73b0\u7684\u529f\u80fd\u81ea\u5df1\u5b9e\u73b0\u4e86\uff0c\u4e0d\u9700\u8981\u4f7f\u7528\u7b2c\u4e09\u65b9\u7684\u670d\u52a1\u4e86\uff0c\u7136\u540e\u518d\u52a0\u4e0a\u4e00\u4e2a\u57df\u540d\u89c4\u5219\u5b9a\u4e49\uff0c\u8def\u7531\u4fe1\u606f\u7684\u5237\u65b0\u4f9d\u9760 Ingress Controller \u6765\u63d0\u4f9b\u3002</p> <p>Ingress Controller \u53ef\u4ee5\u7406\u89e3\u4e3a\u4e00\u4e2a\u76d1\u542c\u5668\uff0c\u901a\u8fc7\u4e0d\u65ad\u5730\u76d1\u542c kube-apiserver\uff0c\u5b9e\u65f6\u7684\u611f\u77e5\u540e\u7aef Service\u3001Pod \u7684\u53d8\u5316\uff0c\u5f53\u5f97\u5230\u8fd9\u4e9b\u4fe1\u606f\u53d8\u5316\u540e\uff0cIngress Controller \u518d\u7ed3\u5408 Ingress \u7684\u914d\u7f6e\uff0c\u66f4\u65b0\u53cd\u5411\u4ee3\u7406\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u8fbe\u5230\u670d\u52a1\u53d1\u73b0\u7684\u4f5c\u7528\u3002\u5176\u5b9e\u8fd9\u70b9\u548c\u670d\u52a1\u53d1\u73b0\u5de5\u5177 consul\u3001 consul-template \u975e\u5e38\u7c7b\u4f3c\u3002</p> <p></p> <p>\u73b0\u5728\u53ef\u4ee5\u4f9b\u5927\u5bb6\u4f7f\u7528\u7684 Ingress Controller \u6709\u5f88\u591a\uff0c\u6bd4\u5982 traefik\u3001nginx-controller\u3001Kubernetes Ingress Controller for Kong\u3001HAProxy Ingress controller\uff0c\u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u81ea\u5df1\u5b9e\u73b0\u4e00\u4e2a Ingress Controller\uff0c\u73b0\u5728\u666e\u904d\u7528\u5f97\u8f83\u591a\u7684\u662f traefik \u548c nginx-controller\uff0ctraefik \u7684\u6027\u80fd\u8f83 nginx-controller \u5dee\uff0c\u4f46\u662f\u914d\u7f6e\u4f7f\u7528\u8981\u7b80\u5355\u8bb8\u591a\uff0c\u6211\u4eec\u8fd9\u91cc\u4f1a\u91cd\u70b9\u7ed9\u5927\u5bb6\u4ecb\u7ecd nginx-controller \u4ee5\u53ca traefik \u7684\u4f7f\u7528\u3002</p>"},{"location":"kubernetes_network/ingress/nginx/#nginx_ingress_controller","title":"NGINX Ingress Controller","text":"<p>NGINX Ingress Controller \u662f\u4f7f\u7528 Kubernetes Ingress \u8d44\u6e90\u5bf9\u8c61\u6784\u5efa\u7684\uff0c\u7528 ConfigMap \u6765\u5b58\u50a8 Nginx \u914d\u7f6e\u7684\u4e00\u79cd Ingress Controller \u5b9e\u73b0\u3002</p> <p>\u8981\u4f7f\u7528 Ingress \u5bf9\u5916\u66b4\u9732\u670d\u52a1\uff0c\u5c31\u9700\u8981\u63d0\u524d\u5b89\u88c5\u4e00\u4e2a Ingress Controller\uff0c\u6211\u4eec\u8fd9\u91cc\u5c31\u5148\u6765\u5b89\u88c5 NGINX Ingress Controller\uff0c\u7531\u4e8e nginx-ingress \u6240\u5728\u7684\u8282\u70b9\u9700\u8981\u80fd\u591f\u8bbf\u95ee\u5916\u7f51\uff0c\u8fd9\u6837\u57df\u540d\u53ef\u4ee5\u89e3\u6790\u5230\u8fd9\u4e9b\u8282\u70b9\u4e0a\u76f4\u63a5\u4f7f\u7528\uff0c\u6240\u4ee5\u9700\u8981\u8ba9 nginx-ingress \u7ed1\u5b9a\u8282\u70b9\u7684 80 \u548c 443 \u7aef\u53e3\uff0c\u6240\u4ee5\u53ef\u4ee5\u4f7f\u7528 hostPort \u6765\u8fdb\u884c\u8bbf\u95ee\uff0c\u5f53\u7136\u5bf9\u4e8e\u7ebf\u4e0a\u73af\u5883\u6765\u8bf4\u4e3a\u4e86\u4fdd\u8bc1\u9ad8\u53ef\u7528\uff0c\u4e00\u822c\u662f\u9700\u8981\u8fd0\u884c\u591a\u4e2a nginx-ingress \u5b9e\u4f8b\u7684\uff0c\u7136\u540e\u53ef\u4ee5\u7528\u4e00\u4e2a nginx/haproxy \u4f5c\u4e3a\u5165\u53e3\uff0c\u901a\u8fc7 keepalived \u6765\u8bbf\u95ee\u8fb9\u7f18\u8282\u70b9\u7684 vip \u5730\u5740\u3002</p> <p>\u8fb9\u7f18\u8282\u70b9</p> <p>\u6240\u8c13\u7684\u8fb9\u7f18\u8282\u70b9\u5373\u96c6\u7fa4\u5185\u90e8\u7528\u6765\u5411\u96c6\u7fa4\u5916\u66b4\u9732\u670d\u52a1\u80fd\u529b\u7684\u8282\u70b9\uff0c\u96c6\u7fa4\u5916\u90e8\u7684\u670d\u52a1\u901a\u8fc7\u8be5\u8282\u70b9\u6765\u8c03\u7528\u96c6\u7fa4\u5185\u90e8\u7684\u670d\u52a1\uff0c\u8fb9\u7f18\u8282\u70b9\u662f\u96c6\u7fa4\u5185\u5916\u4ea4\u6d41\u7684\u4e00\u4e2aEndpoint\u3002</p> <p>\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u9700\u8981\u66f4\u6539\u4e0b\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff1a</p> <pre><code>$ wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-1/deploy/static/mandatory.yaml\n$ cat mandatory.yaml\n...\ntolerations:  # \u7531\u4e8e\u6211\u8fd9\u91cc\u7684\u8fb9\u7f18\u8282\u70b9\u53ea\u6709master\u4e00\u4e2a\u8282\u70b9\uff0c\u6240\u6709\u9700\u8981\u52a0\u4e0a\u5bb9\u5fcd\n- operator: \"Exists\"\nnodeSelector:  # \u56fa\u5b9a\u5728\u8fb9\u7f18\u8282\u70b9\n  kubernetes.io/hostname: ydzs-master\ncontainers:\n  - name: nginx-ingress-controller\n    image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:1\n    args:\n    - /nginx-ingress-controller\n    - --configmap=$(POD_NAMESPACE)/nginx-configuration\n    - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services\n    - --udp-services-configmap=$(POD_NAMESPACE)/udp-services\n    - --publish-service=$(POD_NAMESPACE)/ingress-nginx\n    - --annotations-prefix=nginx.ingress.kubernetes.io\n    securityContext:\n    allowPrivilegeEscalation: true\n    capabilities:\n      drop:\n        - ALL\n      add:\n        - NET_BIND_SERVICE\n    # www-data -&gt; 33\n    runAsUser: 33\n    env:\n    - name: POD_NAME\n      valueFrom:\n        fieldRef:\n          fieldPath: metadata.name\n    - name: POD_NAMESPACE\n      valueFrom:\n        fieldRef:\n          fieldPath: metadata.namespace\n    ports:\n    - name: http\n      hostPort: 80  # \u4f7f\u7528hostPort\n      containerPort: 80\n    - name: https\n      hostPort: 443  # \u4f7f\u7528hostPort\n      containerPort: 443\n...\n$ kubectl apply -f mandatory.yaml\n</code></pre> <p>\u5b89\u88c5\u540e\u4f1a\u5c06 NGINX Ingress Controller \u5b89\u88c5\u5728\u4e00\u4e2a\u7edf\u4e00\u7684 ingress-nginx \u7684 namespace \u4e0b\u9762\uff1a</p> <pre><code>$ kubectl get pods -n ingress-nginx\nNAME                                       READY   STATUS    RESTARTS   AGE\nnginx-ingress-controller-565459444-6m4cz   1/1     Running   0          38s\n</code></pre> <p>\u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 controller \u7684 Pod \u6240\u5728\u8282\u70b9\u4f7f\u7528\u5982\u4e0b\u65b9\u5f0f\u8fdb\u884c\u9a8c\u8bc1\uff1a</p> <pre><code>$ curl 11\n&lt;html&gt;\n&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;\n&lt;body&gt;\n&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;\n&lt;hr&gt;&lt;center&gt;openresty/2&lt;/center&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>\u51fa\u73b0\u4e86\u4e0a\u9762\u7684\u4fe1\u606f\u8bc1\u660e Ingress Controller \u5df2\u7ecf\u5b89\u88c5\u6210\u529f\u3002</p>"},{"location":"kubernetes_network/ingress/nginx/#ingress_1","title":"Ingress","text":"<p>\u5b89\u88c5\u6210\u529f\u540e\uff0c\u73b0\u5728\u6211\u4eec\u6765\u4e3a\u4e00\u4e2a nginx \u5e94\u7528\u521b\u5efa\u4e00\u4e2a Ingress \u8d44\u6e90\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: my-nginx\nspec:\n  selector:\n    matchLabels:\n      app: my-nginx\n  template:\n    metadata:\n      labels:\n        app: my-nginx\n    spec:\n      containers:\n      - name: my-nginx\n        image: nginx\n        ports:\n        - containerPort: 80\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: my-nginx\n  labels:\n    app: my-nginx\nspec:\n  ports:\n  - port: 80\n    protocol: TCP\n    name: http\n  selector:\n    app: my-nginx\n---\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: my-nginx\n  annotations:\n    kubernetes.io/ingress.class: \"nginx\"\nspec:\n  rules:\n  - host: ngdemo.qikqiak.com  # \u5c06\u57df\u540d\u6620\u5c04\u5230 my-nginx \u670d\u52a1\n    http:\n      paths:\n      - path: /\n        backend:\n          serviceName: my-nginx  # \u5c06\u6240\u6709\u8bf7\u6c42\u53d1\u9001\u5230 my-nginx \u670d\u52a1\u7684 80 \u7aef\u53e3\n          servicePort: 80     # \u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u5927\u90e8\u5206Ingress controller\u90fd\u4e0d\u662f\u76f4\u63a5\u8f6c\u53d1\u5230Service\n                            # \u800c\u662f\u53ea\u662f\u901a\u8fc7Service\u6765\u83b7\u53d6\u540e\u7aef\u7684Endpoints\u5217\u8868\uff0c\u76f4\u63a5\u8f6c\u53d1\u5230Pod\uff0c\u8fd9\u6837\u53ef\u4ee5\u51cf\u5c11\u7f51\u7edc\u8df3\u8f6c\uff0c\u63d0\u9ad8\u6027\u80fd\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f ngdemo.yaml\ndeployment.apps \"my-nginx\" created\nservice \"my-nginx\" created\ningress.extensions \"my-nginx\" created\n</code></pre> <p>\u6ce8\u610f\u6211\u4eec\u5728 Ingress \u8d44\u6e90\u5bf9\u8c61\u4e2d\u6dfb\u52a0\u4e86\u4e00\u4e2a annotations\uff1a</p> <pre><code>kubernetes.io/ingress.class: \"nginx\"\n</code></pre> <p>\uff0c\u8fd9\u5c31\u662f\u6307\u5b9a\u8ba9\u8fd9\u4e2a Ingress \u901a\u8fc7 nginx-ingress \u6765\u5904\u7406\u3002</p> <p>\u4e0a\u9762\u8d44\u6e90\u521b\u5efa\u6210\u529f\u540e\uff0c\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u5c06\u57df\u540d<code>ngdemo.qikqiak.com</code>\u89e3\u6790\u5230<code>nginx-ingress</code>\u6240\u5728\u7684<code>\u8fb9\u7f18\u8282\u70b9</code>\u4e2d\u7684\u4efb\u610f\u4e00\u4e2a\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u5728\u672c\u5730<code>/etc/hosts</code>\u4e2d\u6dfb\u52a0\u5bf9\u5e94\u7684\u6620\u5c04\u4e5f\u53ef\u4ee5\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u901a\u8fc7\u57df\u540d\u8fdb\u884c\u8bbf\u95ee\u4e86\u3002</p> <p></p> <p>\u4e0b\u56fe\u663e\u793a\u4e86\u5ba2\u6237\u7aef\u662f\u5982\u679c\u901a\u8fc7 Ingress Controller \u8fde\u63a5\u5230\u5176\u4e2d\u4e00\u4e2a Pod \u7684\u6d41\u7a0b\uff0c\u5ba2\u6237\u7aef\u9996\u5148\u5bf9 <code>ngdemo.qikqiak.com</code> \u6267\u884c DNS \u89e3\u6790\uff0c\u5f97\u5230 Ingress Controller \u6240\u5728\u8282\u70b9\u7684 IP\uff0c\u7136\u540e\u5ba2\u6237\u7aef\u5411 Ingress Controller \u53d1\u9001 HTTP \u8bf7\u6c42\uff0c\u7136\u540e\u6839\u636e Ingress \u5bf9\u8c61\u91cc\u9762\u7684\u63cf\u8ff0\u5339\u914d\u57df\u540d\uff0c\u627e\u5230\u5bf9\u5e94\u7684 Service \u5bf9\u8c61\uff0c\u5e76\u83b7\u53d6\u5173\u8054\u7684 Endpoints \u5217\u8868\uff0c\u5c06\u5ba2\u6237\u7aef\u7684\u8bf7\u6c42\u8f6c\u53d1\u7ed9\u5176\u4e2d\u4e00\u4e2a Pod\u3002</p> <p></p>"},{"location":"kubernetes_network/ingress/nginx/#url_rewrite","title":"URL Rewrite","text":"<p>NGINX Ingress Controller \u5f88\u591a\u9ad8\u7ea7\u7684\u7528\u6cd5\u53ef\u4ee5\u901a\u8fc7 Ingress \u5bf9\u8c61\u7684 <code>annotation</code> \u8fdb\u884c\u914d\u7f6e\uff0c\u6bd4\u5982\u5e38\u7528\u7684 URL Rewrite \u529f\u80fd\uff0c\u6bd4\u5982\u6211\u4eec\u6709\u4e00\u4e2a todo \u7684\u524d\u7aef\u5e94\u7528\uff0c\u5bf9\u5e94\u7684 Ingress \u8d44\u6e90\u5bf9\u8c61\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: fe\n  namespace: default\n  annotations:\n    kubernetes.io/ingress.class: \"nginx\"\nspec:\n  rules:\n  - host: todo.qikqiak.com\n    http:\n      paths:\n      - backend:\n          serviceName: fe\n          servicePort: 3000\n        path: /\n</code></pre> <p>\u5c31\u662f\u4e00\u4e2a\u5f88\u5e38\u89c4\u7684 <code>Ingress</code> \u5bf9\u8c61\uff0c\u90e8\u7f72\u8be5\u5bf9\u8c61\u540e\uff0c\u5c06\u57df\u540d\u89e3\u6790\u540e\u5c31\u53ef\u4ee5\u6b63\u5e38\u8bbf\u95ee\u5230\u5e94\u7528\uff1a</p> <p></p> <p>\u73b0\u5728\u6211\u4eec\u9700\u8981\u5bf9\u8bbf\u95ee\u7684 URL \u8def\u5f84\u505a\u4e00\u4e2a Rewrite\uff0c\u6bd4\u5982\u5728 PATH \u4e2d\u6dfb\u52a0\u4e00\u4e2a app \u7684\u524d\u7f00\uff0c\u5173\u4e8e Rewrite \u7684\u64cd\u4f5c\u5728 ingress-nginx \u5b98\u65b9\u6587\u6863\u4e2d\u4e5f\u7ed9\u51fa\u5bf9\u5e94\u7684\u8bf4\u660e:</p> <p></p> <p>\u6309\u7167\u8981\u6c42\u6211\u4eec\u9700\u8981\u5728 <code>path</code> \u4e2d\u5339\u914d\u524d\u7f00 <code>app</code>\uff0c\u7136\u540e\u901a\u8fc7 <code>rewrite-target</code> \u6307\u5b9a\u76ee\u6807\uff0c\u4fee\u6539\u540e\u7684 Ingress \u5bf9\u8c61\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: fe\n  namespace: default\n  annotations:\n    kubernetes.io/ingress.class: \"nginx\"\n    nginx.ingress.kubernetes.io/rewrite-target: /$2\nspec:\n  rules:\n  - host: todo.qikqiak.com\n    http:\n      paths:\n      - backend:\n          serviceName: fe\n          servicePort: 3000\n        path: /app(/|$)(.*)\n</code></pre> <p>\u66f4\u65b0\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u9047\u89c1\u5230\u76f4\u63a5\u8bbf\u95ee\u57df\u540d\u80af\u5b9a\u662f\u4e0d\u884c\u4e86\uff0c\u56e0\u4e3a\u6211\u4eec\u6ca1\u6709\u5339\u914d <code>/</code> \u7684 path \u8def\u5f84\uff1a</p> <p></p> <p>\u4f46\u662f\u6211\u4eec\u5e26\u4e0a <code>app</code> \u7684\u524d\u7f00\u518d\u53bb\u8bbf\u95ee:</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u53ef\u4ee5\u8bbf\u95ee\u5230\u9875\u9762\u5185\u5bb9\u4e86\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u5728 <code>path</code> \u4e2d\u901a\u8fc7\u6b63\u5219\u8868\u8fbe\u5f0f <code>/app(/|$)(.*)</code> \u5c06\u5339\u914d\u7684\u8def\u5f84\u8bbe\u7f6e\u6210\u4e86 <code>rewrite-target</code> \u7684\u76ee\u6807\u8def\u5f84\u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u8bbf\u95ee <code>todo.qikqiak.com/app</code> \u7684\u65f6\u5019\u5b9e\u9645\u4e0a\u76f8\u5f53\u4e8e\u8bbf\u95ee\u7684\u5c31\u662f\u540e\u7aef\u670d\u52a1\u7684 <code>/</code> \u8def\u5f84\uff0c\u4f46\u662f\u6211\u4eec\u4e5f\u53ef\u4ee5\u53d1\u73b0\u73b0\u5728\u9875\u9762\u7684\u6837\u5f0f\u6ca1\u6709\u4e86\uff1a</p> <p></p> <p>\u8fd9\u662f\u56e0\u4e3a\u5e94\u7528\u7684\u9759\u6001\u8d44\u6e90\u8def\u5f84\u662f\u5728 <code>/stylesheets</code> \u8def\u5f84\u4e0b\u9762\u7684\uff0c\u73b0\u5728\u6211\u4eec\u505a\u4e86 url rewrite \u8fc7\u540e\uff0c\u8981\u6b63\u5e38\u8bbf\u95ee\u4e5f\u9700\u8981\u5e26\u4e0a\u524d\u7f00\u624d\u53ef\u4ee5\uff1a</p> <pre><code>http://todo.qikqiak.com/stylesheets/screen.css\n</code></pre> <p>\uff0c\u5bf9\u4e8e\u56fe\u7247\u6216\u8005\u5176\u4ed6\u9759\u6001\u8d44\u6e90\u4e5f\u662f\u5982\u6b64\uff0c\u5f53\u7136\u6211\u4eec\u53bb\u66f4\u6539\u9875\u9762\u5f15\u5165\u9759\u6001\u8d44\u6e90\u7684\u65b9\u5f0f\u4e3a\u76f8\u5bf9\u8def\u5f84\u4e5f\u662f\u53ef\u4ee5\u7684\uff0c\u4f46\u662f\u6bd5\u7adf\u8981\u4fee\u6539\u4ee3\u7801\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u501f\u52a9 <code>ingress-nginx</code> \u4e2d\u7684 </p> <pre><code>configuration-snippet\n</code></pre> <p>\u6765\u5bf9\u9759\u6001\u8d44\u6e90\u505a\u4e00\u6b21\u8df3\u8f6c\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: fe\n  namespace: default\n  annotations:\n    kubernetes.io/ingress.class: \"nginx\"\n    nginx.ingress.kubernetes.io/rewrite-target: /$2\n    nginx.ingress.kubernetes.io/configuration-snippet: |\n      rewrite ^/stylesheets/(.*)$ /app/stylesheets/$1 redirect;  # \u6dfb\u52a0 /app \u524d\u7f00\n      rewrite ^/images/(.*)$ /app/images/$1 redirect;  # \u6dfb\u52a0 /app \u524d\u7f00\nspec:\n  rules:\n  - host: todo.qikqiak.com\n    http:\n      paths:\n      - backend:\n          serviceName: fe\n          servicePort: 3000\n        path: /app(/|$)(.*)\n</code></pre> <p>\u66f4\u65b0 Ingress \u5bf9\u8c61\u540e\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5237\u65b0\u9875\u9762\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u6b63\u5e38\u4e86\uff1a</p> <p></p> <p>\u8981\u89e3\u51b3\u6211\u4eec\u8bbf\u95ee\u4e3b\u57df\u540d\u51fa\u73b0 404 \u7684\u95ee\u9898\uff0c\u6211\u4eec\u53ef\u4ee5\u7ed9\u5e94\u7528\u8bbe\u7f6e\u4e00\u4e2a <code>app-root</code> \u7684\u6ce8\u89e3\uff0c\u8fd9\u6837\u5f53\u6211\u4eec\u8bbf\u95ee\u4e3b\u57df\u540d\u7684\u65f6\u5019\u4f1a\u81ea\u52a8\u8df3\u8f6c\u5230\u6211\u4eec\u6307\u5b9a\u7684 <code>app-root</code> \u76ee\u5f55\u4e0b\u9762\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: fe\n  namespace: default\n  annotations:\n    kubernetes.io/ingress.class: \"nginx\"\n    nginx.ingress.kubernetes.io/app-root: /app/\n    nginx.ingress.kubernetes.io/rewrite-target: /$2\n    nginx.ingress.kubernetes.io/configuration-snippet: |\n      rewrite ^/stylesheets/(.*)$ /app/stylesheets/$1 redirect;  # \u6dfb\u52a0 /app \u524d\u7f00\n      rewrite ^/images/(.*)$ /app/images/$1 redirect;  # \u6dfb\u52a0 /app \u524d\u7f00\nspec:\n  rules:\n  - host: todo.qikqiak.com\n    http:\n      paths:\n      - backend:\n          serviceName: fe\n          servicePort: 3000\n        path: /app(/|$)(.*)\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u66f4\u65b0\u5e94\u7528\u540e\u8bbf\u95ee\u4e3b\u57df\u540d </p> <pre><code>http://todo.qikqiak.com\n</code></pre> <p>\u5c31\u4f1a\u81ea\u52a8\u8df3\u8f6c\u5230 </p> <pre><code>http://todo.qikqiak.com/app/\n</code></pre> <p>\u8def\u5f84\u4e0b\u9762\u53bb\u4e86\u3002\u4f46\u662f\u8fd8\u6709\u4e00\u4e2a\u95ee\u9898\u662f\u6211\u4eec\u7684 path \u8def\u5f84\u5176\u5b9e\u4e5f\u5339\u914d\u4e86 <code>/app</code> \u8fd9\u6837\u7684\u8def\u5f84\uff0c\u53ef\u80fd\u6211\u4eec\u66f4\u52a0\u5e0c\u671b\u6211\u4eec\u7684\u5e94\u7528\u5728\u6700\u540e\u6dfb\u52a0\u4e00\u4e2a <code>/</code> \u8fd9\u6837\u7684 slash\uff0c\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 </p> <pre><code>configuration-snippet\n</code></pre> <p>\u914d\u7f6e\u6765\u5b8c\u6210\uff0c\u5982\u4e0b Ingress \u5bf9\u8c61\uff1a</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: fe\n  namespace: default\n  annotations:\n    kubernetes.io/ingress.class: \"nginx\"\n    nginx.ingress.kubernetes.io/app-root: /app/\n    nginx.ingress.kubernetes.io/rewrite-target: /$2\n    nginx.ingress.kubernetes.io/configuration-snippet: |\n      rewrite ^(/app)$ $1/ redirect;\n      rewrite ^/stylesheets/(.*)$ /app/stylesheets/$1 redirect;\n      rewrite ^/images/(.*)$ /app/images/$1 redirect;\nspec:\n  rules:\n  - host: todo.qikqiak.com\n    http:\n      paths:\n      - backend:\n          serviceName: fe\n          servicePort: 3000\n        path: /app(/|$)(.*)\n</code></pre> <p>\u66f4\u65b0\u540e\u6211\u4eec\u7684\u5e94\u7528\u5c31\u90fd\u4f1a\u4ee5 <code>/</code> \u8fd9\u6837\u7684 slash \u7ed3\u5c3e\u4e86\u3002\u8fd9\u6837\u5c31\u5b8c\u6210\u4e86\u6211\u4eec\u7684\u9700\u6c42\uff0c\u5982\u679c\u4f60\u539f\u672c\u5bf9 nginx \u7684\u914d\u7f6e\u5c31\u975e\u5e38\u719f\u6089\u7684\u8bdd\u5e94\u8be5\u53ef\u4ee5\u5f88\u5feb\u5c31\u80fd\u7406\u89e3\u8fd9\u79cd\u914d\u7f6e\u65b9\u5f0f\u4e86\u3002</p>"},{"location":"kubernetes_network/ingress/nginx/#basic_auth","title":"Basic Auth","text":"<p>\u540c\u6837\u6211\u4eec\u8fd8\u53ef\u4ee5\u5728 Ingress Controller \u4e0a\u9762\u914d\u7f6e\u4e00\u4e9b\u57fa\u672c\u7684 Auth \u8ba4\u8bc1\uff0c\u6bd4\u5982 Basic Auth\uff0c\u53ef\u4ee5\u7528 htpasswd \u751f\u6210\u4e00\u4e2a\u5bc6\u7801\u6587\u4ef6\u6765\u9a8c\u8bc1\u8eab\u4efd\u9a8c\u8bc1\u3002</p> <pre><code>$ htpasswd -c auth foo\nNew password:\nRe-type new password:\nAdding password for user foo\n</code></pre> <p>\u7136\u540e\u6839\u636e\u4e0a\u9762\u7684 auth \u6587\u4ef6\u521b\u5efa\u4e00\u4e2a secret \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create secret generic basic-auth --from-file=auth\nsecret/basic-auth created\n$ kubectl get secret basic-auth -o yaml\napiVersion: v1\ndata:\n  auth: Zm9vOiRhcHIxJFNjcVhZcFN6JDc4Nm5ISFNaeDdwN2VscDM2WUo0YS8K\nkind: Secret\nmetadata:\n  creationTimestamp: \"2019-12-08T06:40:39Z\"\n  name: basic-auth\n  namespace: default\n  resourceVersion: \"9197951\"\n  selfLink: /api/v1/namespaces/default/secrets/basic-auth\n  uid: 6b2aa299-b511-412e-85ea-d0e91e578af0\ntype: Opaque\n</code></pre> <p>\u7136\u540e\u5bf9\u4e0a\u9762\u7684 my-nginx \u5e94\u7528\u521b\u5efa\u4e00\u4e2a\u5177\u6709 Basic Auth \u7684 Ingress \u5bf9\u8c61\uff1a</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: ingress-with-auth\n  annotations:\n    # \u8ba4\u8bc1\u7c7b\u578b\n    nginx.ingress.kubernetes.io/auth-type: basic\n    # \u5305\u542b user/password \u5b9a\u4e49\u7684 secret \u5bf9\u8c61\u540d\n    nginx.ingress.kubernetes.io/auth-secret: basic-auth\n    # \u8981\u663e\u793a\u7684\u5e26\u6709\u9002\u5f53\u4e0a\u4e0b\u6587\u7684\u6d88\u606f\uff0c\u8bf4\u660e\u9700\u8981\u8eab\u4efd\u9a8c\u8bc1\u7684\u539f\u56e0\n    nginx.ingress.kubernetes.io/auth-realm: 'Authentication Required - foo'\nspec:\n  rules:\n  - host: foo.bar.com\n    http:\n      paths:\n      - path: /\n        backend:\n          serviceName: my-nginx\n          servicePort: 80\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u7136\u540e\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u6216\u8005\u5728\u6d4f\u89c8\u5668\u4e2d\u76f4\u63a5\u6253\u5f00\u914d\u7f6e\u7684\u57df\u540d\uff1a</p> <pre><code>$ curl -v http://k8s.youdianzhishi.com -H 'Host: foo.bar.com'\n* Rebuilt URL to: http://k8s.youdianzhishi.com/\n*   Trying 11..\n* TCP_NODELAY set\n* Connected to k8s.youdianzhishi.com (1111) port 80 (#0)\n&gt; GET / HTTP/1\n&gt; Host: foo.bar.com\n&gt; User-Agent: curl/0\n&gt; Accept: */*\n&gt;\n&lt; HTTP/1 401 Unauthorized\n&lt; Server: openresty/2\n&lt; Date: Sun, 08 Dec 2019 06:44:35 GMT\n&lt; Content-Type: text/html\n&lt; Content-Length: 185\n&lt; Connection: keep-alive\n&lt; WWW-Authenticate: Basic realm=\"Authentication Required - foo\"\n&lt;\n&lt;html&gt;\n&lt;head&gt;&lt;title&gt;401 Authorization Required&lt;/title&gt;&lt;/head&gt;\n&lt;body&gt;\n&lt;center&gt;&lt;h1&gt;401 Authorization Required&lt;/h1&gt;&lt;/center&gt;\n&lt;hr&gt;&lt;center&gt;openresty/2&lt;/center&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u51fa\u73b0\u4e86 401 \u8ba4\u8bc1\u5931\u8d25\u9519\u8bef\uff0c\u7136\u540e\u5e26\u4e0a\u6211\u4eec\u914d\u7f6e\u7684\u7528\u6237\u540d\u548c\u5bc6\u7801\u8fdb\u884c\u8ba4\u8bc1\uff1a</p> <pre><code>$ curl -v http://k8s.youdianzhishi.com -H 'Host: foo.bar.com' -u 'foo:foo'\n* Rebuilt URL to: http://k8s.youdianzhishi.com/\n*   Trying 11..\n* TCP_NODELAY set\n* Connected to k8s.youdianzhishi.com (1111) port 80 (#0)\n* Server auth using Basic with user 'foo'\n&gt; GET / HTTP/1\n&gt; Host: foo.bar.com\n&gt; Authorization: Basic Zm9vOmZvbw==\n&gt; User-Agent: curl/0\n&gt; Accept: */*\n&gt;\n&lt; HTTP/1 200 OK\n&lt; Server: openresty/2\n&lt; Date: Sun, 08 Dec 2019 06:46:27 GMT\n&lt; Content-Type: text/html\n&lt; Content-Length: 612\n&lt; Connection: keep-alive\n&lt; Vary: Accept-Encoding\n&lt; Last-Modified: Tue, 19 Nov 2019 12:50:08 GMT\n&lt; ETag: \"5dd3e500-264\"\n&lt; Accept-Ranges: bytes\n&lt;\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n    body {\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    }\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf\u8ba4\u8bc1\u6210\u529f\u4e86\u3002\u5f53\u7136\u51fa\u6765 Basic Auth \u8fd9\u4e00\u79cd\u7b80\u5355\u7684\u8ba4\u8bc1\u65b9\u5f0f\u4e4b\u5916\uff0cNGINX Ingress Controller \u8fd8\u652f\u6301\u4e00\u4e9b\u5176\u4ed6\u9ad8\u7ea7\u7684\u8ba4\u8bc1\uff0c\u6bd4\u5982 OAUTH \u8ba4\u8bc1\u4e4b\u7c7b\u7684\u3002</p>"},{"location":"kubernetes_network/ingress/nginx/#https","title":"HTTPS","text":"<p>\u5982\u679c\u6211\u4eec\u9700\u8981\u7528 HTTPS \u6765\u8bbf\u95ee\u6211\u4eec\u8fd9\u4e2a\u5e94\u7528\u7684\u8bdd\uff0c\u5c31\u9700\u8981\u76d1\u542c 443 \u7aef\u53e3\u4e86\uff0c\u540c\u6837\u7528 HTTPS \u8bbf\u95ee\u5e94\u7528\u5fc5\u7136\u5c31\u9700\u8981\u8bc1\u4e66\uff0c\u8fd9\u91cc\u6211\u4eec\u7528 <code>openssl</code> \u6765\u521b\u5efa\u4e00\u4e2a\u81ea\u7b7e\u540d\u7684\u8bc1\u4e66\uff1a</p> <pre><code>$ openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj \"/CN=foo.bar.com\"\n</code></pre> <p>\u7136\u540e\u901a\u8fc7 Secret \u5bf9\u8c61\u6765\u5f15\u7528\u8bc1\u4e66\u6587\u4ef6\uff1a</p> <pre><code># \u8981\u6ce8\u610f\u8bc1\u4e66\u6587\u4ef6\u540d\u79f0\u5fc5\u987b\u662f tls.crt \u548c tls.key\n$ kubectl create secret tls foo-tls --cert=tls.crt --key=tls.key\nsecret/who-tls created\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a HTTPS \u8bbf\u95ee\u5e94\u7528\u7684\uff1a</p> <pre><code>apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: ingress-with-auth\n  annotations:\n    # \u8ba4\u8bc1\u7c7b\u578b\n    nginx.ingress.kubernetes.io/auth-type: basic\n    # \u5305\u542b user/password \u5b9a\u4e49\u7684 secret \u5bf9\u8c61\u540d\n    nginx.ingress.kubernetes.io/auth-secret: basic-auth\n    # \u8981\u663e\u793a\u7684\u5e26\u6709\u9002\u5f53\u4e0a\u4e0b\u6587\u7684\u6d88\u606f\uff0c\u8bf4\u660e\u9700\u8981\u8eab\u4efd\u9a8c\u8bc1\u7684\u539f\u56e0\n    nginx.ingress.kubernetes.io/auth-realm: 'Authentication Required - foo'\nspec:\n  rules:\n  - host: foo.bar.com\n    http:\n      paths:\n      - path: /\n        backend:\n          serviceName: my-nginx\n          servicePort: 80\n  tls:\n  - hosts:\n    - foo.bar.com\n    secretName: foo-tls\n</code></pre>"},{"location":"kubernetes_network/ingress/traefik/","title":"Traefik","text":"<p>\ue3c9</p>"},{"location":"kubernetes_network/ingress/traefik/#traefik","title":"Traefik","text":"<p>Traefik \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u53ef\u4ee5\u4f7f\u670d\u52a1\u53d1\u5e03\u53d8\u5f97\u8f7b\u677e\u6709\u8da3\u7684\u8fb9\u7f18\u8def\u7531\u5668\u3002\u5b83\u8d1f\u8d23\u63a5\u6536\u4f60\u7cfb\u7edf\u7684\u8bf7\u6c42\uff0c\u7136\u540e\u4f7f\u7528\u5408\u9002\u7684\u7ec4\u4ef6\u6765\u5bf9\u8fd9\u4e9b\u8bf7\u6c42\u8fdb\u884c\u5904\u7406\u3002</p> <p></p> <p>\u9664\u4e86\u4f17\u591a\u7684\u529f\u80fd\u4e4b\u5916\uff0cTraefik \u7684\u4e0e\u4f17\u4e0d\u540c\u4e4b\u5904\u8fd8\u5728\u4e8e\u5b83\u4f1a\u81ea\u52a8\u53d1\u73b0\u9002\u5408\u4f60\u670d\u52a1\u7684\u914d\u7f6e\u3002\u5f53 Traefik \u5728\u68c0\u67e5\u4f60\u7684\u670d\u52a1\u65f6\uff0c\u4f1a\u627e\u5230\u670d\u52a1\u7684\u76f8\u5173\u4fe1\u606f\u5e76\u627e\u5230\u5408\u9002\u7684\u670d\u52a1\u6765\u6ee1\u8db3\u5bf9\u5e94\u7684\u8bf7\u6c42\u3002</p> <p>Traefik \u517c\u5bb9\u6240\u6709\u4e3b\u6d41\u7684\u96c6\u7fa4\u6280\u672f\uff0c\u6bd4\u5982 Kubernetes\uff0cDocker\uff0cDocker Swarm\uff0cAWS\uff0cMesos\uff0cMarathon\uff0c\u7b49\u7b49\uff1b\u5e76\u4e14\u53ef\u4ee5\u540c\u65f6\u5904\u7406\u591a\u79cd\u65b9\u5f0f\u3002\uff08\u751a\u81f3\u53ef\u4ee5\u7528\u4e8e\u5728\u88f8\u673a\u4e0a\u8fd0\u884c\u7684\u6bd4\u8f83\u65e7\u7684\u8f6f\u4ef6\u3002\uff09</p> <p>\u4f7f\u7528 Traefik\uff0c\u4e0d\u9700\u8981\u7ef4\u62a4\u6216\u8005\u540c\u6b65\u4e00\u4e2a\u72ec\u7acb\u7684\u914d\u7f6e\u6587\u4ef6\uff1a\u56e0\u4e3a\u4e00\u5207\u90fd\u4f1a\u81ea\u52a8\u914d\u7f6e\uff0c\u5b9e\u65f6\u64cd\u4f5c\u7684\uff08\u65e0\u9700\u91cd\u65b0\u542f\u52a8\uff0c\u4e0d\u4f1a\u4e2d\u65ad\u8fde\u63a5\uff09\u3002\u4f7f\u7528 Traefik\uff0c\u4f60\u53ef\u4ee5\u82b1\u66f4\u591a\u7684\u65f6\u95f4\u5728\u7cfb\u7edf\u7684\u5f00\u53d1\u548c\u65b0\u529f\u80fd\u4e0a\u9762\uff0c\u800c\u4e0d\u662f\u5728\u914d\u7f6e\u548c\u7ef4\u62a4\u5de5\u4f5c\u72b6\u6001\u4e0a\u9762\u82b1\u8d39\u5927\u91cf\u65f6\u95f4\u3002</p>"},{"location":"kubernetes_network/ingress/traefik/#_1","title":"\u6838\u5fc3\u6982\u5ff5","text":"<p>Traefik \u662f\u4e00\u4e2a\u8fb9\u7f18\u8def\u7531\u5668\uff0c\u662f\u4f60\u6574\u4e2a\u5e73\u53f0\u7684\u5927\u95e8\uff0c\u62e6\u622a\u5e76\u8def\u7531\u6bcf\u4e2a\u4f20\u5165\u7684\u8bf7\u6c42\uff1a\u5b83\u77e5\u9053\u6240\u6709\u7684\u903b\u8f91\u548c\u89c4\u5219\uff0c\u8fd9\u4e9b\u89c4\u5219\u786e\u5b9a\u54ea\u4e9b\u670d\u52a1\u5904\u7406\u54ea\u4e9b\u8bf7\u6c42\uff1b\u4f20\u7edf\u7684\u53cd\u5411\u4ee3\u7406\u9700\u8981\u4e00\u4e2a\u914d\u7f6e\u6587\u4ef6\uff0c\u5176\u4e2d\u5305\u542b\u8def\u7531\u5230\u4f60\u670d\u52a1\u7684\u6240\u6709\u53ef\u80fd\u8def\u7531\uff0c\u800c Traefik \u4f1a\u5b9e\u65f6\u68c0\u6d4b\u670d\u52a1\u5e76\u81ea\u52a8\u66f4\u65b0\u8def\u7531\u89c4\u5219\uff0c\u53ef\u4ee5\u81ea\u52a8\u670d\u52a1\u53d1\u73b0\u3002</p> <p></p> <p>\u9996\u5148\uff0c\u5f53\u542f\u52a8 Traefik \u65f6\uff0c\u9700\u8981\u5b9a\u4e49 <code>entrypoints</code>\uff08\u5165\u53e3\u70b9\uff09\uff0c\u7136\u540e\uff0c\u6839\u636e\u8fde\u63a5\u5230\u8fd9\u4e9b entrypoints \u7684<code>\u8def\u7531</code>\u6765\u5206\u6790\u4f20\u5165\u7684\u8bf7\u6c42\uff0c\u6765\u67e5\u770b\u4ed6\u4eec\u662f\u5426\u4e0e\u4e00\u7ec4<code>\u89c4\u5219</code>\u76f8\u5339\u914d\uff0c\u5982\u679c\u5339\u914d\uff0c\u5219\u8def\u7531\u53ef\u80fd\u4f1a\u5c06\u8bf7\u6c42\u901a\u8fc7\u4e00\u7cfb\u5217<code>\u4e2d\u95f4\u4ef6</code>\u8f6c\u6362\u8fc7\u540e\u518d\u8f6c\u53d1\u5230\u4f60\u7684<code>\u670d\u52a1</code>\u4e0a\u53bb\u3002\u5728\u4e86\u89e3 Traefik \u4e4b\u524d\u6709\u51e0\u4e2a\u6838\u5fc3\u6982\u5ff5\u6211\u4eec\u5fc5\u987b\u8981\u4e86\u89e3\uff1a</p> <ul> <li><code>Providers</code>\u00a0\u7528\u6765\u81ea\u52a8\u53d1\u73b0\u5e73\u53f0\u4e0a\u7684\u670d\u52a1\uff0c\u53ef\u4ee5\u662f\u7f16\u6392\u5de5\u5177\u3001\u5bb9\u5668\u5f15\u64ce\u6216\u8005 key-value \u5b58\u50a8\u7b49\uff0c\u6bd4\u5982 Docker\u3001Kubernetes\u3001File</li> <li><code>Entrypoints</code>\u00a0\u76d1\u542c\u4f20\u5165\u7684\u6d41\u91cf\uff08\u7aef\u53e3\u7b49\u2026\uff09\uff0c\u662f\u7f51\u7edc\u5165\u53e3\u70b9\uff0c\u5b83\u4eec\u5b9a\u4e49\u4e86\u63a5\u6536\u8bf7\u6c42\u7684\u7aef\u53e3\uff08HTTP \u6216\u8005 TCP\uff09\u3002</li> <li><code>Routers</code>\u00a0\u5206\u6790\u8bf7\u6c42\uff08host, path, headers, SSL, \u2026\uff09\uff0c\u8d1f\u8d23\u5c06\u4f20\u5165\u8bf7\u6c42\u8fde\u63a5\u5230\u53ef\u4ee5\u5904\u7406\u8fd9\u4e9b\u8bf7\u6c42\u7684\u670d\u52a1\u4e0a\u53bb\u3002</li> <li><code>Services</code>\u00a0\u5c06\u8bf7\u6c42\u8f6c\u53d1\u7ed9\u4f60\u7684\u5e94\u7528\uff08load balancing, \u2026\uff09\uff0c\u8d1f\u8d23\u914d\u7f6e\u5982\u4f55\u83b7\u53d6\u6700\u7ec8\u5c06\u5904\u7406\u4f20\u5165\u8bf7\u6c42\u7684\u5b9e\u9645\u670d\u52a1\u3002</li> <li><code>Middlewares</code>\u00a0\u4e2d\u95f4\u4ef6\uff0c\u7528\u6765\u4fee\u6539\u8bf7\u6c42\u6216\u8005\u6839\u636e\u8bf7\u6c42\u6765\u505a\u51fa\u4e00\u4e9b\u5224\u65ad\uff08authentication, rate limiting, headers, ...\uff09\uff0c\u4e2d\u95f4\u4ef6\u88ab\u9644\u4ef6\u5230\u8def\u7531\u4e0a\uff0c\u662f\u4e00\u79cd\u5728\u8bf7\u6c42\u53d1\u9001\u5230\u4f60\u7684<code>\u670d\u52a1</code>\u4e4b\u524d\uff08\u6216\u8005\u5728\u670d\u52a1\u7684\u54cd\u5e94\u53d1\u9001\u5230\u5ba2\u6237\u7aef\u4e4b\u524d\uff09\u8c03\u6574\u8bf7\u6c42\u7684\u4e00\u79cd\u65b9\u6cd5\u3002</li> </ul>"},{"location":"kubernetes_network/ingress/traefik/#_2","title":"\u5b89\u88c5","text":"<p>\u7531\u4e8e Traefik 2.X \u7248\u672c\u548c\u4e4b\u524d\u7684 1.X \u7248\u672c\u4e0d\u517c\u5bb9\uff0c\u6211\u4eec\u8fd9\u91cc\u9009\u62e9\u529f\u80fd\u66f4\u52a0\u5f3a\u5927\u7684 2.X \u7248\u672c\u6765\u548c\u5927\u5bb6\u8fdb\u884c\u8bb2\u89e3\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u955c\u50cf\u662f <code>traefik:2.1.1</code>\u3002</p> <p>\u5728 Traefik \u4e2d\u7684\u914d\u7f6e\u53ef\u4ee5\u4f7f\u7528\u4e24\u79cd\u4e0d\u540c\u7684\u65b9\u5f0f\uff1a</p> <ul> <li>\u52a8\u6001\u914d\u7f6e\uff1a\u5b8c\u5168\u52a8\u6001\u7684\u8def\u7531\u914d\u7f6e</li> <li>\u9759\u6001\u914d\u7f6e\uff1a\u542f\u52a8\u914d\u7f6e</li> </ul> <p><code>\u9759\u6001\u914d\u7f6e</code>\u4e2d\u7684\u5143\u7d20\uff08\u8fd9\u4e9b\u5143\u7d20\u4e0d\u4f1a\u7ecf\u5e38\u66f4\u6539\uff09\u8fde\u63a5\u5230 providers \u5e76\u5b9a\u4e49 Treafik \u5c06\u8981\u76d1\u542c\u7684 entrypoints\u3002</p> <p>\u5728 Traefik \u4e2d\u6709\u4e09\u79cd\u65b9\u5f0f\u5b9a\u4e49\u9759\u6001\u914d\u7f6e\uff1a\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u3001\u5728\u547d\u4ee4\u884c\u53c2\u6570\u4e2d\u3001\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u4f20\u9012</p> <p><code>\u52a8\u6001\u914d\u7f6e</code>\u5305\u542b\u5b9a\u4e49\u7cfb\u7edf\u5982\u4f55\u5904\u7406\u8bf7\u6c42\u7684\u6240\u6709\u914d\u7f6e\u5185\u5bb9\uff0c\u8fd9\u4e9b\u914d\u7f6e\u662f\u53ef\u4ee5\u6539\u53d8\u7684\uff0c\u800c\u4e14\u662f\u65e0\u7f1d\u70ed\u66f4\u65b0\u7684\uff0c\u6ca1\u6709\u4efb\u4f55\u8bf7\u6c42\u4e2d\u65ad\u6216\u8fde\u63a5\u635f\u8017\u3002</p> <p>\u5b89\u88c5 Traefik \u5230 Kubernetes \u96c6\u7fa4\u4e2d\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u6211\u8fd9\u91cc\u63d0\u524d\u51c6\u5907\u597d\u4e86\uff0c\u76f4\u63a5\u6267\u884c\u4e0b\u9762\u7684\u5b89\u88c5\u547d\u4ee4\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f https://www.qikqiak.com/k8strain/network/manifests/traefik/crd.yaml\n$ kubectl apply -f https://www.qikqiak.com/k8strain/network/manifests/traefik/rbac.yaml\n$ kubectl apply -f https://www.qikqiak.com/k8strain/network/manifests/traefik/deployment.yaml\n$ kubectl apply -f https://www.qikqiak.com/k8strain/network/manifests/traefik/dashboard.yaml\n</code></pre> <p>\u5176\u4e2d <code>deployment.yaml</code> \u6211\u8fd9\u91cc\u662f\u56fa\u5b9a\u5230 master \u8282\u70b9\u4e0a\u7684\uff0c\u5982\u679c\u4f60\u9700\u8981\u4fee\u6539\u53ef\u4ee5\u4e0b\u8f7d\u4e0b\u6765\u505a\u76f8\u5e94\u7684\u4fee\u6539\u5373\u53ef\u3002\u6211\u4eec\u8fd9\u91cc\u662f\u901a\u8fc7\u547d\u4ee4\u884c\u53c2\u6570\u6765\u505a\u7684\u9759\u6001\u914d\u7f6e\uff1a</p> <pre><code>args:\n- --entryPoints.web.address=:80\n- --entryPoints.websecure.address=:443\n- --api=true\n- --api.dashboard=true\n- --ping=true\n- --providers.kubernetesingress\n- --providers.kubernetescrd\n- --log.level=INFO\n- --accesslog\n</code></pre> <p>\u5176\u4e2d\u524d\u4e24\u9879\u914d\u7f6e\u662f\u6765\u5b9a\u4e49 <code>web</code> \u548c <code>websecure</code> \u8fd9\u4e24\u4e2a\u5165\u53e3\u70b9\u7684\uff0c<code>--api=true</code> \u5f00\u542f,=\uff0c\u5c31\u4f1a\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a <code>api@internal</code> \u7684\u7279\u6b8a service\uff0c\u5728 dashboard \u4e2d\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a service \u6765\u8bbf\u95ee\uff0c\u7136\u540e\u5176\u4ed6\u6bd4\u8f83\u91cd\u8981\u7684\u5c31\u662f\u5f00\u542f <code>kubernetesingress</code> \u548c <code>kubernetescrd</code> \u8fd9\u4e24\u4e2a provider\u3002</p> <p><code>dashboard.yaml</code> \u4e2d\u5b9a\u4e49\u7684\u662f\u8bbf\u95ee dashboard \u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u4fee\u6539\u3002</p> <pre><code>$ kubectl get pods -n kube-system                       \nNAME                                  READY   STATUS    RESTARTS   AGE\ntraefik-867bd6b9c-lbrlx               1/1     Running   0          6m17s\n......\n$ kubectl get ingressroute\nNAME                 AGE\ntraefik-dashboard    30m\n</code></pre> <p>\u90e8\u7f72\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5728\u672c\u5730 <code>/etc/hosts</code> \u4e2d\u6dfb\u52a0\u4e0a\u57df\u540d <code>traefik.domain.com</code> \u7684\u6620\u5c04\u5373\u53ef\u8bbf\u95ee Traefik \u7684 Dashboard \u9875\u9762\u4e86\uff1a</p> <p></p>"},{"location":"kubernetes_network/ingress/traefik/#acme","title":"ACME","text":"<p>Traefik \u901a\u8fc7\u6269\u5c55 CRD \u7684\u65b9\u5f0f\u6765\u6269\u5c55 Ingress \u7684\u529f\u80fd\uff0c\u9664\u4e86\u9ed8\u8ba4\u7684\u7528 Secret \u7684\u65b9\u5f0f\u53ef\u4ee5\u652f\u6301\u5e94\u7528\u7684 HTTPS \u4e4b\u5916\uff0c\u8fd8\u652f\u6301\u81ea\u52a8\u751f\u6210 HTTPS \u8bc1\u4e66\u3002</p> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u6709\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 <code>whoami</code> \u5e94\u7528\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: whoami\nspec:\n  ports:\n    - protocol: TCP\n      name: web\n      port: 80\n  selector:\n    app: whoami\n---\nkind: Deployment\napiVersion: apps/v1\nmetadata:\n  name: whoami\n  labels:\n    app: whoami\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: whoami\n  template:\n    metadata:\n      labels:\n        app: whoami\n    spec:\n      containers:\n        - name: whoami\n          image: containous/whoami\n          ports:\n            - name: web\n              containerPort: 80\n</code></pre> <p>\u7136\u540e\u5b9a\u4e49\u4e00\u4e2a IngressRoute \u5bf9\u8c61\uff1a</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: simpleingressroute\nspec:\n  entryPoints:\n    - web\n  routes:\n  - match: Host(`who.qikqiak.com`) &amp;&amp; PathPrefix(`/notls`)\n    kind: Rule\n    services:\n    - name: whoami\n      port: 80\n</code></pre> <p>\u901a\u8fc7 <code>entryPoints</code> \u6307\u5b9a\u4e86\u6211\u4eec\u8fd9\u4e2a\u5e94\u7528\u7684\u5165\u53e3\u70b9\u662f <code>web</code>\uff0c\u4e5f\u5c31\u662f\u901a\u8fc7 80 \u7aef\u53e3\u8bbf\u95ee\uff0c\u7136\u540e\u8bbf\u95ee\u7684\u89c4\u5219\u5c31\u662f\u8981\u5339\u914d <code>who.qikqiak.com</code> \u8fd9\u4e2a\u57df\u540d\uff0c\u5e76\u4e14\u5177\u6709 <code>/notls</code> \u7684\u8def\u5f84\u524d\u7f00\u7684\u8bf7\u6c42\u624d\u4f1a\u88ab <code>whoami</code> \u8fd9\u4e2a Service \u6240\u5339\u914d\u3002\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u51e0\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff0c\u7136\u540e\u5bf9\u57df\u540d\u505a\u5bf9\u5e94\u7684\u89e3\u6790\u540e\uff0c\u5c31\u53ef\u4ee5\u8bbf\u95ee\u5e94\u7528\u4e86\uff1a</p> <p></p> <p>\u5728 <code>IngressRoute</code> \u5bf9\u8c61\u4e2d\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e9b\u5339\u914d\u89c4\u5219\uff0c\u8fd9\u4e9b\u89c4\u5219\u5728 Traefik \u4e2d\u6709\u5982\u4e0b\u5b9a\u4e49\u65b9\u5f0f\uff1a</p> <p></p> <p>\u5982\u679c\u6211\u4eec\u9700\u8981\u7528 HTTPS \u6765\u8bbf\u95ee\u6211\u4eec\u8fd9\u4e2a\u5e94\u7528\u7684\u8bdd\uff0c\u5c31\u9700\u8981\u76d1\u542c <code>websecure</code> \u8fd9\u4e2a\u5165\u53e3\u70b9\uff0c\u4e5f\u5c31\u662f\u901a\u8fc7 443 \u7aef\u53e3\u6765\u8bbf\u95ee\uff0c\u540c\u6837\u7528 HTTPS \u8bbf\u95ee\u5e94\u7528\u5fc5\u7136\u5c31\u9700\u8981\u8bc1\u4e66\uff0c\u8fd9\u91cc\u6211\u4eec\u7528 <code>openssl</code> \u6765\u521b\u5efa\u4e00\u4e2a\u81ea\u7b7e\u540d\u7684\u8bc1\u4e66\uff1a</p> <pre><code>$ openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj \"/CN=who.qikqiak.com\"\n</code></pre> <p>\u7136\u540e\u901a\u8fc7 Secret \u5bf9\u8c61\u6765\u5f15\u7528\u8bc1\u4e66\u6587\u4ef6\uff1a</p> <pre><code># \u8981\u6ce8\u610f\u8bc1\u4e66\u6587\u4ef6\u540d\u79f0\u5fc5\u987b\u662f tls.crt \u548c tls.key\n$ kubectl create secret tls who-tls --cert=tls.crt --key=tls.key\nsecret/who-tls created\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a HTTPS \u8bbf\u95ee\u5e94\u7528\u7684 IngressRoute \u5bf9\u8c61\u4e86\uff1a</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: ingressroutetls\nspec:\n  entryPoints:\n    - websecure\n  routes:\n  - match: Host(`who.qikqiak.com`) &amp;&amp; PathPrefix(`/tls`)\n    kind: Rule\n    services:\n    - name: whoami\n      port: 80\n  tls:\n    secretName: who-tls\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u5c31\u53ef\u4ee5\u901a\u8fc7 HTTPS \u6765\u8bbf\u95ee\u5e94\u7528\u4e86\uff0c\u7531\u4e8e\u6211\u4eec\u662f\u81ea\u7b7e\u540d\u7684\u8bc1\u4e66\uff0c\u6240\u4ee5\u8bc1\u4e66\u662f\u4e0d\u53d7\u4fe1\u4efb\u7684\uff1a</p> <p></p> <p>\u9664\u4e86\u624b\u52a8\u63d0\u4f9b\u8bc1\u4e66\u7684\u65b9\u5f0f\u4e4b\u5916 Traefik \u8fd8\u652f\u6301\u4f7f\u7528 <code>Let\u2019s Encrypt</code> \u81ea\u52a8\u751f\u6210\u8bc1\u4e66\uff0c\u8981\u4f7f\u7528 <code>Let\u2019s Encrypt</code> \u6765\u8fdb\u884c\u81ea\u52a8\u5316 HTTPS\uff0c\u5c31\u9700\u8981\u9996\u5148\u5f00\u542f <code>ACME</code>\uff0c\u5f00\u542f <code>ACME</code> \u9700\u8981\u901a\u8fc7\u9759\u6001\u914d\u7f6e\u7684\u65b9\u5f0f\uff0c\u4e5f\u5c31\u662f\u8bf4\u53ef\u4ee5\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u3001\u542f\u52a8\u53c2\u6570\u7b49\u65b9\u5f0f\u6765\u63d0\u4f9b\uff0c\u6211\u4eec\u8fd9\u91cc\u8fd8\u662f\u76f4\u63a5\u4f7f\u7528\u542f\u52a8\u53c2\u6570\u7684\u5f62\u5f0f\u6765\u5f00\u542f\uff0c\u5728 Traefik \u7684\u90e8\u7f72\u6587\u4ef6\u4e2d\u6dfb\u52a0\u5982\u4e0b\u547d\u4ee4\u884c\u53c2\u6570\uff1a</p> <pre><code>args:\n......\n# \u4f7f\u7528 dns \u9a8c\u8bc1\u65b9\u5f0f\n- --certificatesResolvers.ali.acme.dnsChallenge.provider=alidns\n# \u90ae\u7bb1\u914d\u7f6e\n- --certificatesResolvers.ali.acme.email=ych_1024@1com\n# \u4fdd\u5b58 ACME \u8bc1\u4e66\u7684\u4f4d\u7f6e\n- --certificatesResolvers.ali.acme.storage=/etc/acme/acme.json\n</code></pre> <p>ACME \u6709\u591a\u79cd\u6821\u9a8c\u65b9\u5f0f <code>tlsChallenge</code>\u3001<code>httpChallenge</code> \u548c <code>dnsChallenge</code> \u4e09\u79cd\u9a8c\u8bc1\u65b9\u5f0f\uff0c\u4e4b\u524d\u66f4\u5e38\u7528\u7684\u662f http \u8fd9\u79cd\u9a8c\u8bc1\u65b9\u5f0f\uff0c\u5173\u4e8e\u8fd9\u51e0\u79cd\u9a8c\u8bc1\u65b9\u5f0f\u7684\u4f7f\u7528\u53ef\u4ee5\u67e5\u770b\u6587\u6863\uff1ahttps://www.qikqiak.com/traefik-book/https/acme/ \u4e86\u89e3\u4ed6\u4eec\u4e4b\u95f4\u7684\u533a\u522b\u3002\u8981\u4f7f\u7528 tls \u6821\u9a8c\u65b9\u5f0f\u7684\u8bdd\u9700\u8981\u4fdd\u8bc1 Traefik \u7684 443 \u7aef\u53e3\u662f\u53ef\u8fbe\u7684\uff0cdns \u6821\u9a8c\u65b9\u5f0f\u53ef\u4ee5\u751f\u6210\u901a\u914d\u7b26\u7684\u8bc1\u4e66\uff0c\u53ea\u9700\u8981\u914d\u7f6e\u4e0a DNS \u89e3\u6790\u670d\u52a1\u5546\u7684 API \u8bbf\u95ee\u5bc6\u94a5\u5373\u53ef\u6821\u9a8c\u3002\u6211\u4eec\u8fd9\u91cc\u7528 DNS \u6821\u9a8c\u7684\u65b9\u5f0f\u6765\u4e3a\u5927\u5bb6\u8bf4\u660e\u5982\u4f55\u914d\u7f6e ACME\u3002</p> <p>\u4e0a\u9762\u6211\u4eec\u901a\u8fc7\u8bbe\u7f6e </p> <pre><code>--certificatesResolvers.ali.acme.dnsChallenge.provider=alidns\n</code></pre> <p>\u53c2\u6570\u6765\u6307\u5b9a\u6307\u5b9a\u963f\u91cc\u4e91\u7684 DNS \u6821\u9a8c\uff0c\u8981\u4f7f\u7528\u963f\u91cc\u4e91\u7684 DNS \u6821\u9a8c\u6211\u4eec\u8fd8\u9700\u8981\u914d\u7f6e3\u4e2a\u73af\u5883\u53d8\u91cf\uff1a<code>ALICLOUD_ACCESS_KEY</code>\u3001<code>ALICLOUD_SECRET_KEY</code>\u3001<code>ALICLOUD_REGION_ID</code>\uff0c\u5206\u522b\u5bf9\u5e94\u6211\u4eec\u5e73\u65f6\u5f00\u53d1\u963f\u91cc\u4e91\u5e94\u7528\u7684\u65f6\u5019\u7684\u5bc6\u94a5\uff0c\u53ef\u4ee5\u767b\u5f55\u963f\u91cc\u4e91\u540e\u53f0\u83b7\u53d6\uff0c\u7531\u4e8e\u8fd9\u662f\u6bd4\u8f83\u79c1\u5bc6\u7684\u4fe1\u606f\uff0c\u6240\u4ee5\u6211\u4eec\u7528 Secret \u5bf9\u8c61\u6765\u521b\u5efa\uff1a</p> <pre><code>$ kubectl create secret generic traefik-alidns-secret --from-literal=ALICLOUD_ACCESS_KEY=&lt;aliyun ak&gt; --from-literal=ALICLOUD_SECRET_KEY=&lt;aliyun sk&gt;--from-literal=ALICLOUD_REGION_ID=cn-beijing -n kube-system\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u5c06\u8fd9\u4e2a Secret \u901a\u8fc7\u73af\u5883\u53d8\u91cf\u914d\u7f6e\u5230 Traefik \u7684\u5e94\u7528\u4e2d\u3002\u8fd8\u6709\u4e00\u4e2a\u503c\u5f97\u6ce8\u610f\u7684\u662f\u9a8c\u8bc1\u901a\u8fc7\u7684\u8bc1\u4e66\u6211\u4eec\u8fd9\u91cc\u5b58\u5230 <code>/etc/acme/acme.json</code> \u6587\u4ef6\u4e2d\uff0c\u6211\u4eec\u4e00\u5b9a\u8981\u5c06\u8fd9\u4e2a\u6587\u4ef6\u6301\u4e45\u5316\uff0c\u5426\u5219\u6bcf\u6b21 Traefik \u91cd\u5efa\u540e\u5c31\u9700\u8981\u91cd\u65b0\u8ba4\u8bc1\uff0c\u800c <code>Let\u2019s Encrypt</code> \u672c\u8eab\u6821\u9a8c\u6b21\u6570\u662f\u6709\u9650\u5236\u7684\u3002\u6700\u540e\u6211\u4eec\u8fd9\u91cc\u5b8c\u6574\u7684 Traefik \u7684\u914d\u7f6e\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: traefik\n  namespace: kube-system\n  labels:\n    app: traefik\nspec:\n  selector:\n    matchLabels:\n      app: traefik\n  template:\n    metadata:\n      labels:\n        app: traefik\n    spec:\n      serviceAccountName: traefik\n      terminationGracePeriodSeconds: 60\n      tolerations:\n      - operator: \"Exists\"\n      nodeSelector:\n        kubernetes.io/hostname: ydzs-master\n      volumes:\n      - name: acme\n        hostPath:\n          path: /data/k8s/traefik/acme\n      containers:\n      - image: traefik:1\n        name: traefik\n        ports:\n        - name: web\n          containerPort: 80\n          hostPort: 80\n        - name: websecure\n          containerPort: 443\n          hostPort: 443\n        args:\n        - --entryPoints.web.address=:80\n        - --entryPoints.websecure.address=:443\n        - --api=true\n        - --api.dashboard=true\n        - --ping=true\n        - --providers.kubernetesingress\n        - --providers.kubernetescrd\n        - --log.level=INFO\n        - --accesslog\n        # \u4f7f\u7528 dns \u9a8c\u8bc1\u65b9\u5f0f\n        - --certificatesResolvers.ali.acme.dnsChallenge.provider=alidns\n        # \u90ae\u7bb1\u914d\u7f6e\n        - --certificatesResolvers.ali.acme.email=ych_1024@1com\n        # \u4fdd\u5b58 ACME \u8bc1\u4e66\u7684\u4f4d\u7f6e\n        - --certificatesResolvers.ali.acme.storage=/etc/acme/acme.json\n        # \u4e0b\u9762\u662f\u7528\u4e8e\u6d4b\u8bd5\u7684ca\u670d\u52a1\uff0c\u5982\u679chttps\u8bc1\u4e66\u751f\u6210\u6210\u529f\u4e86\uff0c\u5219\u79fb\u9664\u4e0b\u9762\u53c2\u6570\n        # - --certificatesresolvers.ali.acme.caserver=https://acme-staging-vapi.letsencrypt.org/directory\n        envFrom:\n        - secretRef:\n            name: traefik-alidns-secret\n            # ALICLOUD_ACCESS_KEY\n            # ALICLOUD_SECRET_KEY\n            # ALICLOUD_REGION_ID\n        volumeMounts:\n        - name: acme\n          mountPath: /etc/acme\n        resources:\n          requests:\n            cpu: \"50m\"\n            memory: \"50Mi\"\n          limits:\n            cpu: \"200m\"\n            memory: \"100Mi\"\n        securityContext:\n          allowPrivilegeEscalation: true\n          capabilities:\n            drop:\n            - ALL\n            add:\n            - NET_BIND_SERVICE\n        readinessProbe:\n          httpGet:\n            path: /ping\n            port: 8080\n          failureThreshold: 1\n          initialDelaySeconds: 10\n          periodSeconds: 10\n          successThreshold: 1\n          timeoutSeconds: 2\n        livenessProbe:\n          httpGet:\n            path: /ping\n            port: 8080\n          failureThreshold: 3\n          initialDelaySeconds: 10\n          periodSeconds: 10\n          successThreshold: 1\n          timeoutSeconds: 2\n</code></pre> <p>\u76f4\u63a5\u66f4\u65b0 Traefik \u5e94\u7528\u5373\u53ef\u3002\u66f4\u65b0\u5b8c\u6210\u540e\u73b0\u5728\u6211\u4eec\u6765\u4fee\u6539\u4e0a\u9762\u6211\u4eec\u7684 <code>whoami</code> \u5e94\u7528\uff1a</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: ingressroutetls\nspec:\n  entryPoints:\n    - websecure\n  routes:\n  - match: Host(`who.qikqiak.com`) &amp;&amp; PathPrefix(`/tls`)\n    kind: Rule\n    services:\n    - name: whoami\n      port: 80\n  tls:\n    certResolver: ali\n    domains:\n    - main: \"*.qikqiak.com\"\n</code></pre> <p>\u5176\u4ed6\u7684\u90fd\u4e0d\u53d8\uff0c\u53ea\u9700\u8981\u5c06 tls \u90e8\u5206\u6539\u6210\u6211\u4eec\u5b9a\u4e49\u7684 <code>ali</code> \u8fd9\u4e2a\u8bc1\u4e66\u89e3\u6790\u5668\uff0c\u5982\u679c\u6211\u4eec\u60f3\u8981\u751f\u6210\u4e00\u4e2a\u901a\u914d\u7b26\u7684\u57df\u540d\u8bc1\u4e66\u7684\u8bdd\u53ef\u4ee5\u5b9a\u4e49 <code>domains</code> \u53c2\u6570\u6765\u6307\u5b9a\uff0c\u7136\u540e\u66f4\u65b0 IngressRoute \u5bf9\u8c61\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u518d\u53bb\u7528 HTTPS \u8bbf\u95ee\u6211\u4eec\u7684\u5e94\u7528\uff08\u5f53\u7136\u9700\u8981\u5c06\u57df\u540d\u5728\u963f\u91cc\u4e91 DNS \u4e0a\u505a\u89e3\u6790\uff09\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8bbf\u95ee\u5e94\u7528\u5df2\u7ecf\u662f\u53d7\u6d4f\u89c8\u5668\u4fe1\u4efb\u7684\u8bc1\u4e66\u4e86\uff0c\u67e5\u770b\u8bc1\u4e66\u6211\u4eec\u8fd8\u53ef\u4ee5\u53d1\u73b0\u8be5\u8bc1\u4e66\u662f\u4e00\u4e2a\u901a\u914d\u7b26\u7684\u8bc1\u4e66\u3002</p>"},{"location":"kubernetes_network/ingress/traefik/#_3","title":"\u4e2d\u95f4\u4ef6","text":"<p>\u4e2d\u95f4\u4ef6\u662f Traefik2.0 \u4e2d\u4e00\u4e2a\u975e\u5e38\u6709\u7279\u8272\u7684\u529f\u80fd\uff0c\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u5404\u79cd\u9700\u6c42\u53bb\u9009\u62e9\u4e0d\u540c\u7684\u4e2d\u95f4\u4ef6\u6765\u6ee1\u8db3\u670d\u52a1\uff0cTraefik \u5b98\u65b9\u5df2\u7ecf\u5185\u7f6e\u4e86\u8bb8\u591a\u4e0d\u540c\u529f\u80fd\u7684\u4e2d\u95f4\u4ef6\uff0c\u5176\u4e2d\u4e00\u4e9b\u53ef\u4ee5\u4fee\u6539\u8bf7\u6c42\uff0c\u5934\u4fe1\u606f\uff0c\u4e00\u4e9b\u8d1f\u8d23\u91cd\u5b9a\u5411\uff0c\u4e00\u4e9b\u6dfb\u52a0\u8eab\u4efd\u9a8c\u8bc1\u7b49\u7b49\uff0c\u800c\u4e14\u4e2d\u95f4\u4ef6\u8fd8\u53ef\u4ee5\u901a\u8fc7\u94fe\u5f0f\u7ec4\u5408\u7684\u65b9\u5f0f\u6765\u9002\u7528\u5404\u79cd\u60c5\u51b5\u3002</p> <p></p> <p>\u540c\u6837\u6bd4\u5982\u4e0a\u9762\u6211\u4eec\u5b9a\u4e49\u7684 whoami \u8fd9\u4e2a\u5e94\u7528\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 </p> <pre><code>https://who.qikqiak.com/tls\n</code></pre> <p>\u6765\u8bbf\u95ee\u5230\u5e94\u7528\uff0c\u4f46\u662f\u5982\u679c\u6211\u4eec\u7528 <code>http</code> \u6765\u8bbf\u95ee\u7684\u8bdd\u5462\u5c31\u4e0d\u884c\u4e86\uff0c\u5c31\u4f1a404\u4e86\uff0c\u56e0\u4e3a\u6211\u4eec\u6839\u672c\u5c31\u6ca1\u6709\u7b80\u535580\u7aef\u53e3\u8fd9\u4e2a\u5165\u53e3\u70b9\uff0c\u6240\u4ee5\u8981\u60f3\u901a\u8fc7 <code>http</code> \u6765\u8bbf\u95ee\u5e94\u7528\u7684\u8bdd\u81ea\u7136\u6211\u4eec\u9700\u8981\u76d1\u542c\u4e0b <code>web</code> \u8fd9\u4e2a\u5165\u53e3\u70b9\uff1a</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: ingressroutetls-http\nspec:\n  entryPoints:\n    - web\n  routes:\n  - match: Host(`who.qikqiak.com`) &amp;&amp; PathPrefix(`/tls`)\n    kind: Rule\n    services:\n    - name: whoami\n      port: 80\n</code></pre> <p>\u6ce8\u610f\u8fd9\u91cc\u6211\u4eec\u521b\u5efa\u7684 IngressRoute \u7684 entryPoints \u662f <code>web</code>\uff0c\u7136\u540e\u521b\u5efa\u8fd9\u4e2a\u5bf9\u8c61\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7 http \u8bbf\u95ee\u5230\u8fd9\u4e2a\u5e94\u7528\u4e86\u3002</p> <p>\u4f46\u662f\u6211\u4eec\u5982\u679c\u53ea\u5e0c\u671b\u7528\u6237\u901a\u8fc7 https \u6765\u8bbf\u95ee\u5e94\u7528\u7684\u8bdd\u5462\uff1f\u6309\u7167\u4ee5\u524d\u7684\u77e5\u8bc6\uff0c\u6211\u4eec\u662f\u4e0d\u662f\u53ef\u4ee5\u8ba9 http \u5f3a\u5236\u8df3\u8f6c\u5230 https \u670d\u52a1\u53bb\uff0c\u5bf9\u7684\uff0c\u5728 Traefik \u4e2d\u4e5f\u662f\u53ef\u4ee5\u914d\u7f6e\u5f3a\u5236\u8df3\u8f6c\u7684\uff0c\u53ea\u662f\u8fd9\u4e2a\u529f\u80fd\u73b0\u5728\u662f\u901a\u8fc7\u4e2d\u95f4\u4ef6\u6765\u63d0\u4f9b\u7684\u4e86\u3002\u5982\u4e0b\u6240\u793a\uff0c\u6211\u4eec\u4f7f\u7528 <code>redirectScheme</code> \u4e2d\u95f4\u4ef6\u6765\u521b\u5efa\u63d0\u4f9b\u5f3a\u5236\u8df3\u8f6c\u670d\u52a1\uff1a</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: Middleware\nmetadata:\n  name: redirect-https\nspec:\n  redirectScheme:\n    scheme: https\n</code></pre> <p>\u7136\u540e\u5c06\u8fd9\u4e2a\u4e2d\u95f4\u4ef6\u9644\u52a0\u5230 http \u7684\u670d\u52a1\u4e0a\u9762\u53bb\uff0c\u56e0\u4e3a https \u7684\u4e0d\u9700\u8981\u8df3\u8f6c\uff1a</p> <pre><code>---\napiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: ingressroutetls-http\nspec:\n  entryPoints:\n    - web\n  routes:\n  - match: Host(`who.qikqiak.com`) &amp;&amp; PathPrefix(`/tls`)\n    kind: Rule\n    services:\n    - name: whoami\n      port: 80\n    middlewares: \n    - name: redirect-https\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u518d\u53bb\u8bbf\u95ee http \u670d\u52a1\u53ef\u4ee5\u53d1\u73b0\u5c31\u4f1a\u81ea\u52a8\u8df3\u8f6c\u5230 https \u53bb\u4e86\u3002\u5173\u4e8e\u66f4\u591a\u4e2d\u95f4\u4ef6\u7684\u7528\u6cd5\u53ef\u4ee5\u67e5\u770b\u6587\u6863 Traefik Docs\u3002</p>"},{"location":"kubernetes_network/ingress/traefik/#_4","title":"\u7070\u5ea6\u53d1\u5e03","text":"<p>Traefik2.0 \u7684\u4e00\u4e2a\u66f4\u5f3a\u5927\u7684\u529f\u80fd\u5c31\u662f\u7070\u5ea6\u53d1\u5e03\uff0c\u7070\u5ea6\u53d1\u5e03\u6211\u4eec\u6709\u65f6\u5019\u4e5f\u4f1a\u79f0\u4e3a\u91d1\u4e1d\u96c0\u53d1\u5e03\uff08Canary\uff09\uff0c\u4e3b\u8981\u5c31\u662f\u8ba9\u4e00\u90e8\u5206\u6d4b\u8bd5\u7684\u670d\u52a1\u4e5f\u53c2\u4e0e\u5230\u7ebf\u4e0a\u53bb\uff0c\u7ecf\u8fc7\u6d4b\u8bd5\u89c2\u5bdf\u770b\u662f\u5426\u7b26\u53f7\u4e0a\u7ebf\u8981\u6c42\u3002</p> <p></p> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u6709\u4e24\u4e2a\u540d\u4e3a <code>appv1</code> \u548c <code>appv2</code> \u7684\u670d\u52a1\uff0c\u6211\u4eec\u5e0c\u671b\u901a\u8fc7 Traefik \u6765\u63a7\u5236\u6211\u4eec\u7684\u6d41\u91cf\uff0c\u5c06 3\u20444 \u7684\u6d41\u91cf\u8def\u7531\u5230 appv1\uff0c\u00bc \u7684\u6d41\u91cf\u8def\u7531\u5230 appv2 \u53bb\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u53ef\u4ee5\u5229\u7528 Traefik2.0 \u4e2d\u63d0\u4f9b\u7684<code>\u5e26\u6743\u91cd\u7684\u8f6e\u8be2\uff08WRR\uff09</code>\u6765\u5b9e\u73b0\u8be5\u529f\u80fd\uff0c\u9996\u5148\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u90e8\u7f72\u4e0a\u9762\u7684\u4e24\u4e2a\u670d\u52a1\u3002\u4e3a\u4e86\u5bf9\u6bd4\u7ed3\u679c\u6211\u4eec\u8fd9\u91cc\u63d0\u4f9b\u7684\u4e24\u4e2a\u670d\u52a1\u4e00\u4e2a\u662f whoami\uff0c\u4e00\u4e2a\u662f nginx\uff0c\u65b9\u4fbf\u6d4b\u8bd5\u3002</p> <p>appv1 \u670d\u52a1\u7684\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a\uff08appv1.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: appv1\nspec:\n  selector:\n    matchLabels:\n      app: appv1\n  template:\n    metadata:\n      labels:\n        use: test\n        app: appv1\n    spec:\n      containers:\n      - name: whoami\n        image: containous/whoami\n        ports:\n        - containerPort: 80\n          name: portv1\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: appv1\nspec:\n  selector:\n    app: appv1\n  ports:\n  - name: http\n    port: 80\n    targetPort: portv1\n</code></pre> <p>appv2 \u670d\u52a1\u7684\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a\uff08appv2.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: appv2\nspec:\n  selector:\n    matchLabels:\n      app: appv2\n  template:\n    metadata:\n      labels:\n        use: test\n        app: appv2\n    spec:\n      containers:\n      - name: nginx\n        image: nginx\n        ports:\n        - containerPort: 80\n          name: portv2\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: appv2\nspec:\n  selector:\n    app: appv2\n  ports:\n  - name: http\n    port: 80\n    targetPort: portv2\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u4e24\u4e2a\u670d\u52a1\uff1a</p> <pre><code>$ kubectl apply -f appvyaml\n$ kubectl apply -f appvyaml\n# \u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u53ef\u4ee5\u67e5\u770b\u670d\u52a1\u662f\u5426\u8fd0\u884c\u6210\u529f\n$ kubectl get pods -l use=test\nNAME                     READY   STATUS    RESTARTS   AGE\nappv1-58f856c665-shm9j   1/1     Running   0          12s\nappv2-ff5db55cf-qjtrf    1/1     Running   0          12s\n</code></pre> <p>\u5728 Traefik2.1 \u4e2d\u65b0\u589e\u4e86\u4e00\u4e2a <code>TraefikService</code> \u7684 CRD \u8d44\u6e90\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5229\u7528\u8fd9\u4e2a\u5bf9\u8c61\u6765\u914d\u7f6e WRR\uff0c\u4e4b\u524d\u7684\u7248\u672c\u9700\u8981\u901a\u8fc7 File Provider\uff0c\u6bd4\u8f83\u9ebb\u70e6\uff0c\u65b0\u5efa\u4e00\u4e2a\u63cf\u8ff0 WRR \u7684\u8d44\u6e90\u6e05\u5355\uff1a(wrr.yaml)</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: TraefikService\nmetadata:\n  name: app-wrr\nspec:\n  weighted:\n    services:\n      - name: appv1\n        weight: 3  # \u5b9a\u4e49\u6743\u91cd\n        port: 80\n        kind: Service  # \u53ef\u9009\uff0c\u9ed8\u8ba4\u5c31\u662f Service\n      - name: appv2\n        weight: 1\n        port: 80\n</code></pre> <p>\u7136\u540e\u4e3a\u6211\u4eec\u7684\u7070\u5ea6\u53d1\u5e03\u7684\u670d\u52a1\u521b\u5efa\u4e00\u4e2a IngressRoute \u8d44\u6e90\u5bf9\u8c61\uff1a(ingressroute.yaml)</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: wrringressroute\n  namespace: default\nspec:\n  entryPoints:\n    - web\n  routes:\n  - match: Host(`wrr.qikqiak.com`)\n    kind: Rule\n    services:\n    - name: app-wrr\n      kind: TraefikService\n</code></pre> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u73b0\u5728\u6211\u4eec\u914d\u7f6e\u7684 Service \u4e0d\u518d\u662f\u76f4\u63a5\u7684 Kubernetes \u5bf9\u8c61\u4e86\uff0c\u800c\u662f\u4e0a\u9762\u6211\u4eec\u5b9a\u4e49\u7684 TraefikService \u5bf9\u8c61\uff0c\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u4e24\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5bf9\u57df\u540d <code>wrr.qikqiak.com</code> \u505a\u4e0a\u89e3\u6790\uff0c\u53bb\u6d4f\u89c8\u5668\u4e2d\u8fde\u7eed\u8bbf\u95ee 4 \u6b21\uff0c\u6211\u4eec\u53ef\u4ee5\u89c2\u5bdf\u5230 appv1 \u8fd9\u5e94\u7528\u4f1a\u6536\u5230 3 \u6b21\u8bf7\u6c42\uff0c\u800c appv2 \u8fd9\u4e2a\u5e94\u7528\u53ea\u6536\u5230 1 \u6b21\u8bf7\u6c42\uff0c\u7b26\u5408\u4e0a\u9762\u6211\u4eec\u7684 <code>3:1</code> \u7684\u6743\u91cd\u914d\u7f6e\u3002</p> <p></p>"},{"location":"kubernetes_network/ingress/traefik/#_5","title":"\u6d41\u91cf\u590d\u5236","text":"<p>\u9664\u4e86\u7070\u5ea6\u53d1\u5e03\u4e4b\u5916\uff0cTraefik 2.0 \u8fd8\u5f15\u5165\u4e86\u6d41\u91cf\u955c\u50cf\u670d\u52a1\uff0c\u662f\u4e00\u79cd\u53ef\u4ee5\u5c06\u6d41\u5165\u6d41\u91cf\u590d\u5236\u5e76\u540c\u65f6\u5c06\u5176\u53d1\u9001\u7ed9\u5176\u4ed6\u670d\u52a1\u7684\u65b9\u6cd5\uff0c\u955c\u50cf\u670d\u52a1\u53ef\u4ee5\u83b7\u5f97\u7ed9\u5b9a\u767e\u5206\u6bd4\u7684\u8bf7\u6c42\u540c\u65f6\u4e5f\u4f1a\u5ffd\u7565\u8fd9\u90e8\u5206\u8bf7\u6c42\u7684\u54cd\u5e94\u3002</p> <p></p> <p>\u540c\u6837\u7684\u5728 2.0 \u4e2d\u53ea\u80fd\u901a\u8fc7 FileProvider \u8fdb\u884c\u914d\u7f6e\uff0c\u5728 2.1 \u7248\u672c\u4e2d\u6211\u4eec\u5df2\u7ecf\u53ef\u4ee5\u901a\u8fc7 <code>TraefikService</code> \u8d44\u6e90\u5bf9\u8c61\u6765\u8fdb\u884c\u914d\u7f6e\u4e86\uff0c\u73b0\u5728\u6211\u4eec\u90e8\u7f72\u4e24\u4e2a whoami \u7684\u670d\u52a1\uff0c\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: v1\nspec:\n  ports:\n    - protocol: TCP\n      name: web\n      port: 80\n  selector:\n    app: v1\n---\nkind: Deployment\napiVersion: apps/v1\nmetadata:\n  name: v1\n  labels:\n    app: v1\nspec:\n  selector:\n    matchLabels:\n      app: v1\n  template:\n    metadata:\n      labels:\n        app: v1\n    spec:\n      containers:\n        - name: v1\n          image: nginx\n          ports:\n            - name: web\n              containerPort: 80\n\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: v2\nspec:\n  ports:\n    - protocol: TCP\n      name: web\n      port: 80\n  selector:\n    app: v2\n---\nkind: Deployment\napiVersion: apps/v1\nmetadata:\n  name: v2\n  labels:\n    app: v2\nspec:\n  selector:\n    matchLabels:\n      app: v2\n  template:\n    metadata:\n      labels:\n        app: v2\n    spec:\n      containers:\n        - name: v2\n          image: nginx\n          ports:\n            - name: web\n              containerPort: 80\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl get pods\nNAME                                      READY   STATUS    RESTARTS   AGE\nv1-77cfb86999-wfbl2                       1/1     Running   0          94s\nv2-6f45d498b7-g6qjt                       1/1     Running   0          91s\n$ kubectl get svc \nNAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)     AGE\nv1              ClusterIP   2173   &lt;none&gt;        80/TCP      99s\nv2              ClusterIP   48     &lt;none&gt;        80/TCP      96s\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u521b\u5efa\u4e00\u4e2a IngressRoute \u5bf9\u8c61\uff0c\u5c06\u670d\u52a1 v1 \u7684\u6d41\u91cf\u590d\u5236 50% \u5230\u670d\u52a1 v2\uff0c\u5982\u4e0b\u8d44\u6e90\u5bf9\u8c61\u6240\u793a\uff1a(mirror-ingress-route.yaml)</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: TraefikService\nmetadata:\n  name: app-mirror\nspec:\n  mirroring:\n    name: v1 # \u53d1\u9001 100% \u7684\u8bf7\u6c42\u5230 K8S \u7684 Service \"v1\"\n    port: 80\n    mirrors:\n    - name: v2 # \u7136\u540e\u590d\u5236 50% \u7684\u8bf7\u6c42\u5230 v2\n      percent: 50\n      port: 80\n---\napiVersion: traefik.containo.us/v1alpha1\nkind: IngressRoute\nmetadata:\n  name: mirror-ingress-route\n  namespace: default\nspec:\n  entryPoints:\n  - web\n  routes:   \n  - match: Host(`mirror.qikqiak.com`)\n    kind: Rule\n    services:\n    - name: app-mirror\n      kind: TraefikService # \u4f7f\u7528\u58f0\u660e\u7684 TraefikService \u670d\u52a1\uff0c\u800c\u4e0d\u662f K8S \u7684 Service\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f mirror-ingress-route.yaml \ningressroute.traefik.containo.us/mirror-ingress-route created\ntraefikservice.traefik.containo.us/mirroring-example created\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5728\u6d4f\u89c8\u5668\u4e2d\u53bb\u8fde\u7eed\u8bbf\u95ee4\u6b21 <code>mirror.qikqiak.com</code> \u53ef\u4ee5\u53d1\u73b0\u6709\u4e00\u534a\u7684\u8bf7\u6c42\u4e5f\u51fa\u73b0\u5728\u4e86 <code>v2</code> \u8fd9\u4e2a\u670d\u52a1\u4e2d\uff1a </p>"},{"location":"kubernetes_network/ingress/traefik/#tcp","title":"TCP","text":"<p>\u53e6\u5916 Traefik2.0 \u5df2\u7ecf\u652f\u6301\u4e86 TCP \u670d\u52a1\u7684\uff0c\u4e0b\u9762\u6211\u4eec\u4ee5 mongo \u4e3a\u4f8b\u6765\u4e86\u89e3\u4e0b Traefik \u662f\u5982\u4f55\u652f\u6301 TCP \u670d\u52a1\u5f97\u3002</p>"},{"location":"kubernetes_network/ingress/traefik/#tcp_1","title":"\u7b80\u5355 TCP \u670d\u52a1","text":"<p>\u9996\u5148\u90e8\u7f72\u4e00\u4e2a\u666e\u901a\u7684 mongo \u670d\u52a1\uff0c\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a\uff08mongo.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: mongo-traefik\n  labels:\n    app: mongo-traefik\nspec:\n  selector:\n    matchLabels:\n      app: mongo-traefik\n  template:\n    metadata:\n      labels:\n        app: mongo-traefik\n    spec:\n      containers:\n      - name: mongo\n        image: mongo:0\n        ports:\n        - containerPort: 27017\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: mongo-traefik\nspec:\n  selector:\n    app: mongo-traefik\n  ports:\n  - port: 27017\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa mongo \u5e94\u7528\uff1a</p> <pre><code>$ kubectl apply -f mongo.yaml\ndeployment.apps/mongo-traefik created\nservice/mongo-traefik created\n</code></pre> <p>\u521b\u5efa\u6210\u529f\u540e\u5c31\u53ef\u4ee5\u6765\u4e3a mongo \u670d\u52a1\u914d\u7f6e\u4e00\u4e2a\u8def\u7531\u4e86\u3002\u7531\u4e8e Traefik \u4e2d\u4f7f\u7528 TCP \u8def\u7531\u914d\u7f6e\u9700\u8981 <code>SNI</code>\uff0c\u800c <code>SNI</code> \u53c8\u662f\u4f9d\u8d56 <code>TLS</code> \u7684\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u914d\u7f6e\u8bc1\u4e66\u624d\u884c\uff0c\u5982\u679c\u6ca1\u6709\u8bc1\u4e66\u7684\u8bdd\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u901a\u914d\u7b26 <code>*</code> \u8fdb\u884c\u914d\u7f6e\uff0c\u6211\u4eec\u8fd9\u91cc\u521b\u5efa\u4e00\u4e2a <code>IngressRouteTCP</code> \u7c7b\u578b\u7684 CRD \u5bf9\u8c61\uff08\u524d\u9762\u6211\u4eec\u5c31\u5df2\u7ecf\u5b89\u88c5\u4e86\u5bf9\u5e94\u7684 CRD \u8d44\u6e90\uff09\uff1a(mongo-ingressroute-tcp.yaml)</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRouteTCP\nmetadata:\n  name: mongo-traefik-tcp\nspec:\n  entryPoints:\n    - mongo\n  routes:\n  - match: HostSNI(`*`)\n    services:\n    - name: mongo-traefik\n      port: 27107\n</code></pre> <p>\u8981\u6ce8\u610f\u7684\u662f\u8fd9\u91cc\u7684 <code>entryPoints</code> \u90e8\u5206\uff0c\u662f\u6839\u636e\u6211\u4eec\u542f\u52a8\u7684 Traefik \u7684\u9759\u6001\u914d\u7f6e\u4e2d\u7684 entryPoints \u6765\u51b3\u5b9a\u7684\uff0c\u6211\u4eec\u5f53\u7136\u53ef\u4ee5\u4f7f\u7528\u524d\u9762\u6211\u4eec\u5b9a\u4e49\u5f97 80 \u548c 443 \u8fd9\u4e24\u4e2a\u5165\u53e3\u70b9\uff0c\u4f46\u662f\u4e5f\u53ef\u4ee5\u53ef\u4ee5\u81ea\u5df1\u6dfb\u52a0\u4e00\u4e2a\u7528\u4e8e mongo \u670d\u52a1\u7684\u4e13\u95e8\u5165\u53e3\u70b9\uff1a</p> <pre><code>......\n- image: traefik:1\n  name: traefik\n  ports:\n  - name: web\n    containerPort: 80\n    hostPort: 80\n  - name: websecure\n    containerPort: 443\n    hostPort: 443\n  - name: mongo\n    hostPort: 27017\n    containerPort: 27017\n  args:\n  - --entryPoints.web.address=:80\n  - --entryPoints.websecure.address=:443\n  - --entryPoints.mongo.address=:27017\n  ......\n</code></pre> <p>\u8fd9\u91cc\u7ed9\u5165\u53e3\u70b9\u6dfb\u52a0 <code>hostPort</code> \u662f\u4e3a\u4e86\u80fd\u591f\u901a\u8fc7\u8282\u70b9\u7684\u7aef\u53e3\u8bbf\u95ee\u5230\u670d\u52a1\uff0c\u5173\u4e8e entryPoints \u5165\u53e3\u70b9\u7684\u66f4\u591a\u4fe1\u606f\uff0c\u53ef\u4ee5\u67e5\u770b\u6587\u6863 entrypoints \u4e86\u89e3\u66f4\u591a\u4fe1\u606f\u3002</p> <p>\u7136\u540e\u66f4\u65b0 Traefik \u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ mongo-ingressroute-tcp.yaml\ningressroutetcp.traefik.containo.us/mongo-traefik-tcp created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u53bb Traefik \u7684 Dashboard \u9875\u9762\u4e0a\u67e5\u770b\u662f\u5426\u751f\u6548\uff1a</p> <p></p> <p>\u7136\u540e\u6211\u4eec\u914d\u7f6e\u4e00\u4e2a\u57df\u540d <code>mongo.local</code> \u89e3\u6790\u5230 Traefik \u6240\u5728\u7684\u8282\u70b9\uff0c\u7136\u540e\u901a\u8fc7 27017 \u7aef\u53e3\u6765\u8fde\u63a5 mongo \u670d\u52a1\uff1a</p> <pre><code>$ mongo --host mongo.local --port 27017\nmongo(75243,0x1075295c0) malloc: *** malloc_zone_unregister() failed for 0x7fffa56f4000\nMongoDB shell version: 1\nconnecting to: mongo.local:27017/test\n&gt; show dbs\nadmin   000GB\nconfig  000GB\nlocal   000GB\n</code></pre> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u5c06 mongo\uff08TCP\uff09\u670d\u52a1\u66b4\u9732\u7ed9\u5916\u90e8\u7528\u6237\u4e86\u3002</p>"},{"location":"kubernetes_network/ingress/traefik/#tls_tcp","title":"\u5e26 TLS \u8bc1\u4e66\u7684 TCP","text":"<p>\u4e0a\u9762\u6211\u4eec\u90e8\u7f72\u7684 mongo \u662f\u4e00\u4e2a\u666e\u901a\u7684\u670d\u52a1\uff0c\u7136\u540e\u7528 Traefik \u4ee3\u7406\u7684\uff0c\u4f46\u662f\u6709\u65f6\u5019\u4e3a\u4e86\u5b89\u5168 mongo \u670d\u52a1\u672c\u8eab\u8fd8\u4f1a\u4f7f\u7528 TLS \u8bc1\u4e66\u7684\u5f62\u5f0f\u63d0\u4f9b\u670d\u52a1\uff0c\u4e0b\u9762\u662f\u7528\u6765\u751f\u6210 mongo tls \u8bc1\u4e66\u7684\u811a\u672c\u6587\u4ef6\uff1a\uff08generate-certificates.sh\uff09</p> <pre><code>#!/bin/bash\n#\n# From https://medium.com/@rajanmaharjan/secure-your-mongodb-connections-ssl-tls-92e2addb3c89\n\nset -eu -o pipefail\n\nDOMAINS=\"${1}\"\nCERTS_DIR=\"${2}\"\n[ -d \"${CERTS_DIR}\" ]\nCURRENT_DIR=\"$(cd \"$(dirname \"${0}\")\" &amp;&amp; pwd -P)\"\n\nGENERATION_DIRNAME=\"$(echo \"${DOMAINS}\" | cut -d, -f1)\"\n\nrm -rf \"${CERTS_DIR}/${GENERATION_DIRNAME:?}\" \"${CERTS_DIR}/certs\"\n\necho \"== Checking Requirements...\"\ncommand -v go &gt;/dev/null 2&gt;&amp;1 || echo \"Golang is required\"\ncommand -v minica &gt;/dev/null 2&gt;&amp;1 || go get github.com/jsha/minica &gt;/dev/null\n\necho \"== Generating Certificates for the following domains: ${DOMAINS}...\"\ncd \"${CERTS_DIR}\"\nminica --ca-cert \"${CURRENT_DIR}/minica.pem\" --ca-key=\"${CURRENT_DIR}/minica-key.pem\" --domains=\"${DOMAINS}\"\nmv \"${GENERATION_DIRNAME}\" \"certs\"\ncat certs/key.pem certs/cert.pem &gt; certs/mongo.pem\n\necho \"== Certificates Generated in the directory ${CERTS_DIR}/certs\"\n</code></pre> <p>\u5c06\u4e0a\u9762\u8bc1\u4e66\u653e\u7f6e\u5230 certs \u76ee\u5f55\u4e0b\u9762\uff0c\u7136\u540e\u6211\u4eec\u65b0\u5efa\u4e00\u4e2a <code>02-tls-mongo</code> \u7684\u76ee\u5f55\uff0c\u5728\u8be5\u76ee\u5f55\u4e0b\u9762\u6267\u884c\u5982\u4e0b\u547d\u4ee4\u6765\u751f\u6210\u8bc1\u4e66\uff1a</p> <pre><code>$ bash ../certs/generate-certificates.sh mongo.local .\n== Checking Requirements...\n== Generating Certificates for the following domains: mongo.local...\n</code></pre> <p>\u6700\u540e\u7684\u76ee\u5f55\u5982\u4e0b\u6240\u793a\uff0c\u5728 <code>02-tls-mongo</code> \u76ee\u5f55\u4e0b\u9762\u4f1a\u751f\u6210\u5305\u542b\u8bc1\u4e66\u7684 certs \u76ee\u5f55\uff1a</p> <pre><code>$ tree .\n.\n\u251c\u2500\u2500 01-mongo\n\u2502   \u251c\u2500\u2500 mongo-ingressroute-tcp.yaml\n\u2502   \u2514\u2500\u2500 mongo.yaml\n\u251c\u2500\u2500 02-tls-mongo\n\u2502   \u2514\u2500\u2500 certs\n\u2502       \u251c\u2500\u2500 cert.pem\n\u2502       \u251c\u2500\u2500 key.pem\n\u2502       \u2514\u2500\u2500 mongo.pem\n\u2514\u2500\u2500 certs\n    \u251c\u2500\u2500 generate-certificates.sh\n    \u251c\u2500\u2500 minica-key.pem\n    \u2514\u2500\u2500 minica.pem\n</code></pre> <p>\u5728 <code>02-tls-mongo/certs</code> \u76ee\u5f55\u4e0b\u9762\u6267\u884c\u5982\u4e0b\u547d\u4ee4\u901a\u8fc7 Secret \u6765\u5305\u542b\u8bc1\u4e66\u5185\u5bb9\uff1a</p> <pre><code>$ kubectl create secret tls traefik-mongo-certs --cert=cert.pem --key=key.pem\nsecret/traefik-mongo-certs created\n</code></pre> <p>\u7136\u540e\u91cd\u65b0\u66f4\u65b0 <code>IngressRouteTCP</code> \u5bf9\u8c61\uff0c\u589e\u52a0 TLS \u914d\u7f6e\uff1a</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRouteTCP\nmetadata:\n  name: mongo-traefik-tcp\nspec:\n  entryPoints:\n    - mongo\n  routes:\n  - match: HostSNI(`mongo.local`)\n    services:\n    - name: mongo-traefik\n      port: 27017\n  tls: \n    secretName: traefik-mongo-certs\n</code></pre> <p>\u540c\u6837\u66f4\u65b0\u540e\uff0c\u73b0\u5728\u6211\u4eec\u76f4\u63a5\u53bb\u8bbf\u95ee\u5e94\u7528\u5c31\u4f1a\u88ab hang \u4f4f\uff0c\u56e0\u4e3a\u6211\u4eec\u6ca1\u6709\u63d0\u4f9b\u8bc1\u4e66\uff1a</p> <pre><code>$ mongo --host mongo.local --port 27017\nMongoDB shell version: 1\nconnecting to: mongolocal:27017/test\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u5e26\u4e0a\u8bc1\u4e66\u6765\u8fdb\u884c\u8fde\u63a5\uff1a</p> <pre><code>$ mongo --host mongo.local --port 27017 --ssl --sslCAFile=../certs/minica.pem --sslPEMKeyFile=./certs/mongo.pem\nMongoDB shell version v3\nconnecting to: mongodb://mongo.local:27017/\nImplicit session: session { \"id\" : UUID(\"e7409ef6-8ebe-4c5a-9642-42059bdb477b\") }\nMongoDB server version: 14\n......\n&gt; show dbs;\nadmin   000GB\nconfig  000GB\nlocal   000GB\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u73b0\u5728\u5c31\u53ef\u4ee5\u8fde\u63a5\u6210\u529f\u4e86\uff0c\u8fd9\u6837\u5c31\u5b8c\u6210\u4e86\u4e00\u4e2a\u4f7f\u7528 TLS \u8bc1\u4e66\u4ee3\u7406 TCP \u670d\u52a1\u7684\u529f\u80fd\uff0c\u8fd9\u4e2a\u65f6\u5019\u5982\u679c\u6211\u4eec\u4f7f\u7528\u5176\u4ed6\u7684\u57df\u540d\u53bb\u8fdb\u884c\u8fde\u63a5\u5c31\u4f1a\u62a5\u9519\u4e86\uff0c\u56e0\u4e3a\u73b0\u5728\u6211\u4eec\u6307\u5b9a\u7684\u662f\u7279\u5b9a\u7684 HostSNI\uff1a</p> <pre><code>$ mongo --host mongo.k8s.local --port 27017 --ssl --sslCAFile=../certs/minica.pem --sslPEMKeyFile=./certs/mongo.pem\nMongoDB shell version v3\nconnecting to: mongodb://mongo.k8s.local:27017/\n2019-12-29T15:03:424+0800 E NETWORK  [js] SSL peer certificate validation failed: Certificate trust failure: CSSMERR_TP_NOT_TRUSTED; connection rejected\n2019-12-29T15:03:429+0800 E QUERY    [js] Error: couldn't connect to server mongo.qikqiak.com:27017, connection attempt failed: SSLHandshakeFailed: SSL peer certificate validation failed: Certificate trust failure: CSSMERR_TP_NOT_TRUSTED; connection rejected :\nconnect@src/mongo/shell/mongo.js:257:13\n@(connect):1:6\nexception: connect failed\n</code></pre> <p>\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528 ACME \u6765\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e00\u4e2a\u5408\u6cd5\u7684\u8bc1\u4e66\uff0c\u8fd9\u6837\u5728\u8fde\u63a5\u7684\u4f7f\u7528\u5c31\u4e0d\u9700\u8981\u6307\u5b9a\u8bc1\u4e66\u4e86\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>apiVersion: traefik.containo.us/v1alpha1\nkind: IngressRouteTCP\nmetadata:\n  name: mongo-traefik-tcp\nspec:\n  entryPoints:\n    - mongo\n  routes:\n  - match: HostSNI(`mongo.qikqiak.com`)\n    services:\n    - name: mongo-traefik\n      port: 27017\n  tls:\n    certResolver: ali\n    domains:\n    - main: \"*.qikqiak.com\"\n</code></pre> <p>\u8fd9\u6837\u5f53\u6211\u4eec\u8fde\u63a5\u7684\u65f6\u5019\u5c31\u53ea\u9700\u8981\u5982\u4e0b\u7684\u547d\u4ee4\u5373\u53ef\uff1a</p> <pre><code>$ mongo --host mongo.qikqiak.com --port 27017 --ssl\n</code></pre>"},{"location":"kubernetes_scheduler/overview/","title":"\u8c03\u5ea6\u5668\u4ecb\u7ecd","text":"<p>\ue3c9</p>"},{"location":"kubernetes_scheduler/overview/#_1","title":"\u8c03\u5ea6\u5668","text":"<p><code>kube-scheduler</code> \u662f kubernetes \u7684\u6838\u5fc3\u7ec4\u4ef6\u4e4b\u4e00\uff0c\u4e3b\u8981\u8d1f\u8d23\u6574\u4e2a\u96c6\u7fa4\u8d44\u6e90\u7684\u8c03\u5ea6\u529f\u80fd\uff0c\u6839\u636e\u7279\u5b9a\u7684\u8c03\u5ea6\u7b97\u6cd5\u548c\u7b56\u7565\uff0c\u5c06 Pod \u8c03\u5ea6\u5230\u6700\u4f18\u7684\u5de5\u4f5c\u8282\u70b9\u4e0a\u9762\u53bb\uff0c\u4ece\u800c\u66f4\u52a0\u5408\u7406\u3001\u66f4\u52a0\u5145\u5206\u7684\u5229\u7528\u96c6\u7fa4\u7684\u8d44\u6e90\uff0c\u8fd9\u4e5f\u662f\u6211\u4eec\u9009\u62e9\u4f7f\u7528 kubernetes \u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u7406\u7531\u3002\u5982\u679c\u4e00\u95e8\u65b0\u7684\u6280\u672f\u4e0d\u80fd\u5e2e\u52a9\u4f01\u4e1a\u8282\u7ea6\u6210\u672c\u3001\u63d0\u4f9b\u6548\u7387\uff0c\u6211\u76f8\u4fe1\u662f\u5f88\u96be\u63a8\u8fdb\u7684\u3002</p>"},{"location":"kubernetes_scheduler/overview/#_2","title":"\u8c03\u5ea6\u6d41\u7a0b","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c<code>kube-scheduler</code> \u63d0\u4f9b\u7684\u9ed8\u8ba4\u8c03\u5ea6\u5668\u80fd\u591f\u6ee1\u8db3\u6211\u4eec\u7edd\u5927\u591a\u6570\u7684\u8981\u6c42\uff0c\u6211\u4eec\u524d\u9762\u548c\u5927\u5bb6\u63a5\u89e6\u7684\u793a\u4f8b\u4e5f\u57fa\u672c\u4e0a\u7528\u7684\u9ed8\u8ba4\u7684\u7b56\u7565\uff0c\u90fd\u53ef\u4ee5\u4fdd\u8bc1\u6211\u4eec\u7684 Pod \u53ef\u4ee5\u88ab\u5206\u914d\u5230\u8d44\u6e90\u5145\u8db3\u7684\u8282\u70b9\u4e0a\u8fd0\u884c\u3002\u4f46\u662f\u5728\u5b9e\u9645\u7684\u7ebf\u4e0a\u9879\u76ee\u4e2d\uff0c\u53ef\u80fd\u6211\u4eec\u81ea\u5df1\u4f1a\u6bd4 kubernetes \u66f4\u52a0\u4e86\u89e3\u6211\u4eec\u81ea\u5df1\u7684\u5e94\u7528\uff0c\u6bd4\u5982\u6211\u4eec\u5e0c\u671b\u4e00\u4e2a Pod \u53ea\u80fd\u8fd0\u884c\u5728\u7279\u5b9a\u7684\u51e0\u4e2a\u8282\u70b9\u4e0a\uff0c\u6216\u8005\u8fd9\u51e0\u4e2a\u8282\u70b9\u53ea\u80fd\u7528\u6765\u8fd0\u884c\u7279\u5b9a\u7c7b\u578b\u7684\u5e94\u7528\uff0c\u8fd9\u5c31\u9700\u8981\u6211\u4eec\u7684\u8c03\u5ea6\u5668\u80fd\u591f\u53ef\u63a7\u3002</p> <p><code>kube-scheduler</code> \u7684\u4e3b\u8981\u4f5c\u7528\u5c31\u662f\u6839\u636e\u7279\u5b9a\u7684\u8c03\u5ea6\u7b97\u6cd5\u548c\u8c03\u5ea6\u7b56\u7565\u5c06 Pod \u8c03\u5ea6\u5230\u5408\u9002\u7684 Node \u8282\u70b9\u4e0a\u53bb\uff0c\u662f\u4e00\u4e2a\u72ec\u7acb\u7684\u4e8c\u8fdb\u5236\u7a0b\u5e8f\uff0c\u542f\u52a8\u4e4b\u540e\u4f1a\u4e00\u76f4\u76d1\u542c API Server\uff0c\u83b7\u53d6\u5230 <code>PodSpec.NodeName</code> \u4e3a\u7a7a\u7684 Pod\uff0c\u5bf9\u6bcf\u4e2a Pod \u90fd\u4f1a\u521b\u5efa\u4e00\u4e2a binding\u3002</p> <p></p> <p>\u8fd9\u4e2a\u8fc7\u7a0b\u5728\u6211\u4eec\u770b\u6765\u597d\u50cf\u6bd4\u8f83\u7b80\u5355\uff0c\u4f46\u5728\u5b9e\u9645\u7684\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u9700\u8981\u8003\u8651\u7684\u95ee\u9898\u5c31\u6709\u5f88\u591a\u4e86\uff1a</p> <ul> <li>\u5982\u4f55\u4fdd\u8bc1\u5168\u90e8\u7684\u8282\u70b9\u8c03\u5ea6\u7684\u516c\u5e73\u6027\uff1f\u8981\u77e5\u9053\u5e76\u4e0d\u662f\u6240\u6709\u8282\u70b9\u8d44\u6e90\u914d\u7f6e\u4e00\u5b9a\u90fd\u662f\u4e00\u6837\u7684</li> <li>\u5982\u4f55\u4fdd\u8bc1\u6bcf\u4e2a\u8282\u70b9\u90fd\u80fd\u88ab\u5206\u914d\u8d44\u6e90\uff1f</li> <li>\u96c6\u7fa4\u8d44\u6e90\u5982\u4f55\u80fd\u591f\u88ab\u9ad8\u6548\u5229\u7528\uff1f</li> <li>\u96c6\u7fa4\u8d44\u6e90\u5982\u4f55\u624d\u80fd\u88ab\u6700\u5927\u5316\u4f7f\u7528\uff1f</li> <li>\u5982\u4f55\u4fdd\u8bc1 Pod \u8c03\u5ea6\u7684\u6027\u80fd\u548c\u6548\u7387\uff1f</li> <li>\u7528\u6237\u662f\u5426\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u5b9e\u9645\u9700\u6c42\u5b9a\u5236\u81ea\u5df1\u7684\u8c03\u5ea6\u7b56\u7565\uff1f</li> </ul> <p>\u8003\u8651\u5230\u5b9e\u9645\u73af\u5883\u4e2d\u7684\u5404\u79cd\u590d\u6742\u60c5\u51b5\uff0ckubernetes \u7684\u8c03\u5ea6\u5668\u91c7\u7528\u63d2\u4ef6\u5316\u7684\u5f62\u5f0f\u5b9e\u73b0\uff0c\u53ef\u4ee5\u65b9\u4fbf\u7528\u6237\u8fdb\u884c\u5b9a\u5236\u6216\u8005\u4e8c\u6b21\u5f00\u53d1\uff0c\u6211\u4eec\u53ef\u4ee5\u81ea\u5b9a\u4e49\u4e00\u4e2a\u8c03\u5ea6\u5668\u5e76\u4ee5\u63d2\u4ef6\u5f62\u5f0f\u548c kubernetes \u8fdb\u884c\u96c6\u6210\u3002</p> <p>kubernetes \u8c03\u5ea6\u5668\u7684\u6e90\u7801\u4f4d\u4e8e </p> <pre><code>kubernetes/pkg/scheduler\n</code></pre> <p>\u4e2d\uff0c\u5927\u4f53\u7684\u4ee3\u7801\u76ee\u5f55\u7ed3\u6784\u5982\u4e0b\u6240\u793a\uff1a(\u4e0d\u540c\u7684\u7248\u672c\u76ee\u5f55\u7ed3\u6784\u53ef\u80fd\u4e0d\u592a\u4e00\u6837)</p> <pre><code>kubernetes/pkg/scheduler\n-- scheduler.go         //\u8c03\u5ea6\u76f8\u5173\u7684\u5177\u4f53\u5b9e\u73b0\n|-- algorithm\n|   |-- predicates      //\u8282\u70b9\u7b5b\u9009\u7b56\u7565\n|   |-- priorities      //\u8282\u70b9\u6253\u5206\u7b56\u7565\n|-- algorithmprovider\n|   |-- defaults         //\u5b9a\u4e49\u9ed8\u8ba4\u7684\u8c03\u5ea6\u5668\n</code></pre> <p>\u5176\u4e2d Scheduler \u521b\u5efa\u548c\u8fd0\u884c\u7684\u6838\u5fc3\u7a0b\u5e8f\uff0c\u5bf9\u5e94\u7684\u4ee3\u7801\u5728 </p> <pre><code>pkg/scheduler/scheduler.go\n</code></pre> <p>\uff0c\u5982\u679c\u8981\u67e5\u770b<code>kube-scheduler</code> \u7684\u5165\u53e3\u7a0b\u5e8f\uff0c\u5bf9\u5e94\u7684\u4ee3\u7801\u5728 </p> <pre><code>cmd/kube-scheduler/scheduler.go\n</code></pre> <p>\u3002</p> <p>\u8c03\u5ea6\u4e3b\u8981\u5206\u4e3a\u4ee5\u4e0b\u51e0\u4e2a\u90e8\u5206\uff1a</p> <ul> <li>\u9996\u5148\u662f<code>\u9884\u9009\u8fc7\u7a0b</code>\uff0c\u8fc7\u6ee4\u6389\u4e0d\u6ee1\u8db3\u6761\u4ef6\u7684\u8282\u70b9\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u79f0\u4e3a<code>Predicates</code>\uff08\u8fc7\u6ee4\uff09</li> <li>\u7136\u540e\u662f<code>\u4f18\u9009\u8fc7\u7a0b</code>\uff0c\u5bf9\u901a\u8fc7\u7684\u8282\u70b9\u6309\u7167\u4f18\u5148\u7ea7\u6392\u5e8f\uff0c\u79f0\u4e4b\u4e3a<code>Priorities</code>\uff08\u6253\u5206\uff09</li> <li>\u6700\u540e\u4ece\u4e2d\u9009\u62e9\u4f18\u5148\u7ea7\u6700\u9ad8\u7684\u8282\u70b9\uff0c\u5982\u679c\u4e2d\u95f4\u4efb\u4f55\u4e00\u6b65\u9aa4\u6709\u9519\u8bef\uff0c\u5c31\u76f4\u63a5\u8fd4\u56de\u9519\u8bef</li> </ul> <p><code>Predicates</code> \u9636\u6bb5\u9996\u5148\u904d\u5386\u5168\u90e8\u8282\u70b9\uff0c\u8fc7\u6ee4\u6389\u4e0d\u6ee1\u8db3\u6761\u4ef6\u7684\u8282\u70b9\uff0c\u5c5e\u4e8e<code>\u5f3a\u5236\u6027</code>\u89c4\u5219\uff0c\u8fd9\u4e00\u9636\u6bb5\u8f93\u51fa\u7684\u6240\u6709\u6ee1\u8db3\u8981\u6c42\u7684\u8282\u70b9\u5c06\u88ab\u8bb0\u5f55\u5e76\u4f5c\u4e3a\u7b2c\u4e8c\u9636\u6bb5\u7684\u8f93\u5165\uff0c\u5982\u679c\u6240\u6709\u7684\u8282\u70b9\u90fd\u4e0d\u6ee1\u8db3\u6761\u4ef6\uff0c\u90a3\u4e48 Pod \u5c06\u4f1a\u4e00\u76f4\u5904\u4e8e Pending \u72b6\u6001\uff0c\u76f4\u5230\u6709\u8282\u70b9\u6ee1\u8db3\u6761\u4ef6\uff0c\u5728\u8fd9\u671f\u95f4\u8c03\u5ea6\u5668\u4f1a\u4e0d\u65ad\u7684\u91cd\u8bd5\u3002</p> <p>\u6240\u4ee5\u6211\u4eec\u5728\u90e8\u7f72\u5e94\u7528\u7684\u65f6\u5019\uff0c\u5982\u679c\u53d1\u73b0\u6709 Pod \u4e00\u76f4\u5904\u4e8e Pending \u72b6\u6001\uff0c\u90a3\u4e48\u5c31\u662f\u6ca1\u6709\u6ee1\u8db3\u8c03\u5ea6\u6761\u4ef6\u7684\u8282\u70b9\uff0c\u8fd9\u4e2a\u65f6\u5019\u53ef\u4ee5\u53bb\u68c0\u67e5\u4e0b\u8282\u70b9\u8d44\u6e90\u662f\u5426\u53ef\u7528\u3002</p> <p><code>Priorities</code> \u9636\u6bb5\u5373\u518d\u6b21\u5bf9\u8282\u70b9\u8fdb\u884c\u7b5b\u9009\uff0c\u5982\u679c\u6709\u591a\u4e2a\u8282\u70b9\u90fd\u6ee1\u8db3\u6761\u4ef6\u7684\u8bdd\uff0c\u90a3\u4e48\u7cfb\u7edf\u4f1a\u6309\u7167\u8282\u70b9\u7684\u4f18\u5148\u7ea7(<code>priorites</code>)\u5927\u5c0f\u5bf9\u8282\u70b9\u8fdb\u884c\u6392\u5e8f\uff0c\u6700\u540e\u9009\u62e9\u4f18\u5148\u7ea7\u6700\u9ad8\u7684\u8282\u70b9\u6765\u90e8\u7f72 Pod \u5e94\u7528\u3002</p> <p>\u4e0b\u9762\u662f\u8c03\u5ea6\u8fc7\u7a0b\u7684\u7b80\u5355\u793a\u610f\u56fe\uff1a</p> <p></p> <p>\u66f4\u8be6\u7ec6\u7684\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p> <ul> <li>\u9996\u5148\uff0c\u5ba2\u6237\u7aef\u901a\u8fc7 API Server \u7684 REST API \u6216\u8005 kubectl \u5de5\u5177\u521b\u5efa Pod \u8d44\u6e90</li> <li>API Server \u6536\u5230\u7528\u6237\u8bf7\u6c42\u540e\uff0c\u5b58\u50a8\u76f8\u5173\u6570\u636e\u5230 etcd \u6570\u636e\u5e93\u4e2d</li> <li> <p>\u8c03\u5ea6\u5668\u76d1\u542c API Server \u67e5\u770b\u5230\u8fd8\u672a\u88ab\u8c03\u5ea6(bind)\u7684 Pod \u5217\u8868\uff0c\u5faa\u73af\u904d\u5386\u5730\u4e3a\u6bcf\u4e2a Pod \u5c1d\u8bd5\u5206\u914d\u8282\u70b9\uff0c\u8fd9\u4e2a\u5206\u914d\u8fc7\u7a0b\u5c31\u662f\u6211\u4eec\u4e0a\u9762\u63d0\u5230\u7684\u4e24\u4e2a\u9636\u6bb5\uff1a</p> <ul> <li>\u9884\u9009\u9636\u6bb5(Predicates)\uff0c\u8fc7\u6ee4\u8282\u70b9\uff0c\u8c03\u5ea6\u5668\u7528\u4e00\u7ec4\u89c4\u5219\u8fc7\u6ee4\u6389\u4e0d\u7b26\u5408\u8981\u6c42\u7684 Node \u8282\u70b9\uff0c\u6bd4\u5982 Pod \u8bbe\u7f6e\u4e86\u8d44\u6e90\u7684 request\uff0c\u90a3\u4e48\u53ef\u7528\u8d44\u6e90\u6bd4 Pod \u9700\u8981\u7684\u8d44\u6e90\u5c11\u7684\u4e3b\u673a\u663e\u7136\u5c31\u4f1a\u88ab\u8fc7\u6ee4\u6389</li> <li>\u4f18\u9009\u9636\u6bb5(Priorities)\uff0c\u4e3a\u8282\u70b9\u7684\u4f18\u5148\u7ea7\u6253\u5206\uff0c\u5c06\u4e0a\u4e00\u9636\u6bb5\u8fc7\u6ee4\u51fa\u6765\u7684 Node \u5217\u8868\u8fdb\u884c\u6253\u5206\uff0c\u8c03\u5ea6\u5668\u4f1a\u8003\u8651\u4e00\u4e9b\u6574\u4f53\u7684\u4f18\u5316\u7b56\u7565\uff0c\u6bd4\u5982\u628a Deployment \u63a7\u5236\u7684\u591a\u4e2a Pod \u526f\u672c\u5c3d\u91cf\u5206\u5e03\u5230\u4e0d\u540c\u7684\u4e3b\u673a\u4e0a\uff0c\u4f7f\u7528\u6700\u4f4e\u8d1f\u8f7d\u7684\u4e3b\u673a\u7b49\u7b49\u7b56\u7565</li> <li> <p>\u7ecf\u8fc7\u4e0a\u9762\u7684\u9636\u6bb5\u8fc7\u6ee4\u540e\u9009\u62e9\u6253\u5206\u6700\u9ad8\u7684 Node \u8282\u70b9\u548c Pod \u8fdb\u884c <code>binding</code> \u64cd\u4f5c\uff0c\u7136\u540e\u5c06\u7ed3\u679c\u5b58\u50a8\u5230 etcd \u4e2d \u6700\u540e\u88ab\u9009\u62e9\u51fa\u6765\u7684 Node \u8282\u70b9\u5bf9\u5e94\u7684 kubelet \u53bb\u6267\u884c\u521b\u5efa Pod \u7684\u76f8\u5173\u64cd\u4f5c\uff08\u5f53\u7136\u4e5f\u662f watch APIServer \u53d1\u73b0\u7684\uff09\u3002</p> </li> </ul> </li> </ul> <p>\u5176\u4e2d <code>Predicates</code> \u8fc7\u6ee4\u6709\u4e00\u7cfb\u5217\u7684\u9ed8\u8ba4\u8c03\u5ea6\u7b56\u7565\u7b97\u6cd5\u53ef\u4ee5\u4f7f\u7528\uff0c\u6211\u4eec\u8fd9\u91cc\u7b80\u5355\u5217\u4e3e\u51e0\u4e2a\uff1a</p> <ul> <li>PodFitsResources\uff1a\u8282\u70b9\u4e0a\u5269\u4f59\u7684\u8d44\u6e90\uff08\u5982 CPU \u548c\u5185\u5b58\uff09\u662f\u5426\u6ee1\u8db3 Pod \u8bf7\u6c42\u7684\u8d44\u6e90</li> <li>PodFitsHost\uff1a\u5982\u679c Pod \u6307\u5b9a\u4e86 NodeName\uff0c\u68c0\u67e5\u8282\u70b9\u540d\u79f0\u662f\u5426\u548c NodeName \u5339\u914d</li> <li>PodFitsHostPorts\uff1a\u5982\u679c Pod \u4e2d\u5b9a\u4e49\u4e86 hostPort \u5c5e\u6027\uff0c\u90a3\u4e48\u9700\u8981\u5148\u68c0\u67e5\u8fd9\u4e2a\u6307\u5b9a\u7aef\u53e3\u662f\u5426\u5df2\u7ecf\u88ab\u8282\u70b9\u4e0a\u5176\u4ed6\u670d\u52a1\u5360\u7528\u4e86</li> <li>PodMatchNodeSelector\uff1a\u68c0\u67e5 Node \u7684\u6807\u7b7e\u662f\u5426\u80fd\u5339\u914d Pod \u7684 nodeSelector \u7684\u6807\u7b7e\u503c</li> <li>NoDiskConflict\uff1a\u68c0\u67e5 Pod \u8bf7\u6c42\u7684\u5b58\u50a8\u5377\u5728 Node \u4e0a\u662f\u5426\u53ef\u7528\uff0c\u82e5\u4e0d\u5b58\u5728\u51b2\u7a81\u5219\u901a\u8fc7\u68c0\u67e5</li> <li>NoVolumeZoneConflict\uff1a\u68c0\u6d4b Pod \u8bf7\u6c42\u7684 Volumes \u5728\u8282\u70b9\u4e0a\u662f\u5426\u53ef\u7528\uff0c\u56e0\u4e3a\u67d0\u4e9b\u5b58\u50a8\u5377\u5b58\u5728\u533a\u57df\u8c03\u5ea6\u7ea6\u675f</li> <li>CheckNodeDiskPressure\uff1a\u68c0\u67e5\u8282\u70b9\u78c1\u76d8\u7a7a\u95f4\u662f\u5426\u7b26\u5408\u8981\u6c42</li> <li>CheckNodeMemoryPressure\uff1a\u68c0\u67e5\u8282\u70b9\u5185\u5b58\u662f\u5426\u591f\u7528</li> <li>CheckNodeCondition\uff1aNode \u53ef\u4ee5\u4e0a\u62a5\u5176\u81ea\u8eab\u7684\u72b6\u6001\uff0c\u5982\u78c1\u76d8\u3001\u7f51\u7edc\u4e0d\u53ef\u7528\uff0c\u8868\u660e kubelet \u672a\u51c6\u5907\u58d5\u8fd0\u884c Pod\uff0c\u5982\u679c\u8282\u70b9\u88ab\u8bbe\u7f6e\u6210\u8fd9\u79cd\u72b6\u6001\uff0c\u90a3\u4e48 Pod \u4e0d\u4f1a\u88ab\u8c03\u5ea6\u5230\u8fd9\u4e2a\u8282\u70b9\u4e0a</li> <li>PodToleratesNodeTaints\uff1a\u68c0\u67e5 Pod \u5c5e\u6027\u4e0a\u7684 tolerations \u80fd\u5426\u5bb9\u5fcd\u8282\u70b9\u7684 taints \u6c61\u70b9</li> <li>CheckVolumeBinding\uff1a\u68c0\u67e5\u8282\u70b9\u4e0a\u5df2\u7ecf\u7ed1\u5b9a\u7684\u548c\u672a\u7ed1\u5b9a\u7684 PVC \u80fd\u5426\u6ee1\u8db3 Pod \u7684\u5b58\u50a8\u5377\u9700\u6c42</li> </ul> <p>\u9664\u4e86\u8fd9\u4e9b\u8fc7\u6ee4\u7b97\u6cd5\u4e4b\u5916\uff0c\u8fd8\u6709\u4e00\u4e9b\u5176\u4ed6\u7684\u7b97\u6cd5\uff0c\u66f4\u591a\u66f4\u8be6\u7ec6\u7684\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u6e90\u7801\u6587\u4ef6\uff1a</p> <pre><code>k8s.io/kubernetes/pkg/scheduler/algorithm/predicates/predicates.go\n</code></pre> <p>\u3002</p> <p>\u800c <code>Priorities</code> \u4f18\u5148\u7ea7\u662f\u7531\u4e00\u7cfb\u5217\u952e\u503c\u5bf9\u7ec4\u6210\u7684\uff0c\u952e\u662f\u8be5\u4f18\u5148\u7ea7\u7684\u540d\u79f0\uff0c\u503c\u662f\u5b83\u7684\u6743\u91cd\u503c\uff0c\u540c\u6837\uff0c\u6211\u4eec\u8fd9\u91cc\u7ed9\u5927\u5bb6\u5217\u4e3e\u51e0\u4e2a\u5177\u6709\u4ee3\u8868\u6027\u7684\u9009\u9879\uff1a</p> <ul> <li>LeastRequestedPriority\uff1a\u901a\u8fc7\u8ba1\u7b97 CPU \u548c\u5185\u5b58\u7684\u4f7f\u7528\u7387\u6765\u51b3\u5b9a\u6743\u91cd\uff0c\u4f7f\u7528\u7387\u8d8a\u4f4e\u6743\u91cd\u8d8a\u9ad8\uff0c\u5f53\u7136\u6b63\u5e38\u80af\u5b9a\u4e5f\u662f\u8d44\u6e90\u662f\u4f7f\u7528\u7387\u8d8a\u4f4e\u6743\u91cd\u8d8a\u9ad8\uff0c\u80fd\u7ed9\u522b\u7684 Pod \u8fd0\u884c\u7684\u53ef\u80fd\u6027\u5c31\u8d8a\u5927</li> <li>SelectorSpreadPriority\uff1a\u4e3a\u4e86\u66f4\u597d\u7684\u9ad8\u53ef\u7528\uff0c\u5bf9\u540c\u5c5e\u4e8e\u4e00\u4e2a Deployment \u6216\u8005 RC \u4e0b\u9762\u7684\u591a\u4e2a Pod \u526f\u672c\uff0c\u5c3d\u91cf\u8c03\u5ea6\u5230\u591a\u4e2a\u4e0d\u540c\u7684\u8282\u70b9\u4e0a\uff0c\u5f53\u4e00\u4e2a Pod \u88ab\u8c03\u5ea6\u7684\u65f6\u5019\uff0c\u4f1a\u5148\u53bb\u67e5\u627e\u8be5 Pod \u5bf9\u5e94\u7684 controller\uff0c\u7136\u540e\u67e5\u770b\u8be5 controller \u4e0b\u9762\u7684\u5df2\u5b58\u5728\u7684 Pod\uff0c\u8fd0\u884c Pod \u8d8a\u5c11\u7684\u8282\u70b9\u6743\u91cd\u8d8a\u9ad8</li> <li>InterPodAffinityPriority\uff1a\u904d\u5386 Pod \u7684\u4eb2\u548c\u6027\u6761\u76ee\uff0c\u5e76\u5c06\u90a3\u4e9b\u80fd\u591f\u5339\u914d\u5230\u7ed9\u5b9a\u8282\u70b9\u7684\u6761\u76ee\u7684\u6743\u91cd\u76f8\u52a0\uff0c\u7ed3\u679c\u503c\u8d8a\u5927\u7684\u8282\u70b9\u5f97\u5206\u8d8a\u9ad8</li> <li>MostRequestedPriority\uff1a\u7a7a\u95f2\u8d44\u6e90\u6bd4\u4f8b\u8d8a\u4f4e\u7684 Node \u5f97\u5206\u8d8a\u9ad8\uff0c\u8fd9\u4e2a\u8c03\u5ea6\u7b56\u7565\u5c06\u4f1a\u628a\u4f60\u7684\u6240\u6709\u7684\u5de5\u4f5c\u8d1f\u8f7d\uff08Pod\uff09\u8c03\u5ea6\u5230\u5c3d\u91cf\u5c11\u7684\u8282\u70b9\u4e0a</li> <li>RequestedToCapacityRatioPriority\uff1a\u4e3a Node \u4e0a\u6bcf\u4e2a\u8d44\u6e90\u5360\u7528\u6bd4\u4f8b\u8bbe\u5b9a\u5f97\u5206\u503c\uff0c\u7ed9\u8d44\u6e90\u6253\u5206\u51fd\u6570\u5728\u6253\u5206\u65f6\u4f7f\u7528</li> <li>BalancedResourceAllocation\uff1a\u4f18\u9009\u90a3\u4e9b\u4f7f\u5f97\u8d44\u6e90\u5229\u7528\u7387\u66f4\u4e3a\u5747\u8861\u7684\u8282\u70b9\u3002</li> <li> <p>NodePreferAvoidPodsPriority\uff1a\u8fd9\u4e2a\u7b56\u7565\u5c06\u6839\u636e Node \u7684\u6ce8\u89e3\u4fe1\u606f\u4e2d\u662f\u5426\u542b\u6709 </p> <pre><code>scheduler.alpha.kubernetes.io/preferAvoidPods\n</code></pre> <p>\u6765\u8ba1\u7b97\u5176\u4f18\u5148\u7ea7\uff0c\u4f7f\u7528\u8fd9\u4e2a\u7b56\u7565\u53ef\u4ee5\u5c06\u4e24\u4e2a\u4e0d\u540c Pod \u8fd0\u884c\u5728\u4e0d\u540c\u7684 Node \u4e0a *   NodeAffinityPriority\uff1a\u57fa\u4e8e Pod \u5c5e\u6027\u4e2d </p> <pre><code>PreferredDuringSchedulingIgnoredDuringExecution\n</code></pre> <p>\u6765\u8fdb\u884c Node \u4eb2\u548c\u6027\u8c03\u5ea6 *   TaintTolerationPriority\uff1a\u57fa\u4e8e Pod \u4e2d\u5bf9\u6bcf\u4e2a Node \u4e0a\u6c61\u70b9\u5bb9\u5fcd\u7a0b\u5ea6\u8fdb\u884c\u4f18\u5148\u7ea7\u8bc4\u4f30\uff0c\u8fd9\u4e2a\u7b56\u7565\u80fd\u591f\u8c03\u6574\u5f85\u9009 Node \u7684\u6392\u540d *   ImageLocalityPriority\uff1aNode \u4e0a\u5df2\u7ecf\u62e5\u6709 Pod \u9700\u8981\u7684\u5bb9\u5668\u955c\u50cf\u7684 Node \u4f1a\u6709\u8f83\u9ad8\u7684\u4f18\u5148\u7ea7 *   ServiceSpreadingPriority\uff1a\u8fd9\u4e2a\u8c03\u5ea6\u7b56\u7565\u7684\u4e3b\u8981\u76ee\u7684\u662f\u786e\u4fdd\u5c06\u5f52\u5c5e\u4e8e\u540c\u4e00\u4e2a Service \u7684 Pod \u8c03\u5ea6\u5230\u4e0d\u540c\u7684 Node \u4e0a\uff0c\u5982\u679c Node \u4e0a\u6ca1\u6709\u5f52\u5c5e\u4e8e\u540c\u4e00\u4e2a Service \u7684 Pod\uff0c\u8fd9\u4e2a\u7b56\u7565\u66f4\u503e\u5411\u4e8e\u5c06 Pod \u8c03\u5ea6\u5230\u8fd9\u7c7b Node \u4e0a\u3002\u6700\u7ec8\u7684\u76ee\u7684\uff1a\u5373\u4f7f\u5728\u4e00\u4e2a Node \u5b95\u673a\u4e4b\u540e Service \u4e5f\u5177\u6709\u5f88\u5f3a\u5bb9\u707e\u80fd\u529b\u3002 *   CalculateAntiAffinityPriorityMap\uff1a\u8fd9\u4e2a\u7b56\u7565\u4e3b\u8981\u662f\u7528\u6765\u5b9e\u73b0 Pod \u53cd\u4eb2\u548c\u7684 *   EqualPriorityMap\uff1a\u5c06\u6240\u6709\u7684 Node \u8bbe\u7f6e\u6210\u76f8\u540c\u7684\u6743\u91cd\u4e3a 1</p> </li> </ul> <p>\u9664\u4e86\u8fd9\u4e9b\u7b56\u7565\u4e4b\u5916\uff0c\u8fd8\u6709\u5f88\u591a\u5176\u4ed6\u7684\u7b56\u7565\uff0c\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u6e90\u7801\u6587\u4ef6\uff1a</p> <pre><code>k8s.io/kubernetes/pkg/scheduler/algorithm/priorities/\n</code></pre> <p>\u4e86\u89e3\u66f4\u591a\u4fe1\u606f\u3002\u6bcf\u4e00\u4e2a\u4f18\u5148\u7ea7\u51fd\u6570\u4f1a\u8fd4\u56de\u4e00\u4e2a <code>0-10</code> \u7684\u5206\u6570\uff0c\u5206\u6570\u8d8a\u9ad8\u8868\u793a\u8282\u70b9\u8d8a\u4f18\uff0c\u540c\u65f6\u6bcf\u4e00\u4e2a\u51fd\u6570\u4e5f\u4f1a\u5bf9\u5e94\u4e00\u4e2a\u8868\u793a\u6743\u91cd\u7684\u503c\u3002\u6700\u7ec8\u4e3b\u673a\u7684\u5f97\u5206\u7528\u4ee5\u4e0b\u516c\u5f0f\u8ba1\u7b97\u5f97\u51fa\uff1a</p> <pre><code>finalScoreNode = (weight1 * priorityFunc1) + (weight2 * priorityFunc2) + \u2026 + (weightn * priorityFuncn)\n</code></pre>"},{"location":"kubernetes_scheduler/overview/#_3","title":"\u8c03\u5ea6\u5668\u8c03\u4f18","text":"<p>\u4f5c\u4e3a kubernetes \u96c6\u7fa4\u7684\u9ed8\u8ba4\u8c03\u5ea6\u5668\uff0ckube-scheduler \u4e3b\u8981\u8d1f\u8d23\u5c06 Pod \u8c03\u5ea6\u5230\u96c6\u7fa4\u7684 Node \u4e0a\u3002\u5728\u4e00\u4e2a\u96c6\u7fa4\u4e2d\uff0c\u6ee1\u8db3\u4e00\u4e2a Pod \u8c03\u5ea6\u8bf7\u6c42\u7684\u6240\u6709\u8282\u70b9\u79f0\u4e4b\u4e3a <code>\u53ef\u8c03\u5ea6 Node</code>\uff0c\u8c03\u5ea6\u5668\u5148\u5728\u96c6\u7fa4\u4e2d\u627e\u5230\u4e00\u4e2a Pod \u7684\u53ef\u8c03\u5ea6 Node\uff0c\u7136\u540e\u6839\u636e\u4e00\u7cfb\u5217\u51fd\u6570\u5bf9\u8fd9\u4e9b\u53ef\u8c03\u5ea6 Node \u8fdb\u884c\u6253\u5206\uff0c\u4e4b\u540e\u9009\u51fa\u5176\u4e2d\u5f97\u5206\u6700\u9ad8\u7684 Node \u6765\u8fd0\u884c Pod\uff0c\u6700\u540e\uff0c\u8c03\u5ea6\u5668\u5c06\u8fd9\u4e2a\u8c03\u5ea6\u51b3\u5b9a\u544a\u77e5 <code>kube-apiserver</code>\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u53eb\u505a<code>\u7ed1\u5b9a</code>\u3002</p> <p>\u5728 Kubernetes 1.12 \u7248\u672c\u4e4b\u524d\uff0ckube-scheduler \u4f1a\u68c0\u67e5\u96c6\u7fa4\u4e2d\u6240\u6709\u8282\u70b9\u7684\u53ef\u8c03\u5ea6\u6027\uff0c\u5e76\u4e14\u7ed9\u53ef\u8c03\u5ea6\u8282\u70b9\u6253\u5206\u3002Kubernetes 1.12 \u7248\u672c\u6dfb\u52a0\u4e86\u4e00\u4e2a\u65b0\u7684\u529f\u80fd\uff0c\u5141\u8bb8\u8c03\u5ea6\u5668\u5728\u627e\u5230\u4e00\u5b9a\u6570\u91cf\u7684\u53ef\u8c03\u5ea6\u8282\u70b9\u4e4b\u540e\u5c31\u505c\u6b62\u7ee7\u7eed\u5bfb\u627e\u53ef\u8c03\u5ea6\u8282\u70b9\u3002\u8be5\u529f\u80fd\u80fd\u63d0\u9ad8\u8c03\u5ea6\u5668\u5728\u5927\u89c4\u6a21\u96c6\u7fa4\u4e0b\u7684\u8c03\u5ea6\u6027\u80fd\uff0c\u8fd9\u4e2a\u6570\u503c\u662f\u96c6\u7fa4\u89c4\u6a21\u7684\u767e\u5206\u6bd4\uff0c\u8fd9\u4e2a\u767e\u5206\u6bd4\u901a\u8fc7 </p> <pre><code>percentageOfNodesToScore\n</code></pre> <p>\u53c2\u6570\u6765\u8fdb\u884c\u914d\u7f6e\uff0c\u5176\u503c\u7684\u8303\u56f4\u5728 1 \u5230 100 \u4e4b\u95f4\uff0c\u6700\u5927\u503c\u5c31\u662f 100%\uff0c\u5982\u679c\u8bbe\u7f6e\u4e3a 0 \u5c31\u4ee3\u8868\u6ca1\u6709\u63d0\u4f9b\u8fd9\u4e2a\u53c2\u6570\u914d\u7f6e\u3002Kubernetes 1.14 \u7248\u672c\u53c8\u52a0\u5165\u4e86\u4e00\u4e2a\u7279\u6027\uff0c\u5728\u8be5\u53c2\u6570\u6ca1\u6709\u88ab\u7528\u6237\u914d\u7f6e\u7684\u60c5\u51b5\u4e0b\uff0c\u8c03\u5ea6\u5668\u4f1a\u6839\u636e\u96c6\u7fa4\u7684\u89c4\u6a21\u81ea\u52a8\u8bbe\u7f6e\u4e00\u4e2a\u96c6\u7fa4\u6bd4\u4f8b\uff0c\u7136\u540e\u901a\u8fc7\u8fd9\u4e2a\u6bd4\u4f8b\u7b5b\u9009\u4e00\u5b9a\u6570\u91cf\u7684\u53ef\u8c03\u5ea6\u8282\u70b9\u8fdb\u5165\u6253\u5206\u9636\u6bb5\u3002\u8be5\u7279\u6027\u4f7f\u7528<code>\u7ebf\u6027\u516c\u5f0f</code>\u8ba1\u7b97\u51fa\u96c6\u7fa4\u6bd4\u4f8b\uff0c\u6bd4\u5982100\u4e2a\u8282\u70b9\u7684\u96c6\u7fa4\u4e0b\u4f1a\u53d6 50%\uff0c\u5728 5000\u8282\u70b9\u7684\u96c6\u7fa4\u4e0b\u53d6 10%\uff0c\u8fd9\u4e2a\u81ea\u52a8\u8bbe\u7f6e\u7684\u53c2\u6570\u7684\u6700\u4f4e\u503c\u662f 5%\uff0c\u6362\u53e5\u8bdd\u8bf4\uff0c\u8c03\u5ea6\u5668\u81f3\u5c11\u4f1a\u5bf9\u96c6\u7fa4\u4e2d 5% \u7684\u8282\u70b9\u8fdb\u884c\u6253\u5206\uff0c\u9664\u975e\u7528\u6237\u5c06\u8be5\u53c2\u6570\u8bbe\u7f6e\u7684\u4f4e\u4e8e 5\u3002</p> <p>\u6ce8\u610f</p> <p>\u5f53\u96c6\u7fa4\u4e2d\u7684\u53ef\u8c03\u5ea6\u8282\u70b9\u5c11\u4e8e 50 \u4e2a\u65f6\uff0c\u8c03\u5ea6\u5668\u4ecd\u7136\u4f1a\u53bb\u68c0\u67e5\u6240\u6709\u8282\u70b9\uff0c\u56e0\u4e3a\u53ef\u8c03\u5ea6\u8282\u70b9\u592a\u5c11\uff0c\u4e0d\u8db3\u4ee5\u505c\u6b62\u8c03\u5ea6\u5668\u6700\u521d\u7684\u8fc7\u6ee4\u9009\u62e9\u3002\u5982\u679c\u6211\u4eec\u60f3\u8981\u5173\u6389\u8fd9\u4e2a\u8303\u56f4\u53c2\u6570\uff0c\u53ef\u4ee5\u5c06 </p> <pre><code>percentageOfNodesToScore\n</code></pre> <p>\u503c\u8bbe\u7f6e\u6210 100\u3002</p> <p>``` percentageOfNodesToScore <pre><code> \u7684\u503c\u5fc5\u987b\u5728 1 \u5230 100 \u4e4b\u95f4\uff0c\u800c\u4e14\u5176\u9ed8\u8ba4\u503c\u662f\u901a\u8fc7\u96c6\u7fa4\u7684\u89c4\u6a21\u8ba1\u7b97\u5f97\u6765\u7684\uff0c\u53e6\u5916 `50` \u4e2a Node \u7684\u6570\u503c\u662f\u786c\u7f16\u7801\u5728\u7a0b\u5e8f\u91cc\u9762\u7684\uff0c\u8bbe\u7f6e\u8fd9\u4e2a\u503c\u7684\u4f5c\u7528\u5728\u4e8e\uff1a`\u5f53\u96c6\u7fa4\u7684\u89c4\u6a21\u662f\u6570\u767e\u4e2a\u8282\u70b9\u5e76\u4e14 percentageOfNodesToScore \u53c2\u6570\u8bbe\u7f6e\u7684\u8fc7\u4f4e\u7684\u65f6\u5019\uff0c\u8c03\u5ea6\u5668\u7b5b\u9009\u5230\u7684\u53ef\u8c03\u5ea6\u8282\u70b9\u6570\u76ee\u57fa\u672c\u4e0d\u4f1a\u53d7\u5230\u8be5\u53c2\u6570\u5f71\u54cd`\u3002\u5f53\u96c6\u7fa4\u89c4\u6a21\u8f83\u5c0f\u65f6\uff0c\u8fd9\u4e2a\u8bbe\u7f6e\u5bf9\u8c03\u5ea6\u5668\u6027\u80fd\u63d0\u5347\u5e76\u4e0d\u660e\u663e\uff0c\u4f46\u662f\u5728\u8d85\u8fc7 1000 \u4e2a Node \u7684\u96c6\u7fa4\u4e2d\uff0c\u5c06\u8c03\u4f18\u53c2\u6570\u8bbe\u7f6e\u4e3a\u4e00\u4e2a\u8f83\u4f4e\u7684\u503c\u53ef\u4ee5\u5f88\u660e\u663e\u7684\u63d0\u5347\u8c03\u5ea6\u5668\u6027\u80fd\u3002\n\n&gt; \u4e0d\u8fc7\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u8be5\u53c2\u6570\u8bbe\u7f6e\u540e\u53ef\u80fd\u4f1a\u5bfc\u81f4\u53ea\u6709\u96c6\u7fa4\u4e2d\u5c11\u6570\u8282\u70b9\u88ab\u9009\u4e3a\u53ef\u8c03\u5ea6\u8282\u70b9\uff0c\u5f88\u591a Node \u90fd\u6ca1\u6709\u8fdb\u5165\u5230\u6253\u5206\u9636\u6bb5\uff0c\u8fd9\u6837\u5c31\u4f1a\u9020\u6210\u4e00\u79cd\u540e\u679c\uff0c\u4e00\u4e2a\u672c\u6765\u53ef\u4ee5\u5728\u6253\u5206\u9636\u6bb5\u5f97\u5206\u5f88\u9ad8\u7684 Node \u751a\u81f3\u90fd\u4e0d\u80fd\u8fdb\u5165\u6253\u5206\u9636\u6bb5\uff0c\u7531\u4e8e\u8fd9\u4e2a\u539f\u56e0\uff0c\u6240\u4ee5\u8fd9\u4e2a\u53c2\u6570\u4e0d\u5e94\u8be5\u88ab\u8bbe\u7f6e\u6210\u4e00\u4e2a\u5f88\u4f4e\u7684\u503c\uff0c\u901a\u5e38\u7684\u505a\u6cd5\u662f\u4e0d\u4f1a\u5c06\u8fd9\u4e2a\u53c2\u6570\u7684\u503c\u8bbe\u7f6e\u7684\u4f4e\u4e8e 10\uff0c\u5f88\u4f4e\u7684\u53c2\u6570\u503c\u4e00\u822c\u5728\u8c03\u5ea6\u5668\u7684\u541e\u5410\u91cf\u5f88\u9ad8\u4e14\u5bf9 Node \u7684\u6253\u5206\u4e0d\u91cd\u8981\u7684\u60c5\u51b5\u4e0b\u624d\u4f7f\u7528\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c\u53ea\u6709\u5f53\u4f60\u66f4\u503e\u5411\u4e8e\u5728\u53ef\u8c03\u5ea6\u8282\u70b9\u4e2d\u4efb\u610f\u9009\u62e9\u4e00\u4e2a Node \u6765\u8fd0\u884c\u8fd9\u4e2a Pod \u65f6\uff0c\u624d\u4f7f\u7528\u5f88\u4f4e\u7684\u53c2\u6570\u8bbe\u7f6e\u3002\n\n&gt; \u5982\u679c\u4f60\u7684\u96c6\u7fa4\u89c4\u6a21\u53ea\u6709\u6570\u767e\u4e2a\u8282\u70b9\u6216\u8005\u66f4\u5c11\uff0c\u5b9e\u9645\u4e0a\u5e76\u4e0d\u63a8\u8350\u4f60\u5c06\u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u5f97\u6bd4\u9ed8\u8ba4\u503c\u66f4\u4f4e\uff0c\u56e0\u4e3a\u8fd9\u79cd\u60c5\u51b5\u4e0b\u4e0d\u592a\u4f1a\u6709\u6548\u7684\u63d0\u9ad8\u8c03\u5ea6\u5668\u6027\u80fd\u3002\n\n### \u81ea\u5b9a\u4e49\u8c03\u5ea6\u5668 \n\n&gt; \u4e00\u822c\u6765\u8bf4\uff0c\u6211\u4eec\u67094\u79cd\u6269\u5c55 Kubernetes \u8c03\u5ea6\u5668\u7684\u65b9\u6cd5\u3002\n\n*   &gt; \u4e00\u79cd\u65b9\u6cd5\u5c31\u662f\u76f4\u63a5 clone \u5b98\u65b9\u7684 kube-scheduler \u6e90\u4ee3\u7801\uff0c\u5728\u5408\u9002\u7684\u4f4d\u7f6e\u76f4\u63a5\u4fee\u6539\u4ee3\u7801\uff0c\u7136\u540e\u91cd\u65b0\u7f16\u8bd1\u8fd0\u884c\u4fee\u6539\u540e\u7684\u7a0b\u5e8f\uff0c\u5f53\u7136\u8fd9\u79cd\u65b9\u6cd5\u662f\u6700\u4e0d\u5efa\u8bae\u4f7f\u7528\u7684\uff0c\u4e5f\u4e0d\u5b9e\u7528\uff0c\u56e0\u4e3a\u9700\u8981\u82b1\u8d39\u5927\u91cf\u989d\u5916\u7684\u7cbe\u529b\u6765\u548c\u4e0a\u6e38\u7684\u8c03\u5ea6\u7a0b\u5e8f\u66f4\u6539\u4fdd\u6301\u4e00\u81f4\u3002\n\n*   &gt; \u7b2c\u4e8c\u79cd\u65b9\u6cd5\u5c31\u662f\u548c\u9ed8\u8ba4\u7684\u8c03\u5ea6\u7a0b\u5e8f\u4e00\u8d77\u8fd0\u884c\u72ec\u7acb\u7684\u8c03\u5ea6\u7a0b\u5e8f\uff0c\u9ed8\u8ba4\u7684\u8c03\u5ea6\u5668\u548c\u6211\u4eec\u81ea\u5b9a\u4e49\u7684\u8c03\u5ea6\u5668\u53ef\u4ee5\u901a\u8fc7 Pod \u7684 `spec.schedulerName` \u6765\u8986\u76d6\u5404\u81ea\u7684 Pod\uff0c\u9ed8\u8ba4\u662f\u4f7f\u7528 default \u9ed8\u8ba4\u7684\u8c03\u5ea6\u5668\uff0c\u4f46\u662f\u591a\u4e2a\u8c03\u5ea6\u7a0b\u5e8f\u5171\u5b58\u7684\u60c5\u51b5\u4e0b\u4e5f\u6bd4\u8f83\u9ebb\u70e6\uff0c\u6bd4\u5982\u5f53\u591a\u4e2a\u8c03\u5ea6\u5668\u5c06 Pod \u8c03\u5ea6\u5230\u540c\u4e00\u4e2a\u8282\u70b9\u7684\u65f6\u5019\uff0c\u53ef\u80fd\u4f1a\u9047\u5230\u4e00\u4e9b\u95ee\u9898\uff0c\u56e0\u4e3a\u5f88\u6709\u53ef\u80fd\u4e24\u4e2a\u8c03\u5ea6\u5668\u90fd\u540c\u65f6\u5c06\u4e24\u4e2a Pod \u8c03\u5ea6\u5230\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a\u53bb\uff0c\u4f46\u662f\u5f88\u6709\u53ef\u80fd\u5176\u4e2d\u4e00\u4e2a Pod \u8fd0\u884c\u540e\u5176\u5b9e\u8d44\u6e90\u5c31\u6d88\u8017\u5b8c\u4e86\uff0c\u5e76\u4e14\u7ef4\u62a4\u4e00\u4e2a\u9ad8\u8d28\u91cf\u7684\u81ea\u5b9a\u4e49\u8c03\u5ea6\u7a0b\u5e8f\u4e5f\u4e0d\u662f\u5f88\u5bb9\u6613\u7684\uff0c\u56e0\u4e3a\u6211\u4eec\u9700\u8981\u5168\u9762\u4e86\u89e3\u9ed8\u8ba4\u7684\u8c03\u5ea6\u7a0b\u5e8f\uff0c\u6574\u4f53 Kubernetes \u7684\u67b6\u6784\u77e5\u8bc6\u4ee5\u53ca\u5404\u79cd Kubernetes API \u5bf9\u8c61\u7684\u5404\u79cd\u5173\u7cfb\u6216\u9650\u5236\u3002\n\n*   &gt; \u7b2c\u4e09\u79cd\u65b9\u6cd5\u662f\u8c03\u5ea6\u5668\u6269\u5c55\u7a0b\u5e8f\uff0c\u8fd9\u4e2a\u65b9\u6848\u76ee\u524d\u662f\u4e00\u4e2a\u53ef\u884c\u7684\u65b9\u6848\uff0c\u53ef\u4ee5\u548c\u4e0a\u6e38\u8c03\u5ea6\u7a0b\u5e8f\u517c\u5bb9\uff0c\u6240\u8c13\u7684\u8c03\u5ea6\u5668\u6269\u5c55\u7a0b\u5e8f\u5176\u5b9e\u5c31\u662f\u4e00\u4e2a\u53ef\u914d\u7f6e\u7684 Webhook \u800c\u5df2\uff0c\u91cc\u9762\u5305\u542b `\u8fc7\u6ee4\u5668` \u548c `\u4f18\u5148\u7ea7` \u4e24\u4e2a\u7aef\u70b9\uff0c\u5206\u522b\u5bf9\u5e94\u8c03\u5ea6\u5468\u671f\u4e2d\u7684\u4e24\u4e2a\u4e3b\u8981\u9636\u6bb5\uff08\u8fc7\u6ee4\u548c\u6253\u5206\uff09\u3002\n\n*   &gt; \u7b2c\u56db\u79cd\u65b9\u6cd5\u662f\u901a\u8fc7\u8c03\u5ea6\u6846\u67b6\uff08Scheduling Framework\uff09\uff0cKubernetes v1.15 \u7248\u672c\u4e2d\u5f15\u5165\u4e86\u53ef\u63d2\u62d4\u67b6\u6784\u7684\u8c03\u5ea6\u6846\u67b6\uff0c\u4f7f\u5f97\u5b9a\u5236\u8c03\u5ea6\u5668\u8fd9\u4e2a\u4efb\u52a1\u53d8\u5f97\u66f4\u52a0\u7684\u5bb9\u6613\u3002\u8c03\u5e93\u6846\u67b6\u5411\u73b0\u6709\u7684\u8c03\u5ea6\u5668\u4e2d\u6dfb\u52a0\u4e86\u4e00\u7ec4\u63d2\u4ef6\u5316\u7684 API\uff0c\u8be5 API \u5728\u4fdd\u6301\u8c03\u5ea6\u7a0b\u5e8f\u6838\u5fc3\u7b80\u5355\u4e14\u6613\u4e8e\u7ef4\u62a4\u7684\u540c\u65f6\uff0c\u4f7f\u5f97\u5927\u90e8\u5206\u7684\u8c03\u5ea6\u529f\u80fd\u4ee5\u63d2\u4ef6\u7684\u5f62\u5f0f\u5b58\u5728\uff0c\u800c\u4e14\u5728\u6211\u4eec\u73b0\u5728\u7684 v1.16 \u7248\u672c\u4e2d\u4e0a\u9762\u7684 `\u8c03\u5ea6\u5668\u6269\u5c55\u7a0b\u5e8f` \u4e5f\u5df2\u7ecf\u88ab\u5e9f\u5f03\u4e86\uff0c\u6240\u4ee5\u4ee5\u540e\u8c03\u5ea6\u6846\u67b6\u624d\u662f\u81ea\u5b9a\u4e49\u8c03\u5ea6\u5668\u7684\u6838\u5fc3\u65b9\u5f0f\u3002\n\n&gt; \u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u7b80\u5355\u4ecb\u7ecd\u4e0b\u540e\u9762\u4e24\u79cd\u65b9\u5f0f\u7684\u5b9e\u73b0\u3002\n\n### \u8c03\u5ea6\u5668\u6269\u5c55\u7a0b\u5e8f \n\n&gt; \u5728\u8fdb\u5165\u8c03\u5ea6\u5668\u6269\u5c55\u7a0b\u5e8f\u4e4b\u524d\uff0c\u6211\u4eec\u518d\u6765\u4e86\u89e3\u4e0b Kubernetes \u8c03\u5ea6\u7a0b\u5e8f\u662f\u5982\u4f55\u5de5\u4f5c\u7684:\n\n1.  \u9ed8\u8ba4\u8c03\u5ea6\u5668\u6839\u636e\u6307\u5b9a\u7684\u53c2\u6570\u542f\u52a8\uff08\u6211\u4eec\u4f7f\u7528 kubeadm \u642d\u5efa\u7684\u96c6\u7fa4\uff0c\u542f\u52a8\u914d\u7f6e\u6587\u4ef6\u4f4d\u4e8e \n\n    ```\n    /etc/kubernetes/manifests/kube-schdueler.yaml\n    ```\n\n    \uff09\n2.  watch apiserver\uff0c\u5c06 `spec.nodeName` \u4e3a\u7a7a\u7684 Pod \u653e\u5165\u8c03\u5ea6\u5668\u5185\u90e8\u7684\u8c03\u5ea6\u961f\u5217\u4e2d\n3.  \u4ece\u8c03\u5ea6\u961f\u5217\u4e2d Pop \u51fa\u4e00\u4e2a Pod\uff0c\u5f00\u59cb\u4e00\u4e2a\u6807\u51c6\u7684\u8c03\u5ea6\u5468\u671f\n4.  \u4ece Pod \u5c5e\u6027\u4e2d\u68c0\u7d22\u201c\u786c\u6027\u8981\u6c42\u201d\uff08\u6bd4\u5982 CPU/\u5185\u5b58\u8bf7\u6c42\u503c\uff0cnodeSelector/nodeAffinity\uff09\uff0c\u7136\u540e\u8fc7\u6ee4\u9636\u6bb5\u53d1\u751f\uff0c\u5728\u8be5\u9636\u6bb5\u8ba1\u7b97\u51fa\u6ee1\u8db3\u8981\u6c42\u7684\u8282\u70b9\u5019\u9009\u5217\u8868\n5.  \u4ece Pod \u5c5e\u6027\u4e2d\u68c0\u7d22\u201c\u8f6f\u9700\u6c42\u201d\uff0c\u5e76\u5e94\u7528\u4e00\u4e9b\u9ed8\u8ba4\u7684\u201c\u8f6f\u7b56\u7565\u201d\uff08\u6bd4\u5982 Pod \u503e\u5411\u4e8e\u5728\u8282\u70b9\u4e0a\u66f4\u52a0\u805a\u62e2\u6216\u5206\u6563\uff09\uff0c\u6700\u540e\uff0c\u5b83\u4e3a\u6bcf\u4e2a\u5019\u9009\u8282\u70b9\u7ed9\u51fa\u4e00\u4e2a\u5206\u6570\uff0c\u5e76\u6311\u9009\u51fa\u5f97\u5206\u6700\u9ad8\u7684\u6700\u7ec8\u83b7\u80dc\u8005\n6.  \u548c apiserver \u901a\u4fe1\uff08\u53d1\u9001\u7ed1\u5b9a\u8c03\u7528\uff09\uff0c\u7136\u540e\u8bbe\u7f6e Pod \u7684 `spec.nodeName` \u5c5e\u6027\u4ee5\u8868\u793a\u5c06\u8be5 Pod \u8c03\u5ea6\u5230\u7684\u8282\u70b9\u3002\n\n&gt; \u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u67e5\u770b\u5b98\u65b9\u6587\u6863\uff0c\u53ef\u4ee5\u901a\u8fc7 `--config` \u53c2\u6570\u6307\u5b9a\u8c03\u5ea6\u5668\u5c06\u4f7f\u7528\u54ea\u4e9b\u53c2\u6570\uff0c\u8be5\u914d\u7f6e\u6587\u4ef6\u5e94\u8be5\u5305\u542b\u4e00\u4e2a KubeSchedulerConfiguration \u5bf9\u8c61\uff0c\u5982\u4e0b\u6240\u793a\u683c\u5f0f\uff1a\uff08/etc/kubernetes/scheduler-extender.yaml)\n</code></pre></p>"},{"location":"kubernetes_scheduler/overview/#--config","title":"\u901a\u8fc7\"--config\" \u4f20\u9012\u6587\u4ef6\u5185\u5bb9","text":"<p>apiVersion: kubescheduler.config.k8s.io/v1alpha1 kind: KubeSchedulerConfiguration clientConnection:   kubeconfig: \"/etc/kubernetes/scheduler.conf\" algorithmSource:   policy:     file:       path: \"/etc/kubernetes/scheduler-extender-policy.yaml\"  # \u6307\u5b9a\u81ea\u5b9a\u4e49\u8c03\u5ea6\u7b56\u7565\u6587\u4ef6 <pre><code>&gt; \u6211\u4eec\u5728\u8fd9\u91cc\u5e94\u8be5\u8f93\u5165\u7684\u5173\u952e\u53c2\u6570\u662f \n</code></pre> algorithmSource.policy <pre><code>\uff0c\u8fd9\u4e2a\u7b56\u7565\u6587\u4ef6\u53ef\u4ee5\u662f\u672c\u5730\u6587\u4ef6\u4e5f\u53ef\u4ee5\u662f ConfigMap \u8d44\u6e90\u5bf9\u8c61\uff0c\u8fd9\u53d6\u51b3\u4e8e\u8c03\u5ea6\u7a0b\u5e8f\u7684\u90e8\u7f72\u65b9\u5f0f\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u9ed8\u8ba4\u7684\u8c03\u5ea6\u5668\u662f\u9759\u6001 Pod \u65b9\u5f0f\u542f\u52a8\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u7528\u672c\u5730\u6587\u4ef6\u7684\u5f62\u5f0f\u6765\u914d\u7f6e\u3002\n\n&gt; \u8be5\u7b56\u7565\u6587\u4ef6 \n</code></pre> /etc/kubernetes/scheduler-extender-policy.yaml <pre><code> \u5e94\u8be5\u9075\u5faa kubernetes/pkg/scheduler/apis/config/legacy_types.go#L28 \u7684\u8981\u6c42\uff0c\u5728\u6211\u4eec\u8fd9\u91cc\u7684 v1.16.2 \u7248\u672c\u4e2d\u5df2\u7ecf\u652f\u6301 JSON \u548c YAML \u4e24\u79cd\u683c\u5f0f\u7684\u7b56\u7565\u6587\u4ef6\uff0c\u4e0b\u9762\u662f\u6211\u4eec\u5b9a\u4e49\u7684\u4e00\u4e2a\u7b80\u5355\u7684\u793a\u4f8b\uff0c\u53ef\u4ee5\u67e5\u770b Extender \u63cf\u8ff0\u4e86\u89e3\u7b56\u7565\u6587\u4ef6\u7684\u5b9a\u4e49\u89c4\u8303\uff1a\n</code></pre> apiVersion: v1 kind: Policy extenders: - urlPrefix: \"http://11:8888/\"   filterVerb: \"filter\"   prioritizeVerb: \"prioritize\"   weight: 1   enableHttps: false <pre><code>&gt; \u81ea\u5b9a\u4e49\n\n&gt; \u6211\u4eec\u8fd9\u91cc\u7684 Policy \u7b56\u7565\u6587\u4ef6\u662f\u901a\u8fc7\u5b9a\u4e49 `extenders` \u6765\u6269\u5c55\u8c03\u5ea6\u5668\u7684\uff0c\u6709\u65f6\u5019\u6211\u4eec\u4e0d\u9700\u8981\u53bb\u7f16\u5199\u4ee3\u7801\uff0c\u53ef\u4ee5\u76f4\u63a5\u5728\u8be5\u914d\u7f6e\u6587\u4ef6\u4e2d\u901a\u8fc7\u6307\u5b9a `predicates` \u548c `priorities` \u6765\u8fdb\u884c\u81ea\u5b9a\u4e49\uff0c\u5982\u679c\u6ca1\u6709\u6307\u5b9a\u5219\u4f1a\u4f7f\u7528\u9ed8\u8ba4\u7684 `DefaultProvier`\u3002\n</code></pre> {   \"kind\": \"Policy\",   \"apiVersion\": \"v1\",   \"predicates\": [{         \"name\": \"MatchNodeSelector\"     }, {         \"name\": \"PodFitsResources\"     }, {         \"name\": \"PodFitsHostPorts\"     },{         \"name\": \"HostName\"     }   ],   \"priorities\": [{         \"name\": \"EqualPriority\",         \"weight\": 2     }, {         \"name\": \"ImageLocalityPriority\",         \"weight\": 4     }, {         \"name\": \"LeastRequestedPriority\",         \"weight\": 2     }, {         \"name\": \"BalancedResourceAllocation\",         \"weight\": 2     }   ],   \"extenders\": [{         \"urlPrefix\": \"/prefix\",         \"filterVerb\": \"filter\",         \"prioritizeVerb\": \"prioritize\",         \"weight\": 1,         \"bindVerb\": \"bind\",         \"enableHttps\": false   }] } <pre><code>&gt; \u6539\u7b56\u7565\u6587\u4ef6\u5b9a\u4e49\u4e86\u4e00\u4e2a HTTP \u7684\u6269\u5c55\u7a0b\u5e8f\u670d\u52a1\uff0c\u8be5\u670d\u52a1\u8fd0\u884c\u5728 `127.0.0.1:8888` \u4e0b\u9762\uff0c\u5e76\u4e14\u5df2\u7ecf\u5c06\u8be5\u7b56\u7565\u6ce8\u518c\u5230\u4e86\u9ed8\u8ba4\u7684\u8c03\u5ea6\u5668\u4e2d\uff0c\u8fd9\u6837\u5728\u8fc7\u6ee4\u548c\u6253\u5206\u9636\u6bb5\u7ed3\u675f\u540e\uff0c\u53ef\u4ee5\u5c06\u7ed3\u679c\u5206\u522b\u4f20\u9012\u7ed9\u8be5\u6269\u5c55\u7a0b\u5e8f\u7684\u7aef\u70b9 \n</code></pre> / <pre><code> \u548c \n</code></pre> / <pre><code>\uff0c\u5728\u6269\u5c55\u7a0b\u5e8f\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u8fdb\u4e00\u6b65\u8fc7\u6ee4\u5e76\u786e\u5b9a\u4f18\u5148\u7ea7\uff0c\u4ee5\u9002\u5e94\u6211\u4eec\u7684\u7279\u5b9a\u4e1a\u52a1\u9700\u6c42\u3002\n\n#### \u793a\u4f8b \n\n&gt; \u6211\u4eec\u76f4\u63a5\u7528 golang \u6765\u5b9e\u73b0\u4e00\u4e2a\u7b80\u5355\u7684\u8c03\u5ea6\u5668\u6269\u5c55\u7a0b\u5e8f\uff0c\u5f53\u7136\u4f60\u53ef\u4ee5\u4f7f\u7528\u5176\u4ed6\u4efb\u4f55\u7f16\u7a0b\u8bed\u8a00\uff0c\u5982\u4e0b\u6240\u793a\uff1a\n</code></pre> func main() {     router := httprouter.New()     router.GET(\"/\", Index)     router.POST(\"/filter\", Filter)     router.POST(\"/prioritize\", Prioritize) <pre><code>log.Fatal(http.ListenAndServe(\":8888\", router))\n</code></pre> <p>} ``` </p> <p>\u7136\u540e\u63a5\u4e0b\u6765\u6211\u4eec\u9700\u8981\u5b9e\u73b0 <code>/filter</code> \u548c <code>/prioritize</code> \u4e24\u4e2a\u7aef\u70b9\u7684\u5904\u7406\u7a0b\u5e8f\u3002</p> <p>\u5176\u4e2d <code>Filter</code> \u8fd9\u4e2a\u6269\u5c55\u51fd\u6570\u63a5\u6536\u4e00\u4e2a\u8f93\u5165\u7c7b\u578b\u4e3a </p> <p><code>schedulerapi.ExtenderArgs</code></p> <p>\u7684\u53c2\u6570\uff0c\u7136\u540e\u8fd4\u56de\u4e00\u4e2a\u7c7b\u578b\u4e3a </p> <p><code>*schedulerapi.ExtenderFilterResult</code></p> <p>\u7684\u503c\u3002\u5728\u51fd\u6570\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u8fdb\u4e00\u6b65\u8fc7\u6ee4\u8f93\u5165\u7684\u8282\u70b9\uff1a</p> <p>``` // filter \u6839\u636e\u6269\u5c55\u7a0b\u5e8f\u5b9a\u4e49\u7684\u9884\u9009\u89c4\u5219\u6765\u8fc7\u6ee4\u8282\u70b9 func filter(args schedulerapi.ExtenderArgs) *schedulerapi.ExtenderFilterResult {     var filteredNodes []vNode     failedNodes := make(schedulerapi.FailedNodesMap)     pod := args.Pod</p> <pre><code>for _, node := range args.Nodes.Items {\n    fits, failReasons, _ := podFitsOnNode(pod, node)\n    if fits {\n        filteredNodes = append(filteredNodes, node)\n    } else {\n        failedNodes[node.Name] = strings.Join(failReasons, \",\")\n    }\n}\n\nresult := schedulerapi.ExtenderFilterResult{\n    Nodes: &amp;vNodeList{\n        Items: filteredNodes,\n    },\n    FailedNodes: failedNodes,\n    Error:       \"\",\n}\n\nreturn &amp;result\n</code></pre> <p>} ``` </p> <p>\u5728\u8fc7\u6ee4\u51fd\u6570\u4e2d\uff0c\u6211\u4eec\u5faa\u73af\u6bcf\u4e2a\u8282\u70b9\u7136\u540e\u7528\u6211\u4eec\u81ea\u5df1\u5b9e\u73b0\u7684\u4e1a\u52a1\u903b\u8f91\u6765\u5224\u65ad\u662f\u5426\u5e94\u8be5\u6279\u51c6\u8be5\u8282\u70b9\uff0c\u8fd9\u91cc\u6211\u4eec\u5b9e\u73b0\u6bd4\u8f83\u7b80\u5355\uff0c\u5728 <code>podFitsOnNode()</code> \u51fd\u6570\u4e2d\u6211\u4eec\u53ea\u662f\u7b80\u5355\u7684\u68c0\u67e5\u968f\u673a\u6570\u662f\u5426\u4e3a\u5076\u6570\u6765\u5224\u65ad\u5373\u53ef\uff0c\u5982\u679c\u662f\u7684\u8bdd\u6211\u4eec\u5c31\u8ba4\u4e3a\u8fd9\u662f\u4e00\u4e2a\u5e78\u8fd0\u7684\u8282\u70b9\uff0c\u5426\u5219\u62d2\u7edd\u6279\u51c6\u8be5\u8282\u70b9\u3002</p> <p>``` var predicatesSorted = []string{LuckyPred}</p> <p>var predicatesFuncs = map[string]FitPredicate{     LuckyPred: LuckyPredicate, }</p> <p>type FitPredicate func(pod *vPod, node vNode) (bool, []string, error)</p> <p>func podFitsOnNode(pod *vPod, node vNode) (bool, []string, error) {     fits := true     var failReasons []string     for _, predicateKey := range predicatesSorted {         fit, failures, err := predicatesFuncspredicateKey         if err != nil {             return false, nil, err         }         fits = fits &amp;&amp; fit         failReasons = append(failReasons, failures...)     }     return fits, failReasons, nil }</p> <p>func LuckyPredicate(pod *vPod, node vNode) (bool, []string, error) {     lucky := rand.Intn(2) == 0     if lucky {         log.Printf(\"pod %v/%v is lucky to fit on node %v\\n\", pod.Name, pod.Namespace, node.Name)         return true, nil, nil     }     log.Printf(\"pod %v/%v is unlucky to fit on node %v\\n\", pod.Name, pod.Namespace, node.Name)     return false, []string{LuckyPredFailMsg}, nil } <pre><code>&gt; \u540c\u6837\u7684\u6253\u5206\u529f\u80fd\u7528\u540c\u6837\u7684\u65b9\u5f0f\u6765\u5b9e\u73b0\uff0c\u6211\u4eec\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u968f\u673a\u7ed9\u51fa\u4e00\u4e2a\u5206\u6570\uff1a\n</code></pre> // it's webhooked to pkg/scheduler/core/generic_scheduler.go#PrioritizeNodes() // \u8fd9\u4e2a\u51fd\u6570\u8f93\u51fa\u7684\u5206\u6570\u4f1a\u88ab\u6dfb\u52a0\u4f1a\u9ed8\u8ba4\u7684\u8c03\u5ea6\u5668 func prioritize(args schedulerapi.ExtenderArgs) *schedulerapi.HostPriorityList {     pod := args.Pod     nodes := args.Nodes.Items</p> <pre><code>hostPriorityList := make(schedulerapi.HostPriorityList, len(nodes))\nfor i, node := range nodes {\n    score := rand.Intn(schedulerapi.MaxPriority + 1)  // \u5728\u6700\u5927\u4f18\u5148\u7ea7\u5185\u968f\u673a\u53d6\u4e00\u4e2a\u503c\n    log.Printf(luckyPrioMsg, pod.Name, pod.Namespace, score)\n    hostPriorityList[i] = schedulerapi.HostPriority{\n        Host:  node.Name,\n        Score: score,\n    }\n}\n\nreturn &amp;hostPriorityList\n</code></pre> <p>} ``` </p> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u7f16\u8bd1\u6253\u5305\u6211\u4eec\u7684\u5e94\u7528\uff1a</p> <p><code>$ GOOS=linux GOARCH=amd64 go build -o app</code></p> <p>\u4ee3\u7801</p> <p>\u672c\u8282\u8c03\u5ea6\u5668\u6269\u5c55\u7a0b\u5e8f\u5b8c\u6574\u7684\u4ee3\u7801\u83b7\u53d6\u5730\u5740\uff1ahttps://github.com/cnych/sample-scheduler-extender\u3002</p> <p>\u6784\u5efa\u5b8c\u6210\u540e\uff0c\u5c06\u5e94\u7528 <code>app</code> \u62f7\u8d1d\u5230 <code>kube-scheduler</code> \u6240\u5728\u7684\u8282\u70b9\u76f4\u63a5\u8fd0\u884c\u5373\u53ef\u3002\u73b0\u5728\u6211\u4eec\u5c31\u53ef\u4ee5\u5c06\u4e0a\u9762\u7684\u7b56\u7565\u6587\u4ef6\u914d\u7f6e\u5230 <code>kube-scheduler</code> \u7ec4\u4ef6\u4e2d\u53bb\u4e86\uff0c\u6211\u4eec\u8fd9\u91cc\u96c6\u7fa4\u662f kubeadm \u642d\u5efa\u7684\uff0c\u6240\u4ee5\u76f4\u63a5\u4fee\u6539\u6587\u4ef6 </p> <p><code>/etc/kubernetes/manifests/kube-schduler.yaml</code></p> <p>\u6587\u4ef6\u5373\u53ef\uff0c\u5185\u5bb9\u5982\u4e0b\u6240\u793a\uff1a</p> <p><code>apiVersion: v1 kind: Pod metadata:   creationTimestamp: null   labels:     component: kube-scheduler     tier: control-plane   name: kube-scheduler   namespace: kube-system spec:   containers:   - command:     - kube-scheduler     - --authentication-kubeconfig=/etc/kubernetes/scheduler.conf     - --authorization-kubeconfig=/etc/kubernetes/scheduler.conf     - --bind-address=11     - --kubeconfig=/etc/kubernetes/scheduler.conf     - --leader-elect=true     - --config=/etc/kubernetes/scheduler-extender.yaml     - --v=9     image: gcr.azk8s.cn/google_containers/kube-scheduler:v2     imagePullPolicy: IfNotPresent     livenessProbe:       failureThreshold: 8       httpGet:         host: 11         path: /healthz         port: 10251         scheme: HTTP       initialDelaySeconds: 15       timeoutSeconds: 15     name: kube-scheduler     resources:       requests:         cpu: 100m     volumeMounts:     - mountPath: /etc/kubernetes/scheduler.conf       name: kubeconfig       readOnly: true     - mountPath: /etc/kubernetes/scheduler-extender.yaml       name: extender       readOnly: true     - mountPath: /etc/kubernetes/scheduler-extender-policy.yaml       name: extender-policy       readOnly: true   hostNetwork: true   priorityClassName: system-cluster-critical   volumes:   - hostPath:       path: /etc/kubernetes/scheduler.conf       type: FileOrCreate     name: kubeconfig   - hostPath:       path: /etc/kubernetes/scheduler-extender.yaml       type: FileOrCreate     name: extender   - hostPath:       path: /etc/kubernetes/scheduler-extender-policy.yaml       type: FileOrCreate     name: extender-policy status: {}</code></p> <p>\u6ce8\u610f</p> <p>\u5f53\u7136\u6211\u4eec\u8fd9\u4e2a\u5730\u65b9\u662f\u76f4\u63a5\u5728\u7cfb\u7edf\u9ed8\u8ba4\u7684 <code>kube-scheduler</code> \u4e0a\u9762\u914d\u7f6e\u7684\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u590d\u5236\u4e00\u4e2a\u8c03\u5ea6\u5668\u7684 YAML \u6587\u4ef6\u7136\u540e\u66f4\u6539\u4e0b schedulerName \u6765\u90e8\u7f72\uff0c\u8fd9\u6837\u5c31\u4e0d\u4f1a\u5f71\u54cd\u9ed8\u8ba4\u7684\u8c03\u5ea6\u5668\u4e86\uff0c\u7136\u540e\u5728\u9700\u8981\u4f7f\u7528\u8fd9\u4e2a\u6d4b\u8bd5\u7684\u8c03\u5ea6\u5668\u7684 Pod \u4e0a\u9762\u6307\u5b9a <code>spec.schedulerName</code> \u5373\u53ef\u3002\u5bf9\u4e8e\u591a\u8c03\u5ea6\u5668\u7684\u4f7f\u7528\u53ef\u4ee5\u67e5\u770b\u5b98\u65b9\u6587\u6863 \u914d\u7f6e\u591a\u4e2a\u8c03\u5ea6\u5668\u3002</p> <p><code>kube-scheduler</code> \u91cd\u65b0\u914d\u7f6e\u540e\u53ef\u4ee5\u67e5\u770b\u65e5\u5fd7\u6765\u9a8c\u8bc1\u662f\u5426\u91cd\u542f\u6210\u529f\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\u4e00\u5b9a\u9700\u8981\u5c06 </p> <p><code>/etc/kubernetes/scheduler-extender.yaml</code></p> <p>\u548c </p> <p><code>/etc/kubernetes/scheduler-extender-policy.yaml</code></p> <p>\u4e24\u4e2a\u6587\u4ef6\u6302\u8f7d\u5230 Pod \u4e2d\u53bb\uff1a</p> <p><code>$ kubectl logs -f kube-scheduler-ydzs-master -n kube-system I0102 15:17:824657       1 serving.go:319] Generated self-signed cert in-memory I0102 15:17:472276       1 server.go:143] Version: v2 I0102 15:17:472674       1 defaults.go:91] TaintNodesByCondition is enabled, PodToleratesNodeTaints predicate is mandatory W0102 15:17:479704       1 authorization.go:47] Authorization is disabled W0102 15:17:479733       1 authentication.go:79] Authentication is disabled I0102 15:17:479777       1 deprecated_insecure_serving.go:51] Serving healthz insecurely on [::]:10251 I0102 15:17:480559       1 secure_serving.go:123] Serving securely on 11:10259 I0102 15:17:682180       1 leaderelection.go:241] attempting to acquire leader lease  kube-system/kube-scheduler... I0102 15:17:500505       1 leaderelection.go:251] successfully acquired lease kube-system/kube-scheduler</code></p> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u521b\u5efa\u5e76\u914d\u7f6e\u4e86\u4e00\u4e2a\u975e\u5e38\u7b80\u5355\u7684\u8c03\u5ea6\u6269\u5c55\u7a0b\u5e8f\uff0c\u73b0\u5728\u6211\u4eec\u6765\u8fd0\u884c\u4e00\u4e2a Deployment \u67e5\u770b\u5176\u5de5\u4f5c\u539f\u7406\uff0c\u6211\u4eec\u51c6\u5907\u4e00\u4e2a\u5305\u542b20\u4e2a\u526f\u672c\u7684\u90e8\u7f72 Yaml\uff1a(test-scheduler.yaml)</p> <p><code>apiVersion: apps/v1 kind: Deployment metadata:   name: pause spec:   replicas: 20   selector:     matchLabels:       app: pause   template:     metadata:       labels:         app: pause     spec:       containers:       - name: pause         image: gcr.azk8s.cn/google_containers/pause:1</code></p> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <p><code>$ kuectl apply -f test-scheduler.yaml deployment.apps/pause created</code></p> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u53bb\u67e5\u770b\u4e0b\u6211\u4eec\u7f16\u5199\u7684\u8c03\u5ea6\u5668\u6269\u5c55\u7a0b\u5e8f\u65e5\u5fd7\uff1a</p> <p><code>$ ./app ...... 2020/01/03 12:27:29 pod pause-58584fbc95-bwn7t/default is unlucky to fit on node ydzs-node1 2020/01/03 12:27:29 pod pause-58584fbc95-bwn7t/default is lucky to get score 7 2020/01/03 12:27:29 pod pause-58584fbc95-bwn7t/default is lucky to get score 9 2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is unlucky to fit on node ydzs-node3 2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is unlucky to fit on node ydzs-node4 2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is lucky to fit on node ydzs-node1 2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is lucky to fit on node ydzs-node2 2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is lucky to get score 4 2020/01/03 12:27:29 pod pause-58584fbc95-86w92/default is lucky to get score 8 ......</code></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Pod \u8c03\u5ea6\u7684\u8fc7\u7a0b\uff0c\u53e6\u5916\u9ed8\u8ba4\u8c03\u5ea6\u7a0b\u5e8f\u4f1a\u5b9a\u671f\u91cd\u8bd5\u5931\u8d25\u7684 Pod\uff0c\u56e0\u6b64\u5b83\u4eec\u5c06\u4e00\u6b21\u53c8\u4e00\u6b21\u5730\u91cd\u65b0\u4f20\u9012\u5230\u6211\u4eec\u7684\u8c03\u5ea6\u6269\u5c55\u7a0b\u5e8f\u4e0a\uff0c\u6211\u4eec\u7684\u903b\u8f91\u662f\u68c0\u67e5\u968f\u673a\u6570\u662f\u5426\u4e3a\u5076\u6570\uff0c\u6240\u4ee5\u6700\u7ec8\u6240\u6709 Pod \u90fd\u5c06\u5904\u4e8e\u8fd0\u884c\u72b6\u6001\u3002</p> <p>\u8c03\u5ea6\u5668\u6269\u5c55\u7a0b\u5e8f\u53ef\u80fd\u662f\u5728\u4e00\u4e9b\u60c5\u51b5\u4e0b\u53ef\u4ee5\u6ee1\u8db3\u6211\u4eec\u7684\u9700\u6c42\uff0c\u4f46\u662f\u4ed6\u4ecd\u7136\u6709\u4e00\u4e9b\u9650\u5236\u548c\u7f3a\u70b9\uff1a</p> <ul> <li>\u901a\u4fe1\u6210\u672c\uff1a\u6570\u636e\u5728\u9ed8\u8ba4\u8c03\u5ea6\u7a0b\u5e8f\u548c\u8c03\u5ea6\u5668\u6269\u5c55\u7a0b\u5e8f\u4e4b\u95f4\u4ee5 <code>http\uff08s\uff09</code>\u4f20\u8f93\uff0c\u5728\u6267\u884c\u5e8f\u5217\u5316\u548c\u53cd\u5e8f\u5217\u5316\u7684\u65f6\u5019\u6709\u4e00\u5b9a\u6210\u672c</li> <li>\u6709\u9650\u7684\u6269\u5c55\u70b9\uff1a\u6269\u5c55\u7a0b\u5e8f\u53ea\u80fd\u5728\u67d0\u4e9b\u9636\u6bb5\u7684\u672b\u5c3e\u53c2\u4e0e\uff0c\u4f8b\u5982<code>\u201c Filter\u201d</code>\u548c<code>\u201c Prioritize\u201d</code>\uff0c\u5b83\u4eec\u4e0d\u80fd\u5728\u4efb\u4f55\u9636\u6bb5\u7684\u5f00\u59cb\u6216\u4e2d\u95f4\u88ab\u8c03\u7528</li> <li>\u51cf\u6cd5\u4f18\u4e8e\u52a0\u6cd5\uff1a\u4e0e\u9ed8\u8ba4\u8c03\u5ea6\u7a0b\u5e8f\u4f20\u9012\u7684\u8282\u70b9\u5019\u9009\u5217\u8868\u76f8\u6bd4\uff0c\u6211\u4eec\u53ef\u80fd\u6709\u4e00\u4e9b\u9700\u6c42\u9700\u8981\u6dfb\u52a0\u65b0\u7684\u5019\u9009\u8282\u70b9\u5217\u8868\uff0c\u4f46\u8fd9\u662f\u6bd4\u8f83\u5192\u9669\u7684\u64cd\u4f5c\uff0c\u56e0\u4e3a\u4e0d\u80fd\u4fdd\u8bc1\u65b0\u8282\u70b9\u53ef\u4ee5\u901a\u8fc7\u5176\u4ed6\u8981\u6c42\uff0c\u6240\u4ee5\uff0c\u8c03\u5ea6\u5668\u6269\u5c55\u7a0b\u5e8f\u6700\u597d\u6267\u884c<code>\u201c\u51cf\u6cd5\u201d</code>\uff08\u8fdb\u4e00\u6b65\u8fc7\u6ee4\uff09\uff0c\u800c\u4e0d\u662f<code>\u201c\u52a0\u6cd5\u201d</code>\uff08\u6dfb\u52a0\u8282\u70b9\uff09</li> <li>\u7f13\u5b58\u5171\u4eab\uff1a\u4e0a\u9762\u53ea\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u6d4b\u8bd5\u793a\u4f8b\uff0c\u4f46\u5728\u771f\u5b9e\u7684\u9879\u76ee\u4e2d\uff0c\u6211\u4eec\u662f\u9700\u8981\u901a\u8fc7\u67e5\u770b\u6574\u4e2a\u96c6\u7fa4\u7684\u72b6\u6001\u6765\u505a\u51fa\u8c03\u5ea6\u51b3\u7b56\u7684\uff0c\u9ed8\u8ba4\u8c03\u5ea6\u7a0b\u5e8f\u53ef\u4ee5\u5f88\u597d\u5730\u8c03\u5ea6\u51b3\u7b56\uff0c\u4f46\u662f\u65e0\u6cd5\u5171\u4eab\u5176\u7f13\u5b58\uff0c\u8fd9\u610f\u5473\u7740\u6211\u4eec\u5fc5\u987b\u6784\u5efa\u548c\u7ef4\u62a4\u81ea\u5df1\u7684\u7f13\u5b58</li> </ul> <p>\u7531\u4e8e\u8fd9\u4e9b\u5c40\u9650\u6027\uff0cKubernetes \u8c03\u5ea6\u5c0f\u7ec4\u5c31\u63d0\u51fa\u4e86\u4e0a\u9762\u7b2c\u56db\u79cd\u65b9\u6cd5\u6765\u8fdb\u884c\u66f4\u597d\u7684\u6269\u5c55\uff0c\u4e5f\u5c31\u662f</p> <p><code>\u8c03\u5ea6\u6846\u67b6\uff08Scheduler Framework\uff09</code></p> <p>\uff0c\u5b83\u57fa\u672c\u4e0a\u53ef\u4ee5\u89e3\u51b3\u6211\u4eec\u9047\u5230\u7684\u6240\u6709\u96be\u9898\uff0c\u73b0\u5728\u4e5f\u5df2\u7ecf\u6210\u5b98\u65b9\u63a8\u8350\u7684\u6269\u5c55\u65b9\u5f0f\uff0c\u6240\u4ee5\u8fd9\u5c06\u662f\u4ee5\u540e\u6269\u5c55\u8c03\u5ea6\u5668\u7684\u6700\u4e3b\u6d41\u7684\u65b9\u5f0f\u3002 </p>"},{"location":"kubernetes_scheduler/overview/#_4","title":"\u8c03\u5ea6\u6846\u67b6","text":"<p>\u8c03\u5ea6\u6846\u67b6\u5b9a\u4e49\u4e86\u4e00\u7ec4\u6269\u5c55\u70b9\uff0c\u7528\u6237\u53ef\u4ee5\u5b9e\u73b0\u6269\u5c55\u70b9\u5b9a\u4e49\u7684\u63a5\u53e3\u6765\u5b9a\u4e49\u81ea\u5df1\u7684\u8c03\u5ea6\u903b\u8f91\uff08\u6211\u4eec\u79f0\u4e4b\u4e3a<code>\u6269\u5c55</code>\uff09\uff0c\u5e76\u5c06\u6269\u5c55\u6ce8\u518c\u5230\u6269\u5c55\u70b9\u4e0a\uff0c\u8c03\u5ea6\u6846\u67b6\u5728\u6267\u884c\u8c03\u5ea6\u5de5\u4f5c\u6d41\u65f6\uff0c\u9047\u5230\u5bf9\u5e94\u7684\u6269\u5c55\u70b9\u65f6\uff0c\u5c06\u8c03\u7528\u7528\u6237\u6ce8\u518c\u7684\u6269\u5c55\u3002\u8c03\u5ea6\u6846\u67b6\u5728\u9884\u7559\u6269\u5c55\u70b9\u65f6\uff0c\u90fd\u662f\u6709\u7279\u5b9a\u7684\u76ee\u7684\uff0c\u6709\u4e9b\u6269\u5c55\u70b9\u4e0a\u7684\u6269\u5c55\u53ef\u4ee5\u6539\u53d8\u8c03\u5ea6\u7a0b\u5e8f\u7684\u51b3\u7b56\u65b9\u6cd5\uff0c\u6709\u4e9b\u6269\u5c55\u70b9\u4e0a\u7684\u6269\u5c55\u53ea\u662f\u53d1\u9001\u4e00\u4e2a\u901a\u77e5\u3002</p> <p>\u6211\u4eec\u77e5\u9053\u6bcf\u5f53\u8c03\u5ea6\u4e00\u4e2a Pod \u65f6\uff0c\u90fd\u4f1a\u6309\u7167\u4e24\u4e2a\u8fc7\u7a0b\u6765\u6267\u884c\uff1a\u8c03\u5ea6\u8fc7\u7a0b\u548c\u7ed1\u5b9a\u8fc7\u7a0b\u3002</p> <p>\u8c03\u5ea6\u8fc7\u7a0b\u4e3a Pod \u9009\u62e9\u4e00\u4e2a\u5408\u9002\u7684\u8282\u70b9\uff0c\u7ed1\u5b9a\u8fc7\u7a0b\u5219\u5c06\u8c03\u5ea6\u8fc7\u7a0b\u7684\u51b3\u7b56\u5e94\u7528\u5230\u96c6\u7fa4\u4e2d\uff08\u4e5f\u5c31\u662f\u5728\u88ab\u9009\u5b9a\u7684\u8282\u70b9\u4e0a\u8fd0\u884c Pod\uff09\uff0c\u5c06\u8c03\u5ea6\u8fc7\u7a0b\u548c\u7ed1\u5b9a\u8fc7\u7a0b\u5408\u5728\u4e00\u8d77\uff0c\u79f0\u4e4b\u4e3a<code>\u8c03\u5ea6\u4e0a\u4e0b\u6587\uff08scheduling context\uff09</code>\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\u8c03\u5ea6\u8fc7\u7a0b\u662f<code>\u540c\u6b65</code>\u8fd0\u884c\u7684\uff08\u540c\u4e00\u65f6\u95f4\u70b9\u53ea\u4e3a\u4e00\u4e2a Pod \u8fdb\u884c\u8c03\u5ea6\uff09\uff0c\u7ed1\u5b9a\u8fc7\u7a0b\u53ef\u5f02\u6b65\u8fd0\u884c\uff08\u540c\u4e00\u65f6\u95f4\u70b9\u53ef\u5e76\u53d1\u4e3a\u591a\u4e2a Pod \u6267\u884c\u7ed1\u5b9a\uff09\u3002</p> <p>\u8c03\u5ea6\u8fc7\u7a0b\u548c\u7ed1\u5b9a\u8fc7\u7a0b\u9047\u5230\u5982\u4e0b\u60c5\u51b5\u65f6\u4f1a\u4e2d\u9014\u9000\u51fa\uff1a</p> <ul> <li>\u8c03\u5ea6\u7a0b\u5e8f\u8ba4\u4e3a\u5f53\u524d\u6ca1\u6709\u8be5 Pod \u7684\u53ef\u9009\u8282\u70b9</li> <li>\u5185\u90e8\u9519\u8bef</li> </ul> <p>\u8fd9\u4e2a\u65f6\u5019\uff0c\u8be5 Pod \u5c06\u88ab\u653e\u56de\u5230 <code>\u5f85\u8c03\u5ea6\u961f\u5217</code>\uff0c\u5e76\u7b49\u5f85\u4e0b\u6b21\u91cd\u8bd5\u3002 </p>"},{"location":"kubernetes_scheduler/overview/#extension_points","title":"\u6269\u5c55\u70b9\uff08Extension Points\uff09","text":"<p>\u4e0b\u56fe\u5c55\u793a\u4e86\u8c03\u5ea6\u6846\u67b6\u4e2d\u7684\u8c03\u5ea6\u4e0a\u4e0b\u6587\u53ca\u5176\u4e2d\u7684\u6269\u5c55\u70b9\uff0c\u4e00\u4e2a\u6269\u5c55\u53ef\u4ee5\u6ce8\u518c\u591a\u4e2a\u6269\u5c55\u70b9\uff0c\u4ee5\u4fbf\u53ef\u4ee5\u6267\u884c\u66f4\u590d\u6742\u7684\u6709\u72b6\u6001\u7684\u4efb\u52a1\u3002</p> <p></p> <ol> <li><code>QueueSort</code> \u6269\u5c55\u7528\u4e8e\u5bf9 Pod \u7684\u5f85\u8c03\u5ea6\u961f\u5217\u8fdb\u884c\u6392\u5e8f\uff0c\u4ee5\u51b3\u5b9a\u5148\u8c03\u5ea6\u54ea\u4e2a Pod\uff0c<code>QueueSort</code> \u6269\u5c55\u672c\u8d28\u4e0a\u53ea\u9700\u8981\u5b9e\u73b0\u4e00\u4e2a\u65b9\u6cd5 <code>Less(Pod1, Pod2)</code> \u7528\u4e8e\u6bd4\u8f83\u4e24\u4e2a Pod \u8c01\u66f4\u4f18\u5148\u83b7\u5f97\u8c03\u5ea6\u5373\u53ef\uff0c\u540c\u4e00\u65f6\u95f4\u70b9\u53ea\u80fd\u6709\u4e00\u4e2a <code>QueueSort</code> \u63d2\u4ef6\u751f\u6548\u3002</li> <li><code>Pre-filter</code> \u6269\u5c55\u7528\u4e8e\u5bf9 Pod \u7684\u4fe1\u606f\u8fdb\u884c\u9884\u5904\u7406\uff0c\u6216\u8005\u68c0\u67e5\u4e00\u4e9b\u96c6\u7fa4\u6216 Pod \u5fc5\u987b\u6ee1\u8db3\u7684\u524d\u63d0\u6761\u4ef6\uff0c\u5982\u679c <code>pre-filter</code> \u8fd4\u56de\u4e86 error\uff0c\u5219\u8c03\u5ea6\u8fc7\u7a0b\u7ec8\u6b62\u3002</li> <li><code>Filter</code> \u6269\u5c55\u7528\u4e8e\u6392\u9664\u90a3\u4e9b\u4e0d\u80fd\u8fd0\u884c\u8be5 Pod \u7684\u8282\u70b9\uff0c\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u8282\u70b9\uff0c\u8c03\u5ea6\u5668\u5c06\u6309\u987a\u5e8f\u6267\u884c <code>filter</code> \u6269\u5c55\uff1b\u5982\u679c\u4efb\u4f55\u4e00\u4e2a <code>filter</code> \u5c06\u8282\u70b9\u6807\u8bb0\u4e3a\u4e0d\u53ef\u9009\uff0c\u5219\u4f59\u4e0b\u7684 <code>filter</code> \u6269\u5c55\u5c06\u4e0d\u4f1a\u88ab\u6267\u884c\u3002\u8c03\u5ea6\u5668\u53ef\u4ee5\u540c\u65f6\u5bf9\u591a\u4e2a\u8282\u70b9\u6267\u884c <code>filter</code> \u6269\u5c55\u3002</li> <li><code>Post-filter</code> \u662f\u4e00\u4e2a\u901a\u77e5\u7c7b\u578b\u7684\u6269\u5c55\u70b9\uff0c\u8c03\u7528\u8be5\u6269\u5c55\u7684\u53c2\u6570\u662f <code>filter</code> \u9636\u6bb5\u7ed3\u675f\u540e\u88ab\u7b5b\u9009\u4e3a<code>\u53ef\u9009\u8282\u70b9</code>\u7684\u8282\u70b9\u5217\u8868\uff0c\u53ef\u4ee5\u5728\u6269\u5c55\u4e2d\u4f7f\u7528\u8fd9\u4e9b\u4fe1\u606f\u66f4\u65b0\u5185\u90e8\u72b6\u6001\uff0c\u6216\u8005\u4ea7\u751f\u65e5\u5fd7\u6216 metrics \u4fe1\u606f\u3002</li> <li><code>Scoring</code> \u6269\u5c55\u7528\u4e8e\u4e3a\u6240\u6709\u53ef\u9009\u8282\u70b9\u8fdb\u884c\u6253\u5206\uff0c\u8c03\u5ea6\u5668\u5c06\u9488\u5bf9\u6bcf\u4e00\u4e2a\u8282\u70b9\u8c03\u7528 <code>Soring</code> \u6269\u5c55\uff0c\u8bc4\u5206\u7ed3\u679c\u662f\u4e00\u4e2a\u8303\u56f4\u5185\u7684\u6574\u6570\u3002\u5728 <code>normalize scoring</code> \u9636\u6bb5\uff0c\u8c03\u5ea6\u5668\u5c06\u4f1a\u628a\u6bcf\u4e2a <code>scoring</code> \u6269\u5c55\u5bf9\u5177\u4f53\u67d0\u4e2a\u8282\u70b9\u7684\u8bc4\u5206\u7ed3\u679c\u548c\u8be5\u6269\u5c55\u7684\u6743\u91cd\u5408\u5e76\u8d77\u6765\uff0c\u4f5c\u4e3a\u6700\u7ec8\u8bc4\u5206\u7ed3\u679c\u3002</li> <li><code>Normalize scoring</code> \u6269\u5c55\u5728\u8c03\u5ea6\u5668\u5bf9\u8282\u70b9\u8fdb\u884c\u6700\u7ec8\u6392\u5e8f\u4e4b\u524d\u4fee\u6539\u6bcf\u4e2a\u8282\u70b9\u7684\u8bc4\u5206\u7ed3\u679c\uff0c\u6ce8\u518c\u5230\u8be5\u6269\u5c55\u70b9\u7684\u6269\u5c55\u5728\u88ab\u8c03\u7528\u65f6\uff0c\u5c06\u83b7\u5f97\u540c\u4e00\u4e2a\u63d2\u4ef6\u4e2d\u7684 <code>scoring</code> \u6269\u5c55\u7684\u8bc4\u5206\u7ed3\u679c\u4f5c\u4e3a\u53c2\u6570\uff0c\u8c03\u5ea6\u6846\u67b6\u6bcf\u6267\u884c\u4e00\u6b21\u8c03\u5ea6\uff0c\u90fd\u5c06\u8c03\u7528\u6240\u6709\u63d2\u4ef6\u4e2d\u7684\u4e00\u4e2a <code>normalize scoring</code> \u6269\u5c55\u4e00\u6b21\u3002</li> <li><code>Reserve</code> \u662f\u4e00\u4e2a\u901a\u77e5\u6027\u8d28\u7684\u6269\u5c55\u70b9\uff0c\u6709\u72b6\u6001\u7684\u63d2\u4ef6\u53ef\u4ee5\u4f7f\u7528\u8be5\u6269\u5c55\u70b9\u6765\u83b7\u5f97\u8282\u70b9\u4e0a\u4e3a Pod \u9884\u7559\u7684\u8d44\u6e90\uff0c\u8be5\u4e8b\u4ef6\u53d1\u751f\u5728\u8c03\u5ea6\u5668\u5c06 Pod \u7ed1\u5b9a\u5230\u8282\u70b9\u4e4b\u524d\uff0c\u76ee\u7684\u662f\u907f\u514d\u8c03\u5ea6\u5668\u5728\u7b49\u5f85 Pod \u4e0e\u8282\u70b9\u7ed1\u5b9a\u7684\u8fc7\u7a0b\u4e2d\u8c03\u5ea6\u65b0\u7684 Pod \u5230\u8282\u70b9\u4e0a\u65f6\uff0c\u53d1\u751f\u5b9e\u9645\u4f7f\u7528\u8d44\u6e90\u8d85\u51fa\u53ef\u7528\u8d44\u6e90\u7684\u60c5\u51b5\u3002\uff08\u56e0\u4e3a\u7ed1\u5b9a Pod \u5230\u8282\u70b9\u4e0a\u662f\u5f02\u6b65\u53d1\u751f\u7684\uff09\u3002\u8fd9\u662f\u8c03\u5ea6\u8fc7\u7a0b\u7684\u6700\u540e\u4e00\u4e2a\u6b65\u9aa4\uff0cPod \u8fdb\u5165 reserved \u72b6\u6001\u4ee5\u540e\uff0c\u8981\u4e48\u5728\u7ed1\u5b9a\u5931\u8d25\u65f6\u89e6\u53d1 Unreserve \u6269\u5c55\uff0c\u8981\u4e48\u5728\u7ed1\u5b9a\u6210\u529f\u65f6\uff0c\u7531 Post-bind \u6269\u5c55\u7ed3\u675f\u7ed1\u5b9a\u8fc7\u7a0b\u3002</li> <li> <p><code>Permit</code> \u6269\u5c55\u7528\u4e8e\u963b\u6b62\u6216\u8005\u5ef6\u8fdf Pod \u4e0e\u8282\u70b9\u7684\u7ed1\u5b9a\u3002Permit \u6269\u5c55\u53ef\u4ee5\u505a\u4e0b\u9762\u4e09\u4ef6\u4e8b\u4e2d\u7684\u4e00\u9879\uff1a</p> <ul> <li>approve\uff08\u6279\u51c6\uff09\uff1a\u5f53\u6240\u6709\u7684 permit \u6269\u5c55\u90fd approve \u4e86 Pod \u4e0e\u8282\u70b9\u7684\u7ed1\u5b9a\uff0c\u8c03\u5ea6\u5668\u5c06\u7ee7\u7eed\u6267\u884c\u7ed1\u5b9a\u8fc7\u7a0b</li> <li>deny\uff08\u62d2\u7edd\uff09\uff1a\u5982\u679c\u4efb\u4f55\u4e00\u4e2a permit \u6269\u5c55 deny \u4e86 Pod \u4e0e\u8282\u70b9\u7684\u7ed1\u5b9a\uff0cPod \u5c06\u88ab\u653e\u56de\u5230\u5f85\u8c03\u5ea6\u961f\u5217\uff0c\u6b64\u65f6\u5c06\u89e6\u53d1 <code>Unreserve</code> \u6269\u5c55</li> <li>wait\uff08\u7b49\u5f85\uff09\uff1a\u5982\u679c\u4e00\u4e2a permit \u6269\u5c55\u8fd4\u56de\u4e86 wait\uff0c\u5219 Pod \u5c06\u4fdd\u6301\u5728 permit \u9636\u6bb5\uff0c\u76f4\u5230\u88ab\u5176\u4ed6\u6269\u5c55 approve\uff0c\u5982\u679c\u8d85\u65f6\u4e8b\u4ef6\u53d1\u751f\uff0cwait \u72b6\u6001\u53d8\u6210 deny\uff0cPod \u5c06\u88ab\u653e\u56de\u5230\u5f85\u8c03\u5ea6\u961f\u5217\uff0c\u6b64\u65f6\u5c06\u89e6\u53d1 Unreserve \u6269\u5c55</li> <li> <p><code>Pre-bind</code> \u6269\u5c55\u7528\u4e8e\u5728 Pod \u7ed1\u5b9a\u4e4b\u524d\u6267\u884c\u67d0\u4e9b\u903b\u8f91\u3002\u4f8b\u5982\uff0cpre-bind \u6269\u5c55\u53ef\u4ee5\u5c06\u4e00\u4e2a\u57fa\u4e8e\u7f51\u7edc\u7684\u6570\u636e\u5377\u6302\u8f7d\u5230\u8282\u70b9\u4e0a\uff0c\u4ee5\u4fbf Pod \u53ef\u4ee5\u4f7f\u7528\u3002\u5982\u679c\u4efb\u4f55\u4e00\u4e2a <code>pre-bind</code> \u6269\u5c55\u8fd4\u56de\u9519\u8bef\uff0cPod \u5c06\u88ab\u653e\u56de\u5230\u5f85\u8c03\u5ea6\u961f\u5217\uff0c\u6b64\u65f6\u5c06\u89e6\u53d1 Unreserve \u6269\u5c55\u3002</p> </li> </ul> </li> <li> <p><code>Bind</code> \u6269\u5c55\u7528\u4e8e\u5c06 Pod \u7ed1\u5b9a\u5230\u8282\u70b9\u4e0a\uff1a</p> <ul> <li>\u53ea\u6709\u6240\u6709\u7684 pre-bind \u6269\u5c55\u90fd\u6210\u529f\u6267\u884c\u4e86\uff0cbind \u6269\u5c55\u624d\u4f1a\u6267\u884c</li> <li>\u8c03\u5ea6\u6846\u67b6\u6309\u7167 bind \u6269\u5c55\u6ce8\u518c\u7684\u987a\u5e8f\u9010\u4e2a\u8c03\u7528 bind \u6269\u5c55</li> <li>\u5177\u4f53\u67d0\u4e2a bind \u6269\u5c55\u53ef\u4ee5\u9009\u62e9\u5904\u7406\u6216\u8005\u4e0d\u5904\u7406\u8be5 Pod</li> <li>\u5982\u679c\u67d0\u4e2a bind \u6269\u5c55\u5904\u7406\u4e86\u8be5 Pod \u4e0e\u8282\u70b9\u7684\u7ed1\u5b9a\uff0c\u4f59\u4e0b\u7684 bind \u6269\u5c55\u5c06\u88ab\u5ffd\u7565</li> <li> <p><code>Post-bind</code> \u662f\u4e00\u4e2a\u901a\u77e5\u6027\u8d28\u7684\u6269\u5c55\uff1a</p> </li> <li> <p>Post-bind \u6269\u5c55\u5728 Pod \u6210\u529f\u7ed1\u5b9a\u5230\u8282\u70b9\u4e0a\u4e4b\u540e\u88ab\u52a8\u8c03\u7528</p> </li> <li>Post-bind \u6269\u5c55\u662f\u7ed1\u5b9a\u8fc7\u7a0b\u7684\u6700\u540e\u4e00\u4e2a\u6b65\u9aa4\uff0c\u53ef\u4ee5\u7528\u6765\u6267\u884c\u8d44\u6e90\u6e05\u7406\u7684\u52a8\u4f5c</li> <li> <p><code>Unreserve</code> \u662f\u4e00\u4e2a\u901a\u77e5\u6027\u8d28\u7684\u6269\u5c55\uff0c\u5982\u679c\u4e3a Pod \u9884\u7559\u4e86\u8d44\u6e90\uff0cPod \u53c8\u5728\u88ab\u7ed1\u5b9a\u8fc7\u7a0b\u4e2d\u88ab\u62d2\u7edd\u7ed1\u5b9a\uff0c\u5219 unreserve \u6269\u5c55\u5c06\u88ab\u8c03\u7528\u3002Unreserve \u6269\u5c55\u5e94\u8be5\u91ca\u653e\u5df2\u7ecf\u4e3a Pod \u9884\u7559\u7684\u8282\u70b9\u4e0a\u7684\u8ba1\u7b97\u8d44\u6e90\u3002\u5728\u4e00\u4e2a\u63d2\u4ef6\u4e2d\uff0creserve \u6269\u5c55\u548c unreserve \u6269\u5c55\u5e94\u8be5\u6210\u5bf9\u51fa\u73b0\u3002</p> </li> </ul> </li> </ol> <p>\u5982\u679c\u6211\u4eec\u8981\u5b9e\u73b0\u81ea\u5df1\u7684\u63d2\u4ef6\uff0c\u5fc5\u987b\u5411\u8c03\u5ea6\u6846\u67b6\u6ce8\u518c\u63d2\u4ef6\u5e76\u5b8c\u6210\u914d\u7f6e\uff0c\u53e6\u5916\u8fd8\u5fc5\u987b\u5b9e\u73b0\u6269\u5c55\u70b9\u63a5\u53e3\uff0c\u5bf9\u5e94\u7684\u6269\u5c55\u70b9\u63a5\u53e3\u6211\u4eec\u53ef\u4ee5\u5728\u6e90\u7801 </p> <p><code>pkg/scheduler/framework/v1alpha1/interface.go</code></p> <p>\u6587\u4ef6\u4e2d\u627e\u5230\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <p>``` // Plugin is the parent type for all the scheduling framework plugins. type Plugin interface {     Name() string }</p> <p>type QueueSortPlugin interface {     Plugin     Less(*PodInfo, *PodInfo) bool }</p> <p>// PreFilterPlugin is an interface that must be implemented by \"prefilter\" plugins. // These plugins are called at the beginning of the scheduling cycle. type PreFilterPlugin interface {     Plugin     PreFilter(pc *PluginContext, p *vPod) *Status }</p> <p>// FilterPlugin is an interface for Filter plugins. These plugins are called at the // filter extension point for filtering out hosts that cannot run a pod. // This concept used to be called 'predicate' in the original scheduler. // These plugins should return \"Success\", \"Unschedulable\" or \"Error\" in Status.code. // However, the scheduler accepts other valid codes as well. // Anything other than \"Success\" will lead to exclusion of the given host from // running the pod. type FilterPlugin interface {     Plugin     Filter(pc *PluginContext, pod *vPod, nodeName string) *Status }</p> <p>// PostFilterPlugin is an interface for Post-filter plugin. Post-filter is an // informational extension point. Plugins will be called with a list of nodes // that passed the filtering phase. A plugin may use this data to update internal // state or to generate logs/metrics. type PostFilterPlugin interface {     Plugin     PostFilter(pc *PluginContext, pod *vPod, nodes []*vNode, filteredNodesStatuses NodeToStatusMap) *Status }</p> <p>// ScorePlugin is an interface that must be implemented by \"score\" plugins to rank // nodes that passed the filtering phase. type ScorePlugin interface {     Plugin     Score(pc *PluginContext, p *vPod, nodeName string) (int, *Status) }</p> <p>// ScoreWithNormalizePlugin is an interface that must be implemented by \"score\" // plugins that also need to normalize the node scoring results produced by the same // plugin's \"Score\" method. type ScoreWithNormalizePlugin interface {     ScorePlugin     NormalizeScore(pc *PluginContext, p *vPod, scores NodeScoreList) *Status }</p> <p>// ReservePlugin is an interface for Reserve plugins. These plugins are called // at the reservation point. These are meant to update the state of the plugin. // This concept used to be called 'assume' in the original scheduler. // These plugins should return only Success or Error in Status.code. However, // the scheduler accepts other valid codes as well. Anything other than Success // will lead to rejection of the pod. type ReservePlugin interface {     Plugin     Reserve(pc *PluginContext, p *vPod, nodeName string) *Status }</p> <p>// PreBindPlugin is an interface that must be implemented by \"prebind\" plugins. // These plugins are called before a pod being scheduled. type PreBindPlugin interface {     Plugin     PreBind(pc *PluginContext, p *vPod, nodeName string) *Status }</p> <p>// PostBindPlugin is an interface that must be implemented by \"postbind\" plugins. // These plugins are called after a pod is successfully bound to a node. type PostBindPlugin interface {     Plugin     PostBind(pc *PluginContext, p *vPod, nodeName string) }</p> <p>// UnreservePlugin is an interface for Unreserve plugins. This is an informational // extension point. If a pod was reserved and then rejected in a later phase, then // un-reserve plugins will be notified. Un-reserve plugins should clean up state // associated with the reserved Pod. type UnreservePlugin interface {     Plugin     Unreserve(pc *PluginContext, p *vPod, nodeName string) }</p> <p>// PermitPlugin is an interface that must be implemented by \"permit\" plugins. // These plugins are called before a pod is bound to a node. type PermitPlugin interface {     Plugin     Permit(pc *PluginContext, p *vPod, nodeName string) (*Status, time.Duration) }</p> <p>// BindPlugin is an interface that must be implemented by \"bind\" plugins. Bind // plugins are used to bind a pod to a Node. type BindPlugin interface {     Plugin     Bind(pc *PluginContext, p *vPod, nodeName string) *Status } <pre><code>&gt; \u5bf9\u4e8e\u8c03\u5ea6\u6846\u67b6\u63d2\u4ef6\u7684\u542f\u7528\u6216\u8005\u7981\u7528\uff0c\u6211\u4eec\u540c\u6837\u53ef\u4ee5\u4f7f\u7528\u4e0a\u9762\u7684 KubeSchedulerConfiguration \u8d44\u6e90\u5bf9\u8c61\u6765\u8fdb\u884c\u914d\u7f6e\u3002\u4e0b\u9762\u7684\u4f8b\u5b50\u4e2d\u7684\u914d\u7f6e\u542f\u7528\u4e86\u4e00\u4e2a\u5b9e\u73b0\u4e86 `reserve` \u548c `preBind` \u6269\u5c55\u70b9\u7684\u63d2\u4ef6\uff0c\u5e76\u4e14\u7981\u7528\u4e86\u53e6\u5916\u4e00\u4e2a\u63d2\u4ef6\uff0c\u540c\u65f6\u4e3a\u63d2\u4ef6 foo \u63d0\u4f9b\u4e86\u4e00\u4e9b\u914d\u7f6e\u4fe1\u606f\uff1a\n</code></pre> apiVersion: kubescheduler.config.k8s.io/v1alpha1 kind: KubeSchedulerConfiguration</p> <p>...</p> <p>plugins:   reserve:     enabled:     - name: foo     - name: bar     disabled:     - name: baz   preBind:     enabled:     - name: foo     disabled:     - name: baz</p> <p>pluginConfig: - name: foo   args: &gt;     foo\u63d2\u4ef6\u53ef\u4ee5\u89e3\u6790\u7684\u4efb\u610f\u5185\u5bb9 <pre><code>&gt; \u6269\u5c55\u7684\u8c03\u7528\u987a\u5e8f\u5982\u4e0b\uff1a\n\n*   \u5982\u679c\u67d0\u4e2a\u6269\u5c55\u70b9\u6ca1\u6709\u914d\u7f6e\u5bf9\u5e94\u7684\u6269\u5c55\uff0c\u8c03\u5ea6\u6846\u67b6\u5c06\u4f7f\u7528\u9ed8\u8ba4\u63d2\u4ef6\u4e2d\u7684\u6269\u5c55\n*   \u5982\u679c\u4e3a\u67d0\u4e2a\u6269\u5c55\u70b9\u914d\u7f6e\u4e14\u6fc0\u6d3b\u4e86\u6269\u5c55\uff0c\u5219\u8c03\u5ea6\u6846\u67b6\u5c06\u5148\u8c03\u7528\u9ed8\u8ba4\u63d2\u4ef6\u7684\u6269\u5c55\uff0c\u518d\u8c03\u7528\u914d\u7f6e\u4e2d\u7684\u6269\u5c55\n*   \u9ed8\u8ba4\u63d2\u4ef6\u7684\u6269\u5c55\u59cb\u7ec8\u88ab\u6700\u5148\u8c03\u7528\uff0c\u7136\u540e\u6309\u7167 \n\n    ```\n    KubeSchedulerConfiguration\n    ```\n\n     \u4e2d\u6269\u5c55\u7684\u6fc0\u6d3b `enabled` \u987a\u5e8f\u9010\u4e2a\u8c03\u7528\u6269\u5c55\u70b9\u7684\u6269\u5c55\n*   \u53ef\u4ee5\u5148\u7981\u7528\u9ed8\u8ba4\u63d2\u4ef6\u7684\u6269\u5c55\uff0c\u7136\u540e\u5728 `enabled` \u5217\u8868\u4e2d\u7684\u67d0\u4e2a\u4f4d\u7f6e\u6fc0\u6d3b\u9ed8\u8ba4\u63d2\u4ef6\u7684\u6269\u5c55\uff0c\u8fd9\u79cd\u505a\u6cd5\u53ef\u4ee5\u6539\u53d8\u9ed8\u8ba4\u63d2\u4ef6\u7684\u6269\u5c55\u88ab\u8c03\u7528\u65f6\u7684\u987a\u5e8f\n\n&gt; \u5047\u8bbe\u9ed8\u8ba4\u63d2\u4ef6 foo \u5b9e\u73b0\u4e86 `reserve` \u6269\u5c55\u70b9\uff0c\u6b64\u65f6\u6211\u4eec\u8981\u6dfb\u52a0\u4e00\u4e2a\u63d2\u4ef6 bar\uff0c\u60f3\u8981\u5728 foo \u4e4b\u524d\u88ab\u8c03\u7528\uff0c\u5219\u5e94\u8be5\u5148\u7981\u7528 foo \u518d\u6309\u7167 bar foo \u7684\u987a\u5e8f\u6fc0\u6d3b\u3002\u793a\u4f8b\u914d\u7f6e\u5982\u4e0b\u6240\u793a\uff1a\n</code></pre> apiVersion: kubescheduler.config.k8s.io/v1alpha1 kind: KubeSchedulerConfiguration</p> <p>...</p> <p>plugins:   reserve:     enabled:     - name: bar     - name: foo     disabled:     - name: foo <pre><code>&gt; \u5728\u6e90\u7801\u76ee\u5f55 \n</code></pre> pkg/scheduler/framework/plugins/examples <pre><code> \u4e2d\u6709\u51e0\u4e2a\u793a\u8303\u63d2\u4ef6\uff0c\u6211\u4eec\u53ef\u4ee5\u53c2\u7167\u5176\u5b9e\u73b0\u65b9\u5f0f\u3002\n\n#### \u793a\u4f8b \n\n&gt; \u5176\u5b9e\u8981\u5b9e\u73b0\u4e00\u4e2a\u8c03\u5ea6\u6846\u67b6\u7684\u63d2\u4ef6\uff0c\u5e76\u4e0d\u96be\uff0c\u6211\u4eec\u53ea\u8981\u5b9e\u73b0\u5bf9\u5e94\u7684\u6269\u5c55\u70b9\uff0c\u7136\u540e\u5c06\u63d2\u4ef6\u6ce8\u518c\u5230\u8c03\u5ea6\u5668\u4e2d\u5373\u53ef\uff0c\u4e0b\u9762\u662f\u9ed8\u8ba4\u8c03\u5ea6\u5668\u5728\u521d\u59cb\u5316\u7684\u65f6\u5019\u6ce8\u518c\u7684\u63d2\u4ef6\uff1a\n</code></pre> func NewRegistry() Registry {     return Registry{         // FactoryMap:         // New plugins are registered here.         // example:         // {         //  stateful_plugin.Name: stateful.NewStatefulMultipointExample,         //  fooplugin.Name: fooplugin.New,         // }     } } <pre><code>&gt; \u4f46\u662f\u53ef\u4ee5\u770b\u5230\u9ed8\u8ba4\u5e76\u6ca1\u6709\u6ce8\u518c\u4e00\u4e9b\u63d2\u4ef6\uff0c\u6240\u4ee5\u8981\u60f3\u8ba9\u8c03\u5ea6\u5668\u80fd\u591f\u8bc6\u522b\u6211\u4eec\u7684\u63d2\u4ef6\u4ee3\u7801\uff0c\u5c31\u9700\u8981\u81ea\u5df1\u6765\u5b9e\u73b0\u4e00\u4e2a\u8c03\u5ea6\u5668\u4e86\uff0c\u5f53\u7136\u8fd9\u4e2a\u8c03\u5ea6\u5668\u6211\u4eec\u5b8c\u5168\u6ca1\u5fc5\u8981\u5b8c\u5168\u81ea\u5df1\u5b9e\u73b0\uff0c\u76f4\u63a5\u8c03\u7528\u9ed8\u8ba4\u7684\u8c03\u5ea6\u5668\uff0c\u7136\u540e\u5728\u4e0a\u9762\u7684 `NewRegistry()` \u51fd\u6570\u4e2d\u5c06\u6211\u4eec\u7684\u63d2\u4ef6\u6ce8\u518c\u8fdb\u53bb\u5373\u53ef\u3002\u5728 `kube-scheduler` \u7684\u6e90\u7801\u6587\u4ef6 \n</code></pre> kubernetes/cmd/kube-scheduler/app/server.go <pre><code> \u4e2d\u6709\u4e00\u4e2a `NewSchedulerCommand` \u5165\u53e3\u51fd\u6570\uff0c\u5176\u4e2d\u7684\u53c2\u6570\u662f\u4e00\u4e2a\u7c7b\u578b\u4e3a `Option` \u7684\u5217\u8868\uff0c\u800c\u8fd9\u4e2a `Option` \u6070\u597d\u5c31\u662f\u4e00\u4e2a\u63d2\u4ef6\u914d\u7f6e\u7684\u5b9a\u4e49\uff1a\n</code></pre> // Option configures a framework.Registry. type Option func(framework.Registry) error</p> <p>// NewSchedulerCommand creates a *cobra.Command object with default parameters and registryOptions func NewSchedulerCommand(registryOptions ...Option) *cobra.Command {   ...... } <pre><code>&gt; \u6240\u4ee5\u6211\u4eec\u5b8c\u5168\u5c31\u53ef\u4ee5\u76f4\u63a5\u8c03\u7528\u8fd9\u4e2a\u51fd\u6570\u6765\u4f5c\u4e3a\u6211\u4eec\u7684\u51fd\u6570\u5165\u53e3\uff0c\u5e76\u4e14\u4f20\u5165\u6211\u4eec\u81ea\u5df1\u5b9e\u73b0\u7684\u63d2\u4ef6\u4f5c\u4e3a\u53c2\u6570\u5373\u53ef\uff0c\u800c\u4e14\u8be5\u6587\u4ef6\u4e0b\u9762\u8fd8\u6709\u4e00\u4e2a\u540d\u4e3a `WithPlugin` \u7684\u51fd\u6570\u53ef\u4ee5\u6765\u521b\u5efa\u4e00\u4e2a `Option` \u5b9e\u4f8b\uff1a\n</code></pre> // WithPlugin creates an Option based on plugin name and factory. func WithPlugin(name string, factory framework.PluginFactory) Option {     return func(registry framework.Registry) error {         return registry.Register(name, factory)     } } <pre><code>&gt; \u6240\u4ee5\u6700\u7ec8\u6211\u4eec\u7684\u5165\u53e3\u51fd\u6570\u5982\u4e0b\u6240\u793a\uff1a\n</code></pre> func main() {     rand.Seed(time.Now().UTC().UnixNano())</p> <pre><code>command := app.NewSchedulerCommand(\n    app.WithPlugin(sample.Name, sample.New), \n)\n\nlogs.InitLogs()\ndefer logs.FlushLogs()\n\nif err := command.Execute(); err != nil {\n    _, _ = fmt.Fprintf(os.Stderr, \"%v\\\\n\", err)\n    os.Exit(1)\n}\n</code></pre> <p>} <pre><code>&gt; \u5176\u4e2d \n</code></pre> app.WithPlugin(sample.Name, sample.New) <pre><code> \u5c31\u662f\u6211\u4eec\u63a5\u4e0b\u6765\u8981\u5b9e\u73b0\u7684\u63d2\u4ef6\uff0c\u4ece `WithPlugin` \u51fd\u6570\u7684\u53c2\u6570\u4e5f\u53ef\u4ee5\u770b\u51fa\u6211\u4eec\u8fd9\u91cc\u7684 `sample.New` \u5fc5\u987b\u662f\u4e00\u4e2a \n</code></pre> framework.PluginFactory <pre><code> \u7c7b\u578b\u7684\u503c\uff0c\u800c `PluginFactory` \u7684\u5b9a\u4e49\u5c31\u662f\u4e00\u4e2a\u51fd\u6570\uff1a\n</code></pre> type PluginFactory = func(configuration *runtime.Unknown, f FrameworkHandle) (Plugin, error) <pre><code>&gt; \u6240\u4ee5 `sample.New` \u5b9e\u9645\u4e0a\u5c31\u662f\u4e0a\u9762\u7684\u8fd9\u4e2a\u51fd\u6570\uff0c\u5728\u8fd9\u4e2a\u51fd\u6570\u4e2d\u6211\u4eec\u53ef\u4ee5\u83b7\u53d6\u5230\u63d2\u4ef6\u4e2d\u7684\u4e00\u4e9b\u6570\u636e\u7136\u540e\u8fdb\u884c\u903b\u8f91\u5904\u7406\u5373\u53ef\uff0c\u63d2\u4ef6\u5b9e\u73b0\u5982\u4e0b\u6240\u793a\uff0c\u6211\u4eec\u8fd9\u91cc\u53ea\u662f\u7b80\u5355\u83b7\u53d6\u4e0b\u6570\u636e\u6253\u5370\u65e5\u5fd7\uff0c\u5982\u679c\u4f60\u6709\u5b9e\u9645\u9700\u6c42\u7684\u53ef\u4ee5\u6839\u636e\u83b7\u53d6\u7684\u6570\u636e\u5c31\u884c\u5904\u7406\u5373\u53ef\uff0c\u6211\u4eec\u8fd9\u91cc\u53ea\u662f\u5b9e\u73b0\u4e86 `PreFilter`\u3001`Filter`\u3001`PreBind` \u4e09\u4e2a\u6269\u5c55\u70b9\uff0c\u5176\u4ed6\u7684\u53ef\u4ee5\u7528\u540c\u6837\u7684\u65b9\u5f0f\u6765\u6269\u5c55\u5373\u53ef\uff1a\n</code></pre> // \u63d2\u4ef6\u540d\u79f0 const Name = \"sample-plugin\"</p> <p>type Args struct {     FavoriteColor  string <code>json:\"favorite_color,omitempty\"</code>     FavoriteNumber int    <code>json:\"favorite_number,omitempty\"</code>     ThanksTo       string <code>json:\"thanks_to,omitempty\"</code> }</p> <p>type Sample struct {     args   *Args     handle framework.FrameworkHandle }</p> <p>func (s *Sample) Name() string {     return Name }</p> <p>func (s *Sample) PreFilter(pc *framework.PluginContext, pod *vPod) *framework.Status {     klog.V(3).Infof(\"prefilter pod: %v\", pod.Name)     return framework.NewStatus(framework.Success, \"\") }</p> <p>func (s *Sample) Filter(pc *framework.PluginContext, pod *vPod, nodeName string) *framework.Status {     klog.V(3).Infof(\"filter pod: %v, node: %v\", pod.Name, nodeName)     return framework.NewStatus(framework.Success, \"\") }</p> <p>func (s *Sample) PreBind(pc *framework.PluginContext, pod *vPod, nodeName string) *framework.Status {     if nodeInfo, ok := s.handle.NodeInfoSnapshot().NodeInfoMap[nodeName]; !ok {         return framework.NewStatus(framework.Error, fmt.Sprintf(\"prebind get node info error: %+v\", nodeName))     } else {         klog.V(3).Infof(\"prebind node info: %+v\", nodeInfo.Node())         return framework.NewStatus(framework.Success, \"\")     } }</p> <p>//type PluginFactory = func(configuration *runtime.Unknown, f FrameworkHandle) (Plugin, error) func New(configuration *runtime.Unknown, f framework.FrameworkHandle) (framework.Plugin, error) {     args := &amp;Args{}     if err := framework.DecodeInto(configuration, args); err != nil {         return nil, err     }     klog.V(3).Infof(\"get plugin config args: %+v\", args)     return &amp;Sample{         args: args,         handle: f,     }, nil } <pre><code>&gt; &gt; \u5b8c\u6574\u4ee3\u7801\u53ef\u4ee5\u524d\u5f80\u4ed3\u5e93 https://github.com/cnych/sample-scheduler-framework \u83b7\u53d6\u3002\n\n&gt; \u5b9e\u73b0\u5b8c\u6210\u540e\uff0c\u7f16\u8bd1\u6253\u5305\u6210\u955c\u50cf\u5373\u53ef\uff0c\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u5f53\u6210\u666e\u901a\u7684\u5e94\u7528\u7528\u4e00\u4e2a `Deployment` \u63a7\u5236\u5668\u6765\u90e8\u7f72\u5373\u53ef\uff0c\u7531\u4e8e\u6211\u4eec\u9700\u8981\u53bb\u83b7\u53d6\u96c6\u7fa4\u4e2d\u7684\u4e00\u4e9b\u8d44\u6e90\u5bf9\u8c61\uff0c\u6240\u4ee5\u5f53\u7136\u9700\u8981\u7533\u8bf7 RBAC \u6743\u9650\uff0c\u7136\u540e\u540c\u6837\u901a\u8fc7 `--config` \u53c2\u6570\u6765\u914d\u7f6e\u6211\u4eec\u7684\u8c03\u5ea6\u5668\uff0c\u540c\u6837\u8fd8\u662f\u4f7f\u7528\u4e00\u4e2a \n</code></pre> KubeSchedulerConfiguration <pre><code> \u8d44\u6e90\u5bf9\u8c61\u914d\u7f6e\uff0c\u53ef\u4ee5\u901a\u8fc7 `plugins` \u6765\u542f\u7528\u6216\u8005\u7981\u7528\u6211\u4eec\u5b9e\u73b0\u7684\u63d2\u4ef6\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7 `pluginConfig` \u6765\u4f20\u9012\u4e00\u4e9b\u53c2\u6570\u503c\u7ed9\u63d2\u4ef6\uff1a\n</code></pre> kind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1 metadata:   name: sample-scheduler-clusterrole rules:   - apiGroups:       - \"\"     resources:       - endpoints       - events     verbs:       - create       - get       - update   - apiGroups:       - \"\"     resources:       - nodes     verbs:       - get       - list       - watch   - apiGroups:       - \"\"     resources:       - pods     verbs:       - delete       - get       - list       - watch       - update   - apiGroups:       - \"\"     resources:       - bindings       - pods/binding     verbs:       - create   - apiGroups:       - \"\"     resources:       - pods/status     verbs:       - patch       - update   - apiGroups:       - \"\"     resources:       - replicationcontrollers       - services     verbs:       - get       - list       - watch   - apiGroups:       - apps       - extensions     resources:       - replicasets     verbs:       - get       - list       - watch   - apiGroups:       - apps     resources:       - statefulsets     verbs:       - get       - list       - watch   - apiGroups:       - policy     resources:       - poddisruptionbudgets     verbs:       - get       - list       - watch   - apiGroups:       - \"\"     resources:       - persistentvolumeclaims       - persistentvolumes     verbs:       - get       - list       - watch   - apiGroups:       - \"\"     resources:       - configmaps     verbs:       - get       - list       - watch   - apiGroups:       - \"storage.k8s.io\"     resources:       - storageclasses       - csinodes     verbs:       - get       - list       - watch   - apiGroups:       - \"coordination.k8s.io\"     resources:       - leases     verbs:       - create       - get       - list       - update   - apiGroups:       - \"events.k8s.io\"     resources:       - events     verbs:       - create       - patch       - update</p> <p>apiVersion: v1 kind: ServiceAccount metadata:   name: sample-scheduler-sa   namespace: kube-system</p> <p>kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata:   name: sample-scheduler-clusterrolebinding   namespace: kube-system roleRef:   apiGroup: rbac.authorization.k8s.io   kind: ClusterRole   name: sample-scheduler-clusterrole subjects: - kind: ServiceAccount   name: sample-scheduler-sa   namespace: kube-system</p> <p>apiVersion: v1 kind: ConfigMap metadata:   name: scheduler-config   namespace: kube-system data:   scheduler-config.yaml: |     apiVersion: kubescheduler.config.k8s.io/v1alpha1     kind: KubeSchedulerConfiguration     schedulerName: sample-scheduler     leaderElection:       leaderElect: true       lockObjectName: sample-scheduler       lockObjectNamespace: kube-system     plugins:       preFilter:         enabled:         - name: \"sample-plugin\"       filter:         enabled:         - name: \"sample-plugin\"       preBind:         enabled:         - name: \"sample-plugin\"     pluginConfig:     - name: \"sample-plugin\"       args:         favorite_color: \"#326CE5\"         favorite_number: 7         thanks_to: \"thockin\"</p> <p>apiVersion: apps/v1 kind: Deployment metadata:   name: sample-scheduler   namespace: kube-system   labels:     component: sample-scheduler spec:   replicas: 1   selector:     matchLabels:       component: sample-scheduler   template:     metadata:       labels:         component: sample-scheduler     spec:       serviceAccount: sample-scheduler-sa       priorityClassName: system-cluster-critical       volumes:         - name: scheduler-config           configMap:             name: scheduler-config       containers:         - name: scheduler-ctrl           image: cnych/sample-scheduler:v6           imagePullPolicy: IfNotPresent           args:             - sample-scheduler-framework             - --config=/etc/kubernetes/scheduler-config.yaml             - --v=3           resources:             requests:               cpu: \"50m\"           volumeMounts:             - name: scheduler-config               mountPath: /etc/kubernetes <pre><code>&gt; \u76f4\u63a5\u90e8\u7f72\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u90e8\u7f72\u4e86\u4e00\u4e2a\u540d\u4e3a `sample-scheduler` \u7684\u8c03\u5ea6\u5668\u4e86\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u53ef\u4ee5\u90e8\u7f72\u4e00\u4e2a\u5e94\u7528\u6765\u4f7f\u7528\u8fd9\u4e2a\u8c03\u5ea6\u5668\u8fdb\u884c\u8c03\u5ea6\uff1a\n</code></pre> apiVersion: apps/v1 kind: Deployment metadata:   name: test-scheduler spec:   replicas: 1   selector:     matchLabels:       app: test-scheduler   template:     metadata:       labels:         app: test-scheduler     spec:       schedulerName: sample-scheduler       containers:       - image: nginx         imagePullPolicy: IfNotPresent         name: nginx         ports:         - containerPort: 80 <pre><code>&gt; \u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\u6211\u4eec\u73b0\u5728\u624b\u52a8\u6307\u5b9a\u4e86\u4e00\u4e2a `schedulerName` \u7684\u5b57\u6bb5\uff0c\u5c06\u5176\u8bbe\u7f6e\u6210\u4e0a\u9762\u6211\u4eec\u81ea\u5b9a\u4e49\u7684\u8c03\u5ea6\u5668\u540d\u79f0 `sample-scheduler`\u3002\n\n&gt; \u6211\u4eec\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff0c\u521b\u5efa\u5b8c\u6210\u540e\u67e5\u770b\u6211\u4eec\u81ea\u5b9a\u4e49\u8c03\u5ea6\u5668\u7684\u65e5\u5fd7\u4fe1\u606f\uff1a\n</code></pre> $ kubectl get pods -n kube-system -l component=sample-scheduler NAME                               READY   STATUS    RESTARTS   AGE sample-scheduler-7c469787f-rwhhd   1/1     Running   0          13m $ kubectl logs -f sample-scheduler-7c469787f-rwhhd -n kube-system I0104 08:24:087881       1 scheduler.go:530] Attempting to schedule pod: default/test-scheduler-6d779d9465-rq2bb I0104 08:24:087992       1 plugins.go:23] prefilter pod: test-scheduler-6d779d9465-rq2bb I0104 08:24:088657       1 plugins.go:28] filter pod: test-scheduler-6d779d9465-rq2bb, node: ydzs-node1 I0104 08:24:088797       1 plugins.go:28] filter pod: test-scheduler-6d779d9465-rq2bb, node: ydzs-node2 I0104 08:24:088871       1 plugins.go:28] filter pod: test-scheduler-6d779d9465-rq2bb, node: ydzs-node3 I0104 08:24:088946       1 plugins.go:28] filter pod: test-scheduler-6d779d9465-rq2bb, node: ydzs-node4 I0104 08:24:088992       1 plugins.go:28] filter pod: test-scheduler-6d779d9465-rq2bb, node: ydzs-master I0104 08:24:090653       1 plugins.go:36] prebind node info: &amp;Node{ObjectMeta:{ydzs-node3   /api/v1/nodes/ydzs-node3 1ff6e228-4d98-4737-b6d3-30a5d55ccdc2 15466372 0 2019-11-10 09:05:09 +0000 UTC   ......} I0104 08:24:091761       1 factory.go:610] Attempting to bind test-scheduler-6d779d9465-rq2bb to ydzs-node3 I0104 08:24:104994       1 scheduler.go:667] pod default/test-scheduler-6d779d9465-rq2bb is bound successfully on node \"ydzs-node3\", 5 nodes evaluated, 4 nodes were found feasible. Bound node resource: \"Capacity: CPU&lt;4&gt;|Memory&lt;8008820Ki&gt;|Pods&lt;110&gt;|StorageEphemeral&lt;17921Mi&gt;; Allocatable: CPU&lt;4&gt;|Memory&lt;7906420Ki&gt;|Pods&lt;110&gt;|StorageEphemeral&lt;16912377419&gt;.\". <pre><code>&gt; \u53ef\u4ee5\u770b\u5230\u5f53\u6211\u4eec\u521b\u5efa\u5b8c Pod \u540e\uff0c\u5728\u6211\u4eec\u81ea\u5b9a\u4e49\u7684\u8c03\u5ea6\u5668\u4e2d\u5c31\u51fa\u73b0\u4e86\u5bf9\u5e94\u7684\u65e5\u5fd7\uff0c\u5e76\u4e14\u5728\u6211\u4eec\u5b9a\u4e49\u7684\u6269\u5c55\u70b9\u4e0a\u9762\u90fd\u51fa\u73b0\u4e86\u5bf9\u5e94\u7684\u65e5\u5fd7\uff0c\u8bc1\u660e\u6211\u4eec\u7684\u793a\u4f8b\u6210\u529f\u4e86\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u67e5\u770b Pod \u7684 `schedulerName` \u6765\u9a8c\u8bc1\uff1a\n</code></pre> $ kubectl get pods NAME                                      READY   STATUS    RESTARTS   AGE test-scheduler-6d779d9465-rq2bb           1/1     Running   0          22m $ kubectl get pod test-scheduler-6d779d9465-rq2bb -o yaml ...... restartPolicy: Always schedulerName: sample-scheduler securityContext: {} serviceAccount: default ...... <pre><code>&gt; \u5728\u6700\u65b0\u7684 Kubernetes v1.17 \u7248\u672c\u4e2d\uff0c`Scheduler Framework` \u5185\u7f6e\u7684\u9884\u9009\u548c\u4f18\u9009\u51fd\u6570\u5df2\u7ecf\u5168\u90e8\u63d2\u4ef6\u5316\uff0c\u6240\u4ee5\u8981\u6269\u5c55\u8c03\u5ea6\u5668\u6211\u4eec\u5e94\u8be5\u638c\u63e1\u5e76\u7406\u89e3\u8c03\u5ea6\u6846\u67b6\u8fd9\u79cd\u65b9\u5f0f\u3002\n\n### \u4f18\u5148\u7ea7\u8c03\u5ea6 \n\n&gt; \u4e0e\u524d\u9762\u6240\u8bb2\u7684\u8c03\u5ea6\u4f18\u9009\u7b56\u7565\u4e2d\u7684\u4f18\u5148\u7ea7\uff08Priorities\uff09\u4e0d\u540c\uff0c\u524d\u9762\u6240\u8bb2\u7684\u4f18\u5148\u7ea7\u6307\u7684\u662f\u8282\u70b9\u4f18\u5148\u7ea7\uff0c\u800c\u6211\u4eec\u8fd9\u91cc\u6240\u8bf4\u7684\u4f18\u5148\u7ea7\u6307\u7684\u662f Pod \u7684\u4f18\u5148\u7ea7\uff0c\u9ad8\u4f18\u5148\u7ea7\u7684 Pod \u4f1a\u4f18\u5148\u88ab\u8c03\u5ea6\uff0c\u6216\u8005\u5728\u8d44\u6e90\u4e0d\u8db3\u4f4e\u60c5\u51b5\u727a\u7272\u4f4e\u4f18\u5148\u7ea7\u7684 Pod\uff0c\u4ee5\u4fbf\u4e8e\u91cd\u8981\u7684 Pod \u80fd\u591f\u5f97\u5230\u8d44\u6e90\u90e8\u7f72\u3002\n\n&gt; \u8981\u5b9a\u4e49 Pod \u4f18\u5148\u7ea7\uff0c\u5c31\u9700\u8981\u5148\u5b9a\u4e49 `PriorityClass` \u5bf9\u8c61\uff0c\u8be5\u5bf9\u8c61\u6ca1\u6709 Namespace \u7684\u9650\u5236\uff1a\n</code></pre> apiVersion: v1 kind: PriorityClass metadata:   name: high-priority value: 1000000 globalDefault: false description: \"This priority class should be used for XYZ service pods only.\" <pre><code>&gt; \u5176\u4e2d\uff1a\n\n*   value \u4e3a 32 \u4f4d\u6574\u6570\u7684\u4f18\u5148\u7ea7\uff0c\u8be5\u503c\u8d8a\u5927\uff0c\u4f18\u5148\u7ea7\u8d8a\u9ad8\n*   globalDefault \u7528\u4e8e\u672a\u914d\u7f6e PriorityClassName \u7684 Pod\uff0c\u6574\u4e2a\u96c6\u7fa4\u4e2d\u5e94\u8be5\u53ea\u6709\u4e00\u4e2a `PriorityClass` \u5c06\u5176\u8bbe\u7f6e\u4e3a true\n\n&gt; \u7136\u540e\u901a\u8fc7\u5728 Pod \u7684 \n</code></pre> spec.priorityClassName <pre><code> \u4e2d\u6307\u5b9a\u5df2\u5b9a\u4e49\u7684 `PriorityClass` \u540d\u79f0\u5373\u53ef\uff1a\n</code></pre> apiVersion: v1 kind: Pod metadata:   name: nginx   labels:     app: nginx spec:   containers:   - name: nginx     image: nginx     imagePullPolicy: IfNotPresent   priorityClassName: high-priority ``` <p>\u53e6\u5916\u4e00\u4e2a\u503c\u5f97\u6ce8\u610f\u7684\u662f\u5f53\u8282\u70b9\u6ca1\u6709\u8db3\u591f\u7684\u8d44\u6e90\u4f9b\u8c03\u5ea6\u5668\u8c03\u5ea6 Pod\uff0c\u5bfc\u81f4 Pod \u5904\u4e8e pending \u65f6\uff0c\u62a2\u5360\uff08preemption\uff09\u903b\u8f91\u5c31\u4f1a\u88ab\u89e6\u53d1\uff0c\u62a2\u5360\u4f1a\u5c1d\u8bd5\u4ece\u4e00\u4e2a\u8282\u70b9\u5220\u9664\u4f4e\u4f18\u5148\u7ea7\u7684 Pod\uff0c\u4ece\u800c\u91ca\u653e\u8d44\u6e90\u4f7f\u9ad8\u4f18\u5148\u7ea7\u7684 Pod \u5f97\u5230\u8282\u70b9\u8d44\u6e90\u8fdb\u884c\u90e8\u7f72\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u901a\u8fc7\u4e0b\u9762\u7684\u56fe\u518d\u53bb\u56de\u987e\u4e0b kubernetes \u7684\u8c03\u5ea6\u8fc7\u7a0b\u5c31\u6e05\u6670\u5f88\u591a\u4e86\uff1a</p> <p></p>"},{"location":"kubernetes_scheduler/usage/","title":"Pod \u8c03\u5ea6","text":"<p>\ue3c9</p>"},{"location":"kubernetes_scheduler/usage/#_1","title":"\u8c03\u5ea6","text":"<p>\u4e00\u822c\u60c5\u51b5\u4e0b\u6211\u4eec\u90e8\u7f72\u7684 Pod \u662f\u901a\u8fc7\u96c6\u7fa4\u7684\u81ea\u52a8\u8c03\u5ea6\u7b56\u7565\u6765\u9009\u62e9\u8282\u70b9\u7684\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u8c03\u5ea6\u5668\u8003\u8651\u7684\u662f\u8d44\u6e90\u8db3\u591f\uff0c\u5e76\u4e14\u8d1f\u8f7d\u5c3d\u91cf\u5e73\u5747\uff0c\u4f46\u662f\u6709\u7684\u65f6\u5019\u6211\u4eec\u9700\u8981\u80fd\u591f\u66f4\u52a0\u7ec6\u7c92\u5ea6\u7684\u53bb\u63a7\u5236 Pod \u7684\u8c03\u5ea6\uff0c\u6bd4\u5982\u6211\u4eec\u5e0c\u671b\u4e00\u4e9b\u673a\u5668\u5b66\u4e60\u7684\u5e94\u7528\u53ea\u8dd1\u5728\u6709 GPU \u7684\u8282\u70b9\u4e0a\uff1b\u4f46\u662f\u6709\u7684\u65f6\u5019\u6211\u4eec\u7684\u670d\u52a1\u4e4b\u95f4\u4ea4\u6d41\u6bd4\u8f83\u9891\u7e41\uff0c\u53c8\u5e0c\u671b\u80fd\u591f\u5c06\u8fd9\u670d\u52a1\u7684 Pod \u90fd\u8c03\u5ea6\u5230\u540c\u4e00\u4e2a\u7684\u8282\u70b9\u4e0a\u3002\u8fd9\u5c31\u9700\u8981\u4f7f\u7528\u4e00\u4e9b\u8c03\u5ea6\u65b9\u5f0f\u6765\u63a7\u5236 Pod \u7684\u8c03\u5ea6\u4e86\uff0c\u4e3b\u8981\u6709\u4e24\u4e2a\u6982\u5ff5\uff1a<code>\u4eb2\u548c\u6027\u548c\u53cd\u4eb2\u548c\u6027</code>\uff0c\u4eb2\u548c\u6027\u53c8\u5206\u6210\u8282\u70b9\u4eb2\u548c\u6027(nodeAffinity)\u548c Pod \u4eb2\u548c\u6027(podAffinity)\u3002</p>"},{"location":"kubernetes_scheduler/usage/#nodeselector","title":"nodeSelector","text":"<p>\u5728\u4e86\u89e3\u4eb2\u548c\u6027\u4e4b\u524d\uff0c\u6211\u4eec\u5148\u6765\u4e86\u89e3\u4e00\u4e2a\u975e\u5e38\u5e38\u7528\u7684\u8c03\u5ea6\u65b9\u5f0f\uff1a<code>nodeSelector</code>\u3002\u6211\u4eec\u77e5\u9053 label \u6807\u7b7e\u662f kubernetes \u4e2d\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u6982\u5ff5\uff0c\u7528\u6237\u53ef\u4ee5\u975e\u5e38\u7075\u6d3b\u7684\u5229\u7528 label \u6765\u7ba1\u7406\u96c6\u7fa4\u4e2d\u7684\u8d44\u6e90\uff0c\u6bd4\u5982\u6700\u5e38\u89c1\u7684 Service \u5bf9\u8c61\u901a\u8fc7 label \u53bb\u5339\u914d Pod \u8d44\u6e90\uff0c\u800c Pod \u7684\u8c03\u5ea6\u4e5f\u53ef\u4ee5\u6839\u636e\u8282\u70b9\u7684 label \u6765\u8fdb\u884c\u8c03\u5ea6\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4\u67e5\u770b\u6211\u4eec\u7684 node \u7684 label\uff1a</p> <pre><code>$ kubectl get nodes --show-labels\nNAME          STATUS   ROLES    AGE   VERSION   LABELS\nydzs-master   Ready    master   55d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-master,kubernetes.io/os=linux,node-role.kubernetes.io/master=\nydzs-node1    Ready    &lt;none&gt;   55d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/fluentd-ds-ready=true,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-node1,kubernetes.io/os=linux\nydzs-node2    Ready    &lt;none&gt;   55d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/fluentd-ds-ready=true,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-node2,kubernetes.io/os=linux\nydzs-node3    Ready    &lt;none&gt;   53d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/fluentd-ds-ready=true,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-node3,kubernetes.io/os=linux,monitor=prometheus\nydzs-node4    Ready    &lt;none&gt;   53d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/fluentd-ds-ready=true,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-node4,kubernetes.io/os=linux\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u5148\u7ed9\u8282\u70b9 ydzs-node2 \u589e\u52a0\u4e00\u4e2a<code>com=youdianzhishi</code>\u7684\u6807\u7b7e\uff0c\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code>$ kubectl label nodes ydzs-node2 com=youdianzhishi\nnode/ydzs-node2 labeled\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0a\u9762\u7684 <code>--show-labels</code> \u53c2\u6570\u53ef\u4ee5\u67e5\u770b\u4e0a\u8ff0\u6807\u7b7e\u662f\u5426\u751f\u6548\u3002\u5f53\u8282\u70b9\u88ab\u6253\u4e0a\u4e86\u76f8\u5173\u6807\u7b7e\u540e\uff0c\u5728\u8c03\u5ea6\u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e9b\u6807\u7b7e\u4e86\uff0c\u53ea\u9700\u8981\u5728 Pod \u7684 spec \u5b57\u6bb5\u4e2d\u6dfb\u52a0 <code>nodeSelector</code> \u5b57\u6bb5\uff0c\u91cc\u9762\u662f\u6211\u4eec\u9700\u8981\u88ab\u8c03\u5ea6\u7684\u8282\u70b9\u7684 label \u6807\u7b7e\uff0c\u6bd4\u5982\uff0c\u4e0b\u9762\u7684 Pod \u6211\u4eec\u8981\u5f3a\u5236\u8c03\u5ea6\u5230 ydzs-node2 \u8fd9\u4e2a\u8282\u70b9\u4e0a\u53bb\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528 nodeSelector \u6765\u8868\u793a\u4e86\uff1a(node-selector-demo.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  labels:\n    app: busybox-pod\n  name: test-busybox\nspec:\n  containers:\n  - command:\n    - sleep\n    - \"3600\"\n    image: busybox\n    imagePullPolicy: Always\n    name: test-busybox\n  nodeSelector:\n    com: youdianzhishi\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 describe \u547d\u4ee4\u67e5\u770b\u8c03\u5ea6\u7ed3\u679c\uff1a</p> <pre><code>$ kubectl apply -f pod-selector-demo.yaml \npod/test-busybox created\n$ kubectl describe pod test-busybox\nName:         test-busybox\nNamespace:    default\nPriority:     0\nNode:         ydzs-node2/123\n......\nNode-Selectors:  com=youdianzhishi\nTolerations:     node.kubernetes.io/not-ready:NoExecute for 300s\n                 node.kubernetes.io/unreachable:NoExecute for 300s\nEvents:\n  Type    Reason     Age        From                 Message\n  ----    ------     ----       ----                 -------\n  Normal  Scheduled  &lt;unknown&gt;  default-scheduler    Successfully assigned default/test-busybox to ydzs-node2\n  Normal  Pulling    13s        kubelet, ydzs-node2  Pulling image \"busybox\"\n  Normal  Pulled     10s        kubelet, ydzs-node2  Successfully pulled image \"busybox\"\n  Normal  Created    10s        kubelet, ydzs-node2  Created container test-busybox\n  Normal  Started    9s         kubelet, ydzs-node2  Started container test-busybox\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Events \u4e0b\u9762\u7684\u4fe1\u606f\uff0c\u6211\u4eec\u7684 Pod \u901a\u8fc7\u9ed8\u8ba4\u7684 <code>default-scheduler</code> \u8c03\u5ea6\u5668\u88ab\u7ed1\u5b9a\u5230\u4e86 ydzs-node2 \u8282\u70b9\u3002\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f<code>nodeSelector</code> \u5c5e\u4e8e\u5f3a\u5236\u6027\u7684\uff0c\u5982\u679c\u6211\u4eec\u7684\u76ee\u6807\u8282\u70b9\u6ca1\u6709\u53ef\u7528\u7684\u8d44\u6e90\uff0c\u6211\u4eec\u7684 Pod \u5c31\u4f1a\u4e00\u76f4\u5904\u4e8e <code>Pending</code> \u72b6\u6001\u3002</p> <p>\u901a\u8fc7\u4e0a\u9762\u7684\u4f8b\u5b50\u6211\u4eec\u53ef\u4ee5\u611f\u53d7\u5230 <code>nodeSelector</code> \u7684\u65b9\u5f0f\u6bd4\u8f83\u76f4\u89c2\uff0c\u4f46\u662f\u8fd8\u591f\u7075\u6d3b\uff0c\u63a7\u5236\u7c92\u5ea6\u504f\u5927\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u518d\u548c\u5927\u5bb6\u4e86\u89e3\u4e0b\u66f4\u52a0\u7075\u6d3b\u7684\u65b9\u5f0f\uff1a\u8282\u70b9\u4eb2\u548c\u6027(nodeAffinity)\u3002</p>"},{"location":"kubernetes_scheduler/usage/#_2","title":"\u4eb2\u548c\u6027\u548c\u53cd\u4eb2\u548c\u6027\u8c03\u5ea6","text":"<p>\u524d\u9762\u6211\u4eec\u4e86\u89e3\u4e86 kubernetes \u8c03\u5ea6\u5668\u7684\u8c03\u5ea6\u6d41\u7a0b\uff0c\u6211\u4eec\u77e5\u9053\u9ed8\u8ba4\u7684\u8c03\u5ea6\u5668\u5728\u4f7f\u7528\u7684\u65f6\u5019\uff0c\u7ecf\u8fc7\u4e86 <code>predicates</code> \u548c <code>priorities</code> \u4e24\u4e2a\u9636\u6bb5\uff0c\u4f46\u662f\u5728\u5b9e\u9645\u7684\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u5f80\u5f80\u6211\u4eec\u9700\u8981\u6839\u636e\u81ea\u5df1\u7684\u4e00\u4e9b\u5b9e\u9645\u9700\u6c42\u6765\u63a7\u5236 Pod \u7684\u8c03\u5ea6\uff0c\u8fd9\u5c31\u9700\u8981\u7528\u5230 <code>nodeAffinity(\u8282\u70b9\u4eb2\u548c\u6027)</code>\u3001<code>podAffinity(pod \u4eb2\u548c\u6027)</code> \u4ee5\u53ca </p> <pre><code>podAntiAffinity(pod \u53cd\u4eb2\u548c\u6027)\n</code></pre> <p>\u3002</p> <p>\u4eb2\u548c\u6027\u8c03\u5ea6\u53ef\u4ee5\u5206\u6210<code>\u8f6f\u7b56\u7565</code>\u548c<code>\u786c\u7b56\u7565</code>\u4e24\u79cd\u65b9\u5f0f:</p> <ul> <li><code>\u8f6f\u7b56\u7565</code>\u5c31\u662f\u5982\u679c\u73b0\u5728\u6ca1\u6709\u6ee1\u8db3\u8c03\u5ea6\u8981\u6c42\u7684\u8282\u70b9\u7684\u8bdd\uff0cPod \u5c31\u4f1a\u5ffd\u7565\u8fd9\u6761\u89c4\u5219\uff0c\u7ee7\u7eed\u5b8c\u6210\u8c03\u5ea6\u8fc7\u7a0b\uff0c\u8bf4\u767d\u4e86\u5c31\u662f\u6ee1\u8db3\u6761\u4ef6\u6700\u597d\u4e86\uff0c\u6ca1\u6709\u7684\u8bdd\u4e5f\u65e0\u6240\u8c13</li> <li><code>\u786c\u7b56\u7565</code>\u5c31\u6bd4\u8f83\u5f3a\u786c\u4e86\uff0c\u5982\u679c\u6ca1\u6709\u6ee1\u8db3\u6761\u4ef6\u7684\u8282\u70b9\u7684\u8bdd\uff0c\u5c31\u4e0d\u65ad\u91cd\u8bd5\u76f4\u5230\u6ee1\u8db3\u6761\u4ef6\u4e3a\u6b62\uff0c\u7b80\u5355\u8bf4\u5c31\u662f\u4f60\u5fc5\u987b\u6ee1\u8db3\u6211\u7684\u8981\u6c42\uff0c\u4e0d\u7136\u5c31\u4e0d\u5e72\u4e86</li> </ul> <p>\u5bf9\u4e8e\u4eb2\u548c\u6027\u548c\u53cd\u4eb2\u548c\u6027\u90fd\u6709\u8fd9\u4e24\u79cd\u89c4\u5219\u53ef\u4ee5\u8bbe\u7f6e\uff1a </p> <pre><code>preferredDuringSchedulingIgnoredDuringExecution\n</code></pre> <p>\u548c</p> <pre><code>requiredDuringSchedulingIgnoredDuringExecution\n</code></pre> <p>\uff0c\u524d\u9762\u7684\u5c31\u662f\u8f6f\u7b56\u7565\uff0c\u540e\u9762\u7684\u5c31\u662f\u786c\u7b56\u7565\u3002</p>"},{"location":"kubernetes_scheduler/usage/#_3","title":"\u8282\u70b9\u4eb2\u548c\u6027","text":"<p>\u8282\u70b9\u4eb2\u548c\u6027\uff08nodeAffinity\uff09\u4e3b\u8981\u662f\u7528\u6765\u63a7\u5236 Pod \u8981\u90e8\u7f72\u5728\u54ea\u4e9b\u8282\u70b9\u4e0a\uff0c\u4ee5\u53ca\u4e0d\u80fd\u90e8\u7f72\u5728\u54ea\u4e9b\u8282\u70b9\u4e0a\u7684\uff0c\u5b83\u53ef\u4ee5\u8fdb\u884c\u4e00\u4e9b\u7b80\u5355\u7684\u903b\u8f91\u7ec4\u5408\u4e86\uff0c\u4e0d\u53ea\u662f\u7b80\u5355\u7684\u76f8\u7b49\u5339\u914d\u3002</p> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u7528\u4e00\u4e2a Deployment \u6765\u7ba1\u74068\u4e2a Pod \u526f\u672c\uff0c\u73b0\u5728\u6211\u4eec\u6765\u63a7\u5236\u4e0b\u8fd9\u4e9b Pod \u7684\u8c03\u5ea6\uff0c\u5982\u4e0b\u4f8b\u5b50\uff1a\uff08node-affinity-demo.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: node-affinity\n  labels:\n    app: node-affinity\nspec:\n  replicas: 8\n  selector:\n    matchLabels:\n      app: node-affinity\n  template:\n    metadata:\n      labels:\n        app: node-affinity\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:9\n        ports:\n        - containerPort: 80\n          name: nginxweb\n      affinity:\n        nodeAffinity:\n          requiredDuringSchedulingIgnoredDuringExecution:  # \u786c\u7b56\u7565\n            nodeSelectorTerms:\n            - matchExpressions:\n              - key: kubernetes.io/hostname\n                operator: NotIn\n                values:\n                - ydzs-node3\n          preferredDuringSchedulingIgnoredDuringExecution:  # \u8f6f\u7b56\u7565\n          - weight: 1\n            preference:\n              matchExpressions:\n              - key: com\n                operator: In\n                values:\n                - youdianzhishi\n</code></pre> <p>\u4e0a\u9762\u8fd9\u4e2a Pod \u9996\u5148\u662f\u8981\u6c42\u4e0d\u80fd\u8fd0\u884c\u5728 ydzs-node3 \u8fd9\u4e2a\u8282\u70b9\u4e0a\uff0c\u5982\u679c\u6709\u4e2a\u8282\u70b9\u6ee1\u8db3 <code>com=youdianzhishi</code> \u7684\u8bdd\u5c31\u4f18\u5148\u8c03\u5ea6\u5230\u8fd9\u4e2a\u8282\u70b9\u4e0a\u3002</p> <p>\u7531\u4e8e\u4e0a\u9762 ydzs-node02 \u8282\u70b9\u6211\u4eec\u6253\u4e0a\u4e86 <code>com=youdianzhishi</code> \u8fd9\u6837\u7684 label \u6807\u7b7e\uff0c\u6240\u4ee5\u6309\u8981\u6c42\u4f1a\u4f18\u5148\u8c03\u5ea6\u5230\u8fd9\u4e2a\u8282\u70b9\u6765\u7684\uff0c\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u8fd9\u4e2a Pod\uff0c\u7136\u540e\u67e5\u770b\u5177\u4f53\u7684\u8c03\u5ea6\u60c5\u51b5\u662f\u5426\u6ee1\u8db3\u6211\u4eec\u7684\u8981\u6c42\u3002</p> <pre><code>$ kubectl apply -f node-affinty-demo.yaml \ndeployment.apps/node-affinity created\n$ kubectl get pods -l app=node-affinity -o wide\nNAME                            READY   STATUS    RESTARTS   AGE     IP             NODE         NOMINATED NODE   READINESS GATES\nnode-affinity-cdd9d54d9-bgbbh   1/1     Running   0          2m28s   2247   ydzs-node2   &lt;none&gt;           &lt;none&gt;\nnode-affinity-cdd9d54d9-dlbck   1/1     Running   0          2m28s   216    ydzs-node4   &lt;none&gt;           &lt;none&gt;\nnode-affinity-cdd9d54d9-g2jr6   1/1     Running   0          2m28s   217    ydzs-node4   &lt;none&gt;           &lt;none&gt;\nnode-affinity-cdd9d54d9-gzr58   1/1     Running   0          2m28s   2118   ydzs-node1   &lt;none&gt;           &lt;none&gt;\nnode-affinity-cdd9d54d9-hcv7r   1/1     Running   0          2m28s   2246   ydzs-node2   &lt;none&gt;           &lt;none&gt;\nnode-affinity-cdd9d54d9-kvxw4   1/1     Running   0          2m28s   2245   ydzs-node2   &lt;none&gt;           &lt;none&gt;\nnode-affinity-cdd9d54d9-p4mmk   1/1     Running   0          2m28s   2244   ydzs-node2   &lt;none&gt;           &lt;none&gt;\nnode-affinity-cdd9d54d9-t5mff   1/1     Running   0          2m28s   2117   ydzs-node1   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u4ece\u7ed3\u679c\u53ef\u4ee5\u770b\u51fa\u67094\u4e2a Pod \u88ab\u90e8\u7f72\u5230\u4e86 ydzs-node2 \u8282\u70b9\u4e0a\uff0c\u4f46\u662f\u53ef\u4ee5\u770b\u5230\u5e76\u6ca1\u6709\u4e00\u4e2a Pod \u88ab\u90e8\u7f72\u5230 ydzs-node3 \u8fd9\u4e2a\u8282\u70b9\u4e0a\uff0c\u56e0\u4e3a\u6211\u4eec\u7684\u786c\u7b56\u7565\u5c31\u662f\u4e0d\u5141\u8bb8\u90e8\u7f72\u5230\u8be5\u8282\u70b9\u4e0a\uff0c\u800c ydzs-node2 \u662f\u8f6f\u7b56\u7565\uff0c\u6240\u4ee5\u4f1a\u5c3d\u91cf\u6ee1\u8db3\u3002\u8fd9\u91cc\u7684\u5339\u914d\u903b\u8f91\u662f label \u6807\u7b7e\u7684\u503c\u5728\u67d0\u4e2a\u5217\u8868\u4e2d\uff0c\u73b0\u5728 Kubernetes \u63d0\u4f9b\u7684\u64cd\u4f5c\u7b26\u6709\u4e0b\u9762\u7684\u51e0\u79cd\uff1a</p> <ul> <li>In\uff1alabel \u7684\u503c\u5728\u67d0\u4e2a\u5217\u8868\u4e2d</li> <li>NotIn\uff1alabel \u7684\u503c\u4e0d\u5728\u67d0\u4e2a\u5217\u8868\u4e2d</li> <li>Gt\uff1alabel \u7684\u503c\u5927\u4e8e\u67d0\u4e2a\u503c</li> <li>Lt\uff1alabel \u7684\u503c\u5c0f\u4e8e\u67d0\u4e2a\u503c</li> <li>Exists\uff1a\u67d0\u4e2a label \u5b58\u5728</li> <li>DoesNotExist\uff1a\u67d0\u4e2a label \u4e0d\u5b58\u5728</li> </ul> <p>\u4f46\u662f\u9700\u8981\u6ce8\u610f\u7684\u662f\u5982\u679c <code>nodeSelectorTerms</code> \u4e0b\u9762\u6709\u591a\u4e2a\u9009\u9879\u7684\u8bdd\uff0c\u6ee1\u8db3\u4efb\u4f55\u4e00\u4e2a\u6761\u4ef6\u5c31\u53ef\u4ee5\u4e86\uff1b\u5982\u679c <code>matchExpressions</code>\u6709\u591a\u4e2a\u9009\u9879\u7684\u8bdd\uff0c\u5219\u5fc5\u987b\u540c\u65f6\u6ee1\u8db3\u8fd9\u4e9b\u6761\u4ef6\u624d\u80fd\u6b63\u5e38\u8c03\u5ea6 Pod\u3002</p>"},{"location":"kubernetes_scheduler/usage/#pod","title":"Pod \u4eb2\u548c\u6027","text":"<p>Pod \u4eb2\u548c\u6027\uff08podAffinity\uff09\u4e3b\u8981\u89e3\u51b3 Pod \u53ef\u4ee5\u548c\u54ea\u4e9b Pod \u90e8\u7f72\u5728\u540c\u4e00\u4e2a\u62d3\u6251\u57df\u4e2d\u7684\u95ee\u9898\uff08\u5176\u4e2d\u62d3\u6251\u57df\u7528\u4e3b\u673a\u6807\u7b7e\u5b9e\u73b0\uff0c\u53ef\u4ee5\u662f\u5355\u4e2a\u4e3b\u673a\uff0c\u4e5f\u53ef\u4ee5\u662f\u591a\u4e2a\u4e3b\u673a\u7ec4\u6210\u7684 cluster\u3001zone \u7b49\u7b49\uff09\uff0c\u800c Pod \u53cd\u4eb2\u548c\u6027\u4e3b\u8981\u662f\u89e3\u51b3 Pod \u4e0d\u80fd\u548c\u54ea\u4e9b Pod \u90e8\u7f72\u5728\u540c\u4e00\u4e2a\u62d3\u6251\u57df\u4e2d\u7684\u95ee\u9898\uff0c\u5b83\u4eec\u90fd\u662f\u5904\u7406\u7684 Pod \u4e0e Pod \u4e4b\u95f4\u7684\u5173\u7cfb\uff0c\u6bd4\u5982\u4e00\u4e2a Pod \u5728\u4e00\u4e2a\u8282\u70b9\u4e0a\u4e86\uff0c\u90a3\u4e48\u6211\u8fd9\u4e2a\u4e5f\u5f97\u5728\u8fd9\u4e2a\u8282\u70b9\uff0c\u6216\u8005\u4f60\u8fd9\u4e2a Pod \u5728\u8282\u70b9\u4e0a\u4e86\uff0c\u90a3\u4e48\u6211\u5c31\u4e0d\u60f3\u548c\u4f60\u5f85\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a\u3002</p> <p>\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u53ea\u6709\u4e00\u4e2a\u96c6\u7fa4\uff0c\u5e76\u6ca1\u6709\u533a\u57df\u6216\u8005\u673a\u623f\u7684\u6982\u5ff5\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u76f4\u63a5\u4f7f\u7528\u4e3b\u673a\u540d\u6765\u4f5c\u4e3a\u62d3\u6251\u57df\uff0c\u628a Pod \u521b\u5efa\u5728\u540c\u4e00\u4e2a\u4e3b\u673a\u4e0a\u9762\u3002</p> <pre><code>$ kubectl get nodes --show-labels\nNAME          STATUS   ROLES    AGE   VERSION   LABELS\nydzs-master   Ready    master   55d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-master,kubernetes.io/os=linux,node-role.kubernetes.io/master=\nydzs-node1    Ready    &lt;none&gt;   55d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/fluentd-ds-ready=true,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-node1,kubernetes.io/os=linux\nydzs-node2    Ready    &lt;none&gt;   55d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/fluentd-ds-ready=true,beta.kubernetes.io/os=linux,com=youdianzhishi,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-node2,kubernetes.io/os=linux\nydzs-node3    Ready    &lt;none&gt;   53d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/fluentd-ds-ready=true,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-node3,kubernetes.io/os=linux,monitor=prometheus\nydzs-node4    Ready    &lt;none&gt;   53d   v2   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/fluentd-ds-ready=true,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ydzs-node4,kubernetes.io/os=linux\n</code></pre> <p>\u540c\u6837\uff0c\u8fd8\u662f\u9488\u5bf9\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u6211\u4eec\u6765\u6d4b\u8bd5\u4e0b Pod \u7684\u4eb2\u548c\u6027\uff1a\uff08pod-affinity-demo.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: pod-affinity\n  labels:\n    app: pod-affinity\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: pod-affinity\n  template:\n    metadata:\n      labels:\n        app: pod-affinity\n    spec:\n      containers:\n      - name: nginx\n        image: nginx\n        ports:\n        - containerPort: 80\n          name: nginxweb\n      affinity:\n        podAffinity:\n          requiredDuringSchedulingIgnoredDuringExecution:  # \u786c\u7b56\u7565\n          - labelSelector:\n              matchExpressions:\n              - key: app\n                operator: In\n                values:\n                - busybox-pod\n            topologyKey: kubernetes.io/hostname\n</code></pre> <p>\u4e0a\u9762\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\u7684 Pod \u9700\u8981\u8c03\u5ea6\u5230\u67d0\u4e2a\u6307\u5b9a\u7684\u8282\u70b9\u4e0a\uff0c\u5e76\u4e14\u8be5\u8282\u70b9\u4e0a\u8fd0\u884c\u4e86\u4e00\u4e2a\u5e26\u6709 <code>app=busybox-pod</code> \u6807\u7b7e\u7684 Pod\u3002\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u6709\u6807\u7b7e <code>app=busybox-pod</code> \u7684 pod \u5217\u8868\uff1a</p> <pre><code>$ kubectl get pods -l app=busybox-pod -o wide\nNAME           READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES\ntest-busybox   1/1     Running   0          27m   2242   ydzs-node2   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u6211\u4eec\u770b\u5230\u8fd9\u4e2a Pod \u8fd0\u884c\u5728\u4e86 ydzs-node2 \u7684\u8282\u70b9\u4e0a\u9762\uff0c\u6240\u4ee5\u6309\u7167\u4e0a\u9762\u7684\u4eb2\u548c\u6027\u6765\u8bf4\uff0c\u4e0a\u9762\u6211\u4eec\u90e8\u7f72\u76843\u4e2a Pod \u526f\u672c\u4e5f\u5e94\u8be5\u8fd0\u884c\u5728 ydzs-node2 \u8282\u70b9\u4e0a\uff1a</p> <pre><code>$ kubectl apply -f pod-affinity-demo.yaml \ndeployment.apps/pod-affinity created\n$ kubectl get pods -o wide -l app=pod-affinity\nNAME                            READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES\npod-affinity-587f9b5b58-5nxmf   1/1     Running   0          26s   2249   ydzs-node2   &lt;none&gt;           &lt;none&gt;\npod-affinity-587f9b5b58-m2j7s   1/1     Running   0          26s   2248   ydzs-node2   &lt;none&gt;           &lt;none&gt;\npod-affinity-587f9b5b58-vrd7b   1/1     Running   0          26s   2250   ydzs-node2   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u628a\u4e0a\u9762\u7684 test-busybox \u548c pod-affinity \u8fd9\u4e2a Deployment \u90fd\u5220\u9664\uff0c\u7136\u540e\u91cd\u65b0\u521b\u5efa pod-affinity \u8fd9\u4e2a\u8d44\u6e90\uff0c\u770b\u770b\u80fd\u4e0d\u80fd\u6b63\u5e38\u8c03\u5ea6\u5462\uff1a</p> <pre><code>$ kubectl delete -f node-selector-demo.yaml\npod \"test-busybox\" deleted\n$  kubectl delete -f pod-affinity-demo.yaml\ndeployment.apps \"pod-affinity\" deleted\n$ kubectl apply -f pod-affinity-demo.yaml\ndeployment.apps/pod-affinity created\n$ kubectl get pods -o wide -l app=pod-affinity\nNAME                            READY   STATUS    RESTARTS   AGE   IP       NODE     NOMINATED NODE   READINESS GATES\npod-affinity-587f9b5b58-bbfgr   0/1     Pending   0          18s   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;\npod-affinity-587f9b5b58-lwc8n   0/1     Pending   0          18s   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;\npod-affinity-587f9b5b58-pc7ql   0/1     Pending   0          18s   &lt;none&gt;   &lt;none&gt;   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u90fd\u5904\u4e8e <code>Pending</code> \u72b6\u6001\u4e86\uff0c\u8fd9\u662f\u56e0\u4e3a\u73b0\u5728\u6ca1\u6709\u4e00\u4e2a\u8282\u70b9\u4e0a\u9762\u62e5\u6709 <code>app=busybox-pod</code> \u8fd9\u4e2a\u6807\u7b7e\u7684 Pod\uff0c\u800c\u4e0a\u9762\u6211\u4eec\u7684\u8c03\u5ea6\u4f7f\u7528\u7684\u662f\u786c\u7b56\u7565\uff0c\u6240\u4ee5\u5c31\u6ca1\u529e\u6cd5\u8fdb\u884c\u8c03\u5ea6\u4e86\uff0c\u5927\u5bb6\u53ef\u4ee5\u53bb\u5c1d\u8bd5\u4e0b\u91cd\u65b0\u5c06 test-busybox \u8fd9\u4e2a Pod \u8c03\u5ea6\u5230\u5176\u4ed6\u8282\u70b9\u4e0a\uff0c\u89c2\u5bdf\u4e0b\u4e0a\u9762\u76843\u4e2a\u526f\u672c\u4f1a\u4e0d\u4f1a\u4e5f\u88ab\u8c03\u5ea6\u5230\u5bf9\u5e94\u7684\u8282\u70b9\u4e0a\u53bb\u3002</p> <p>\u6211\u4eec\u8fd9\u4e2a\u5730\u65b9\u4f7f\u7528\u7684\u662f </p> <pre><code>kubernetes.io/hostname\n</code></pre> <p>\u8fd9\u4e2a\u62d3\u6251\u57df\uff0c\u610f\u601d\u5c31\u662f\u6211\u4eec\u5f53\u524d\u8c03\u5ea6\u7684 Pod \u8981\u548c\u76ee\u6807\u7684 Pod \u5904\u4e8e\u540c\u4e00\u4e2a\u4e3b\u673a\u4e0a\u9762\uff0c\u56e0\u4e3a\u8981\u5904\u4e8e\u540c\u4e00\u4e2a\u62d3\u6251\u57df\u4e0b\u9762\uff0c\u4e3a\u4e86\u8bf4\u660e\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u628a\u62d3\u6251\u57df\u6539\u6210 </p> <pre><code>beta.kubernetes.io/os\n</code></pre> <p>\uff0c\u540c\u6837\u7684\u6211\u4eec\u5f53\u524d\u8c03\u5ea6\u7684 Pod \u8981\u548c\u76ee\u6807\u7684 Pod \u5904\u4e8e\u540c\u4e00\u4e2a\u62d3\u6251\u57df\u4e2d\uff0c\u76ee\u6807\u7684 Pod \u662f\u62e5\u6709 </p> <pre><code>beta.kubernetes.io/os=linux\n</code></pre> <p>\u7684\u6807\u7b7e\uff0c\u800c\u6211\u4eec\u8fd9\u91cc\u6240\u6709\u8282\u70b9\u90fd\u6709\u8fd9\u6837\u7684\u6807\u7b7e\uff0c\u8fd9\u4e5f\u5c31\u610f\u5473\u7740\u6211\u4eec\u6240\u6709\u8282\u70b9\u90fd\u5728\u540c\u4e00\u4e2a\u62d3\u6251\u57df\u4e2d\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u7684 Pod \u53ef\u4ee5\u88ab\u8c03\u5ea6\u5230\u4efb\u4f55\u4e00\u4e2a\u8282\u70b9\uff0c\u91cd\u65b0\u8fd0\u884c\u4e0a\u9762\u7684 <code>app=busybox-pod</code> \u7684 Pod\uff0c\u7136\u540e\u518d\u66f4\u65b0\u4e0b\u6211\u4eec\u8fd9\u91cc\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl get pods -o wide -l app=pod-affinity\nNAME                           READY   STATUS    RESTARTS   AGE     IP             NODE         NOMINATED NODE   READINESS GATES\npod-affinity-76c56567c-792n4   1/1     Running   0          2m59s   2254   ydzs-node2   &lt;none&gt;           &lt;none&gt;\npod-affinity-76c56567c-8s2pd   1/1     Running   0          3m53s   218    ydzs-node4   &lt;none&gt;           &lt;none&gt;\npod-affinity-76c56567c-hx7ck   1/1     Running   0          2m52s   223    ydzs-node3   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u73b0\u5728\u662f\u5206\u522b\u8fd0\u884c\u57283\u4e2a\u8282\u70b9\u4e0b\u9762\u7684\uff0c\u56e0\u4e3a\u4ed6\u4eec\u90fd\u5c5e\u4e8e </p> <pre><code>beta.kubernetes.io/os\n</code></pre> <p>\u8fd9\u4e2a\u62d3\u6251\u57df\u3002</p>"},{"location":"kubernetes_scheduler/usage/#pod_1","title":"Pod \u53cd\u4eb2\u548c\u6027","text":"<p>Pod \u53cd\u4eb2\u548c\u6027\uff08podAntiAffinity\uff09\u5219\u662f\u53cd\u7740\u6765\u7684\uff0c\u6bd4\u5982\u4e00\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e86\u67d0\u4e2a Pod\uff0c\u90a3\u4e48\u6211\u4eec\u7684\u6a21\u677f Pod \u5219\u4e0d\u5e0c\u671b\u88ab\u8c03\u5ea6\u5230\u8fd9\u4e2a\u8282\u70b9\u4e0a\u9762\u53bb\u4e86\u3002\u6211\u4eec\u628a\u4e0a\u9762\u7684 <code>podAffinity</code> \u76f4\u63a5\u6539\u6210 <code>podAntiAffinity</code>\uff1a(pod-antiaffinity-demo.yaml)</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: pod-antiaffinity\n  labels:\n    app: pod-antiaffinity\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: pod-antiaffinity\n  template:\n    metadata:\n      labels:\n        app: pod-antiaffinity\n    spec:\n      containers:\n      - name: nginx\n        image: nginx\n        ports:\n        - containerPort: 80\n          name: nginxweb\n      affinity:\n        podAntiAffinity:\n          requiredDuringSchedulingIgnoredDuringExecution:  # \u786c\u7b56\u7565\n          - labelSelector:\n              matchExpressions:\n              - key: app\n                operator: In\n                values:\n                - busybox-pod\n            topologyKey: kubernetes.io/hostname\n</code></pre> <p>\u8fd9\u91cc\u7684\u610f\u601d\u5c31\u662f\u5982\u679c\u4e00\u4e2a\u8282\u70b9\u4e0a\u9762\u6709\u4e00\u4e2a <code>app=busybox-pod</code> \u8fd9\u6837\u7684 Pod \u7684\u8bdd\uff0c\u90a3\u4e48\u6211\u4eec\u7684 Pod \u5c31\u522b\u8c03\u5ea6\u5230\u8fd9\u4e2a\u8282\u70b9\u4e0a\u9762\u6765\uff0c\u4e0a\u9762\u6211\u4eec\u628a<code>app=busybox-pod</code> \u8fd9\u4e2a Pod \u56fa\u5b9a\u5230\u4e86 ydzs-node2 \u8fd9\u4e2a\u8282\u70b9\u4e0a\u9762\u7684\uff0c\u6240\u4ee5\u6b63\u5e38\u6765\u8bf4\u6211\u4eec\u8fd9\u91cc\u7684 Pod \u4e0d\u4f1a\u51fa\u73b0\u5728\u8be5\u8282\u70b9\u4e0a\uff1a</p> <pre><code>$ kubectl apply -f pod-antiaffinity-demo.yaml \ndeployment.apps/pod-antiaffinity created\n$ kubectl get pods -l app=pod-antiaffinity -o wide\nNAME                                READY   STATUS    RESTARTS   AGE   IP            NODE         NOMINATED NODE   READINESS GATES\npod-antiaffinity-84d5bf9df4-9c9qk   1/1     Running   0          73s   219   ydzs-node4   &lt;none&gt;           &lt;none&gt;\npod-antiaffinity-84d5bf9df4-q6lkm   1/1     Running   0          67s   224   ydzs-node3   &lt;none&gt;           &lt;none&gt;\npod-antiaffinity-84d5bf9df4-vk9tc   1/1     Running   0          57s   225   ydzs-node3   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6ca1\u6709\u88ab\u8c03\u5ea6\u5230 ydzs-node2 \u8282\u70b9\u4e0a\uff0c\u56e0\u4e3a\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u7684\u662f Pod \u53cd\u4eb2\u548c\u6027\u3002\u5927\u5bb6\u53ef\u4ee5\u601d\u8003\u4e0b\uff0c\u5982\u679c\u8fd9\u91cc\u6211\u4eec\u5c06\u62d3\u6251\u57df\u66f4\u6539\u6210 </p> <pre><code>beta.kubernetes.io/os\n</code></pre> <p>\u4f1a\u600e\u4e48\u6837\u5462\uff1f\u53ef\u4ee5\u81ea\u5df1\u53bb\u6d4b\u8bd5\u4e0b\u770b\u770b\u3002</p>"},{"location":"kubernetes_scheduler/usage/#_4","title":"\u6c61\u70b9\u4e0e\u5bb9\u5fcd","text":"<p>\u5bf9\u4e8e <code>nodeAffinity</code> \u65e0\u8bba\u662f\u786c\u7b56\u7565\u8fd8\u662f\u8f6f\u7b56\u7565\u65b9\u5f0f\uff0c\u90fd\u662f\u8c03\u5ea6 Pod \u5230\u9884\u671f\u8282\u70b9\u4e0a\uff0c\u800c\u6c61\u70b9\uff08Taints\uff09\u6070\u597d\u4e0e\u4e4b\u76f8\u53cd\uff0c\u5982\u679c\u4e00\u4e2a\u8282\u70b9\u6807\u8bb0\u4e3a Taints \uff0c\u9664\u975e Pod \u4e5f\u88ab\u6807\u8bc6\u4e3a\u53ef\u4ee5\u5bb9\u5fcd\u6c61\u70b9\u8282\u70b9\uff0c\u5426\u5219\u8be5 Taints \u8282\u70b9\u4e0d\u4f1a\u88ab\u8c03\u5ea6 Pod\u3002</p> <p>\u6bd4\u5982\u7528\u6237\u5e0c\u671b\u628a Master \u8282\u70b9\u4fdd\u7559\u7ed9 Kubernetes \u7cfb\u7edf\u7ec4\u4ef6\u4f7f\u7528\uff0c\u6216\u8005\u628a\u4e00\u7ec4\u5177\u6709\u7279\u6b8a\u8d44\u6e90\u9884\u7559\u7ed9\u67d0\u4e9b Pod\uff0c\u5219\u6c61\u70b9\u5c31\u5f88\u6709\u7528\u4e86\uff0cPod \u4e0d\u4f1a\u518d\u88ab\u8c03\u5ea6\u5230 taint \u6807\u8bb0\u8fc7\u7684\u8282\u70b9\u3002\u6211\u4eec\u4f7f\u7528 kubeadm \u642d\u5efa\u7684\u96c6\u7fa4\u9ed8\u8ba4\u5c31\u7ed9 master \u8282\u70b9\u6dfb\u52a0\u4e86\u4e00\u4e2a\u6c61\u70b9\u6807\u8bb0\uff0c\u6240\u4ee5\u6211\u4eec\u770b\u5230\u6211\u4eec\u5e73\u65f6\u7684 Pod \u90fd\u6ca1\u6709\u88ab\u8c03\u5ea6\u5230 master \u4e0a\u53bb\uff1a</p> <pre><code>$ kubectl describe node ydzs-master\nName:               ydzs-master\nRoles:              master\nLabels:             beta.kubernetes.io/arch=amd64\n                    beta.kubernetes.io/os=linux\n                    kubernetes.io/arch=amd64\n                    kubernetes.io/hostname=ydzs-master\n                    kubernetes.io/os=linux\n                    node-role.kubernetes.io/master=\n......\nTaints:             node-role.kubernetes.io/master:NoSchedule\nUnschedulable:      false\n......\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0a\u9762\u7684\u547d\u4ee4\u67e5\u770b master \u8282\u70b9\u7684\u4fe1\u606f\uff0c\u5176\u4e2d\u6709\u4e00\u6761\u5173\u4e8e Taints \u7684\u4fe1\u606f\uff1a</p> <pre><code>node-role.kubernetes.io/master:NoSchedule\n</code></pre> <p>\uff0c\u5c31\u8868\u793amaster \u8282\u70b9\u6253\u4e86\u4e00\u4e2a\u6c61\u70b9\u7684\u6807\u8bb0\uff0c\u5176\u4e2d\u5f71\u54cd\u7684\u53c2\u6570\u662f <code>NoSchedule</code>\uff0c\u8868\u793a Pod \u4e0d\u4f1a\u88ab\u8c03\u5ea6\u5230\u6807\u8bb0\u4e3a taints \u7684\u8282\u70b9\uff0c\u9664\u4e86 <code>NoSchedule</code> \u5916\uff0c\u8fd8\u6709\u53e6\u5916\u4e24\u4e2a\u9009\u9879\uff1a</p> <ul> <li>PreferNoSchedule\uff1aNoSchedule \u7684\u8f6f\u7b56\u7565\u7248\u672c\uff0c\u8868\u793a\u5c3d\u91cf\u4e0d\u8c03\u5ea6\u5230\u6c61\u70b9\u8282\u70b9\u4e0a\u53bb</li> <li>NoExecute\uff1a\u8be5\u9009\u9879\u610f\u5473\u7740\u4e00\u65e6 Taint \u751f\u6548\uff0c\u5982\u8be5\u8282\u70b9\u5185\u6b63\u5728\u8fd0\u884c\u7684 Pod \u6ca1\u6709\u5bf9\u5e94\u5bb9\u5fcd\uff08Tolerate\uff09\u8bbe\u7f6e\uff0c\u5219\u4f1a\u76f4\u63a5\u88ab\u9010\u51fa</li> </ul> <p>\u6c61\u70b9 taint \u6807\u8bb0\u8282\u70b9\u7684\u547d\u4ee4\u5982\u4e0b\uff1a</p> <pre><code>$ kubectl taint nodes ydzs-node2 test=node2:NoSchedule\nnode \"ydzs-node2\" tainted\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u540d\u5c06 ydzs-node2 \u8282\u70b9\u6807\u8bb0\u4e3a\u4e86\u6c61\u70b9\uff0c\u5f71\u54cd\u7b56\u7565\u662f <code>NoSchedule</code>\uff0c\u53ea\u4f1a\u5f71\u54cd\u65b0\u7684 Pod \u8c03\u5ea6\uff0c\u5982\u679c\u4ecd\u7136\u5e0c\u671b\u67d0\u4e2a Pod \u8c03\u5ea6\u5230 taint \u8282\u70b9\u4e0a\uff0c\u5219\u5fc5\u987b\u5728 Spec \u4e2d\u505a\u51fa Toleration \u5b9a\u4e49\uff0c\u624d\u80fd\u8c03\u5ea6\u5230\u8be5\u8282\u70b9\uff0c\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u60f3\u8981\u5c06\u4e00\u4e2a Pod \u8c03\u5ea6\u5230 master \u8282\u70b9\uff1a(taint-demo.yaml)</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: taint\n  labels:\n    app: taint\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: taint\n  template:\n    metadata:\n      labels:\n        app: taint\n    spec:\n      containers:\n      - name: nginx\n        image: nginx\n        ports:\n        - name: http\n          containerPort: 80\n      tolerations:\n      - key: \"node-role.kubernetes.io/master\"\n        operator: \"Exists\"\n        effect: \"NoSchedule\"\n</code></pre> <p>\u7531\u4e8e master \u8282\u70b9\u88ab\u6807\u8bb0\u4e3a\u4e86\u6c61\u70b9\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u8981\u60f3 Pod \u80fd\u591f\u8c03\u5ea6\u5230\u6539\u8282\u70b9\u53bb\uff0c\u5c31\u9700\u8981\u589e\u52a0\u5bb9\u5fcd\u7684\u58f0\u660e\uff1a</p> <pre><code>tolerations:\n- key: \"node-role.kubernetes.io/master\"\n  operator: \"Exists\"\n  effect: \"NoSchedule\"\n</code></pre> <p>\u7136\u540e\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\uff0c\u67e5\u770b\u7ed3\u679c\uff1a</p> <pre><code>$ kubectl apply -f taint-demo.yaml\ndeployment.apps \"taint\" created\n$ kubectl get pods -o wide\nNAME                                      READY     STATUS             RESTARTS   AGE       IP             NODE\n......\ntaint-845d8bb4fb-57mhm                    1/1       Running            0          1m        2247   ydzs-node2\ntaint-845d8bb4fb-bbvmp                    1/1       Running            0          1m        233    ydzs-master\ntaint-845d8bb4fb-zb78x                    1/1       Running            0          1m        2246   ydzs-node2\n......\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6709\u4e00\u4e2a Pod \u526f\u672c\u88ab\u8c03\u5ea6\u5230\u4e86 master \u8282\u70b9\uff0c\u8fd9\u5c31\u662f\u5bb9\u5fcd\u7684\u4f7f\u7528\u65b9\u6cd5\u3002</p> <p>\u5bf9\u4e8e <code>tolerations</code> \u5c5e\u6027\u7684\u5199\u6cd5\uff0c\u5176\u4e2d\u7684 key\u3001value\u3001effect \u4e0e Node \u7684 Taint \u8bbe\u7f6e\u9700\u4fdd\u6301\u4e00\u81f4\uff0c \u8fd8\u6709\u4ee5\u4e0b\u51e0\u70b9\u8bf4\u660e\uff1a</p> <ul> <li>\u5982\u679c operator \u7684\u503c\u662f <code>Exists</code>\uff0c\u5219 value \u5c5e\u6027\u53ef\u7701\u7565</li> <li>\u5982\u679c operator \u7684\u503c\u662f <code>Equal</code>\uff0c\u5219\u8868\u793a\u5176 key \u4e0e value \u4e4b\u95f4\u7684\u5173\u7cfb\u662f equal(\u7b49\u4e8e)</li> <li>\u5982\u679c\u4e0d\u6307\u5b9a operator \u5c5e\u6027\uff0c\u5219\u9ed8\u8ba4\u503c\u4e3a <code>Equal</code></li> </ul> <p>\u53e6\u5916\uff0c\u8fd8\u6709\u4e24\u4e2a\u7279\u6b8a\u503c\uff1a</p> <ul> <li>\u7a7a\u7684 key \u5982\u679c\u518d\u914d\u5408 <code>Exists</code> \u5c31\u80fd\u5339\u914d\u6240\u6709\u7684 key \u4e0e value\uff0c\u4e5f\u5c31\u662f\u662f\u80fd\u5bb9\u5fcd\u6240\u6709\u8282\u70b9\u7684\u6240\u6709 Taints</li> <li>\u7a7a\u7684 effect \u5339\u914d\u6240\u6709\u7684 effect</li> </ul> <p>\u6700\u540e\u5982\u679c\u6211\u4eec\u8981\u53d6\u6d88\u8282\u70b9\u7684\u6c61\u70b9\u6807\u8bb0\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl taint nodes ydzs-node2 test-\nnode \"ydzs-node2\" untainted\n</code></pre>"},{"location":"kubernetes_security/admission/","title":"\u51c6\u5165\u63a7\u5236\u5668","text":"<p>\ue3c9</p>"},{"location":"kubernetes_security/admission/#_1","title":"\u51c6\u5165\u63a7\u5236\u5668","text":"<p>Kubernetes \u63d0\u4f9b\u4e86\u9700\u8981\u6269\u5c55\u5176\u5185\u7f6e\u529f\u80fd\u7684\u65b9\u6cd5\uff0c\u6700\u5e38\u7528\u7684\u53ef\u80fd\u662f\u81ea\u5b9a\u4e49\u8d44\u6e90\u7c7b\u578b\u548c\u81ea\u5b9a\u4e49\u63a7\u5236\u5668\u4e86\uff0c\u9664\u6b64\u4e4b\u5916\uff0cKubernetes \u8fd8\u6709\u4e00\u4e9b\u5176\u4ed6\u975e\u5e38\u6709\u8da3\u7684\u529f\u80fd\uff0c\u6bd4\u5982 <code>admission webhooks</code> \u5c31\u53ef\u4ee5\u7528\u4e8e\u6269\u5c55 API\uff0c\u7528\u4e8e\u4fee\u6539\u67d0\u4e9b Kubernetes \u8d44\u6e90\u7684\u57fa\u672c\u884c\u4e3a\u3002</p> <p>\u51c6\u5165\u63a7\u5236\u5668\u662f\u5728\u5bf9\u8c61\u6301\u4e45\u5316\u4e4b\u524d\u7528\u4e8e\u5bf9 Kubernetes API Server \u7684\u8bf7\u6c42\u8fdb\u884c\u62e6\u622a\u7684\u4ee3\u7801\u6bb5\uff0c\u5728\u8bf7\u6c42\u7ecf\u8fc7<code>\u8eab\u4efd\u9a8c\u8bc1</code>\u548c<code>\u6388\u6743\u4e4b\u540e</code>\u653e\u884c\u901a\u8fc7\u3002\u51c6\u5165\u63a7\u5236\u5668\u53ef\u80fd\u6b63\u5728 <code>validating</code>\u3001<code>mutating</code> \u6216\u8005\u90fd\u5728\u6267\u884c\uff0c<code>Mutating</code> \u63a7\u5236\u5668\u53ef\u4ee5\u4fee\u6539\u4ed6\u4eec\u5904\u7406\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c<code>Validating</code> \u63a7\u5236\u5668\u4e0d\u4f1a\uff0c\u5982\u679c\u4efb\u4f55\u4e00\u4e2a\u9636\u6bb5\u4e2d\u7684\u4efb\u4f55\u63a7\u5236\u5668\u62d2\u7edd\u4e86\u8bf7\u6c42\uff0c\u5219\u4f1a\u7acb\u5373\u62d2\u7edd\u6574\u4e2a\u8bf7\u6c42\uff0c\u5e76\u5c06\u9519\u8bef\u8fd4\u56de\u7ed9\u6700\u7ec8\u7684\u7528\u6237\u3002</p> <p>\u8fd9\u610f\u5473\u7740\u6709\u4e00\u4e9b\u7279\u6b8a\u7684\u63a7\u5236\u5668\u53ef\u4ee5\u62e6\u622a Kubernetes API \u8bf7\u6c42\uff0c\u5e76\u6839\u636e\u81ea\u5b9a\u4e49\u7684\u903b\u8f91\u4fee\u6539\u6216\u8005\u62d2\u7edd\u5b83\u4eec\u3002Kubernetes \u6709\u81ea\u5df1\u5b9e\u73b0\u7684\u4e00\u4e2a\u63a7\u5236\u5668\u5217\u8868\uff1ahttps://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#what-does-each-admission-controller-do\uff0c\u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u7f16\u5199\u81ea\u5df1\u7684\u63a7\u5236\u5668\uff0c\u867d\u7136\u8fd9\u4e9b\u63a7\u5236\u5668\u542c\u8d77\u6765\u529f\u80fd\u6bd4\u8f83\u5f3a\u5927\uff0c\u4f46\u662f\u8fd9\u4e9b\u63a7\u5236\u5668\u9700\u8981\u88ab\u7f16\u8bd1\u8fdb kube-apiserver\uff0c\u5e76\u4e14\u53ea\u80fd\u5728 apiserver \u542f\u52a8\u65f6\u542f\u52a8\u3002</p> <p>\u7531\u4e8e\u4e0a\u9762\u7684\u63a7\u5236\u5668\u7684\u9650\u5236\uff0c\u6211\u4eec\u5c31\u9700\u8981\u7528\u5230<code>\u52a8\u6001</code>\u7684\u6982\u5ff5\u4e86\uff0c\u800c\u4e0d\u662f\u548c apiserver \u8026\u5408\u5728\u4e00\u8d77\uff0c<code>Admission webhooks</code> \u5c31\u901a\u8fc7\u4e00\u79cd\u52a8\u6001\u914d\u7f6e\u65b9\u6cd5\u89e3\u51b3\u4e86\u8fd9\u4e2a\u9650\u5236\u95ee\u9898\u3002</p>"},{"location":"kubernetes_security/admission/#admission_webhook","title":"admission webhook \u662f\u4ec0\u4e48?","text":"<p>\u5728 Kubernetes apiserver \u4e2d\u5305\u542b\u4e24\u4e2a\u7279\u6b8a\u7684\u51c6\u5165\u63a7\u5236\u5668\uff1a</p> <pre><code>MutatingAdmissionWebhook\n</code></pre> <p>\u548c</p> <pre><code>ValidatingAdmissionWebhook\n</code></pre> <p>\uff0c\u8fd9\u4e24\u4e2a\u63a7\u5236\u5668\u5c06\u53d1\u9001\u51c6\u5165\u8bf7\u6c42\u5230\u5916\u90e8\u7684 HTTP \u56de\u8c03\u670d\u52a1\u5e76\u63a5\u6536\u4e00\u4e2a\u51c6\u5165\u54cd\u5e94\u3002\u5982\u679c\u542f\u7528\u4e86\u8fd9\u4e24\u4e2a\u51c6\u5165\u63a7\u5236\u5668\uff0cKubernetes \u7ba1\u7406\u5458\u53ef\u4ee5\u5728\u96c6\u7fa4\u4e2d\u521b\u5efa\u548c\u914d\u7f6e\u4e00\u4e2a admission webhook\u3002</p> <p></p> <p>\u6574\u4f53\u7684\u6b65\u9aa4\u5982\u4e0b\u6240\u793a\uff1a</p> <ul> <li> <ol> <li>\u68c0\u67e5\u96c6\u7fa4\u4e2d\u662f\u5426\u542f\u7528\u4e86 admission webhook \u63a7\u5236\u5668\uff0c\u5e76\u6839\u636e\u9700\u8981\u8fdb\u884c\u914d\u7f6e\u3002</li> </ol> </li> <li> <ol> <li>\u7f16\u5199\u5904\u7406\u51c6\u5165\u8bf7\u6c42\u7684 HTTP \u56de\u8c03\uff0c\u56de\u8c03\u53ef\u4ee5\u662f\u4e00\u4e2a\u90e8\u7f72\u5728\u96c6\u7fa4\u4e2d\u7684\u7b80\u5355 HTTP \u670d\u52a1\uff0c\u751a\u81f3\u4e5f\u53ef\u4ee5\u662f\u4e00\u4e2a <code>serverless</code> \u51fd\u6570\uff0c\u4f8b\u5982 https://github.com/kelseyhightower/denyenv-validating-admission-webhook \u8fd9\u4e2a\u9879\u76ee\u3002</li> </ol> </li> <li> <ol> <li> <p>\u901a\u8fc7 </p> <pre><code>MutatingWebhookConfiguration\n</code></pre> <p>\u548c </p> <pre><code>ValidatingWebhookConfiguration\n</code></pre> <p>\u8d44\u6e90\u914d\u7f6e admission webhook\u3002</p> </li> </ol> </li> </ul> <p>\u8fd9\u4e24\u79cd\u7c7b\u578b\u7684 admission webhook \u4e4b\u95f4\u7684\u533a\u522b\u662f\u975e\u5e38\u660e\u663e\u7684\uff1a<code>validating webhooks</code> \u53ef\u4ee5\u62d2\u7edd\u8bf7\u6c42\uff0c\u4f46\u662f\u5b83\u4eec\u5374\u4e0d\u80fd\u4fee\u6539\u51c6\u5165\u8bf7\u6c42\u4e2d\u83b7\u53d6\u7684\u5bf9\u8c61\uff0c\u800c <code>mutating webhooks</code> \u53ef\u4ee5\u5728\u8fd4\u56de\u51c6\u5165\u54cd\u5e94\u4e4b\u524d\u901a\u8fc7\u521b\u5efa\u8865\u4e01\u6765\u4fee\u6539\u5bf9\u8c61\uff0c\u5982\u679c webhook \u62d2\u7edd\u4e86\u4e00\u4e2a\u8bf7\u6c42\uff0c\u5219\u4f1a\u5411\u6700\u7ec8\u7528\u6237\u8fd4\u56de\u9519\u8bef\u3002</p> <p>\u73b0\u5728\u975e\u5e38\u706b\u70ed\u7684\u7684 Service Mesh \u5e94\u7528 <code>istio</code> \u5c31\u662f\u901a\u8fc7 mutating webhooks \u6765\u81ea\u52a8\u5c06 <code>Envoy</code> \u8fd9\u4e2a sidecar \u5bb9\u5668\u6ce8\u5165\u5230 Pod \u4e2d\u53bb\u7684\uff1ahttps://istio.io/docs/setup/kubernetes/sidecar-injection/\u3002</p>"},{"location":"kubernetes_security/admission/#admission_webhook_1","title":"\u521b\u5efa\u914d\u7f6e\u4e00\u4e2a Admission Webhook","text":"<p>\u4e0a\u9762\u6211\u4eec\u4ecb\u7ecd\u4e86 Admission Webhook \u7684\u7406\u8bba\u77e5\u8bc6\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5728\u4e00\u4e2a\u771f\u5b9e\u7684 Kubernetes \u96c6\u7fa4\u4e2d\u6765\u5b9e\u9645\u6d4b\u8bd5\u4f7f\u7528\u4e0b\uff0c\u6211\u4eec\u5c06\u521b\u5efa\u4e00\u4e2a webhook \u7684 webserver\uff0c\u5c06\u5176\u90e8\u7f72\u5230\u96c6\u7fa4\u4e2d\uff0c\u7136\u540e\u521b\u5efa webhook \u914d\u7f6e\u67e5\u770b\u662f\u5426\u751f\u6548\u3002</p> <p>\u9996\u5148\u786e\u4fdd\u5728 apiserver \u4e2d\u542f\u7528\u4e86 </p> <pre><code>MutatingAdmissionWebhook\n</code></pre> <p>\u548c </p> <pre><code>ValidatingAdmissionWebhook\n</code></pre> <p>\u8fd9\u4e24\u4e2a\u63a7\u5236\u5668\uff0c\u7531\u4e8e\u6211\u8fd9\u91cc\u96c6\u7fa4\u4f7f\u7528\u7684\u662f kubeadm \u642d\u5efa\u7684\uff0c\u53ef\u4ee5\u901a\u8fc7\u67e5\u770b apiserver Pod \u7684\u914d\u7f6e\uff1a</p> <pre><code>$ kubectl get pods kube-apiserver-ydzs-master -n kube-system -o yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  labels:\n    component: kube-apiserver\n    tier: control-plane\n  name: kube-apiserver-ydzs-master\n  namespace: kube-system\n......\nspec:\n  containers:\n  - command:\n    - kube-apiserver\n    - --advertise-address=111\n    - --allow-privileged=true\n    - --authorization-mode=Node,RBAC\n    - --client-ca-file=/etc/kubernetes/pki/ca.crt\n    - --enable-admission-plugins=NodeRestriction,MutatingAdmissionWebhook,ValidatingAdmissionWebhook\n......\n</code></pre> <p>\u4e0a\u9762\u7684 </p> <pre><code>enable-admission-plugins\n</code></pre> <p>\u53c2\u6570\u4e2d\u5e26\u4e0a\u4e86 </p> <pre><code>MutatingAdmissionWebhook\n</code></pre> <p>\u548c</p> <pre><code>ValidatingAdmissionWebhook\n</code></pre> <p>\u4e24\u4e2a\u51c6\u5165\u63a7\u5236\u63d2\u4ef6\uff0c\u5982\u679c\u6ca1\u6709\u7684\uff08\u5f53\u524d v1.16.2 \u7248\u672c\u9ed8\u8ba4\u5df2\u7ecf\u5f00\u542f\uff09\uff0c\u9700\u8981\u6dfb\u52a0\u4e0a\u8fd9\u4e24\u4e2a\u53c2\u6570\uff0c\u7136\u540e\u91cd\u542f apiserver\u3002</p> <p>\u7136\u540e\u901a\u8fc7\u8fd0\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u68c0\u67e5\u96c6\u7fa4\u4e2d\u662f\u5426\u542f\u7528\u4e86\u51c6\u5165\u6ce8\u518c API\uff1a</p> <pre><code>$ kubectl api-versions |grep admission\n\nadmissionregistration.k8s.io/v1beta1\n</code></pre>"},{"location":"kubernetes_security/admission/#webhook","title":"\u7f16\u5199 webhook","text":"<p>\u6ee1\u8db3\u4e86\u524d\u9762\u7684\u5148\u51b3\u6761\u4ef6\u540e\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u5b9e\u73b0\u4e00\u4e2a webhook \u793a\u4f8b\uff0c\u901a\u8fc7\u76d1\u542c\u4e24\u4e2a\u4e0d\u540c\u7684 HTTP \u7aef\u70b9\uff08validate \u548c mutate\uff09\u6765\u8fdb\u884c <code>validating</code> \u548c <code>mutating webhook</code> \u9a8c\u8bc1\u3002</p> <p>\u8fd9\u4e2a webhook \u7684\u5b8c\u6574\u4ee3\u7801\u53ef\u4ee5\u5728 Github \u4e0a\u83b7\u53d6\uff1ahttps://github.com/cnych/admission-webhook-example\uff0c\u8be5\u4ed3\u5e93 Fork \u81ea\u9879\u76ee https://github.com/banzaicloud/admission-webhook-example\u3002\u8fd9\u4e2a webhook \u662f\u4e00\u4e2a\u7b80\u5355\u7684\u5e26 TLS \u8ba4\u8bc1\u7684 HTTP \u670d\u52a1\uff0c\u7528 Deployment \u65b9\u5f0f\u90e8\u7f72\u5728\u6211\u4eec\u7684\u96c6\u7fa4\u4e2d\u3002</p> <p>\u4ee3\u7801\u4e2d\u4e3b\u8981\u7684\u903b\u8f91\u5728\u4e24\u4e2a\u6587\u4ef6\u4e2d\uff1a<code>main.go</code> \u548c <code>webhook.go</code>\uff0cmain.go \u6587\u4ef6\u5305\u542b\u521b\u5efa HTTP \u670d\u52a1\u7684\u4ee3\u7801\uff0c\u800cwebhook.go \u5305\u542b validates \u548c mutates \u4e24\u4e2a webhook \u7684\u903b\u8f91\uff0c\u5927\u90e8\u5206\u4ee3\u7801\u90fd\u6bd4\u8f83\u7b80\u5355\uff0c\u9996\u5148\u67e5\u770b main.go \u6587\u4ef6\uff0c\u67e5\u770b\u5982\u4f55\u4f7f\u7528\u6807\u51c6 golang \u5305\u6765\u542f\u52a8 HTTP \u670d\u52a1\uff0c\u4ee5\u53ca\u5982\u4f55\u4ece\u547d\u4ee4\u884c\u6807\u5fd7\u4e2d\u8bfb\u53d6 TLS \u914d\u7f6e\u7684\u8bc1\u4e66\uff1a</p> <pre><code>flag.StringVar(&amp;parameters.certFile, \"tlsCertFile\", \"/etc/webhook/certs/cert.pem\", \"File containing the x509 Certificate for HTTPS.\")\nflag.StringVar(&amp;parameters.keyFile, \"tlsKeyFile\", \"/etc/webhook/certs/key.pem\", \"File containing the x509 private key to --tlsCertFile.\")\n</code></pre> <p>\u7136\u540e\u4e00\u4e2a\u6bd4\u8f83\u91cd\u8981\u7684\u662f serve \u51fd\u6570\uff0c\u7528\u6765\u5904\u7406\u4f20\u5165\u7684 mutate \u548c validating \u51fd\u6570 \u7684 HTTP \u8bf7\u6c42\u3002\u8be5\u51fd\u6570\u4ece\u8bf7\u6c42\u4e2d\u53cd\u5e8f\u5217\u5316 <code>AdmissionReview</code> \u5bf9\u8c61\uff0c\u6267\u884c\u4e00\u4e9b\u57fa\u672c\u7684\u5185\u5bb9\u6821\u9a8c\uff0c\u6839\u636e URL \u8def\u5f84\u8c03\u7528\u76f8\u5e94\u7684 mutate \u548c validate \u51fd\u6570\uff0c\u7136\u540e\u5e8f\u5217\u5316 AdmissionReview \u5bf9\u8c61\uff1a</p> <pre><code>func (whsvr *WebhookServer) serve(w http.ResponseWriter, r *http.Request) {\n    var body []byte\n    if r.Body != nil {\n        if data, err := ioutil.ReadAll(r.Body); err == nil {\n            body = data\n        }\n    }\n    if len(body) == 0 {\n        glog.Error(\"empty body\")\n        http.Error(w, \"empty body\", http.StatusBadRequest)\n        return\n    }\n\n    // \u6821\u9a8c Content-Type\n    contentType := r.Header.Get(\"Content-Type\")\n    if contentType != \"application/json\" {\n        glog.Errorf(\"Content-Type=%s, expect application/json\", contentType)\n        http.Error(w, \"invalid Content-Type, expect `application/json`\", http.StatusUnsupportedMediaType)\n        return\n    }\n\n    var admissionResponse *v1betaAdmissionResponse\n    ar := v1betaAdmissionReview{}\n    if _, _, err := deserializer.Decode(body, nil, &amp;ar); err != nil {\n        glog.Errorf(\"Can't decode body: %v\", err)\n        admissionResponse = &amp;v1betaAdmissionResponse{\n            Result: &amp;metavStatus{\n                Message: err.Error(),\n            },\n        }\n    } else {\n        fmt.Println(r.URL.Path)\n        if r.URL.Path == \"/mutate\" {\n            admissionResponse = whsvr.mutate(&amp;ar)\n        } else if r.URL.Path == \"/validate\" {\n            admissionResponse = whsvr.validate(&amp;ar)\n        }\n    }\n\n    admissionReview := v1betaAdmissionReview{}\n    if admissionResponse != nil {\n        admissionReview.Response = admissionResponse\n        if ar.Request != nil {\n            admissionReview.Response.UID = ar.Request.UID\n        }\n    }\n\n    resp, err := json.Marshal(admissionReview)\n    if err != nil {\n        glog.Errorf(\"Can't encode response: %v\", err)\n        http.Error(w, fmt.Sprintf(\"could not encode response: %v\", err), http.StatusInternalServerError)\n    }\n    glog.Infof(\"Ready to write reponse ...\")\n    if _, err := w.Write(resp); err != nil {\n        glog.Errorf(\"Can't write response: %v\", err)\n        http.Error(w, fmt.Sprintf(\"could not write response: %v\", err), http.StatusInternalServerError)\n    }\n}\n</code></pre> <p>\u4e3b\u8981\u7684\u51c6\u5165\u903b\u8f91\u662f validate \u548c mutate \u4e24\u4e2a\u51fd\u6570\u3002validate \u51fd\u6570\u68c0\u67e5\u8d44\u6e90\u5bf9\u8c61\u662f\u5426\u9700\u8981\u6821\u9a8c\uff1a\u4e0d\u9a8c\u8bc1 kube-system \u548c kube-public \u4e24\u4e2a\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u8d44\u6e90\uff0c\u5982\u679c\u60f3\u8981\u663e\u793a\u7684\u58f0\u660e\u4e0d\u9a8c\u8bc1\u67d0\u4e2a\u8d44\u6e90\uff0c\u53ef\u4ee5\u901a\u8fc7\u5728\u8d44\u6e90\u5bf9\u8c61\u4e2d\u6dfb\u52a0\u4e00\u4e2a </p> <pre><code>admission-webhook-example.qikqiak.com/validate=false\n</code></pre> <p>\u7684 annotation \u8fdb\u884c\u58f0\u660e\u3002\u5982\u679c\u9700\u8981\u9a8c\u8bc1\uff0c\u5219\u6839\u636e\u8d44\u6e90\u7c7b\u578b\u7684 kind\uff0c\u548c\u6807\u7b7e\u4e0e\u5176\u5bf9\u5e94\u9879\u8fdb\u884c\u6bd4\u8f83\uff0c\u5c06 service \u6216\u8005 deployment \u8d44\u6e90\u4ece\u8bf7\u6c42\u4e2d\u53cd\u5e8f\u5217\u5316\u51fa\u6765\u3002\u5982\u679c\u7f3a\u5c11\u67d0\u4e9b label \u6807\u7b7e\uff0c\u5219\u54cd\u5e94\u4e2d\u7684 Allowed \u4f1a\u88ab\u8bbe\u7f6e\u4e3a false\u3002\u5982\u679c\u9a8c\u8bc1\u5931\u8d25\uff0c\u5219\u4f1a\u5728\u54cd\u5e94\u4e2d\u5199\u5165\u5931\u8d25\u539f\u56e0\uff0c\u6700\u7ec8\u7528\u6237\u5728\u5c1d\u8bd5\u521b\u5efa\u8d44\u6e90\u65f6\u4f1a\u6536\u5230\u5931\u8d25\u7684\u4fe1\u606f\u3002validate \u51fd\u6570\u5b9e\u73b0\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>// validate deployments and services\nfunc (whsvr *WebhookServer) validate(ar *v1betaAdmissionReview) *v1betaAdmissionResponse {\n    req := ar.Request\n    var (\n        availableLabels                 map[string]string\n        objectMeta                      *metavObjectMeta\n        resourceNamespace, resourceName string\n    )\n\n    glog.Infof(\"AdmissionReview for Kind=%v, Namespace=%v Name=%v (%v) UID=%v patchOperation=%v UserInfo=%v\",\n        req.Kind, req.Namespace, req.Name, resourceName, req.UID, req.Operation, req.UserInfo)\n\n    switch req.Kind.Kind {\n    case \"Deployment\":\n        var deployment appsvDeployment\n        if err := json.Unmarshal(req.Object.Raw, &amp;deployment); err != nil {\n            glog.Errorf(\"Could not unmarshal raw object: %v\", err)\n            return &amp;v1betaAdmissionResponse{\n                Result: &amp;metavStatus{\n                    Message: err.Error(),\n                },\n            }\n        }\n        resourceName, resourceNamespace, objectMeta = deployment.Name, deployment.Namespace, &amp;deployment.ObjectMeta\n        availableLabels = deployment.Labels\n    case \"Service\":\n        var service corevService\n        if err := json.Unmarshal(req.Object.Raw, &amp;service); err != nil {\n            glog.Errorf(\"Could not unmarshal raw object: %v\", err)\n            return &amp;v1betaAdmissionResponse{\n                Result: &amp;metavStatus{\n                    Message: err.Error(),\n                },\n            }\n        }\n        resourceName, resourceNamespace, objectMeta = service.Name, service.Namespace, &amp;service.ObjectMeta\n        availableLabels = service.Labels\n    }\n\n    if !validationRequired(ignoredNamespaces, objectMeta) {\n        glog.Infof(\"Skipping validation for %s/%s due to policy check\", resourceNamespace, resourceName)\n        return &amp;v1betaAdmissionResponse{\n            Allowed: true,\n        }\n    }\n\n    allowed := true\n    var result *metavStatus\n    glog.Info(\"available labels:\", availableLabels)\n    glog.Info(\"required labels\", requiredLabels)\n    for _, rl := range requiredLabels {\n        if _, ok := availableLabels[rl]; !ok {\n            allowed = false\n            result = &amp;metavStatus{\n                Reason: \"required labels are not set\",\n            }\n            break\n        }\n    }\n\n    return &amp;v1betaAdmissionResponse{\n        Allowed: allowed,\n        Result:  result,\n    }\n}\n</code></pre> <p>\u5224\u65ad\u662f\u5426\u9700\u8981\u8fdb\u884c\u6821\u9a8c\u7684\u65b9\u6cd5\u5982\u4e0b\uff0c\u53ef\u4ee5\u901a\u8fc7 namespace \u8fdb\u884c\u5ffd\u7565\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7 annotations \u8bbe\u7f6e\u8fdb\u884c\u914d\u7f6e\uff1a</p> <pre><code>func validationRequired(ignoredList []string, metadata *metavObjectMeta) bool {\n    required := admissionRequired(ignoredList, admissionWebhookAnnotationValidateKey, metadata)\n    glog.Infof(\"Validation policy for %v/%v: required:%v\", metadata.Namespace, metadata.Name, required)\n    return required\n}\n\nfunc admissionRequired(ignoredList []string, admissionAnnotationKey string, metadata *metavObjectMeta) bool {\n    // skip special kubernetes system namespaces\n    for _, namespace := range ignoredList {\n        if metadata.Namespace == namespace {\n            glog.Infof(\"Skip validation for %v for it's in special namespace:%v\", metadata.Name, metadata.Namespace)\n            return false\n        }\n    }\n\n    annotations := metadata.GetAnnotations()\n    if annotations == nil {\n        annotations = map[string]string{}\n    }\n\n    var required bool\n    switch strings.ToLower(annotations[admissionAnnotationKey]) {\n    default:\n        required = true\n    case \"n\", \"no\", \"false\", \"off\":\n        required = false\n    }\n    return required\n}\n</code></pre> <p>mutate \u51fd\u6570\u7684\u4ee3\u7801\u662f\u975e\u5e38\u7c7b\u4f3c\u7684\uff0c\u4f46\u4e0d\u662f\u4ec5\u4ec5\u6bd4\u8f83\u6807\u7b7e\u5e76\u5728\u54cd\u5e94\u4e2d\u8bbe\u7f6e Allowed\uff0c\u800c\u662f\u521b\u5efa\u4e00\u4e2a\u8865\u4e01\uff0c\u5c06\u7f3a\u5931\u7684\u6807\u7b7e\u6dfb\u52a0\u5230\u8d44\u6e90\u4e2d\uff0c\u5e76\u5c06 not_available \u8bbe\u7f6e\u4e3a\u6807\u7b7e\u7684\u503c\u3002</p> <pre><code>// main mutation process\nfunc (whsvr *WebhookServer) mutate(ar *v1betaAdmissionReview) *v1betaAdmissionResponse {\n    req := ar.Request\n    var (\n        availableLabels, availableAnnotations map[string]string\n        objectMeta                            *metavObjectMeta\n        resourceNamespace, resourceName       string\n    )\n\n    glog.Infof(\"AdmissionReview for Kind=%v, Namespace=%v Name=%v (%v) UID=%v patchOperation=%v UserInfo=%v\",\n        req.Kind, req.Namespace, req.Name, resourceName, req.UID, req.Operation, req.UserInfo)\n\n    switch req.Kind.Kind {\n    case \"Deployment\":\n        var deployment appsvDeployment\n        if err := json.Unmarshal(req.Object.Raw, &amp;deployment); err != nil {\n            glog.Errorf(\"Could not unmarshal raw object: %v\", err)\n            return &amp;v1betaAdmissionResponse{\n                Result: &amp;metavStatus{\n                    Message: err.Error(),\n                },\n            }\n        }\n        resourceName, resourceNamespace, objectMeta = deployment.Name, deployment.Namespace, &amp;deployment.ObjectMeta\n        availableLabels = deployment.Labels\n    case \"Service\":\n        var service corevService\n        if err := json.Unmarshal(req.Object.Raw, &amp;service); err != nil {\n            glog.Errorf(\"Could not unmarshal raw object: %v\", err)\n            return &amp;v1betaAdmissionResponse{\n                Result: &amp;metavStatus{\n                    Message: err.Error(),\n                },\n            }\n        }\n        resourceName, resourceNamespace, objectMeta = service.Name, service.Namespace, &amp;service.ObjectMeta\n        availableLabels = service.Labels\n    }\n\n    if !mutationRequired(ignoredNamespaces, objectMeta) {\n        glog.Infof(\"Skipping validation for %s/%s due to policy check\", resourceNamespace, resourceName)\n        return &amp;v1betaAdmissionResponse{\n            Allowed: true,\n        }\n    }\n\n    annotations := map[string]string{admissionWebhookAnnotationStatusKey: \"mutated\"}\n    patchBytes, err := createPatch(availableAnnotations, annotations, availableLabels, addLabels)\n    if err != nil {\n        return &amp;v1betaAdmissionResponse{\n            Result: &amp;metavStatus{\n                Message: err.Error(),\n            },\n        }\n    }\n\n    glog.Infof(\"AdmissionResponse: patch=%v\\\\n\", string(patchBytes))\n    return &amp;v1betaAdmissionResponse{\n        Allowed: true,\n        Patch:   patchBytes,\n        PatchType: func() *v1betaPatchType {\n            pt := v1betaPatchTypeJSONPatch\n            return &amp;pt\n        }(),\n    }\n}\n</code></pre>"},{"location":"kubernetes_security/admission/#_2","title":"\u6784\u5efa","text":"<p>\u5176\u5b9e\u6211\u4eec\u5df2\u7ecf\u5c06\u4ee3\u7801\u6253\u5305\u6210\u4e00\u4e2a docker \u955c\u50cf\u4e86\uff0c\u4f60\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\uff0c\u955c\u50cf\u4ed3\u5e93\u5730\u5740\u4e3a\uff1a</p> <pre><code>cnych/admission-webhook-example:v1\n</code></pre> <p>\u3002\u5f53\u7136\u5982\u679c\u4f60\u5e0c\u671b\u66f4\u6539\u90e8\u5206\u4ee3\u7801\uff0c\u90a3\u5c31\u9700\u8981\u91cd\u65b0\u6784\u5efa\u9879\u76ee\u4e86\uff0c\u7531\u4e8e\u8fd9\u4e2a\u9879\u76ee\u91c7\u7528 go \u8bed\u8a00\u5f00\u53d1\uff0c\u5305\u7ba1\u7406\u5de5\u5177\u66f4\u6539\u4e3a\u4e86 <code>go mod</code>\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u786e\u4fdd\u6784\u5efa\u73af\u5883\u63d0\u524d\u5b89\u88c5\u597d go \u73af\u5883\uff0c\u5f53\u7136 docker \u4e5f\u662f\u5fc5\u4e0d\u53ef\u5c11\u7684\uff0c\u56e0\u4e3a\u6211\u4eec\u9700\u8981\u7684\u662f\u6253\u5305\u6210\u4e00\u4e2a docker \u955c\u50cf\u3002</p> <p>\u83b7\u53d6\u9879\u76ee\uff1a</p> <pre><code>$ mkdir admission-webhook &amp;&amp; cd admission-webhook\n$ git clone https://github.com/cnych/admission-webhook-example.git\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4ee3\u7801\u6839\u76ee\u5f55\u4e0b\u9762\u6709\u4e00\u4e2a build \u7684\u811a\u672c\uff0c\u53ea\u9700\u8981\u63d0\u4f9b\u6211\u4eec\u81ea\u5df1\u7684 docker \u955c\u50cf\u7528\u6237\u540d\u7136\u540e\u76f4\u63a5\u6784\u5efa\u5373\u53ef\uff1a</p> <pre><code>$ export DOCKER_USER=cnych\n$ ./build\n</code></pre>"},{"location":"kubernetes_security/admission/#_3","title":"\u90e8\u7f72","text":"<p>\u4e3a\u4e86\u90e8\u7f72 webhook server\uff0c\u6211\u4eec\u9700\u8981\u5728\u6211\u4eec\u7684 Kubernetes \u96c6\u7fa4\u4e2d\u521b\u5efa\u4e00\u4e2a service \u548c deployment \u8d44\u6e90\u5bf9\u8c61\uff0c\u90e8\u7f72\u662f\u975e\u5e38\u7b80\u5355\u7684\uff0c\u53ea\u662f\u9700\u8981\u914d\u7f6e\u670d\u52a1\u7684 TLS \u914d\u7f6e\u3002\u6211\u4eec\u53ef\u4ee5\u5728\u4ee3\u7801\u6839\u76ee\u5f55\u4e0b\u9762\u7684 deployment \u6587\u4ef6\u5939\u4e0b\u9762\u67e5\u770b<code>deployment.yaml</code> \u6587\u4ef6\u4e2d\u5173\u4e8e\u8bc1\u4e66\u7684\u914d\u7f6e\u58f0\u660e\uff0c\u4f1a\u53d1\u73b0\u4ece\u547d\u4ee4\u884c\u53c2\u6570\u4e2d\u8bfb\u53d6\u7684\u8bc1\u4e66\u548c\u79c1\u94a5\u6587\u4ef6\u662f\u901a\u8fc7\u4e00\u4e2a secret \u5bf9\u8c61\u6302\u8f7d\u8fdb\u6765\u7684\uff1a</p> <pre><code>args:\n    - -tlsCertFile=/etc/webhook/certs/cert.pem\n    - -tlsKeyFile=/etc/webhook/certs/key.pem\n[...]\n    volumeMounts:\n    - name: webhook-certs\n        mountPath: /etc/webhook/certs\n        readOnly: true\nvolumes:\n- name: webhook-certs\n  secret:\n  secretName: admission-webhook-example-certs\n</code></pre> <p>\u5728\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u5bf9\u4e8e TLS \u8bc1\u4e66\uff08\u7279\u522b\u662f\u79c1\u94a5\uff09\u7684\u5904\u7406\u662f\u975e\u5e38\u91cd\u8981\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u7c7b\u4f3c\u4e8e <code>cert-manager</code> \u4e4b\u7c7b\u7684\u5de5\u5177\u6765\u81ea\u52a8\u5904\u7406 TLS \u8bc1\u4e66\uff0c\u6216\u8005\u5c06\u79c1\u94a5\u5bc6\u94a5\u5b58\u50a8\u5728 Vault \u4e2d\uff0c\u800c\u4e0d\u662f\u76f4\u63a5\u5b58\u5728 secret \u8d44\u6e90\u5bf9\u8c61\u4e2d\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4efb\u4f55\u7c7b\u578b\u7684\u8bc1\u4e66\uff0c\u4f46\u662f\u9700\u8981\u6ce8\u610f\u7684\u662f\u6211\u4eec\u8fd9\u91cc\u8bbe\u7f6e\u7684 CA \u8bc1\u4e66\u662f\u9700\u8981\u8ba9 apiserver \u80fd\u591f\u9a8c\u8bc1\u7684\uff0c\u6211\u4eec\u8fd9\u91cc\u53ef\u4ee5\u91cd\u7528 Istio \u9879\u76ee\u4e2d\u7684\u751f\u6210\u7684\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42\u811a\u672c\u3002\u901a\u8fc7\u53d1\u9001\u8bf7\u6c42\u5230 apiserver\uff0c\u83b7\u53d6\u8ba4\u8bc1\u4fe1\u606f\uff0c\u7136\u540e\u4f7f\u7528\u83b7\u5f97\u7684\u7ed3\u679c\u6765\u521b\u5efa\u9700\u8981\u7684 secret \u5bf9\u8c61\u3002</p> <p>\u9996\u5148\uff0c\u8fd0\u884c\u8be5\u811a\u672c\u68c0\u67e5 secret \u5bf9\u8c61\u4e2d\u662f\u5426\u6709\u8bc1\u4e66\u548c\u79c1\u94a5\u4fe1\u606f\uff1a</p> <pre><code>$ ./deployment/webhook-create-signed-cert.sh\ncreating certs in tmpdir /var/folders/x3/wjy_1z155pdf8jg_jgpmf6kc0000gn/T/tmp.IboFfX97 \nGenerating RSA private key, 2048 bit long modulus (2 primes)\n..................+++++\n........+++++\ne is 65537 (0x010001)\ncertificatesigningrequest.certificates.k8s.io/admission-webhook-example-svc.default created\nNAME                                    AGE   REQUESTOR          CONDITION\nadmission-webhook-example-svc.default   1s    kubernetes-admin   Pending\ncertificatesigningrequest.certificates.k8s.io/admission-webhook-example-svc.default approved\nsecret/admission-webhook-example-certs created\n$ kubectl get secret admission-webhook-example-certs\nNAME                              TYPE     DATA   AGE\nadmission-webhook-example-certs   Opaque   2      28s\n</code></pre> <p>\u4e00\u65e6 secret \u5bf9\u8c61\u521b\u5efa\u6210\u529f\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u521b\u5efa deployment \u548c service \u5bf9\u8c61\u3002</p> <pre><code>$ kubectl apply -f deployment/rbac.yaml\n$ kubectl apply -f deployment/deployment.yaml\ndeployment.apps \"admission-webhook-example-deployment\" created\n$ kubectl apply -f deployment/service.yaml\nservice \"admission-webhook-example-svc\" created\n</code></pre>"},{"location":"kubernetes_security/admission/#webhook_1","title":"\u914d\u7f6e webhook","text":"<p>\u73b0\u5728\u6211\u4eec\u7684 webhook \u670d\u52a1\u8fd0\u884c\u8d77\u6765\u4e86\uff0c\u5b83\u53ef\u4ee5\u63a5\u6536\u6765\u81ea apiserver \u7684\u8bf7\u6c42\u3002\u4f46\u662f\u6211\u4eec\u8fd8\u9700\u8981\u5728 kubernetes \u4e0a\u521b\u5efa\u4e00\u4e9b\u914d\u7f6e\u8d44\u6e90\u3002\u9996\u5148\u6765\u914d\u7f6e validating \u8fd9\u4e2a webhook\uff0c\u67e5\u770b webhook \u914d\u7f6e\uff0c\u6211\u4eec\u4f1a\u6ce8\u610f\u5230\u5b83\u91cc\u9762\u5305\u542b\u4e00\u4e2a <code>CA_BUNDLE</code> \u7684\u5360\u4f4d\u7b26\uff1a</p> <pre><code>clientConfig:\n  service:\n        name: admission-webhook-example-svc\n        namespace: default\n        path: \"/validate\"\n    caBundle: ${CA_BUNDLE}\n</code></pre> <p>CA \u8bc1\u4e66\u5e94\u63d0\u4f9b\u7ed9 admission webhook \u914d\u7f6e\uff0c\u8fd9\u6837 apiserver \u624d\u53ef\u4ee5\u4fe1\u4efb webhook server \u63d0\u4f9b\u7684 TLS \u8bc1\u4e66\u3002\u56e0\u4e3a\u6211\u4eec\u4e0a\u9762\u5df2\u7ecf\u4f7f\u7528 Kubernetes API \u7b7e\u7f72\u4e86\u8bc1\u4e66\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u6211\u4eec\u7684 kubeconfig \u4e2d\u7684 CA \u8bc1\u4e66\u6765\u7b80\u5316\u64cd\u4f5c\u3002\u4ee3\u7801\u4ed3\u5e93\u4e2d\u4e5f\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5c0f\u811a\u672c\u7528\u6765\u66ff\u6362 CA_BUNDLE \u8fd9\u4e2a\u5360\u4f4d\u7b26\uff0c\u521b\u5efa <code>validating webhook</code> \u4e4b\u524d\u8fd0\u884c\u8be5\u547d\u4ee4\u5373\u53ef\uff1a</p> <pre><code>$ cat ./deployment/validatingwebhook.yaml | ./deployment/webhook-patch-ca-bundle.sh &gt; ./deployment/validatingwebhook-ca-bundle.yaml\n</code></pre> <p>\u6267\u884c\u5b8c\u6210\u540e\u53ef\u4ee5\u67e5\u770b </p> <pre><code>validatingwebhook-ca-bundle.yaml\n</code></pre> <p>\u6587\u4ef6\u4e2d\u7684 <code>CA_BUNDLE</code> \u5360\u4f4d\u7b26\u7684\u503c\u662f\u5426\u5df2\u7ecf\u88ab\u66ff\u6362\u6389\u4e86\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f <code>clientConfig</code> \u91cc\u9762\u7684 path \u8def\u5f84\u662f <code>/validate</code>\uff0c\u56e0\u4e3a\u6211\u4eec\u4ee3\u7801\u5728\u662f\u5c06 validate \u548c mutate \u96c6\u6210\u5728\u4e00\u4e2a\u670d\u52a1\u4e2d\u7684\u3002</p> <p>\u7136\u540e\u5c31\u662f\u9700\u8981\u914d\u7f6e\u4e00\u4e9b RBAC \u89c4\u5219\uff0c\u6211\u4eec\u60f3\u5728 deployment \u6216 service \u521b\u5efa\u65f6\u62e6\u622a API \u8bf7\u6c42\uff0c\u6240\u4ee5 apiGroups \u548capiVersions \u5bf9\u5e94\u7684\u503c\u5206\u522b\u4e3a <code>apps/v1</code> \u5bf9\u5e94 deployment\uff0cv1 \u5bf9\u5e94 service\u3002</p> <p>webhook \u7684\u6700\u540e\u4e00\u90e8\u5206\u662f\u914d\u7f6e\u4e00\u4e2a <code>namespaceSelector</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u4e3a webhook \u5de5\u4f5c\u7684\u547d\u540d\u7a7a\u95f4\u5b9a\u4e49\u4e00\u4e2a selector\uff0c\u8fd9\u4e2a\u914d\u7f6e\u4e0d\u662f\u5fc5\u987b\u7684\uff0c\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u6dfb\u52a0\u4e86\u4e0b\u9762\u7684\u914d\u7f6e\uff1a</p> <pre><code>namespaceSelector:\n  matchLabels:\n      admission-webhook-example: enabled\n</code></pre> <p>\u5219\u6211\u4eec\u7684 webhook \u4f1a\u53ea\u9002\u7528\u4e8e\u8bbe\u7f6e\u4e86 </p> <pre><code>admission-webhook-example=enabled\n</code></pre> <p>\u6807\u7b7e\u7684 namespaces\u3002</p> <p>\u6240\u4ee5\uff0c\u9996\u5148\u9700\u8981\u5728 default \u8fd9\u4e2a namespace \u4e2d\u6dfb\u52a0\u8be5\u6807\u7b7e\uff1a</p> <pre><code>$ kubectl label namespace default admission-webhook-example=enabled\nnamespace \"default\" labeled\n</code></pre> <p>\u6700\u540e\uff0c\u521b\u5efa\u8fd9\u4e2a validating webhook \u914d\u7f6e\u5bf9\u8c61\uff0c\u8fd9\u4f1a\u52a8\u6001\u5730\u5c06 webhook \u6dfb\u52a0\u5230 webhook \u94fe\u4e0a\uff0c\u6240\u4ee5\u4e00\u65e6\u521b\u5efa\u8d44\u6e90\uff0c\u5c31\u4f1a\u62e6\u622a\u8bf7\u6c42\u7136\u540e\u8c03\u7528\u6211\u4eec\u7684 webhook \u670d\u52a1\uff1a</p> <pre><code>$ kubectl apply -f deployment/validatingwebhook-ca-bundle.yaml\nvalidatingwebhookconfiguration.admissionregistration.k8s.io \"validation-webhook-example-cfg\" created\n</code></pre>"},{"location":"kubernetes_security/admission/#_4","title":"\u6d4b\u8bd5","text":"<p>\u73b0\u5728\u8ba9\u6211\u4eec\u521b\u5efa\u4e00\u4e2a deployment \u8d44\u6e90\u6765\u9a8c\u8bc1\u4e0b\u662f\u5426\u6709\u6548\uff0c\u4ee3\u7801\u4ed3\u5e93\u4e0b\u6709\u4e00\u4e2a <code>sleep.yaml</code> \u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u76f4\u63a5\u521b\u5efa\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f deployment/sleep.yaml\nError from server (required labels are not set): error when creating \"deployment/sleep.yaml\": admission webhook \"required-labels.qikqiak.com\" denied the request: required labels are not set\n</code></pre> <p>\u6b63\u5e38\u60c5\u51b5\u4e0b\u521b\u5efa\u7684\u65f6\u5019\u4f1a\u51fa\u73b0\u4e0a\u9762\u7684\u9519\u8bef\u4fe1\u606f\uff0c\u7136\u540e\u90e8\u7f72\u53e6\u5916\u4e00\u4e2a </p> <pre><code>sleep-with-labels.yaml\n</code></pre> <p>\u7684\u8d44\u6e90\u6e05\u5355\uff1a</p> <pre><code>$ kubectl apply -f deployment/sleep-with-labels.yaml\ndeployment.apps \"sleep\" created\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u53ef\u4ee5\u6b63\u5e38\u90e8\u7f72\uff0c\u7136\u540e\u6211\u4eec\u5c06\u4e0a\u9762\u7684 deployment \u5220\u9664\uff0c\u7136\u540e\u90e8\u7f72\u53e6\u5916\u4e00\u4e2a </p> <pre><code>sleep-no-validation.yaml\n</code></pre> <p>\u8d44\u6e90\u6e05\u5355\uff0c\u8be5\u6e05\u5355\u4e2d\u4e0d\u5b58\u5728\u6240\u9700\u7684\u6807\u7b7e\uff0c\u4f46\u662f\u914d\u7f6e\u4e86 </p> <pre><code>admission-webhook-example.qikqiak.com/validate=false\n</code></pre> <p>\u8fd9\u6837\u7684 annotation\uff0c\u6240\u4ee5\u6b63\u5e38\u4e5f\u662f\u53ef\u4ee5\u6b63\u5e38\u521b\u5efa\u7684\uff1a</p> <pre><code>$ kubectl delete deployment sleep\n$ kubectl apply -f deployment/sleep-no-validation.yaml\ndeployment.apps \"sleep\" created\n</code></pre>"},{"location":"kubernetes_security/admission/#mutating_webhook","title":"\u90e8\u7f72 mutating webhook","text":"<p>\u9996\u5148\uff0c\u6211\u4eec\u5c06\u4e0a\u9762\u7684 <code>validating webhook</code> \u5220\u9664\uff0c\u9632\u6b62\u5bf9 mutating \u4ea7\u751f\u5e72\u6270\uff0c\u7136\u540e\u90e8\u7f72\u65b0\u7684\u914d\u7f6e\u3002 <code>mutating webhook</code> \u4e0e <code>validating webhook</code> \u914d\u7f6e\u57fa\u672c\u76f8\u540c\uff0c\u4f46\u662f webook server \u7684\u8def\u5f84\u662f <code>/mutate</code>\uff0c\u540c\u6837\u7684\u6211\u4eec\u4e5f\u9700\u8981\u5148\u586b\u5145\u4e0a <code>CA_BUNDLE</code> \u8fd9\u4e2a\u5360\u4f4d\u7b26\u3002</p> <pre><code>$ kubectl delete validatingwebhookconfiguration validation-webhook-example-cfg\nvalidatingwebhookconfiguration.admissionregistration.k8s.io \"validation-webhook-example-cfg\" deleted\n$ cat ./deployment/mutatingwebhook.yaml | ./deployment/webhook-patch-ca-bundle.sh &gt; ./deployment/mutatingwebhook-ca-bundle.yaml\n$ kubectl apply -f deployment/mutatingwebhook-ca-bundle.yaml\nmutatingwebhookconfiguration.admissionregistration.k8s.io \"mutating-webhook-example-cfg\" created\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u518d\u6b21\u90e8\u7f72\u4e0a\u9762\u7684 sleep \u5e94\u7528\u7a0b\u5e8f\uff0c\u7136\u540e\u67e5\u770b\u662f\u5426\u6b63\u786e\u6dfb\u52a0 label \u6807\u7b7e\uff1a</p> <pre><code>$ kubectl apply -f deployment/sleep.yaml\ndeployment.apps \"sleep\" created\n$ kubectl get deploy sleep -o yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  annotations:\n    admission-webhook-example.qikqiak.com/status: mutated\n    deployment.kubernetes.io/revision: \"1\"\n  creationTimestamp: \"2020-06-01T08:10:04Z\"\n  generation: 1\n  labels:\n    app.kubernetes.io/component: not_available\n    app.kubernetes.io/instance: not_available\n    app.kubernetes.io/managed-by: not_available\n    app.kubernetes.io/name: not_available\n    app.kubernetes.io/part-of: not_available\n    app.kubernetes.io/version: not_available\n  name: sleep\n  namespace: default\n...\n</code></pre> <p>\u6700\u540e\uff0c\u6211\u4eec\u91cd\u65b0\u521b\u5efa <code>validating webhook</code>\uff0c\u6765\u4e00\u8d77\u6d4b\u8bd5\u3002\u73b0\u5728\uff0c\u5c1d\u8bd5\u518d\u6b21\u521b\u5efa sleep \u5e94\u7528\u3002\u6b63\u5e38\u662f\u53ef\u4ee5\u521b\u5efa\u6210\u529f\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u4e0b admission-controllers \u7684\u6587\u6863\u3002</p> <p>\u51c6\u5165\u63a7\u5236\u5206\u4e24\u4e2a\u9636\u6bb5\u8fdb\u884c\uff0c\u7b2c\u4e00\u9636\u6bb5\uff0c\u8fd0\u884c <code>mutating admission</code> \u63a7\u5236\u5668\uff0c\u7b2c\u4e8c\u9636\u6bb5\u8fd0\u884c <code>validating admission</code> \u63a7\u5236\u5668\u3002</p> <p>\u6240\u4ee5 <code>mutating webhook</code> \u5728\u7b2c\u4e00\u9636\u6bb5\u6dfb\u52a0\u4e0a\u7f3a\u5931\u7684 labels \u6807\u7b7e\uff0c\u7136\u540e <code>validating webhook</code> \u5728\u7b2c\u4e8c\u9636\u6bb5\u5c31\u4e0d\u4f1a\u62d2\u7edd\u8fd9\u4e2a deployment \u4e86\uff0c\u56e0\u4e3a\u6807\u7b7e\u5df2\u7ecf\u5b58\u5728\u4e86\uff0c\u7528 <code>not_available</code> \u8bbe\u7f6e\u4ed6\u4eec\u7684\u503c\u3002</p> <pre><code>$ kubectl apply -f deployment/validatingwebhook-ca-bundle.yaml\nvalidatingwebhookconfiguration.admissionregistration.k8s.io \"validation-webhook-example-cfg\" created\n$ kubectl apply -f deployment/sleep.yaml\ndeployment.apps \"sleep\" created\n</code></pre>"},{"location":"kubernetes_security/rbac/","title":"RBAC","text":"<p>\ue3c9</p>"},{"location":"kubernetes_security/rbac/#rbac","title":"RBAC \u6743\u9650\u63a7\u5236","text":"<p>\u524d\u9762\u6211\u4eec\u5df2\u7ecf\u5b66\u4e60\u4e00\u4e9b\u5e38\u7528\u7684\u8d44\u6e90\u5bf9\u8c61\u7684\u4f7f\u7528\uff0c\u6211\u4eec\u77e5\u9053\u5bf9\u4e8e\u8d44\u6e90\u5bf9\u8c61\u7684\u64cd\u4f5c\u90fd\u662f\u901a\u8fc7 APIServer \u8fdb\u884c\u7684\uff0c\u90a3\u4e48\u96c6\u7fa4\u662f\u600e\u6837\u77e5\u9053\u6211\u4eec\u7684\u8bf7\u6c42\u5c31\u662f\u5408\u6cd5\u7684\u8bf7\u6c42\u5462\uff1f\u8fd9\u4e2a\u5c31\u9700\u8981\u4e86\u89e3 Kubernetes \u4e2d\u53e6\u5916\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u77e5\u8bc6\u70b9\u4e86\uff1a<code>RBAC</code>\uff08\u57fa\u4e8e\u89d2\u8272\u7684\u6743\u9650\u63a7\u5236\uff09\u3002</p> <p>\u7ba1\u7406\u5458\u53ef\u4ee5\u901a\u8fc7 Kubernetes API \u52a8\u6001\u914d\u7f6e\u7b56\u7565\u6765\u542f\u7528<code>RBAC</code>\uff0c\u9700\u8981\u5728 kube-apiserver \u4e2d\u6dfb\u52a0\u53c2\u6570</p> <pre><code>--authorization-mode=RBAC\n</code></pre> <p>\uff0c\u5982\u679c\u4f7f\u7528\u7684kubeadm \u5b89\u88c5\u7684\u96c6\u7fa4\u90a3\u4e48\u662f\u9ed8\u8ba4\u5f00\u542f\u4e86 <code>RBAC</code> \u7684\uff0c\u53ef\u4ee5\u901a\u8fc7\u67e5\u770b Master \u8282\u70b9\u4e0a apiserver \u7684\u9759\u6001 Pod \u5b9a\u4e49\u6587\u4ef6\uff1a</p> <pre><code>$ cat /etc/kubernetes/manifests/kube-apiserver.yaml \n...\n    - --authorization-mode=Node,RBAC\n...\n</code></pre> <p>\u5982\u679c\u662f\u4e8c\u8fdb\u5236\u7684\u65b9\u5f0f\u642d\u5efa\u7684\u96c6\u7fa4\uff0c\u6dfb\u52a0\u8fd9\u4e2a\u53c2\u6570\u8fc7\u540e\uff0c\u8bb0\u5f97\u8981\u91cd\u542f kube-apiserver \u670d\u52a1\u3002</p>"},{"location":"kubernetes_security/rbac/#api","title":"API \u5bf9\u8c61","text":"<p>\u5728\u5b66\u4e60 <code>RBAC</code> \u4e4b\u524d\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u518d\u53bb\u7406\u89e3\u4e0b Kubernetes \u96c6\u7fa4\u4e2d\u7684\u5bf9\u8c61\uff0c\u6211\u4eec\u77e5\u9053\uff0c\u5728 Kubernetes \u96c6\u7fa4\u4e2d\uff0cKubernetes \u5bf9\u8c61\u662f\u6211\u4eec\u6301\u4e45\u5316\u7684\u5b9e\u4f53\uff0c\u5c31\u662f\u6700\u7ec8\u5b58\u5165 etcd \u4e2d\u7684\u6570\u636e\uff0c\u96c6\u7fa4\u4e2d\u901a\u8fc7\u8fd9\u4e9b\u5b9e\u4f53\u6765\u8868\u793a\u6574\u4e2a\u96c6\u7fa4\u7684\u72b6\u6001\u3002\u524d\u9762\u6211\u4eec\u90fd\u76f4\u63a5\u7f16\u5199\u7684 YAML \u6587\u4ef6\uff0c\u901a\u8fc7 kubectl \u6765\u63d0\u4ea4\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff0c\u7136\u540e\u521b\u5efa\u7684\u5bf9\u5e94\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u90a3\u4e48\u5b83\u7a76\u7adf\u662f\u5982\u4f55\u5c06\u6211\u4eec\u7684 YAML \u6587\u4ef6\u8f6c\u6362\u6210\u96c6\u7fa4\u4e2d\u7684\u4e00\u4e2a API \u5bf9\u8c61\u7684\u5462\uff1f</p> <p>\u8fd9\u4e2a\u5c31\u9700\u8981\u53bb\u4e86\u89e3\u4e0b<code>\u58f0\u660e\u5f0f API</code>\u7684\u8bbe\u8ba1\uff0cKubernetes API \u662f\u4e00\u4e2a\u4ee5 JSON \u4e3a\u4e3b\u8981\u5e8f\u5217\u5316\u65b9\u5f0f\u7684 HTTP \u670d\u52a1\uff0c\u9664\u6b64\u4e4b\u5916\u4e5f\u652f\u6301 Protocol Buffers \u5e8f\u5217\u5316\u65b9\u5f0f\uff0c\u4e3b\u8981\u7528\u4e8e\u96c6\u7fa4\u5185\u90e8\u7ec4\u4ef6\u95f4\u7684\u901a\u4fe1\u3002\u4e3a\u4e86\u53ef\u6269\u5c55\u6027\uff0cKubernetes \u5728\u4e0d\u540c\u7684 API \u8def\u5f84\uff08\u6bd4\u5982<code>/api/v1</code> \u6216\u8005 <code>/apis/batch</code>\uff09\u4e0b\u9762\u652f\u6301\u4e86\u591a\u4e2a API \u7248\u672c\uff0c\u4e0d\u540c\u7684 API \u7248\u672c\u610f\u5473\u7740\u4e0d\u540c\u7ea7\u522b\u7684\u7a33\u5b9a\u6027\u548c\u652f\u6301\uff1a</p> <ul> <li>Alpha \u7ea7\u522b\uff0c\u4f8b\u5982 <code>v1alpha1</code> \u9ed8\u8ba4\u60c5\u51b5\u4e0b\u662f\u88ab\u7981\u7528\u7684\uff0c\u53ef\u4ee5\u968f\u65f6\u5220\u9664\u5bf9\u529f\u80fd\u7684\u652f\u6301\uff0c\u6240\u4ee5\u8981\u614e\u7528</li> <li>Beta \u7ea7\u522b\uff0c\u4f8b\u5982 <code>v2beta1</code> \u9ed8\u8ba4\u60c5\u51b5\u4e0b\u662f\u542f\u7528\u7684\uff0c\u8868\u793a\u4ee3\u7801\u5df2\u7ecf\u7ecf\u8fc7\u4e86\u5f88\u597d\u7684\u6d4b\u8bd5\uff0c\u4f46\u662f\u5bf9\u8c61\u7684\u8bed\u4e49\u53ef\u80fd\u4f1a\u5728\u968f\u540e\u7684\u7248\u672c\u4e2d\u4ee5\u4e0d\u517c\u5bb9\u7684\u65b9\u5f0f\u66f4\u6539</li> <li>\u7a33\u5b9a\u7ea7\u522b\uff0c\u6bd4\u5982 <code>v1</code> \u8868\u793a\u5df2\u7ecf\u662f\u7a33\u5b9a\u7248\u672c\u4e86\uff0c\u4e5f\u4f1a\u51fa\u73b0\u5728\u540e\u7eed\u7684\u5f88\u591a\u7248\u672c\u4e2d\u3002</li> </ul> <p>\u5728 Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u4e00\u4e2a API \u5bf9\u8c61\u5728 Etcd \u91cc\u7684\u5b8c\u6574\u8d44\u6e90\u8def\u5f84\uff0c\u662f\u7531\uff1a<code>Group\uff08API \u7ec4\uff09</code>\u3001<code>Version\uff08API \u7248\u672c\uff09</code>\u548c <code>Resource\uff08API \u8d44\u6e90\u7c7b\u578b\uff09</code>\u4e09\u4e2a\u90e8\u5206\u7ec4\u6210\u7684\u3002\u901a\u8fc7\u8fd9\u6837\u7684\u7ed3\u6784\uff0c\u6574\u4e2a Kubernetes \u91cc\u7684\u6240\u6709 API \u5bf9\u8c61\uff0c\u5b9e\u9645\u4e0a\u5c31\u53ef\u4ee5\u7528\u5982\u4e0b\u7684\u6811\u5f62\u7ed3\u6784\u8868\u793a\u51fa\u6765\uff1a</p> <p></p> <p>\u4ece\u4e0a\u56fe\u4e2d\u6211\u4eec\u4e5f\u53ef\u4ee5\u770b\u51fa Kubernetes \u7684 API \u5bf9\u8c61\u7684\u7ec4\u7ec7\u65b9\u5f0f\uff0c\u5728\u9876\u5c42\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6709\u4e00\u4e2a\u6838\u5fc3\u7ec4\uff08\u7531\u4e8e\u5386\u53f2\u539f\u56e0\uff0c\u662f <code>/api/v1</code> \u4e0b\u7684\u6240\u6709\u5185\u5bb9\u800c\u4e0d\u662f\u5728 <code>/apis/core/v1</code> \u4e0b\u9762\uff09\u548c\u547d\u540d\u7ec4\uff08\u8def\u5f84 <code>/apis/$NAME/$VERSION</code>\uff09\u548c\u7cfb\u7edf\u8303\u56f4\u5185\u7684\u5b9e\u4f53\uff0c\u6bd4\u5982 <code>/metrics</code>\u3002\u6211\u4eec\u4e5f\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u67e5\u770b\u96c6\u7fa4\u4e2d\u7684 API \u7ec4\u7ec7\u5f62\u5f0f\uff1a</p> <pre><code>$ kubectl get --raw /\n{\n  \"paths\": [\n    \"/api\",\n    \"/api/v1\",\n    \"/apis\",\n    \"/apis/\",\n    ......\n    \"/version\"\n  ]\n}\n</code></pre> <p>\u6bd4\u5982\u6211\u4eec\u6765\u67e5\u770b\u6279\u5904\u7406\u8fd9\u4e2a\u64cd\u4f5c\uff0c\u5728\u6211\u4eec\u5f53\u524d\u8fd9\u4e2a\u7248\u672c\u4e2d\u5b58\u5728\u4e24\u4e2a\u7248\u672c\u7684\u64cd\u4f5c\uff1a<code>/apis/batch/v1</code> \u548c <code>/apis/batch/v1beta1</code>\uff0c\u5206\u522b\u66b4\u9732\u4e86\u53ef\u4ee5\u67e5\u8be2\u548c\u64cd\u4f5c\u7684\u4e0d\u540c\u5b9e\u4f53\u96c6\u5408\uff0c\u540c\u6837\u6211\u4eec\u8fd8\u662f\u53ef\u4ee5\u901a\u8fc7 kubectl \u6765\u67e5\u8be2\u5bf9\u5e94\u5bf9\u8c61\u4e0b\u9762\u7684\u6570\u636e\uff1a</p> <pre><code>$ kubectl get --raw /apis/batch/v1 | python -m json.tool\n{\n    \"apiVersion\": \"v1\",\n    \"groupVersion\": \"batch/v1\",\n    \"kind\": \"APIResourceList\",\n    \"resources\": [\n        {\n            \"categories\": [\n                \"all\"\n            ],\n            \"kind\": \"Job\",\n            \"name\": \"jobs\",\n            \"namespaced\": true,\n            \"singularName\": \"\",\n            \"storageVersionHash\": \"mudhfqk/qZY=\",\n            \"verbs\": [\n                \"create\",\n                \"delete\",\n                \"deletecollection\",\n                \"get\",\n                \"list\",\n                \"patch\",\n                \"update\",\n                \"watch\"\n            ]\n        },\n        {\n            \"kind\": \"Job\",\n            \"name\": \"jobs/status\",\n            \"namespaced\": true,\n            \"singularName\": \"\",\n            \"verbs\": [\n                \"get\",\n                \"patch\",\n                \"update\"\n            ]\n        }\n    ]\n}\n</code></pre> <p>\u4f46\u662f\u8fd9\u4e2a\u64cd\u4f5c\u548c\u6211\u4eec\u5e73\u65f6\u64cd\u4f5c HTTP \u670d\u52a1\u7684\u65b9\u5f0f\u4e0d\u592a\u4e00\u6837\uff0c\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>kubectl proxy</code> \u547d\u4ee4\u6765\u5f00\u542f\u5bf9 apiserver \u7684\u8bbf\u95ee\uff1a</p> <pre><code>$ kubectl proxy\nStarting to serve on 11:8001\n</code></pre> <p>\u7136\u540e\u91cd\u65b0\u5f00\u542f\u4e00\u4e2a\u65b0\u7684\u7ec8\u7aef\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u65b9\u5f0f\u6765\u8bbf\u95ee\u6279\u5904\u7406\u7684 API \u670d\u52a1\uff1a</p> <pre><code>$ curl http://11:8001/apis/batch/v1\n{\n  \"kind\": \"APIResourceList\",\n  \"apiVersion\": \"v1\",\n  \"groupVersion\": \"batch/v1\",\n  \"resources\": [\n    {\n      \"name\": \"jobs\",\n      \"singularName\": \"\",\n      \"namespaced\": true,\n      \"kind\": \"Job\",\n      \"verbs\": [\n        \"create\",\n        \"delete\",\n        \"deletecollection\",\n        \"get\",\n        \"list\",\n        \"patch\",\n        \"update\",\n        \"watch\"\n      ],\n      \"categories\": [\n        \"all\"\n      ],\n      \"storageVersionHash\": \"mudhfqk/qZY=\"\n    },\n    {\n      \"name\": \"jobs/status\",\n      \"singularName\": \"\",\n      \"namespaced\": true,\n      \"kind\": \"Job\",\n      \"verbs\": [\n        \"get\",\n        \"patch\",\n        \"update\"\n      ]\n    }\n  ]\n}\n</code></pre> <p>\u540c\u6837\u4e5f\u53ef\u4ee5\u53bb\u8bbf\u95ee\u53e6\u5916\u4e00\u4e2a\u7248\u672c\u7684\u5bf9\u8c61\u6570\u636e\uff1a</p> <pre><code>$ curl http://11:8001/apis/batch/v1beta1\n......\n</code></pre> <p>\u901a\u5e38\uff0cKubernetes API \u652f\u6301\u901a\u8fc7\u6807\u51c6 HTTP <code>POST</code>\u3001<code>PUT</code>\u3001<code>DELETE</code> \u548c <code>GET</code> \u5728\u6307\u5b9a PATH \u8def\u5f84\u4e0a\u521b\u5efa\u3001\u66f4\u65b0\u3001\u5220\u9664\u548c\u68c0\u7d22\u64cd\u4f5c\uff0c\u5e76\u4f7f\u7528 JSON \u4f5c\u4e3a\u9ed8\u8ba4\u7684\u6570\u636e\u4ea4\u4e92\u683c\u5f0f\u3002</p> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u8981\u521b\u5efa\u4e00\u4e2a Deployment \u5bf9\u8c61\uff0c\u90a3\u4e48\u6211\u4eec\u7684 YAML \u6587\u4ef6\u7684\u58f0\u660e\u5c31\u9700\u8981\u600e\u4e48\u5199\uff1a</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\n</code></pre> <p>\u5176\u4e2d <code>Deployment</code> \u5c31\u662f\u8fd9\u4e2a API \u5bf9\u8c61\u7684\u8d44\u6e90\u7c7b\u578b\uff08Resource\uff09\uff0c<code>apps</code> \u5c31\u662f\u5b83\u7684\u7ec4\uff08Group\uff09\uff0c<code>v1</code> \u5c31\u662f\u5b83\u7684\u7248\u672c\uff08Version\uff09\u3002API Group\u3001Version \u548c \u8d44\u6e90\u5c31\u552f\u4e00\u5b9a\u4e49\u4e86\u4e00\u4e2a HTTP \u8def\u5f84\uff0c\u7136\u540e\u5728 kube-apiserver \u7aef\u5bf9\u8fd9\u4e2a url \u8fdb\u884c\u4e86\u76d1\u542c\uff0c\u7136\u540e\u628a\u5bf9\u5e94\u7684\u8bf7\u6c42\u4f20\u9012\u7ed9\u4e86\u5bf9\u5e94\u7684\u63a7\u5236\u5668\u8fdb\u884c\u5904\u7406\u800c\u5df2\uff0c\u5f53\u7136\u5728 Kuberentes \u4e2d\u7684\u5b9e\u73b0\u8fc7\u7a0b\u662f\u975e\u5e38\u590d\u6742\u7684\u3002</p>"},{"location":"kubernetes_security/rbac/#rbac_1","title":"RBAC","text":"<p>\u4e0a\u9762\u6211\u4eec\u4ecb\u7ecd\u4e86 Kubernetes \u6240\u6709\u8d44\u6e90\u5bf9\u8c61\u90fd\u662f\u6a21\u578b\u5316\u7684 API \u5bf9\u8c61\uff0c\u5141\u8bb8\u6267\u884c </p> <pre><code>CRUD(Create\u3001Read\u3001Update\u3001Delete)\n</code></pre> <p>\u64cd\u4f5c(\u4e5f\u5c31\u662f\u6211\u4eec\u5e38\u8bf4\u7684\u589e\u3001\u5220\u3001\u6539\u3001\u67e5\u64cd\u4f5c)\uff0c\u6bd4\u5982\u4e0b\u9762\u7684\u8fd9\u4e9b\u8d44\u6e90\uff1a</p> <ul> <li>Pods</li> <li>ConfigMaps</li> <li>Deployments</li> <li>Nodes</li> <li>Secrets</li> <li>Namespaces</li> <li>......</li> </ul> <p>\u5bf9\u4e8e\u4e0a\u9762\u8fd9\u4e9b\u8d44\u6e90\u5bf9\u8c61\u7684\u53ef\u80fd\u5b58\u5728\u7684\u64cd\u4f5c\u6709\uff1a</p> <ul> <li>create</li> <li>get</li> <li>delete</li> <li>list</li> <li>update</li> <li>edit</li> <li>watch</li> <li>exec</li> <li>patch</li> </ul> <p>\u5728\u66f4\u4e0a\u5c42\uff0c\u8fd9\u4e9b\u8d44\u6e90\u548c API Group \u8fdb\u884c\u5173\u8054\uff0c\u6bd4\u5982 Pods \u5c5e\u4e8e Core API Group\uff0c\u800c Deployements \u5c5e\u4e8e apps API Group\uff0c\u73b0\u5728\u6211\u4eec\u8981\u5728 Kubernetes \u4e2d\u901a\u8fc7 RBAC \u6765\u5bf9\u8d44\u6e90\u8fdb\u884c\u6743\u9650\u7ba1\u7406\uff0c\u9664\u4e86\u4e0a\u9762\u7684\u8fd9\u4e9b\u8d44\u6e90\u548c\u64cd\u4f5c\u4ee5\u5916\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u4e86\u89e3\u53e6\u5916\u51e0\u4e2a\u6982\u5ff5\uff1a</p> <ul> <li><code>Rule</code>\uff1a\u89c4\u5219\uff0c\u89c4\u5219\u662f\u4e00\u7ec4\u5c5e\u4e8e\u4e0d\u540c API Group \u8d44\u6e90\u4e0a\u7684\u4e00\u7ec4\u64cd\u4f5c\u7684\u96c6\u5408</li> <li><code>Role</code> \u548c <code>ClusterRole</code>\uff1a\u89d2\u8272\u548c\u96c6\u7fa4\u89d2\u8272\uff0c\u8fd9\u4e24\u4e2a\u5bf9\u8c61\u90fd\u5305\u542b\u4e0a\u9762\u7684 Rules \u5143\u7d20\uff0c\u4e8c\u8005\u7684\u533a\u522b\u5728\u4e8e\uff0c\u5728 Role \u4e2d\uff0c\u5b9a\u4e49\u7684\u89c4\u5219\u53ea\u9002\u7528\u4e8e\u5355\u4e2a\u547d\u540d\u7a7a\u95f4\uff0c\u4e5f\u5c31\u662f\u548c namespace \u5173\u8054\u7684\uff0c\u800c ClusterRole \u662f\u96c6\u7fa4\u8303\u56f4\u5185\u7684\uff0c\u56e0\u6b64\u5b9a\u4e49\u7684\u89c4\u5219\u4e0d\u53d7\u547d\u540d\u7a7a\u95f4\u7684\u7ea6\u675f\u3002\u53e6\u5916 Role \u548c ClusterRole \u5728Kubernetes \u4e2d\u90fd\u88ab\u5b9a\u4e49\u4e3a\u96c6\u7fa4\u5185\u90e8\u7684 API \u8d44\u6e90\uff0c\u548c\u6211\u4eec\u524d\u9762\u5b66\u4e60\u8fc7\u7684 Pod\u3001Deployment \u8fd9\u4e9b\u5bf9\u8c61\u7c7b\u4f3c\uff0c\u90fd\u662f\u6211\u4eec\u96c6\u7fa4\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u6240\u4ee5\u540c\u6837\u7684\u53ef\u4ee5\u4f7f\u7528 YAML \u6587\u4ef6\u6765\u63cf\u8ff0\uff0c\u7528 kubectl \u5de5\u5177\u6765\u7ba1\u7406</li> <li> <p><code>Subject</code>\uff1a\u4e3b\u9898\uff0c\u5bf9\u5e94\u96c6\u7fa4\u4e2d\u5c1d\u8bd5\u64cd\u4f5c\u7684\u5bf9\u8c61\uff0c\u96c6\u7fa4\u4e2d\u5b9a\u4e49\u4e863\u79cd\u7c7b\u578b\u7684\u4e3b\u9898\u8d44\u6e90\uff1a</p> <ul> <li><code>User Account</code>\uff1a\u7528\u6237\uff0c\u8fd9\u662f\u6709\u5916\u90e8\u72ec\u7acb\u670d\u52a1\u8fdb\u884c\u7ba1\u7406\u7684\uff0c\u7ba1\u7406\u5458\u8fdb\u884c\u79c1\u94a5\u7684\u5206\u914d\uff0c\u7528\u6237\u53ef\u4ee5\u4f7f\u7528 KeyStone \u6216\u8005 Goolge \u5e10\u53f7\uff0c\u751a\u81f3\u4e00\u4e2a\u7528\u6237\u540d\u548c\u5bc6\u7801\u7684\u6587\u4ef6\u5217\u8868\u4e5f\u53ef\u4ee5\u3002\u5bf9\u4e8e\u7528\u6237\u7684\u7ba1\u7406\u96c6\u7fa4\u5185\u90e8\u6ca1\u6709\u4e00\u4e2a\u5173\u8054\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u6240\u4ee5\u7528\u6237\u4e0d\u80fd\u901a\u8fc7\u96c6\u7fa4\u5185\u90e8\u7684 API \u6765\u8fdb\u884c\u7ba1\u7406</li> <li><code>Group</code>\uff1a\u7ec4\uff0c\u8fd9\u662f\u7528\u6765\u5173\u8054\u591a\u4e2a\u8d26\u6237\u7684\uff0c\u96c6\u7fa4\u4e2d\u6709\u4e00\u4e9b\u9ed8\u8ba4\u521b\u5efa\u7684\u7ec4\uff0c\u6bd4\u5982 cluster-admin</li> <li><code>Service Account</code>\uff1a\u670d\u52a1\u5e10\u53f7\uff0c\u901a\u8fc7 Kubernetes API \u6765\u7ba1\u7406\u7684\u4e00\u4e9b\u7528\u6237\u5e10\u53f7\uff0c\u548c namespace \u8fdb\u884c\u5173\u8054\u7684\uff0c\u9002\u7528\u4e8e\u96c6\u7fa4\u5185\u90e8\u8fd0\u884c\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u9700\u8981\u901a\u8fc7 API \u6765\u5b8c\u6210\u6743\u9650\u8ba4\u8bc1\uff0c\u6240\u4ee5\u5728\u96c6\u7fa4\u5185\u90e8\u8fdb\u884c\u6743\u9650\u64cd\u4f5c\uff0c\u6211\u4eec\u90fd\u9700\u8981\u4f7f\u7528\u5230 ServiceAccount\uff0c\u8fd9\u4e5f\u662f\u6211\u4eec\u8fd9\u8282\u8bfe\u7684\u91cd\u70b9</li> <li> <p><code>RoleBinding</code> \u548c <code>ClusterRoleBinding</code>\uff1a\u89d2\u8272\u7ed1\u5b9a\u548c\u96c6\u7fa4\u89d2\u8272\u7ed1\u5b9a\uff0c\u7b80\u5355\u6765\u8bf4\u5c31\u662f\u628a\u58f0\u660e\u7684 Subject \u548c\u6211\u4eec\u7684 Role \u8fdb\u884c\u7ed1\u5b9a\u7684\u8fc7\u7a0b\uff08\u7ed9\u67d0\u4e2a\u7528\u6237\u7ed1\u5b9a\u4e0a\u64cd\u4f5c\u7684\u6743\u9650\uff09\uff0c\u4e8c\u8005\u7684\u533a\u522b\u4e5f\u662f\u4f5c\u7528\u8303\u56f4\u7684\u533a\u522b\uff1aRoleBinding \u53ea\u4f1a\u5f71\u54cd\u5230\u5f53\u524d namespace \u4e0b\u9762\u7684\u8d44\u6e90\u64cd\u4f5c\u6743\u9650\uff0c\u800c ClusterRoleBinding \u4f1a\u5f71\u54cd\u5230\u6240\u6709\u7684 namespace\u3002</p> </li> </ul> </li> </ul> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u901a\u8fc7\u51e0\u4e2a\u7b80\u5355\u7684\u793a\u4f8b\uff0c\u6765\u5b66\u4e60\u4e0b\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u5982\u4f55\u4f7f\u7528 <code>RBAC</code>\u3002</p>"},{"location":"kubernetes_security/rbac/#namespace","title":"\u53ea\u80fd\u8bbf\u95ee\u67d0\u4e2a namespace \u7684\u666e\u901a\u7528\u6237","text":"<p>\u6211\u4eec\u60f3\u8981\u521b\u5efa\u4e00\u4e2a User Account\uff0c\u53ea\u80fd\u8bbf\u95ee kube-system \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\uff0c\u5bf9\u5e94\u7684\u7528\u6237\u4fe1\u606f\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>username: cnych\ngroup: youdianzhishi\n</code></pre>"},{"location":"kubernetes_security/rbac/#_1","title":"\u521b\u5efa\u7528\u6237\u51ed\u8bc1","text":"<p>\u6211\u4eec\u524d\u9762\u5df2\u7ecf\u63d0\u5230\u8fc7\uff0cKubernetes \u6ca1\u6709 User Account \u7684 API \u5bf9\u8c61\uff0c\u4e0d\u8fc7\u8981\u521b\u5efa\u4e00\u4e2a\u7528\u6237\u5e10\u53f7\u7684\u8bdd\u4e5f\u662f\u633a\u7b80\u5355\u7684\uff0c\u5229\u7528\u7ba1\u7406\u5458\u5206\u914d\u7ed9\u4f60\u7684\u4e00\u4e2a\u79c1\u94a5\u5c31\u53ef\u4ee5\u521b\u5efa\u4e86\uff0c\u8fd9\u4e2a\u6211\u4eec\u53ef\u4ee5\u53c2\u8003\u5b98\u65b9\u6587\u6863\u4e2d\u7684\u65b9\u6cd5\uff0c\u8fd9\u91cc\u6211\u4eec\u6765\u4f7f\u7528 <code>OpenSSL</code> \u8bc1\u4e66\u6765\u521b\u5efa\u4e00\u4e2a User\uff0c\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528\u66f4\u7b80\u5355\u7684 <code>cfssl</code>\u5de5\u5177\u6765\u521b\u5efa\uff1a</p> <p>\u7ed9\u7528\u6237 cnych \u521b\u5efa\u4e00\u4e2a\u79c1\u94a5\uff0c\u547d\u540d\u6210 <code>cnych.key</code>\uff1a</p> <pre><code>$ openssl genrsa -out cnych.key 2048\nGenerating RSA private key, 2048 bit long modulus\n..............................................................................+++\n..............................................................................................................................................+++\ne is 65537 (0x10001)\n</code></pre> <p>\u4f7f\u7528\u6211\u4eec\u521a\u521a\u521b\u5efa\u7684\u79c1\u94a5\u521b\u5efa\u4e00\u4e2a\u8bc1\u4e66\u7b7e\u540d\u8bf7\u6c42\u6587\u4ef6\uff1a<code>cnych.csr</code>\uff0c\u8981\u6ce8\u610f\u9700\u8981\u786e\u4fdd\u5728<code>-subj</code>\u53c2\u6570\u4e2d\u6307\u5b9a\u7528\u6237\u540d\u548c\u7ec4(CN\u8868\u793a\u7528\u6237\u540d\uff0cO\u8868\u793a\u7ec4)\uff1a</p> <pre><code>$ openssl req -new -key cnych.key -out cnych.csr -subj \"/CN=cnych/O=youdianzhishi\"\n</code></pre> <p>\u7136\u540e\u627e\u5230\u6211\u4eec\u7684 Kubernetes \u96c6\u7fa4\u7684 <code>CA</code> \u8bc1\u4e66\uff0c\u6211\u4eec\u4f7f\u7528\u7684\u662f kubeadm \u5b89\u88c5\u7684\u96c6\u7fa4\uff0cCA \u76f8\u5173\u8bc1\u4e66\u4f4d\u4e8e <code>/etc/kubernetes/pki/</code> \u76ee\u5f55\u4e0b\u9762\uff0c\u5982\u679c\u4f60\u662f\u4e8c\u8fdb\u5236\u65b9\u5f0f\u642d\u5efa\u7684\uff0c\u4f60\u5e94\u8be5\u5728\u6700\u5f00\u59cb\u642d\u5efa\u96c6\u7fa4\u7684\u65f6\u5019\u5c31\u5df2\u7ecf\u6307\u5b9a\u597d\u4e86 CA \u7684\u76ee\u5f55\uff0c\u6211\u4eec\u4f1a\u5229\u7528\u8be5\u76ee\u5f55\u4e0b\u9762\u7684 <code>ca.crt</code> \u548c <code>ca.key</code>\u4e24\u4e2a\u6587\u4ef6\u6765\u6279\u51c6\u4e0a\u9762\u7684\u8bc1\u4e66\u8bf7\u6c42\u3002\u751f\u6210\u6700\u7ec8\u7684\u8bc1\u4e66\u6587\u4ef6\uff0c\u6211\u4eec\u8fd9\u91cc\u8bbe\u7f6e\u8bc1\u4e66\u7684\u6709\u6548\u671f\u4e3a 500 \u5929\uff1a</p> <pre><code>$ openssl x509 -req -in cnych.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out cnych.crt -days 500\nSignature ok\nsubject=/CN=cnych/O=youdianzhishi\nGetting CA Private Key\n</code></pre> <p>\u73b0\u5728\u67e5\u770b\u6211\u4eec\u5f53\u524d\u6587\u4ef6\u5939\u4e0b\u9762\u662f\u5426\u751f\u6210\u4e86\u4e00\u4e2a\u8bc1\u4e66\u6587\u4ef6\uff1a</p> <pre><code>$ ls\ncnych.crt  cnych.csr  cnych.key\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u521a\u521a\u521b\u5efa\u7684\u8bc1\u4e66\u6587\u4ef6\u548c\u79c1\u94a5\u6587\u4ef6\u5728\u96c6\u7fa4\u4e2d\u521b\u5efa\u65b0\u7684\u51ed\u8bc1\u548c\u4e0a\u4e0b\u6587(Context):</p> <pre><code>$ kubectl config set-credentials cnych --client-certificate=cnych.crt --client-key=cnych.key\nUser \"cnych\" set.\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e00\u4e2a\u7528\u6237 <code>cnych</code> \u521b\u5efa\u4e86\uff0c\u7136\u540e\u4e3a\u8fd9\u4e2a\u7528\u6237\u8bbe\u7f6e\u65b0\u7684 Context\uff0c\u6211\u4eec\u8fd9\u91cc\u6307\u5b9a\u7279\u5b9a\u7684\u4e00\u4e2a namespace\uff1a</p> <pre><code>$ kubectl config set-context cnych-context --cluster=kubernetes --namespace=kube-system --user=cnych\nContext \"cnych-context\" created.\n</code></pre> <p>\u5230\u8fd9\u91cc\uff0c\u6211\u4eec\u7684\u7528\u6237 <code>cnych</code> \u5c31\u5df2\u7ecf\u521b\u5efa\u6210\u529f\u4e86\uff0c\u73b0\u5728\u6211\u4eec\u4f7f\u7528\u5f53\u524d\u7684\u8fd9\u4e2a\u914d\u7f6e\u6587\u4ef6\u6765\u64cd\u4f5c kubectl \u547d\u4ee4\u7684\u65f6\u5019\uff0c\u5e94\u8be5\u4f1a\u51fa\u73b0\u9519\u8bef\uff0c\u56e0\u4e3a\u6211\u4eec\u8fd8\u6ca1\u6709\u4e3a\u8be5\u7528\u6237\u5b9a\u4e49\u4efb\u4f55\u64cd\u4f5c\u7684\u6743\u9650\u5462\uff1a</p> <pre><code>$ kubectl get pods --context=cnych-context\nError from server (Forbidden): pods is forbidden: User \"cnych\" cannot list resource \"pods\" in API group \"\" in the namespace \"kube-system\"\n</code></pre>"},{"location":"kubernetes_security/rbac/#_2","title":"\u521b\u5efa\u89d2\u8272","text":"<p>\u7528\u6237\u521b\u5efa\u5b8c\u6210\u540e\uff0c\u63a5\u4e0b\u6765\u5c31\u9700\u8981\u7ed9\u8be5\u7528\u6237\u6dfb\u52a0\u64cd\u4f5c\u6743\u9650\uff0c\u6211\u4eec\u6765\u5b9a\u4e49\u4e00\u4e2a YAML \u6587\u4ef6\uff0c\u521b\u5efa\u4e00\u4e2a\u5141\u8bb8\u7528\u6237\u64cd\u4f5c Deployment\u3001Pod\u3001ReplicaSets \u7684\u89d2\u8272\uff0c\u5982\u4e0b\u5b9a\u4e49\uff1a(cnych-role.yaml)</p> <pre><code>apiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  name: cnych-role\n  namespace: kube-system\nrules:\n- apiGroups: [\"\", \"apps\"]\n  resources: [\"deployments\", \"replicasets\", \"pods\"]\n  verbs: [\"get\", \"list\", \"watch\", \"create\", \"update\", \"patch\", \"delete\"] # \u4e5f\u53ef\u4ee5\u4f7f\u7528['*']\n</code></pre> <p>\u5176\u4e2d Pod \u5c5e\u4e8e <code>core</code> \u8fd9\u4e2a API Group\uff0c\u5728 YAML \u4e2d\u7528\u7a7a\u5b57\u7b26\u5c31\u53ef\u4ee5\uff0c\u800c Deployment \u548c ReplicaSet \u73b0\u5728\u90fd\u5c5e\u4e8e <code>apps</code> \u8fd9\u4e2a API Group\uff08\u5982\u679c\u4e0d\u77e5\u9053\u5219\u53ef\u4ee5\u7528 <code>kubectl explain</code> \u547d\u4ee4\u67e5\u770b\uff09\uff0c\u6240\u4ee5 <code>rules</code> \u4e0b\u9762\u7684 <code>apiGroups</code> \u5c31\u7efc\u5408\u4e86\u8fd9\u51e0\u4e2a\u8d44\u6e90\u7684 API Group\uff1a[\"\", \"apps\"]\uff0c\u5176\u4e2d<code>verbs</code> \u5c31\u662f\u6211\u4eec\u4e0a\u9762\u63d0\u5230\u7684\u53ef\u4ee5\u5bf9\u8fd9\u4e9b\u8d44\u6e90\u5bf9\u8c61\u6267\u884c\u7684\u64cd\u4f5c\uff0c\u6211\u4eec\u8fd9\u91cc\u9700\u8981\u6240\u6709\u7684\u64cd\u4f5c\u65b9\u6cd5\uff0c\u6240\u4ee5\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528[*]\u6765\u4ee3\u66ff\u3002\u7136\u540e\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a Role\uff1a</p> <pre><code>$ kubectl create -f cnych-role.yaml\nrole.rbac.authorization.k8s.io/cnych-role created\n</code></pre> <p>\u6ce8\u610f\u8fd9\u91cc\u6211\u4eec\u6ca1\u6709\u4f7f\u7528\u4e0a\u9762\u7684 <code>cnych-context</code> \u8fd9\u4e2a\u4e0a\u4e0b\u6587\uff0c\u56e0\u4e3a\u6682\u65f6\u8fd8\u6728\u6709\u6743\u9650\u3002</p>"},{"location":"kubernetes_security/rbac/#_3","title":"\u521b\u5efa\u89d2\u8272\u6743\u9650\u7ed1\u5b9a","text":"<p>Role \u521b\u5efa\u5b8c\u6210\u4e86\uff0c\u4f46\u662f\u5f88\u660e\u663e\u73b0\u5728\u6211\u4eec\u8fd9\u4e2a <code>Role</code> \u548c\u6211\u4eec\u7684\u7528\u6237 <code>cnych</code> \u8fd8\u6ca1\u6709\u4efb\u4f55\u5173\u7cfb\uff0c\u5bf9\u5427\uff1f\u8fd9\u91cc\u5c31\u9700\u8981\u521b\u5efa\u4e00\u4e2a <code>RoleBinding</code> \u5bf9\u8c61\uff0c\u5728 kube-system \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u5c06\u4e0a\u9762\u7684 <code>cnych-role</code> \u89d2\u8272\u548c\u7528\u6237 <code>cnych</code> \u8fdb\u884c\u7ed1\u5b9a\uff1a\uff08cnych-rolebinding.yaml\uff09</p> <pre><code>apiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\n  name: cnych-rolebinding\n  namespace: kube-system\nsubjects:\n- kind: User\n  name: cnych\n  apiGroup: \"\"\nroleRef:\n  kind: Role\n  name: cnych-role\n  apiGroup: rbac.authorization.k8s.io  # \u7559\u7a7a\u5b57\u7b26\u4e32\u4e5f\u53ef\u4ee5\uff0c\u5219\u4f7f\u7528\u5f53\u524d\u7684apiGroup\n</code></pre> <p>\u4e0a\u9762\u7684 YAML \u6587\u4ef6\u4e2d\u6211\u4eec\u770b\u5230\u4e86 <code>subjects</code> \u5b57\u6bb5\uff0c\u8fd9\u91cc\u5c31\u662f\u6211\u4eec\u4e0a\u9762\u63d0\u5230\u7684\u7528\u6765\u5c1d\u8bd5\u64cd\u4f5c\u96c6\u7fa4\u7684\u5bf9\u8c61\uff0c\u8fd9\u91cc\u5bf9\u5e94\u4e0a\u9762\u7684 <code>User</code> \u5e10\u53f7 <code>cnych</code>\uff0c\u4f7f\u7528kubectl \u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create -f cnych-rolebinding.yaml\nrolebinding.rbac.authorization.k8s.io/cnych-rolebinding created\n</code></pre>"},{"location":"kubernetes_security/rbac/#_4","title":"\u6d4b\u8bd5","text":"<p>\u73b0\u5728\u6211\u4eec\u5e94\u8be5\u53ef\u4ee5\u4e0a\u9762\u7684 <code>cnych-context</code> \u4e0a\u4e0b\u6587\u6765\u64cd\u4f5c\u96c6\u7fa4\u4e86\uff1a</p> <pre><code>$ kubectl get pods --context=cnych-context\nkubectl get pods --context=cnych-context\nNAME                                         READY   STATUS    RESTARTS   AGE\ncoredns-667f964f9b-pr44s                     1/1     Running   0          13d\ncoredns-667f964f9b-vh55b                     1/1     Running   1          13d\netcd-ydzs-master                             1/1     Running   0          13d\nkube-apiserver-ydzs-master                   1/1     Running   1          6d5h\nkube-controller-manager-ydzs-master          1/1     Running   3          13d\n......\n$ kubectl --context=cnych-context get rs,deploy\nNAME                                                    DESIRED   CURRENT   READY   AGE\nreplicaset.apps/coredns-667f964f9b                      2         2         2       13d\nreplicaset.apps/metrics-server-5d4dbb78bb               1         1         1       2d21h\nreplicaset.apps/metrics-server-6886856d7c               0         0         0       2d21h\nreplicaset.apps/metrics-server-6dcfdf89b5               0         0         0       2d21h\nreplicaset.apps/traefik-ingress-controller-54f665bb97   0         0         0       47h\n\nNAME                                         READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/coredns                      2/2     2            2           13d\ndeployment.apps/metrics-server               1/1     1            1           2d21h\ndeployment.apps/traefik-ingress-controller   1/1     1            1           2d6h\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u4f7f\u7528 kubectl \u7684\u4f7f\u7528\u5e76\u6ca1\u6709\u6307\u5b9a namespace\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u6211\u4eec\u4e0a\u9762\u521b\u5efa\u8fd9\u4e2a Context \u7684\u65f6\u5019\u5c31\u7ed1\u5b9a\u5728\u4e86 kube-system \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\uff0c\u5982\u679c\u6211\u4eec\u5728\u540e\u9762\u52a0\u4e0a\u4e00\u4e2a<code>-n default</code>\u8bd5\u770b\u770b\u5462\uff1f</p> <pre><code>$ kubectl --context=cnych-context get pods --namespace=default\nError from server (Forbidden): pods is forbidden: User \"cnych\" cannot list resource \"pods\" in API group \"\" in the namespace \"default\"\n</code></pre> <p>\u5982\u679c\u53bb\u83b7\u53d6\u5176\u4ed6\u7684\u8d44\u6e90\u5bf9\u8c61\u5462\uff1a</p> <pre><code>$ kubectl --context=cnych-context get svc\nError from server (Forbidden): services is forbidden: User \"cnych\" cannot list resource \"services\" in API group \"\" in the namespace \"kube-system\"\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6ca1\u6709\u6743\u9650\u83b7\u53d6\uff0c\u56e0\u4e3a\u6211\u4eec\u5e76\u6ca1\u6709\u4e3a\u5f53\u524d\u64cd\u4f5c\u7528\u6237\u6307\u5b9a\u5176\u4ed6\u5bf9\u8c61\u8d44\u6e90\u7684\u8bbf\u95ee\u6743\u9650\uff0c\u662f\u7b26\u5408\u6211\u4eec\u7684\u9884\u671f\u7684\u3002\u8fd9\u6837\u6211\u4eec\u5c31\u521b\u5efa\u4e86\u4e00\u4e2a\u53ea\u6709\u5355\u4e2a\u547d\u540d\u7a7a\u95f4\u8bbf\u95ee\u6743\u9650\u7684\u666e\u901a User \u3002</p>"},{"location":"kubernetes_security/rbac/#namespace_serviceaccount","title":"\u53ea\u80fd\u8bbf\u95ee\u67d0\u4e2a namespace \u7684 ServiceAccount","text":"<p>\u4e0a\u9762\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2a\u53ea\u80fd\u8bbf\u95ee\u67d0\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684<code>\u666e\u901a\u7528\u6237</code>\uff0c\u6211\u4eec\u524d\u9762\u4e5f\u63d0\u5230\u8fc7 <code>subjects</code> \u4e0b\u9762\u8fd8\u6709\u4e00\u79cd\u7c7b\u578b\u7684\u4e3b\u9898\u8d44\u6e90\uff1a<code>ServiceAccount</code>\uff0c\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a\u96c6\u7fa4\u5185\u90e8\u7684\u7528\u6237\u53ea\u80fd\u64cd\u4f5c kube-system \u8fd9\u4e2a\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684 pods \u548c deployments\uff0c\u9996\u5148\u6765\u521b\u5efa\u4e00\u4e2a <code>ServiceAccount</code> \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create sa cnych-sa -n kube-system\n</code></pre> <p>\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u5b9a\u4e49\u6210 YAML \u6587\u4ef6\u7684\u5f62\u5f0f\u6765\u521b\u5efa\uff1a</p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: cnych-sa\n  namespace: kube-system\n</code></pre> <p>\u7136\u540e\u65b0\u5efa\u4e00\u4e2a Role \u5bf9\u8c61\uff1a(cnych-sa-role.yaml)</p> <pre><code>apiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  name: cnych-sa-role\n  namespace: kube-system\nrules:\n- apiGroups: [\"\"]\n  resources: [\"pods\"]\n  verbs: [\"get\", \"watch\", \"list\"]\n- apiGroups: [\"apps\"]\n  resources: [\"deployments\"]\n  verbs: [\"get\", \"list\", \"watch\", \"create\", \"update\", \"patch\", \"delete\"]\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u8fd9\u91cc\u5b9a\u4e49\u7684\u89d2\u8272\u6ca1\u6709<code>\u521b\u5efa\u3001\u5220\u9664\u3001\u66f4\u65b0</code> Pod \u7684\u6743\u9650\uff0c\u5f85\u4f1a\u6211\u4eec\u53ef\u4ee5\u91cd\u70b9\u6d4b\u8bd5\u4e00\u4e0b\uff0c\u521b\u5efa\u8be5 Role \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create -f cnych-sa-role.yaml\n</code></pre> <p>\u7136\u540e\u521b\u5efa\u4e00\u4e2a <code>RoleBinding</code> \u5bf9\u8c61\uff0c\u5c06\u4e0a\u9762\u7684 <code>cnych-sa</code> \u548c\u89d2\u8272 haimaxy-sa-role \u8fdb\u884c\u7ed1\u5b9a\uff1a(haimaxy-sa-rolebinding.yaml)</p> <pre><code>kind: RoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: cnych-sa-rolebinding\n  namespace: kube-system\nsubjects:\n- kind: ServiceAccount\n  name: cnych-sa\n  namespace: kube-system\nroleRef:\n  kind: Role\n  name: cnych-sa-role\n  apiGroup: rbac.authorization.k8s.io\n</code></pre> <p>\u6dfb\u52a0\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create -f cnych-sa-rolebinding.yaml\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u600e\u4e48\u53bb\u9a8c\u8bc1\u8fd9\u4e2a ServiceAccount \u5462\uff1f\u6211\u4eec\u524d\u9762\u7684\u8bfe\u7a0b\u4e2d\u662f\u4e0d\u662f\u63d0\u5230\u8fc7\u4e00\u4e2a ServiceAccount \u4f1a\u751f\u6210\u4e00\u4e2a Secret \u5bf9\u8c61\u548c\u5b83\u8fdb\u884c\u6620\u5c04\uff0c\u8fd9\u4e2a Secret \u91cc\u9762\u5305\u542b\u4e00\u4e2a token\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528\u8fd9\u4e2a token \u53bb\u767b\u5f55 Dashboard\uff0c\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u5728 Dashboard \u4e2d\u6765\u9a8c\u8bc1\u6211\u4eec\u7684\u529f\u80fd\u662f\u5426\u7b26\u5408\u9884\u671f\u4e86\uff1a</p> <pre><code>$ kubectl get secret -n kube-system |grep cnych-sa\ncnych-sa-token-nxgqx                  kubernetes.io/service-account-token   3         47m\n$ kubectl get secret cnych-sa-token-nxgqx -o jsonpath={.data.token} -n kube-system |base64 -d\n# \u4f1a\u751f\u6210\u4e00\u4e32\u5f88\u957f\u7684base64\u540e\u7684\u5b57\u7b26\u4e32\n</code></pre> <p>\u4f7f\u7528\u8fd9\u91cc\u7684 token \u53bb Dashboard \u9875\u9762\u8fdb\u884c\u767b\u5f55\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u7684\u63d0\u793a\u4fe1\u606f\u8bf4\u6211\u4eec\u73b0\u5728\u4f7f\u7528\u7684\u8fd9\u4e2a ServiceAccount \u6ca1\u6709\u6743\u9650\u83b7\u53d6\u5f53\u524d\u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u767b\u5f55\u8fdb\u6765\u540e\u9ed8\u8ba4\u8df3\u8f6c\u5230 default \u547d\u540d\u7a7a\u95f4\uff0c\u6211\u4eec\u5207\u6362\u5230 kube-system \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u5c31\u53ef\u4ee5\u4e86\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u53ef\u4ee5\u8bbf\u95ee pod \u5217\u8868\u4e86\uff0c\u4f46\u662f\u4e5f\u4f1a\u6709\u4e00\u4e9b\u5176\u4ed6\u989d\u5916\u7684\u63d0\u793a\uff1a</p> <pre><code>events is forbidden: User system:serviceaccount:kube-system:cnych-sa cannot list events in the namespace kube-system\n</code></pre> <p>\uff0c\u8fd9\u662f\u56e0\u4e3a\u5f53\u524d\u767b\u5f55\u7528\u53ea\u88ab\u6388\u6743\u4e86\u8bbf\u95ee pod \u548c deployment \u7684\u6743\u9650\uff0c\u540c\u6837\u7684\uff0c\u8bbf\u95ee\u4e0bdeployment\u770b\u770b\u53ef\u4ee5\u4e86\u5417\uff1f</p> <p>\u540c\u6837\u7684\uff0c\u4f60\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u6c42\u6765\u5bf9\u8bbf\u95ee\u7528\u6237\u7684\u6743\u9650\u8fdb\u884c\u9650\u5236\uff0c\u53ef\u4ee5\u81ea\u5df1\u901a\u8fc7 Role \u5b9a\u4e49\u66f4\u52a0\u7ec6\u7c92\u5ea6\u7684\u6743\u9650\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u7cfb\u7edf\u5185\u7f6e\u7684\u4e00\u4e9b\u6743\u9650\u2026\u2026</p>"},{"location":"kubernetes_security/rbac/#serviceaccount","title":"\u53ef\u4ee5\u5168\u5c40\u8bbf\u95ee\u7684 ServiceAccount","text":"<p>\u521a\u521a\u6211\u4eec\u521b\u5efa\u7684 cnych-sa \u8fd9\u4e2a <code>ServiceAccount</code> \u548c\u4e00\u4e2a <code>Role</code> \u89d2\u8272\u8fdb\u884c\u7ed1\u5b9a\u7684\uff0c\u5982\u679c\u6211\u4eec\u73b0\u5728\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 ServiceAccount\uff0c\u9700\u8981\u4ed6\u64cd\u4f5c\u7684\u6743\u9650\u4f5c\u7528\u4e8e\u6240\u6709\u7684 namespace\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u9700\u8981\u4f7f\u7528\u5230 <code>ClusterRole</code> \u548c <code>ClusterRoleBinding</code> \u8fd9\u4e24\u79cd\u8d44\u6e90\u5bf9\u8c61\u4e86\u3002\u540c\u6837\uff0c\u9996\u5148\u65b0\u5efa\u4e00\u4e2a ServiceAcount \u5bf9\u8c61\uff1a(cnych-sa2.yaml)</p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: cnych-sa2\n  namespace: kube-system\n</code></pre> <p>\u521b\u5efa\uff1a</p> <pre><code>$ kubectl create -f cnych-sayaml\n</code></pre> <p>\u7136\u540e\u521b\u5efa\u4e00\u4e2a ClusterRoleBinding \u5bf9\u8c61\uff08cnych-clusterolebinding.yaml\uff09:</p> <pre><code>kind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1beta1\nmetadata:\n  name: cnych-sa2-clusterrolebinding\nsubjects:\n- kind: ServiceAccount\n  name: cnych-sa2\n  namespace: kube-system\nroleRef:\n  kind: ClusterRole\n  name: cluster-admin\n  apiGroup: rbac.authorization.k8s.io\n</code></pre> <p>\u4ece\u4e0a\u9762\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u6ca1\u6709\u4e3a\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\u58f0\u660e namespace\uff0c\u56e0\u4e3a\u8fd9\u662f\u4e00\u4e2a ClusterRoleBinding \u8d44\u6e90\u5bf9\u8c61\uff0c\u662f\u4f5c\u7528\u4e8e\u6574\u4e2a\u96c6\u7fa4\u7684\uff0c\u6211\u4eec\u4e5f\u6ca1\u6709\u5355\u72ec\u65b0\u5efa\u4e00\u4e2a ClusterRole \u5bf9\u8c61\uff0c\u800c\u662f\u4f7f\u7528\u7684 <code>cluster-admin</code> \u8fd9\u4e2a\u5bf9\u8c61\uff0c\u8fd9\u662f Kubernetes \u96c6\u7fa4\u5185\u7f6e\u7684 ClusterRole \u5bf9\u8c61\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 </p> <pre><code>kubectl get clusterrole\n</code></pre> <p>\u548c </p> <pre><code>kubectl get clusterrolebinding\n</code></pre> <p>\u67e5\u770b\u7cfb\u7edf\u5185\u7f6e\u7684\u4e00\u4e9b\u96c6\u7fa4\u89d2\u8272\u548c\u96c6\u7fa4\u89d2\u8272\u7ed1\u5b9a\uff0c\u8fd9\u91cc\u6211\u4eec\u4f7f\u7528\u7684 <code>cluster-admin</code> \u8fd9\u4e2a\u96c6\u7fa4\u89d2\u8272\u662f\u62e5\u6709\u6700\u9ad8\u6743\u9650\u7684\u96c6\u7fa4\u89d2\u8272\uff0c\u6240\u4ee5\u4e00\u822c\u9700\u8981\u8c28\u614e\u4f7f\u7528\u8be5\u96c6\u7fa4\u89d2\u8272\u3002</p> <p>\u521b\u5efa\u4e0a\u9762\u96c6\u7fa4\u89d2\u8272\u7ed1\u5b9a\u8d44\u6e90\u5bf9\u8c61\uff0c\u521b\u5efa\u5b8c\u6210\u540e\u540c\u6837\u4f7f\u7528 ServiceAccount \u5bf9\u5e94\u7684 token \u53bb\u767b\u5f55 Dashboard \u9a8c\u8bc1\u4e0b\uff1a</p> <pre><code>$ kubectl create -f cnych-clusterolebinding.yaml\n$ kubectl get secret -n kube-system |grep cnych-sa2\ncnych-sa2-token-nxgqx                  kubernetes.io/service-account-token   3         47m\n$ kubectl get secret cnych-sa2-token-nxgqx -o jsonpath={.data.token} -n kube-system |base64 -d\n# \u4f1a\u751f\u6210\u4e00\u4e32\u5f88\u957f\u7684base64\u540e\u7684\u5b57\u7b26\u4e32\n</code></pre> <p></p> <p>\u6211\u4eec\u5728\u6700\u5f00\u59cb\u63a5\u89e6\u5230 RBAC \u8ba4\u8bc1\u7684\u65f6\u5019\uff0c\u53ef\u80fd\u4e0d\u592a\u719f\u6089\uff0c\u7279\u522b\u662f\u4e0d\u77e5\u9053\u5e94\u8be5\u600e\u4e48\u53bb\u7f16\u5199 rules \u89c4\u5219\uff0c\u5927\u5bb6\u53ef\u4ee5\u53bb\u5206\u6790\u7cfb\u7edf\u81ea\u5e26\u7684 <code>clusterrole</code>\u3001<code>clusterrolebinding</code> \u8fd9\u4e9b\u8d44\u6e90\u5bf9\u8c61\u7684\u7f16\u5199\u65b9\u6cd5\uff0c\u600e\u4e48\u5206\u6790\uff1f\u8fd8\u662f\u5229\u7528 kubectl \u7684 get\u3001describe\u3001 <code>-o yaml</code> \u8fd9\u4e9b\u64cd\u4f5c\uff0c\u6240\u4ee5 kubectl \u6700\u57fa\u672c\u7684\u64cd\u4f5c\u7528\u6237\u4e00\u5b9a\u8981\u638c\u63e1\u597d\u3002</p>"},{"location":"kubernetes_security/security_context/","title":"Security Context","text":"<p>\ue3c9</p>"},{"location":"kubernetes_security/security_context/#security_context","title":"Security Context","text":"<p>Kubernetes Pod/\u5bb9\u5668\u7684\u5b89\u5168\u7ba1\u63a7</p> <p></p> <p>\u6211\u4eec\u6709\u65f6\u5019\u5728\u8fd0\u884c\u4e00\u4e2a\u5bb9\u5668\u7684\u65f6\u5019\uff0c\u53ef\u80fd\u9700\u8981\u4f7f\u7528 <code>sysctl</code> \u547d\u4ee4\u6765\u4fee\u6539\u5185\u6838\u53c2\u6570\uff0c\u6bd4\u5982 <code>net</code>\u3001<code>vm</code>\u3001<code>kernel</code> \u7b49\u53c2\u6570\uff0c\u4f46\u662f <code>systcl</code> \u9700\u8981\u5bb9\u5668\u62e5\u6709\u8d85\u7ea7\u6743\u9650\uff0c\u624d\u53ef\u4ee5\u4f7f\u7528\uff0c\u5728 Docker \u5bb9\u5668\u542f\u52a8\u7684\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u52a0\u4e0a <code>--privileged</code> \u53c2\u6570\u6765\u4f7f\u7528\u7279\u6743\u6a21\u5f0f\u3002\u90a3\u4e48\u5728 Kubernetes \u4e2d\u5e94\u8be5\u5982\u4f55\u6765\u4f7f\u7528\u5462\uff1f</p> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u5c31\u9700\u8981\u4f7f\u7528\u5230 Kubernetes \u4e2d\u7684 <code>Security Context</code>\uff0c\u4e5f\u5c31\u662f\u5e38\u8bf4\u7684\u5b89\u5168\u4e0a\u4e0b\u6587\uff0c\u4e3b\u8981\u662f\u6765\u9650\u5236\u5bb9\u5668\u975e\u6cd5\u64cd\u4f5c\u5bbf\u4e3b\u8282\u70b9\u7684\u7cfb\u7edf\u7ea7\u522b\u7684\u5185\u5bb9\uff0c\u4f7f\u5f97\u8282\u70b9\u7684\u7cfb\u7edf\u6216\u8005\u8282\u70b9\u4e0a\u5176\u4ed6\u5bb9\u5668\u7ec4\u53d7\u5230\u5f71\u54cd\u3002Kubernetes \u63d0\u4f9b\u4e86\u4e09\u79cd\u914d\u7f6e\u5b89\u5168\u4e0a\u4e0b\u6587\u7ea7\u522b\u7684\u65b9\u6cd5\uff1a</p> <ul> <li>Container-level Security Context\uff1a\u4ec5\u5e94\u7528\u5230\u6307\u5b9a\u7684\u5bb9\u5668</li> <li>Pod-level Security Context\uff1a\u5e94\u7528\u5230 Pod \u5185\u6240\u6709\u5bb9\u5668\u4ee5\u53ca Volume</li> <li>Pod Security Policies\uff08PSP\uff09\uff1a\u5e94\u7528\u5230\u96c6\u7fa4\u5185\u90e8\u6240\u6709 Pod \u4ee5\u53ca Volume</li> </ul> <p>\u6211\u4eec\u53ef\u4ee5\u7528\u5982\u4e0b\u51e0\u79cd\u65b9\u5f0f\u6765\u8bbe\u7f6e <code>Security Context</code>\uff1a</p> <ul> <li>\u8bbf\u95ee\u6743\u9650\u63a7\u5236\uff1a\u6839\u636e\u7528\u6237 ID\uff08UID\uff09\u548c\u7ec4 ID\uff08GID\uff09\u6765\u9650\u5236\u5bf9\u8d44\u6e90\uff08\u6bd4\u5982\uff1a\u6587\u4ef6\uff09\u7684\u8bbf\u95ee\u6743\u9650</li> <li>Security Enhanced Linux (SELinux)\uff1a\u4e3a\u5bf9\u8c61\u5206\u914d <code>SELinux</code> \u6807\u7b7e</li> <li>\u4ee5 privileged\uff08\u7279\u6743\uff09\u6a21\u5f0f\u8fd0\u884c</li> <li>Linux Capabilities\uff1a\u7ed9\u67d0\u4e2a\u7279\u5b9a\u7684\u8fdb\u7a0b\u8d85\u7ea7\u6743\u9650\uff0c\u800c\u4e0d\u7528\u7ed9 root \u7528\u6237\u6240\u6709\u7684 privileged \u6743\u9650</li> <li>AppArmor\uff1a\u4f7f\u7528\u7a0b\u5e8f\u6587\u4ef6\u6765\u9650\u5236\u5355\u4e2a\u7a0b\u5e8f\u7684\u6743\u9650</li> <li>Seccomp\uff1a\u8fc7\u6ee4\u5bb9\u5668\u4e2d\u8fdb\u7a0b\u7684\u7cfb\u7edf\u8c03\u7528\uff08system call\uff09</li> <li> <p>AllowPrivilegeEscalation\uff08\u5141\u8bb8\u7279\u6743\u6269\u5927\uff09\uff1a\u6b64\u9879\u914d\u7f6e\u662f\u4e00\u4e2a\u5e03\u5c14\u503c\uff0c\u5b9a\u4e49\u4e86\u4e00\u4e2a\u8fdb\u7a0b\u662f\u5426\u53ef\u4ee5\u6bd4\u5176\u7236\u8fdb\u7a0b\u83b7\u5f97\u66f4\u591a\u7684\u7279\u6743\uff0c\u76f4\u63a5\u6548\u679c\u662f\uff0c\u5bb9\u5668\u7684\u8fdb\u7a0b\u4e0a\u662f\u5426\u88ab\u8bbe\u7f6e no_new_privs \u6807\u8bb0\u3002\u5f53\u51fa\u73b0\u5982\u4e0b\u60c5\u51b5\u65f6\uff0cAllowPrivilegeEscalation \u7684\u503c\u59cb\u7ec8\u4e3a true\uff1a</p> <ul> <li>\u5bb9\u5668\u4ee5 <code>privileged</code> \u6a21\u5f0f\u8fd0\u884c</li> <li>\u5bb9\u5668\u62e5\u6709 <code>CAP_SYS_ADMIN</code> \u7684 Linux Capability</li> </ul> </li> </ul>"},{"location":"kubernetes_security/security_context/#pod_security_context","title":"\u4e3a Pod \u8bbe\u7f6e Security Context","text":"<p>\u6211\u4eec\u53ea\u9700\u8981\u5728 Pod \u5b9a\u4e49\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u4e2d\u6dfb\u52a0 <code>securityContext</code> \u5b57\u6bb5\uff0c\u5c31\u53ef\u4ee5\u4e3a Pod \u6307\u5b9a\u5b89\u5168\u4e0a\u4e0b\u6587\u76f8\u5173\u7684\u8bbe\u5b9a\uff0c\u901a\u8fc7\u8be5\u5b57\u6bb5\u6307\u5b9a\u7684\u5185\u5bb9\u5c06\u4f1a\u5bf9\u5f53\u524d Pod \u4e2d\u7684\u6240\u6709\u5bb9\u5668\u751f\u6548\u3002</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: security-context-pod-demo\nspec:\n  volumes:\n  - name: sec-ctx-vol\n    emptyDir: {}\n  securityContext:\n    runAsUser: 1000\n    runAsGroup: 3000\n    fsGroup: 2000\n  containers:\n  - name: sec-ctx-demo\n    image: busybox\n    command: [\"sh\", \"-c\", \"sleep 60m\"]\n    volumeMounts:\n    - name: sec-ctx-vol\n      mountPath: /pod/demo\n    securityContext:\n      allowPrivilegeEscalation: false\n</code></pre> <p>\u5728\u5f53\u524d\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u4e2d\u6211\u4eec\u5728 Pod \u4e0b\u9762\u6dfb\u52a0\u4e86 <code>securityContext</code> \u5b57\u6bb5\uff0c\u5176\u4e2d\uff1a</p> <ul> <li> <p><code>runAsUser</code> \u5b57\u6bb5\u6307\u5b9a\u4e86\u8be5 Pod \u4e2d\u6240\u6709\u5bb9\u5668\u7684\u8fdb\u7a0b\u90fd\u4ee5 UID 1000 \u7684\u8eab\u4efd\u8fd0\u884c\uff0c<code>runAsGroup</code> \u5b57\u6bb5\u6307\u5b9a\u4e86\u8be5 Pod \u4e2d\u6240\u6709\u5bb9\u5668\u7684\u8fdb\u7a0b\u90fd\u4ee5 GID 3000 \u7684\u8eab\u4efd\u8fd0\u884c</p> <ul> <li>\u5982\u679c\u7701\u7565\u8be5\u5b57\u6bb5\uff0c\u5bb9\u5668\u8fdb\u7a0b\u7684 GID \u4e3a <code>root(0)</code></li> <li>\u5bb9\u5668\u4e2d\u521b\u5efa\u7684\u6587\u4ef6\uff0c\u5176\u6240\u6709\u8005\u4e3a userID 1000\uff0cgroupID 3000</li> <li> <p><code>fsGroup</code> \u5b57\u6bb5\u6307\u5b9a\u4e86\u8be5 Pod \u7684 fsGroup \u4e3a 2000</p> </li> <li> <p>\u6570\u636e\u5377 \uff08\u5bf9\u5e94\u6302\u8f7d\u70b9 <code>/pod/demo</code> \u7684\u6570\u636e\u5377\u4e3a <code>sec-ctx-demo</code>\uff09 \u7684\u6240\u6709\u8005\u4ee5\u53ca\u5728\u8be5\u6570\u636e\u5377\u4e0b\u521b\u5efa\u7684\u4efb\u4f55\u6587\u4ef6\uff0c\u5176 GID \u90fd\u4e3a 2000</p> </li> </ul> </li> </ul> <p>\u4e0b\u8868\u662f\u6211\u4eec\u5e38\u7528\u7684\u4e00\u4e9b <code>securityContext</code> \u5b57\u6bb5\u8bbe\u7f6e\u5185\u5bb9\u4ecb\u7ecd\uff1a</p> <p></p> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 Pod \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f https:/www.qikqiak.com/k8strain/security/manifests/security-context-pod-demo-yaml\n$ kubectl get pods\nNAME                        READY   STATUS    RESTARTS   AGE\nsecurity-context-pod-demo   1/1     Running   0          6m45s\n</code></pre> <p>\u8fd0\u884c\u5b8c\u6210\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u9a8c\u8bc1\u4e0b\u5bb9\u5668\u4e2d\u7684\u8fdb\u7a0b\u8fd0\u884c\u7684 ownership\uff1a</p> <pre><code>$ kubectl exec security-context-pod-demo top\nMem: 7586020K used, 422948K free, 298660K shrd, 1247656K buff, 3867660K cached\nCPU:  1% usr  0% sys  0% nic 3% idle  2% io  0% irq  0% sirq\nLoad average: 30 35 35 1/956 50\n  PID  PPID USER     STAT   VSZ %VSZ CPU %CPU COMMAND\n   46     0 1000     R     1292  0   0  0 top\n    1     0 1000     S     1280  0   0  0 sleep 60m\n</code></pre> <p>\u6211\u4eec\u76f4\u63a5\u8fd0\u884c\u4e00\u4e2a <code>top</code> \u8fdb\u7a0b\uff0c\u67e5\u770b\u5bb9\u5668\u4e2d\u7684\u6240\u6709\u6b63\u5728\u6267\u884c\u7684\u8fdb\u7a0b\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230 USER ID \u90fd\u4e3a 1000\uff08<code>runAsUser</code> \u6307\u5b9a\u7684\uff09\uff0c\u7136\u540e\u67e5\u770b\u4e0b\u6302\u8f7d\u7684\u6570\u636e\u5377\u7684 ownership\uff1a</p> <pre><code>$ kubectl exec security-context-pod-demo -- ls -la /pod\ntotal 8\ndrwxr-xr-x    3 root     root          4096 Nov 26 15:44 .\ndrwxr-xr-x    1 root     root          4096 Nov 26 15:44 ..\ndrwxrwsrwx    2 root     2000             6 Nov 26 15:43 demo\n</code></pre> <p>\u56e0\u4e3a\u4e0a\u9762\u6211\u4eec\u6307\u5b9a\u4e86 <code>fsGroup=2000</code>\uff0c\u6240\u4ee5\u58f0\u660e\u6302\u8f7d\u7684\u6570\u636e\u5377 <code>/pod/demo</code> \u7684 GID \u4e5f\u53d8\u6210\u4e86 2000\u3002\u76f4\u63a5\u8c03\u7528\u5bb9\u5668\u4e2d\u7684 id \u547d\u4ee4\uff1a</p> <pre><code>$ kubectl exec security-context-pod-demo id\nuid=1000 gid=3000 groups=2000\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 gid \u4e3a 3000\uff0c\u4e0e <code>runAsGroup</code> \u5b57\u6bb5\u6240\u6307\u5b9a\u7684\u4e00\u81f4\uff0c\u5982\u679c <code>runAsGroup</code> \u5b57\u6bb5\u88ab\u7701\u7565\uff0c\u5219 gid \u53d6\u503c\u4e3a 0\uff08\u5373 root\uff09\uff0c\u6b64\u65f6\u5bb9\u5668\u4e2d\u7684\u8fdb\u7a0b\u5c06\u53ef\u4ee5\u64cd\u4f5c root Group \u7684\u6587\u4ef6\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u73b0\u5728\u60f3\u8981\u53bb\u5220\u9664\u5bb9\u5668\u4e2d\u7684 <code>/tmp</code> \u76ee\u5f55\u5c31\u6ca1\u6709\u6743\u9650\u4e86\uff0c\u56e0\u4e3a\u8be5\u76ee\u5f55\u7684\u7528\u6237\u548c\u7ec4\u90fd\u662f root\uff0c\u800c\u6211\u4eec\u5f53\u524d\u8981\u53bb\u5220\u9664\u4f7f\u7528\u7684\u8fdb\u7a0b\u7684 ID \u53f7\u5c31\u53d8\u6210\u4e86 1000:3000\uff0c\u6240\u4ee5\u6ca1\u6709\u6743\u9650\u64cd\u4f5c\uff1a</p> <pre><code>$ kubectl exec security-context-pod-demo -- ls -la /tmp\ntotal 8\ndrwxrwxrwt    2 root     root          4096 Oct 29 02:40 .\ndrwxr-xr-x    1 root     root          4096 Nov 26 15:44 ..\n$ kubectl exec security-context-pod-demo -- rm -rf /tmp\nrm: can't remove '/tmp': Permission denied\n</code></pre>"},{"location":"kubernetes_security/security_context/#security_context_1","title":"\u4e3a\u5bb9\u5668\u8bbe\u7f6e Security Context","text":"<p>\u9664\u4e86\u5728 Pod \u4e2d\u53ef\u4ee5\u8bbe\u7f6e\u5b89\u5168\u4e0a\u4e0b\u6587\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u5355\u72ec\u4e3a\u67d0\u4e2a\u5bb9\u5668\u8bbe\u7f6e\u5b89\u5168\u4e0a\u4e0b\u6587\uff0c\u540c\u6837\u4e5f\u662f\u901a\u8fc7 <code>securityContext</code> \u5b57\u6bb5\u8bbe\u7f6e\uff0c\u5f53\u8be5\u5b57\u6bb5\u7684\u914d\u7f6e\u4e0e Pod \u7ea7\u522b\u7684 securityContext \u914d\u7f6e\u76f8\u51b2\u7a81\u65f6\uff0c\u5bb9\u5668\u7ea7\u522b\u7684\u914d\u7f6e\u5c06\u8986\u76d6 Pod \u7ea7\u522b\u7684\u914d\u7f6e\u3002\u5bb9\u5668\u7ea7\u522b\u7684 securityContext \u4e0d\u5f71\u54cd Pod \u4e2d\u7684\u6570\u636e\u5377\u3002\u5982\u4e0b\u8d44\u6e90\u6e05\u5355\u6240\u793a\uff1a</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: security-context-container-demo\nspec:\n  securityContext:\n    runAsUser: 1000\n  containers:\n  - name: sec-ctx-demo\n    image: busybox\n    command: [ \"sh\", \"-c\", \"sleep 60m\" ]\n    securityContext:\n      runAsUser: 2000\n      allowPrivilegeEscalation: false\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 Pod \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f https:/www.qikqiak.com/k8strain/security/manifests/security-context-pod-demo-yaml\n$ kubectl get pods\nNAME                              READY   STATUS              RESTARTS   AGE\nsecurity-context-container-demo   1/1     Running             0          5s\n</code></pre> <p>\u540c\u6837\u6211\u4eec\u76f4\u63a5\u6267\u884c\u5bb9\u5668\u4e2d\u7684 <code>top</code> \u547d\u4ee4\uff1a</p> <pre><code>$ kubectl exec security-context-container-demo top\nMem: 4991896K used, 3016924K free, 52308K shrd, 158364K buff, 3282996K cached\nCPU:  6% usr  8% sys  6% nic 8% idle  0% io  0% irq  0% sirq\nLoad average: 12 09 12 1/848 10\n  PID  PPID USER     STAT   VSZ %VSZ CPU %CPU COMMAND\n    6     0 2000     R     1292  0   1  0 top\n    1     0 2000     S     1280  0   3  0 sleep 60m\n</code></pre> <p>\u5bb9\u5668\u7684\u8fdb\u7a0b\u4ee5 UID 2000 \u7684\u8eab\u4efd\u8fd0\u884c\uff0c\u8be5\u53d6\u503c\u7531 </p> <pre><code>spec.containers[*].securityContext.runAsUser\n</code></pre> <p>\u5bb9\u5668\u7ec4\u4e2d\u7684\u5b57\u6bb5\u5b9a\u4e49\u3002Pod \u4e2d\u5b9a\u4e49\u7684 </p> <pre><code>spec.securityContext.runAsUser\n</code></pre> <p>\u53d6\u503c 1000 \u88ab\u8986\u76d6\u3002</p>"},{"location":"kubernetes_security/security_context/#linux_capabilities","title":"\u8bbe\u7f6e Linux Capabilities","text":"<p>\u6211\u4eec\u4f7f\u7528 <code>docker run</code> \u7684\u65f6\u5019\u53ef\u4ee5\u901a\u8fc7 <code>--cap-add</code> \u548c <code>--cap-drop</code> \u547d\u4ee4\u6765\u7ed9\u5bb9\u5668\u6dfb\u52a0 <code>Linux Capabilities</code>\u3002\u90a3\u4e48\u5728 Kubernetes \u4e0b\u9762\u5982\u4f55\u6765\u8bbe\u7f6e\u5462\uff1f\u8981\u4e86\u89e3\u5982\u4f55\u8bbe\u7f6e\uff0c\u9996\u5148\u6211\u4eec\u8fd8\u662f\u9700\u8981\u4e86\u89e3\u4e0b <code>Linux Capabilities</code> \u662f\u4ec0\u4e48\uff1f</p>"},{"location":"kubernetes_security/security_context/#linux_capabilities_1","title":"Linux Capabilities","text":"<p>\u8981\u4e86\u89e3 <code>Linux Capabilities</code>\uff0c\u8fd9\u5c31\u5f97\u4ece Linux \u7684\u6743\u9650\u63a7\u5236\u53d1\u5c55\u6765\u8bf4\u660e\u3002\u5728 Linux 2.2 \u7248\u672c\u4e4b\u524d\uff0c\u5f53\u5185\u6838\u5bf9\u8fdb\u7a0b\u8fdb\u884c\u6743\u9650\u9a8c\u8bc1\u7684\u65f6\u5019\uff0cLinux \u5c06\u8fdb\u7a0b\u5212\u5206\u4e3a\u4e24\u7c7b\uff1a\u7279\u6743\u8fdb\u7a0b\uff08UID=0\uff0c\u4e5f\u5c31\u662f\u8d85\u7ea7\u7528\u6237\uff09\u548c\u975e\u7279\u6743\u8fdb\u7a0b\uff08UID!=0\uff09\uff0c\u7279\u6743\u8fdb\u7a0b\u62e5\u6709\u6240\u6709\u7684\u5185\u6838\u6743\u9650\uff0c\u800c\u975e\u7279\u6743\u8fdb\u7a0b\u5219\u6839\u636e\u8fdb\u7a0b\u51ed\u8bc1\uff08effective UID, effective GID\uff0csupplementary group \u7b49\uff09\u8fdb\u884c\u6743\u9650\u68c0\u67e5\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u4ee5\u5e38\u7528\u7684 <code>passwd</code> \u547d\u4ee4\u4e3a\u4f8b\uff0c\u4fee\u6539\u7528\u6237\u5bc6\u7801\u9700\u8981\u5177\u6709 root \u6743\u9650\uff0c\u800c\u666e\u901a\u7528\u6237\u662f\u6ca1\u6709\u8fd9\u4e2a\u6743\u9650\u7684\u3002\u4f46\u662f\u5b9e\u9645\u4e0a\u666e\u901a\u7528\u6237\u53c8\u53ef\u4ee5\u4fee\u6539\u81ea\u5df1\u7684\u5bc6\u7801\uff0c\u8fd9\u662f\u600e\u4e48\u56de\u4e8b\u5462\uff1f\u5728 Linux \u7684\u6743\u9650\u63a7\u5236\u673a\u5236\u4e2d\uff0c\u6709\u4e00\u7c7b\u6bd4\u8f83\u7279\u6b8a\u7684\u6743\u9650\u8bbe\u7f6e\uff0c\u6bd4\u5982 SUID(Set User ID on execution)\uff0c\u5141\u8bb8\u7528\u6237\u4ee5\u53ef\u6267\u884c\u6587\u4ef6\u7684 owner \u7684\u6743\u9650\u6765\u8fd0\u884c\u53ef\u6267\u884c\u6587\u4ef6\u3002\u56e0\u4e3a\u7a0b\u5e8f\u6587\u4ef6 <code>/bin/passwd</code> \u88ab\u8bbe\u7f6e\u4e86 <code>SUID</code> \u6807\u8bc6\uff0c\u6240\u4ee5\u666e\u901a\u7528\u6237\u5728\u6267\u884c passwd \u547d\u4ee4\u65f6\uff0c\u8fdb\u7a0b\u662f\u4ee5 passwd \u7684\u6240\u6709\u8005\uff0c\u4e5f\u5c31\u662f root \u7528\u6237\u7684\u8eab\u4efd\u8fd0\u884c\uff0c\u4ece\u800c\u5c31\u53ef\u4ee5\u4fee\u6539\u5bc6\u7801\u4e86\u3002</p> <p>\u4f46\u662f\u4f7f\u7528 <code>SUID</code> \u5374\u5e26\u6765\u4e86\u65b0\u7684\u5b89\u5168\u9690\u60a3\uff0c\u5f53\u6211\u4eec\u8fd0\u884c\u8bbe\u7f6e\u4e86 <code>SUID</code> \u7684\u547d\u4ee4\u65f6\uff0c\u901a\u5e38\u53ea\u662f\u9700\u8981\u5f88\u5c0f\u4e00\u90e8\u5206\u7684\u7279\u6743\uff0c\u4f46\u662f <code>SUID</code> \u5374\u7ed9\u4e86\u5b83 root \u5177\u6709\u7684\u5168\u90e8\u6743\u9650\uff0c\u4e00\u65e6 \u88ab\u8bbe\u7f6e\u4e86 <code>SUID</code> \u7684\u547d\u4ee4\u51fa\u73b0\u6f0f\u6d1e\uff0c\u662f\u4e0d\u662f\u5c31\u5f88\u5bb9\u6613\u88ab\u5229\u7528\u4e86\u3002</p> <p>\u4e3a\u6b64 Linux \u5f15\u5165\u4e86 <code>Capabilities</code> \u673a\u5236\u6765\u5bf9 root \u6743\u9650\u8fdb\u884c\u4e86\u66f4\u52a0\u7ec6\u7c92\u5ea6\u7684\u63a7\u5236\uff0c\u5b9e\u73b0\u6309\u9700\u8fdb\u884c\u6388\u6743\uff0c\u8fd9\u6837\u5c31\u5927\u5927\u51cf\u5c0f\u4e86\u7cfb\u7edf\u7684\u5b89\u5168\u9690\u60a3\u3002</p>"},{"location":"kubernetes_security/security_context/#capabilities","title":"\u4ec0\u4e48\u662f Capabilities","text":"<p>\u4ece\u5185\u6838 2.2 \u5f00\u59cb\uff0cLinux \u5c06\u4f20\u7edf\u4e0a\u4e0e\u8d85\u7ea7\u7528\u6237 root \u5173\u8054\u7684\u7279\u6743\u5212\u5206\u4e3a\u4e0d\u540c\u7684\u5355\u5143\uff0c\u79f0\u4e3a <code>capabilites</code>\u3002<code>Capabilites</code> \u6bcf\u4e2a\u5355\u5143\u90fd\u53ef\u4ee5\u72ec\u7acb\u542f\u7528\u548c\u7981\u7528\u3002\u8fd9\u6837\u5f53\u7cfb\u7edf\u5728\u4f5c\u6743\u9650\u68c0\u67e5\u7684\u65f6\u5019\u5c31\u53d8\u6210\u4e86\uff1a<code>\u5728\u6267\u884c\u7279\u6743\u64cd\u4f5c\u65f6\uff0c\u5982\u679c\u8fdb\u7a0b\u7684\u6709\u6548\u8eab\u4efd\u4e0d\u662f root\uff0c\u5c31\u53bb\u68c0\u67e5\u662f\u5426\u5177\u6709\u8be5\u7279\u6743\u64cd\u4f5c\u6240\u5bf9\u5e94\u7684 capabilites\uff0c\u5e76\u4ee5\u6b64\u51b3\u5b9a\u662f\u5426\u53ef\u4ee5\u8fdb\u884c\u8be5\u7279\u6743\u64cd\u4f5c</code>\u3002\u6bd4\u5982\u5982\u679c\u6211\u4eec\u8981\u8bbe\u7f6e\u7cfb\u7edf\u65f6\u95f4\uff0c\u5c31\u5f97\u5177\u6709 <code>CAP_SYS_TIME</code> \u8fd9\u4e2a capabilites\u3002\u4e0b\u9762\u662f\u4ece capabilities man page \u4e2d\u6458\u53d6\u7684 capabilites \u5217\u8868\uff1a</p> <p></p>"},{"location":"kubernetes_security/security_context/#capabilities_1","title":"\u5982\u4f55\u4f7f\u7528 Capabilities","text":"<p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>getcap</code> \u548c <code>setcap</code> \u4e24\u6761\u547d\u4ee4\u6765\u5206\u522b\u67e5\u770b\u548c\u8bbe\u7f6e\u7a0b\u5e8f\u6587\u4ef6\u7684 <code>capabilities</code> \u5c5e\u6027\u3002\u6bd4\u5982\u5f53\u524d\u6211\u4eec\u662f<code>zuiapp</code> \u8fd9\u4e2a\u7528\u6237\uff0c\u4f7f\u7528 <code>getcap</code> \u547d\u4ee4\u67e5\u770b <code>ping</code> \u547d\u4ee4\u76ee\u524d\u5177\u6709\u7684 <code>capabilities</code>\uff1a</p> <pre><code>$ ll /bin/ping\n-rwxr-xr-x. 1 root root 62088 Nov  7  2016 /bin/ping\n$ getcap /bin/ping\n/bin/ping = cap_net_admin,cap_net_raw+p\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5177\u6709 <code>cap_net_admin</code> \u8fd9\u4e2a\u5c5e\u6027\uff0c\u6240\u4ee5\u6211\u4eec\u73b0\u5728\u53ef\u4ee5\u6267\u884c <code>ping</code> \u547d\u4ee4\uff1a</p> <pre><code>$ ping www.qikqiak.com\nPING www.qikqiak.com.w.kunlungr.com (12186) 56(84) bytes of data.\n64 bytes from 12186 (12186): icmp_seq=1 ttl=54 time=87 ms\n64 bytes from 12186 (12186): icmp_seq=2 ttl=54 time=85 ms\n</code></pre> <p>\u4f46\u662f\u5982\u679c\u6211\u4eec\u628a\u547d\u4ee4\u7684 <code>capabilities</code> \u5c5e\u6027\u79fb\u9664\u6389\uff1a</p> <pre><code>$ sudo setcap cap_net_admin,cap_net_raw-p /bin/ping\n$ getcap /bin/ping\n/bin/ping =\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u6267\u884c <code>ping</code> \u547d\u4ee4\u53ef\u4ee5\u53d1\u73b0\u5df2\u7ecf\u6ca1\u6709\u6743\u9650\u4e86\uff1a</p> <pre><code>$ ping www.qikqiak.com\nping: socket: Operation not permitted\n</code></pre> <p>\u56e0\u4e3a ping \u547d\u4ee4\u5728\u6267\u884c\u65f6\u9700\u8981\u8bbf\u95ee\u7f51\u7edc\uff0c\u6240\u9700\u7684 <code>capabilities</code> \u4e3a <code>cap_net_admin</code> \u548c <code>cap_net_raw</code>\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>setcap</code> \u547d\u4ee4\u53ef\u6765\u6dfb\u52a0\u5b83\u4eec\uff1a</p> <pre><code>$ sudo setcap cap_net_admin,cap_net_raw+p /bin/ping\n$ getcap /bin/ping\n/bin/ping = cap_net_admin,cap_net_raw+p\n$ ping www.qikqiak.com\nPING www.qikqiak.com.w.kunlungr.com (12188) 56(84) bytes of data.\n64 bytes from 12188 (12188): icmp_seq=1 ttl=54 time=39 ms\n</code></pre> <p>\u547d\u4ee4\u4e2d\u7684 <code>p</code> \u8868\u793a <code>Permitted</code> \u96c6\u5408(\u63a5\u4e0b\u6765\u4f1a\u4ecb\u7ecd)\uff0c<code>+</code> \u53f7\u8868\u793a\u628a\u6307\u5b9a\u7684<code>capabilities</code> \u6dfb\u52a0\u5230\u8fd9\u4e9b\u96c6\u5408\u4e2d\uff0c<code>-</code> \u53f7\u8868\u793a\u4ece\u96c6\u5408\u4e2d\u79fb\u9664\u3002</p> <p>\u5bf9\u4e8e\u53ef\u6267\u884c\u6587\u4ef6\u7684\u5c5e\u6027\u4e2d\u6709\u4e09\u4e2a\u96c6\u5408\u6765\u4fdd\u5b58\u4e09\u7c7b <code>capabilities</code>\uff0c\u5b83\u4eec\u5206\u522b\u662f\uff1a</p> <ul> <li>Permitted\uff1a\u5728\u8fdb\u7a0b\u6267\u884c\u65f6\uff0cPermitted \u96c6\u5408\u4e2d\u7684 capabilites \u81ea\u52a8\u88ab\u52a0\u5165\u5230\u8fdb\u7a0b\u7684 Permitted \u96c6\u5408\u4e2d\u3002</li> <li>Inheritable\uff1aInheritable \u96c6\u5408\u4e2d\u7684 capabilites \u4f1a\u4e0e\u8fdb\u7a0b\u7684 Inheritable \u96c6\u5408\u6267\u884c\u4e0e\u64cd\u4f5c\uff0c\u4ee5\u786e\u5b9a\u8fdb\u7a0b\u5728\u6267\u884c execve \u51fd\u6570\u540e\u54ea\u4e9b capabilites \u88ab\u7ee7\u627f\u3002</li> <li>Effective\uff1aEffective \u53ea\u662f\u4e00\u4e2a bit\u3002\u5982\u679c\u8bbe\u7f6e\u4e3a\u5f00\u542f\uff0c\u90a3\u4e48\u5728\u6267\u884c execve \u51fd\u6570\u540e\uff0cPermitted \u96c6\u5408\u4e2d\u65b0\u589e\u7684 capabilities \u4f1a\u81ea\u52a8\u51fa\u73b0\u5728\u8fdb\u7a0b\u7684 Effective \u96c6\u5408\u4e2d\u3002</li> </ul> <p>\u5bf9\u4e8e\u8fdb\u7a0b\u4e2d\u6709\u4e94\u79cd <code>capabilities</code> \u96c6\u5408\u7c7b\u578b\uff0c\u76f8\u6bd4\u6587\u4ef6\u7684 <code>capabilites</code>\uff0c\u8fdb\u7a0b\u7684 <code>capabilities</code> \u591a\u4e86\u4e24\u4e2a\u96c6\u5408\uff0c\u5206\u522b\u662f <code>Bounding</code> \u548c <code>Ambient</code>\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u540d\u6765\u67e5\u770b\u5f53\u524d\u8fdb\u7a0b\u7684 <code>capabilities</code> \u4fe1\u606f\uff1a</p> <pre><code>$ cat /proc/7029/status | grep 'Cap'  #7029\u4e3aPID\nCapInh: 0000000000000000\nCapPrm: 0000000000000000\nCapEff: 0000000000000000\nCapBnd: 0000001fffffffff\nCapAmb: 0000000000000000\n</code></pre> <p>\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>capsh</code> \u547d\u4ee4\u628a\u5b83\u4eec\u8f6c\u4e49\u4e3a\u53ef\u8bfb\u7684\u683c\u5f0f\uff0c\u8fd9\u6837\u57fa\u672c\u53ef\u4ee5\u770b\u51fa\u8fdb\u7a0b\u5177\u6709\u7684 <code>capabilities</code> \u4e86\uff1a</p> <pre><code>$ capsh --decode=0000001fffffffff\n0x0000001fffffffff=cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,35,36\n</code></pre>"},{"location":"kubernetes_security/security_context/#docker_container_capabilities","title":"Docker Container Capabilities","text":"<p>\u6211\u4eec\u8bf4 Docker \u5bb9\u5668\u672c\u8d28\u4e0a\u5c31\u662f\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u6240\u4ee5\u7406\u8bba\u4e0a\u5bb9\u5668\u5c31\u4f1a\u548c\u8fdb\u7a0b\u4e00\u6837\u4f1a\u6709\u4e00\u4e9b\u9ed8\u8ba4\u7684\u5f00\u653e\u6743\u9650\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b Docker \u4f1a\u5220\u9664\u5fc5\u987b\u7684 <code>capabilities</code> \u4e4b\u5916\u7684\u6240\u6709 <code>capabilities</code>\uff0c\u56e0\u4e3a\u5728\u5bb9\u5668\u4e2d\u6211\u4eec\u7ecf\u5e38\u4f1a\u4ee5 root \u7528\u6237\u6765\u8fd0\u884c\uff0c\u4f7f\u7528 <code>capabilities</code> \u73b0\u5728\u540e\uff0c\u5bb9\u5668\u4e2d\u7684\u4f7f\u7528\u7684 root \u7528\u6237\u6743\u9650\u5c31\u6bd4\u6211\u4eec\u5e73\u65f6\u5728\u5bbf\u4e3b\u673a\u4e0a\u4f7f\u7528\u7684 root \u7528\u6237\u6743\u9650\u8981\u5c11\u5f88\u591a\u4e86\uff0c\u8fd9\u6837\u5373\u4f7f\u51fa\u73b0\u4e86\u5b89\u5168\u6f0f\u6d1e\uff0c\u4e5f\u5f88\u96be\u7834\u574f\u6216\u8005\u83b7\u53d6\u5bbf\u4e3b\u673a\u7684 root \u6743\u9650\uff0c\u6240\u4ee5 Docker \u652f\u6301 <code>Capabilities</code> \u5bf9\u4e8e\u5bb9\u5668\u7684\u5b89\u5168\u6027\u6765\u8bf4\u662f\u975e\u5e38\u6709\u5fc5\u8981\u7684\u3002</p> <p>\u4e0d\u8fc7\u6211\u4eec\u5728\u8fd0\u884c\u5bb9\u5668\u7684\u65f6\u5019\u53ef\u4ee5\u901a\u8fc7\u6307\u5b9a <code>--privileded</code> \u53c2\u6570\u6765\u5f00\u542f\u5bb9\u5668\u7684\u8d85\u7ea7\u6743\u9650\uff0c\u8fd9\u4e2a\u53c2\u6570\u4e00\u5b9a\u8981\u614e\u7528\uff0c\u56e0\u4e3a\u4ed6\u4f1a\u83b7\u53d6\u7cfb\u7edf root \u7528\u6237\u6240\u6709\u80fd\u529b\u8d4b\u503c\u7ed9\u5bb9\u5668\uff0c\u5e76\u4e14\u4f1a\u626b\u63cf\u5bbf\u4e3b\u673a\u7684\u6240\u6709\u8bbe\u5907\u6587\u4ef6\u6302\u8f7d\u5230\u5bb9\u5668\u5185\u90e8\uff0c\u6240\u4ee5\u662f\u975e\u5e38\u5371\u9669\u7684\u64cd\u4f5c\u3002</p> <p>\u4f46\u662f\u5982\u679c\u4f60\u786e\u5b9e\u9700\u8981\u4e00\u4e9b\u7279\u6b8a\u7684\u6743\u9650\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>--cap-add</code> \u548c <code>--cap-drop</code> \u8fd9\u4e24\u4e2a\u53c2\u6570\u6765\u52a8\u6001\u8c03\u6574\uff0c\u53ef\u4ee5\u6700\u5927\u9650\u5ea6\u5730\u4fdd\u8bc1\u5bb9\u5668\u7684\u4f7f\u7528\u5b89\u5168\u3002\u4e0b\u9762\u8868\u683c\u4e2d\u5217\u51fa\u7684 <code>Capabilities</code> \u662f Docker \u9ed8\u8ba4\u7ed9\u5bb9\u5668\u6dfb\u52a0\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>--cap-drop</code> \u53bb\u9664\u5176\u4e2d\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\uff1a</p> <p></p> <p>\u4e0b\u9762\u8868\u683c\u4e2d\u5217\u51fa\u7684 <code>Capabilities</code> \u662f Docker \u9ed8\u8ba4\u5220\u9664\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7<code>--cap-add</code>\u6dfb\u52a0\u5176\u4e2d\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\uff1a</p> <p></p> <p><code>--cap-add</code>\u548c<code>--cap-drop</code> \u8fd9\u4e24\u53c2\u6570\u90fd\u652f\u6301<code>ALL</code>\u503c\uff0c\u6bd4\u5982\u5982\u679c\u4f60\u60f3\u8ba9\u67d0\u4e2a\u5bb9\u5668\u62e5\u6709\u9664\u4e86<code>MKNOD</code>\u4e4b\u5916\u7684\u6240\u6709\u5185\u6838\u6743\u9650\uff0c\u90a3\u4e48\u53ef\u4ee5\u6267\u884c\u4e0b\u9762\u7684\u547d\u4ee4\uff1a </p> <pre><code>$ sudo docker run --cap-add=ALL --cap-drop=MKNOD ...\n</code></pre> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u9700\u8981\u4fee\u6539\u7f51\u7edc\u63a5\u53e3\u6570\u636e\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u662f\u6ca1\u6709\u6743\u9650\u7684\uff0c\u56e0\u4e3a\u9700\u8981\u7684 <code>NET_ADMIN</code> \u8fd9\u4e2a <code>Capabilities</code> \u9ed8\u8ba4\u88ab\u79fb\u9664\u4e86\uff1a</p> <pre><code>$ docker run -it --rm busybox /bin/sh\n/ # ip link add dummy0 type dummy\nip: RTNETLINK answers: Operation not permitted\n/ #\n</code></pre> <p>\u6240\u4ee5\u5728\u4e0d\u4f7f\u7528 <code>--privileged</code> \u7684\u60c5\u51b5\u4e0b\uff08\u4e0d\u5efa\u8bae\uff09\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 <code>--cap-add=NET_ADMIN</code> \u5c06\u8fd9\u4e2a <code>Capabilities</code> \u6dfb\u52a0\u56de\u6765\uff1a</p> <pre><code>$ docker run -it --rm --cap-add=NET_ADMIN busybox /bin/sh\n/ # ip link add dummy0 type dummy\n/ #\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u5df2\u7ecf OK \u4e86\u3002</p>"},{"location":"kubernetes_security/security_context/#kubernetes_capabilities","title":"Kubernetes \u914d\u7f6e Capabilities","text":"<p>\u4e0a\u9762\u6211\u4ecb\u7ecd\u4e86\u5728 Docker \u5bb9\u5668\u4e0b\u5982\u4f55\u6765\u914d\u7f6e <code>Capabilities</code>\uff0c\u5728 Kubernetes \u4e2d\u4e5f\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u6765\u5b9a\u4e49\uff0c\u6211\u4eec\u53ea\u9700\u8981\u6dfb\u52a0\u5230 Pod \u5b9a\u4e49\u7684 </p> <pre><code>spec.containers.sercurityContext.capabilities\n</code></pre> <p>\u4e2d\u5373\u53ef\uff0c\u4e5f\u53ef\u4ee5\u8fdb\u884c <code>add</code> \u548c <code>drop</code> \u914d\u7f6e\uff0c\u540c\u6837\u4e0a\u9762\u7684\u793a\u4f8b\uff0c\u6211\u4eec\u8981\u7ed9 busybox \u5bb9\u5668\u6dfb\u52a0 <code>NET_ADMIN</code> \u8fd9\u4e2a <code>Capabilities</code>\uff0c\u5bf9\u5e94\u7684 YAML \u6587\u4ef6\u53ef\u4ee5\u8fd9\u6837\u5b9a\u4e49\uff1a(cpb-demo.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: cpb-demo\nspec:\n  containers:\n  - name: cpb\n    image: busybox\n    args:\n    - sleep\n    - \"3600\"\n    securityContext:\n      capabilities:\n        add: # \u6dfb\u52a0\n        - NET_ADMIN\n        drop:  # \u5220\u9664\n        - KILL\n</code></pre> <p>\u6211\u4eec\u5728 <code>securityContext</code> \u4e0b\u9762\u6dfb\u52a0\u4e86 <code>capabilities</code> \u5b57\u6bb5\uff0c\u5176\u4e2d\u6dfb\u52a0\u4e86 <code>NET_ADMIN</code> \u5e76\u4e14\u5220\u9664\u4e86 <code>KILL</code> \u8fd9\u4e2a\u9ed8\u8ba4\u7684\u5bb9\u5668 <code>Capabilities</code>\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u5728 Pod \u4e2d\u4fee\u6539\u7f51\u7edc\u63a5\u53e3\u6570\u636e\u4e86\uff1a</p> <pre><code>$ kubectl apply -f cpb-demo.yaml\n$ kubectl get pods\nNAME                      READY   STATUS    RESTARTS   AGE\ncpb-demo                  1/1     Running   0          2m9s\n$ kubectl exec -it cpb-demo /bin/sh\n/ # ip link add dummy0 type dummy\n/ #\n</code></pre> <p>\u5728 Kubernetes \u4e2d\u901a\u8fc7 </p> <pre><code>sercurityContext.capabilities\n</code></pre> <p>\u8fdb\u884c\u914d\u7f6e\u5bb9\u5668\u7684 <code>Capabilities</code>\uff0c\u5f53\u7136\u6700\u7ec8\u8fd8\u662f\u901a\u8fc7 Docker \u7684 <code>libcontainer</code> \u53bb\u501f\u52a9 </p> <pre><code>Linux kernel capabilities\n</code></pre> <p>\u5b9e\u73b0\u7684\u6743\u9650\u7ba1\u7406\u3002</p>"},{"location":"kubernetes_security/security_context/#selinux","title":"\u4e3a\u5bb9\u5668\u8bbe\u7f6e <code>SELinux</code> \u6807\u7b7e","text":"<p><code>SELinux</code> (Security-Enhanced Linux) \u662f\u4e00\u79cd\u5f3a\u5236\u8bbf\u95ee\u63a7\u5236\uff08mandatory access control\uff09\u7684\u5b9e\u73b0\u3002\u5b83\u7684\u4f5c\u6cd5\u662f\u4ee5\u6700\u5c0f\u6743\u9650\u539f\u5219\uff08principle of least privilege\uff09\u4e3a\u57fa\u7840\uff0c\u5728 Linux \u6838\u5fc3\u4e2d\u4f7f\u7528 Linux \u5b89\u5168\u6a21\u5757\uff08Linux Security Modules\uff09\u3002Pod \u6216\u5bb9\u5668\u5b9a\u4e49\u7684 securityContext \u4e2d <code>seLinuxOptions</code> \u5b57\u6bb5\u662f\u4e00\u4e2a SELinuxOptions \u5bf9\u8c61\uff0c\u8be5\u5b57\u6bb5\u53ef\u7528\u4e8e\u4e3a\u5bb9\u5668\u6307\u5b9a <code>SELinux</code> \u6807\u7b7e\u3002</p> <pre><code>securityContext:\n  seLinuxOptions:\n    level: \"s0:c123,c456\"\n</code></pre>"},{"location":"kubernetes_security/security_context/#apparmor","title":"AppArmor","text":"<p>TODO</p>"},{"location":"kubernetes_security/security_context/#seccomp","title":"Seccomp","text":"<p>TODO</p> <p>\u9664\u4e86\u8fd9\u4e9b\u9488\u5bf9\u5bb9\u5668\u548c Pod \u7684\u4e00\u4e9b\u5b89\u5168\u7ba1\u63a7\u4e4b\u5916\uff0c\u8fd8\u6709\u96c6\u7fa4\u7ea7\u522b\u7684\u5b89\u5168\u7b56\u7565\u8bbe\u7f6e Pod Security Policies\uff08PSP\uff09\uff0c\u53ef\u4ee5\u81ea\u52a8\u4e3a\u96c6\u7fa4\u5185\u7684 Pod \u548c Volume \u8bbe\u7f6e Security Context\u3002</p>"},{"location":"kubernetes_stroage/ceph/","title":"Ceph \u5b58\u50a8","text":"<p>\ue3c9</p>"},{"location":"kubernetes_stroage/ceph/#ceph","title":"Ceph","text":"<p>Ceph \u662f\u4e00\u4e2a\u7edf\u4e00\u7684\u5206\u5e03\u5f0f\u5b58\u50a8\u7cfb\u7edf\uff0c\u63d0\u4f9b\u8f83\u597d\u7684\u6027\u80fd\u3001\u53ef\u9760\u6027\u548c\u53ef\u6269\u5c55\u6027\u3002\u6700\u65e9\u8d77\u6e90\u4e8e Sage \u535a\u58eb\u671f\u95f4\u7684\u5de5\u4f5c\uff0c\u968f\u540e\u8d21\u732e\u7ed9\u5f00\u6e90\u793e\u533a\u3002</p>"},{"location":"kubernetes_stroage/ceph/#_1","title":"\u7b80\u4ecb","text":"<p><code>\u9ad8\u6027\u80fd</code></p> <ul> <li>\u629b\u5f03\u4e86\u4f20\u7edf\u7684\u96c6\u4e2d\u5f0f\u5b58\u50a8\u8fd0\u8f93\u5c40\u5bfb\u5740\u7684\u65b9\u6848\uff0c\u91c7\u7528 <code>CRUSH</code> \u7b97\u6cd5\uff0c\u6570\u636e\u5206\u5e03\u5747\u8861\uff0c\u5e76\u884c\u5ea6\u9ad8\u3002</li> <li>\u8003\u8651\u4e86\u5bb9\u707e\u57df\u7684\u9694\u79bb\uff0c\u80fd\u591f\u5b9e\u73b0\u5404\u7c7b\u8d1f\u8f7d\u7684\u526f\u672c\u8bbe\u7f6e\u89c4\u5219\uff0c\u4f8b\u5982\u8de8\u673a\u623f\u3001\u673a\u67b6\u611f\u77e5\u7b49\u3002</li> <li>\u80fd\u591f\u652f\u6301\u4e0a\u5343\u4e2a\u5b58\u50a8\u8282\u70b9\u7684\u89c4\u6a21\uff0c\u652f\u6301 TB \u5230 PB \u7ea7\u7684\u6570\u636e\u3002</li> </ul> <p><code>\u9ad8\u53ef\u7528\u6027</code></p> <ul> <li>\u526f\u672c\u6570\u53ef\u4ee5\u7075\u6d3b\u63a7\u5236</li> <li>\u652f\u6301\u6545\u969c\u57df\u5206\u79bb\uff0c\u6570\u636e\u5f3a\u4e00\u81f4\u6027</li> <li>\u591a\u79cd\u6545\u969c\u573a\u666f\u81ea\u52a8\u8fdb\u884c\u4fee\u590d\u81ea\u6108</li> <li>\u6ca1\u6709\u5355\u70b9\u6545\u969c\uff0c\u81ea\u52a8\u7ba1\u7406~~</li> </ul> <p><code>\u9ad8\u53ef\u6269\u5c55\u6027</code></p> <ul> <li>\u53bb\u4e2d\u5fc3\u5316</li> <li>\u6269\u5c55\u7075\u6d3b</li> <li>\u968f\u7740\u8282\u70b9\u589e\u52a0\u800c\u7ebf\u6027\u589e\u957f</li> </ul> <p><code>\u7279\u6027\u4e30\u5bcc</code></p> <ul> <li>\u652f\u6301\u4e09\u79cd\u5b58\u50a8\u63a5\u53e3\uff1a\u5757\u5b58\u50a8\u3001\u6587\u4ef6\u5b58\u50a8\u3001\u5bf9\u8c61\u5b58\u50a8</li> <li>\u652f\u6301\u81ea\u5b9a\u4e49\u63a5\u53e3\uff0c\u652f\u6301\u591a\u79cd\u8bed\u8a00\u9a71\u52a8</li> </ul>"},{"location":"kubernetes_stroage/ceph/#_2","title":"\u67b6\u6784","text":"<p><code>\u652f\u6301\u4e09\u79cd\u63a5\u53e3</code></p> <ul> <li>Object\uff1a\u6709\u539f\u751f API\uff0c\u800c\u4e14\u4e5f\u517c\u5bb9 Swift \u548c S3 \u7684 API</li> <li>Block\uff1a\u652f\u6301\u7cbe\u7b80\u914d\u7f6e\u3001\u5feb\u7167\u3001\u514b\u9686</li> <li>File\uff1aPosix \u63a5\u53e3\uff0c\u652f\u6301\u5feb\u7167</li> </ul> <p></p>"},{"location":"kubernetes_stroage/ceph/#_3","title":"\u7ec4\u4ef6","text":"<p><code>Monitor</code>\uff1a\u4e00\u4e2a Ceph \u96c6\u7fa4\u9700\u8981\u591a\u4e2a Monitor \u7ec4\u6210\u7684\u5c0f\u96c6\u7fa4\uff0c\u5b83\u4eec\u901a\u8fc7 Paxos \u540c\u6b65\u6570\u636e\uff0c\u7528\u6765\u4fdd\u5b58 OSD \u7684\u5143\u6570\u636e\u3002</p> <p><code>OSD</code>\uff1a\u5168\u79f0 </p> <pre><code>Object Storage Device\n</code></pre> <p>\uff0c\u4e5f\u5c31\u662f\u8d1f\u8d23\u54cd\u5e94\u5ba2\u6237\u7aef\u8bf7\u6c42\u8fd4\u56de\u5177\u4f53\u6570\u636e\u7684\u8fdb\u7a0b\uff0c\u4e00\u4e2a Ceph \u96c6\u7fa4\u4e00\u822c\u90fd\u6709\u5f88\u591a\u4e2a OSD\u3002\u4e3b\u8981\u529f\u80fd\u7528\u4e8e\u6570\u636e\u7684\u5b58\u50a8\uff0c\u5f53\u76f4\u63a5\u4f7f\u7528\u786c\u76d8\u4f5c\u4e3a\u5b58\u50a8\u76ee\u6807\u65f6\uff0c\u4e00\u5757\u786c\u76d8\u79f0\u4e4b\u4e3a <code>OSD</code>\uff0c\u5f53\u4f7f\u7528\u4e00\u4e2a\u76ee\u5f55\u4f5c\u4e3a\u5b58\u50a8\u76ee\u6807\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u76ee\u5f55\u4e5f\u88ab\u79f0\u4e3a <code>OSD</code>\u3002</p> <p><code>MDS</code>\uff1a\u5168\u79f0 <code>Ceph Metadata Server</code>\uff0c\u662f CephFS \u670d\u52a1\u4f9d\u8d56\u7684\u5143\u6570\u636e\u670d\u52a1\uff0c\u5bf9\u8c61\u5b58\u50a8\u548c\u5757\u8bbe\u5907\u5b58\u50a8\u4e0d\u9700\u8981\u8be5\u670d\u52a1\u3002</p> <p><code>Object</code>\uff1aCeph \u6700\u5e95\u5c42\u7684\u5b58\u50a8\u5355\u5143\u662f Object \u5bf9\u8c61\uff0c\u4e00\u6761\u6570\u636e\u3001\u4e00\u4e2a\u914d\u7f6e\u90fd\u662f\u4e00\u4e2a\u5bf9\u8c61\uff0c\u6bcf\u4e2a Object \u5305\u542b ID\u3001\u5143\u6570\u636e\u548c\u539f\u59cb\u6570\u636e\u3002</p> <p><code>Pool</code>\uff1aPool \u662f\u4e00\u4e2a\u5b58\u50a8\u5bf9\u8c61\u7684\u903b\u8f91\u5206\u533a\uff0c\u5b83\u901a\u5e38\u89c4\u5b9a\u4e86\u6570\u636e\u5197\u4f59\u7684\u7c7b\u578b\u4e0e\u526f\u672c\u6570\uff0c\u9ed8\u8ba4\u4e3a3\u526f\u672c\u3002\u5bf9\u4e8e\u4e0d\u540c\u7c7b\u578b\u7684\u5b58\u50a8\uff0c\u9700\u8981\u5355\u72ec\u7684 Pool\uff0c\u5982 RBD\u3002</p> <p><code>PG</code>\uff1a\u5168\u79f0 <code>Placement Grouops</code>\uff0c\u662f\u4e00\u4e2a\u903b\u8f91\u6982\u5ff5\uff0c\u4e00\u4e2a OSD \u5305\u542b\u591a\u4e2a PG\u3002\u5f15\u5165 PG \u8fd9\u4e00\u5c42\u5176\u5b9e\u662f\u4e3a\u4e86\u66f4\u597d\u7684\u5206\u914d\u6570\u636e\u548c\u5b9a\u4f4d\u6570\u636e\u3002\u6bcf\u4e2a <code>Pool</code> \u5185\u5305\u542b\u5f88\u591a\u4e2a PG\uff0c\u5b83\u662f\u4e00\u4e2a\u5bf9\u8c61\u7684\u96c6\u5408\uff0c\u670d\u52a1\u7aef\u6570\u636e\u5747\u8861\u548c\u6062\u590d\u7684\u6700\u5c0f\u5355\u4f4d\u5c31\u662f PG\u3002</p> <p></p> <ul> <li>pool \u662f ceph \u5b58\u50a8\u6570\u636e\u65f6\u7684\u903b\u8f91\u5206\u533a\uff0c\u5b83\u8d77\u5230 namespace \u7684\u4f5c\u7528</li> <li>\u6bcf\u4e2a pool \u5305\u542b\u4e00\u5b9a\u6570\u91cf(\u53ef\u914d\u7f6e)\u7684 PG</li> <li>PG \u91cc\u7684\u5bf9\u8c61\u88ab\u6620\u5c04\u5230\u4e0d\u540c\u7684 Object \u4e0a</li> <li>pool \u662f\u5206\u5e03\u5230\u6574\u4e2a\u96c6\u7fa4\u7684</li> </ul> <p><code>FileStore\u4e0eBlueStore</code>\uff1aFileStore \u662f\u8001\u7248\u672c\u9ed8\u8ba4\u4f7f\u7528\u7684\u540e\u7aef\u5b58\u50a8\u5f15\u64ce\uff0c\u5982\u679c\u4f7f\u7528 FileStore\uff0c\u5efa\u8bae\u4f7f\u7528 <code>xfs</code> \u6587\u4ef6\u7cfb\u7edf\u3002BlueStore \u662f\u4e00\u4e2a\u65b0\u7684\u540e\u7aef\u5b58\u50a8\u5f15\u64ce\uff0c\u53ef\u4ee5\u76f4\u63a5\u7ba1\u7406\u88f8\u786c\u76d8\uff0c\u629b\u5f03\u4e86 ext4 \u4e0e xfs \u7b49\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\u3002\u53ef\u4ee5\u76f4\u63a5\u5bf9\u7269\u7406\u786c\u76d8\u8fdb\u884c\u64cd\u4f5c\uff0c\u540c\u65f6\u6548\u7387\u4e5f\u9ad8\u51fa\u5f88\u591a\u3002</p> <p><code>RADOS</code>\uff1a\u5168\u79f0 </p> <pre><code>Reliable Autonomic Distributed Object Store\n</code></pre> <p>\uff0c\u662f Ceph \u96c6\u7fa4\u7684\u7cbe\u534e\uff0c\u7528\u4e8e\u5b9e\u73b0\u6570\u636e\u5206\u914d\u3001Failover \u7b49\u96c6\u7fa4\u64cd\u4f5c\u3002</p> <p><code>Librados</code>\uff1a<code>Librados</code> \u662f Rados \u63d0\u4f9b\u5e93\uff0c\u56e0\u4e3a RADOS \u662f\u534f\u8bae\u5f88\u96be\u76f4\u63a5\u8bbf\u95ee\uff0c\u56e0\u6b64\u4e0a\u5c42\u7684 RBD\u3001RGW \u548c CephFS \u90fd\u662f\u901a\u8fc7 librados \u8bbf\u95ee\u7684\uff0c\u76ee\u524d\u63d0\u4f9b PHP\u3001Ruby\u3001Java\u3001Python\u3001C \u548c C++ \u652f\u6301\u3002</p> <p><code>CRUSH</code>\uff1a<code>CRUSH</code> \u662f Ceph \u4f7f\u7528\u7684\u6570\u636e\u5206\u5e03\u7b97\u6cd5\uff0c\u7c7b\u4f3c\u4e00\u81f4\u6027\u54c8\u5e0c\uff0c\u8ba9\u6570\u636e\u5206\u914d\u5230\u9884\u671f\u7684\u5730\u65b9\u3002</p> <p><code>RBD</code>\uff1a\u5168\u79f0 <code>RADOS Block Device</code>\uff0c\u662f Ceph \u5bf9\u5916\u63d0\u4f9b\u7684\u5757\u8bbe\u5907\u670d\u52a1\uff0c\u5982\u865a\u62df\u673a\u786c\u76d8\uff0c\u652f\u6301\u5feb\u7167\u529f\u80fd\u3002</p> <p><code>RGW</code>\uff1a\u5168\u79f0\u662f <code>RADOS Gateway</code>\uff0c\u662f Ceph \u5bf9\u5916\u63d0\u4f9b\u7684\u5bf9\u8c61\u5b58\u50a8\u670d\u52a1\uff0c\u63a5\u53e3\u4e0e S3 \u548c Swift \u517c\u5bb9\u3002</p> <p><code>CephFS</code>\uff1a\u5168\u79f0 <code>Ceph File System</code>\uff0c\u662f Ceph \u5bf9\u5916\u63d0\u4f9b\u7684\u6587\u4ef6\u7cfb\u7edf\u670d\u52a1\u3002</p>"},{"location":"kubernetes_stroage/ceph/#_4","title":"\u5757\u5b58\u50a8","text":"<p><code>\u5178\u578b\u8bbe\u5907</code></p> <p>\u78c1\u76d8\u9635\u5217\uff0c\u786c\u76d8\uff0c\u4e3b\u8981\u662f\u5c06\u88f8\u78c1\u76d8\u7a7a\u95f4\u6620\u5c04\u7ed9\u4e3b\u673a\u4f7f\u7528\u7684\u3002</p> <p><code>\u4f18\u70b9</code></p> <ul> <li>\u901a\u8fc7 Raid \u4e0e LVM \u7b49\u624b\u6bb5\uff0c\u5bf9\u6570\u636e\u63d0\u4f9b\u4e86\u4fdd\u62a4\u3002</li> <li>\u591a\u5757\u5ec9\u4ef7\u7684\u786c\u76d8\u7ec4\u5408\u8d77\u6765\uff0c\u63d0\u9ad8\u5bb9\u91cf\u3002</li> <li>\u591a\u5757\u78c1\u76d8\u7ec4\u5408\u51fa\u6765\u7684\u903b\u8f91\u76d8\uff0c\u63d0\u5347\u8bfb\u5199\u6548\u7387\u3002</li> </ul> <p><code>\u7f3a\u70b9</code></p> <ul> <li>\u91c7\u7528 SAN \u67b6\u6784\u7ec4\u7f51\u65f6\uff0c\u5149\u7ea4\u4ea4\u6362\u673a\uff0c\u9020\u4ef7\u6210\u672c\u9ad8\u3002</li> <li>\u4e3b\u673a\u4e4b\u95f4\u65e0\u6cd5\u5171\u4eab\u6570\u636e\u3002</li> </ul> <p><code>\u4f7f\u7528\u573a\u666f</code></p> <ul> <li>Docker \u5bb9\u5668\u3001\u865a\u62df\u673a\u78c1\u76d8\u5b58\u50a8\u5206\u914d\u3002</li> <li>\u65e5\u5fd7\u5b58\u50a8</li> <li>\u6587\u4ef6\u5b58\u50a8</li> <li>...</li> </ul>"},{"location":"kubernetes_stroage/ceph/#_5","title":"\u6587\u4ef6\u5b58\u50a8","text":"<p><code>\u5178\u578b\u8bbe\u5907</code> FTP\u3001NFS \u670d\u52a1\u5668\uff0c\u4e3a\u4e86\u514b\u670d\u5757\u5b58\u50a8\u6587\u4ef6\u65e0\u6cd5\u5171\u4eab\u7684\u95ee\u9898\uff0c\u6240\u4ee5\u6709\u4e86\u6587\u4ef6\u5b58\u50a8\uff0c\u5728\u670d\u52a1\u5668\u4e0a\u67b6\u8bbe FTP \u4e0e NFS \u670d\u52a1\u5668\uff0c\u5c31\u662f\u6587\u4ef6\u5b58\u50a8\u3002</p> <p><code>\u4f18\u70b9</code></p> <ul> <li>\u9020\u4ef7\u4f4e\uff0c\u968f\u4fbf\u4e00\u53f0\u673a\u5668\u5c31\u53ef\u4ee5\u4e86</li> <li>\u65b9\u4fbf\u6587\u4ef6\u53ef\u4ee5\u5171\u4eab</li> </ul> <p><code>\u7f3a\u70b9</code></p> <ul> <li>\u8bfb\u5199\u901f\u7387\u4f4e</li> <li>\u4f20\u8f93\u901f\u7387\u6162</li> </ul> <p><code>\u4f7f\u7528\u573a\u666f</code></p> <ul> <li>\u65e5\u5fd7\u5b58\u50a8</li> <li>\u6709\u76ee\u5f55\u7ed3\u6784\u7684\u6587\u4ef6\u5b58\u50a8</li> <li>...</li> </ul>"},{"location":"kubernetes_stroage/ceph/#_6","title":"\u5bf9\u8c61\u5b58\u50a8","text":"<p><code>\u5178\u578b\u8bbe\u5907</code></p> <p>\u5185\u7f6e\u5927\u5bb9\u91cf\u786c\u76d8\u7684\u5206\u5e03\u5f0f\u670d\u52a1\u5668(swift, s3)\uff1b\u591a\u53f0\u670d\u52a1\u5668\u5185\u7f6e\u5927\u5bb9\u91cf\u786c\u76d8\uff0c\u5b89\u88c5\u4e0a\u5bf9\u8c61\u5b58\u50a8\u7ba1\u7406\u8f6f\u4ef6\uff0c\u5bf9\u5916\u63d0\u4f9b\u8bfb\u5199\u8bbf\u95ee\u529f\u80fd\u3002</p> <p><code>\u4f18\u70b9</code></p> <ul> <li>\u5177\u5907\u5757\u5b58\u50a8\u7684\u8bfb\u5199\u9ad8\u901f\u3002</li> <li>\u5177\u5907\u6587\u4ef6\u5b58\u50a8\u7684\u5171\u4eab\u7b49\u7279\u6027</li> </ul> <p><code>\u4f7f\u7528\u573a\u666f</code>\uff1a(\u9002\u5408\u66f4\u65b0\u53d8\u52a8\u8f83\u5c11\u7684\u6570\u636e)</p> <ul> <li>\u56fe\u7247\u5b58\u50a8</li> <li>\u89c6\u9891\u5b58\u50a8</li> <li>...</li> </ul>"},{"location":"kubernetes_stroage/ceph/#_7","title":"\u90e8\u7f72","text":"<p>\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u4f7f\u7528\uff0c\u4e5f\u4e3a\u4e86\u65b9\u4fbf\u7ba1\u7406\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528 Rook \u6765\u90e8\u7f72 Ceph \u96c6\u7fa4\uff0cRook \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u4e91\u539f\u751f\u5b58\u50a8\u7f16\u6392\u5de5\u5177\uff0c\u63d0\u4f9b\u5e73\u53f0\u3001\u6846\u67b6\u548c\u5bf9\u5404\u79cd\u5b58\u50a8\u89e3\u51b3\u65b9\u6848\u7684\u652f\u6301\uff0c\u4ee5\u548c\u4e91\u539f\u751f\u73af\u5883\u8fdb\u884c\u672c\u5730\u96c6\u6210\u3002</p> <p>Rook \u5c06\u5b58\u50a8\u8f6f\u4ef6\u8f6c\u53d8\u6210\u81ea\u6211\u7ba1\u7406\u3001\u81ea\u6211\u6269\u5c55\u548c\u81ea\u6211\u4fee\u590d\u7684\u5b58\u50a8\u670d\u52a1\uff0c\u901a\u8fc7\u81ea\u52a8\u5316\u90e8\u7f72\u3001\u542f\u52a8\u3001\u914d\u7f6e\u3001\u4f9b\u5e94\u3001\u6269\u5c55\u3001\u5347\u7ea7\u3001\u8fc1\u79fb\u3001\u707e\u96be\u6062\u590d\u3001\u76d1\u63a7\u548c\u8d44\u6e90\u7ba1\u7406\u6765\u5b9e\u73b0\u3002Rook \u5e95\u5c42\u4f7f\u7528\u4e91\u539f\u751f\u5bb9\u5668\u7ba1\u7406\u3001\u8c03\u5ea6\u548c\u7f16\u6392\u5e73\u53f0\u63d0\u4f9b\u7684\u80fd\u529b\u6765\u63d0\u4f9b\u8fd9\u4e9b\u529f\u80fd\uff0c\u5176\u5b9e\u5c31\u662f\u6211\u4eec\u5e73\u5e38\u8bf4\u7684 Operator\u3002Rook \u5229\u7528\u6269\u5c55\u529f\u80fd\u5c06\u5176\u6df1\u5ea6\u96c6\u6210\u5230\u4e91\u539f\u751f\u73af\u5883\u4e2d\uff0c\u5e76\u4e3a\u8c03\u5ea6\u3001\u751f\u547d\u5468\u671f\u7ba1\u7406\u3001\u8d44\u6e90\u7ba1\u7406\u3001\u5b89\u5168\u6027\u3001\u76d1\u63a7\u7b49\u63d0\u4f9b\u4e86\u65e0\u7f1d\u7684\u4f53\u9a8c\u3002\u6709\u5173 Rook \u5f53\u524d\u652f\u6301\u7684\u5b58\u50a8\u89e3\u51b3\u65b9\u6848\u7684\u72b6\u6001\u7684\u66f4\u591a\u8be6\u7ec6\u4fe1\u606f\uff0c\u53ef\u4ee5\u53c2\u8003 Rook \u4ed3\u5e93 \u7684\u9879\u76ee\u4ecb\u7ecd\u3002</p> <p></p> <p>Rook \u5305\u542b\u591a\u4e2a\u7ec4\u4ef6\uff1a</p> <ul> <li>Rook Operator\uff1aRook \u7684\u6838\u5fc3\u7ec4\u4ef6\uff0cRook Operator \u662f\u4e00\u4e2a\u7b80\u5355\u7684\u5bb9\u5668\uff0c\u81ea\u52a8\u542f\u52a8\u5b58\u50a8\u96c6\u7fa4\uff0c\u5e76\u76d1\u63a7\u5b58\u50a8\u5b88\u62a4\u8fdb\u7a0b\uff0c\u6765\u786e\u4fdd\u5b58\u50a8\u96c6\u7fa4\u7684\u5065\u5eb7\u3002</li> <li>Rook Agent\uff1a\u5728\u6bcf\u4e2a\u5b58\u50a8\u8282\u70b9\u4e0a\u8fd0\u884c\uff0c\u5e76\u914d\u7f6e\u4e00\u4e2a FlexVolume \u6216\u8005 CSI \u63d2\u4ef6\uff0c\u548c Kubernetes \u7684\u5b58\u50a8\u5377\u63a7\u5236\u6846\u67b6\u8fdb\u884c\u96c6\u6210\u3002Agent \u5904\u7406\u6240\u6709\u7684\u5b58\u50a8\u64cd\u4f5c\uff0c\u4f8b\u5982\u6302\u63a5\u7f51\u7edc\u5b58\u50a8\u8bbe\u5907\u3001\u5728\u4e3b\u673a\u4e0a\u52a0\u8f7d\u5b58\u50a8\u5377\u4ee5\u53ca\u683c\u5f0f\u5316\u6587\u4ef6\u7cfb\u7edf\u7b49\u3002</li> <li>Rook Discovers\uff1a\u68c0\u6d4b\u6302\u63a5\u5230\u5b58\u50a8\u8282\u70b9\u4e0a\u7684\u5b58\u50a8\u8bbe\u5907\u3002</li> </ul> <p>Rook \u8fd8\u4f1a\u7528 Kubernetes Pod \u7684\u5f62\u5f0f\uff0c\u90e8\u7f72 Ceph \u7684 MON\u3001OSD \u4ee5\u53ca MGR \u5b88\u62a4\u8fdb\u7a0b\u3002Rook Operator \u8ba9\u7528\u6237\u53ef\u4ee5\u901a\u8fc7 CRD \u6765\u521b\u5efa\u548c\u7ba1\u7406\u5b58\u50a8\u96c6\u7fa4\u3002\u6bcf\u79cd\u8d44\u6e90\u90fd\u5b9a\u4e49\u4e86\u81ea\u5df1\u7684 CRD\uff1a</p> <ul> <li>RookCluster\uff1a\u63d0\u4f9b\u4e86\u5bf9\u5b58\u50a8\u673a\u7fa4\u7684\u914d\u7f6e\u80fd\u529b\uff0c\u7528\u6765\u63d0\u4f9b\u5757\u5b58\u50a8\u3001\u5bf9\u8c61\u5b58\u50a8\u4ee5\u53ca\u5171\u4eab\u6587\u4ef6\u7cfb\u7edf\u3002\u6bcf\u4e2a\u96c6\u7fa4\u90fd\u6709\u591a\u4e2a Pool\u3002</li> <li>Pool\uff1a\u4e3a\u5757\u5b58\u50a8\u63d0\u4f9b\u652f\u6301\uff0cPool \u4e5f\u662f\u7ed9\u6587\u4ef6\u548c\u5bf9\u8c61\u5b58\u50a8\u63d0\u4f9b\u5185\u90e8\u652f\u6301\u3002</li> <li>Object Store\uff1a\u7528 S3 \u517c\u5bb9\u63a5\u53e3\u5f00\u653e\u5b58\u50a8\u670d\u52a1\u3002</li> <li>File System\uff1a\u4e3a\u591a\u4e2a Kubernetes Pod \u63d0\u4f9b\u5171\u4eab\u5b58\u50a8\u3002</li> </ul>"},{"location":"kubernetes_stroage/ceph/#_8","title":"\u73af\u5883","text":"<p>Rook Ceph \u9700\u8981\u4f7f\u7528 RBD \u5185\u6838\u6a21\u5757\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8fd0\u884c <code>modprobe rbd</code> \u6765\u6d4b\u8bd5 Kubernetes \u8282\u70b9\u662f\u5426\u6709\u8be5\u6a21\u5757\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u5219\u9700\u8981\u66f4\u65b0\u4e0b\u5185\u6838\u7248\u672c\u3002</p> <p>\u53e6\u5916\u9700\u8981\u5728\u8282\u70b9\u4e0a\u5b89\u88c5 <code>lvm2</code> \u8f6f\u4ef6\u5305\uff1a</p> <pre><code># Centos\nsudo yum install -y lvm2\n# Ubuntu\nsudo apt-get install -y lvm2\n</code></pre>"},{"location":"kubernetes_stroage/ceph/#_9","title":"\u5b89\u88c5","text":"<p>\u6211\u4eec\u8fd9\u91cc\u90e8\u7f72\u6700\u65b0\u7684 release-1.2 \u7248\u672c\u7684 Rook\uff0c\u90e8\u7f72\u6e05\u5355\u6587\u4ef6\u5730\u5740\uff1ahttps://github.com/rook/rook/tree/release-1.2/cluster/examples/kubernetes/ceph\u3002</p> <p>\u4ece\u4e0a\u9762\u94fe\u63a5\u4e2d\u4e0b\u8f7d common.yaml \u4e0e operator.yaml \u4e24\u4e2a\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff1a</p> <pre><code># \u4f1a\u5b89\u88c5crd\u3001rbac\u76f8\u5173\u8d44\u6e90\u5bf9\u8c61\n$ kubectl apply -f common.yaml\n# \u5b89\u88c5 rook operator\n$ kubectl apply -f operator.yaml\n</code></pre> <p>\u5728\u7ee7\u7eed\u64cd\u4f5c\u4e4b\u524d\uff0c\u9a8c\u8bc1 <code>rook-ceph-operator</code> \u662f\u5426\u5904\u4e8e<code>Running</code>\u72b6\u6001\uff1a</p> <pre><code>$ kubectl get pods -n rook-ceph\nNAME                                  READY   STATUS    RESTARTS   AGE\nrook-ceph-operator-6d8fb9498b-jxdwx   1/1     Running   0          34s\nrook-discover-7wpsl                   1/1     Running   0          32s\nrook-discover-8t8lv                   1/1     Running   0          32s\nrook-discover-9t497                   1/1     Running   0          32s\nrook-discover-v57rd                   1/1     Running   0          32s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 Operator \u8fd0\u884c\u6210\u529f\u540e\uff0c\u8fd8\u4f1a\u6709\u4e00\u4e2a DaemonSet \u63a7\u5236\u5668\u8fd0\u884c\u5f97 rook-discover \u5e94\u7528\uff0c\u5f53 <code>Rook Operator</code> \u5904\u4e8e Running \u72b6\u6001\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u521b\u5efa Ceph \u96c6\u7fa4\u4e86\u3002\u4e3a\u4e86\u4f7f\u96c6\u7fa4\u5728\u91cd\u542f\u540e\u4e0d\u53d7\u5f71\u54cd\uff0c\u8bf7\u786e\u4fdd\u8bbe\u7f6e\u7684 <code>dataDirHostPath</code> \u5c5e\u6027\u503c\u4e3a\u6709\u6548\u5f97\u4e3b\u673a\u8def\u5f84\u3002\u66f4\u591a\u76f8\u5173\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u67e5\u770b\u96c6\u7fa4\u914d\u7f6e\u76f8\u5173\u6587\u6863\u3002</p> <p>\u521b\u5efa\u5982\u4e0b\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\uff1a(cluster.yaml)</p> <pre><code>apiVersion: ceph.rook.io/v1\nkind: CephCluster\nmetadata:\n  name: rook-ceph\n  namespace: rook-ceph\nspec:\n  cephVersion:\n    # \u6700\u65b0\u5f97 ceph \u955c\u50cf, \u53ef\u4ee5\u67e5\u770b https://hub.docker.com/r/ceph/ceph/tags\n    image: ceph/ceph:v5\n  dataDirHostPath: /var/lib/rook  # \u4e3b\u673a\u6709\u6548\u76ee\u5f55\n  mon:\n    count: 3\n  dashboard:\n    enabled: true\n  storage:\n    useAllNodes: true\n    useAllDevices: false\n    # \u91cd\u8981: Directories \u5e94\u8be5\u53ea\u5728\u9884\u751f\u4ea7\u73af\u5883\u4e2d\u4f7f\u7528\n    directories:\n    - path: /data/rook\n</code></pre> <p>\u5176\u4e2d\u6709\u51e0\u4e2a\u6bd4\u8f83\u91cd\u8981\u7684\u5b57\u6bb5\uff1a</p> <ul> <li><code>dataDirHostPath</code>\uff1a\u5bbf\u4e3b\u673a\u4e0a\u7684\u76ee\u5f55\uff0c\u7528\u4e8e\u6bcf\u4e2a\u670d\u52a1\u5b58\u50a8\u914d\u7f6e\u548c\u6570\u636e\u3002\u5982\u679c\u76ee\u5f55\u4e0d\u5b58\u5728\uff0c\u4f1a\u81ea\u52a8\u521b\u5efa\u8be5\u76ee\u5f55\u3002\u7531\u4e8e\u6b64\u76ee\u5f55\u5728\u4e3b\u673a\u4e0a\u4fdd\u7559\uff0c\u56e0\u6b64\u5728\u5220\u9664 Pod \u540e\u5c06\u4fdd\u7559\u8be5\u76ee\u5f55\uff0c\u53e6\u5916\u4e0d\u5f97\u4f7f\u7528\u4ee5\u4e0b\u8def\u5f84\u53ca\u5176\u4efb\u4f55\u5b50\u8def\u5f84\uff1a<code>/etc/ceph</code>\u3001<code>/rook</code> \u6216 <code>/var/log/ceph</code>\u3002</li> <li><code>useAllNodes</code>\uff1a\u7528\u4e8e\u8868\u793a\u662f\u5426\u4f7f\u7528\u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u8282\u70b9\u8fdb\u884c\u5b58\u50a8\uff0c\u5982\u679c\u5728 <code>nodes</code> \u5b57\u6bb5\u4e0b\u6307\u5b9a\u4e86\u5404\u4e2a\u8282\u70b9\uff0c\u5219\u5fc5\u987b\u5c06<code>useAllNodes</code>\u8bbe\u7f6e\u4e3a false\u3002</li> <li><code>useAllDevices</code>\uff1a\u8868\u793a OSD \u662f\u5426\u81ea\u52a8\u4f7f\u7528\u8282\u70b9\u4e0a\u7684\u6240\u6709\u8bbe\u5907\uff0c\u4e00\u822c\u8bbe\u7f6e\u4e3a false\uff0c\u8fd9\u6837\u53ef\u63a7\u6027\u8f83\u9ad8</li> <li><code>directories</code>\uff1a\u4e00\u822c\u6765\u8bf4\u5e94\u8be5\u4f7f\u7528\u4e00\u5757\u88f8\u76d8\u6765\u505a\u5b58\u50a8\uff0c\u6709\u65f6\u4e3a\u4e86\u6d4b\u8bd5\u65b9\u4fbf\uff0c\u4f7f\u7528\u4e00\u4e2a\u76ee\u5f55\u4e5f\u662f\u53ef\u4ee5\u7684\uff0c\u5f53\u7136\u751f\u6210\u73af\u5883\u4e0d\u63a8\u8350\u4f7f\u7528\u76ee\u5f55\u3002</li> </ul> <p>\u9664\u4e86\u4e0a\u9762\u8fd9\u4e9b\u5b57\u6bb5\u5c5e\u6027\u4e4b\u5916\u8fd8\u6709\u5f88\u591a\u5176\u4ed6\u53ef\u4ee5\u7ec6\u7c92\u5ea6\u63a7\u5236\u5f97\u53c2\u6570\uff0c\u53ef\u4ee5\u67e5\u770b\u96c6\u7fa4\u914d\u7f6e\u76f8\u5173\u6587\u6863\u3002</p> <p>\u73b0\u5728\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 <code>CephCluster</code> \u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f cluster.yaml \ncephcluster.ceph.rook.io/rook-ceph created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\uff0cRook Operator \u5c31\u4f1a\u6839\u636e\u6211\u4eec\u7684\u63cf\u8ff0\u4fe1\u606f\u53bb\u81ea\u52a8\u521b\u5efa Ceph \u96c6\u7fa4\u4e86\u3002</p>"},{"location":"kubernetes_stroage/ceph/#_10","title":"\u9a8c\u8bc1","text":"<p>\u8981\u9a8c\u8bc1\u96c6\u7fa4\u662f\u5426\u5904\u4e8e\u6b63\u5e38\u72b6\u6001\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Rook \u5de5\u5177\u7bb1 \u6765\u8fd0\u884c <code>ceph status</code> \u547d\u4ee4\u67e5\u770b\u3002</p> <p>Rook \u5de5\u5177\u7bb1\u662f\u4e00\u4e2a\u7528\u4e8e\u8c03\u8bd5\u548c\u6d4b\u8bd5 Rook \u7684\u5e38\u7528\u5de5\u5177\u5bb9\u5668\uff0c\u8be5\u5de5\u5177\u57fa\u4e8e CentOS \u955c\u50cf\uff0c\u6240\u4ee5\u53ef\u4ee5\u4f7f\u7528 yum \u6765\u8f7b\u677e\u5b89\u88c5\u66f4\u591a\u7684\u5de5\u5177\u5305\u3002\u6211\u4eec\u8fd9\u91cc\u7528 Deployment \u63a7\u5236\u5668\u6765\u90e8\u7f72 Rook \u5de5\u5177\u7bb1\uff0c\u90e8\u7f72\u7684\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a\uff08toolbox.yaml\uff09</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: rook-ceph-tools\n  namespace: rook-ceph\n  labels:\n    app: rook-ceph-tools\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: rook-ceph-tools\n  template:\n    metadata:\n      labels:\n        app: rook-ceph-tools\n    spec:\n      dnsPolicy: ClusterFirstWithHostNet\n      containers:\n      - name: rook-ceph-tools\n        image: rook/ceph:v1\n        command: [\"/tini\"]\n        args: [\"-g\", \"--\", \"/usr/local/bin/toolbox.sh\"]\n        imagePullPolicy: IfNotPresent\n        env:\n          - name: ROOK_ADMIN_SECRET\n            valueFrom:\n              secretKeyRef:\n                name: rook-ceph-mon\n                key: admin-secret\n        securityContext:\n          privileged: true\n        volumeMounts:\n          - mountPath: /dev\n            name: dev\n          - mountPath: /sys/bus\n            name: sysbus\n          - mountPath: /lib/modules\n            name: libmodules\n          - name: mon-endpoint-volume\n            mountPath: /etc/rook\n      # \u5982\u679c\u8bbe\u7f6e hostNetwork: false,  \"rbd map\" \u547d\u4ee4\u4f1a\u88ab hang \u4f4f, \u53c2\u8003 https://github.com/rook/rook/issues/2021\n      hostNetwork: true\n      volumes:\n        - name: dev\n          hostPath:\n            path: /dev\n        - name: sysbus\n          hostPath:\n            path: /sys/bus\n        - name: libmodules\n          hostPath:\n            path: /lib/modules\n        - name: mon-endpoint-volume\n          configMap:\n            name: rook-ceph-mon-endpoints\n            items:\n            - key: data\n              path: mon-endpoints\n</code></pre> <p>\u7136\u540e\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a Pod\uff1a</p> <pre><code>$ kubectl apply -f toolbox.yaml\ndeployment.apps/rook-ceph-tools created\n</code></pre> <p>\u4e00\u65e6 toolbox \u7684 Pod \u8fd0\u884c\u6210\u529f\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u8fdb\u5165\u5230\u5de5\u5177\u7bb1\u5185\u90e8\u8fdb\u884c\u64cd\u4f5c\uff1a</p> <pre><code>$ kubectl -n rook-ceph exec -it $(kubectl -n rook-ceph get pod -l \"app=rook-ceph-tools\" -o jsonpath='{.items[0].metadata.name}') bash\n</code></pre> <p>\u5de5\u5177\u7bb1\u4e2d\u7684\u6240\u6709\u53ef\u7528\u5de5\u5177\u547d\u4ee4\u5747\u5df2\u51c6\u5907\u5c31\u7eea\uff0c\u53ef\u6ee1\u8db3\u60a8\u7684\u6545\u969c\u6392\u9664\u9700\u6c42\u3002\u4f8b\u5982\uff1a</p> <pre><code>ceph status\nceph osd status\nceph df\nrados df\n</code></pre> <p>\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u8981\u67e5\u770b\u96c6\u7fa4\u7684\u72b6\u6001\uff0c\u9700\u8981\u6ee1\u8db3\u4e0b\u9762\u7684\u6761\u4ef6\u624d\u8ba4\u4e3a\u662f\u5065\u5eb7\u7684\uff1a</p> <ul> <li>\u6240\u6709 mons \u5e94\u8be5\u8fbe\u5230\u6cd5\u5b9a\u6570\u91cf</li> <li>mgr \u5e94\u8be5\u662f\u6fc0\u6d3b\u72b6\u6001</li> <li>\u81f3\u5c11\u6709\u4e00\u4e2a OSD \u5904\u4e8e\u6fc0\u6d3b\u72b6\u6001</li> <li>\u5982\u679c\u4e0d\u662f HEALTH_OK \u72b6\u6001\uff0c\u5219\u5e94\u8be5\u67e5\u770b\u544a\u8b66\u6216\u8005\u9519\u8bef\u4fe1\u606f</li> </ul> <pre><code>$ ceph status\nceph status\n  cluster:\n    id:     dae083e6-8487-447b-b6ae-9eb321818439\n    health: HEALTH_OK\n\n  services:\n    mon: 3 daemons, quorum a,b,c (age 15m)\n    mgr: a(active, since 2m)\n    osd: 31 osds: 2 up (since 6m), 2 in (since 6m)\n\n  data:\n    pools:   0 pools, 0 pgs\n    objects: 0 objects, 0 B\n    usage:   79 GiB used, 314 GiB / 393 GiB avail\n    pgs:\n</code></pre> <p>\u5982\u679c\u7fa4\u96c6\u8fd0\u884c\u4e0d\u6b63\u5e38\uff0c\u53ef\u4ee5\u67e5\u770b Ceph \u5e38\u89c1\u95ee\u9898\u4ee5\u4e86\u89e3\u66f4\u591a\u8be6\u7ec6\u4fe1\u606f\u548c\u53ef\u80fd\u7684\u89e3\u51b3\u65b9\u6848\u3002</p>"},{"location":"kubernetes_stroage/ceph/#dashboard","title":"Dashboard","text":"<p>Ceph \u6709\u4e00\u4e2a Dashboard \u5de5\u5177\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u4e0a\u9762\u67e5\u770b\u96c6\u7fa4\u7684\u72b6\u6001\uff0c\u5305\u62ec\u603b\u4f53\u8fd0\u884c\u72b6\u6001\uff0cmgr\u3001osd \u548c\u5176\u4ed6 Ceph \u8fdb\u7a0b\u7684\u72b6\u6001\uff0c\u67e5\u770b\u6c60\u548c PG \u72b6\u6001\uff0c\u4ee5\u53ca\u663e\u793a\u5b88\u62a4\u8fdb\u7a0b\u7684\u65e5\u5fd7\u7b49\u7b49\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u5728\u4e0a\u9762\u7684 cluster CRD \u5bf9\u8c61\u4e2d\u5f00\u542f dashboard\uff0c\u8bbe\u7f6e</p> <pre><code>dashboard.enable=true\n</code></pre> <p>\u5373\u53ef\uff0c\u8fd9\u6837 Rook Operator \u5c31\u4f1a\u542f\u7528 ceph-mgr dashboard \u6a21\u5757\uff0c\u5e76\u5c06\u521b\u5efa\u4e00\u4e2a Kubernetes Service \u6765\u66b4\u9732\u8be5\u670d\u52a1\uff0c\u5c06\u542f\u7528\u7aef\u53e3 7000 \u8fdb\u884c https \u8bbf\u95ee\uff0c\u5982\u679c Ceph \u96c6\u7fa4\u90e8\u7f72\u6210\u529f\u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u67e5\u770b Dashboard \u7684 Service\uff1a</p> <pre><code>$ kubectl get svc -n rook-ceph\nNAME                         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE\nrook-ceph-mgr              ClusterIP   1       &lt;none&gt;        9283/TCP            3m6s\nrook-ceph-mgr-dashboard    ClusterIP   11180   &lt;none&gt;        7000/TCP            3m29s\n</code></pre> <p>\u8fd9\u91cc\u7684 rook-ceph-mgr \u670d\u52a1\u7528\u4e8e\u62a5\u544a Prometheus metrics \u6307\u6807\u6570\u636e\u7684\uff0c\u800c\u540e\u9762\u7684\u7684 rook-ceph-mgr-dashboard \u670d\u52a1\u5c31\u662f\u6211\u4eec\u7684 Dashboard \u670d\u52a1\uff0c\u5982\u679c\u5728\u96c6\u7fa4\u5185\u90e8\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 DNS \u540d\u79f0 </p> <pre><code>http://rook-ceph-mgr-dashboard.rook-ceph:7000\n</code></pre> <p>\u6216\u8005 CluterIP </p> <pre><code>http://11180:7000\n</code></pre> <p>\u6765\u8fdb\u884c\u8bbf\u95ee\uff0c\u4f46\u662f\u5982\u679c\u8981\u5728\u96c6\u7fa4\u5916\u90e8\u8fdb\u884c\u8bbf\u95ee\u7684\u8bdd\uff0c\u6211\u4eec\u5c31\u9700\u8981\u901a\u8fc7 Ingress \u6216\u8005 NodePort \u7c7b\u578b\u7684 Service \u6765\u66b4\u9732\u4e86\uff0c\u4e3a\u4e86\u65b9\u4fbf\u6d4b\u8bd5\u6211\u4eec\u8fd9\u91cc\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 NodePort \u7c7b\u578b\u7684\u670d\u52a1\u6765\u8bbf\u95ee Dashboard\uff0c\u8d44\u6e90\u6e05\u5355\u5982\u4e0b\u6240\u793a\uff1a\uff08dashboard-external.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: rook-ceph-mgr-dashboard-external\n  namespace: rook-ceph\n  labels:\n    app: rook-ceph-mgr\n    rook_cluster: rook-ceph\nspec:\n  ports:\n  - name: dashboard\n    port: 7000\n    protocol: TCP\n    targetPort: 7000\n  selector:\n    app: rook-ceph-mgr\n    rook_cluster: rook-ceph\n  type: NodePort\n</code></pre> <p>\u540c\u6837\u76f4\u63a5\u521b\u5efa\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f dashboard-external.yaml\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5230\u65b0\u521b\u5efa\u7684 rook-ceph-mgr-dashboard-external \u8fd9\u4e2a Service \u670d\u52a1\uff1a</p> <pre><code>$ kubectl get svc -n rook-ceph \nNAME                                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE\nrook-ceph-mgr                           ClusterIP   29     &lt;none&gt;        9283/TCP            23m\nrook-ceph-mgr-dashboard                 ClusterIP   198     &lt;none&gt;        7000/TCP            23m\nrook-ceph-mgr-dashboard-external   NodePort    1223    &lt;none&gt;        7000:31361/TCP      14s\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u9700\u8981\u901a\u8fc7 </p> <pre><code>http://&lt;NodeIp&gt;:31361\n</code></pre> <p>\u5c31\u53ef\u4ee5\u8bbf\u95ee\u5230 Dashboard \u4e86\u3002</p> <p></p> <p>\u4f46\u662f\u5728\u8bbf\u95ee\u7684\u65f6\u5019\u9700\u8981\u6211\u4eec\u767b\u5f55\u624d\u80fd\u591f\u8bbf\u95ee\uff0cRook \u521b\u5efa\u4e86\u4e00\u4e2a\u9ed8\u8ba4\u7684\u7528\u6237 admin\uff0c\u5e76\u5728\u8fd0\u884c Rook \u7684\u547d\u540d\u7a7a\u95f4\u4e2d\u751f\u6210\u4e86\u4e00\u4e2a\u540d\u4e3a </p> <pre><code>rook-ceph-dashboard-admin-password\n</code></pre> <p>\u7684 Secret\uff0c\u8981\u83b7\u53d6\u5bc6\u7801\uff0c\u53ef\u4ee5\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ kubectl -n rook-ceph get secret rook-ceph-dashboard-password -o jsonpath=\"{['data']['password']}\" | base64 --decode &amp;&amp; echo\nxxxx\uff08\u767b\u5f55\u5bc6\u7801\uff09\n</code></pre> <p>\u7528\u4e0a\u9762\u83b7\u5f97\u7684\u5bc6\u7801\u548c\u7528\u6237\u540d admin \u5c31\u53ef\u4ee5\u767b\u5f55 Dashboard \u4e86\uff0c\u5728 Dashboard \u4e0a\u9762\u53ef\u4ee5\u67e5\u770b\u5230\u6574\u4e2a\u96c6\u7fa4\u7684\u72b6\u6001\uff1a</p> <p></p>"},{"location":"kubernetes_stroage/ceph/#_11","title":"\u4f7f\u7528","text":"<p>\u73b0\u5728\u6211\u4eec\u7684 Ceph \u96c6\u7fa4\u642d\u5efa\u6210\u529f\u4e86\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u6765\u4f7f\u7528\u5b58\u50a8\u4e86\u3002\u9996\u5148\u6211\u4eec\u9700\u8981\u521b\u5efa\u5b58\u50a8\u6c60\uff0c\u53ef\u4ee5\u7528 CRD \u6765\u5b9a\u4e49 Pool\u3002Rook \u63d0\u4f9b\u4e86\u4e24\u79cd\u673a\u5236\u6765\u7ef4\u6301 OSD\uff1a</p> <ul> <li>\u526f\u672c\uff1a\u7f3a\u7701\u9009\u9879\uff0c\u6bcf\u4e2a\u5bf9\u8c61\u90fd\u4f1a\u6839\u636e <code>spec.replicated.size</code> \u5728\u591a\u4e2a\u78c1\u76d8\u4e0a\u8fdb\u884c\u590d\u5236\u3002\u5efa\u8bae\u975e\u751f\u4ea7\u73af\u5883\u81f3\u5c11 2 \u4e2a\u526f\u672c\uff0c\u751f\u4ea7\u73af\u5883\u81f3\u5c11 3 \u4e2a\u3002</li> <li> <p>Erasure Code\uff1a\u662f\u4e00\u79cd\u8f83\u4e3a\u8282\u7ea6\u7684\u65b9\u5f0f\u3002EC \u628a\u6570\u636e\u62c6\u5206 n \u6bb5\uff08</p> <pre><code>spec.erasureCoded.dataChunks\n</code></pre> <p>\uff09\uff0c\u518d\u52a0\u5165 k \u4e2a\u4ee3\u7801\u6bb5\uff08</p> <pre><code>spec.erasureCoded.codingChunks\n</code></pre> <p>\uff09\uff0c\u7528\u5206\u5e03\u7684\u65b9\u5f0f\u628a <code>n+k</code> \u6bb5\u6570\u636e\u4fdd\u5b58\u5728\u78c1\u76d8\u4e0a\u3002\u8fd9\u79cd\u60c5\u51b5\u4e0b Ceph \u80fd\u591f\u9694\u79bb k \u4e2a OSD \u7684\u635f\u5931\u3002</p> </li> </ul> <p>\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u526f\u672c\u7684\u65b9\u5f0f\uff0c\u521b\u5efa\u5982\u4e0b\u6240\u793a\u7684 RBD \u7c7b\u578b\u7684\u5b58\u50a8\u6c60\uff1a(pool.yaml)</p> <pre><code>apiVersion: ceph.rook.io/v1\nkind: CephBlockPool\nmetadata:\n  name: k8s-test-pool   # operator\u4f1a\u76d1\u542c\u5e76\u521b\u5efa\u4e00\u4e2apool\uff0c\u6267\u884c\u5b8c\u540e\u754c\u9762\u4e0a\u4e5f\u80fd\u770b\u5230\u5bf9\u5e94\u7684pool\n  namespace: rook-ceph\nspec:\n  failureDomain: host  # \u6570\u636e\u5757\u7684\u6545\u969c\u57df: \u503c\u4e3ahost\u65f6\uff0c\u6bcf\u4e2a\u6570\u636e\u5757\u5c06\u653e\u7f6e\u5728\u4e0d\u540c\u7684\u4e3b\u673a\u4e0a;\u503c\u4e3aosd\u65f6\uff0c\u6bcf\u4e2a\u6570\u636e\u5757\u5c06\u653e\u7f6e\u5728\u4e0d\u540c\u7684osd\u4e0a\n  replicated:\n    size: 3   # \u6c60\u4e2d\u6570\u636e\u7684\u526f\u672c\u6570,1\u5c31\u662f\u4e0d\u4fdd\u5b58\u4efb\u4f55\u526f\u672c\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f pool.yaml \ncephblockpool.ceph.rook.io/k8s-test-pool created\n</code></pre> <p>\u5b58\u50a8\u6c60\u521b\u5efa\u5b8c\u6210\u540e\u6211\u4eec\u5728 Dashboard \u4e0a\u9762\u7684\u786e\u53ef\u4ee5\u770b\u5230\u65b0\u589e\u4e86\u4e00\u4e2a pool\uff0c\u4f46\u662f\u4f1a\u53d1\u73b0\u96c6\u7fa4\u5065\u5eb7\u72b6\u6001\u53d8\u6210\u4e86 <code>WARN</code>\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5230\u6709\u5982\u4e0b\u65e5\u5fd7\u51fa\u73b0\uff1a</p> <pre><code>Health check update: too few PGs per OSD (6 &lt; min 30) (TOO_FEW_PGS)\n</code></pre> <p>\u8fd9\u662f\u56e0\u4e3a\u6bcf\u4e2a osd \u4e0a\u7684 pg \u6570\u91cf\u5c0f\u4e8e\u6700\u5c0f\u7684\u6570\u76ee30\u4e2a\u3002pgs \u4e3a8\uff0c\u56e0\u4e3a\u662f3\u526f\u672c\u7684\u914d\u7f6e\uff0c\u6240\u4ee5\u5f53\u67094\u4e2a osd \u7684\u65f6\u5019\uff0c\u6bcf\u4e2a osd \u4e0a\u5747\u5206\u4e868/4 *3=6\u4e2apgs\uff0c\u4e5f\u5c31\u662f\u51fa\u73b0\u4e86\u5982\u4e0a\u7684\u9519\u8bef\u5c0f\u4e8e\u6700\u5c0f\u914d\u7f6e30\u4e2a\uff0c\u96c6\u7fa4\u8fd9\u79cd\u72b6\u6001\u5982\u679c\u8fdb\u884c\u6570\u636e\u7684\u5b58\u50a8\u548c\u64cd\u4f5c\uff0c\u96c6\u7fa4\u4f1a\u5361\u6b7b\uff0c\u65e0\u6cd5\u54cd\u5e94io\uff0c\u540c\u65f6\u4f1a\u5bfc\u81f4\u5927\u9762\u79ef\u7684 osd down\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u8fdb\u5165 toolbox \u7684\u5bb9\u5668\u4e2d\u67e5\u770b\u4e0a\u9762\u5b58\u50a8\u7684 pg \u6570\u91cf\uff1a</p> <pre><code>$ ceph osd pool get k8s-test-pool pg_num\npg_num: 8\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u589e\u52a0 pg_num \u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff1a</p> <pre><code>$ ceph osd pool set k8s-test-pool pg_num 64\nset pool 1 pg_num to 64\n$ ceph -s\n  cluster:\n    id:     7851387c-5d18-489a-8c04-b699fb9764c0\n    health: HEALTH_OK\n\n  services:\n    mon: 3 daemons, quorum a,b,c (age 33m)\n    mgr: a(active, since 32m)\n    osd: 4 osds: 4 up (since 32m), 4 in (since 32m)\n\n  data:\n    pools:   1 pools, 64 pgs\n    objects: 0 objects, 0 B\n    usage:   182 GiB used, 605 GiB / 787 GiB avail\n    pgs:     64 active+clean\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u518d\u67e5\u770b\u5c31\u53ef\u4ee5\u770b\u5230\u73b0\u5728\u5c31\u662f\u5065\u5eb7\u72b6\u6001\u4e86\u3002\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\u6211\u4eec\u8fd9\u91cc\u7684 pool \u4e0a\u6ca1\u6709\u6570\u636e\uff0c\u6240\u4ee5\u4fee\u6539 pg \u5f71\u54cd\u5e76\u4e0d\u5927\uff0c\u4f46\u662f\u5982\u679c\u662f\u751f\u4ea7\u73af\u5883\u91cd\u65b0\u4fee\u6539 pg \u6570\uff0c\u4f1a\u5bf9\u751f\u4ea7\u73af\u5883\u4ea7\u751f\u8f83\u5927\u5f71\u54cd\u3002\u56e0\u4e3a pg \u6570\u53d8\u4e86\uff0c\u5c31\u4f1a\u5bfc\u81f4\u6574\u4e2a\u96c6\u7fa4\u7684\u6570\u636e\u91cd\u65b0\u5747\u8861\u548c\u8fc1\u79fb\uff0c\u6570\u636e\u8d8a\u5927\u54cd\u5e94 io \u7684\u65f6\u95f4\u4f1a\u8d8a\u957f\u3002\u6240\u4ee5\uff0c\u6700\u597d\u5728\u4e00\u5f00\u59cb\u5c31\u8bbe\u7f6e\u597d pg \u6570\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a StorageClass \u6765\u8fdb\u884c\u52a8\u6001\u5b58\u50a8\u914d\u7f6e\uff0c\u5982\u4e0b\u6240\u793a\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a Ceph \u7684\u5757\u5b58\u50a8\u7684 StorageClass\uff1a(storageclass.yaml)</p> <pre><code>apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: rook-ceph-block\nprovisioner: rook-ceph.rbd.csi.ceph.com\nparameters:\n  # clusterID \u662f rook \u96c6\u7fa4\u8fd0\u884c\u7684\u547d\u540d\u7a7a\u95f4\n  clusterID: rook-ceph\n\n  # \u6307\u5b9a\u5b58\u50a8\u6c60\n  pool: k8s-test-pool\n\n  # RBD image (\u5b9e\u9645\u7684\u5b58\u50a8\u4ecb\u8d28) \u683c\u5f0f. \u9ed8\u8ba4\u4e3a \"2\".\n  imageFormat: \"2\"\n\n  # RBD image \u7279\u6027. CSI RBD \u73b0\u5728\u53ea\u652f\u6301 `layering` .\n  imageFeatures: layering\n\n  # Ceph \u7ba1\u7406\u5458\u8ba4\u8bc1\u4fe1\u606f\uff0c\u8fd9\u4e9b\u90fd\u662f\u5728 clusterID \u547d\u540d\u7a7a\u95f4\u4e0b\u9762\u81ea\u52a8\u751f\u6210\u7684\n  csi.storage.k8s.io/provisioner-secret-name: rook-csi-rbd-provisioner\n  csi.storage.k8s.io/provisioner-secret-namespace: rook-ceph\n  csi.storage.k8s.io/node-stage-secret-name: rook-csi-rbd-node\n  csi.storage.k8s.io/node-stage-secret-namespace: rook-ceph\n  # \u6307\u5b9a volume \u7684\u6587\u4ef6\u7cfb\u7edf\u683c\u5f0f\uff0c\u5982\u679c\u4e0d\u6307\u5b9a, csi-provisioner \u4f1a\u9ed8\u8ba4\u8bbe\u7f6e\u4e3a `ext4`\n  csi.storage.k8s.io/fstype: ext4\n# uncomment the following to use rbd-nbd as mounter on supported nodes\n# **IMPORTANT**: If you are using rbd-nbd as the mounter, during upgrade you will be hit a ceph-csi\n# issue that causes the mount to be disconnected. You will need to follow special upgrade steps\n# to restart your application pods. Therefore, this option is not recommended.\n#mounter: rbd-nbd\nreclaimPolicy: Delete\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 StorageClass \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f storageclass.yaml \nstorageclass.storage.k8s.io/rook-ceph-block created\n$ kubectl get storageclass\nNAME              PROVISIONER                    AGE\nrook-ceph-block   rook-ceph.rbd.csi.ceph.com     35s\n</code></pre> <p>\u7136\u540e\u521b\u5efa\u4e00\u4e2a PVC \u6765\u4f7f\u7528\u4e0a\u9762\u7684 StorageClass \u5bf9\u8c61\uff1a(pvc.yaml)</p> <pre><code>apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: mysql-pv-claim\n  labels:\n    app: wordpress\nspec:\n  storageClassName: rook-ceph-block\n  accessModes:\n  - ReadWriteOnce\n  resources:\n    requests:\n      storage: 20Gi\n</code></pre> <p>\u540c\u6837\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684 PVC \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f pvc.yaml \npersistentvolumeclaim/mysql-pv-claim created\n$ kubectl get pvc -l app=wordpress\nNAME             STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS      AGE\nmysql-pv-claim   Bound    pvc-1eab82e3-d214-4d8e-8fcc-ed379c24e0e3   20Gi       RWO            rook-ceph-block   32m\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6211\u4eec\u7684 PVC \u5bf9\u8c61\u5df2\u7ecf\u662f Bound \u72b6\u6001\u4e86\uff0c\u81ea\u52a8\u521b\u5efa\u4e86\u5bf9\u5e94\u7684 PV\uff0c\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a PVC \u5bf9\u8c61\u6765\u505a\u6570\u636e\u6301\u4e45\u5316\u64cd\u4f5c\u4e86\u3002</p> <p>\u8fd9\u4e2a\u65f6\u5019\u53ef\u80fd\u96c6\u7fa4\u8fd8\u4f1a\u51fa\u73b0\u5982\u4e0b\u7684\u5065\u5eb7\u63d0\u793a\uff1a</p> <pre><code>$ ceph health detail\nHEALTH_WARN application not enabled on 1 pool(s)\nPOOL_APP_NOT_ENABLED application not enabled on 1 pool(s)\n    application not enabled on pool 'k8s-test-pool'\n    use 'ceph osd pool application enable &lt;pool-name&gt; &lt;app-name&gt;', where &lt;app-name&gt; is 'cephfs', 'rbd', 'rgw', or freeform for custom applications.\n$ ceph osd pool application enable k8s-test-pool k8srbd\nenabled application 'k8srbd' on pool 'k8s-test-pool'\n</code></pre> <p>\u6839\u636e\u63d0\u793a\u542f\u7528\u4e00\u4e2a application \u5373\u53ef\u3002</p> <p>\u5728\u5b98\u65b9\u4ed3\u5e93 cluster/examples/kubernetes \u76ee\u5f55\u4e0b\uff0c\u5b98\u65b9\u7ed9\u4e86\u4e2a wordpress \u7684\u4f8b\u5b50\uff0c\u53ef\u4ee5\u76f4\u63a5\u8fd0\u884c\u6d4b\u8bd5\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f mysql.yaml\n$ kubectl apply -f wordpress.yaml\n</code></pre> <p>\u5b98\u65b9\u7684\u8fd9\u4e2a\u793a\u4f8b\u91cc\u9762\u7684 wordpress \u7528\u7684 Loadbalancer \u7c7b\u578b\uff0c\u6211\u4eec\u53ef\u4ee5\u6539\u6210 NodePort\uff1a</p> <pre><code>$ kubectl get pvc -l app=wordpress\nNAME             STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS      AGE\nmysql-pv-claim   Bound    pvc-1eab82e3-d214-4d8e-8fcc-ed379c24e0e3   20Gi       RWO            rook-ceph-block   12h\nwp-pv-claim      Bound    pvc-237932ed-5ca7-468c-bd16-220ebb2a1ce3   20Gi       RWO            rook-ceph-block   25s\n$ kubectl get pods -l app=wordpress               \nNAME                              READY   STATUS    RESTARTS   AGE\nwordpress-5b886cf59b-4xwn8        1/1     Running   0          24m\nwordpress-mysql-b9ddd6d4c-qhjd4   1/1     Running   0          24m\n$ kubectl get svc -l app=wordpress\nNAME              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE\nwordpress         NodePort    12225   &lt;none&gt;        80:30307/TCP   80s\nwordpress-mysql   ClusterIP   None             &lt;none&gt;        3306/TCP       87s\n</code></pre> <p>\u5f53\u5e94\u7528\u90fd\u5904\u4e8e Running \u72b6\u6001\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 </p> <pre><code>http://&lt;\u4efb\u610f\u8282\u70b9IP&gt;:30307\n</code></pre> <p>\u53bb\u8bbf\u95ee wordpress \u5e94\u7528\uff1a</p> <p></p> <p>\u6bd4\u5982\u6211\u4eec\u5728\u7b2c\u4e00\u7bc7\u6587\u7ae0\u4e2d\u66f4\u6539\u4e0b\u5185\u5bb9\uff0c\u7136\u540e\u6211\u4eec\u5c06\u5e94\u7528 Pod \u5168\u90e8\u5220\u9664\u91cd\u5efa\uff1a</p> <pre><code>$ kubectl delete pod wordpress-mysql-b9ddd6d4c-qhjd4 wordpress-5b886cf59b-4xwn8\npod \"wordpress-mysql-b9ddd6d4c-qhjd4\" deleted\npod \"wordpress-5b886cf59b-4xwn8\" deleted\n$ kubectl get pods -l app=wordpress                                            \nNAME                              READY   STATUS    RESTARTS   AGE\nwordpress-5b886cf59b-kwxk4        1/1     Running   0          2m52s\nwordpress-mysql-b9ddd6d4c-kkcr7   1/1     Running   0          2m52s\n</code></pre> <p>\u5f53 Pod \u91cd\u5efa\u5b8c\u6210\u540e\u518d\u6b21\u8bbf\u95ee wordpress \u5e94\u7528\u7684\u4e3b\u9875\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\u4e4b\u524d\u6211\u4eec\u6dfb\u52a0\u7684\u6570\u636e\u4ecd\u7136\u5b58\u5728\uff0c\u8fd9\u5c31\u8bc1\u660e\u6211\u4eec\u7684\u6570\u636e\u6301\u4e45\u5316\u662f\u6b63\u786e\u7684\u3002</p>"},{"location":"kubernetes_stroage/csi/","title":"\u5b58\u50a8\u539f\u7406","text":"<p>\ue3c9</p>"},{"location":"kubernetes_stroage/csi/#_1","title":"\u5b58\u50a8\u539f\u7406","text":"<p>\u524d\u9762\u7684\u7ae0\u8282\u4e2d\u6211\u4eec\u4ecb\u7ecd\u4e86\u5728 Kubernetes \u4e2d\u7684\u6301\u4e45\u5316\u5b58\u50a8\u7684\u4f7f\u7528\uff0c\u4e86\u89e3\u4e86 PV\u3001PVC \u4ee5\u53ca StorageClass \u7684\u4f7f\u7528\u65b9\u6cd5\uff0c\u4ece\u672c\u5730\u5b58\u50a8\u5230 Ceph \u5171\u4eab\u5b58\u50a8\u90fd\u6709\u5b66\u4e60\uff0c\u5230\u8fd9\u91cc\u6211\u4eec\u5176\u5b9e\u5df2\u7ecf\u53ef\u4ee5\u5b8c\u6210\u5e94\u7528\u5404\u79cd\u573a\u666f\u7684\u6570\u636e\u6301\u4e45\u5316\u4e86\uff0c\u4f46\u662f\u96be\u514d\u5728\u5b9e\u9645\u7684\u4f7f\u7528\u8fc7\u7a0b\u4e2d\u4f1a\u9047\u5230\u5404\u79cd\u5404\u6837\u7684\u95ee\u9898\uff0c\u8981\u89e3\u51b3\u8fd9\u4e9b\u95ee\u9898\u6700\u597d\u7684\u65b9\u5f0f\u5c31\u662f\u6765\u4e86\u89e3\u4e0b Kubernetes \u4e2d\u5b58\u50a8\u7684\u5b9e\u73b0\u539f\u7406\u3002</p> <p>Kubernetes \u9ed8\u8ba4\u60c5\u51b5\u4e0b\u5c31\u63d0\u4f9b\u4e86\u4e3b\u6d41\u7684\u5b58\u50a8\u5377\u63a5\u5165\u65b9\u6848\uff0c\u6211\u4eec\u53ef\u4ee5\u6267\u884c\u547d\u4ee4 </p> <pre><code>kubectl explain pod.spec.volumes\n</code></pre> <p>\u67e5\u770b\u5230\u652f\u6301\u7684\u5404\u79cd\u5b58\u50a8\u5377\uff0c\u53e6\u5916\u4e5f\u63d0\u4f9b\u4e86\u63d2\u4ef6\u673a\u5236\uff0c\u5141\u8bb8\u5176\u4ed6\u7c7b\u578b\u7684\u5b58\u50a8\u670d\u52a1\u63a5\u5165\u5230 Kubernetes \u7cfb\u7edf\u4e2d\u6765\uff0c\u5728 Kubernetes \u4e2d\u5c31\u5bf9\u5e94 <code>In-Tree</code> \u548c <code>Out-Of-Tree</code> \u4e24\u79cd\u65b9\u5f0f\uff0c<code>In-Tree</code> \u5c31\u662f\u5728 Kubernetes \u6e90\u7801\u5185\u90e8\u5b9e\u73b0\u7684\uff0c\u548c Kubernetes \u4e00\u8d77\u53d1\u5e03\u3001\u7ba1\u7406\u7684\uff0c\u4f46\u662f\u66f4\u65b0\u8fed\u4ee3\u6162\u3001\u7075\u6d3b\u6027\u6bd4\u8f83\u5dee\uff0c<code>Out-Of-Tree</code> \u662f\u72ec\u7acb\u4e8e Kubernetes \u7684\uff0c\u76ee\u524d\u4e3b\u8981\u6709 <code>CSI</code> \u548c <code>FlexVolume</code> \u4e24\u79cd\u673a\u5236\uff0c\u5f00\u53d1\u8005\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u5b58\u50a8\u7c7b\u578b\u5b9e\u73b0\u4e0d\u540c\u7684\u5b58\u50a8\u63d2\u4ef6\u63a5\u5165\u5230 Kubernetes \u4e2d\u53bb\uff0c\u5176\u4e2d <code>CSI</code> \u662f\u73b0\u5728\u4e5f\u662f\u4ee5\u540e\u4e3b\u6d41\u7684\u65b9\u5f0f\uff0c\u6240\u4ee5\u5f53\u7136\u6211\u4eec\u7684\u91cd\u70b9\u4e5f\u4f1a\u662f <code>CSI</code> \u7684\u4f7f\u7528\u4ecb\u7ecd\u3002</p>"},{"location":"kubernetes_stroage/csi/#_2","title":"\u5b58\u50a8\u67b6\u6784","text":"<p>\u524d\u9762\u6211\u4eec\u4e86\u89e3\u5230\u4e86 PV\u3001PVC\u3001StorgeClass \u7684\u4f7f\u7528\uff0c\u4f46\u662f\u4ed6\u4eec\u662f\u5982\u4f55\u548c\u6211\u4eec\u7684 Pod \u5173\u8054\u8d77\u6765\u4f7f\u7528\u7684\u5462\uff1f\u8fd9\u5c31\u9700\u8981\u4ece Volume \u7684\u5904\u7406\u6d41\u7a0b\u548c\u539f\u7406\u8bf4\u8d77\u4e86\u3002</p> <p>\u5982\u4e0b\u6240\u793a\uff0c\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2a nfs \u7c7b\u578b\u7684 PV \u8d44\u6e90\u5bf9\u8c61\uff1a\uff08volume.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: nfs-pv\nspec:\n  storageClassName: manual\n  capacity: \n    storage: 1Gi\n  accessModes:\n  - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Retain\n  nfs:\n    path: /data/k8s  # \u6307\u5b9anfs\u7684\u6302\u8f7d\u70b9\n    server: 111  # \u6307\u5b9anfs\u670d\u52a1\u5730\u5740\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: nfs-pvc\nspec:\n  storageClassName: manual\n  accessModes:\n  - ReadWriteOnce\n  resources:\n    requests:\n      storage: 1Gi\n</code></pre> <p>\u6211\u4eec\u77e5\u9053\u7528\u6237\u771f\u6b63\u4f7f\u7528\u7684\u662f PVC\uff0c\u800c\u8981\u4f7f\u7528 PVC \u7684\u524d\u63d0\u5c31\u662f\u5fc5\u987b\u8981\u5148\u548c\u67d0\u4e2a\u7b26\u5408\u6761\u4ef6\u7684 PV \u8fdb\u884c\u4e00\u4e00\u7ed1\u5b9a\uff0c\u6bd4\u5982\u5b58\u50a8\u5bb9\u5668\u3001\u8bbf\u95ee\u6a21\u5f0f\uff0c\u4ee5\u53ca PV \u548c PVC \u7684 storageClassName \u5b57\u6bb5\u5fc5\u987b\u4e00\u6837\uff0c\u8fd9\u6837\u624d\u80fd\u591f\u8fdb\u884c\u7ed1\u5b9a\uff0c\u5f53 PVC \u548c PV \u7ed1\u5b9a\u6210\u529f\u540e\u5c31\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e2a PVC \u5bf9\u8c61\u4e86\uff1a(pod.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: test-volumes\nspec:\n  volumes:\n  - name: nfs\n    persistentVolumeClaim:\n      claimName: nfs-pvc\n  containers:\n  - name: web\n    image: nginx\n    ports:\n    - name: web\n      containerPort: 80\n    volumeMounts:\n    - name: nfs\n      subPath: test-volumes\n      mountPath: \"/usr/share/nginx/html\"\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f volume.yaml\n$ kubectl apply -f pod.yaml\n</code></pre> <p>\u6211\u4eec\u53ea\u662f\u5728 volumes \u4e2d\u6307\u5b9a\u4e86\u6211\u4eec\u4e0a\u9762\u521b\u5efa\u7684 PVC \u5bf9\u8c61\uff0c\u5f53\u8fd9\u4e2a Pod \u88ab\u521b\u5efa\u4e4b\u540e\uff0c kubelet \u5c31\u4f1a\u628a\u8fd9\u4e2a PVC \u5bf9\u5e94\u7684\u8fd9\u4e2a NFS \u7c7b\u578b\u7684 Volume\uff08PV\uff09\u6302\u8f7d\u5230\u8fd9\u4e2a Pod \u5bb9\u5668\u4e2d\u7684\u76ee\u5f55\u4e2d\u53bb\u3002\u524d\u9762\u6211\u4eec\u4e5f\u63d0\u5230\u4e86\u8fd9\u6837\u7684\u8bdd\u5bf9\u4e8e\u666e\u901a\u7528\u6237\u6765\u8bf4\u5b8c\u5168\u5c31\u4e0d\u7528\u5173\u5fc3\u540e\u9762\u7684\u5177\u4f53\u5b58\u50a8\u5728 NFS \u8fd8\u662f Ceph \u6216\u8005\u5176\u4ed6\u4e86\uff0c\u53ea\u9700\u8981\u76f4\u63a5\u4f7f\u7528 PVC \u5c31\u53ef\u4ee5\u4e86\uff0c\u56e0\u4e3a\u771f\u6b63\u7684\u5b58\u50a8\u662f\u9700\u8981\u5f88\u591a\u76f8\u5173\u7684\u4e13\u4e1a\u77e5\u8bc6\u7684\uff0c\u8fd9\u6837\u5c31\u5b8c\u5168\u804c\u8d23\u5206\u79bb\u89e3\u8026\u4e86\u3002</p> <p>\u666e\u901a\u7528\u6237\u76f4\u63a5\u4f7f\u7528 PVC \u6ca1\u6709\u95ee\u9898\uff0c\u4f46\u662f\u4e5f\u4f1a\u51fa\u73b0\u4e00\u4e2a\u95ee\u9898\uff0c\u90a3\u5c31\u662f\u5f53\u666e\u901a\u7528\u6237\u521b\u5efa\u4e00\u4e2a PVC \u5bf9\u8c61\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u65f6\u5019\u7cfb\u7edf\u91cc\u9762\u5e76\u6ca1\u6709\u5408\u9002\u7684 PV \u6765\u548c\u5b83\u8fdb\u884c\u7ed1\u5b9a\uff0c\u56e0\u4e3a PV \u5927\u591a\u6570\u60c5\u51b5\u4e0b\u662f\u7ba1\u7406\u5458\u7ed9\u6211\u4eec\u521b\u5efa\u7684\uff0c\u8fd9\u4e2a\u65f6\u5019\u542f\u52a8 Pod \u80af\u5b9a\u5c31\u4f1a\u5931\u8d25\u4e86\uff0c\u5982\u679c\u73b0\u5728\u7ba1\u7406\u5458\u5982\u679c\u53bb\u521b\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7684 PV \u7684\u8bdd\uff0cPVC \u548c PV \u5f53\u7136\u5c31\u53ef\u4ee5\u7ed1\u5b9a\u4e86\uff0c\u7136\u540e Pod \u4e5f\u4f1a\u81ea\u52a8\u7684\u542f\u52a8\u6210\u529f\uff0c\u8fd9\u662f\u56e0\u4e3a\u5728 Kubernetes \u4e2d\u6709\u4e00\u4e2a\u4e13\u95e8\u5904\u7406\u6301\u4e45\u5316\u5b58\u50a8\u7684\u63a7\u5236\u5668 Volume Controller\uff0c\u8fd9\u4e2a\u63a7\u5236\u5668\u4e0b\u9762\u6709\u5f88\u591a\u4e2a\u63a7\u5236\u5faa\u73af\uff0c\u5176\u4e2d\u4e00\u4e2a\u5c31\u662f\u7528\u4e8e PV \u548c PVC \u7ed1\u5b9a\u7684 PersistentVolumeController\u3002</p> <p>PersistentVolumeController \u4f1a\u4e0d\u65ad\u5730\u5faa\u73af\u53bb\u67e5\u770b\u6bcf\u4e00\u4e2a PVC\uff0c\u662f\u4e0d\u662f\u5df2\u7ecf\u5904\u4e8e Bound\uff08\u5df2\u7ed1\u5b9a\uff09\u72b6\u6001\u3002\u5982\u679c\u4e0d\u662f\uff0c\u90a3\u5b83\u5c31\u4f1a\u904d\u5386\u6240\u6709\u7684\u3001\u53ef\u7528\u7684 PV\uff0c\u5e76\u5c1d\u8bd5\u5c06\u5176\u4e0e\u672a\u7ed1\u5b9a\u7684 PVC \u8fdb\u884c\u7ed1\u5b9a\uff0c\u8fd9\u6837\uff0cKubernetes \u5c31\u53ef\u4ee5\u4fdd\u8bc1\u7528\u6237\u63d0\u4ea4\u7684\u6bcf\u4e00\u4e2a PVC\uff0c\u53ea\u8981\u6709\u5408\u9002\u7684 PV \u51fa\u73b0\uff0c\u5b83\u5c31\u80fd\u591f\u5f88\u5feb\u8fdb\u5165\u7ed1\u5b9a\u72b6\u6001\u3002\u800c\u6240\u8c13\u5c06\u4e00\u4e2a PV \u4e0e PVC \u8fdb\u884c<code>\u7ed1\u5b9a</code>\uff0c\u5176\u5b9e\u5c31\u662f\u5c06\u8fd9\u4e2a PV \u5bf9\u8c61\u7684\u540d\u5b57\uff0c\u586b\u5728\u4e86 PVC \u5bf9\u8c61\u7684 <code>spec.volumeName</code> \u5b57\u6bb5\u4e0a\u3002</p> <p>PV \u548c PVC \u7ed1\u5b9a\u4e0a\u4e86\uff0c\u90a3\u4e48\u53c8\u662f\u5982\u4f55\u5c06\u5bb9\u5668\u91cc\u9762\u7684\u6570\u636e\u8fdb\u884c\u6301\u4e45\u5316\u7684\u5462\uff0c\u524d\u9762\u6211\u4eec\u5b66\u4e60\u8fc7 Docker \u7684 Volume \u6302\u8f7d\uff0c\u5176\u5b9e\u5c31\u662f<code>\u5c06\u4e00\u4e2a\u5bbf\u4e3b\u673a\u4e0a\u7684\u76ee\u5f55\u548c\u4e00\u4e2a\u5bb9\u5668\u91cc\u7684\u76ee\u5f55\u7ed1\u5b9a\u6302\u8f7d\u5728\u4e86\u4e00\u8d77</code>\uff0c\u5177\u6709\u6301\u4e45\u5316\u529f\u80fd\u5f53\u7136\u5c31\u662f\u6307\u7684\u5bbf\u4e3b\u673a\u4e0a\u9762\u7684\u8fd9\u4e2a\u76ee\u5f55\u4e86\uff0c\u5f53\u5bb9\u5668\u88ab\u5220\u9664\u6216\u8005\u5728\u5176\u4ed6\u8282\u70b9\u4e0a\u91cd\u5efa\u51fa\u6765\u4ee5\u540e\uff0c\u8fd9\u4e2a\u76ee\u5f55\u91cc\u9762\u7684\u5185\u5bb9\u4f9d\u7136\u5b58\u5728\uff0c\u6240\u4ee5\u4e00\u822c\u60c5\u51b5\u4e0b\u5b9e\u73b0\u6301\u4e45\u5316\u662f\u9700\u8981\u4e00\u4e2a\u8fdc\u7a0b\u5b58\u50a8\u7684\uff0c\u6bd4\u5982 NFS\u3001Ceph \u6216\u8005\u4e91\u5382\u5546\u63d0\u4f9b\u7684\u78c1\u76d8\u7b49\u7b49\u3002\u6240\u4ee5\u63a5\u4e0b\u6765\u9700\u8981\u505a\u7684\u5c31\u662f\u6301\u4e45\u5316\u5bbf\u4e3b\u673a\u76ee\u5f55\u8fd9\u4e2a\u8fc7\u7a0b\u3002</p> <p>\u5f53 Pod \u88ab\u8c03\u5ea6\u5230\u4e00\u4e2a\u8282\u70b9\u4e0a\u540e\uff0c\u8282\u70b9\u4e0a\u7684 kubelet \u7ec4\u4ef6\u5c31\u4f1a\u4e3a\u8fd9\u4e2a Pod \u521b\u5efa\u5b83\u7684 Volume \u76ee\u5f55\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b kubelet \u4e3a Volume \u521b\u5efa\u7684\u76ee\u5f55\u5728 kubelet \u5de5\u4f5c\u76ee\u5f55\u4e0b\u9762\uff1a</p> <pre><code>/var/lib/kubelet/pods/&lt;Pod\u7684ID&gt;/volumes/kubernetes.io~&lt;Volume\u7c7b\u578b&gt;/&lt;Volume\u540d\u5b57&gt;\n</code></pre> <p>\u6bd4\u5982\u4e0a\u9762\u6211\u4eec\u521b\u5efa\u7684 Pod \u5bf9\u5e94\u7684 Volume \u76ee\u5f55\u5b8c\u6574\u8def\u5f84\u4e3a\uff1a</p> <pre><code>/var/lib/kubelet/pods/d4fcdb11-baf7-43d9-8d7d-3ede24118e08/volumes/kubernetes.io~nfs/nfs-pv\n</code></pre> <p>\u63d0\u793a</p> <p>\u8981\u83b7\u53d6 Pod \u7684\u552f\u4e00\u6807\u8bc6 uid\uff0c\u53ef\u901a\u8fc7\u547d\u4ee4 </p> <pre><code>kubectl get pod pod\u540d -o jsonpath={.metadata.uid}\n</code></pre> <p>\u83b7\u53d6\u3002</p> <p>\u7136\u540e\u5c31\u9700\u8981\u6839\u636e\u6211\u4eec\u7684 Volume \u7c7b\u578b\u6765\u51b3\u5b9a\u9700\u8981\u505a\u4ec0\u4e48\u64cd\u4f5c\u4e86\uff0c\u6bd4\u5982\u4e0a\u8282\u8bfe\u6211\u4eec\u7528\u7684 Ceph RBD\uff0c\u90a3\u4e48 kubelet \u5c31\u9700\u8981\u5148\u5c06 Ceph \u63d0\u4f9b\u7684 RBD \u6302\u8f7d\u5230 Pod \u6240\u5728\u7684\u5bbf\u4e3b\u673a\u4e0a\u9762\uff0c\u8fd9\u4e2a\u9636\u6bb5\u5728 Kubernetes \u4e2d\u88ab\u79f0\u4e3a Attach \u9636\u6bb5\u3002Attach \u9636\u6bb5\u5b8c\u6210\u540e\uff0c\u4e3a\u4e86\u80fd\u591f\u4f7f\u7528\u8fd9\u4e2a\u5757\u8bbe\u5907\uff0ckubelet \u8fd8\u8981\u8fdb\u884c\u7b2c\u4e8c\u4e2a\u64cd\u4f5c\uff0c\u5373\uff1a\u683c\u5f0f\u5316\u8fd9\u4e2a\u5757\u8bbe\u5907\uff0c\u7136\u540e\u5c06\u5b83\u6302\u8f7d\u5230\u5bbf\u4e3b\u673a\u6307\u5b9a\u7684\u6302\u8f7d\u70b9\u4e0a\u3002\u8fd9\u4e2a\u6302\u8f7d\u70b9\uff0c\u4e5f\u5c31\u662f\u4e0a\u9762\u6211\u4eec\u63d0\u5230\u7684 Volume \u7684\u5bbf\u4e3b\u673a\u7684\u76ee\u5f55\u3002\u5c06\u5757\u8bbe\u5907\u683c\u5f0f\u5316\u5e76\u6302\u8f7d\u5230 Volume \u5bbf\u4e3b\u673a\u76ee\u5f55\u7684\u64cd\u4f5c\uff0c\u5728 Kubernetes \u4e2d\u88ab\u79f0\u4e3a Mount \u9636\u6bb5\u3002\u4e0a\u8282\u8bfe\u6211\u4eec\u4f7f\u7528 Ceph RBD \u6301\u4e45\u5316\u7684 Wordpress \u7684 MySQL \u6570\u636e\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5bf9\u5e94\u7684 Volume \u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get pods -o wide -l app=wordpress\nNAME                              READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES\nwordpress-5b886cf59b-dv2zt        1/1     Running   0          20d   2158   ydzs-node1   &lt;none&gt;           &lt;none&gt;\nwordpress-mysql-b9ddd6d4c-pjhbt   1/1     Running   0          20d   270    ydzs-node4   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 MySQL \u8fd0\u884c\u5728 node4 \u8282\u70b9\u4e0a\uff0c\u7136\u540e\u53ef\u4ee5\u5728\u8be5\u8282\u70b9\u4e0a\u67e5\u770b Volume \u4fe1\u606f\uff0cPod \u5bf9\u5e94\u7684 uid \u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u83b7\u53d6\uff1a</p> <pre><code>$ kubectl get pod wordpress-mysql-b9ddd6d4c-pjhbt -o jsonpath={.metadata.uid}\n3f84af87-9f58-4c69-9e38-5ef234498133\n$ ls /var/lib/kubelet/pods/3f84af87-9f58-4c69-9e38-5ef234498133/volumes/kubernetes.io~csi/pvc-c8861c23-c03d-47aa-96f6-73c4d4093109/\nmount  vol_data.json\n</code></pre> <p>\u7136\u540e\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u53ef\u4ee5\u67e5\u770b Volume \u7684\u6301\u4e45\u5316\u4fe1\u606f\uff1a</p> <pre><code>$ findmnt /var/lib/kubelet/pods/3f84af87-9f58-4c69-9e38-5ef234498133/volumes/kubernetes.io~csi/pvc-c8861c23-c03d-47aa-96f6-73c4d4093109/mount\nTARGET                                                                                            SOURCE    FSTYPE OPTIONS\n/var/lib/kubelet/pods/3f84af87-9f58-4c69-9e38-5ef234498133/volumes/kubernetes.io~csi/pvc-c8861c23-c03d-47aa-96f6-73c4d4093109/mount    /dev/rbd0 ext4   rw,relatime,\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u8fd9\u91cc\u7684 Volume \u662f\u6302\u8f7d\u5230 <code>/dev/rbd0</code> \u8fd9\u4e2a\u8bbe\u5907\u4e0a\u9762\u7684\uff0c\u901a\u8fc7 <code>df</code> \u547d\u4ee4\u4e5f\u662f\u53ef\u4ee5\u770b\u5230\u7684\uff1a</p> <pre><code>$ df -h |grep dev\ndevtmpfs        9G     0  9G   0% /dev\ntmpfs           9G     0  9G   0% /dev/shm\n/dev/vda3        18G  7G   13G  27% /\n/dev/vda1       497M  158M  340M  32% /boot\n/dev/vdb1       197G   24G  164G  13% /data\n/dev/rbd0        20G  160M   20G   1% /var/lib/kubelet/pods/3f84af87-9f58-4c69-9e38-5ef234498133/volumes/kubernetes.io~csi/pvc-c8861c23-c03d-47aa-96f6-73c4d4093109/mount\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u5c31\u7ecf\u8fc7\u4e86 <code>Attach</code> \u548c <code>Mount</code> \u4e24\u4e2a\u9636\u6bb5\u5b8c\u6210\u4e86 Volume \u7684\u6301\u4e45\u5316\u3002\u4f46\u662f\u5bf9\u4e8e\u4e0a\u9762\u6211\u4eec\u4f7f\u7528\u7684 NFS \u5c31\u66f4\u52a0\u7b80\u5355\u4e86\uff0c \u56e0\u4e3a NFS \u5b58\u50a8\u5e76\u6ca1\u6709\u4e00\u4e2a\u8bbe\u5907\u9700\u8981\u6302\u8f7d\u5230\u5bbf\u4e3b\u673a\u4e0a\u9762\uff0c\u6240\u4ee5\u8fd9\u4e2a\u65f6\u5019 kubelet \u5c31\u4f1a\u76f4\u63a5\u8fdb\u5165\u7b2c\u4e8c\u4e2a <code>Mount</code> \u9636\u6bb5\uff0c\u76f8\u5f53\u4e8e\u76f4\u63a5\u5728\u5bbf\u4e3b\u673a\u4e0a\u9762\u6267\u884c\u5982\u4e0b\u7684\u547d\u4ee4\uff1a</p> <pre><code>$ mount -t nfs 111:/data/k8s /var/lib/kubelet/pods/d4fcdb11-baf7-43d9-8d7d-3ede24118e08/volumes/kubernetes.io~nfs/nfs-pv\n</code></pre> <p>\u540c\u6837\u53ef\u4ee5\u5728\u6d4b\u8bd5\u7684 Pod \u6240\u5728\u8282\u70b9\u67e5\u770b Volume \u7684\u6302\u8f7d\u4fe1\u606f\uff1a</p> <pre><code>$ findmnt /var/lib/kubelet/pods/d4fcdb11-baf7-43d9-8d7d-3ede24118e08/volumes/kubernetes.io~nfs/nfs-pv\nTARGET                                                                               SOURCE                 FSTYPE OPTIONS\n/var/lib/kubelet/pods/d4fcdb11-baf7-43d9-8d7d-3ede24118e08/volumes/kubernetes.io~nfs/nfs-pv\n                                                                                     111:/data/k8s nfs4   rw,relatime,\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8fd9\u4e2a Volume \u88ab\u6302\u8f7d\u5230\u4e86 NFS\uff0810.151.30.11:/data/k8s\uff09\u4e0b\u9762\uff0c\u4ee5\u540e\u6211\u4eec\u5728\u8fd9\u4e2a\u76ee\u5f55\u91cc\u5199\u5165\u7684\u6240\u6709\u6587\u4ef6\uff0c\u90fd\u4f1a\u88ab\u4fdd\u5b58\u5728\u8fdc\u7a0b NFS \u670d\u52a1\u5668\u4e0a\u3002</p> <p>\u8fd9\u6837\u5728\u7ecf\u8fc7\u4e86\u4e0a\u9762\u7684\u4e24\u4e2a\u9636\u6bb5\u8fc7\u540e\uff0c\u6211\u4eec\u5c31\u5f97\u5230\u4e86\u4e00\u4e2a\u6301\u4e45\u5316\u7684\u5bbf\u4e3b\u673a\u4e0a\u9762\u7684 Volume \u76ee\u5f55\u4e86\uff0c\u63a5\u4e0b\u6765 kubelet \u53ea\u9700\u8981\u628a\u8fd9\u4e2a Volume \u76ee\u5f55\u6302\u8f7d\u5230\u5bb9\u5668\u4e2d\u5bf9\u5e94\u7684\u76ee\u5f55\u5373\u53ef\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u4e3a Pod \u91cc\u7684\u5bb9\u5668\u6302\u8f7d\u8fd9\u4e2a\u6301\u4e45\u5316\u7684 Volume \u4e86\uff0c\u8fd9\u4e00\u6b65\u5176\u5b9e\u4e5f\u5c31\u76f8\u5f53\u4e8e\u6267\u884c\u4e86\u5982\u4e0b\u6240\u793a\u7684\u547d\u4ee4\uff1a</p> <pre><code>$ docker run -v /var/lib/kubelet/pods/&lt;Pod\u7684ID&gt;/volumes/kubernetes.io~&lt;Volume\u7c7b\u578b&gt;/&lt;Volume\u540d\u5b57&gt;:/&lt;\u5bb9\u5668\u5185\u7684\u76ee\u6807\u76ee\u5f55&gt; \u6211\u7684\u955c\u50cf ...\n</code></pre> <p>\u6574\u4e2a\u5b58\u50a8\u7684\u67b6\u6784\u53ef\u4ee5\u7528\u4e0b\u56fe\u6765\u8bf4\u660e\uff1a </p> <ul> <li>PV Controller\uff1a\u8d1f\u8d23 PV/PVC \u7684\u7ed1\u5b9a\uff0c\u5e76\u6839\u636e\u9700\u6c42\u8fdb\u884c\u6570\u636e\u5377\u7684 Provision/Delete \u64cd\u4f5c</li> <li>AD Controller\uff1a\u8d1f\u8d23\u5b58\u50a8\u8bbe\u5907\u7684 Attach/Detach \u64cd\u4f5c\uff0c\u5c06\u8bbe\u5907\u6302\u8f7d\u5230\u76ee\u6807\u8282\u70b9</li> <li>Volume Manager\uff1a\u7ba1\u7406\u5377\u7684 Mount/Unmount \u64cd\u4f5c\u3001\u5377\u8bbe\u5907\u7684\u683c\u5f0f\u5316\u7b49\u64cd\u4f5c</li> <li>Volume Plugin\uff1a\u6269\u5c55\u5404\u79cd\u5b58\u50a8\u7c7b\u578b\u7684\u5377\u7ba1\u7406\u80fd\u529b\uff0c\u5b9e\u73b0\u7b2c\u4e09\u65b9\u5b58\u50a8\u7684\u5404\u79cd\u64cd\u4f5c\u80fd\u529b\u548c Kubernetes \u5b58\u50a8\u7cfb\u7edf\u7ed3\u5408</li> </ul> <p>\u6211\u4eec\u4e0a\u9762\u4f7f\u7528\u7684 NFS \u5c31\u5c5e\u4e8e In-Tree \u8fd9\u79cd\u65b9\u5f0f\uff0c\u800c\u4e0a\u8282\u8bfe\u4f7f\u7528\u7684 Ceph RBD \u5c31\u662f Out-Of-Tree \u7684\u65b9\u5f0f\uff0c\u800c\u4e14\u662f\u4f7f\u7528\u7684\u662f CSI \u63d2\u4ef6\u3002\u4e0b\u9762\u6211\u4eec\u518d\u6765\u4e86\u89e3\u4e0b <code>FlexVolume</code> \u548c <code>CSI</code> \u4e24\u79cd\u63d2\u4ef6\u65b9\u5f0f\u3002</p>"},{"location":"kubernetes_stroage/csi/#flexvolume","title":"FlexVolume","text":"<p>FlexVolume \u63d0\u4f9b\u4e86\u4e00\u79cd\u6269\u5c55 Kubernetes \u5b58\u50a8\u63d2\u4ef6\u7684\u65b9\u5f0f\uff0c\u7528\u6237\u53ef\u4ee5\u81ea\u5b9a\u4e49\u81ea\u5df1\u7684\u5b58\u50a8\u63d2\u4ef6\u3002\u8981\u4f7f\u7528 FlexVolume \u9700\u8981\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u5b89\u88c5\u5b58\u50a8\u63d2\u4ef6\u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u8be5\u4e8c\u8fdb\u5236\u9700\u8981\u5b9e\u73b0 FlexVolume \u7684\u76f8\u5173\u63a5\u53e3\uff0c\u9ed8\u8ba4\u5b58\u50a8\u63d2\u4ef6\u7684\u5b58\u653e\u8def\u5f84\u4e3a</p> <pre><code>/usr/libexec/kubernetes/kubelet-plugins/volume/exec/&lt;vendor~driver&gt;/&lt;driver&gt;\n</code></pre> <p>\uff0c<code>VolumePlugins</code> \u7ec4\u4ef6\u4f1a\u4e0d\u65ad watch \u8fd9\u4e2a\u76ee\u5f55\u6765\u5b9e\u73b0\u63d2\u4ef6\u7684\u6dfb\u52a0\u3001\u5220\u9664\u7b49\u529f\u80fd\u3002</p> <p>\u5176\u4e2d <code>vendor~driver</code> \u7684\u540d\u5b57\u9700\u8981\u548c Pod \u4e2d<code>flexVolume.driver</code> \u7684\u5b57\u6bb5\u540d\u5b57\u5339\u914d\uff0c\u4f8b\u5982\uff1a</p> <pre><code>/usr/libexec/kubernetes/kubelet-plugins/volume/exec/foo~cifs/cifs\n</code></pre> <p>\u5bf9\u5e94\u7684 Pod \u4e2d\u7684 <code>flexVolume.driver</code> \u5c5e\u6027\u4e3a\uff1a<code>foo/cifs</code>\u3002</p> <p>\u5728\u6211\u4eec\u5b9e\u73b0\u81ea\u5b9a\u4e49\u5b58\u50a8\u63d2\u4ef6\u7684\u65f6\u5019\uff0c\u9700\u8981\u5b9e\u73b0 FlexVolume \u7684\u90e8\u5206\u63a5\u53e3\uff0c\u56e0\u4e3a\u8981\u770b\u5b9e\u9645\u9700\u6c42\uff0c\u5e76\u4e0d\u4e00\u5b9a\u6240\u6709\u63a5\u53e3\u90fd\u9700\u8981\u5b9e\u73b0\u3002\u6bd4\u5982\u5bf9\u4e8e\u7c7b\u4f3c\u4e8e NFS \u8fd9\u6837\u7684\u5b58\u50a8\u5c31\u6ca1\u5fc5\u8981\u5b9e\u73b0 <code>attach/detach</code> \u8fd9\u4e9b\u63a5\u53e3\u4e86\uff0c\u56e0\u4e3a\u4e0d\u9700\u8981\uff0c\u53ea\u9700\u8981\u5b9e\u73b0 <code>init/mount/umount</code> 3\u4e2a\u63a5\u53e3\u5373\u53ef\u3002</p> <ul> <li> <p>init: </p> <pre><code>&lt;driver executable&gt; init\n</code></pre> <ul> <li>kubelet/kube-controller-manager \u521d\u59cb\u5316\u5b58\u50a8\u63d2\u4ef6\u65f6\u8c03\u7528\uff0c\u63d2\u4ef6\u9700\u8981\u8fd4\u56de\u662f\u5426\u9700\u8981\u8981 attach \u548c detach \u64cd\u4f5c</li> <li>attach: </li> </ul> <pre><code>&lt;driver executable&gt; attach &lt;json options&gt; &lt;node name&gt;\n</code></pre> <ul> <li>\u5c06\u5b58\u50a8\u5377\u6302\u8f7d\u5230 Node \u8282\u70b9\u4e0a</li> <li>detach: </li> </ul> <pre><code>&lt;driver executable&gt; detach &lt;mount device&gt; &lt;node name&gt;\n</code></pre> <ul> <li>\u5c06\u5b58\u50a8\u5377\u4ece Node \u4e0a\u5378\u8f7d</li> <li>waitforattach: </li> </ul> <pre><code>&lt;driver executable&gt; waitforattach &lt;mount device&gt; &lt;json options&gt;\n</code></pre> <ul> <li>\u7b49\u5f85 attach \u64cd\u4f5c\u6210\u529f\uff08\u8d85\u65f6\u65f6\u95f4\u4e3a 10 \u5206\u949f\uff09</li> <li>isattached: </li> </ul> <pre><code>&lt;driver executable&gt; isattached &lt;json options&gt; &lt;node name&gt;\n</code></pre> <ul> <li>\u68c0\u67e5\u5b58\u50a8\u5377\u662f\u5426\u5df2\u7ecf\u6302\u8f7d</li> <li>mountdevice: </li> </ul> <pre><code>&lt;driver executable&gt; mountdevice &lt;mount dir&gt; &lt;mount device&gt; &lt;json options&gt;\n</code></pre> <ul> <li>\u5c06\u8bbe\u5907\u6302\u8f7d\u5230\u6307\u5b9a\u76ee\u5f55\u4e2d\u4ee5\u4fbf\u540e\u7eed bind mount \u4f7f\u7528</li> <li>unmountdevice: </li> </ul> <pre><code>&lt;driver executable&gt; unmountdevice &lt;mount device&gt;\n</code></pre> <ul> <li>\u5c06\u8bbe\u5907\u53d6\u6d88\u6302\u8f7d</li> <li>mount: </li> </ul> <pre><code>&lt;driver executable&gt; mount &lt;mount dir&gt; &lt;json options&gt;\n</code></pre> <ul> <li>\u5c06\u5b58\u50a8\u5377\u6302\u8f7d\u5230\u6307\u5b9a\u76ee\u5f55\u4e2d</li> <li>unmount: </li> </ul> <pre><code>&lt;driver executable&gt; unmount &lt;mount dir&gt;\n</code></pre> <ul> <li>\u5c06\u5b58\u50a8\u5377\u53d6\u6d88\u6302\u8f7d</li> </ul> </li> </ul> <p>\u5b9e\u73b0\u4e0a\u9762\u7684\u8fd9\u4e9b\u63a5\u53e3\u9700\u8981\u8fd4\u56de\u5982\u4e0b\u6240\u793a\u7684 JSON \u683c\u5f0f\u7684\u6570\u636e\uff1a</p> <pre><code>{\n    \"status\": \"&lt;Success/Failure/Not supported&gt;\",\n    \"message\": \"&lt;Reason for success/failure&gt;\",\n    \"device\": \"&lt;Path to the device attached. This field is valid only for attach &amp; waitforattach call-outs&gt;\"\n    \"volumeName\": \"&lt;Cluster wide unique name of the volume. Valid only for getvolumename call-out&gt;\"\n    \"attached\": &lt;True/False (Return true if volume is attached on the node. Valid only for isattached call-out)&gt;\n    \"capabilities\": &lt;Only included as part of the Init response&gt;\n    {\n        \"attach\": &lt;True/False (Return true if the driver implements attach and detach)&gt;\n    }\n}\n</code></pre> <p>\u6bd4\u5982\u6211\u4eec\u6765\u5b9e\u73b0\u4e00\u4e2a NFS \u7684 FlexVolume \u63d2\u4ef6\uff0c\u6700\u7b80\u5355\u7684\u65b9\u5f0f\u5c31\u662f\u5199\u4e00\u4e2a\u811a\u672c\uff0c\u7136\u540e\u5b9e\u73b0 init\u3001mount\u3001unmount 3\u4e2a\u547d\u4ee4\u5373\u53ef\uff0c\u7136\u540e\u6309\u7167\u4e0a\u9762\u7684 JSON \u683c\u5f0f\u8fd4\u56de\u6570\u636e\uff0c\u6700\u540e\u628a\u8fd9\u4e2a\u811a\u672c\u653e\u5728\u8282\u70b9\u7684 FlexVolume \u63d2\u4ef6\u76ee\u5f55\u4e0b\u9762\u5373\u53ef\u3002</p> <p>\u4e0b\u9762\u5c31\u662f\u5b98\u65b9\u7ed9\u51fa\u7684\u4e00\u4e2a NFS \u7684 FlexVolume \u63d2\u4ef6\u793a\u4f8b\uff0c\u53ef\u4ee5\u4ece https://github.com/kubernetes/examples/blob/master/staging/volumes/flexvolume/nfs \u83b7\u53d6\u811a\u672c\uff1a</p> <pre><code>#!/bin/bash\n# \u6ce8\u610f:\n#  - \u5728\u4f7f\u7528\u63d2\u4ef6\u4e4b\u524d\u9700\u8981\u5148\u5b89\u88c5 jq\u3002\nusage() {\n    err \"Invalid usage. Usage: \"\n    err \"\\\\t$0 init\"\n    err \"\\\\t$0 mount &lt;mount dir&gt; &lt;json params&gt;\"\n    err \"\\\\t$0 unmount &lt;mount dir&gt;\"\n    exit 1\n}\n\nerr() {\n    echo -ne $* 1&gt;&amp;2\n}\n\nlog() {\n    echo -ne $* &gt;&amp;1\n}\n\nismounted() {\n    MOUNT=`findmnt -n ${MNTPATH} 2&gt;/dev/null | cut -d' ' -f1`\n    if [ \"${MOUNT}\" == \"${MNTPATH}\" ]; then\n        echo \"1\"\n    else\n        echo \"0\"\n    fi\n}\n\ndomount() {\n    MNTPATH=$1\n\n    NFS_SERVER=$(echo $2 | jq -r '.server')\n    SHARE=$(echo $2 | jq -r '.share')\n\n    if [ $(ismounted) -eq 1 ] ; then\n        log '{\"status\": \"Success\"}'\n        exit 0\n    fi\n\n    mkdir -p ${MNTPATH} &amp;&gt; /dev/null\n\n    mount -t nfs ${NFS_SERVER}:/${SHARE} ${MNTPATH} &amp;&gt; /dev/null\n    if [ $? -ne 0 ]; then\n        err \"{ \\\\\"status\\\\\": \\\\\"Failure\\\\\", \\\\\"message\\\\\": \\\\\"Failed to mount ${NFS_SERVER}:${SHARE} at ${MNTPATH}\\\\\"}\"\n        exit 1\n    fi\n    log '{\"status\": \"Success\"}'\n    exit 0\n}\n\nunmount() {\n    MNTPATH=$1\n    if [ $(ismounted) -eq 0 ] ; then\n        log '{\"status\": \"Success\"}'\n        exit 0\n    fi\n\n    umount ${MNTPATH} &amp;&gt; /dev/null\n    if [ $? -ne 0 ]; then\n        err \"{ \\\\\"status\\\\\": \\\\\"Failed\\\\\", \\\\\"message\\\\\": \\\\\"Failed to unmount volume at ${MNTPATH}\\\\\"}\"\n        exit 1\n    fi\n\n    log '{\"status\": \"Success\"}'\n    exit 0\n}\n\nop=$1\n\nif ! command -v jq &gt;/dev/null 2&gt;&amp;1; then\n    err \"{ \\\\\"status\\\\\": \\\\\"Failure\\\\\", \\\\\"message\\\\\": \\\\\"'jq' binary not found. Please install jq package before using this driver\\\\\"}\"\n    exit 1\nfi\n\nif [ \"$op\" = \"init\" ]; then\n    log '{\"status\": \"Success\", \"capabilities\": {\"attach\": false}}'\n    exit 0\nfi\n\nif [ $# -lt 2 ]; then\n    usage\nfi\n\nshift\n\ncase \"$op\" in\n    mount)\n        domount $*\n        ;;\n    unmount)\n        unmount $*\n        ;;\n    *)\n        log '{\"status\": \"Not supported\"}'\n        exit 0\nesac\n\nexit 1\n</code></pre> <p>\u5c06\u4e0a\u9762\u811a\u672c\u547d\u540d\u6210 nfs\uff0c\u653e\u7f6e\u5230 node1 \u8282\u70b9\u5bf9\u5e94\u7684\u63d2\u4ef6\u4e0b\u9762\uff1a </p> <pre><code>/usr/libexec/kubernetes/kubelet-plugins/volume/exec/ydzs~nfs/nfs\n</code></pre> <p>\uff0c\u5e76\u8bbe\u7f6e\u6743\u9650\u4e3a 700\uff1a</p> <pre><code>$ chmod 700 /usr/libexec/kubernetes/kubelet-plugins/volume/exec/ydzs~nfs/nfs\n# \u5b89\u88c5 jq \u5de5\u5177\n$ yum -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-noarch.rpm\n$ yum install jq -y\n</code></pre> <p>\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u90e8\u7f72\u4e00\u4e2a\u5e94\u7528\u5230 node1 \u8282\u70b9\u4e0a\uff0c\u5e76\u7528 <code>flexVolume</code> \u6765\u6301\u4e45\u5316\u5bb9\u5668\u4e2d\u7684\u6570\u636e\uff08\u5f53\u7136\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5b9a\u4e49 flexvolume \u7c7b\u578b\u7684 PV\u3001PVC \u6765\u4f7f\u7528\uff09\uff0c\u5982\u4e0b\u6240\u793a\uff1a(test-flexvolume.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: test-flexvolume\nspec:\n  nodeSelector:\n    kubernetes.io/hostname: ydzs-node1\n  volumes:\n  - name: test\n    flexVolume:\n      driver: \"ydzs/nfs\"  # \u5b9a\u4e49\u63d2\u4ef6\u7c7b\u578b\uff0c\u6839\u636e\u8fd9\u4e2a\u53c2\u6570\u5728\u5bf9\u5e94\u7684\u76ee\u5f55\u4e0b\u9762\u627e\u5230\u63d2\u4ef6\u7684\u53ef\u6267\u884c\u6587\u4ef6\n      fsType: \"nfs\"  # \u5b9a\u4e49\u5b58\u50a8\u5377\u6587\u4ef6\u7cfb\u7edf\u7c7b\u578b\n      options:  # \u5b9a\u4e49\u6240\u6709\u4e0e\u5b58\u50a8\u76f8\u5173\u7684\u4e00\u4e9b\u5177\u4f53\u53c2\u6570\n        server: \"111\"\n        share: \"data/k8s\"\n  containers:\n  - name: web\n    image: nginx\n    ports:\n    - containerPort: 80\n    volumeMounts:\n    - name: test\n      subPath: testflexvolume\n      mountPath: /usr/share/nginx/html\n</code></pre> <p>\u5176\u4e2d <code>flexVolume.driver</code> \u5c31\u662f\u63d2\u4ef6\u76ee\u5f55 <code>ydzs~nfs</code> \u5bf9\u5e94\u7684 <code>ydzs/nfs</code> \u540d\u79f0\uff0c<code>flexVolume.options</code> \u4e2d\u6839\u636e\u4e0a\u9762\u7684 nfs \u811a\u672c\u53ef\u4ee5\u5f97\u77e5\u91cc\u9762\u914d\u7f6e\u7684\u662f NFS \u7684 Server \u5730\u5740\u548c\u6302\u8f7d\u76ee\u5f55\u8def\u5f84\uff0c\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f test-flexvolume.yaml\n$ kubectl get pods \nNAME                                      READY   STATUS    RESTARTS   AGE\ntest-flexvolume                           1/1     Running   0          13h\n......\n$ kubectl exec -it test-flexvolume mount |grep test\n111:/data/k8s/testflexvolume on /usr/share/nginx/html type nfs4 (rw,relatime,vers=1,rsize=524288,wsize=524288,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,clientaddr=122,local_lock=none,addr=111)\n$ mount |grep test\n111:/data/k8s on /var/lib/kubelet/pods/a376832a-7638-4faf-b1a0-404956e8e60a/volumes/ydzs~nfs/test type nfs4 (rw,relatime,vers=1,rsize=524288,wsize=524288,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,clientaddr=122,local_lock=none,addr=111)\n111:/data/k8s/testflexvolume on /var/lib/kubelet/pods/a376832a-7638-4faf-b1a0-404956e8e60a/volume-subpaths/test/web/0 type nfs4 (rw,relatime,vers=1,rsize=524288,wsize=524288,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,clientaddr=122,local_lock=none,addr=111)\n</code></pre> <p>\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5230 Pod \u7684\u672c\u5730\u6301\u4e45\u5316\u76ee\u5f55\u662f\u88ab mount \u5230\u4e86 NFS \u4e0a\u9762\uff0c\u8bc1\u660e\u4e0a\u9762\u6211\u4eec\u7684 FlexVolume \u63d2\u4ef6\u662f\u6b63\u5e38\u7684\u3002</p> <p>\u8c03\u7528</p> <p>\u5f53\u6211\u4eec\u8981\u53bb\u771f\u6b63\u7684 mount NFS \u7684\u65f6\u5019\uff0c\u5c31\u662f\u901a\u8fc7 kubelet \u8c03\u7528 VolumePlugin\uff0c\u7136\u540e\u76f4\u63a5\u6267\u884c\u547d\u4ee4</p> <pre><code>/usr/libexec/kubernetes/kubelet-plugins/volume/exec/ydzs~nfs/nfs mount &lt;mount dir&gt; &lt;json param&gt;\n</code></pre> <p>\u6765\u5b8c\u6210\u7684\uff0c\u5c31\u76f8\u5f53\u4e8e\u5e73\u65f6\u6211\u4eec\u5728\u5bbf\u4e3b\u673a\u4e0a\u9762\u624b\u52a8\u6302\u8f7d NFS \u7684\u65b9\u5f0f\u4e00\u6837\u7684\uff0c\u6240\u4ee5\u5b58\u50a8\u63d2\u4ef6 nfs \u662f\u4e00\u4e2a\u53ef\u6267\u884c\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u6216\u8005 shell \u811a\u672c\u90fd\u662f\u53ef\u4ee5\u7684\u3002</p>"},{"location":"kubernetes_stroage/csi/#csi","title":"CSI","text":"<p>\u65e2\u7136\u5df2\u7ecf\u6709\u4e86 FlexVolume \u63d2\u4ef6\u4e86\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u9700\u8981 CSI \u63d2\u4ef6\u5462\uff1f\u4e0a\u9762\u6211\u4eec\u4f7f\u7528 FlexVolume \u63d2\u4ef6\u7684\u65f6\u5019\u53ef\u4ee5\u770b\u51fa FlexVolume \u63d2\u4ef6\u5b9e\u9645\u4e0a\u76f8\u5f53\u4e8e\u5c31\u662f\u4e00\u4e2a\u666e\u901a\u7684 shell \u547d\u4ee4\uff0c\u7c7b\u4f3c\u4e8e\u5e73\u65f6\u6211\u4eec\u5728 Linux \u4e0b\u9762\u6267\u884c\u7684 <code>ls</code> \u547d\u4ee4\u4e00\u6837\uff0c\u53ea\u662f\u8fd4\u56de\u7684\u4fe1\u606f\u662f JSON \u683c\u5f0f\u7684\u6570\u636e\uff0c\u5e76\u4e0d\u662f\u6211\u4eec\u901a\u5e38\u8ba4\u4e3a\u7684\u4e00\u4e2a\u5e38\u9a7b\u5185\u5b58\u7684\u8fdb\u7a0b\uff0c\u800c CSI \u662f\u4e00\u4e2a\u66f4\u52a0\u5b8c\u5584\u3001\u7f16\u7801\u66f4\u52a0\u65b9\u4fbf\u53cb\u597d\u7684\u4e00\u79cd\u5b58\u50a8\u63d2\u4ef6\u6269\u5c55\u65b9\u5f0f\u3002</p> <p>CSI \u662f\u7531\u6765\u81ea Kubernetes\u3001Mesos\u3001 Cloud Foundry \u7b49\u793e\u533a\u6210\u5458\u8054\u5408\u5236\u5b9a\u7684\u4e00\u4e2a\u884c\u4e1a\u6807\u51c6\u63a5\u53e3\u89c4\u8303\uff0c\u65e8\u5728\u5c06\u4efb\u610f\u5b58\u50a8\u7cfb\u7edf\u66b4\u9732\u7ed9\u5bb9\u5668\u5316\u5e94\u7528\u7a0b\u5e8f\u3002CSI \u89c4\u8303\u5b9a\u4e49\u4e86\u5b58\u50a8\u63d0\u4f9b\u5546\u5b9e\u73b0 CSI \u517c\u5bb9\u63d2\u4ef6\u7684\u6700\u5c0f\u64cd\u4f5c\u96c6\u5408\u548c\u90e8\u7f72\u5efa\u8bae\uff0cCSI \u89c4\u8303\u7684\u4e3b\u8981\u7126\u70b9\u662f\u58f0\u660e\u63d2\u4ef6\u5fc5\u987b\u5b9e\u73b0\u7684\u63a5\u53e3\u3002</p> <p>\u5728 Kubernetes \u4e0a\u6574\u5408 CSI \u63d2\u4ef6\u7684\u6574\u4f53\u67b6\u6784\u5982\u4e0b\u56fe\u6240\u793a\uff1a </p> <p>Kubernetes CSI \u5b58\u50a8\u4f53\u7cfb\u4e3b\u8981\u7531\u4e24\u90e8\u5206\u7ec4\u6210\uff1a</p> <ul> <li> <p>Kubernetes \u5916\u90e8\u7ec4\u4ef6\uff1a\u5305\u542b Driver registrar\u3001External provisioner\u3001External attacher \u4e09\u90e8\u5206\uff0c\u8fd9\u4e09\u4e2a\u7ec4\u4ef6\u662f\u4ece Kubernetes \u539f\u672c\u7684 in-tree \u5b58\u50a8\u4f53\u7cfb\u4e2d\u5265\u79bb\u51fa\u6765\u7684\u5b58\u50a8\u7ba1\u7406\u529f\u80fd\uff0c\u5b9e\u9645\u4e0a\u662f Kubernetes \u4e2d\u7684\u4e00\u79cd\u5916\u90e8 controller \uff0c\u5b83\u4eec watch kubernetes \u7684 API \u8d44\u6e90\u5bf9\u8c61\uff0c\u6839\u636e watch \u5230\u7684\u72b6\u6001\u6765\u8c03\u7528\u4e0b\u9762\u63d0\u5230\u7684\u7b2c\u4e8c\u90e8\u5206\u7684 CSI \u63d2\u4ef6\u6765\u5b9e\u73b0\u5b58\u50a8\u7684\u7ba1\u7406\u548c\u64cd\u4f5c\u3002\u8fd9\u90e8\u5206\u662f Kubernetes \u56e2\u961f\u7ef4\u62a4\u7684\uff0c\u63d2\u4ef6\u5f00\u53d1\u8005\u5b8c\u5168\u4e0d\u5fc5\u5173\u5fc3\u5176\u5b9e\u73b0\u7ec6\u8282\u3002</p> <ul> <li>Driver registra\uff1a\u7528\u4e8e\u5c06\u63d2\u4ef6\u6ce8\u518c\u5230 kubelet \u7684 sidecar \u5bb9\u5668\uff0c\u5e76\u5c06\u9a71\u52a8\u7a0b\u5e8f\u81ea\u5b9a\u4e49\u7684 NodeId \u6dfb\u52a0\u5230\u8282\u70b9\u7684 Annotations \u4e0a\uff0c\u901a\u8fc7\u4e0e CSI \u4e0a\u9762\u7684 Identity \u670d\u52a1\u8fdb\u884c\u901a\u4fe1\u8c03\u7528 CSI \u7684 GetNodeId \u65b9\u6cd5\u6765\u5b8c\u6210\u8be5\u64cd\u4f5c\u3002</li> <li>External provisioner\uff1a\u7528\u4e8e watch Kubernetes \u7684 PVC \u5bf9\u8c61\u5e76\u8c03\u7528 CSI \u7684 CreateVolume \u548c DeleteVolume \u64cd\u4f5c\u3002</li> <li>External attacher\uff1a\u7528\u4e8e Attach/Detach \u9636\u6bb5\uff0c\u901a\u8fc7 watch Kubernetes \u7684 VolumeAttachment \u5bf9\u8c61\u5e76\u8c03\u7528 CSI \u7684 ControllerPublish \u548c ControllerUnpublish \u64cd\u4f5c\u6765\u5b8c\u6210\u5bf9\u5e94\u7684 Volume \u7684 Attach/Detach\u3002\u800c Volume \u7684 Mount/Unmount \u9636\u6bb5\u5e76\u4e0d\u5c5e\u4e8e\u5916\u90e8\u7ec4\u4ef6\uff0c\u5f53\u771f\u6b63\u9700\u8981\u6267\u884c Mount \u64cd\u4f5c\u7684\u65f6\u5019\uff0ckubelet \u4f1a\u53bb\u76f4\u63a5\u8c03\u7528\u4e0b\u9762\u7684 CSI Node \u670d\u52a1\u6765\u5b8c\u6210 Volume \u7684 Mount/UnMount \u64cd\u4f5c\u3002</li> <li> <p>CSI \u5b58\u50a8\u63d2\u4ef6: \u8fd9\u90e8\u5206\u6b63\u662f\u5f00\u53d1\u8005\u9700\u8981\u5b9e\u73b0\u7684 CSI \u63d2\u4ef6\u90e8\u5206\uff0c\u90fd\u662f\u901a\u8fc7 gRPC \u5b9e\u73b0\u7684\u670d\u52a1\uff0c\u4e00\u822c\u4f1a\u7528\u4e00\u4e2a\u4e8c\u8fdb\u5236\u6587\u4ef6\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\uff0c\u4e3b\u8981\u5305\u542b\u4e09\u90e8\u5206\uff1aCSI Identity\u3001CSI Controller\u3001CSI Node\u3002</p> </li> <li> <p>CSI Identity \u2014 \u4e3b\u8981\u7528\u4e8e\u8d1f\u8d23\u5bf9\u5916\u66b4\u9732\u8fd9\u4e2a\u63d2\u4ef6\u672c\u8eab\u7684\u4fe1\u606f\uff0c\u786e\u4fdd\u63d2\u4ef6\u7684\u5065\u5eb7\u72b6\u6001\u3002</p> <pre><code>service Identity {\n    // \u8fd4\u56de\u63d2\u4ef6\u7684\u540d\u79f0\u548c\u7248\u672c\n    rpc GetPluginInfo(GetPluginInfoRequest)\n        returns (GetPluginInfoResponse) {}\n    // \u8fd4\u56de\u8fd9\u4e2a\u63d2\u4ef6\u7684\u5305\u542b\u7684\u529f\u80fd\uff0c\u6bd4\u5982\u975e\u5757\u5b58\u50a8\u7c7b\u578b\u7684 CSI \u63d2\u4ef6\u4e0d\u9700\u8981\u5b9e\u73b0 Attach \u529f\u80fd\uff0cGetPluginCapabilities \u5c31\u53ef\u4ee5\u5728\u8fd4\u56de\u4e2d\u6807\u6ce8\u8fd9\u4e2a CSI \u63d2\u4ef6\u4e0d\u5305\u542b Attach \u529f\u80fd\n    rpc GetPluginCapabilities(GetPluginCapabilitiesRequest)\n        returns (GetPluginCapabilitiesResponse) {}\n    // \u63d2\u4ef6\u63d2\u4ef6\u662f\u5426\u6b63\u5728\u8fd0\u884c\n    rpc Probe (ProbeRequest)\n        returns (ProbeResponse) {}\n}\n</code></pre> </li> <li> <p>CSI Controller - \u4e3b\u8981\u5b9e\u73b0 Volume \u7ba1\u7406\u6d41\u7a0b\u5f53\u4e2d\u7684 Provision \u548c Attach \u9636\u6bb5\uff0cProvision \u9636\u6bb5\u662f\u6307\u521b\u5efa\u548c\u5220\u9664 Volume \u7684\u6d41\u7a0b\uff0c\u800c Attach \u9636\u6bb5\u662f\u6307\u628a\u5b58\u50a8\u5377\u9644\u7740\u5728\u67d0\u4e2a\u8282\u70b9\u6216\u8131\u79bb\u67d0\u4e2a\u8282\u70b9\u7684\u6d41\u7a0b\uff0c\u53e6\u5916\u53ea\u6709\u5757\u5b58\u50a8\u7c7b\u578b\u7684 CSI \u63d2\u4ef6\u624d\u9700\u8981 Attach \u529f\u80fd\u3002</p> <pre><code>service Controller {\n    // \u521b\u5efa\u5b58\u50a8\u5377\uff0c\u5305\u62ec\u4e91\u7aef\u5b58\u50a8\u4ecb\u8d28\u4ee5\u53caPV\u5bf9\u8c61\n    rpc CreateVolume (CreateVolumeRequest)\n        returns (CreateVolumeResponse) {}\n\n    //  \u5220\u9664\u5b58\u50a8\u5377\n    rpc DeleteVolume (DeleteVolumeRequest)\n        returns (DeleteVolumeResponse) {}\n\n    // \u6302\u8f7d\u5b58\u50a8\u5377\uff0c\u5c06\u5b58\u50a8\u4ecb\u8d28\u6302\u8f7d\u5230\u76ee\u6807\u8282\u70b9\n    rpc ControllerPublishVolume (ControllerPublishVolumeRequest)\n        returns (ControllerPublishVolumeResponse) {}\n\n    // \u5378\u8f7d\u5b58\u50a8\u5377\n    rpc ControllerUnpublishVolume (ControllerUnpublishVolumeRequest)\n        returns (ControllerUnpublishVolumeResponse) {}\n\n    // \u4f8b\u5982\uff1a\u662f\u5426\u53ef\u4ee5\u540c\u65f6\u7528\u4e8e\u591a\u4e2a\u8282\u70b9\u7684\u8bfb/\u5199\n    rpc ValidateVolumeCapabilities (ValidateVolumeCapabilitiesRequest)\n        returns (ValidateVolumeCapabilitiesResponse) {}\n\n    // \u8fd4\u56de\u6240\u6709\u53ef\u7528\u7684 volumes\n    rpc ListVolumes (ListVolumesRequest)\n        returns (ListVolumesResponse) {}\n\n    // \u53ef\u7528\u5b58\u50a8\u6c60\u7684\u603b\u5bb9\u91cf\n    rpc GetCapacity (GetCapacityRequest)\n        returns (GetCapacityResponse) {}\n\n    // \u4f8b\u5982. \u63d2\u4ef6\u53ef\u80fd\u672a\u5b9e\u73b0 GetCapacity\u3001Snapshotting\n    rpc ControllerGetCapabilities (ControllerGetCapabilitiesRequest)\n        returns (ControllerGetCapabilitiesResponse) {}\n\n    // \u521b\u5efa\u5feb\u7167\n    rpc CreateSnapshot (CreateSnapshotRequest)\n        returns (CreateSnapshotResponse) {}\n\n    // \u5220\u9664\u6307\u5b9a\u7684\u5feb\u7167\n    rpc DeleteSnapshot (DeleteSnapshotRequest)\n        returns (DeleteSnapshotResponse) {}\n\n    // \u83b7\u53d6\u6240\u6709\u7684\u5feb\u7167\n    rpc ListSnapshots (ListSnapshotsRequest)\n        returns (ListSnapshotsResponse) {}\n}\n</code></pre> </li> <li> <p>CSI Node \u2014 \u8d1f\u8d23\u63a7\u5236 Kubernetes \u8282\u70b9\u4e0a\u7684 Volume \u64cd\u4f5c\u3002\u5176\u4e2d Volume \u7684\u6302\u8f7d\u88ab\u5206\u6210\u4e86 NodeStageVolume \u548c NodePublishVolume \u4e24\u4e2a\u9636\u6bb5\u3002NodeStageVolume \u63a5\u53e3\u4e3b\u8981\u662f\u9488\u5bf9\u5757\u5b58\u50a8\u7c7b\u578b\u7684 CSI \u63d2\u4ef6\u800c\u63d0\u4f9b\u7684\uff0c\u5757\u8bbe\u5907\u5728 \"Attach\" \u9636\u6bb5\u88ab\u9644\u7740\u5728 Node \u4e0a\u540e\uff0c\u9700\u8981\u6302\u8f7d\u81f3 Pod \u5bf9\u5e94\u76ee\u5f55\u4e0a\uff0c\u4f46\u56e0\u4e3a\u5757\u8bbe\u5907\u5728 linux \u4e0a\u53ea\u80fd mount \u4e00\u6b21\uff0c\u800c\u5728 kubernetes volume \u7684\u4f7f\u7528\u573a\u666f\u4e2d\uff0c\u4e00\u4e2a volume \u53ef\u80fd\u88ab\u6302\u8f7d\u8fdb\u540c\u4e00\u4e2a Node \u4e0a\u7684\u591a\u4e2a Pod \u5b9e\u4f8b\u4e2d\uff0c\u6240\u4ee5\u8fd9\u91cc\u63d0\u4f9b\u4e86 NodeStageVolume \u8fd9\u4e2a\u63a5\u53e3\uff0c\u4f7f\u7528\u8fd9\u4e2a\u63a5\u53e3\u628a\u5757\u8bbe\u5907\u683c\u5f0f\u5316\u540e\u5148\u6302\u8f7d\u81f3 Node \u4e0a\u7684\u4e00\u4e2a\u4e34\u65f6\u5168\u5c40\u76ee\u5f55\uff0c\u7136\u540e\u518d\u8c03\u7528 NodePublishVolume \u4f7f\u7528 linux \u4e2d\u7684 <code>bind mount</code> \u6280\u672f\u628a\u8fd9\u4e2a\u5168\u5c40\u76ee\u5f55\u6302\u8f7d\u8fdb Pod \u4e2d\u5bf9\u5e94\u7684\u76ee\u5f55\u4e0a\u3002</p> <pre><code>service Node {\n    // \u5728\u8282\u70b9\u4e0a\u521d\u59cb\u5316\u5b58\u50a8\u5377\uff08\u683c\u5f0f\u5316\uff09\uff0c\u5e76\u6267\u884c\u6302\u8f7d\u5230Global\u76ee\u5f55\n    rpc NodeStageVolume (NodeStageVolumeRequest)\n        returns (NodeStageVolumeResponse) {}\n\n    // umount \u5b58\u50a8\u5377\u5728\u8282\u70b9\u4e0a\u7684 Global \u76ee\u5f55\n    rpc NodeUnstageVolume (NodeUnstageVolumeRequest)\n        returns (NodeUnstageVolumeResponse) {}\n\n    // \u5728\u8282\u70b9\u4e0a\u5c06\u5b58\u50a8\u5377\u7684 Global \u76ee\u5f55\u6302\u8f7d\u5230 Pod \u7684\u5b9e\u9645\u6302\u8f7d\u76ee\u5f55\n    rpc NodePublishVolume (NodePublishVolumeRequest)\n        returns (NodePublishVolumeResponse) {}\n\n    // unmount \u5b58\u50a8\u5377\u5728\u8282\u70b9\u4e0a\u7684 Pod \u6302\u8f7d\u76ee\u5f55\n    rpc NodeUnpublishVolume (NodeUnpublishVolumeRequest)\n        returns (NodeUnpublishVolumeResponse) {}\n\n    // \u83b7\u53d6\u8282\u70b9\u4e0aVolume\u6302\u8f7d\u6587\u4ef6\u7cfb\u7edf\u7edf\u8ba1\u4fe1\u606f\uff08\u603b\u7a7a\u95f4\u3001\u53ef\u7528\u7a7a\u95f4\u7b49\uff09\n    rpc NodeGetVolumeStats (NodeGetVolumeStatsRequest)\n        returns (NodeGetVolumeStatsResponse) {}\n\n    // \u83b7\u53d6\u8282\u70b9\u7684\u552f\u4e00 ID\n    rpc NodeGetId (NodeGetIdRequest)\n        returns (NodeGetIdResponse) {\n        option deprecated = true;\n    }\n\n    // \u8fd4\u56de\u8282\u70b9\u63d2\u4ef6\u7684\u80fd\u529b\n    rpc NodeGetCapabilities (NodeGetCapabilitiesRequest)\n        returns (NodeGetCapabilitiesResponse) {}\n\n    // \u83b7\u53d6\u8282\u70b9\u7684\u4e00\u4e9b\u4fe1\u606f\n    rpc NodeGetInfo (NodeGetInfoRequest)\n        returns (NodeGetInfoResponse) {}\n}\n</code></pre> </li> </ul> </li> </ul> <p>\u53ea\u9700\u8981\u5b9e\u73b0\u4e0a\u9762\u7684\u63a5\u53e3\u5c31\u53ef\u4ee5\u5b9e\u73b0\u4e00\u4e2a CSI \u63d2\u4ef6\u4e86\u3002\u867d\u7136 Kubernetes \u5e76\u672a\u89c4\u5b9a CSI \u63d2\u4ef6\u7684\u6253\u5305\u5b89\u88c5\uff0c\u4f46\u662f\u63d0\u4f9b\u4e86\u4ee5\u4e0b\u5efa\u8bae\u6765\u7b80\u5316\u6211\u4eec\u5728 Kubernetes \u4e0a\u5bb9\u5668\u5316 CSI Volume \u9a71\u52a8\u7a0b\u5e8f\u7684\u90e8\u7f72\u65b9\u6848\uff0c\u5177\u4f53\u7684\u65b9\u6848\u4ecb\u7ecd\u53ef\u4ee5\u67e5\u770b CSI \u89c4\u8303\u4ecb\u7ecd\u6587\u6863 https://github.com/kubernetes/community</p> <p></p> <p>\u6309\u7167\u4e0a\u56fe\u7684\u63a8\u8350\u65b9\u6848\uff0cCSI Controller \u90e8\u5206\u4ee5 StatefulSet \u6216\u8005 Deployment \u65b9\u5f0f\u90e8\u7f72\uff0cCSI Node \u90e8\u5206\u4ee5 DaemonSet \u65b9\u5f0f\u90e8\u7f72\u3002\u56e0\u4e3a\u8fd9\u4e24\u90e8\u5206\u5b9e\u73b0\u5728\u540c\u4e00\u4e2a CSI \u63d2\u4ef6\u7a0b\u5e8f\u4e2d\uff0c\u56e0\u6b64\u53ea\u9700\u8981\u628a\u8fd9\u4e2a CSI \u63d2\u4ef6\u4e0e External Components \u4ee5\u5bb9\u5668\u65b9\u5f0f\u90e8\u7f72\u5728\u540c\u4e00\u4e2a Pod\u4e2d\uff0c\u628a\u8fd9\u4e2a CSI \u63d2\u4ef6\u4e0e Driver registrar \u4ee5\u5bb9\u5668\u65b9\u5f0f\u90e8\u7f72\u5728 DaemonSet \u7684 Pod \u4e2d\uff0c\u5373\u53ef\u5b8c\u6210 CSI \u7684\u90e8\u7f72\u3002</p> <p>\u524d\u9762\u6211\u4eec\u4f7f\u7528\u7684 Rook \u90e8\u7f72\u7684 Ceph \u96c6\u7fa4\u5c31\u662f\u5b9e\u73b0\u4e86 CSI \u63d2\u4ef6\u7684:</p> <pre><code>$ kubectl get pods -n rook-ceph |grep plugin\ncsi-cephfsplugin-2s9d5                                 3/3     Running     0          21d\ncsi-cephfsplugin-fgp4v                                 3/3     Running     0          17d\ncsi-cephfsplugin-fv5nx                                 3/3     Running     0          21d\ncsi-cephfsplugin-mn8q4                                 3/3     Running     0          17d\ncsi-cephfsplugin-nf6h8                                 3/3     Running     0          21d\ncsi-cephfsplugin-provisioner-56c8b7ddf4-68h6d          4/4     Running     0          21d\ncsi-cephfsplugin-provisioner-56c8b7ddf4-rq4t6          4/4     Running     0          21d\ncsi-cephfsplugin-xwnl4                                 3/3     Running     0          21d\ncsi-rbdplugin-7r88w                                    3/3     Running     0          21d\ncsi-rbdplugin-95g5j                                    3/3     Running     0          21d\ncsi-rbdplugin-bnzpr                                    3/3     Running     0          21d\ncsi-rbdplugin-dvftb                                    3/3     Running     0          21d\ncsi-rbdplugin-jzmj2                                    3/3     Running     0          17d\ncsi-rbdplugin-provisioner-6ff4dd4b94-bvtss             5/5     Running     0          21d\ncsi-rbdplugin-provisioner-6ff4dd4b94-lfn68             5/5     Running     0          21d\ncsi-rbdplugin-trxb4                                    3/3     Running     0          17d\n</code></pre> <p>\u8fd9\u91cc\u5176\u5b9e\u662f\u5b9e\u73b0\u4e86 RBD \u548c CephFS \u4e24\u79cd CSI\uff0c\u7528 DaemonSet \u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8fd0\u884c\u4e86\u4e00\u4e2a\u5305\u542b <code>Driver registra</code> \u5bb9\u5668\u7684 Pod\uff0c\u5f53\u7136\u548c\u8282\u70b9\u76f8\u5173\u7684\u64cd\u4f5c\u6bd4\u5982 Mount/Unmount \u4e5f\u662f\u5728\u8fd9\u4e2a Pod \u91cc\u9762\u6267\u884c\u7684\uff0c\u5176\u4ed6\u7684\u6bd4\u5982 Provision\u3001Attach \u90fd\u662f\u5728\u53e6\u5916\u7684 </p> <pre><code>csi-rbdplugin-provisioner-xxx\n</code></pre> <p>Pod \u4e2d\u6267\u884c\u7684\u3002</p>"},{"location":"kubernetes_stroage/local/","title":"Local \u672c\u5730\u5b58\u50a8","text":"<p>\ue3c9</p>"},{"location":"kubernetes_stroage/local/#local","title":"Local \u5b58\u50a8","text":"<p>\u524d\u9762\u6211\u4eec\u6709\u901a\u8fc7 <code>hostPath</code> \u6216\u8005 <code>emptyDir</code> \u7684\u65b9\u5f0f\u6765\u6301\u4e45\u5316\u6211\u4eec\u7684\u6570\u636e\uff0c\u4f46\u662f\u663e\u7136\u6211\u4eec\u8fd8\u9700\u8981\u66f4\u52a0\u53ef\u9760\u7684\u5b58\u50a8\u6765\u4fdd\u5b58\u5e94\u7528\u7684\u6301\u4e45\u5316\u6570\u636e\uff0c\u8fd9\u6837\u5bb9\u5668\u5728\u91cd\u5efa\u540e\uff0c\u4f9d\u7136\u53ef\u4ee5\u4f7f\u7528\u4e4b\u524d\u7684\u6570\u636e\u3002\u4f46\u662f\u5b58\u50a8\u8d44\u6e90\u548c CPU \u8d44\u6e90\u4ee5\u53ca\u5185\u5b58\u8d44\u6e90\u6709\u5f88\u5927\u4e0d\u540c\uff0c\u4e3a\u4e86\u5c4f\u853d\u5e95\u5c42\u7684\u6280\u672f\u5b9e\u73b0\u7ec6\u8282\uff0c\u8ba9\u7528\u6237\u66f4\u52a0\u65b9\u4fbf\u7684\u4f7f\u7528\uff0cKubernetes \u4fbf\u5f15\u5165\u4e86 <code>PV</code> \u548c <code>PVC</code> \u4e24\u4e2a\u91cd\u8981\u7684\u8d44\u6e90\u5bf9\u8c61\u6765\u5b9e\u73b0\u5bf9\u5b58\u50a8\u7684\u7ba1\u7406\u3002</p>"},{"location":"kubernetes_stroage/local/#_1","title":"\u6982\u5ff5","text":"<p><code>PV</code> \u7684\u5168\u79f0\u662f\uff1a<code>PersistentVolume</code>\uff08\u6301\u4e45\u5316\u5377\uff09\uff0c\u662f\u5bf9\u5e95\u5c42\u5171\u4eab\u5b58\u50a8\u7684\u4e00\u79cd\u62bd\u8c61\uff0cPV \u7531\u7ba1\u7406\u5458\u8fdb\u884c\u521b\u5efa\u548c\u914d\u7f6e\uff0c\u5b83\u548c\u5177\u4f53\u7684\u5e95\u5c42\u7684\u5171\u4eab\u5b58\u50a8\u6280\u672f\u7684\u5b9e\u73b0\u65b9\u5f0f\u6709\u5173\uff0c\u6bd4\u5982 <code>Ceph</code>\u3001<code>GlusterFS</code>\u3001<code>NFS</code>\u3001<code>hostPath</code> \u7b49\uff0c\u90fd\u662f\u901a\u8fc7\u63d2\u4ef6\u673a\u5236\u5b8c\u6210\u4e0e\u5171\u4eab\u5b58\u50a8\u7684\u5bf9\u63a5\u3002</p> <p><code>PVC</code> \u7684\u5168\u79f0\u662f\uff1a</p> <pre><code>PersistentVolumeClaim\n</code></pre> <p>\uff08\u6301\u4e45\u5316\u5377\u58f0\u660e\uff09\uff0cPVC \u662f\u7528\u6237\u5b58\u50a8\u7684\u4e00\u79cd\u58f0\u660e\uff0cPVC \u548c Pod \u6bd4\u8f83\u7c7b\u4f3c\uff0cPod \u6d88\u8017\u7684\u662f\u8282\u70b9\uff0cPVC \u6d88\u8017\u7684\u662f PV \u8d44\u6e90\uff0cPod \u53ef\u4ee5\u8bf7\u6c42 CPU \u548c\u5185\u5b58\uff0c\u800c PVC \u53ef\u4ee5\u8bf7\u6c42\u7279\u5b9a\u7684\u5b58\u50a8\u7a7a\u95f4\u548c\u8bbf\u95ee\u6a21\u5f0f\u3002\u5bf9\u4e8e\u771f\u6b63\u4f7f\u7528\u5b58\u50a8\u7684\u7528\u6237\u4e0d\u9700\u8981\u5173\u5fc3\u5e95\u5c42\u7684\u5b58\u50a8\u5b9e\u73b0\u7ec6\u8282\uff0c\u53ea\u9700\u8981\u76f4\u63a5\u4f7f\u7528 PVC \u5373\u53ef\u3002</p> <p>\u4f46\u662f\u901a\u8fc7 PVC \u8bf7\u6c42\u5230\u4e00\u5b9a\u7684\u5b58\u50a8\u7a7a\u95f4\u4e5f\u5f88\u6709\u53ef\u80fd\u4e0d\u8db3\u4ee5\u6ee1\u8db3\u5e94\u7528\u5bf9\u4e8e\u5b58\u50a8\u8bbe\u5907\u7684\u5404\u79cd\u9700\u6c42\uff0c\u800c\u4e14\u4e0d\u540c\u7684\u5e94\u7528\u7a0b\u5e8f\u5bf9\u4e8e\u5b58\u50a8\u6027\u80fd\u7684\u8981\u6c42\u53ef\u80fd\u4e5f\u4e0d\u5c3d\u76f8\u540c\uff0c\u6bd4\u5982\u8bfb\u5199\u901f\u5ea6\u3001\u5e76\u53d1\u6027\u80fd\u7b49\uff0c\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e00\u95ee\u9898\uff0cKubernetes \u53c8\u4e3a\u6211\u4eec\u5f15\u5165\u4e86\u4e00\u4e2a\u65b0\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a<code>StorageClass</code>\uff0c\u901a\u8fc7 <code>StorageClass</code> \u7684\u5b9a\u4e49\uff0c\u7ba1\u7406\u5458\u53ef\u4ee5\u5c06\u5b58\u50a8\u8d44\u6e90\u5b9a\u4e49\u4e3a\u67d0\u79cd\u7c7b\u578b\u7684\u8d44\u6e90\uff0c\u6bd4\u5982\u5feb\u901f\u5b58\u50a8\u3001\u6162\u901f\u5b58\u50a8\u7b49\uff0c\u7528\u6237\u6839\u636e StorageClass \u7684\u63cf\u8ff0\u5c31\u53ef\u4ee5\u975e\u5e38\u76f4\u89c2\u7684\u77e5\u9053\u5404\u79cd\u5b58\u50a8\u8d44\u6e90\u7684\u5177\u4f53\u7279\u6027\u4e86\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u6839\u636e\u5e94\u7528\u7684\u7279\u6027\u53bb\u7533\u8bf7\u5408\u9002\u7684\u5b58\u50a8\u8d44\u6e90\u4e86\uff0c\u6b64\u5916 <code>StorageClass</code> \u8fd8\u53ef\u4ee5\u4e3a\u6211\u4eec\u81ea\u52a8\u751f\u6210 PV\uff0c\u514d\u53bb\u4e86\u6bcf\u6b21\u624b\u52a8\u521b\u5efa\u7684\u9ebb\u70e6\u3002</p>"},{"location":"kubernetes_stroage/local/#hostpath","title":"hostPath","text":"<p>\u6211\u4eec\u4e0a\u9762\u63d0\u5230\u4e86 PV \u662f\u5bf9\u5e95\u5c42\u5b58\u50a8\u6280\u672f\u7684\u4e00\u79cd\u62bd\u8c61\uff0cPV \u4e00\u822c\u90fd\u662f\u7531\u7ba1\u7406\u5458\u6765\u521b\u5efa\u548c\u914d\u7f6e\u7684\uff0c\u6211\u4eec\u9996\u5148\u6765\u521b\u5efa\u4e00\u4e2a <code>hostPath</code> \u7c7b\u578b\u7684 <code>PersistentVolume</code>\u3002Kubernetes \u652f\u6301 hostPath \u7c7b\u578b\u7684 PersistentVolume \u4f7f\u7528\u8282\u70b9\u4e0a\u7684\u6587\u4ef6\u6216\u76ee\u5f55\u6765\u6a21\u62df\u9644\u5e26\u7f51\u7edc\u7684\u5b58\u50a8\uff0c\u4f46\u662f\u9700\u8981\u6ce8\u610f\u7684\u662f\u5728\u751f\u4ea7\u96c6\u7fa4\u4e2d\uff0c\u6211\u4eec\u4e0d\u4f1a\u4f7f\u7528 hostPath\uff0c\u96c6\u7fa4\u7ba1\u7406\u5458\u4f1a\u63d0\u4f9b\u7f51\u7edc\u5b58\u50a8\u8d44\u6e90\uff0c\u6bd4\u5982 NFS \u5171\u4eab\u5377\u6216 Ceph \u5b58\u50a8\u5377\uff0c\u96c6\u7fa4\u7ba1\u7406\u5458\u8fd8\u53ef\u4ee5\u4f7f\u7528 <code>StorageClasses</code> \u6765\u8bbe\u7f6e\u52a8\u6001\u63d0\u4f9b\u5b58\u50a8\u3002\u56e0\u4e3a Pod \u5e76\u4e0d\u662f\u59cb\u7ec8\u56fa\u5b9a\u5728\u67d0\u4e2a\u8282\u70b9\u4e0a\u9762\u7684\uff0c\u6240\u4ee5\u8981\u4f7f\u7528 hostPath \u7684\u8bdd\u6211\u4eec\u5c31\u9700\u8981\u5c06 Pod \u56fa\u5b9a\u5728\u67d0\u4e2a\u8282\u70b9\u4e0a\uff0c\u8fd9\u6837\u663e\u7136\u5c31\u5927\u5927\u964d\u4f4e\u4e86\u5e94\u7528\u7684\u5bb9\u9519\u6027\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u5c06\u6d4b\u8bd5\u7684\u5e94\u7528\u56fa\u5b9a\u5728\u8282\u70b9 ydzs-node1 \u4e0a\u9762\uff0c\u9996\u5148\u5728\u8be5\u8282\u70b9\u4e0a\u9762\u521b\u5efa\u4e00\u4e2a </p> <pre><code>/data/k8s/test/hostpath\n</code></pre> <p>\u7684\u76ee\u5f55\uff0c\u7136\u540e\u5728\u8be5\u76ee\u5f55\u4e2d\u521b\u5efa\u4e00\u4e2a <code>index.html</code> \u7684\u6587\u4ef6\uff1a</p> <pre><code>$ echo 'Hello from Kubernetes hostpath storage' &gt; /data/k8s/test/hostpath/index.html\n</code></pre> <p>\u7136\u540e\u63a5\u4e0b\u6765\u521b\u5efa\u4e00\u4e2a hostPath \u7c7b\u578b\u7684 PV \u8d44\u6e90\u5bf9\u8c61\uff1a\uff08pv-hostpath.yaml\uff09</p> <pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: pv-hostpath\n  labels:\n    type: local\nspec:\n  storageClassName: manual\n  capacity:\n    storage: 10Gi\n  accessModes:\n    - ReadWriteOnce\n  hostPath:\n    path: \"/data/k8s/test/hostpath\"\n</code></pre> <p>\u914d\u7f6e\u6587\u4ef6\u4e2d\u6307\u5b9a\u4e86\u8be5\u5377\u4f4d\u4e8e\u96c6\u7fa4\u8282\u70b9\u4e0a\u7684 </p> <pre><code>/data/k8s/test/hostpath\n</code></pre> <p>\u76ee\u5f55\uff0c\u8fd8\u6307\u5b9a\u4e86 10G \u5927\u5c0f\u7684\u7a7a\u95f4\u548c <code>ReadWriteOnce</code> \u7684\u8bbf\u95ee\u6a21\u5f0f\uff0c\u8fd9\u610f\u5473\u7740\u8be5\u5377\u53ef\u4ee5\u5728\u5355\u4e2a\u8282\u70b9\u4e0a\u4ee5\u8bfb\u5199\u65b9\u5f0f\u6302\u8f7d\uff0c\u53e6\u5916\u8fd8\u5b9a\u4e49\u4e86\u540d\u79f0\u4e3a <code>manual</code> \u7684 <code>StorageClass</code>\uff0c\u8be5\u540d\u79f0\u7528\u6765\u5c06 </p> <pre><code>PersistentVolumeClaim\n</code></pre> <p>\u8bf7\u6c42\u7ed1\u5b9a\u5230\u8be5 <code>PersistentVolum</code>\u3002\u4e0b\u9762\u662f\u5173\u4e8e PV \u7684\u8fd9\u4e9b\u914d\u7f6e\u5c5e\u6027\u7684\u4e00\u4e9b\u8bf4\u660e\uff1a</p> <ul> <li> <p>Capacity\uff08\u5b58\u50a8\u80fd\u529b\uff09\uff1a\u4e00\u822c\u6765\u8bf4\uff0c\u4e00\u4e2a PV \u5bf9\u8c61\u90fd\u8981\u6307\u5b9a\u4e00\u4e2a\u5b58\u50a8\u80fd\u529b\uff0c\u901a\u8fc7 PV \u7684 <code>capacity</code> \u5c5e\u6027\u6765\u8bbe\u7f6e\u7684\uff0c\u76ee\u524d\u53ea\u652f\u6301\u5b58\u50a8\u7a7a\u95f4\u7684\u8bbe\u7f6e\uff0c\u5c31\u662f\u6211\u4eec\u8fd9\u91cc\u7684 <code>storage=10Gi</code>\uff0c\u4e0d\u8fc7\u672a\u6765\u53ef\u80fd\u4f1a\u52a0\u5165 <code>IOPS</code>\u3001\u541e\u5410\u91cf\u7b49\u6307\u6807\u7684\u914d\u7f6e\u3002</p> </li> <li> <p>AccessModes\uff08\u8bbf\u95ee\u6a21\u5f0f\uff09\uff1a\u7528\u6765\u5bf9 PV \u8fdb\u884c\u8bbf\u95ee\u6a21\u5f0f\u7684\u8bbe\u7f6e\uff0c\u7528\u4e8e\u63cf\u8ff0\u7528\u6237\u5e94\u7528\u5bf9\u5b58\u50a8\u8d44\u6e90\u7684\u8bbf\u95ee\u6743\u9650\uff0c\u8bbf\u95ee\u6743\u9650\u5305\u62ec\u4e0b\u9762\u51e0\u79cd\u65b9\u5f0f\uff1a</p> <ul> <li>ReadWriteOnce\uff08RWO\uff09\uff1a\u8bfb\u5199\u6743\u9650\uff0c\u4f46\u662f\u53ea\u80fd\u88ab\u5355\u4e2a\u8282\u70b9\u6302\u8f7d</li> <li>ReadOnlyMany\uff08ROX\uff09\uff1a\u53ea\u8bfb\u6743\u9650\uff0c\u53ef\u4ee5\u88ab\u591a\u4e2a\u8282\u70b9\u6302\u8f7d</li> <li>ReadWriteMany\uff08RWX\uff09\uff1a\u8bfb\u5199\u6743\u9650\uff0c\u53ef\u4ee5\u88ab\u591a\u4e2a\u8282\u70b9\u6302\u8f7d</li> </ul> <p>\u6ce8\u610f</p> <p>\u4e00\u4e9b PV \u53ef\u80fd\u652f\u6301\u591a\u79cd\u8bbf\u95ee\u6a21\u5f0f\uff0c\u4f46\u662f\u5728\u6302\u8f7d\u7684\u65f6\u5019\u53ea\u80fd\u4f7f\u7528\u4e00\u79cd\u8bbf\u95ee\u6a21\u5f0f\uff0c\u591a\u79cd\u8bbf\u95ee\u6a21\u5f0f\u662f\u4e0d\u4f1a\u751f\u6548\u7684\u3002</p> <p>\u4e0b\u56fe\u662f\u4e00\u4e9b\u5e38\u7528\u7684 Volume \u63d2\u4ef6\u652f\u6301\u7684\u8bbf\u95ee\u6a21\u5f0f\uff1a </p> </li> </ul> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f pv-hostpath.yaml\npersistentvolume/pv-hostpath created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u67e5\u770b PersistentVolume \u7684\u4fe1\u606f\uff0c\u8f93\u51fa\u7ed3\u679c\u663e\u793a\u8be5 <code>PersistentVolume</code> \u7684\u72b6\u6001\uff08STATUS\uff09 \u4e3a <code>Available</code>\u3002 \u8fd9\u610f\u5473\u7740\u5b83\u8fd8\u6ca1\u6709\u88ab\u7ed1\u5b9a\u7ed9 </p> <pre><code>PersistentVolumeClaim\n</code></pre> <p>\uff1a</p> <pre><code>$ kubectl get pv pv-hostpath\nNAME          CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE\npv-hostpath   10Gi       RWO            Retain           Available           manual                  58s\n</code></pre> <p>\u5176\u4e2d\u6709\u4e00\u9879 <code>RECLAIM POLICY</code> \u7684\u914d\u7f6e\uff0c\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 PV \u7684 </p> <pre><code>persistentVolumeReclaimPolicy\n</code></pre> <p>\uff08\u56de\u6536\u7b56\u7565\uff09\u5c5e\u6027\u6765\u8fdb\u884c\u914d\u7f6e\uff0c\u76ee\u524d PV \u652f\u6301\u7684\u7b56\u7565\u6709\u4e09\u79cd\uff1a</p> <ul> <li>Retain\uff08\u4fdd\u7559\uff09\uff1a\u4fdd\u7559\u6570\u636e\uff0c\u9700\u8981\u7ba1\u7406\u5458\u624b\u5de5\u6e05\u7406\u6570\u636e</li> <li>Recycle\uff08\u56de\u6536\uff09\uff1a\u6e05\u9664 PV \u4e2d\u7684\u6570\u636e\uff0c\u6548\u679c\u76f8\u5f53\u4e8e\u6267\u884c <code>rm -rf /thevoluem/*</code></li> <li>Delete\uff08\u5220\u9664\uff09\uff1a\u4e0e PV \u76f8\u8fde\u7684\u540e\u7aef\u5b58\u50a8\u5b8c\u6210 volume \u7684\u5220\u9664\u64cd\u4f5c\uff0c\u5f53\u7136\u8fd9\u5e38\u89c1\u4e8e\u4e91\u670d\u52a1\u5546\u7684\u5b58\u50a8\u670d\u52a1\uff0c\u6bd4\u5982 ASW EBS\u3002</li> </ul> <p>\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u76ee\u524d\u53ea\u6709 <code>NFS</code> \u548c <code>HostPath</code> \u4e24\u79cd\u7c7b\u578b\u652f\u6301\u56de\u6536\u7b56\u7565\uff0c\u5f53\u7136\u4e00\u822c\u6765\u8bf4\u8fd8\u662f\u8bbe\u7f6e\u4e3a <code>Retain</code> \u8fd9\u79cd\u7b56\u7565\u4fdd\u9669\u4e00\u70b9\u3002</p> <p>\u6ce8\u610f</p> <p><code>Recycle</code> \u7b56\u7565\u4f1a\u901a\u8fc7\u8fd0\u884c\u4e00\u4e2a busybox \u5bb9\u5668\u6765\u6267\u884c\u6570\u636e\u5220\u9664\u547d\u4ee4\uff0c\u9ed8\u8ba4\u5b9a\u4e49\u7684 busybox \u955c\u50cf\u662f\uff1a</p> <pre><code>gcr.io/google_containers/busybox:latest\n</code></pre> <p>\uff0c\u5e76\u4e14 </p> <pre><code>imagePullPolicy: Always\n</code></pre> <p>\uff0c\u5982\u679c\u9700\u8981\u8c03\u6574\u914d\u7f6e\uff0c\u9700\u8981\u589e\u52a0</p> <pre><code>kube-controller-manager\n</code></pre> <p>\u542f\u52a8\u53c2\u6570\uff1a</p> <pre><code>--pv-recycler-pod-template-filepath-hostpath\n</code></pre> <p>\u6765\u8fdb\u884c\u914d\u7f6e\u3002</p> <p>\u5173\u4e8e PV \u7684\u72b6\u6001\uff0c\u5b9e\u9645\u4e0a\u63cf\u8ff0\u7684\u662f PV \u7684\u751f\u547d\u5468\u671f\u7684\u67d0\u4e2a\u9636\u6bb5\uff0c\u4e00\u4e2a PV \u7684\u751f\u547d\u5468\u671f\u4e2d\uff0c\u53ef\u80fd\u4f1a\u5904\u4e8e4\u79cd\u4e0d\u540c\u7684\u9636\u6bb5\uff1a</p> <ul> <li>Available\uff08\u53ef\u7528\uff09\uff1a\u8868\u793a\u53ef\u7528\u72b6\u6001\uff0c\u8fd8\u672a\u88ab\u4efb\u4f55 PVC \u7ed1\u5b9a</li> <li>Bound\uff08\u5df2\u7ed1\u5b9a\uff09\uff1a\u8868\u793a PVC \u5df2\u7ecf\u88ab PVC \u7ed1\u5b9a</li> <li>Released\uff08\u5df2\u91ca\u653e\uff09\uff1aPVC \u88ab\u5220\u9664\uff0c\u4f46\u662f\u8d44\u6e90\u8fd8\u672a\u88ab\u96c6\u7fa4\u91cd\u65b0\u58f0\u660e</li> <li>Failed\uff08\u5931\u8d25\uff09\uff1a \u8868\u793a\u8be5 PV \u7684\u81ea\u52a8\u56de\u6536\u5931\u8d25</li> </ul> <p>\u73b0\u5728\u6211\u4eec\u521b\u5efa\u5b8c\u6210\u4e86 PV\uff0c\u5982\u679c\u6211\u4eec\u9700\u8981\u4f7f\u7528\u8fd9\u4e2a PV \u7684\u8bdd\uff0c\u5c31\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7684 PVC \u6765\u548c\u4ed6\u8fdb\u884c\u7ed1\u5b9a\u4e86\uff0c\u5c31\u7c7b\u4f3c\u4e8e\u6211\u4eec\u7684\u670d\u52a1\u662f\u901a\u8fc7 Pod \u6765\u8fd0\u884c\u7684\uff0c\u800c\u4e0d\u662f Node\uff0c\u53ea\u662f Pod \u8dd1\u5728 Node \u4e0a\u800c\u5df2\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u4e00\u4e2a </p> <pre><code>PersistentVolumeClaim\n</code></pre> <p>\uff0cPod \u4f7f\u7528 PVC \u6765\u8bf7\u6c42\u7269\u7406\u5b58\u50a8\uff0c\u6211\u4eec\u8fd9\u91cc\u521b\u5efa\u7684 PVC \u8bf7\u6c42\u81f3\u5c11 3G \u5bb9\u91cf\u7684\u5377\uff0c\u8be5\u5377\u81f3\u5c11\u53ef\u4ee5\u4e3a\u4e00\u4e2a\u8282\u70b9\u63d0\u4f9b\u8bfb\u5199\u8bbf\u95ee\uff0c\u4e0b\u9762\u662f PVC \u7684\u914d\u7f6e\u6587\u4ef6\uff1a(pvc-hostpath.yaml)</p> <pre><code>apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: pvc-hostpath\nspec:\n  storageClassName: manual\n  accessModes:\n  - ReadWriteOnce\n  resources:\n    requests:\n      storage: 3Gi\n</code></pre> <p>\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a PVC \u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl create -f pvc-hostpath.yaml\npersistentvolumeclaim/pvc-hostpath created\n</code></pre> <p>\u521b\u5efa PVC \u4e4b\u540e\uff0cKubernetes \u5c31\u4f1a\u53bb\u67e5\u627e\u6ee1\u8db3\u6211\u4eec\u58f0\u660e\u8981\u6c42\u7684 PV\uff0c\u6bd4\u5982 <code>storageClassName</code>\u3001<code>accessModes</code> \u4ee5\u53ca\u5bb9\u91cf\u8fd9\u4e9b\u662f\u5426\u6ee1\u8db3\u8981\u6c42\uff0c\u5982\u679c\u6ee1\u8db3\u8981\u6c42\u5c31\u4f1a\u5c06 PV \u548c PVC \u7ed1\u5b9a\u5728\u4e00\u8d77\u3002</p> <p>\u6ce8\u610f</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\u76ee\u524d PV \u548c PVC \u4e4b\u95f4\u662f\u4e00\u5bf9\u4e00\u7ed1\u5b9a\u7684\u5173\u7cfb\uff0c\u4e5f\u5c31\u662f\u8bf4\u4e00\u4e2a PV \u53ea\u80fd\u88ab\u4e00\u4e2a PVC \u7ed1\u5b9a\u3002</p> <p>\u6211\u4eec\u73b0\u5728\u518d\u6b21\u67e5\u770b PV \u7684\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get pv -l type=local\nNAME          CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                  STORAGECLASS   REASON   AGE\npv-hostpath   10Gi       RWO            Retain           Bound    default/pvc-hostpath   manual                  81m\n</code></pre> <p>\u73b0\u5728\u8f93\u51fa\u7684 STATUS \u4e3a <code>Bound</code>\uff0c\u67e5\u770b PVC \u7684\u4fe1\u606f\uff1a</p> <pre><code>$ kubectl get pvc pvc-hostpath\nNAME           STATUS   VOLUME        CAPACITY   ACCESS MODES   STORAGECLASS   AGE\npvc-hostpath   Bound    pv-hostpath   10Gi       RWO            manual         6m47s\n</code></pre> <p>\u8f93\u51fa\u7ed3\u679c\u8868\u660e\u8be5 PVC \u7ed1\u5b9a\u4e86\u5230\u4e86\u4e0a\u9762\u6211\u4eec\u521b\u5efa\u7684 <code>pv-hostpath</code> \u8fd9\u4e2a PV \u4e0a\u9762\u4e86\uff0c\u6211\u4eec\u8fd9\u91cc\u867d\u7136\u58f0\u660e\u76843G\u7684\u5bb9\u91cf\uff0c\u4f46\u662f\u7531\u4e8e PV \u91cc\u9762\u662f 10G\uff0c\u6240\u4ee5\u663e\u7136\u4e5f\u662f\u6ee1\u8db3\u8981\u6c42\u7684\u3002</p> <p>PVC \u51c6\u5907\u597d\u8fc7\u540e\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u53ef\u4ee5\u6765\u521b\u5efa Pod \u4e86\uff0c\u8be5 Pod \u4f7f\u7528\u4e0a\u9762\u6211\u4eec\u58f0\u660e\u7684 PVC \u4f5c\u4e3a\u5b58\u50a8\u5377\uff1a(pv-hostpath-pod.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: pv-hostpath-pod\nspec:\n  volumes:\n  - name: pv-hostpath\n    persistentVolumeClaim:\n      claimName: pvc-hostpath\n  nodeSelector:\n    kubernetes.io/hostname: ydzs-node1\n  containers:\n  - name: task-pv-container\n    image: nginx\n    ports:\n    - containerPort: 80\n    volumeMounts:\n    - mountPath: \"/usr/share/nginx/html\"\n      name: pv-hostpath\n</code></pre> <p>\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u7531\u4e8e\u6211\u4eec\u521b\u5efa\u7684 PV \u771f\u6b63\u7684\u5b58\u50a8\u5728\u8282\u70b9 ydzs-node1 \u4e0a\u9762\uff0c\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u5fc5\u987b\u628a Pod \u56fa\u5b9a\u5728\u8fd9\u4e2a\u8282\u70b9\u4e0b\u9762\uff0c\u53e6\u5916\u53ef\u4ee5\u6ce8\u610f\u5230 Pod \u7684\u914d\u7f6e\u6587\u4ef6\u6307\u5b9a\u4e86 </p> <pre><code>PersistentVolumeClaim\n</code></pre> <p>\uff0c\u4f46\u6ca1\u6709\u6307\u5b9a <code>PersistentVolume</code>\uff0c\u5bf9 Pod \u800c\u8a00\uff0c<code>PVC</code> \u5c31\u662f\u4e00\u4e2a\u5b58\u50a8\u5377\u3002\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a Pod \u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl create -f pv-hostpath-pod.yaml\npod/pv-hostpath-pod created\n$ kubectl get pod pv-hostpath-pod\nNAME              READY   STATUS    RESTARTS   AGE\npv-hostpath-pod   1/1     Running   0          105s\n</code></pre> <p>\u8fd0\u884c\u6210\u529f\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u6253\u5f00\u4e00\u4e2a shell \u8bbf\u95ee Pod \u4e2d\u7684\u5bb9\u5668\uff1a</p> <pre><code>$ kubectl exec -it pv-hostpath-pod -- /bin/bash\n</code></pre> <p>\u5728 shell \u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u9a8c\u8bc1 nginx \u7684\u6570\u636e \u662f\u5426\u6b63\u5728\u4ece hostPath \u5377\u63d0\u4f9b index.html \u6587\u4ef6\uff1a</p> <pre><code>root@pv-hostpath-pod:/# apt-get update\nroot@pv-hostpath-pod:/# apt-get install curl -y\nroot@pv-hostpath-pod:/# curl localhost\nHello from Kubernetes hostpath storage\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8f93\u51fa\u7ed3\u679c\u662f\u6211\u4eec\u524d\u9762\u5199\u5230 hostPath \u5377\u79cd\u7684 index.html \u6587\u4ef6\u4e2d\u7684\u5185\u5bb9\uff0c\u540c\u6837\u6211\u4eec\u53ef\u4ee5\u628a Pod \u5220\u9664\uff0c\u7136\u540e\u518d\u6b21\u91cd\u5efa\u518d\u6d4b\u8bd5\u4e00\u6b21\uff0c\u53ef\u4ee5\u53d1\u73b0\u5185\u5bb9\u8fd8\u662f\u6211\u4eec\u5728 hostPath \u79cd\u8bbe\u7f6e\u7684\u5185\u5bb9\u3002</p> <p>\u6211\u4eec\u5728\u6301\u4e45\u5316\u5bb9\u5668\u6570\u636e\u7684\u65f6\u5019\u4f7f\u7528 PV/PVC \u6709\u4ec0\u4e48\u597d\u5904\u5462\uff1f\u6bd4\u5982\u6211\u4eec\u8fd9\u91cc\u4e4b\u524d\u76f4\u63a5\u5728 Pod \u4e0b\u9762\u4e5f\u53ef\u4ee5\u4f7f\u7528 hostPath \u6765\u6301\u4e45\u5316\u6570\u636e\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u8981\u8d39\u52b2\u53bb\u521b\u5efa PV\u3001PVC \u5bf9\u8c61\u6765\u5f15\u7528\u5462\uff1fPVC \u548c PV \u7684\u8bbe\u8ba1\uff0c\u5176\u5b9e\u8ddf<code>\u9762\u5411\u5bf9\u8c61</code>\u7684\u601d\u60f3\u5b8c\u5168\u4e00\u81f4\uff0cPVC \u53ef\u4ee5\u7406\u89e3\u4e3a\u6301\u4e45\u5316\u5b58\u50a8\u7684\u63a5\u53e3\uff0c\u5b83\u63d0\u4f9b\u4e86\u5bf9\u67d0\u79cd\u6301\u4e45\u5316\u5b58\u50a8\u7684\u63cf\u8ff0\uff0c\u4f46\u4e0d\u63d0\u4f9b\u5177\u4f53\u7684\u5b9e\u73b0\uff1b\u800c\u8fd9\u4e2a\u6301\u4e45\u5316\u5b58\u50a8\u7684\u5b9e\u73b0\u90e8\u5206\u5219\u7531 PV \u8d1f\u8d23\u5b8c\u6210\u3002\u8fd9\u6837\u505a\u7684\u597d\u5904\u662f\uff0c\u4f5c\u4e3a\u5e94\u7528\u5f00\u53d1\u8005\uff0c\u6211\u4eec\u53ea\u9700\u8981\u8ddf PVC \u8fd9\u4e2a\u63a5\u53e3\u6253\u4ea4\u9053\uff0c\u800c\u4e0d\u5fc5\u5173\u5fc3\u5177\u4f53\u7684\u5b9e\u73b0\u662f hostPath\u3001NFS \u8fd8\u662f Ceph\u3002\u6bd5\u7adf\u8fd9\u4e9b\u5b58\u50a8\u76f8\u5173\u7684\u77e5\u8bc6\u592a\u4e13\u4e1a\u4e86\uff0c\u5e94\u8be5\u4ea4\u7ed9\u4e13\u4e1a\u7684\u4eba\u53bb\u505a\uff0c\u8fd9\u6837\u5bf9\u4e8e\u6211\u4eec\u7684 Pod \u6765\u8bf4\u5c31\u4e0d\u7528\u7ba1\u5177\u4f53\u7684\u7ec6\u8282\u4e86\uff0c\u4f60\u53ea\u9700\u8981\u7ed9\u6211\u4e00\u4e2a\u53ef\u7528\u7684 PVC \u5373\u53ef\u4e86\uff0c\u8fd9\u6837\u662f\u4e0d\u662f\u5c31\u5b8c\u5168\u5c4f\u853d\u4e86\u7ec6\u8282\u548c\u89e3\u8026\u4e86\u554a\uff0c\u6240\u4ee5\u6211\u4eec\u66f4\u5e94\u8be5\u4f7f\u7528 PV\u3001PVC \u8fd9\u79cd\u65b9\u5f0f\u3002</p>"},{"location":"kubernetes_stroage/local/#local_pv","title":"Local PV","text":"<p>\u4e0a\u9762\u6211\u4eec\u521b\u5efa\u4e86\u540e\u7aef\u662f hostPath \u7c7b\u578b\u7684 PV \u8d44\u6e90\u5bf9\u8c61\uff0c\u6211\u4eec\u4e5f\u63d0\u5230\u4e86\uff0c\u4f7f\u7528 hostPath \u6709\u4e00\u4e2a\u5c40\u9650\u6027\u5c31\u662f\uff0c\u6211\u4eec\u7684 Pod \u4e0d\u80fd\u968f\u4fbf\u6f02\u79fb\uff0c\u9700\u8981\u56fa\u5b9a\u5230\u4e00\u4e2a\u8282\u70b9\u4e0a\uff0c\u56e0\u4e3a\u4e00\u65e6\u6f02\u79fb\u5230\u5176\u4ed6\u8282\u70b9\u4e0a\u53bb\u4e86\u5bbf\u4e3b\u673a\u4e0a\u9762\u5c31\u6ca1\u6709\u5bf9\u5e94\u7684\u6570\u636e\u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u5728\u4f7f\u7528 hostPath \u7684\u65f6\u5019\u90fd\u4f1a\u642d\u914d nodeSelector \u6765\u8fdb\u884c\u4f7f\u7528\u3002\u4f46\u662f\u4f7f\u7528 hostPath \u660e\u663e\u4e5f\u6709\u4e00\u4e9b\u597d\u5904\u7684\uff0c\u56e0\u4e3a PV \u76f4\u63a5\u4f7f\u7528\u7684\u662f\u672c\u5730\u78c1\u76d8\uff0c\u5c24\u5176\u662f SSD \u76d8\uff0c\u5b83\u7684\u8bfb\u5199\u6027\u80fd\u76f8\u6bd4\u4e8e\u5927\u591a\u6570\u8fdc\u7a0b\u5b58\u50a8\u6765\u8bf4\uff0c\u8981\u597d\u5f97\u591a\uff0c\u6240\u4ee5\u5bf9\u4e8e\u4e00\u4e9b\u5bf9\u78c1\u76d8 IO \u8981\u6c42\u6bd4\u8f83\u9ad8\u7684\u5e94\u7528\u6bd4\u5982 etcd \u5c31\u975e\u5e38\u5b9e\u7528\u4e86\u3002\u4e0d\u8fc7\u5462\uff0c\u76f8\u6bd4\u4e8e\u6b63\u5e38\u7684 PV \u6765\u8bf4\uff0c\u4f7f\u7528\u4e86 hostPath \u7684\u8fd9\u4e9b\u8282\u70b9\u4e00\u65e6\u5b95\u673a\u6570\u636e\u5c31\u53ef\u80fd\u4e22\u5931\uff0c\u6240\u4ee5\u8fd9\u5c31\u8981\u6c42\u4f7f\u7528 hostPath \u7684\u5e94\u7528\u5fc5\u987b\u5177\u5907\u6570\u636e\u5907\u4efd\u548c\u6062\u590d\u7684\u80fd\u529b\uff0c\u5141\u8bb8\u4f60\u628a\u8fd9\u4e9b\u6570\u636e\u5b9a\u65f6\u5907\u4efd\u5728\u5176\u4ed6\u4f4d\u7f6e\u3002</p> <p>\u6240\u4ee5\u5728 hostPath \u7684\u57fa\u7840\u4e0a\uff0cKubernetes \u4f9d\u9760 PV\u3001PVC \u5b9e\u73b0\u4e86\u4e00\u4e2a\u65b0\u7684\u7279\u6027\uff0c\u8fd9\u4e2a\u7279\u6027\u7684\u540d\u5b57\u53eb\u4f5c\uff1a</p> <pre><code>Local Persistent Volume\n</code></pre> <p>\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u8bf4\u7684 <code>Local PV</code>\u3002</p> <p>\u5176\u5b9e <code>Local PV</code> \u5b9e\u73b0\u7684\u529f\u80fd\u5c31\u975e\u5e38\u7c7b\u4f3c\u4e8e <code>hostPath</code> \u52a0\u4e0a <code>nodeAffinity</code>\uff0c\u6bd4\u5982\uff0c\u4e00\u4e2a Pod \u53ef\u4ee5\u58f0\u660e\u4f7f\u7528\u7c7b\u578b\u4e3a Local \u7684 PV\uff0c\u800c\u8fd9\u4e2a PV \u5176\u5b9e\u5c31\u662f\u4e00\u4e2a hostPath \u7c7b\u578b\u7684 Volume\u3002\u5982\u679c\u8fd9\u4e2a hostPath \u5bf9\u5e94\u7684\u76ee\u5f55\uff0c\u5df2\u7ecf\u5728\u8282\u70b9 A \u4e0a\u88ab\u4e8b\u5148\u521b\u5efa\u597d\u4e86\uff0c\u90a3\u4e48\uff0c\u6211\u53ea\u9700\u8981\u518d\u7ed9\u8fd9\u4e2a Pod \u52a0\u4e0a\u4e00\u4e2a <code>nodeAffinity=nodeA</code>\uff0c\u4e0d\u5c31\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a Volume \u4e86\u5417\uff1f\u7406\u8bba\u4e0a\u786e\u5b9e\u662f\u53ef\u884c\u7684\uff0c\u4f46\u662f\u4e8b\u5b9e\u4e0a\uff0c\u6211\u4eec\u7edd\u4e0d\u5e94\u8be5\u628a\u4e00\u4e2a\u5bbf\u4e3b\u673a\u4e0a\u7684\u76ee\u5f55\u5f53\u4f5c PV \u6765\u4f7f\u7528\uff0c\u56e0\u4e3a\u672c\u5730\u76ee\u5f55\u7684\u5b58\u50a8\u884c\u4e3a\u662f\u5b8c\u5168\u4e0d\u53ef\u63a7\uff0c\u5b83\u6240\u5728\u7684\u78c1\u76d8\u968f\u65f6\u90fd\u53ef\u80fd\u88ab\u5e94\u7528\u5199\u6ee1\uff0c\u751a\u81f3\u9020\u6210\u6574\u4e2a\u5bbf\u4e3b\u673a\u5b95\u673a\u3002\u6240\u4ee5\uff0c\u4e00\u822c\u6765\u8bf4 <code>Local PV</code> \u5bf9\u5e94\u7684\u5b58\u50a8\u4ecb\u8d28\u662f\u4e00\u5757\u989d\u5916\u6302\u8f7d\u5728\u5bbf\u4e3b\u673a\u7684\u78c1\u76d8\u6216\u8005\u5757\u8bbe\u5907\uff0c\u6211\u4eec\u53ef\u4ee5\u8ba4\u4e3a\u5c31\u662f<code>\u4e00\u4e2a PV \u4e00\u5757\u76d8</code>\u3002</p> <p>\u53e6\u5916\u4e00\u4e2a <code>Local PV</code> \u548c\u666e\u901a\u7684 PV \u6709\u4e00\u4e2a\u5f88\u5927\u7684\u4e0d\u540c\u5728\u4e8e <code>Local PV</code> \u53ef\u4ee5\u4fdd\u8bc1 Pod \u59cb\u7ec8\u80fd\u591f\u88ab\u6b63\u786e\u5730\u8c03\u5ea6\u5230\u5b83\u6240\u8bf7\u6c42\u7684 <code>Local PV</code> \u6240\u5728\u7684\u8282\u70b9\u4e0a\u9762\uff0c\u5bf9\u4e8e\u666e\u901a\u7684 PV \u6765\u8bf4\uff0cKubernetes \u90fd\u662f\u5148\u8c03\u5ea6 Pod \u5230\u67d0\u4e2a\u8282\u70b9\u4e0a\uff0c\u7136\u540e\u518d\u6301\u4e45\u5316\u8282\u70b9\u4e0a\u7684 Volume \u76ee\u5f55\uff0c\u8fdb\u800c\u5b8c\u6210 Volume \u76ee\u5f55\u4e0e\u5bb9\u5668\u7684\u7ed1\u5b9a\u6302\u8f7d\uff0c\u4f46\u662f\u5bf9\u4e8e <code>Local PV</code> \u6765\u8bf4\uff0c\u8282\u70b9\u4e0a\u53ef\u4f9b\u4f7f\u7528\u7684\u78c1\u76d8\u5fc5\u987b\u662f\u63d0\u524d\u51c6\u5907\u597d\u7684\uff0c\u56e0\u4e3a\u5b83\u4eec\u5728\u4e0d\u540c\u8282\u70b9\u4e0a\u7684\u6302\u8f7d\u60c5\u51b5\u53ef\u80fd\u5b8c\u5168\u4e0d\u540c\uff0c\u751a\u81f3\u6709\u7684\u8282\u70b9\u53ef\u4ee5\u6ca1\u8fd9\u79cd\u78c1\u76d8\uff0c\u6240\u4ee5\uff0c\u8fd9\u65f6\u5019\uff0c\u8c03\u5ea6\u5668\u5c31\u5fc5\u987b\u80fd\u591f\u77e5\u9053\u6240\u6709\u8282\u70b9\u4e0e <code>Local PV</code> \u5bf9\u5e94\u7684\u78c1\u76d8\u7684\u5173\u8054\u5173\u7cfb\uff0c\u7136\u540e\u6839\u636e\u8fd9\u4e2a\u4fe1\u606f\u6765\u8c03\u5ea6 Pod\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f\u5728\u8c03\u5ea6\u7684\u65f6\u5019\u8003\u8651 Volume \u7684\u5206\u5e03\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u6d4b\u8bd5\u4e0b <code>Local PV</code> \u7684\u4f7f\u7528\uff0c\u5f53\u7136\u6309\u7167\u4e0a\u9762\u6211\u4eec\u7684\u5206\u6790\u6211\u4eec\u5e94\u8be5\u7ed9\u5bbf\u4e3b\u673a\u6302\u8f7d\u5e76\u683c\u5f0f\u5316\u4e00\u4e2a\u53ef\u7528\u7684\u78c1\u76d8\uff0c\u6211\u4eec\u8fd9\u91cc\u5c31\u6682\u65f6\u5c06 ydzs-node1 \u8282\u70b9\u4e0a\u7684 <code>/data/k8s/localpv</code> \u8fd9\u4e2a\u76ee\u5f55\u770b\u6210\u662f\u6302\u8f7d\u7684\u4e00\u4e2a\u72ec\u7acb\u7684\u78c1\u76d8\u3002\u73b0\u5728\u6211\u4eec\u6765\u58f0\u660e\u4e00\u4e2a <code>Local PV</code> \u7c7b\u578b\u7684 PV\uff0c\u5982\u4e0b\u6240\u793a\uff1a(pv-local.yaml)</p> <pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: pv-local\nspec:\n  capacity:\n    storage: 5Gi\n  volumeMode: Filesystem\n  accessModes:\n  - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Delete\n  storageClassName: local-storage\n  local:\n    path: /data/k8s/localpv  # ydzs-node1\u8282\u70b9\u4e0a\u7684\u76ee\u5f55\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n      - matchExpressions:\n        - key: kubernetes.io/hostname\n          operator: In\n          values:\n          - ydzs-node1\n</code></pre> <p>\u548c\u524d\u9762\u6211\u4eec\u5b9a\u4e49\u7684 PV \u4e0d\u540c\uff0c\u6211\u4eec\u8fd9\u91cc\u5b9a\u4e49\u4e86\u4e00\u4e2a <code>local</code> \u5b57\u6bb5\uff0c\u8868\u660e\u5b83\u662f\u4e00\u4e2a <code>Local PV</code>\uff0c\u800c path \u5b57\u6bb5\uff0c\u6307\u5b9a\u7684\u6b63\u662f\u8fd9\u4e2a PV \u5bf9\u5e94\u7684\u672c\u5730\u78c1\u76d8\u7684\u8def\u5f84\uff0c\u5373\uff1a<code>/data/k8s/localpv</code>\uff0c\u8fd9\u4e5f\u5c31\u610f\u5473\u7740\u5982\u679c Pod \u8981\u60f3\u4f7f\u7528\u8fd9\u4e2a PV\uff0c\u90a3\u5b83\u5c31\u5fc5\u987b\u8fd0\u884c\u5728 ydzs-node1 \u8282\u70b9\u4e0a\u3002\u6240\u4ee5\uff0c\u5728\u8fd9\u4e2a PV \u7684\u5b9a\u4e49\u91cc\uff0c\u6dfb\u52a0\u4e86\u4e00\u4e2a\u8282\u70b9\u4eb2\u548c\u6027 <code>nodeAffinity</code> \u5b57\u6bb5\u6307\u5b9a ydzs-node1 \u8fd9\u4e2a\u8282\u70b9\u3002\u8fd9\u6837\uff0c\u8c03\u5ea6\u5668\u5728\u8c03\u5ea6 Pod \u7684\u65f6\u5019\uff0c\u5c31\u80fd\u591f\u77e5\u9053\u4e00\u4e2a PV \u4e0e\u8282\u70b9\u7684\u5bf9\u5e94\u5173\u7cfb\uff0c\u4ece\u800c\u505a\u51fa\u6b63\u786e\u7684\u9009\u62e9\u3002</p> <p>\u76f4\u63a5\u521b\u5efa\u4e0a\u9762\u7684\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f pv-local.yaml \npersistentvolume/pv-local created\n$ kubectl get pv\nNAME      CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS  CLAIM      STORAGECLASS      REASON   AGE\npv-local  5Gi        RWO            Delete           Available          local-storage              24s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a PV \u521b\u5efa\u540e\uff0c\u8fdb\u5165\u4e86 <code>Available</code>\uff08\u53ef\u7528\uff09\u72b6\u6001\u3002\u8fd9\u4e2a\u65f6\u5019\u5982\u679c\u6309\u7167\u524d\u9762\u63d0\u5230\u7684\uff0c\u6211\u4eec\u8981\u4f7f\u7528\u8fd9\u4e2a <code>Local PV</code> \u7684\u8bdd\u5c31\u9700\u8981\u53bb\u521b\u5efa\u4e00\u4e2a PVC \u548c\u4ed6\u8fdb\u884c\u7ed1\u5b9a\uff1a(pvc-local.yaml)</p> <pre><code>kind: PersistentVolumeClaim\napiVersion: v1\nmetadata:\n  name: pvc-local\nspec:\n  accessModes:\n  - ReadWriteOnce\n  resources:\n    requests:\n      storage: 5Gi\n  storageClassName: local-storage\n</code></pre> <p>\u540c\u6837\u8981\u6ce8\u610f\u58f0\u660e\u7684\u8fd9\u4e9b\u5c5e\u6027\u9700\u8981\u548c\u4e0a\u9762\u7684 PV \u5bf9\u5e94\uff0c\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a\u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f pvc-local.yaml \npersistentvolumeclaim/pvc-local created\n$ kubectl get pvc\nNAME           STATUS   VOLUME        CAPACITY   ACCESS MODES   STORAGECLASS    AGE\npvc-local      Bound    pv-local      5Gi        RWO            local-storage   38s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u73b0\u5728 PVC \u548c PV \u5df2\u7ecf\u5904\u4e8e <code>Bound</code> \u7ed1\u5b9a\u72b6\u6001\u4e86\u3002\u4f46\u5b9e\u9645\u4e0a\u8fd9\u662f\u4e0d\u7b26\u5408\u6211\u4eec\u7684\u9700\u6c42\u7684\uff0c\u6bd4\u5982\u73b0\u5728\u6211\u4eec\u7684 Pod \u58f0\u660e\u4f7f\u7528\u8fd9\u4e2a pvc-local\uff0c\u5e76\u4e14\u6211\u4eec\u4e5f\u660e\u786e\u89c4\u5b9a\uff0c\u8fd9\u4e2a Pod \u53ea\u80fd\u8fd0\u884c\u5728 ydzs-node2 \u8fd9\u4e2a\u8282\u70b9\u4e0a\uff0c\u5982\u679c\u6309\u7167\u4e0a\u9762\u6211\u4eec\u8fd9\u91cc\u7684\u64cd\u4f5c\uff0c\u8fd9\u4e2a pvc-local \u662f\u4e0d\u662f\u5c31\u548c\u6211\u4eec\u8fd9\u91cc\u7684 pv-local \u8fd9\u4e2a <code>Local PV</code> \u7ed1\u5b9a\u5728\u4e00\u8d77\u4e86\uff0c\u4f46\u662f\u8fd9\u4e2a PV \u7684\u5b58\u50a8\u5238\u53c8\u5728 ydzs-node1 \u8fd9\u4e2a\u8282\u70b9\u4e0a\uff0c\u663e\u7136\u5c31\u4f1a\u51fa\u73b0\u51b2\u7a81\u4e86\uff0c\u90a3\u4e48\u8fd9\u4e2a Pod \u7684\u8c03\u5ea6\u80af\u5b9a\u5c31\u4f1a\u5931\u8d25\u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u5728\u4f7f\u7528 <code>Local PV</code> \u7684\u65f6\u5019\uff0c\u5fc5\u987b\u60f3\u529e\u6cd5\u5ef6\u8fdf\u8fd9\u4e2a<code>\u7ed1\u5b9a</code>\u64cd\u4f5c\u3002</p> <p>\u8981\u600e\u4e48\u6765\u5b9e\u73b0\u8fd9\u4e2a\u5ef6\u8fdf\u7ed1\u5b9a\u5462\uff1f\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa <code>StorageClass</code> \u6765\u6307\u5b9a\u8fd9\u4e2a\u52a8\u4f5c\uff0c\u5728 StorageClass \u79cd\u6709\u4e00\u4e2a </p> <pre><code>volumeBindingMode=WaitForFirstConsumer\n</code></pre> <p>\u7684\u5c5e\u6027\uff0c\u5c31\u662f\u544a\u8bc9 Kubernetes \u5728\u53d1\u73b0\u8fd9\u4e2a StorageClass \u5173\u8054\u7684 PVC \u4e0e PV \u53ef\u4ee5\u7ed1\u5b9a\u5728\u4e00\u8d77\uff0c\u4f46\u4e0d\u8981\u73b0\u5728\u5c31\u7acb\u523b\u6267\u884c\u7ed1\u5b9a\u64cd\u4f5c\uff08\u5373\uff1a\u8bbe\u7f6e PVC \u7684 VolumeName \u5b57\u6bb5\uff09\uff0c\u800c\u662f\u8981\u7b49\u5230\u7b2c\u4e00\u4e2a\u58f0\u660e\u4f7f\u7528\u8be5 PVC \u7684 Pod \u51fa\u73b0\u5728\u8c03\u5ea6\u5668\u4e4b\u540e\uff0c\u8c03\u5ea6\u5668\u518d\u7efc\u5408\u8003\u8651\u6240\u6709\u7684\u8c03\u5ea6\u89c4\u5219\uff0c\u5f53\u7136\u4e5f\u5305\u62ec\u6bcf\u4e2a PV \u6240\u5728\u7684\u8282\u70b9\u4f4d\u7f6e\uff0c\u6765\u7edf\u4e00\u51b3\u5b9a\uff0c\u8fd9\u4e2a Pod \u58f0\u660e\u7684 PVC\uff0c\u5230\u5e95\u5e94\u8be5\u8ddf\u54ea\u4e2a PV \u8fdb\u884c\u7ed1\u5b9a\u3002\u901a\u8fc7\u8fd9\u4e2a\u5ef6\u8fdf\u7ed1\u5b9a\u673a\u5236\uff0c\u539f\u672c\u5b9e\u65f6\u53d1\u751f\u7684 PVC \u548c PV \u7684\u7ed1\u5b9a\u8fc7\u7a0b\uff0c\u5c31\u88ab\u5ef6\u8fdf\u5230\u4e86 Pod \u7b2c\u4e00\u6b21\u8c03\u5ea6\u7684\u65f6\u5019\u5728\u8c03\u5ea6\u5668\u4e2d\u8fdb\u884c\uff0c\u4ece\u800c\u4fdd\u8bc1\u4e86\u8fd9\u4e2a\u7ed1\u5b9a\u7ed3\u679c\u4e0d\u4f1a\u5f71\u54cd Pod \u7684\u6b63\u5e38\u8c03\u5ea6\u3002</p> <p>\u6240\u4ee5\u6211\u4eec\u9700\u8981\u521b\u5efa\u5bf9\u5e94\u7684 <code>StorageClass</code> \u5bf9\u8c61\uff1a\uff08local-storageclass.yaml\uff09</p> <pre><code>apiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: local-storage\nprovisioner: kubernetes.io/no-provisioner\nvolumeBindingMode: WaitForFirstConsumer\n</code></pre> <p>\u8fd9\u4e2a <code>StorageClass</code> \u7684\u540d\u5b57\uff0c\u53eb\u4f5c local-storage\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u5728 PV \u4e2d\u58f0\u660e\u7684\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5728\u5b83\u7684 <code>provisioner</code> \u5b57\u6bb5\uff0c\u6211\u4eec\u6307\u5b9a\u7684\u662f <code>no-provisioner</code>\u3002\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u8fd9\u91cc\u662f\u624b\u52a8\u521b\u5efa\u7684 PV\uff0c\u6240\u4ee5\u4e0d\u9700\u8981\u52a8\u6001\u6765\u751f\u6210 PV\uff0c\u53e6\u5916\u8fd9\u4e2a StorageClass \u8fd8\u5b9a\u4e49\u4e86\u4e00\u4e2a </p> <pre><code>volumeBindingMode=WaitForFirstConsumer\n</code></pre> <p>\u7684\u5c5e\u6027\uff0c\u5b83\u662f <code>Local PV</code> \u91cc\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u7279\u6027\uff0c\u5373\uff1a<code>\u5ef6\u8fdf\u7ed1\u5b9a</code>\u3002\u901a\u8fc7\u8fd9\u4e2a\u5ef6\u8fdf\u7ed1\u5b9a\u673a\u5236\uff0c\u539f\u672c\u5b9e\u65f6\u53d1\u751f\u7684 PVC \u548c PV \u7684\u7ed1\u5b9a\u8fc7\u7a0b\uff0c\u5c31\u88ab\u5ef6\u8fdf\u5230\u4e86 Pod \u7b2c\u4e00\u6b21\u8c03\u5ea6\u7684\u65f6\u5019\u5728\u8c03\u5ea6\u5668\u4e2d\u8fdb\u884c\uff0c\u4ece\u800c\u4fdd\u8bc1\u4e86\u8fd9\u4e2a\u7ed1\u5b9a\u7ed3\u679c\u4e0d\u4f1a\u5f71\u54cd Pod \u7684\u6b63\u5e38\u8c03\u5ea6\u3002</p> <p>\u73b0\u5728\u6211\u4eec\u6765\u521b\u5efa\u8fd9\u4e2a StorageClass \u8d44\u6e90\u5bf9\u8c61\uff1a</p> <pre><code>$ kubectl apply -f local-storageclass.yaml \nstorageclass.storage.k8s.io/local-storage created\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u91cd\u65b0\u5220\u9664\u4e0a\u9762\u58f0\u660e\u7684 PVC \u5bf9\u8c61\uff0c\u91cd\u65b0\u521b\u5efa\uff1a</p> <pre><code>$ kubectl delete -f pvc-local.yaml \npersistentvolumeclaim \"pvc-local\" deleted\n$ kubectl create -f pvc-local.yaml\npersistentvolumeclaim/pvc-local created\n$ kubectl get pvc\nNAME           STATUS    VOLUME        CAPACITY   ACCESS MODES   STORAGECLASS    AGE\npvc-local      Pending                                           local-storage   3s\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\u8fd9\u4e2a\u65f6\u5019\uff0c\u96c6\u7fa4\u4e2d\u5373\u4f7f\u5df2\u7ecf\u5b58\u5728\u4e86\u4e00\u4e2a\u53ef\u4ee5\u4e0e PVC \u5339\u914d\u7684 PV \u4e86\uff0c\u4f46\u8fd9\u4e2a PVC \u4f9d\u7136\u5904\u4e8e <code>Pending</code> \u72b6\u6001\uff0c\u4e5f\u5c31\u662f\u7b49\u5f85\u7ed1\u5b9a\u7684\u72b6\u6001\uff0c\u8fd9\u5c31\u662f\u56e0\u4e3a\u4e0a\u9762\u6211\u4eec\u914d\u7f6e\u7684\u662f\u5ef6\u8fdf\u7ed1\u5b9a\uff0c\u9700\u8981\u5728\u771f\u6b63\u7684 Pod \u4f7f\u7528\u7684\u65f6\u5019\u624d\u4f1a\u6765\u505a\u7ed1\u5b9a\u3002</p> <p>\u540c\u6837\u6211\u4eec\u58f0\u660e\u4e00\u4e2a Pod \u6765\u4f7f\u7528\u8fd9\u91cc\u7684 pvc-local \u8fd9\u4e2a PVC\uff0c\u8d44\u6e90\u5bf9\u8c61\u5982\u4e0b\u6240\u793a\uff1a(pv-local-pod.yaml)</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  name: pv-local-pod\nspec:\n  volumes:\n  - name: example-pv-local\n    persistentVolumeClaim:\n      claimName: pvc-local\n  containers:\n  - name: example-pv-local\n    image: nginx\n    ports:\n    - containerPort: 80\n    volumeMounts:\n    - mountPath: /usr/share/nginx/html\n      name: example-pv-local\n</code></pre> <p>\u76f4\u63a5\u521b\u5efa\u8fd9\u4e2a Pod\uff1a</p> <pre><code>$ kubectl apply -f pv-local-pod.yaml \npod/pv-local-pod created\n</code></pre> <p>\u521b\u5efa\u5b8c\u6210\u540e\u6211\u4eec\u8fd9\u4e2a\u65f6\u5019\u53bb\u67e5\u770b\u524d\u9762\u6211\u4eec\u58f0\u660e\u7684 PVC\uff0c\u4f1a\u7acb\u523b\u53d8\u6210 <code>Bound</code> \u72b6\u6001\uff0c\u4e0e\u524d\u9762\u5b9a\u4e49\u7684 PV \u7ed1\u5b9a\u5728\u4e86\u4e00\u8d77\uff1a</p> <pre><code>$ kubectl get pvc\nNAME           STATUS   VOLUME        CAPACITY   ACCESS MODES   STORAGECLASS    AGE\npvc-local      Bound    pv-local      5Gi        RWO            local-storage   4m59s\n</code></pre> <p>\u8fd9\u65f6\u5019\uff0c\u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u5728\u8fd9\u4e2a Pod \u7684 Volume \u76ee\u5f55\u91cc\uff0c\u521b\u5efa\u4e00\u4e2a\u6d4b\u8bd5\u6587\u4ef6\uff0c\u6bd4\u5982\uff1a</p> <pre><code>$ kubectl exec -it pv-local-pod /bin/sh\n# cd /usr/share/nginx/html\n# echo \"Hello from Kubernetes local pv storage\" &gt; test.txt  \n#\n</code></pre> <p>\u7136\u540e\uff0c\u767b\u5f55\u5230 ydzs-node1 \u8fd9\u53f0\u673a\u5668\u4e0a\uff0c\u67e5\u770b\u4e00\u4e0b\u5b83\u7684 <code>/data/k8s/localpv</code> \u76ee\u5f55\u4e0b\u7684\u5185\u5bb9\uff0c\u4f60\u5c31\u53ef\u4ee5\u770b\u5230\u521a\u521a\u521b\u5efa\u7684\u8fd9\u4e2a\u6587\u4ef6\uff1a</p> <pre><code># \u5728ydzs-node1\u8282\u70b9\u4e0a\n$ ls /data/k8s/localpv\ntest.txt\n$ cat /data/k8s/localpv/test.txt \nHello from Kubernetes local pv storage\n</code></pre> <p>\u5982\u679c\u91cd\u65b0\u521b\u5efa\u8fd9\u4e2a Pod \u7684\u8bdd\uff0c\u5c31\u4f1a\u53d1\u73b0\uff0c\u6211\u4eec\u4e4b\u524d\u521b\u5efa\u7684\u6d4b\u8bd5\u6587\u4ef6\uff0c\u4f9d\u7136\u88ab\u4fdd\u5b58\u5728\u8fd9\u4e2a\u6301\u4e45\u5316 Volume \u5f53\u4e2d\uff1a</p> <pre><code>$ kubectl delete -f pv-local-pod.yaml  \n$ kubectl apply -f pv-local-pod.yaml \n$ kubectl exec -it pv-local-pod /bin/sh\n# ls /usr/share/nginx/html\ntest.txt\n# cat /usr/share/nginx/html/test.txt\nHello from Kubernetes local pv storage\n#\n</code></pre> <p>\u5230\u8fd9\u91cc\u5c31\u8bf4\u660e\u57fa\u4e8e\u672c\u5730\u5b58\u50a8\u7684 Volume \u662f\u5b8c\u5168\u53ef\u4ee5\u63d0\u4f9b\u5bb9\u5668\u6301\u4e45\u5316\u5b58\u50a8\u529f\u80fd\u7684\uff0c\u5bf9\u4e8e StatefulSet \u8fd9\u6837\u7684\u6709\u72b6\u6001\u7684\u8d44\u6e90\u5bf9\u8c61\uff0c\u4e5f\u5b8c\u5168\u53ef\u4ee5\u901a\u8fc7\u58f0\u660e Local \u7c7b\u578b\u7684 PV \u548c PVC\uff0c\u6765\u7ba1\u7406\u5e94\u7528\u7684\u5b58\u50a8\u72b6\u6001\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u6211\u4eec\u4e0a\u9762\u624b\u52a8\u521b\u5efa PV \u7684\u65b9\u5f0f\uff0c\u5373\u9759\u6001\u7684 PV \u7ba1\u7406\u65b9\u5f0f\uff0c\u5728\u5220\u9664 PV \u65f6\u9700\u8981\u6309\u5982\u4e0b\u6d41\u7a0b\u6267\u884c\u64cd\u4f5c\uff1a</p> <ul> <li>\u5220\u9664\u4f7f\u7528\u8fd9\u4e2a PV \u7684 Pod</li> <li>\u4ece\u5bbf\u4e3b\u673a\u79fb\u9664\u672c\u5730\u78c1\u76d8</li> <li>\u5220\u9664 PVC</li> <li>\u5220\u9664 PV</li> </ul> <p>\u5982\u679c\u4e0d\u6309\u7167\u8fd9\u4e2a\u6d41\u7a0b\u7684\u8bdd\uff0c\u8fd9\u4e2a PV \u7684\u5220\u9664\u5c31\u4f1a\u5931\u8d25\u3002</p>"}]}